<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Ghép Hán Tự - Kaixin Game</title>
    
    <!-- Tải Tailwind CSS & FontAwesome -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <!-- Tải Confetti -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.3/dist/confetti.browser.min.js"></script>

    <style>
        /* --- FONTS --- */
        @font-face {
            font-family: 'Kaiti';
            src: url('https://ndthien90.github.io/hello_chinese2/fonts/Kaiti.ttf') format('truetype');
            font-weight: normal;
            font-style: normal;
        }
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&family=Ma+Shan+Zheng&family=Mulish:ital,wght@0,200..900;1,200..900&display=swap');

        /* --- CSS VARIABLES (Hệ thống Theme) --- */
        :root {
            /* Default Theme (Blue) - Sẽ được JS ghi đè nếu có theme khác */
            --primary: #2563eb;       
            --primary-light: #dbeafe; 
            --bg-body: #f3f4f6;       
            --bg-card: #ffffff;       
            --text-main: #1f2937;     
            --text-sub: #6b7280;      
            --shadow-color: rgba(59, 130, 246, 0.3);
            --success: #22c55e;
            --error: #ef4444;
            --warning: #f59e0b;
        }

        body { 
            font-family: 'Mulish', 'Inter', sans-serif; 
            background-color: var(--bg-body); 
            color: var(--text-main);
            padding-bottom: 90px; /* Chừa chỗ cho Bottom Nav */
            transition: background-color 0.5s ease, color 0.5s ease;
            min-height: 100vh;
            user-select: none;
            -webkit-user-select: none;
        }

        /* --- UTILS --- */
        .theme-bg-primary { background-color: var(--primary) !important; }
        .theme-text-primary { color: var(--primary) !important; }
        .theme-border-primary { border-color: var(--primary) !important; }
        .theme-shadow { box-shadow: 0 10px 15px -3px var(--shadow-color) !important; }
        .theme-ring-focus:focus { ring-color: var(--primary) !important; }

        /* --- GAME GRID & TILES --- */
        #hanzi-grid {
            transition: all 0.3s ease;
        }

        .hanzi-tile {
            aspect-ratio: 1;
            background-color: var(--bg-card);
            border-radius: 1rem; /* rounded-2xl */
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            border: 2px solid transparent;
        }

        .hanzi-content {
            font-family: 'Kaiti', 'SimSun', serif;
            font-size: 1.75rem;
            /* CẬP NHẬT: Đưa về normal để không bị bôi đen đậm */
            font-weight: normal; 
            color: var(--text-main);
            transition: transform 0.1s;
        }

        /* States */
        .hanzi-tile:active { transform: scale(0.95); }
        
        .hanzi-tile.selected {
            /* CẬP NHẬT: Giữ nguyên màu nền (màu card) */
            background-color: var(--bg-card) !important;
            
            /* CẬP NHẬT: Chỉ đổi màu viền thành màu theme */
            border-color: var(--primary) !important;
            border-width: 2px;
            
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px var(--shadow-color);
        }
        
        .hanzi-tile.selected .hanzi-content { 
            /* CẬP NHẬT: Giữ nguyên màu chữ mặc định */
            color: var(--text-main) !important; 
        }

        .hanzi-tile.correct {
            animation: correct-pop 0.6s forwards;
            background-color: var(--success) !important;
        }
        .hanzi-tile.correct .hanzi-content { color: #ffffff !important; }

        .hanzi-tile.wrong {
            animation: wrong-shake 0.5s ease-in-out;
            background-color: var(--bg-card);
            border-color: var(--error) !important;
        }
        .hanzi-tile.wrong .hanzi-content { color: var(--text-main); }

        .hanzi-tile.hint-pulse {
            animation: pulse-orange 1.5s infinite;
            border-color: var(--warning);
            background-color: #fffbeb; /* yellow-50 */
        }
        
        /* Animations */
        @keyframes correct-pop {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.1); opacity: 0.8; }
            100% { transform: scale(0); opacity: 0; }
        }

        @keyframes wrong-shake {
            0%, 100% { transform: translateX(0); }
            20%, 60% { transform: translateX(-5px); }
            40%, 80% { transform: translateX(5px); }
        }
        
        @keyframes pulse-orange {
            0% { box-shadow: 0 0 0 0 rgba(245, 158, 11, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(245, 158, 11, 0); }
            100% { box-shadow: 0 0 0 0 rgba(245, 158, 11, 0); }
        }

        .flying-score {
            position: fixed;
            z-index: 9999;
            font-size: 1.5rem;
            font-weight: 900;
            color: var(--success);
            pointer-events: none;
            text-shadow: 0 2px 4px rgba(255,255,255,0.8);
            transition: all 0.8s cubic-bezier(0.19, 1, 0.22, 1);
        }

        /* --- MODALS --- */
        .modal-backdrop {
            background-color: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(4px);
        }
        
        /* Ẩn scrollbar */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

    </style>
    
    <!-- Firebase Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-hanzi-app';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null; 

        let app, db, auth, userId = null;

        if (firebaseConfig) {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            window.db = db;

            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                    listenForBestScore();
                } else {
                    try {
                        if (initialAuthToken) {
                            await signInWithCustomToken(auth, initialAuthToken); 
                        } else {
                            await signInAnonymously(auth);
                        }
                    } catch (error) {
                        console.error("Lỗi xác thực Firebase:", error);
                    }
                }
            });
        }

        function listenForBestScore() {
            if (!db) return;
            const docRef = doc(db, "artifacts", appId, "public", "data", "hanzi_match_scores", "best_score");
            onSnapshot(docRef, (doc) => {
                if (doc.exists()) {
                    window.updateBestScore(doc.data().score || 0);
                }
            });
        }

        window.saveBestScore = async (newScore) => {
            if (!db || !userId) return;
            const docRef = doc(db, "artifacts", appId, "public", "data", "hanzi_match_scores", "best_score");
            try {
                const docSnap = await getDoc(docRef);
                if (!docSnap.exists() || newScore > (docSnap.data().score || 0)) {
                    await setDoc(docRef, { score: newScore, userId: userId, updated: new Date().toISOString() });
                }
            } catch (e) { console.error(e); }
        };
    </script>
</head>
<body class="max-w-md mx-auto border-x border-gray-200 shadow-xl relative">

    <audio id="audio-player" style="display: none;"></audio>

    <!-- Top Bar -->
    <div class="px-4 py-3 flex justify-between items-center sticky top-0 z-30 shadow-sm transition-colors duration-500" style="background-color: var(--bg-card);">
        <div class="flex items-center gap-3">
            <a href="index.html" class="w-10 h-10 rounded-xl flex items-center justify-center hover:bg-gray-100 transition text-gray-500">
                <i class="fas fa-chevron-left"></i>
            </a>
            <div>
                <h2 class="font-bold text-lg leading-tight">Ghép Hán Tự</h2>
                <div class="flex items-center gap-2 text-xs opacity-70">
                    <span class="theme-text-primary font-bold"><i class="fas fa-crown"></i> Cao nhất: <span id="best-score">0</span></span>
                </div>
            </div>
        </div>
        <div class="flex gap-2">
            <div class="px-3 py-1.5 bg-yellow-50 border border-yellow-200 rounded-xl flex items-center gap-1.5 text-sm font-bold text-yellow-700 shadow-sm">
                <i class="fas fa-star text-yellow-500"></i> <span id="current-score">0</span>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="p-4 flex flex-col min-h-[80vh]">
        
        <!-- Controls: Lesson Select -->
        <div class="mb-4 relative">
            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                <i class="fas fa-book-open theme-text-primary opacity-60"></i>
            </div>
            <select id="lesson-select" class="block w-full pl-10 pr-10 py-3 text-sm font-bold border-none rounded-2xl shadow-sm focus:ring-2 focus:ring-opacity-50 appearance-none transition-all cursor-pointer" style="background-color: var(--bg-card); color: var(--text-main); ring-color: var(--primary);">
                <option value="1">H1 Bài 1: 老师您好！</option> 
                <option value="2">H1 Bài 2: 谢谢你！</option> 
                <option value="3">H1 Bài 3: 你叫什么名字?</option>
                <option value="4">H1 Bài 4: 她是我的汉语老师。</option>
                <option value="5">H1 Bài 5: 她女儿今年八岁。</option>
                <option value="6">H1 Bài 6: 我会说汉语。</option>
            </select>
            <div class="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none">
                <i class="fas fa-chevron-down text-gray-400"></i>
            </div>
        </div>

        <!-- Progress Bar & Stage Info -->
        <div class="mb-6">
            <div class="flex justify-between items-end mb-2 px-1">
                <div class="text-xs font-bold uppercase opacity-60 tracking-wider">Tiến độ</div>
                <div class="text-sm font-bold theme-text-primary">
                    Màn <span id="current-stage-display">1</span>/<span id="total-stages-display">5</span>
                </div>
            </div>
            <div class="w-full h-2.5 rounded-full bg-gray-200 overflow-hidden">
                <div id="progress-bar" class="h-full rounded-full transition-all duration-500 theme-bg-primary" style="width: 20%"></div>
            </div>
        </div>

        <!-- Selection Display (Từ đang ghép) -->
        <!-- Đã sửa: Nền trắng, viền xanh -->
        <div id="selection-display" class="h-16 mb-6 rounded-2xl flex items-center justify-center text-3xl font-black theme-text-primary transition-all duration-300 shadow-inner" style="background-color: var(--primary-light); font-family: 'Kaiti', serif;">
            <!-- Ký tự sẽ hiện ở đây -->
            <span class="opacity-30 text-base font-normal italic" style="font-family: 'Mulish', sans-serif;">Chọn ký tự để ghép...</span>
        </div>

        <!-- Grid -->
        <div id="hanzi-grid" class="grid grid-cols-2 gap-3 mb-auto">
            <!-- Tiles generated by JS -->
        </div>

        <!-- Action Buttons -->
        <div class="grid grid-cols-4 gap-3 mt-6">
            <button id="restart-btn" class="col-span-2 py-4 rounded-2xl flex items-center justify-center gap-2 text-white font-bold shadow-lg theme-bg-primary theme-shadow active:scale-95 transition-transform">
                <i class="fas fa-redo-alt"></i>
                <span>Chơi lại</span>
            </button>
            
           <button id="hint-btn" class="col-span-2 py-4 rounded-2xl flex flex items-center justify-center gap-2 text-white font-bold shadow-lg transition-transform active:scale-95 shadow-sm border" style="background-color: var(--warning); border-color: var(--warning); color: #ffffff;">
                <i class="fas fa-lightbulb text-xl mb-0.5"></i>
                <span>Gợi ý (<span id="hint-count">5</span>)</span>
            </button>
        </div>
        
        <!-- Message Area (Toast substitute) -->
        <div id="message-area" class="h-6 mt-2 text-center text-sm font-bold text-orange-500 transition-opacity duration-300 opacity-0"></div>

    </div>

    <!-- Bottom Tab Bar -->
    <div class="fixed bottom-0 left-0 right-0 max-w-md mx-auto border-t border-gray-200 px-2 py-3 flex justify-around items-center z-40 pb-6 md:pb-3 transition-colors duration-500" style="background-color: var(--bg-card);">
        <a href="index.html" class="flex flex-col items-center gap-1 text-gray-400 hover:text-blue-600 transition w-16">
            <i class="fas fa-home text-xl"></i>
            <span class="text-[10px] font-medium">Home</span>
        </a>
        <a href="study.html" class="flex flex-col items-center gap-1 text-gray-400 hover:text-blue-600 transition w-16">
            <i class="fas fa-book-open text-xl"></i>
            <span class="text-[10px] font-medium">Học</span>
        </a>
        <a href="javascript:void(0)" class="flex flex-col items-center gap-1 w-16 theme-text-primary">
            <i class="fas fa-gamepad text-xl"></i>
            <span class="text-[10px] font-medium">Game</span>
        </a>
        <a href="profile.html" class="flex flex-col items-center gap-1 text-gray-400 hover:text-blue-600 transition w-16">
            <i class="fas fa-user text-xl"></i>
            <span class="text-[10px] font-medium">Tôi</span>
        </a>
    </div>

    <!-- DICTIONARY MODAL -->
    <div id="dictionary-modal" class="fixed inset-0 z-50 hidden items-center justify-center modal-backdrop p-4">
        <div class="bg-white p-6 rounded-3xl shadow-2xl max-w-xs w-full transform transition-all scale-95 opacity-0 flex flex-col items-center text-center relative overflow-hidden" id="dict-modal-content">
            <!-- Decorative bg -->
            <div class="absolute top-0 left-0 w-full h-24 theme-bg-primary opacity-10"></div>
            
            <!-- Spacer thay thế -->
            <div style="height: 2rem;"></div> 

            <h3 class="text-2xl font-black mb-1 theme-text-primary z-10">Chính xác!</h3>
            
            <div class="my-4 w-full"> 
                <p id="modal-hanzi" class="text-4xl  text-gray-800 mb-2" style="font-family: 'Kaiti', serif; line-height: 1.1;"></p>
                <div class="flex items-center justify-center gap-2 mb-2">
                    <p id="modal-pinyin" class="text-xl font-mono theme-text-primary font-bold"></p>
                </div>
                <p id="modal-vn" class="text-base font-semibold text-gray-600"></p>
            </div>

            <div class="w-full text-center px-2 mt-2 pt-3 border-t border-gray-100">
                <p class="text-xs uppercase text-gray-400 font-bold mb-1">Ví dụ</p>
                <p id="modal-example" class="text-sm italic text-gray-500 leading-relaxed"></p>
            </div>
        </div>
    </div>
    
    <!-- GAME OVER MODAL -->
    <div id="gameover-modal" class="fixed inset-0 z-50 hidden items-center justify-center modal-backdrop p-4">
        <div class="bg-white p-8 rounded-3xl shadow-2xl max-w-sm w-full text-center transform transition-all scale-95 opacity-0 relative overflow-hidden" id="gameover-content">
            <div class="absolute top-0 left-0 w-full h-full bg-gradient-to-b from-yellow-50 to-white -z-10"></div>
            
            <div class="mb-6">
                <i class="fas fa-trophy text-6xl text-yellow-400 drop-shadow-md animate-bounce"></i>
            </div>
            
            <h3 class="text-3xl font-black text-gray-800 mb-2">HOÀN THÀNH!</h3>
            <p class="text-gray-500 text-sm mb-6">Bạn đã xuất sắc vượt qua tất cả các màn.</p>
            
            <div class="bg-white rounded-2xl p-4 shadow-sm border border-gray-100 mb-6 flex flex-col items-center">
                <span class="text-xs font-bold text-gray-400 uppercase">Tổng điểm</span>
                <span id="final-score" class="text-5xl font-black theme-text-primary">0</span>
            </div>

            <button onclick="window.restartGame()" class="w-full py-3.5 text-white font-bold rounded-xl shadow-lg theme-bg-primary theme-shadow active:scale-95 transition">
                Chơi Lại Từ Đầu
            </button>
        </div>
    </div>

    <!-- LEVEL TOAST -->
    <div id="level-toast" class="fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 z-50 hidden pointer-events-none">
        <div class="bg-gray-800/90 backdrop-blur text-white px-6 py-4 rounded-2xl shadow-2xl text-center flex flex-col items-center animate-bounce">
            <i class="fas fa-level-up-alt text-3xl text-yellow-400 mb-2"></i>
            <h3 class="text-xl font-bold">Màn Tiếp Theo!</h3>
        </div>
    </div>

    <script>
        // --- 1. THEME ENGINE (Từ Index.html) ---
        const THEMES = [
            { id: 'default', colors: { primary: '#2563eb', primaryLight: '#dbeafe', bgBody: '#f3f4f6', bgCard: '#ffffff', textMain: '#1f2937', shadow: 'rgba(59, 130, 246, 0.3)' } },
            { id: 'sunset', colors: { primary: '#f97316', primaryLight: '#ffedd5', bgBody: '#fff7ed', bgCard: '#ffffff', textMain: '#431407', shadow: 'rgba(249, 115, 22, 0.3)' } },
            { id: 'nature', colors: { primary: '#16a34a', primaryLight: '#dcfce7', bgBody: '#f0fdf4', bgCard: '#ffffff', textMain: '#14532d', shadow: 'rgba(22, 163, 74, 0.3)' } },
            { id: 'ocean', colors: { primary: '#0891b2', primaryLight: '#cffafe', bgBody: '#ecfeff', bgCard: '#ffffff', textMain: '#164e63', shadow: 'rgba(8, 145, 178, 0.3)' } },
            { id: 'dark', colors: { primary: '#8b5cf6', primaryLight: '#2e1065', bgBody: '#111827', bgCard: '#1f2937', textMain: '#f3f4f6', shadow: 'rgba(139, 92, 246, 0.3)' } },
            { id: 'candy', colors: { primary: '#ec4899', primaryLight: '#fce7f3', bgBody: '#fdf2f8', bgCard: '#ffffff', textMain: '#831843', shadow: 'rgba(236, 72, 153, 0.3)' } },
            { id: 'lavender', colors: { primary: '#a855f7', primaryLight: '#f3e8ff', bgBody: '#faf5ff', bgCard: '#ffffff', textMain: '#581c87', shadow: 'rgba(168, 85, 247, 0.3)' } },
            { id: 'mint', colors: { primary: '#14b8a6', primaryLight: '#ccfbf1', bgBody: '#f0fdfa', bgCard: '#ffffff', textMain: '#134e4a', shadow: 'rgba(20, 184, 166, 0.3)' } },
            { id: 'luxury', colors: { primary: '#eab308', primaryLight: '#fef9c3', bgBody: '#fffbeb', bgCard: '#ffffff', textMain: '#422006', shadow: 'rgba(234, 179, 8, 0.3)' } },
            { id: 'rose', colors: { primary: '#f43f5e', primaryLight: '#ffe4e6', bgBody: '#fff1f2', bgCard: '#ffffff', textMain: '#881337', shadow: 'rgba(244, 63, 94, 0.3)' } },
            { id: 'coffee', colors: { primary: '#78350f', primaryLight: '#fef3c7', bgBody: '#fffbeb', bgCard: '#ffffff', textMain: '#451a03', shadow: 'rgba(120, 53, 15, 0.3)' } },
            { id: 'galaxy', colors: { primary: '#6366f1', primaryLight: '#312e81', bgBody: '#0f172a', bgCard: '#1e293b', textMain: '#e2e8f0', shadow: 'rgba(99, 102, 241, 0.3)' } },
            { id: 'lime', colors: { primary: '#84cc16', primaryLight: '#ecfccb', bgBody: '#f7fee7', bgCard: '#ffffff', textMain: '#365314', shadow: 'rgba(132, 204, 22, 0.3)' } },
            { id: 'coral', colors: { primary: '#fb7185', primaryLight: '#ffe4e6', bgBody: '#fff1f2', bgCard: '#ffffff', textMain: '#9f1239', shadow: 'rgba(251, 113, 133, 0.3)' } },
            { id: 'minimal', colors: { primary: '#6b7280', primaryLight: '#e5e7eb', bgBody: '#f9fafb', bgCard: '#ffffff', textMain: '#111827', shadow: 'rgba(107, 114, 128, 0.3)' } }
        ];

        function loadTheme() {
            const savedThemeId = localStorage.getItem('theme') || 'default';
            const theme = THEMES.find(t => t.id === savedThemeId) || THEMES[0];
            const root = document.documentElement;
            
            root.style.setProperty('--primary', theme.colors.primary);
            root.style.setProperty('--primary-light', theme.colors.primaryLight);
            root.style.setProperty('--bg-body', theme.colors.bgBody);
            root.style.setProperty('--bg-card', theme.colors.bgCard);
            root.style.setProperty('--text-main', theme.colors.textMain);
            root.style.setProperty('--shadow-color', theme.colors.shadow);
        }
        
        loadTheme(); // Apply immediately

        // --- 2. GAME LOGIC ---
        
        let WORD_LIST_RAW = [];         
        let WORD_LIST_WITH_IDS = [];    
        
        const STAGES = [6, 8, 12, 16]; 
        let currentStageIndex = 0;

        let gridState = [];             
        let currentScore = 0;
        let bestScore = 0;
        let selectedTiles = [];
        let comboCount = 0;
        let hintCount = 5;               
        let isProcessing = false;
        let currentLesson = '1'; 

        let CURRENT_STAGE_WORDS = []; 
        let UNSOLVED_WORDS = [];        
        let currentHanziToSpeak = ''; 

        // DOM Elements
        const gridElement = document.getElementById('hanzi-grid');
        const scoreElement = document.getElementById('current-score');
        const bestScoreElement = document.getElementById('best-score');
        const selectionDisplay = document.getElementById('selection-display');
        const messageArea = document.getElementById('message-area');
        const hintCountElement = document.getElementById('hint-count');
        const hintBtn = document.getElementById('hint-btn');
        // const speakerBtn = document.getElementById('speaker-btn'); // REMOVED
        const lessonSelect = document.getElementById('lesson-select');
        const audioPlayer = document.getElementById('audio-player'); 
        const currentStageDisplay = document.getElementById('current-stage-display');
        const totalStagesDisplay = document.getElementById('total-stages-display');
        const progressBar = document.getElementById('progress-bar');
        const levelToast = document.getElementById('level-toast');
        
        const BASE_PATH = 'data_flashcard/'; 

        // --- Audio Functions ---
        const playAudioFromLesson = (lessonNumber, hanziText) => {
            if (window.speechSynthesis.speaking) window.speechSynthesis.cancel();
            audioPlayer.pause();
            audioPlayer.removeAttribute('src'); 

            const audioPath = `${BASE_PATH}bai${lessonNumber}/mp3/${hanziText}.mp3`;
            
            // CẬP NHẬT: Không còn speakerBtn để điều khiển UI, chỉ phát âm thanh
            
            audioPlayer.onloadedmetadata = () => {
                audioPlayer.currentTime = 0; 
                audioPlayer.play().catch(e => speakHanzi(hanziText));
            };
            audioPlayer.onerror = () => speakHanzi(hanziText);

            audioPlayer.src = audioPath;
            audioPlayer.load();
        };

        const speakHanzi = (text) => {
            if (!('speechSynthesis' in window)) return;
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'zh-CN'; 
            utterance.rate = 1.0;
            window.speechSynthesis.speak(utterance);
        };

        // --- Load Data ---
        const loadAndParseLesson = async (lessonNumber) => {
            currentLesson = lessonNumber; 
            const filePath = `${BASE_PATH}bai${lessonNumber}/bai${lessonNumber}.txt`;
            
            try {
                const response = await fetch(filePath);
                if (!response.ok) throw new Error("File not found");
                const text = await response.text();
                
                const lines = text.trim().split('\n');
                let newWordList = [];

                lines.forEach((line, index) => {
                    if (line.trim() === '' || line.startsWith('#') || line.startsWith('//')) return; 
                    const parts = line.split('|').map(p => p.trim());
                    if (parts.length >= 2) {
                        const hanzi = parts[0];
                        if (hanzi.length >= 2) { 
                            newWordList.push({
                                chars: hanzi.split(''), 
                                length: hanzi.length, 
                                pinyin: parts[1], 
                                vn: parts[2] || '', 
                                example: parts[3] || '', 
                                id: `L${lessonNumber}_W${index}`
                            });
                        }
                    }
                });
                
                WORD_LIST_WITH_IDS = newWordList;
                window.restartGame(); 
                
            } catch (error) {
                console.error("Lỗi tải bài học:", error);
                showMessage(`Không tìm thấy dữ liệu Bài ${lessonNumber}.`, true);
            }
        };

        // --- Core Game Logic ---
        const findExactSubset = (words, target) => {
            const find = (index, currentSum, currentSubset) => {
                if (currentSum === target) return currentSubset;
                if (currentSum > target || index === words.length) return null;
                const withWord = find(index + 1, currentSum + words[index].length, [...currentSubset, words[index]]);
                if (withWord) return withWord;
                const withoutWord = find(index + 1, currentSum, currentSubset);
                if (withoutWord) return withoutWord;
                return null;
            };
            return find(0, 0, []);
        };

        const selectWordsForStage = (targetTileCount) => {
            let shuffledPool = [...WORD_LIST_WITH_IDS].sort(() => 0.5 - Math.random());
            for(let i = 0; i < 10; i++) {
                 shuffledPool.sort(() => 0.5 - Math.random());
                 const exactSet = findExactSubset(shuffledPool, targetTileCount);
                 if (exactSet) return exactSet;
            }
            let selected = [];
            let currentCount = 0;
            let infinitePool = [...WORD_LIST_WITH_IDS]; 
            let attempts = 0;
            while (currentCount < targetTileCount && attempts < 200) {
                attempts++;
                const randomWord = infinitePool[Math.floor(Math.random() * infinitePool.length)];
                if (currentCount + randomWord.length <= targetTileCount) {
                    const clonedWord = {
                        ...randomWord,
                        id: randomWord.id + '_dup_' + Math.random().toString(36).substr(2, 5) 
                    };
                    selected.push(clonedWord);
                    currentCount += randomWord.length;
                }
            }
            return selected;
        };

        const startStage = (stageIndex) => {
            isProcessing = false;
            currentStageIndex = stageIndex;
            const targetTiles = STAGES[currentStageIndex];
            
            // Update UI
            currentStageDisplay.textContent = currentStageIndex + 1;
            totalStagesDisplay.textContent = STAGES.length;
            const progressPercent = ((currentStageIndex) / STAGES.length) * 100;
            progressBar.style.width = `${progressPercent + 20}%`; // Minimum visual width

            CURRENT_STAGE_WORDS = selectWordsForStage(targetTiles);
            UNSOLVED_WORDS = [...CURRENT_STAGE_WORDS];
            
            gridElement.className = 'grid gap-3 mb-auto';
            if (targetTiles === 4) gridElement.classList.add('grid-cols-2');
            else if (targetTiles === 6) gridElement.classList.add('grid-cols-3');
            else gridElement.classList.add('grid-cols-4');
            
            fillNewGrid(targetTiles);
        };

        const fillNewGrid = (targetTiles) => {
            gridState = [];
            let allChars = UNSOLVED_WORDS.flatMap(word => word.chars);
            allChars.sort(() => 0.5 - Math.random());
            
            for (let i = 0; i < targetTiles; i++) {
                const char = allChars[i] || ''; 
                gridState.push({ 
                    char: char, 
                    index: i, 
                    id: Date.now() + i + Math.random(), 
                    isEmpty: char === '' 
                }); 
            }
            renderGrid();
        };

        window.restartGame = () => {
            if (WORD_LIST_WITH_IDS.length === 0) return;
            currentScore = 0;
            scoreElement.textContent = currentScore;
            selectedTiles = [];
            hintCount = 5;
            hintCountElement.textContent = hintCount;
            hintBtn.disabled = false;
            hintBtn.style.opacity = '1';
            
            const modal = document.getElementById('gameover-modal');
            const content = document.getElementById('gameover-content');
            
            content.classList.remove('scale-100', 'opacity-100');
            content.classList.add('scale-95', 'opacity-0');
            
            modal.classList.remove('flex'); // Remove flex when closing
            modal.classList.add('hidden');
            
            startStage(0);
        };

        const renderGrid = () => {
            gridElement.innerHTML = '';
            gridState.forEach((tile, index) => {
                const isSelected = selectedTiles.includes(index);
                const tileDiv = document.createElement('div');
                const isTileEmpty = tile.isEmpty || !tile.char;
                
                tileDiv.className = `hanzi-tile ${isSelected ? 'selected' : ''}`;
                
                if (isTileEmpty) {
                    tileDiv.style.opacity = '0';
                    tileDiv.style.pointerEvents = 'none';
                }

                tileDiv.dataset.index = index;
                tileDiv.onclick = isTileEmpty ? null : () => handleTileClick(index);

                const contentDiv = document.createElement('div');
                contentDiv.className = 'hanzi-content';
                contentDiv.textContent = tile.char;

                tileDiv.appendChild(contentDiv);
                gridElement.appendChild(tileDiv);
            });
        };

        const updateSelectionDisplay = () => {
            const currentWord = selectedTiles.map(index => gridState[index].char).join('');
            if (currentWord) {
                selectionDisplay.textContent = currentWord;
                // CẬP NHẬT: Nền trắng theo yêu cầu "nền ô nhập màu trắng"
                selectionDisplay.style.backgroundColor = '#ffffff'; 
                // Thêm viền màu theme để rõ ràng trên nền trắng
                selectionDisplay.style.border = '2px solid var(--primary)';
                
                // Chữ màu theme (xanh)
                selectionDisplay.classList.add('theme-text-primary'); 
                selectionDisplay.classList.remove('text-white');
                selectionDisplay.style.color = ''; 
            } else {
                selectionDisplay.innerHTML = '<span class="opacity-30 text-base font-normal italic" style="font-family: \'Mulish\', sans-serif;">Chọn ký tự để ghép...</span>';
                selectionDisplay.style.backgroundColor = 'var(--primary-light)';
                selectionDisplay.style.border = '2px solid transparent'; // Reset border
                
                selectionDisplay.classList.add('theme-text-primary'); 
                selectionDisplay.classList.remove('text-white');
                selectionDisplay.style.color = ''; 
            }
        };

        const handleTileClick = (index) => {
            if (isProcessing) return;
            const tile = gridState[index];
            if (tile.isEmpty || !tile.char) return;

            // Rung nhẹ
            if ('vibrate' in navigator) navigator.vibrate(10);

            if (selectedTiles.includes(index)) {
                selectedTiles = selectedTiles.filter(i => i !== index);
            } else {
                selectedTiles.push(index);
            }

            updateSelectionDisplay();
            renderGrid();
            
            if (selectedTiles.length >= 2) checkMatch();
        };

        const checkMatch = () => {
            if (isProcessing) return;
            
            const currentWordChars = selectedTiles.map(index => gridState[index].char);
            const currentWordStr = currentWordChars.join('');
            
            const matchedWord = UNSOLVED_WORDS.find(word => word.chars.join('') === currentWordStr);
            
            if (matchedWord) {
                handleMatchCorrect(matchedWord);
            } else if (selectedTiles.length >= 4) { 
                handleMatchWrong();
            } else {
                const potential = UNSOLVED_WORDS.some(w => w.chars.join('').startsWith(currentWordStr));
                if (!potential) handleMatchWrong();
            }
        };
        
        const handleMatchCorrect = (matchedWord) => {
            isProcessing = true;
            comboCount++;
            
            UNSOLVED_WORDS = UNSOLVED_WORDS.filter(w => w.id !== matchedWord.id);
            
            selectedTiles.forEach(index => {
                const tile = gridElement.querySelector(`[data-index="${index}"]`);
                if (tile) {
                    tile.classList.remove('selected');
                    tile.classList.add('correct');
                    gridState[index].char = '';
                    gridState[index].isEmpty = true;
                }
            });

            const pointsGained = matchedWord.length * 10 * comboCount;
            animateFlyingScore(pointsGained);
            currentScore += pointsGained;
            scoreElement.textContent = currentScore;
            
            if (currentScore > bestScore) {
                bestScore = currentScore;
                bestScoreElement.textContent = bestScore;
                if (window.saveBestScore) window.saveBestScore(currentScore);
            }
            
            showDictionaryModal(matchedWord);
            selectedTiles = [];
            updateSelectionDisplay();
            
            setTimeout(() => {
                renderGrid();
                isProcessing = false;
                if (UNSOLVED_WORDS.length === 0) handleStageComplete();
            }, 600);
        };

        const handleStageComplete = () => {
            isProcessing = true;
            if (currentStageIndex < STAGES.length - 1) {
                //levelToast.classList.remove('hidden');
                setTimeout(() => {
                    levelToast.classList.add('hidden');
                    startStage(currentStageIndex + 1);
                }, 1500);
            } else {
                showVictoryModal();
            }
        };

        const handleMatchWrong = () => {
            isProcessing = true;
            comboCount = 0;
            showMessage('Sai rồi!', true);
            
            if ('vibrate' in navigator) navigator.vibrate([50, 50, 50]);

            selectedTiles.forEach(index => {
                const tile = gridElement.querySelector(`[data-index="${index}"]`);
                if (tile) tile.classList.add('wrong');
            });
            setTimeout(() => {
                selectedTiles = [];
                updateSelectionDisplay();
                renderGrid(); 
                isProcessing = false;
            }, 600);
        };
        
        const handleHint = () => {
            if (hintCount <= 0 || isProcessing || UNSOLVED_WORDS.length === 0) return;
            const hintWord = UNSOLVED_WORDS[0];
            hintCount--;
            hintCountElement.textContent = hintCount;
            if (hintCount === 0) {
                hintBtn.disabled = true;
                hintBtn.style.opacity = '0.5';
            }

            let foundIndices = [];
            let tempGrid = [...gridState]; 
            
            hintWord.chars.forEach(char => {
                for (let i = 0; i < tempGrid.length; i++) {
                    if (tempGrid[i].char === char && !tempGrid[i].isEmpty && !foundIndices.includes(i)) {
                        foundIndices.push(i);
                        break; 
                    }
                }
            });

            foundIndices.forEach(index => {
                const tile = gridElement.querySelector(`[data-index="${index}"]`);
                if (tile) {
                    tile.classList.add('hint-pulse');
                    setTimeout(() => tile.classList.remove('hint-pulse'), 1500);
                }
            });
        };

        const showDictionaryModal = (word) => {
            const modal = document.getElementById('dictionary-modal');
            const content = document.getElementById('dict-modal-content');

            document.getElementById('modal-hanzi').textContent = word.chars.join('');
            document.getElementById('modal-pinyin').textContent = word.pinyin;
            document.getElementById('modal-vn').textContent = word.vn;
            document.getElementById('modal-example').textContent = word.example;
            
            currentHanziToSpeak = word.chars.join('');
            
            // Đã sửa: Thêm class flex để căn giữa
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            
            setTimeout(() => {
                content.classList.remove('scale-95', 'opacity-0');
                content.classList.add('scale-100', 'opacity-100');
            }, 10);
            
            playAudioFromLesson(currentLesson, currentHanziToSpeak);
            
            setTimeout(() => {
                content.classList.remove('scale-100', 'opacity-100');
                content.classList.add('scale-95', 'opacity-0');
                setTimeout(() => { 
                    modal.classList.add('hidden');
                    modal.classList.remove('flex'); // Dọn dẹp class flex
                }, 300);
            }, 2500);
        };

        const showVictoryModal = () => {
            const modal = document.getElementById('gameover-modal');
            const content = document.getElementById('gameover-content');
            
            document.getElementById('final-score').textContent = currentScore;
            
            // Đã sửa: Thêm class flex để căn giữa
            modal.classList.remove('hidden');
            modal.classList.add('flex');

            setTimeout(() => {
                content.classList.remove('scale-95', 'opacity-0');
                content.classList.add('scale-100', 'opacity-100');
            }, 10);
            
            confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 } });
        };

        const animateFlyingScore = (points) => {
            if (selectedTiles.length === 0) return;
            const tile = gridElement.querySelector(`[data-index="${selectedTiles[0]}"]`);
            if (!tile) return;
            
            const rect = tile.getBoundingClientRect();
            const flyEl = document.createElement('div');
            flyEl.textContent = `+${points}`;
            flyEl.className = 'flying-score';
            flyEl.style.left = `${rect.left + rect.width/2}px`;
            flyEl.style.top = `${rect.top}px`;
            document.body.appendChild(flyEl);
            
            const target = scoreElement.getBoundingClientRect();
            // Simple animation sequence
            setTimeout(() => {
                flyEl.style.transform = `translate(${target.left - rect.left}px, ${target.top - rect.top}px) scale(0.5)`;
                flyEl.style.opacity = '0';
            }, 50);
            setTimeout(() => flyEl.remove(), 800);
        };

        const showMessage = (msg, isError = false) => {
            messageArea.textContent = msg;
            messageArea.className = isError ? 'h-6 mt-2 text-center text-sm font-bold text-red-500' : 'h-6 mt-2 text-center text-sm font-bold text-green-500';
            messageArea.style.opacity = '1';
            setTimeout(() => { messageArea.style.opacity = '0'; }, 2000);
        };
        
        window.updateBestScore = (score) => {
            bestScore = score;
            bestScoreElement.textContent = score;
        };

        window.onload = function() {
            document.getElementById('restart-btn').onclick = window.restartGame;
            document.getElementById('hint-btn').onclick = handleHint; 
            // speakerBtn.onclick = handleSpeakerClick; // REMOVED
            lessonSelect.onchange = (e) => loadAndParseLesson(e.target.value);
            loadAndParseLesson(lessonSelect.value);
        };
    </script>
</body>
</html>