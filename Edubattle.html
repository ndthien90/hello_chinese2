<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EduBattle - N·ªÅn t·∫£ng h·ªçc t·∫≠p & Thi ƒë·∫•u</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* Custom scrollbar for better look */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        /* Style for drag/drop items in Jumble question */
        .jumble-word {
            display: inline-block;
            padding: 8px 12px;
            margin: 4px;
            background-color: #e0f2f1; /* Tailwind teal-50 */
            border: 1px solid #009688; /* Tailwind teal-600 */
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.2s;
            font-weight: 600;
        }
        .jumble-word:hover { background-color: #b2dfdb; }

        /* Animation for correct answer flash */
        .flash-green {
            animation: flashGreen 0.2s ease-out;
        }
        @keyframes flashGreen {
            0% { background-color: #f0fff4; }
            50% { background-color: #34d399; } /* Tailwind green-400 */
            100% { background-color: #f0fff4; }
        }

        /* --- M·ªöI: CSS cho Responsive Sidebar (Mobile Hidden) --- */
        #mobile-overlay {
            z-index: 40; /* D∆∞·ªõi toast */
            display: none;
        }
        @media (max-width: 1023px) {
            /* ·∫®n sidebar tr√™n mobile, d√πng overlay */
            #sidebar-desktop {
                transform: translateX(-100%);
                transition: transform 0.3s ease-in-out;
                position: fixed;
                height: 100%;
                z-index: 50;
            }
            #sidebar-desktop.open {
                transform: translateX(0);
            }
            #mobile-overlay.open {
                display: block;
            }
            /* FIX QUAN TR·ªåNG: Th√™m padding-bottom cho main tr√™n mobile ƒë·ªÉ tr√°nh thanh nav bar che m·∫•t n·ªôi dung */
            main {
                padding-bottom: calc(1rem + 64px) !important; /* 1rem (p-4) + chi·ªÅu cao c·ªßa nav (h-16 = 64px) */
            }
        }
        @media (min-width: 1024px) {
            /* Hi·ªán sidebar tr√™n desktop */
            #sidebar-desktop {
                transform: translateX(0);
                width: 16rem; /* w-64 */
            }
            /* Sidebar thu g·ªçn */
            #sidebar-desktop.collapsed {
                 width: 4.5rem; /* w-18 */
            }
            #sidebar-desktop.collapsed .sidebar-label,
            #sidebar-desktop.collapsed .profile-details,
            #sidebar-desktop.collapsed .logout-text,
            #sidebar-desktop.collapsed .app-title {
                display: none;
            }
            #sidebar-desktop.collapsed .nav-item,
            #sidebar-desktop.collapsed .profile-wrapper,
            #sidebar-desktop.collapsed .logout-btn {
                justify-content: center;
            }
            #sidebar-desktop.collapsed .profile-wrapper {
                padding-left: 0.5rem;
            }
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 font-sans h-screen overflow-hidden">

    <div id="app" class="h-full w-full"></div>

    <div id="toast-container" class="fixed top-4 right-4 z-50 flex flex-col gap-2"></div>
    
    <div id="avatar-modal-container"></div>
    
    <!-- M·ªöI: Overlay cho Mobile Sidebar -->
    <div id="mobile-overlay" class="fixed inset-0 bg-black bg-opacity-50 transition-opacity" onclick="toggleSidebar(false)"></div>


    <script type="module">
         import { initializeApp, deleteApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        //import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithCustomToken, onAuthStateChanged, signOut, signInAnonymously,
                 createUserWithEmailAndPassword, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, addDoc, updateDoc, onSnapshot, serverTimestamp, query, where, getDocs, deleteDoc, runTransaction, arrayRemove, arrayUnion } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getStorage, ref as storageRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js"; // TH√äM FIREBASE STORAGE

        // --- 1. CONFIGURATION ---
        let appId, firebaseConfig;
        const TEACHER_CODE = "ruands10"; // M√£ x√°c nh·∫≠n gi√°o vi√™n

        try {
            if (typeof __firebase_config !== 'undefined') {
                firebaseConfig = JSON.parse(__firebase_config);
            } else {
                // Fallback config (Public Demo)
                firebaseConfig = {
                    apiKey: "AIzaSyBTHcX_Ha3CZPNHY8vcWilcOe4oF3f6rKU",
                    authDomain: "lmsapp-19548.firebaseapp.com",
                    projectId: "lmsapp-19548",
                    storageBucket: "lmsapp-19548.firebasestorage.app",
                    messagingSenderId: "584664617140",
                    appId: "1:584664617140:web:8ffa1650976191c45887e1",
                    measurementId: "G-1TK7RW8H15"
                };
            }
            appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        } catch (e) { console.error(e); firebaseConfig = {}; }

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app); // KH·ªûI T·∫†O STORAGE
        
        // Helper Paths
        const getPath = (col) => `artifacts/${appId}/public/data/${col}`;
        const getRef = (col) => collection(db, 'artifacts', appId, 'public', 'data', col);

        // --- 2. STATE MANAGEMENT ---
        const state = {
            user: null,
            profile: null,
            view: 'dashboard', 
            data: {
                assignments: [],
                submissions: [],
                users: [],
                matches: [],
                vocabulary: [], // Store loaded vocabulary here
                questionBanks: [], // Ng√¢n h√†ng ƒë·ªÅ
                classes: [], // Danh s√°ch l·ªõp h·ªçc
            },
            ui: {
                isCreatingAssignment: false,
                takingAssignmentId: null,
                currentQuestionIndex: 0,
                assignmentAnswers: {},
                newAssignment: { title: '', questions: [], selectedClassIds: [] }, 
                activeMatch: null,
                matchQIndex: 0,
                authMode: 'login',
                newQuestionType: 'mcq',
                competitionMode: 'lobby',
                lastFinishedMatch: null,
                hasAnsweredCurrentQ: false,
                viewAssignmentId: null,
                viewSubmission: null,
                bankMode: 'list',
                selectedBankId: null,
                isSelectingBankQuestions: false,
                viewClassId: null, 
                isCreatingClass: false, 
                isManagingStudent: false, 
                isProcessingStudentCreation: false,
                viewClassMode: 'students', 
                isImportingBankData: false,
                importQType: 'vocab_mcq', 
                // M·ªöI: Tr·∫°ng th√°i Modal Avatar
                isAvatarModalOpen: false,
                tempAvatarUrl: null, // L∆∞u tr·ªØ t·∫°m th·ªùi URL ·∫£nh t·∫£i l√™n ho·∫∑c emoji
                tempAvatarType: null, // 'emoji' ho·∫∑c 'url'
                
                // --- M·ªöI: RESPONSIVE UI STATE ---
                isSidebarOpen: window.innerWidth >= 1024, // M·ªü m·∫∑c ƒë·ªãnh tr√™n Desktop
                isSidebarCollapsed: false, // Tr·∫°ng th√°i thu g·ªçn tr√™n Desktop
                
                // --- M·ªöI: Th·ªëng k√™ l·ªõp h·ªçc ---
                selectedStatAssignmentId: null, // ID b√†i t·∫≠p ƒëang xem th·ªëng k√™

                // --- M·ªöI: Student Class View State ---
                viewMyClassId: null, // ID c·ªßa l·ªõp h·ªçc sinh ƒëang xem chi ti·∫øt
                isJoiningClass: false, // Tr·∫°ng th√°i modal nh·∫≠p m√£ l·ªõp
                isBulkModalOpen: false,
                isBulkCreating: false,
            },
            isAuthReady: false,
            initialAuthToken: typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null,
            areAssignmentsListenersActive: false 
        };
        
        // M·ªöI: DANH S√ÅCH EMOJI
        const EMOJI_AVATARS = ['üêº','üôé‚Äç‚ôÇÔ∏è','üåã','üíÇ','üôç','ü¶∏','üêØ','üêò','üê¢','üêù', 'üéÖ', 'üßô', 'üê∂', 'üêÆ', 'üê∞', 
                                                         'üêã', 'üêµ', '‚òÉÔ∏è', 'ü¶ã', 'ü§π‚Äç‚ôÇÔ∏è', 'üêì', 'üê¨', 'üê∑', 'üåé', 'üéØ','üéì', 'üò∫', 'üöÄ', 'üí°',
                                                        'üïµÔ∏è', 'üß†', 'ü¶â', 'ü¶ä', 'üêª', 'üêº', 'üíª', 'üßë‚Äçüéì', 'üë®‚Äçüè´', 'üèÜ', 'ü•á', 'ü•à', 'ü•â',
                                                        'üê≤', 'ü¶Ñ', 'ü§ñ'];

        // H√†m t·∫°o m√£ ph√≤ng ng·∫´u nhi√™n 6 k√Ω t·ª±
        const generateRoomCode = () => {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let code = '';
            for (let i = 0; i < 6; i++) {
                code += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return code;
        };
        
        // --- M·ªöI: RESPONSIVE HANDLERS ---
        window.toggleSidebar = (force) => {
            if (window.innerWidth < 1024) {
                 // Mobile: Toggle open/close
                state.ui.isSidebarOpen = (force !== undefined) ? force : !state.ui.isSidebarOpen;
            } else {
                // Desktop: Toggle collapse/expand
                 state.ui.isSidebarCollapsed = (force !== undefined) ? force : !state.ui.isSidebarCollapsed;
            }
            renderApp();
        };

        window.toggleCollapse = () => {
            if (window.innerWidth >= 1024) {
                state.ui.isSidebarCollapsed = !state.ui.isSidebarCollapsed;
                renderApp();
            }
        }
        
// --- S·ª¨A L·ªñI NH√ÅY M√ÄN H√åNH KHI NH·∫¨P LI·ªÜU MOBILE ---
let lastWidth = window.innerWidth; // L∆∞u l·∫°i chi·ªÅu r·ªông ban ƒë·∫ßu

window.addEventListener('resize', () => {
    const currentWidth = window.innerWidth;

    // QUAN TR·ªåNG: N·∫øu chi·ªÅu r·ªông kh√¥ng ƒë·ªïi (ch·ªâ ƒë·ªïi chi·ªÅu cao do b√†n ph√≠m hi·ªán), th√¨ KH√îNG l√†m g√¨ c·∫£.
    if (currentWidth === lastWidth) return;
    
    // C·∫≠p nh·∫≠t l·∫°i chi·ªÅu r·ªông m·ªõi
    lastWidth = currentWidth;

    const isDesktop = currentWidth >= 1024;
    if (isDesktop && !state.ui.isSidebarOpen) {
        state.ui.isSidebarOpen = true; 
    } else if (!isDesktop && state.ui.isSidebarCollapsed) {
        state.ui.isSidebarCollapsed = false; 
    }
    
    if (state.user && state.profile) renderApp();
});


        // --- 3. UTILITIES & DATA LOADING ---

        window.showToast = (msg, type = 'success') => {
            const container = document.getElementById('toast-container');
            const el = document.createElement('div');
            const color = type === 'error' ? 'bg-red-500' : 'bg-green-600';
            el.className = `${color} text-white px-6 py-3 rounded-lg shadow-xl animate-bounce mb-2 transition-all duration-500`;
            el.textContent = msg;
            container.appendChild(el);
            setTimeout(() => {
                el.style.opacity = '0';
                setTimeout(() => el.remove(), 500);
            }, 3000);
        };

        const renderIcons = () => lucide.createIcons();
        
        // H√†m tr·ªôn m·∫£ng
        const shuffleArray = (array) => {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[i], array[j]];
            }
            return array;
        };

        /**
         * Chuy·ªÉn ƒë·ªïi m·ªôt t·ª´ ho·∫∑c c√¢u ti·∫øng Trung sang √¢m thanh
         * @param {string} text - VƒÉn b·∫£n c·∫ßn ph√°t √¢m
         * @param {string} lang - Ng√¥n ng·ªØ (m·∫∑c ƒë·ªãnh 'zh-CN' cho ti·∫øng Trung)
         */
        window.speakWord = (text, lang = 'zh-CN') => {
            if ('speechSynthesis' in window) {
                window.speechSynthesis.cancel();
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = lang; 
                utterance.rate = 0.8; // H∆°i ch·∫≠m l·∫°i ƒë·ªÉ r√µ r√†ng
                
                window.speechSynthesis.speak(utterance);
            } else {
                showToast("Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ √¢m thanh.", "error");
            }
        };

        // LOAD DATA FROM LOCAL FILE (Kh√¥ng thay ƒë·ªïi)
        const loadVocabulary = async () => {
            try {
                const response = await fetch('dataLMS/data.txt');
                
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                
                const text = await response.text();
                const vocab = text.split('\n')
                    .map(line => line.trim())
                    .filter(line => line.length > 0)
                    .map(line => {
                        const parts = line.split('|');
                        if (parts.length >= 3) {
                            return { word: parts[0].trim(), pinyin: parts[1].trim(), meaning: parts[2].trim() };
                        }
                        return null;
                    })
                    .filter(item => item !== null);

                if (vocab.length === 0) throw new Error("File r·ªóng");
                
                state.data.vocabulary = vocab;

            } catch (e) {
                console.warn("Kh√¥ng load ƒë∆∞·ª£c dataLMS/data.txt, s·ª≠ d·ª•ng d·ªØ li·ªáu m·∫´u.", e);
                // D·ªØ li·ªáu m·∫´u fallback
                state.data.vocabulary = [
                    { word: '‰Ω†Â•Ω', pinyin: 'n«ê h«éo', meaning: 'Xin ch√†o' },
                    { word: 'Ë∞¢Ë∞¢', pinyin: 'xi√®xie', meaning: 'C·∫£m ∆°n' },
                    { word: 'ÂÜçËßÅ', pinyin: 'z√†iji√†n', meaning: 'T·∫°m bi·ªát' },
                    { word: 'ËÄÅÂ∏à', pinyin: 'l«éoshƒ´', meaning: 'Gi√°o vi√™n' },
                    { word: 'Â≠¶Áîü', pinyin: 'xu√©sheng', meaning: 'H·ªçc sinh' },
                    { word: 'ÊúãÂèã', pinyin: 'p√©ngyou', meaning: 'B·∫°n b√®' },
                    { word: 'Áà±', pinyin: '√†i', meaning: 'Y√™u' },
                    { word: 'ÂñúÊ¨¢', pinyin: 'x«êhuan', meaning: 'Th√≠ch' },
                    { word: 'Áå´', pinyin: 'mƒÅo', meaning: 'Con m√®o' },
                    { word: 'Áãó', pinyin: 'g«íu', meaning: 'Con ch√≥' },
                    { word: 'Ê∞¥', pinyin: 'shu«ê', meaning: 'N∆∞·ªõc' },
                    { word: '‰π¶', pinyin: 'sh≈´', meaning: 'S√°ch' }
                ];
                if (state.view === 'competition') {
                    showToast("ƒêang d√πng d·ªØ li·ªáu m·∫´u (kh√¥ng t√¨m th·∫•y dataLMS/data.txt)", "error");
                }
            }
        };

        // --- 4. LOGIC T·∫†O C√ÇU H·ªéI ƒê·∫§U TR∆Ø·ªúNG M·ªöI (Gi·ªØ nguy√™n) ---
        const generateArenaQuestions = () => {
            const vocabList = state.data.vocabulary;
            const questions = [];
            if (vocabList.length < 4) return [];

            const NUM_QUESTION_TYPES = 7; 

            for(let i = 0; i < 10; i++) {
                const correctItem = vocabList[Math.floor(Math.random() * vocabList.length)];
                const type = Math.floor(Math.random() * NUM_QUESTION_TYPES) + 1; 
                let qText = "", qOptions = [], correctAnswerVal = "", audioWord = null, audioSentence = null;
                let qTypeId = type; 

                const distractors = [];
                while(distractors.length < 3) {
                    const item = vocabList[Math.floor(Math.random() * vocabList.length)];
                    if (item.word !== correctItem.word && !distractors.includes(item)) distractors.push(item);
                }
                
                const sentence = `ÊàëÂñúÊ¨¢${correctItem.word}„ÄÇ`;
                
                switch(type) {
                    case 1: 
                        qText = `Nghƒ©a c·ªßa t·ª´ <span class="text-blue-600 font-bold text-3xl mx-2">${correctItem.word}</span> l√† g√¨?`;
                        correctAnswerVal = correctItem.meaning;
                        qOptions = [correctItem.meaning, ...distractors.map(d => d.meaning)];
                        break;
                    case 2: 
                        qText = `Pinyin c·ªßa t·ª´ <span class="text-blue-600 font-bold text-3xl mx-2">${correctItem.word}</span> l√† g√¨?`;
                        correctAnswerVal = correctItem.pinyin;
                        qOptions = [correctItem.pinyin, ...distractors.map(d => d.pinyin)];
                        break;
                    case 3: 
                        qText = `T·ª´ n√†o c√≥ nghƒ©a l√† <span class="text-green-600 font-bold text-2xl mx-2">"${correctItem.meaning}"</span>?`;
                        correctAnswerVal = correctItem.word;
                        qOptions = [correctItem.word, ...distractors.map(d => d.word)];
                        break;
                    case 4: 
                        qText = `Nghe v√† ch·ªçn t·ª´ v·ª±ng ƒë√∫ng:`;
                        audioWord = correctItem.word;
                        correctAnswerVal = correctItem.word;
                        qOptions = [correctItem.word, ...distractors.map(d => d.word)];
                        break;
                    case 5: 
                        qText = `Nghe v√† ch·ªçn nghƒ©a ƒë√∫ng:`;
                        audioWord = correctItem.word;
                        correctAnswerVal = correctItem.meaning;
                        qOptions = [correctItem.meaning, ...distractors.map(d => d.meaning)];
                        break;
                    case 6: 
                        qTypeId = 6;
                        qText = `Nghe c√¢u v√† ch·ªçn nghƒ©a ƒë√∫ng:`;
                        audioSentence = sentence;
                        correctAnswerVal = `T√¥i th√≠ch ${correctItem.meaning}.`; 
                        const sentenceMeanings = [`T√¥i th√≠ch ${correctItem.meaning}.`];
                        while(sentenceMeanings.length < 4) {
                             const distractorItem = vocabList[Math.floor(Math.random() * vocabList.length)];
                             const distractorMeaning = `T√¥i th√≠ch ${distractorItem.meaning}.`;
                             if (!sentenceMeanings.includes(distractorMeaning)) {
                                 sentenceMeanings.push(distractorMeaning);
                             }
                        }
                        qOptions = sentenceMeanings;
                        break;
                    case 7: 
                        qTypeId = 7;
                        qText = `Nghe v√† vi·∫øt l·∫°i c√¢u ti·∫øng Trung:`;
                        audioSentence = sentence;
                        correctAnswerVal = sentence;
                        qOptions = []; 
                        break;
                }
                
                const shuffledOptions = qOptions.sort(() => Math.random() - 0.5);
                
                if (qTypeId === 7) {
                    questions.push({
                        type: 'arena_input', 
                        qTypeId: type,
                        text: qText,
                        audioSentence: audioSentence,
                        correct: correctAnswerVal 
                    });
                } else {
                    questions.push({
                        type: 'arena_quiz',
                        qTypeId: type,
                        text: qText,
                        options: shuffledOptions,
                        correct: shuffledOptions.indexOf(correctAnswerVal),
                        audioWord: audioWord,
                        audioSentence: audioSentence 
                    });
                }
            }
            return questions;
        };
        
        // M·ªöI: H√ÄM RENDER AVATAR (Gi·ªØ nguy√™n)
        const renderAvatar = (userProfile, size = 'w-10 h-10', textSize = 'text-base') => {
            // X√°c ƒë·ªãnh xem c√≥ ph·∫£i profile t·∫°m th·ªùi (modal) hay kh√¥ng
            const isTempProfile = userProfile === state.profile && state.ui.isAvatarModalOpen;
            const profileToRender = isTempProfile ? {
                avatarUrl: state.ui.tempAvatarUrl || state.profile?.avatarUrl,
                avatarType: state.ui.tempAvatarType || state.profile?.avatarType,
                name: state.profile?.name,
                role: state.profile?.role
            } : userProfile;
            
            if (profileToRender?.avatarUrl && profileToRender.avatarType === 'url') {
                // ·∫¢nh t·∫£i l√™n
                return `<img src="${profileToRender.avatarUrl}" alt="${profileToRender.name?.charAt(0) || '?'}" class="${size} rounded-full object-cover border-2 border-white shadow-md">`;
            } else if (profileToRender?.avatarUrl && profileToRender.avatarType === 'emoji') {
                 // Emoji
                return `<div class="${size} rounded-full flex items-center justify-center bg-white border border-slate-200 shadow-inner">
                            <span class="${textSize}">${profileToRender.avatarUrl}</span>
                        </div>`;
            } else {
                // Default (Ch·ªØ c√°i ƒë·∫ßu t√™n)
                const bgColor = profileToRender?.role === 'teacher' ? 'bg-purple-500' : 'bg-blue-500';
                const initials = profileToRender?.name?.charAt(0) || '?';
                return `<div class="${size} rounded-full flex items-center justify-center font-bold text-white ${bgColor} border-2 border-white shadow-md">
                            <span class="${textSize}">${initials}</span>
                        </div>`;
            }
        };


        // --- 5. SETUP LISTENERS & AUTH (Gi·ªØ nguy√™n) ---

        const initAuth = async () => {
            await loadVocabulary();
            if (state.initialAuthToken) {
                await signInWithCustomToken(auth, state.initialAuthToken);
            }
        };

        // H√†m kh·ªüi t·∫°o c√°c listeners ph·ª• thu·ªôc v√†o state.profile.classIds
        const initializeStudentDataListeners = (uid) => {
            if (state.areAssignmentsListenersActive) return;

            // 1. Assignments Listener
            onSnapshot(getRef('assignments'), (snap) => {
                const myClassIds = state.profile?.classIds || [];
                const isTeacher = state.profile?.role === 'teacher';
                
                const allAssignments = snap.docs.map(d => ({id: d.id, ...d.data()}));
                
                // L·ªçc b√†i t·∫≠p theo l·ªõp
                const filteredAssignments = allAssignments.filter(a => {
                    // N·∫øu l√† gi√°o vi√™n, th·∫•y b√†i c·ªßa m√¨nh
                    if (isTeacher && a.createdBy === uid) return true; 
                    // N·∫øu l√† h·ªçc sinh, th·∫•y b√†i t·∫≠p ƒë∆∞·ª£c giao cho b·∫•t k·ª≥ l·ªõp n√†o c·ªßa h·ªç
                    if (!isTeacher && a.classIds && Array.isArray(a.classIds)) {
                        return a.classIds.some(classId => myClassIds.includes(classId));
                    }
                    return false;
                });
                
                state.data.assignments = filteredAssignments;
                if(state.view === 'assignments' || state.view === 'dashboard' || state.ui.viewAssignmentId || (state.ui.viewClassId && state.ui.viewClassMode !== 'students') || state.ui.viewMyClassId) renderApp();
            });
            
            // 2. Submissions Listener
            onSnapshot(getRef('submissions'), (snap) => {
                state.data.submissions = snap.docs.map(d => ({id: d.id, ...d.data()}));
                if(state.view === 'assignments' || state.view === 'dashboard' || state.ui.viewSubmission || (state.ui.viewClassId && state.ui.viewClassMode === 'stats') || state.ui.viewMyClassId) renderApp();
            });

            state.areAssignmentsListenersActive = true;
        }

        const setupListeners = (uid) => {
            // Bi·∫øn ƒë·ªÉ theo d√µi xem profile ƒë√£ ƒë∆∞·ª£c load l·∫ßn ƒë·∫ßu ch∆∞a
            let isProfileLoaded = false; 

            // 1. Profile Listener (QUAN TR·ªåNG: Ph·∫£i ch·∫°y tr∆∞·ªõc ƒë·ªÉ l·∫•y classIds)
            onSnapshot(doc(db, getPath('users'), uid), (snap) => {
                if(snap.exists()) {
                    state.profile = snap.data();
                    if (!state.ui.isProcessingStudentCreation) {
                         renderApp();
                    }
                    
                    // Ch·ªâ kh·ªüi t·∫°o c√°c listeners ph·ª• thu·ªôc khi profile ƒë∆∞·ª£c t·∫£i l·∫ßn ƒë·∫ßu ho·∫∑c thay ƒë·ªïi
                    if (!isProfileLoaded && state.profile) {
                        isProfileLoaded = true;
                        initializeStudentDataListeners(uid);
                    }

                } else if (state.user) {
                    state.profile = null;
                    renderApp();
                }
            });
            
            // 2. Users (Rank, Students list)
            onSnapshot(getRef('users'), (snap) => {
                state.data.users = snap.docs.map(d => ({id: d.id, ...d.data()}));
                if(!state.ui.isProcessingStudentCreation && (state.view === 'ranking' || state.ui.viewClassId || state.ui.viewMyClassId)) renderApp();
            });
            
            // 3. Question Banks
            onSnapshot(getRef('question_banks'), (snap) => {
                state.data.questionBanks = snap.docs.map(d => ({id: d.id, ...d.data()}));
                if(state.view === 'question_bank') renderApp();
            });
            
            // 4. Classes (C·∫≠p nh·∫≠t classIds cho h·ªçc sinh)
            onSnapshot(getRef('classes'), (snap) => {
                 const myClasses = snap.docs.map(d => ({id: d.id, ...d.data()}))
                 
                 if (state.profile?.role === 'teacher') {
                     state.data.classes = myClasses.filter(c => c.teacherId === uid);
                 } else if (state.profile?.role === 'student' && state.user) {
                     const studentClasses = myClasses.filter(c => (c.studentIds || []).includes(uid));
                     const studentClassIds = studentClasses.map(c => c.id);
                     
                     if (state.profile) {
                         // C·∫≠p nh·∫≠t classIds trong profile. S·ª± ki·ªán n√†y s·∫Ω k√≠ch ho·∫°t Profile Listener ch·∫°y l·∫°i.
                         state.profile.classIds = studentClassIds; 
                         // K√≠ch ho·∫°t renderApp() n·∫øu ƒëang ·ªü ch·∫ø ƒë·ªô xem l·ªõp (ho·∫∑c Assignments n·∫øu c·∫ßn)
                         // Tuy nhi√™n, vi·ªác n√†y s·∫Ω ƒë∆∞·ª£c x·ª≠ l√Ω b·ªüi Profile Listener.
                     }
                     state.data.classes = studentClasses;
                 } else {
                      state.data.classes = [];
                 }
                 
                 if(state.view === 'classes' || state.ui.viewClassId || state.view === 'my_classes') renderApp();
            });
            
            // 5. Match Listener (Gi·ªØ nguy√™n)
            onSnapshot(getRef('matches'), (snap) => {
                state.data.matches = snap.docs.map(d => ({id: d.id, ...d.data()}));
                const uid = state.user?.uid;
                const prevMatch = state.ui.activeMatch; 
                const prevMode = state.ui.competitionMode;

                state.ui.activeMatch = state.data.matches.find(m => 
                    (m.player1?.uid === uid || m.player2?.uid === uid) && m.status !== 'finished'
                );
                
                let newMode = 'lobby';
                if (state.ui.activeMatch) {
                    newMode = state.ui.activeMatch.status === 'playing' ? 'playing' : 'waiting';
                }

                const isPlayingContainerExists = document.getElementById('match-playing-container');
                const isSameMode = prevMode === 'playing' && newMode === 'playing';

                if (prevMatch && prevMatch.status === 'playing' && newMode !== 'playing') {
                     const finishedMatch = state.data.matches.find(m => m.id === prevMatch.id && m.status === 'finished');
                     if (finishedMatch) {
                        state.ui.lastFinishedMatch = finishedMatch;
                        
                         deleteDoc(doc(db, getPath('matches'), finishedMatch.id))
                             .catch(e => console.error("Error deleting finished match:", e));
                     }
                }
                
                if (prevMatch && prevMatch.status === 'playing' && state.ui.activeMatch === null) {
                    const finishedMatch = state.ui.lastFinishedMatch;

                    if (finishedMatch) {
                        const isP1 = finishedMatch.player1.uid === uid;
                        const myScore = isP1 ? finishedMatch.player1.score : finishedMatch.player2.score;
                        const opponentScore = isP1 ? finishedMatch.player2.score : finishedMatch.player1.score;

                        let message;
                        let type;

                        if (myScore > opponentScore) {
                            message = `üèÜ CH√öC M·ª™NG! B·∫°n ƒë√£ chi·∫øn th·∫Øng v·ªõi ${myScore} - ${opponentScore} ƒëi·ªÉm!`;
                            type = 'success';
                        } else if (myScore < opponentScore) {
                            message = `üò≠ H√£y c·ªë g·∫Øng h∆°n n·ªØa! B·∫°n ƒë√£ thua ${myScore} - ${opponentScore} ƒëi·ªÉm.`;
                            type = 'error';
                        } else {
                            message = `ü§ù H√íA! Tr·∫≠n ƒë·∫•u k·∫øt th√∫c v·ªõi t·ª∑ s·ªë ${myScore} - ${opponentScore}.`;
                            type = 'success';
                        }
                        showToast(message, type);
                    }
                    
                    state.ui.competitionMode = 'lobby';
                    state.ui.lastFinishedMatch = null;
                    state.ui.hasAnsweredCurrentQ = false; 
                    renderApp();
                    return;
                }

                if (state.ui.activeMatch && prevMatch && state.ui.activeMatch.qIndex !== prevMatch.qIndex) {
                    state.ui.hasAnsweredCurrentQ = false;
                }

                state.ui.competitionMode = newMode; 

                if (state.view === 'competition') {
                    if (isSameMode && isPlayingContainerExists) {
                        if (
                            !prevMatch || 
                            prevMatch.player1.score !== state.ui.activeMatch.player1.score || 
                            prevMatch.player2.score !== state.ui.activeMatch.player2.score ||
                            state.ui.activeMatch.qIndex !== prevMatch.qIndex 
                        ) {
                            state.ui.matchQIndex = state.ui.activeMatch.qIndex || 0; 
                            updatePlayingUI();
                        }
                    } else {
                        if (state.ui.activeMatch) {
                            state.ui.matchQIndex = state.ui.activeMatch.qIndex || 0; 
                        }
                        renderApp();
                    }
                }
            });
        };
        
        // --- Smart UI Update (Cho l·ªói Scroll Jump) ---
        const updateMainContent = () => {
            const mainEl = document.querySelector('main');
            if (mainEl) {
                mainEl.innerHTML = renderViewContent();
                renderIcons();
            }
            
            // RENDER MODAL NH·∫¨P D·ªÆ LI·ªÜU
            const appEl = document.getElementById('app');
            // C·∫ßn x√≥a modal import data c≈© tr∆∞·ªõc khi render l·∫°i
            const existingImportModal = document.querySelector('.fixed.inset-0.bg-slate-900.bg-opacity-70:not(#avatar-modal-container > div)');
            if (existingImportModal) existingImportModal.remove();

            if (state.ui.isImportingBankData) {
                 appEl.insertAdjacentHTML('beforeend', renderImportDataModal());
                 renderIcons();
            }
        }
        
        const renderApp = () => {
            const appEl = document.getElementById('app');
            const modalEl = document.getElementById('avatar-modal-container');
            const overlayEl = document.getElementById('mobile-overlay'); // M·ªöI

            
            if (state.ui.isProcessingStudentCreation) {
                 appEl.innerHTML = `
                    <div class="fixed inset-0 bg-slate-900 bg-opacity-90 flex flex-col items-center justify-center z-50 text-white fade-in">
                        <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-blue-500 mb-4"></div>
                        <p class="text-xl font-bold">ƒêang x·ª≠ l√Ω...</p>
                        <p class="text-sm text-slate-400 mt-2">Vui l√≤ng ch·ªù gi√¢y l√°t</p>
                    </div>
                `;
                // ƒê·∫£m b·∫£o modal avatar ƒë∆∞·ª£c ·∫©n khi ƒëang x·ª≠ l√Ω
                modalEl.innerHTML = '';
                return;
            }

            if (!state.isAuthReady || !state.user || !state.profile) {
                appEl.innerHTML = renderAuthScreen();
                // ƒê·∫£m b·∫£o modal avatar ƒë∆∞·ª£c ·∫©n khi ·ªü m√†n h√¨nh ƒëƒÉng nh·∫≠p
                modalEl.innerHTML = '';
                renderIcons();
            } else {
                // Gi·ªØ l·∫°i layout ch√≠nh (Sidebar + Header + Bottom Nav) n·∫øu ƒë√£ t·ªìn t·∫°i
                if (!document.getElementById('main-layout-wrapper')) {
                    appEl.innerHTML = renderMainLayout();
                }
                
                // C·∫¨P NH·∫¨T TR·∫†NG TH√ÅI SIDEBAR
                const sidebarEl = document.getElementById('sidebar-desktop');
                if (sidebarEl) {
                    sidebarEl.classList.toggle('open', window.innerWidth < 1024 && state.ui.isSidebarOpen);
                    sidebarEl.classList.toggle('collapsed', window.innerWidth >= 1024 && state.ui.isSidebarCollapsed);
                }
                if (overlayEl) {
                    overlayEl.classList.toggle('open', window.innerWidth < 1024 && state.ui.isSidebarOpen);
                }
                const headerScoreEl = document.getElementById('header-points');
                if (headerScoreEl && state.profile) {
                     headerScoreEl.textContent = state.profile.points;
                }
                // Ch·ªâ c·∫≠p nh·∫≠t n·ªôi dung c·ªßa MAIN (v√† modal import data n·∫øu c√≥)
                updateMainContent();
            }
            
            // **FIX QUAN TR·ªåNG:** Ph·∫£i render Avatar Modal v√†o container ri√™ng (ƒê√∫ng v·ªã tr√≠)
            if (state.ui.isAvatarModalOpen) {
                modalEl.innerHTML = renderAvatarModal();
                renderIcons();
            } else {
                modalEl.innerHTML = '';
            }
        };
        
        // --- 6. RENDERERS ---

const renderAuthScreen = () => {
            const isRegister = state.ui.authMode === 'register';
            // L·∫•y role hi·ªán t·∫°i ƒë·ªÉ gi·ªØ tr·∫°ng th√°i khi render l·∫°i
            const currentRole = document.querySelector('input[name="role"]:checked')?.value || 'student';
            
            return `
                <div class="min-h-screen bg-slate-900 flex items-center justify-center p-4 relative">
                    <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md fade-in relative z-10">
                        <div class="text-center mb-8">
                            <div class="bg-blue-600 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4">
                                <i data-lucide="book-open" class="text-white w-8 h-8"></i>
                            </div>
                            <h1 class="text-3xl font-bold text-slate-800">EduBattle</h1>
                            <p class="text-slate-500">N·ªÅn t·∫£ng h·ªçc t·∫≠p & thi ƒë·∫•u</p>
                        </div>
                        
                        <h2 class="text-2xl font-bold text-slate-800 mb-6 text-center">${isRegister ? 'ƒêƒÉng k√Ω t√†i kho·∫£n m·ªõi' : 'ƒêƒÉng nh·∫≠p'}</h2>
                        
                        <form onsubmit="${isRegister ? 'handleRegister(event)' : 'handleLogin(event)'}" class="space-y-4">
                            ${isRegister ? `
                                <div><input id="join-name" type="text" required class="w-full p-3 border rounded-lg focus:ring-blue-500 focus:border-blue-500" placeholder="H·ªç v√† t√™n"></div>
                                <div><input id="join-email" type="email" required class="w-full p-3 border rounded-lg focus:ring-blue-500 focus:border-blue-500" placeholder="Email"></div>
                                <div><input id="join-password" type="password" required class="w-full p-3 border rounded-lg focus:ring-blue-500 focus:border-blue-500" placeholder="M·∫≠t kh·∫©u"></div>
                                <div class="grid grid-cols-2 gap-4">
                                    <label class="cursor-pointer border p-2 rounded-lg text-center transition hover:bg-slate-100 ${currentRole === 'student' ? 'border-blue-500 bg-blue-50' : 'border-slate-200'}">
                                        <input type="radio" name="role" value="student" ${currentRole === 'student' ? 'checked' : ''} onchange="renderApp()" class="mr-1"> H·ªçc sinh
                                    </label>
                                    <label class="cursor-pointer border p-2 rounded-lg text-center transition hover:bg-slate-100 ${currentRole === 'teacher' ? 'border-purple-500 bg-purple-50' : 'border-slate-200'}">
                                        <input type="radio" name="role" value="teacher" ${currentRole === 'teacher' ? 'checked' : ''} onchange="renderApp()" class="mr-1"> Gi√°o vi√™n
                                    </label>
                                </div>
                                
                                ${currentRole === 'teacher' ? 
                                    '<input id="teacher-code" type="text" class="w-full p-3 border border-purple-300 rounded-lg focus:ring-purple-500 focus:border-purple-500" placeholder="M√£ gi√°o vi√™n (ruands10)">' : 
                                    '<input id="class-code-input" type="text" class="w-full p-3 border border-green-300 rounded-lg focus:ring-green-500 focus:border-green-500" placeholder="M√£ l·ªõp h·ªçc (T√πy ch·ªçn, 6 k√Ω t·ª±)">'}

                                <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-3 rounded-lg font-bold shadow-lg transition transform hover:-translate-y-0.5">ƒêƒÉng k√Ω t√†i kho·∫£n</button>
                            ` : `
                                <div><input id="login-email" type="email" required class="w-full p-3 border rounded-lg focus:ring-green-500 focus:border-green-500" placeholder="Email"></div>
                                <div><input id="login-password" type="password" required class="w-full p-3 border rounded-lg focus:ring-green-500 focus:border-green-500" placeholder="M·∫≠t kh·∫©u"></div>
                                <button type="submit" class="w-full bg-green-600 hover:bg-green-700 text-white py-3 rounded-lg font-bold shadow-lg transition transform hover:-translate-y-0.5">ƒêƒÉng nh·∫≠p</button>
                            `}
                        </form>

                        <div class="mt-6 pt-4 border-t text-center text-sm">
                            <button onclick="setAuthMode('${isRegister ? 'login' : 'register'}')" class="font-bold text-blue-600 hover:text-blue-700 transition">
                                ${isRegister ? 'ƒê√£ c√≥ t√†i kho·∫£n? ƒêƒÉng nh·∫≠p' : 'Ch∆∞a c√≥ t√†i kho·∫£n? ƒêƒÉng k√Ω ngay'}
                            </button>
                        </div>
                        
                        <div class="mt-4 text-center">
                            <button onclick="toggleBulkModal(true)" class="text-xs text-slate-500 underline hover:text-purple-600 transition">
                                <i data-lucide="users" size="14" class="inline"></i> T·∫°o t√†i kho·∫£n h·ªçc sinh h√†ng lo·∫°t (GV)
                            </button>
                        </div>
                    </div>

${state.ui.isBulkModalOpen ? `
                    <div class="fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50 p-4 fade-in">
                        <div class="bg-white rounded-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto p-6 md:p-8 relative">
                            
                            <div class="flex justify-between items-center mb-6 border-b pb-4 sticky top-0 bg-white z-10">
                                <h3 class="text-2xl font-bold text-purple-700">T·∫°o t√†i kho·∫£n h√†ng lo·∫°t</h3>
                                        <button onclick="toggleBulkModal(false)" 
                                        class="p-2 bg-slate-100 rounded-full text-slate-500 hover:bg-red-100 hover:text-red-600 transition shadow-sm"
                                        title="ƒê√≥ng">
                                    <i data-lucide="x" size="16"></i>
                                </button>
                            </div>

                            <div class="space-y-4">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-bold text-slate-700 mb-1">M√£ Gi√°o Vi√™n (*)</label>
                                        <input id="bulk-teacher-code" type="text" class="w-full p-2 border rounded-lg focus:border-purple-500" placeholder="Nh·∫≠p: ruands10">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-bold text-slate-700 mb-1">M·∫≠t kh·∫©u chung (*)</label>
                                        <input id="bulk-password" type="text" class="w-full p-2 border rounded-lg focus:border-purple-500" placeholder="VD: 123456">
                                    </div>
                                </div>

                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 bg-blue-50 p-4 rounded-xl border border-blue-100">
                                    <div>
                                        <label class="block text-sm font-bold text-blue-800 mb-1">T√™n L·ªõp h·ªçc (L√†m ƒëu√¥i Email)</label>
                                        <input id="bulk-class-name" type="text" class="w-full p-2 border rounded-lg" placeholder="VD: HN1">
                                        <p class="text-xs text-blue-600 mt-1">VD nh·∫≠p "HN1" -> email: ten_hn1@gmail.com</p>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-bold text-blue-800 mb-1">M√£ L·ªõp (ƒê·ªÉ tham gia)</label>
                                        <input id="bulk-class-code" type="text" class="w-full p-2 border rounded-lg" placeholder="VD: 123456">
                                        <p class="text-xs text-slate-500 mt-1">M√£ ƒë·ªÉ h·ªçc sinh nh·∫≠p v√†o khi tham gia l·ªõp</p>
                                    </div>
                                </div>

                                <div>
                                    <label class="block text-sm font-bold text-slate-700 mb-1">Danh s√°ch H·ªçc sinh (M·ªói t√™n 1 d√≤ng)</label>
                                    <textarea id="bulk-student-list" rows="5" class="w-full p-3 border rounded-lg font-medium" placeholder="Nguy·ªÖn VƒÉn A&#10;Tr·∫ßn Th·ªã B&#10;L√™ VƒÉn C"></textarea>
                                </div>

                               <div class="border-t pt-4">
                                    <p class="text-sm font-bold text-slate-700 mb-2">Ho·∫∑c t·∫£i l√™n file CSV (N√¢ng cao)</p>
                                    <input type="file" id="bulk-csv-file" accept=".csv" class="block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-purple-50 file:text-purple-700 hover:file:bg-purple-100"/>
                                    <p class="text-xs text-blue-600 mt-1 font-bold">C·∫•u tr√∫c: T√™n HS, Email, M√£ l·ªõp, T√™n l·ªõp, M·∫≠t kh·∫©u (T√πy ch·ªçn)</p>
                                </div>

                                <div class="flex gap-3 pt-4 border-t mt-4">
                                    <button onclick="toggleBulkModal(false)" class="flex-1 py-3 rounded-xl font-bold text-slate-600 bg-slate-100 hover:bg-slate-200 transition">
                                        H·ªßy b·ªè
                                    </button>
                                    <button onclick="handleBulkCreate()" class="flex-[2] bg-purple-600 hover:bg-purple-700 text-white py-3 rounded-xl font-bold text-lg shadow-lg flex items-center justify-center gap-2 transition">
                                        <i data-lucide="user-plus"></i> B·∫Øt ƒë·∫ßu t·∫°o
                                    </button>
                                </div>
                                
                                <p id="bulk-status" class="text-center text-sm font-bold mt-2 text-slate-600"></p>
                            </div>
                        </div>
                    </div>` : ''}
                    </div>
            `;
        };

        const renderMainLayout = () => {
            const isDesktop = window.innerWidth >= 1024;
            const isCollapsed = state.ui.isSidebarCollapsed && isDesktop;

            return `
                <div id="main-layout-wrapper" class="flex h-screen bg-slate-50 overflow-hidden">
                    
                    <!-- Sidebar (Desktop/Mobile Menu) -->
                    <div id="sidebar-desktop" class="bg-slate-900 text-slate-300 flex flex-col shadow-xl flex-shrink-0 lg:w-64 transition-all duration-300 ${state.ui.isSidebarOpen ? 'open' : ''} ${isCollapsed ? 'collapsed' : ''}">
                        <div class="p-4 lg:p-6 border-b border-slate-800 flex items-center gap-3">
                            <div class="bg-blue-600 p-2 rounded-lg"><i data-lucide="book-open" class="text-white w-5 h-5"></i></div>
                            <h1 class="text-xl font-bold text-white app-title">EduBattle</h1>
                            <button onclick="toggleCollapse()" class="text-slate-500 hover:text-white transition hidden lg:block ml-auto ${isCollapsed ? 'rotate-180' : ''}">
                                <i data-lucide="chevrons-left" size="20"></i>
                            </button>
                        </div>
                        <nav class="flex-1 p-4 space-y-2 overflow-y-auto">
                            ${renderNavItem('dashboard', 'layout-dashboard', 'T·ªïng quan', isCollapsed)}
                            ${state.profile.role === 'teacher' ? renderNavItem('classes', 'graduation-cap', 'Qu·∫£n l√Ω L·ªõp h·ªçc', isCollapsed) : ''}
                            ${state.profile.role === 'student' ? renderNavItem('my_classes', 'graduation-cap', 'L·ªõp c·ªßa t√¥i', isCollapsed) : ''}
                            ${renderNavItem('assignments', 'book-open', 'B√†i t·∫≠p', isCollapsed)}
                            ${state.profile.role === 'teacher' ? renderNavItem('question_bank', 'library', 'Ng√¢n h√†ng ƒë·ªÅ', isCollapsed) : ''}
                            ${renderNavItem('competition', 'swords', 'ƒê·∫•u tr∆∞·ªùng', isCollapsed)}
                            ${renderNavItem('ranking', 'trophy', 'X·∫øp h·∫°ng', isCollapsed)}
                        </nav>
                        <div class="p-4 border-t border-slate-800">
                            <div class="flex items-center gap-3 mb-4 px-2 group cursor-pointer profile-wrapper" onclick="toggleAvatarModal(true)">
                                ${renderAvatar(state.profile, 'w-10 h-10', 'text-base')}
                                <div class="overflow-hidden profile-details">
                                    <p class="text-sm font-medium text-white truncate group-hover:text-blue-400 transition">${state.profile.name}</p>
                                    <p class="text-xs text-slate-400 capitalize">${state.profile.role === 'teacher' ? 'Gi√°o vi√™n' : 'H·ªçc sinh'}</p>
                                </div>
                                <i data-lucide="pencil" size="16" class="text-slate-500 group-hover:text-blue-400 transition ml-auto profile-details"></i>
                            </div>
                            <button onclick="handleSignOut()" class="w-full flex items-center gap-2 px-4 py-2 text-sm text-red-400 hover:bg-slate-800 rounded-lg transition-colors logout-btn">
                                <i data-lucide="log-out" size="16"></i> <span class="logout-text">ƒêƒÉng xu·∫•t</span>
                            </button>
                        </div>
                    </div>

                    <div class="flex-1 flex flex-col min-w-0">
                        <!-- Header (Responsive) -->
                        <header class="bg-white shadow-md lg:shadow-sm px-4 lg:px-8 py-3 lg:py-4 flex justify-between items-center z-10">
                            <!-- Mobile menu button -->
                            <button onclick="toggleSidebar(true)" class="lg:hidden text-slate-700 hover:text-blue-600 mr-3">
                                <i data-lucide="menu" size="24"></i>
                            </button>
                            <h2 class="text-xl md:text-2xl font-bold text-slate-800 capitalize truncate">
                                ${state.view === 'dashboard' ? 'T·ªïng quan' : 
                                  state.view === 'classes' ? 'Qu·∫£n l√Ω L·ªõp h·ªçc' : 
                                  state.view === 'my_classes' ? 'L·ªõp c·ªßa t√¥i' : 
                                  state.view === 'assignments' ? 'B√†i t·∫≠p v·ªÅ nh√†' :
                                  state.view === 'question_bank' ? 'Ng√¢n h√†ng ƒë·ªÅ' :
                                  state.view === 'competition' ? 'ƒê·∫•u tr∆∞·ªùng tr·ª±c tuy·∫øn' : 'B·∫£ng x·∫øp h·∫°ng'}
                            </h2>
	        <div class="px-3 py-1 bg-yellow-100 text-yellow-700 rounded-full text-sm font-bold flex items-center gap-1.5 ml-auto">
    		<i data-lucide="trophy" size="14"></i> 
    		<span class="hidden md:inline">ƒêi·ªÉm:</span> 
    		<span id="header-points">${state.profile.points}</span>
	        </div>
                        </header>
                        
                        <!-- Main Content -->
                        <main class="flex-1 overflow-y-auto p-4 lg:p-8 pb-16 lg:pb-8 fade-in">
                            ${renderViewContent()}
                        </main>
                        
                        <!-- M·ªöI: Mobile Bottom Navigation -->
                        <!-- FIX: ƒê·∫£m b·∫£o z-index cao v√† chi·ªÅu cao c·ªë ƒë·ªãnh -->
                        <nav id="mobile-bottom-nav" class="fixed bottom-0 left-0 right-0 lg:hidden bg-white border-t border-slate-200 shadow-2xl z-20 h-16">
                            <div class="flex justify-around items-center h-full">
                                ${renderMobileNavItem('dashboard', 'layout-dashboard', 'T·ªïng quan')}
                                ${state.profile.role === 'teacher' ? renderMobileNavItem('classes', 'graduation-cap', 'L·ªõp h·ªçc') : ''}
                                ${state.profile.role === 'student' ? renderMobileNavItem('my_classes', 'graduation-cap', 'L·ªõp c·ªßa t√¥i') : ''}
                                ${renderMobileNavItem('assignments', 'book-open', 'B√†i t·∫≠p')}
                                ${renderMobileNavItem('competition', 'swords', 'ƒê·∫•u tr∆∞·ªùng')}
                                ${renderMobileNavItem('ranking', 'trophy', 'X·∫øp h·∫°ng')}
                            </div>
                        </nav>
                    </div>
                </div>
            `;
        };

        const renderNavItem = (viewName, icon, label, isCollapsed) => `
            <button onclick="changeView('${viewName}')" class="w-full flex items-center nav-item gap-3 px-4 py-3 rounded-xl transition-all ${state.view === viewName ? 'bg-blue-600 text-white shadow-lg' : 'hover:bg-slate-800'}">
                <i data-lucide="${icon}" size="20"></i> <span class="font-medium sidebar-label">${label}</span>
            </button>
        `;
        
        // M·ªöI: Render Nav Item cho Mobile Bottom Bar
        const renderMobileNavItem = (viewName, icon, label) => `
            <button onclick="changeView('${viewName}')" class="flex flex-col items-center justify-center p-2 transition-colors ${state.view === viewName ? 'text-blue-600' : 'text-slate-500 hover:text-blue-500'}">
                <i data-lucide="${icon}" size="20"></i>
                <span class="text-xs font-medium">${label}</span>
            </button>
        `;


        const renderViewContent = () => {
            switch(state.view) {
                case 'dashboard': return renderDashboard();
                case 'classes': return renderClasses(); 
                case 'my_classes': return renderMyClasses(); // <-- NEW: Student class view
                case 'assignments': return renderAssignments();
                case 'question_bank': return renderQuestionBank();
                case 'competition': return renderCompetition();
                case 'ranking': return renderRanking();
                default: return '';
            }
        };
        
        // DASHBOARD (C·∫≠p nh·∫≠t Responsive)
        const renderDashboard = () => {
            const mySubmissions = state.data.submissions.filter(s => s.studentId === state.user.uid);
            const myAssignments = state.data.assignments;
            
            const pending = myAssignments.filter(a => 
                 !state.data.submissions.some(s => s.assignmentId === a.id && s.studentId === state.user.uid)
            ).length;
            
            return `
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 lg:gap-6 mb-6 lg:mb-8">
                    <div class="bg-white p-5 rounded-xl shadow-md border border-slate-100 flex items-center gap-4">
                        <div class="p-3 rounded-xl bg-yellow-50 text-yellow-500"><i data-lucide="trophy" size="24"></i></div>
                        <div><p class="text-slate-500 text-sm">ƒêi·ªÉm t√≠ch l≈©y</p><p class="text-xl md:text-2xl font-bold text-slate-800">${state.profile.points}</p></div>
                    </div>
                    <div class="bg-white p-5 rounded-xl shadow-md border border-slate-100 flex items-center gap-4">
                        <div class="p-3 rounded-xl bg-green-50 text-green-500"><i data-lucide="check-circle" size="24"></i></div>
                        <div><p class="text-slate-500 text-sm">B√†i t·∫≠p ƒë√£ l√†m</p><p class="text-xl md:text-2xl font-bold text-slate-800">${mySubmissions.length}</p></div>
                    </div>
                    <div class="bg-white p-5 rounded-xl shadow-md border border-slate-100 flex items-center gap-4">
                        <div class="p-3 rounded-xl bg-orange-50 text-orange-500"><i data-lucide="clock" size="24"></i></div>
                        <div><p class="text-slate-500 text-sm">B√†i t·∫≠p ch·ªù</p><p class="text-xl md:text-2xl font-bold text-slate-800">${Math.max(0, pending)}</p></div>
                    </div>
                </div>
                <div class="bg-gradient-to-r from-blue-600 to-indigo-700 rounded-2xl p-6 md:p-8 text-white shadow-xl flex flex-col lg:flex-row items-start lg:items-center justify-between">
                    <div class="lg:max-w-xl">
                        <h3 class="text-xl md:text-2xl font-bold mb-2">Ch√†o m·ª´ng tr·ªü l·∫°i, ${state.profile.name}!</h3>
                        <p class="text-blue-100 text-sm md:text-base mb-4 lg:mb-6">
                            ${state.profile.role === 'student' ? 'B·∫°n ƒë√£ s·∫µn s√†ng ƒë·ªÉ chinh ph·ª•c c√°c th·ª≠ th√°ch h√¥m nay ch∆∞a?' : 'Qu·∫£n l√Ω l·ªõp h·ªçc v√† t·∫°o b√†i t·∫≠p m·ªõi.'}
                        </p>
                        <div class="flex flex-wrap gap-3">
                            <button onclick="changeView('assignments')" class="bg-white text-blue-700 px-5 py-2 rounded-lg font-bold hover:bg-blue-50 transition text-sm">
                                ${state.profile.role === 'student' ? 'L√†m b√†i ngay' : 'T·∫°o b√†i t·∫≠p'}
                            </button>
                            <button onclick="changeView('competition')" class="bg-blue-800 text-white px-5 py-2 rounded-lg font-bold hover:bg-blue-900 transition flex items-center gap-2 text-sm">
                                <i data-lucide="swords" size="16"></i> ƒê·∫•u tr∆∞·ªùng
                            </button>
                        </div>
                    </div>
                    <i data-lucide="trophy" class="w-20 h-20 lg:w-32 lg:h-32 opacity-20 mt-4 lg:mt-0 lg:block flex-shrink-0"></i>
                </div>
            `;
        };

        // M·ªöI: STUDENT CLASSES RENDERERS
        
        const renderMyClasses = () => {
            if (state.profile.role !== 'student') return `<p class="text-red-500">B·∫°n kh√¥ng c√≥ quy·ªÅn truy c·∫≠p t√≠nh nƒÉng n√†y.</p>`;

            const myClasses = state.data.classes;
            
            // If viewing a specific class detail
            if (state.ui.viewMyClassId) {
                return renderMyClassDetails(state.ui.viewMyClassId);
            }
            
            // If join class modal is open
            if (state.ui.isJoiningClass) {
                 return renderJoinClassModal();
            }

            const list = myClasses.map(c => {
                const teacherProfile = state.data.users.find(u => u.uid === c.teacherId);

                return `
                    <div class="bg-white p-5 rounded-xl shadow-md border border-slate-100 hover:shadow-lg transition">
                        <div class="flex justify-between items-center mb-3">
                            <div class="bg-blue-100 p-2 rounded-lg text-blue-600"><i data-lucide="school" size="20"></i></div>
                            <span class="text-xs font-bold text-blue-600 bg-blue-100 px-3 py-1 rounded-full">${c.classCode || 'N/A'}</span>
                        </div>
                        <h4 class="text-lg font-bold text-slate-800 mb-1 truncate">${c.title}</h4>
                        <p class="text-slate-500 text-sm mb-4">Gi√°o vi√™n: ${teacherProfile ? teacherProfile.name : 'ƒêang c·∫≠p nh·∫≠t'}</p>
                        <button onclick="viewMyClassDetails('${c.id}')" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-2 rounded-lg font-medium transition flex items-center justify-center gap-2 text-sm">
                            <i data-lucide="eye" size="12"></i> Chi ti·∫øt
                        </button>
                    </div>
                `;
            }).join('');

            return `
                <div class="flex flex-wrap gap-4 mb-6">
                    <h3 class="text-2xl font-bold text-slate-800 flex-1 min-w-full lg:min-w-0">Danh s√°ch L·ªõp h·ªçc c·ªßa t√¥i (${myClasses.length})</h3>
                    <button onclick="toggleJoinClass(true)" class="bg-green-600 hover:bg-green-700 text-white px-5 py-2 md:px-6 md:py-3 rounded-xl font-bold shadow-md flex items-center gap-2 text-sm md:text-base">
                        <i data-lucide="plus-circle"></i> Th√™m m√£ v√†o l·ªõp
                    </button>
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 lg:gap-6">
                    ${list || `<p class="text-slate-500">B·∫°n ch∆∞a tham gia l·ªõp h·ªçc n√†o. Vui l√≤ng h·ªèi gi√°o vi√™n m√£ l·ªõp.</p>`}
                </div>
            `;
        };

        const renderJoinClassModal = () => {
             return `
                <div class="max-w-sm mx-auto bg-white p-6 md:p-8 rounded-2xl shadow-xl text-center fade-in">
                    <div class="flex justify-between items-center mb-6 border-b pb-4">
                        <h3 class="text-xl md:text-2xl font-bold text-green-600">Tham gia L·ªõp h·ªçc</h3>
                        <button onclick="toggleJoinClass(false)" class="text-slate-500 hover:text-red-500"><i data-lucide="x"></i></button>
                    </div>
                    <p class="text-slate-600 mb-4 text-sm">Nh·∫≠p m√£ l·ªõp h·ªçc (6 k√Ω t·ª±) do gi√°o vi√™n cung c·∫•p.</p>
                    <input type="text" id="join-class-code-input" class="w-full p-4 border-2 border-slate-300 rounded-xl text-center text-xl font-bold tracking-widest uppercase mb-4 focus:border-green-500" maxlength="6" placeholder="M√£ L·ªõp">
                    <button onclick="handleJoinClass()" class="w-full bg-green-600 text-white py-3 rounded-xl font-bold mb-4 transition hover:bg-green-700">Tham Gia L·ªõp</button>
                </div>
             `;
        };
        
        const renderMyClassDetails = (classId) => {
            const classData = state.data.classes.find(c => c.id === classId);
            if (!classData) return `<p class="text-red-500">Kh√¥ng t√¨m th·∫•y l·ªõp h·ªçc.</p>`;
            
            const teacherProfile = state.data.users.find(u => u.uid === classData.teacherId);
            const classStudents = (classData.studentIds || [])
                .map(sid => state.data.users.find(u => u.uid === sid))
                .filter(u => u); // Filter out null/undefined profiles
            
            // 1. Danh s√°ch b√†i t·∫≠p c·∫ßn l√†m (Pending Assignments)
            const pendingAssignments = state.data.assignments.filter(a => 
                 // B√†i t·∫≠p ph·∫£i ƒë∆∞·ª£c giao cho l·ªõp n√†y
                (a.classIds || []).includes(classId) &&
                 // V√† h·ªçc sinh ch∆∞a n·ªôp b√†i
                !state.data.submissions.some(s => s.assignmentId === a.id && s.studentId === state.user.uid)
            );

            // 2. Danh s√°ch h·ªçc sinh v√† ƒëi·ªÉm s·ªë
            // S·∫Øp x·∫øp h·ªçc sinh theo ƒëi·ªÉm ƒë·ªÉ l√†m b·∫£ng x·∫øp h·∫°ng l·ªõp
            const sortedStudents = [...classStudents].sort((a, b) => (b.points||0) - (a.points||0));

            const studentListHtml = sortedStudents.map((s, idx) => {
                const isMe = s.uid === state.user.uid;
                const rowClass = isMe ? 'bg-blue-50 border-blue-200 hover:bg-blue-100' : 'hover:bg-slate-50';
                
                return `
                    <tr class="border-b last:border-0 ${rowClass} transition">
                        <td class="py-3 pl-4 font-bold text-slate-500 w-16 text-center">${idx + 1}</td>
                        <td class="py-3 flex items-center gap-3">
                            ${renderAvatar(s, 'w-8 h-8', 'text-sm')}
                            <span class="font-medium ${isMe ? 'text-blue-700' : 'text-slate-700'} truncate">${s.name} ${isMe ? '(B·∫°n)' : ''}</span>
                        </td>
                        <td class="py-3 pr-4 text-right font-bold text-lg text-yellow-600">${s.points || 0}</td>
                    </tr>
                `;
            }).join('');
            
            const pendingListHtml = pendingAssignments.map(a => `
                <div class="bg-white p-4 rounded-xl shadow-sm border border-orange-100 flex justify-between items-center hover:bg-orange-50 transition">
                    <p class="font-medium text-slate-700 truncate">${a.title} (${a.questions.length} c√¢u)</p>
                    <button onclick="changeView('assignments'); startAssignment('${a.id}')" 
                            class="bg-orange-500 hover:bg-orange-600 text-white px-4 py-1.5 rounded-lg font-bold text-xs flex-shrink-0">
                        L√†m ngay
                    </button>
                </div>
            `).join('');

            return `
                <div class="max-w-4xl mx-auto bg-white p-4 md:p-8 rounded-2xl shadow-lg fade-in">
                    <div class="flex justify-between items-start mb-6 border-b pb-4">
                        <div class="flex flex-col">
                            <h3 class="text-2xl md:text-3xl font-bold text-blue-600">${classData.title}</h3>
                            <p class="text-slate-500 text-sm">Gi√°o vi√™n: ${teacherProfile ? teacherProfile.name : 'N/A'}</p>
                            <p class="text-slate-500 text-sm mt-1">M√£ l·ªõp: <span class="font-bold text-blue-600">${classData.classCode}</span></p>
                        </div>
                        <button onclick="viewMyClassDetails(null)" class="text-slate-500 hover:text-red-500 flex-shrink-0"><i data-lucide="x"></i></button>
                    </div>
                    
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <!-- C·ªôt 1: Danh s√°ch B√†i t·∫≠p c·∫ßn l√†m -->
                        <div>
                            <h4 class="text-xl font-bold text-slate-700 mb-4 flex items-center gap-2">
                                <i data-lucide="clipboard-list" class="text-orange-500"></i> B√†i t·∫≠p c·∫ßn l√†m (${pendingAssignments.length})
                            </h4>
                            <div class="space-y-3 max-h-96 overflow-y-auto pr-2">
                                ${pendingListHtml || '<div class="p-4 bg-green-50 text-green-700 rounded-xl font-medium">üéâ Ho√†n th√†nh h·∫øt r·ªìi!</div>'}
                            </div>
                            <div class="mt-6">
                                <button onclick="changeView('assignments')" class="w-full bg-blue-100 text-blue-700 py-2.5 rounded-xl font-bold hover:bg-blue-200 transition text-sm">
                                    Xem t·∫•t c·∫£ B√†i t·∫≠p ƒë√£ giao
                                </button>
                            </div>
                        </div>

                        <!-- C·ªôt 2: Danh s√°ch H·ªçc sinh & ƒêi·ªÉm -->
                        <div>
                            <h4 class="text-xl font-bold text-slate-700 mb-4 flex items-center gap-2">
                                <i data-lucide="trophy" class="text-yellow-600"></i> B·∫£ng x·∫øp h·∫°ng L·ªõp (${classStudents.length} h·ªçc sinh)
                            </h4>
                            <div class="bg-slate-50 rounded-xl overflow-hidden shadow-inner border">
                                <div class="overflow-x-auto">
                                    <table class="w-full min-w-[300px]">
                                        <thead>
                                            <tr class="text-left text-slate-500 text-sm border-b bg-slate-100">
                                                <th class="pb-3 pt-3 pl-4 w-16 text-center">H·∫°ng</th>
                                                <th class="pb-3 pt-3">H·ªçc sinh</th>
                                                <th class="pb-3 pt-3 pr-4 text-right">ƒêi·ªÉm s·ªë</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${studentListHtml}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        };

        // M·ªöI: CLASSES MANAGEMENT RENDERERS (Gi√°o vi√™n)

        const renderClasses = () => {
            const isTeacher = state.profile.role === 'teacher';
            if (!isTeacher) return `<p class="text-red-500">B·∫°n kh√¥ng c√≥ quy·ªÅn truy c·∫≠p t√≠nh nƒÉng n√†y.</p>`;

            if (state.ui.viewClassId && (state.ui.isCreatingAssignment || state.ui.viewAssignmentId)) {
                // NESTED VIEW: N·∫øu ƒëang ·ªü ch·∫ø ƒë·ªô xem l·ªõp nh∆∞ng l·∫°i ƒëang t·∫°o/s·ª≠a assignment, ∆∞u ti√™n render form t·∫°o/s·ª≠a
                 if (state.ui.isCreatingAssignment) {
                     if (state.ui.isSelectingBankQuestions) {
                         return renderQuestionSelectionFromBank(); 
                     }
                     return renderCreateAssignmentForm();
                 }
                 if (state.ui.viewAssignmentId) {
                     return renderAssignmentDetails(); 
                 }
            }
            
            if (state.ui.viewClassId) {
                return renderViewClass(state.ui.viewClassId);
            }
            if (state.ui.isCreatingClass) {
                return renderCreateClassForm();
            }

            const myClasses = state.data.classes;

            const list = myClasses.map(c => {
                const studentCount = (c.studentIds ? c.studentIds.length : 0);

                return `
                    <div class="bg-white p-5 rounded-xl shadow-md border border-slate-100 hover:shadow-lg transition">
                        <div class="flex justify-between items-center mb-3">
                            <div class="bg-green-100 p-2 rounded-lg text-green-600"><i data-lucide="graduation-cap" size="20"></i></div>
                            <span class="text-xs font-bold text-green-600 bg-green-100 px-3 py-1 rounded-full">${c.classCode || 'N/A'}</span>
                        </div>
                        <h4 class="text-lg font-bold text-slate-800 mb-1 truncate">${c.title}</h4>
                        <p class="text-slate-500 text-sm mb-4">${studentCount} H·ªçc sinh</p>
                        <div class="flex gap-2 text-sm">
                            <button onclick="viewClass('${c.id}')" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white py-2 rounded-lg font-medium transition">
                                <i data-lucide="eye" size="12" class="inline mr-1"></i> Xem chi ti·∫øt
                            </button>
                            <button onclick="confirmDeleteClass('${c.id}', '${c.title}')" class="p-2 bg-red-100 text-red-600 rounded-lg hover:bg-red-200 transition">
                                <i data-lucide="trash-2" size="12"></i>
                            </button>
                        </div>
                    </div>
                `;
            }).join('');

            return `
                <button onclick="toggleCreateClass(true)" class="mb-6 bg-green-600 hover:bg-green-700 text-white px-5 py-2 md:px-6 md:py-3 rounded-xl font-bold shadow-md flex items-center gap-2 text-sm md:text-base">
                    <i data-lucide="plus-circle"></i> T·∫°o L·ªõp h·ªçc m·ªõi
                </button>
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 lg:gap-6">
                    ${list || '<p class="text-slate-500">B·∫°n ch∆∞a t·∫°o l·ªõp h·ªçc n√†o.</p>'}
                </div>
            `;
        };

        const renderCreateClassForm = () => {
            return `
                <div class="max-w-xl mx-auto bg-white p-6 md:p-8 rounded-2xl shadow-lg fade-in">
                    <div class="flex justify-between items-center mb-6 border-b pb-4">
                        <h3 class="text-xl md:text-2xl font-bold text-green-600">T·∫°o L·ªõp h·ªçc m·ªõi</h3>
                        <button onclick="toggleCreateClass(false)" class="text-slate-500 hover:text-red-500"><i data-lucide="x"></i></button>
                    </div>
                    <label for="class-title" class="block text-sm font-medium text-slate-700 mb-1">T√™n L·ªõp h·ªçc</label>
                    <input id="class-title" type="text" class="w-full p-3 border-2 rounded-lg text-base md:text-lg mb-6 focus:border-green-500" placeholder="V√≠ d·ª•: L·ªõp H√°n ng·ªØ 101">
                    <button onclick="handleCreateClass()" class="w-full bg-green-600 text-white py-3 rounded-xl font-bold hover:bg-green-700 transition">L∆∞u L·ªõp h·ªçc</button>
                </div>
            `;
        };
        
        // Helper to render student list
        const renderClassStudents = (classData, studentList) => {
            const studentRows = studentList.map(s => {
                const studentProfile = state.data.users.find(u => u.uid === s.uid);
                return `
                    <tr class="border-b last:border-0 hover:bg-slate-50 transition">
                        <td class="py-3 pl-4 flex items-center gap-3">
                            ${renderAvatar(studentProfile, 'w-8 h-8', 'text-sm')}
                            <span class="font-medium text-slate-700 truncate">${s.name}</span>
                        </td>
                        <td class="py-3 text-slate-500 hidden md:table-cell truncate">${s.email}</td>
                        <td class="py-3 text-right pr-4">
                            <button onclick="confirmRemoveStudent('${classData.id}', '${s.uid}', '${s.name}')" 
                                    class="text-red-500 hover:text-red-700 p-2 rounded-full hover:bg-red-50 transition">
                                <i data-lucide="user-minus" size="18"></i>
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
            
            return `
                <h4 class="text-xl font-bold text-slate-700 mb-4">Danh s√°ch H·ªçc sinh</h4>
                <div class="bg-slate-50 rounded-xl overflow-hidden shadow-inner border">
                    <div class="overflow-x-auto">
                        <table class="w-full min-w-[500px] md:min-w-full">
                            <thead>
                                <tr class="text-left text-slate-500 text-sm border-b bg-slate-100">
                                    <th class="pb-3 pt-3 pl-4">H·ªç v√† T√™n</th>
                                    <th class="pb-3 pt-3 hidden md:table-cell">T√†i kho·∫£n (Email)</th>
                                    <th class="pb-3 pt-3 pr-4 text-right">Thao t√°c</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${studentRows || `<tr><td colspan="3" class="text-center py-8 text-slate-500">Ch∆∞a c√≥ h·ªçc sinh n√†o trong l·ªõp.</td></tr>`}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        const renderClassAssignments = (classData, studentList) => {
            // L·ªçc b√†i t·∫≠p ƒë√£ giao cho l·ªõp n√†y V√Ä ƒë∆∞·ª£c t·∫°o b·ªüi gi√°o vi√™n hi·ªán t·∫°i
            const classAssignments = state.data.assignments.filter(a => 
                (a.classIds || []).includes(classData.id) && a.createdBy === state.user.uid
            );

const list = classAssignments.map(a => {
                const submissionsCount = state.data.submissions.filter(s => s.assignmentId === a.id && studentList.some(st => st.uid === s.studentId)).length;
                const completionRate = studentList.length > 0 ? Math.round((submissionsCount / studentList.length) * 100) : 0;
                const completionColor = completionRate === 100 ? 'bg-green-100 text-green-700' : completionRate > 0 ? 'bg-yellow-100 text-yellow-700' : 'bg-red-100 text-red-700';

                // GIAO DI·ªÜN M·ªöI: Click th·∫ª, Hover x√≥a
                return `
                    <div onclick="viewAssignmentDetailsInClass('${a.id}')" 
                         class="group bg-white p-3 rounded-xl shadow-sm border border-slate-100 hover:shadow-md hover:border-yellow-200 transition flex items-center justify-between gap-3 cursor-pointer">
                        
                        <div class="flex items-center gap-3 flex-1 min-w-0">
                            <div class="bg-indigo-50 text-indigo-600 p-2 rounded-lg flex-shrink-0 group-hover:bg-indigo-600 group-hover:text-white transition">
                                <i data-lucide="book-open" class="w-5 h-5"></i>
                            </div>
                            <div class="min-w-0">
                                <h4 class="text-sm font-bold text-slate-800 truncate group-hover:text-indigo-700 transition">${a.title}</h4>
                                <p class="text-xs text-slate-500 mt-0.5">${a.questions.length} c√¢u h·ªèi</p>
                            </div>
                        </div>

                        <div class="flex items-center gap-3 flex-shrink-0">
                            <span class="px-2 py-1 rounded-full text-xs font-bold ${completionColor} hidden sm:inline-block">
                                ${submissionsCount}/${studentList.length} (${completionRate}%)
                            </span>
                            
                            <div class="opacity-0 group-hover:opacity-100 transition-opacity duration-200">
                                <button onclick="event.stopPropagation(); confirmDeleteAssignment('${a.id}', '${a.title}')" 
                                        class="p-2 bg-red-50 text-red-500 rounded-lg hover:bg-red-600 hover:text-white transition shadow-sm">
                                    <i data-lucide="trash-2" size="18"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

return `
                <h4 class="text-xl font-bold text-slate-700 mb-4"></h4>
                
                <button onclick="createClassAssignment('${classData.id}', '${classData.title}')" class="mb-4 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-xl font-bold shadow-md flex items-center gap-2 text-sm w-fit">
                    <i data-lucide="plus-circle" size="18"></i> T·∫°o B√†i t·∫≠p m·ªõi
                </button>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-1">
                    ${list || `<p class="text-slate-500 text-center col-span-full py-4 bg-slate-50 rounded-xl border border-dashed border-slate-300">Ch∆∞a c√≥ b√†i t·∫≠p n√†o ƒë∆∞·ª£c giao cho l·ªõp n√†y.</p>`}
                </div>
            `;
        };
        
        // --- M·ªöI: H√ÄM RENDER CHI TI·∫æT TH·ªêNG K√ä B√ÄI T·∫¨P ---
        const renderAssignmentStatsDetail = (assign, studentList, submissions) => {
             
            const studentStats = studentList.map(student => {
                const userProfile = state.data.users.find(u => u.uid === student.uid);
                const sub = submissions.find(s => s.studentId === student.uid);
                return {
                    ...student,
                    ...userProfile, 
                    score: sub ? sub.score : 0,
                    submitted: !!sub
                };
            });
            
            // Sort by score (high to low)
            studentStats.sort((a, b) => b.score - a.score);

            const statsRows = studentStats.map((s, idx) => `
                <tr class="border-b last:border-0 hover:bg-slate-50 transition ${!s.submitted ? 'opacity-60' : ''}">
                    <td class="py-3 pl-4 font-medium text-slate-700 w-12 text-center">${idx + 1}</td>
                    <td class="py-3 flex items-center gap-3">
                        ${renderAvatar(s, 'w-8 h-8', 'text-sm')}
                        <span class="font-medium text-slate-700 truncate">${s.name}</span>
                    </td>
                    <td class="py-3 text-center hidden sm:table-cell">
                        <span class="px-2 py-0.5 rounded-full text-xs font-bold ${s.submitted ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}">
                            ${s.submitted ? 'ƒê√£ n·ªôp' : 'Ch∆∞a n·ªôp'}
                        </span>
                    </td>
                    <td class="py-3 pr-4 text-right font-bold text-lg ${s.score >= 50 ? 'text-green-600' : 'text-red-500'} w-20">${s.score}</td>
                </tr>
            `).join('');

            return `
                <div class="bg-white p-4 md:p-6 rounded-xl shadow-md border mb-6 fade-in">
                    <div class="flex justify-between items-center mb-4 border-b pb-2">
                        <h5 class="text-xl font-bold text-blue-600 truncate">${assign.title} (${assign.questions.length} c√¢u)</h5>
                        <button onclick="viewAssignmentStats(null)" class="text-red-500 hover:text-red-700">
                             <i data-lucide="x" size="20"></i>
                        </button>
                    </div>
                    
                    <div class="bg-slate-50 rounded-xl overflow-hidden shadow-inner border">
                        <div class="overflow-x-auto">
                            <table class="w-full min-w-[500px]">
                                <thead>
                                    <tr class="text-left text-slate-500 text-sm border-b bg-slate-100">
                                        <th class="pb-3 pt-3 pl-4 w-12 text-center">H·∫°ng</th>
                                        <th class="pb-3 pt-3">H·ªçc sinh</th>
                                        <th class="pb-3 pt-3 text-center hidden sm:table-cell">Tr·∫°ng th√°i</th>
                                        <th class="pb-3 pt-3 pr-4 text-right w-20">ƒêi·ªÉm (100)</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${statsRows}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
        }

        const renderClassStatistics = (classData, studentList) => {
            const classAssignments = state.data.assignments.filter(a => 
                (a.classIds || []).includes(classData.id) && a.createdBy === state.user.uid
            );
            
            if (classAssignments.length === 0) {
                 return `<p class="text-slate-500">Ch∆∞a c√≥ b√†i t·∫≠p n√†o ƒë∆∞·ª£c giao ƒë·ªÉ th·ªëng k√™.</p>`;
            }

            // --- M·ªöI: Hi·ªÉn th·ªã chi ti·∫øt b√†i t·∫≠p ƒë√£ ch·ªçn ---
            if (state.ui.selectedStatAssignmentId) {
                const selectedAssign = classAssignments.find(a => a.id === state.ui.selectedStatAssignmentId);
                if (selectedAssign) {
                    const submissions = state.data.submissions.filter(s => 
                        s.assignmentId === selectedAssign.id && studentList.some(st => st.uid === s.studentId)
                    );
                    return renderAssignmentStatsDetail(selectedAssign, studentList, submissions);
                }
            }
            
            // --- M·∫∂C ƒê·ªäNH: Hi·ªÉn th·ªã danh s√°ch c√°c b√†i t·∫≠p ---
 const assignmentCards = classAssignments.map(a => {
                const submissionsCount = state.data.submissions.filter(s => 
                    s.assignmentId === a.id && studentList.some(st => st.uid === s.studentId)
                ).length;
                
                const completionRate = studentList.length > 0 ? 
                    Math.round((submissionsCount / studentList.length) * 100) : 0;
                
                const completionColor = completionRate === 100 ? 'bg-green-500' : 
                                         completionRate > 0 ? 'bg-yellow-500' : 
                                         'bg-slate-400';

                return `
                    <button onclick="viewAssignmentStats('${a.id}')" 
                            class="bg-white p-3 rounded-xl shadow-sm border border-slate-100 hover:shadow-md hover:bg-slate-50 transition flex items-center justify-between gap-3 text-left w-full group">
                        
                        <div class="flex items-center gap-3 flex-1 min-w-0">
                            <div class="bg-indigo-50 text-indigo-600 p-2 rounded-lg flex-shrink-0">
                                <i data-lucide="bar-chart-3" class="w-5 h-5"></i>
                            </div>
                            <div class="min-w-0">
                                <h4 class="text-sm font-bold text-slate-800 truncate group-hover:text-blue-600 transition">${a.title}</h4>
                                <p class="text-xs text-slate-500 mt-0.5">${a.questions.length} c√¢u h·ªèi</p>
                            </div>
                        </div>

                        <div class="flex items-center gap-3 flex-shrink-0">
                             <span class="px-2 py-1 rounded-full text-xs font-bold text-white ${completionColor}">
                                ${completionRate}%
                            </span>
                            <i data-lucide="chevron-right" class="text-slate-300 w-5 h-5 group-hover:text-blue-500 transition"></i>
                        </div>
                    </button>
                `;
            }).join('');

             return `
                <h4 class="text-xl font-bold text-slate-700 mb-4">Danh s√°ch B√†i t·∫≠p (Ch·ªçn ƒë·ªÉ xem th·ªëng k√™)</h4>
                
                <div class="grid grid-cols-1 lg:grid-cols-4 gap-1">
                    ${assignmentCards || `<p class="text-slate-500 text-center col-span-full py-4 bg-slate-50 rounded-xl border border-dashed border-slate-300">Ch∆∞a c√≥ b√†i t·∫≠p n√†o ƒë∆∞·ª£c giao ƒë·ªÉ th·ªëng k√™.</p>`}
                </div>
            `;
        }

        const renderViewClass = (classId) => {
            const classData = state.data.classes.find(c => c.id === classId);
            if (!classData) return `<p class="text-red-500">Kh√¥ng t√¨m th·∫•y l·ªõp h·ªçc.</p>`;
            
            // KI·ªÇM TRA M·ªöI: N·∫øu ƒëang trong ng·ªØ c·∫£nh l·ªõp nh∆∞ng l·∫°i ƒëang t·∫°o/s·ª≠a b√†i t·∫≠p, render form ƒë√≥
            if (state.ui.isCreatingAssignment || state.ui.viewAssignmentId) {
                // Logic n√†y ƒë√£ ƒë∆∞·ª£c chuy·ªÉn l√™n renderClasses ƒë·ªÉ ƒë·∫£m b·∫£o view assignment/create form ƒë∆∞·ª£c render tr∆∞·ªõc
            }

            const studentList = (classData.studentIds || []).map(sid => {
                const user = state.data.users.find(u => u.uid === sid);
                return { uid: sid, name: user ? user.name : 'Unknown User', email: user ? user.email : 'N/A' };
            });

            // Decide which content to show
            let contentHtml = '';
            switch(state.ui.viewClassMode) {
                case 'assignments':
                    contentHtml = renderClassAssignments(classData, studentList);
                    // M·ªöI: Reset stat ID khi chuy·ªÉn tab
                    state.ui.selectedStatAssignmentId = null;
                    break;
                case 'stats':
                    contentHtml = renderClassStatistics(classData, studentList);
                    break;
                case 'students':
                default:
                    contentHtml = renderClassStudents(classData, studentList);
                    // M·ªöI: Reset stat ID khi chuy·ªÉn tab
                    state.ui.selectedStatAssignmentId = null;
                    break;
            }

            // Tabs/Navigation
            const nav = (mode, icon, label) => `
                <button onclick="setViewClassMode('${mode}')" 
                    class="flex-1 flex flex-col sm:flex-row items-center justify-center gap-1 sm:gap-2 py-2 sm:py-3 rounded-xl font-bold transition text-sm sm:text-base 
                    ${state.ui.viewClassMode === mode ? 'bg-blue-600 text-white shadow-md' : 'bg-slate-100 text-slate-700 hover:bg-slate-200'}">
                    <i data-lucide="${icon}" size="20"></i> ${label}
                </button>
            `;

return `
                <div class="max-w-7xl mx-auto bg-white p-4 md:p-8 rounded-2xl shadow-lg fade-in">
                    
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 border-b pb-4 gap-4">
                        
                        <div class="flex items-center gap-2 w-full md:w-auto flex-1 mr-4">
                            <input id="edit-class-title" type="text" value="${classData.title}" 
                                    class="text-2xl md:text-3xl font-bold border-b-2 border-transparent hover:border-blue-200 focus:border-blue-500 outline-none p-1 bg-transparent w-full">
                            <button onclick="handleUpdateClassTitle('${classData.id}')" class="p-2 text-blue-500 hover:bg-blue-50 rounded-lg transition flex-shrink-0" title="L∆∞u t√™n l·ªõp">
                                <i data-lucide="save" size="24"></i>
                            </button>
                        </div>

                        <div class="flex items-center gap-3 self-end md:self-center">
                            
                            <button onclick="copyToClipboard('${classData.classCode}', 'M√£ l·ªõp')" 
                                    class="group flex items-center gap-2 bg-green-50 border border-green-200 text-green-700 px-3 py-1.5 rounded-lg hover:bg-green-100 hover:shadow-sm transition cursor-pointer"
                                    title="Nh·∫•n ƒë·ªÉ sao ch√©p m√£ l·ªõp">
                                <span class="text-xs font-bold uppercase text-green-600 tracking-wider">M√£ l·ªõp:</span>
                                <span class="font-mono text-lg font-black tracking-widest">${classData.classCode}</span>
                                <i data-lucide="copy" size="14" class="opacity-50 group-hover:opacity-100 transition"></i>
                            </button>

                            <button onclick="viewClass(null)" class="p-2 text-slate-400 hover:text-red-500 hover:bg-red-50 rounded-lg transition flex-shrink-0">
                                <i data-lucide="x" size="24"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div class="flex gap-2 md:gap-4 mb-8">
                        ${nav('students', 'users', `H·ªçc sinh`)}
                        ${nav('assignments', 'clipboard-list', 'B√†i t·∫≠p')}
                        ${nav('stats', 'bar-chart-3', 'Th·ªëng k√™')}
                    </div>

                    ${contentHtml}
                </div>
            `;
        };
        
        // ASSIGNMENTS (C·∫≠p nh·∫≠t Responsive)
        const renderAssignments = () => {
            if (state.ui.isCreatingAssignment) {
                if (state.ui.isSelectingBankQuestions) {
                    return renderQuestionSelectionFromBank();
                }
                return renderCreateAssignmentForm();
            }
            if (state.ui.takingAssignmentId) {
                // CH√ö √ù: Logic update Assignment Question UI s·∫Ω n·∫±m trong h√†m ri√™ng
                return renderTakeAssignment();
            }
            if (state.ui.viewAssignmentId) {
                 return renderAssignmentDetails(); 
            }
            if (state.ui.viewSubmission) {
                return renderSubmissionResult(); 
            }

            const isTeacher = state.profile.role === 'teacher';
            const assignmentsList = state.data.assignments;

const list = assignmentsList.map(a => {
                const sub = state.data.submissions.find(s => s.assignmentId === a.id && s.studentId === state.user.uid);
                
                // 1. L·∫§Y T√äN L·ªöP (Logic m·ªõi th√™m v√†o)
                // T√¨m t√™n c·ªßa c√°c l·ªõp d·ª±a tr√™n classIds trong b√†i t·∫≠p
                const assignedClasses = (a.classIds || []).map(id => 
                    state.data.classes.find(c => c.id === id)?.title 
                ).filter(Boolean).join(', '); // L·ªçc b·ªè gi√° tr·ªã r·ªóng v√† n·ªëi b·∫±ng d·∫•u ph·∫©y

                // X·ª≠ l√Ω logic hi·ªÉn th·ªã
                if (!isTeacher) {
                    // --- GIAO DI·ªÜN H·ªåC SINH ---
                    let actionBtn = sub 
                        ? `<button onclick="viewSubmissionResult('${sub.id}')" class="px-3 py-1.5 bg-green-50 text-green-700 border border-green-200 rounded-lg font-bold text-xs whitespace-nowrap hover:bg-green-100 transition">${sub.score} ƒëi·ªÉm</button>`
                        : `<button onclick="startAssignment('${a.id}')" class="px-3 py-1.5 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-bold text-xs whitespace-nowrap shadow-sm transition">L√†m ngay</button>`;

                    return `
                        <div class="bg-white p-3 rounded-xl shadow-sm border border-slate-100 hover:shadow-md transition flex items-center justify-between gap-3">
                            <div class="flex items-center gap-3 flex-1 min-w-0">
                                <div class="${sub ? 'bg-green-100 text-green-600' : 'bg-blue-50 text-blue-600'} p-2 rounded-lg flex-shrink-0"><i data-lucide="${sub ? 'check-circle' : 'book-open'}" class="w-5 h-5"></i></div>
                                <div class="min-w-0">
                                    <h4 class="text-sm font-bold text-slate-800 truncate">${a.title}</h4>
                                    ${assignedClasses ? `<p class="text-xs text-blue-600 font-medium truncate mt-0.5">${assignedClasses}</p>` : ''}
                                    <p class="text-xs text-slate-500 mt-0.5">${a.questions.length} c√¢u h·ªèi</p>
                                </div>
                            </div>
                            <div class="flex-shrink-0">${actionBtn}</div>
                        </div>
                    `;
                } else {
                    // --- GIAO DI·ªÜN GI√ÅO VI√äN ---
                    return `
                        <div onclick="viewAssignmentDetails('${a.id}')" 
                             class="group bg-white p-3 rounded-xl shadow-sm border border-slate-100 hover:shadow-md hover:border-blue-200 transition flex items-center justify-between gap-3 cursor-pointer relative">
                            
                            <div class="flex items-center gap-3 flex-1 min-w-0">
                                <div class="bg-blue-50 text-blue-600 p-2 rounded-lg flex-shrink-0 group-hover:bg-blue-600 group-hover:text-white transition">
                                    <i data-lucide="book-open" class="w-5 h-5"></i>
                                </div>
                                <div class="min-w-0">
                                    <h4 class="text-sm font-bold text-slate-800 truncate group-hover:text-blue-700 transition">${a.title}</h4>
                                    
                                    ${assignedClasses ? `<p class="text-xs text-blue-600 font-medium truncate mt-0.5">${assignedClasses}</p>` : '<p class="text-xs text-slate-400 italic mt-0.5">Ch∆∞a giao l·ªõp n√†o</p>'}
                                    
                                    <!--<p class="text-xs text-slate-500 mt-0.5 group-hover:text-slate-700">${a.questions.length} c√¢u h·ªèi</p> -->
                                </div>
                            </div>

                            <div class="flex-shrink-0 opacity-0 group-hover:opacity-100 transition-opacity duration-200">
                                <button onclick="event.stopPropagation(); confirmDeleteAssignment('${a.id}', '${a.title}')" 
                                        class="p-2 bg-red-50 text-red-500 rounded-lg hover:bg-red-600 hover:text-white transition shadow-sm" title="X√≥a">
                                    <i data-lucide="trash-2" size="18"></i>
                                </button>
                            </div>
                        </div>
                    `;
                }
            }).join('');

            return `
                ${isTeacher ? 
                    `<button onclick="toggleCreate(true)" class="mb-6 bg-blue-600 hover:bg-blue-700 text-white px-5 py-2 md:px-6 md:py-3 rounded-xl font-bold shadow-md flex items-center gap-2 text-sm md:text-base">
                        <i data-lucide="plus-circle"></i> T·∫°o b√†i t·∫≠p
                    </button>` : ''}
<div class="flex flex-col gap-2 md:grid md:grid-cols-2 lg:grid-cols-4 md:gap-2">
    ${list || `<p class="text-slate-500 text-center italic py-8">Kh√¥ng c√≥ b√†i t·∫≠p n√†o.</p>`}
</div>
            `;
        };
        
        // QUESTION BANK (C·∫≠p nh·∫≠t Responsive)
        const renderQuestionBank = () => {
            const isTeacher = state.profile.role === 'teacher';
            if (!isTeacher) return `<p class="text-red-500">B·∫°n kh√¥ng c√≥ quy·ªÅn truy c·∫≠p t√≠nh nƒÉng n√†y.</p>`;

            if (state.ui.bankMode === 'create') {
                return renderCreateQuestionBankForm();
            }
            if (state.ui.bankMode === 'view' && state.ui.selectedBankId) {
                return renderViewQuestionBank();
            }

            const myBanks = state.data.questionBanks.filter(b => b.createdBy === state.user.uid);
            
const list = myBanks.map(bank => `
                <div onclick="viewBankDetails('${bank.id}')" 
                     class="group bg-white p-3 rounded-xl shadow-sm border border-slate-100 hover:shadow-md hover:border-purple-200 transition flex items-center justify-between gap-3 cursor-pointer">
                    
                    <div class="flex items-center gap-3 flex-1 min-w-0">
                        <div class="bg-purple-50 text-purple-600 p-2 rounded-lg flex-shrink-0 group-hover:bg-purple-600 group-hover:text-white transition">
                            <i data-lucide="library" class="w-5 h-5"></i>
                        </div>
                        <div class="min-w-0">
                            <h4 class="text-sm font-bold text-slate-800 truncate group-hover:text-purple-700 transition">${bank.title}</h4>
                            <p class="text-xs text-slate-500 mt-0.5">${bank.questions.length} c√¢u h·ªèi</p>
                        </div>
                    </div>

                    <div class="flex-shrink-0 opacity-0 group-hover:opacity-100 transition-opacity duration-200">
                        <button onclick="event.stopPropagation(); confirmDeleteBank('${bank.id}', '${bank.title}')" 
                                class="p-2 bg-red-50 text-red-500 rounded-lg hover:bg-red-600 hover:text-white transition shadow-sm">
                            <i data-lucide="trash-2" size="18"></i>
                        </button>
                    </div>
                </div>
            `).join('');

                return `
                <div class="flex flex-wrap gap-3 mb-4">
                    <button onclick="setBankMode('create')" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-xl font-bold shadow-md flex items-center gap-2 text-sm">
                        <i data-lucide="plus-circle" size="18"></i> T·∫°o Ng√¢n h√†ng ƒë·ªÅ
                    </button>
                    <button onclick="toggleImportData(true)" class="bg-yellow-600 hover:bg-yellow-700 text-white px-4 py-2 rounded-xl font-bold shadow-md flex items-center gap-2 text-sm">
                        <i data-lucide="file-text" size="18"></i> Nh·∫≠p d·ªØ li·ªáu
                    </button>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-2">
                    ${list || '<p class="text-slate-500 text-center col-span-full py-4 bg-slate-50 rounded-xl border border-dashed border-slate-300">B·∫°n ch∆∞a t·∫°o ng√¢n h√†ng ƒë·ªÅ n√†o.</p>'}
                </div>
            `;
        };
        
        const renderCreateQuestionBankForm = () => {
            const qList = state.ui.newAssignment.questions.map((q, idx) => renderQuestionDisplay(q, idx)).join('');

            return `
                <div class="bg-white p-4 md:p-6 rounded-2xl shadow-lg fade-in max-w-4xl mx-auto">
                    <div class="flex justify-between mb-4 md:mb-6 border-b pb-3">
                        <h3 class="text-xl font-bold text-purple-600">T·∫°o Ng√¢n h√†ng ƒë·ªÅ m·ªõi</h3>
                        <button onclick="setBankMode('list')" class="text-slate-500 hover:text-red-500"><i data-lucide="x"></i></button>
                    </div>
                    <div class="mb-4 md:mb-6 flex flex-col md:flex-row gap-4">
                        <input id="new-bank-title" class="flex-1 text-lg font-bold border-b-2 border-slate-200 p-2 outline-none focus:border-purple-500" placeholder="Ti√™u ƒë·ªÅ Ng√¢n h√†ng ƒë·ªÅ...">
                         <button onclick="toggleImportData(true, true)" class="bg-yellow-600 hover:bg-yellow-700 text-white px-4 py-2 rounded-lg font-bold flex items-center justify-center gap-2 text-sm">
                            <i data-lucide="upload" size="18"></i> Nh·∫≠p t·ª´ File
                        </button>
                    </div>
                    
                    <h4 class="text-lg font-bold text-slate-800 mb-3">Danh s√°ch c√¢u h·ªèi (${state.ui.newAssignment.questions.length})</h4>
                    <div id="questions-preview" class="space-y-4 border p-4 rounded-xl bg-slate-50 max-h-96 overflow-y-auto">${qList || '<p class="text-slate-500">Ch∆∞a c√≥ c√¢u h·ªèi n√†o.</p>'}</div>

                    ${renderQuestionInputSection(false)}

                    <button onclick="publishQuestionBank()" class="w-full bg-purple-600 text-white py-3 rounded-xl font-bold hover:bg-purple-700 transition">L∆∞u Ng√¢n h√†ng ƒë·ªÅ</button>
                </div>
            `;
        };
        
        const renderViewQuestionBank = () => {
            const bank = state.data.questionBanks.find(b => b.id === state.ui.selectedBankId);
            if (!bank) return `<p class="text-red-500">Kh√¥ng t√¨m th·∫•y ng√¢n h√†ng ƒë·ªÅ.</p>`;

            // D√πng l·∫°i state.ui.newAssignment ƒë·ªÉ ch·ªânh s·ª≠a t·∫°m th·ªùi
            if (!state.ui.newAssignment.id || state.ui.newAssignment.id !== bank.id) {
                // Kh·ªüi t·∫°o tr·∫°ng th√°i ch·ªânh s·ª≠a
                state.ui.newAssignment = { ...bank, questions: JSON.parse(JSON.stringify(bank.questions)) };
                state.ui.newQuestionType = 'mcq';
            }

            const qList = state.ui.newAssignment.questions.map((q, idx) => renderQuestionDisplay(q, idx)).join('');

            return `
                <div class="bg-white p-4 md:p-6 rounded-2xl shadow-lg fade-in max-w-4xl mx-auto">
                    <div class="flex justify-between mb-4 md:mb-6 border-b pb-3">
                        <h3 class="text-xl font-bold text-purple-600">Ch·ªânh s·ª≠a Ng√¢n h√†ng ƒë·ªÅ</h3>
                        <button onclick="viewBankDetails(null)" class="text-slate-500 hover:text-red-500"><i data-lucide="x"></i></button>
                    </div>
                    
                    <div class="mb-4 md:mb-6 flex flex-col md:flex-row gap-4">
                        <div class="flex-1">
                            <label class="block text-sm font-medium text-slate-600 mb-1">Ti√™u ƒë·ªÅ</label>
                            <input id="edit-bank-title" class="w-full text-lg font-bold border-b-2 border-slate-200 p-2 outline-none focus:border-purple-500" value="${state.ui.newAssignment.title}">
                        </div>
                        <button onclick="toggleImportData(true, true)" class="self-end bg-yellow-600 hover:bg-yellow-700 text-white px-4 py-2 rounded-lg font-bold flex items-center justify-center gap-2 text-sm h-fit">
                            <i data-lucide="upload" size="18"></i> Nh·∫≠p t·ª´ File
                        </button>
                    </div>
                    
                    <h4 class="text-lg font-bold text-slate-800 mb-3">Danh s√°ch c√¢u h·ªèi (${state.ui.newAssignment.questions.length})</h4>
                    <div id="questions-preview" class="space-y-4 border p-4 rounded-xl bg-slate-50 max-h-96 overflow-y-auto">${qList || '<p class="text-slate-500">Ch∆∞a c√≥ c√¢u h·ªèi n√†o.</p>'}</div>

                    ${renderQuestionInputSection(true)}

                    <button onclick="saveBankChanges('${bank.id}')" class="w-full bg-green-600 text-white py-3 rounded-xl font-bold hover:bg-green-700 transition">L∆∞u thay ƒë·ªïi Ng√¢n h√†ng ƒë·ªÅ</button>
                </div>
            `;
        }
        
        // --- Giao di·ªán Modal Nh·∫≠p d·ªØ li·ªáu t·ª´ File ---

        const questionTypes = [
            { id: 'vocab_mcq', label: '1. Tr·∫Øc nghi·ªám (T·ª´ v·ª±ng, Pinyin, Nghƒ©a)', example: 't·ª´ v·ª±ng|pinyin|nghƒ©a' },
            { id: 'listen_mcq', label: '2. Nghe √¢m thanh ch·ªçn nghƒ©a (T·ª´ v·ª±ng)', example: 't·ª´ v·ª±ng|pinyin|nghƒ©a' },
            { id: 'fib', label: '3. ƒêi·ªÅn t·ª´ c√≤n thi·∫øu (FIB)', example: 'C√¢u c√≥ ch·ªó tr·ªëng|t·ª´ c·∫ßn ƒëi·ªÅn' },
            { id: 'jumble', label: '4. X·∫øp t·ª´ th√†nh c√¢u (Jumble)', example: 'C√¢u ƒë√∫ng c√°ch nhau b·∫±ng d·∫•u c√°ch' },
            { id: 'translation', label: '5. D·ªãch c√¢u (Vi·ªát - Trung)', example: 'c√¢u ti·∫øng trung|c√¢u ti·∫øng vi·ªát' },
            { id: 'listen_translate', label: '6. Nghe c√¢u d·ªãch nghƒ©a (C√¢u)', example: 'c√¢u ti·∫øng trung|c√¢u ti·∫øng vi·ªát' },
            { id: 'listen_write', label: '7. Nghe c√¢u vi·∫øt l·∫°i (C√¢u)', example: 'c√¢u ti·∫øng trung|c√¢u ti·∫øng vi·ªát' },
            // Lo·∫°i 8, 9, 10... c√≥ th·ªÉ th√™m v√†o ƒë√¢y
        ];
        
        const getImportInstructions = (type) => {
             const typeData = questionTypes.find(t => t.id === type);
             if (!typeData) return { instructions: 'Kh√¥ng t√¨m th·∫•y lo·∫°i c√¢u h·ªèi.', structure: '' };

             const instructionsMap = {
                 'vocab_mcq': { 
                     instructions: 'T·∫°o t·ª´ v·ª±ng, Pinyin, v√† Nghƒ©a. H·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông t·∫°o c√°c b√†i tr·∫Øc nghi·ªám ch·ªçn nghƒ©a, ch·ªçn Pinyin, v√† ch·ªçn t·ª´.', 
                     structure: 't·ª´ v·ª±ng|pinyin|nghƒ©a' 
                 },
                 'listen_mcq': { 
                     instructions: 'T·∫°o t·ª´ v·ª±ng, Pinyin, v√† Nghƒ©a. H·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông t·∫°o b√†i tr·∫Øc nghi·ªám Nghe (ph√°t √¢m t·ª´) v√† ch·ªçn nghƒ©a.', 
                     structure: 't·ª´ v·ª±ng|pinyin|nghƒ©a' 
                 },
                 'fib': { 
                     instructions: 'M·ªói d√≤ng l√† m·ªôt c√¢u h·ªèi ƒëi·ªÅn t·ª´. T·ª´ c·∫ßn ƒëi·ªÅn ph·∫£i n·∫±m gi·ªØa hai k√≠ t·ª± g·∫°ch ƒë·ª©ng (v√≠ d·ª•: |ch·ª£|)', 
                     structure: 'H√¥m nay t√¥i ƒëi |ch·ª£| mua rau.' 
                 },
                 'jumble': { 
                     instructions: 'M·ªói d√≤ng l√† m·ªôt c√¢u ho√†n ch·ªânh. C√°c t·ª´ trong c√¢u ph·∫£i ƒë∆∞·ª£c ph√¢n t√°ch b·∫±ng D·∫§U C√ÅCH. H·ªá th·ªëng s·∫Ω x√°o tr·ªôn c√°c t·ª´ n√†y.', 
                     structure: 'T√¥i y√™u h·ªçc ti·∫øng Vi·ªát' 
                 },
                 'translation': { 
                     instructions: 'M·ªói d√≤ng l√† m·ªôt c·∫∑p c√¢u ti·∫øng Trung - ti·∫øng Vi·ªát. C√¢u h·ªèi s·∫Ω y√™u c·∫ßu d·ªãch t·ª´ TV sang TC.', 
                     structure: 'ÊàëÁà±‰Ω†|T√¥i y√™u b·∫°n' 
                 },
                 'listen_translate': { 
                     instructions: 'M·ªói d√≤ng l√† m·ªôt c·∫∑p c√¢u ti·∫øng Trung - ti·∫øng Vi·ªát. H·ªá th·ªëng s·∫Ω ph√°t √¢m c√¢u TC v√† y√™u c·∫ßu d·ªãch sang TV.', 
                     structure: '‰Ω†Â•ΩÂêó|B·∫°n kh·ªèe kh√¥ng' 
                 },
                 'listen_write': { 
                     instructions: 'M·ªói d√≤ng l√† m·ªôt c·∫∑p c√¢u ti·∫øng Trung - ti·∫øng Vi·ªát. H·ªá th·ªëng s·∫Ω ph√°t √¢m c√¢u TC v√† y√™u c·∫ßu vi·∫øt l·∫°i c√¢u TC.', 
                     structure: 'ÊàëÊòØÂ≠¶Áîü|T√¥i l√† h·ªçc sinh' 
                 }
             };
             
             return instructionsMap[type] || { instructions: 'Vui l√≤ng ch·ªçn lo·∫°i c√¢u h·ªèi ph√π h·ª£p.', structure: 'Kh√¥ng r√µ' };
        };


        const renderImportDataModal = () => {
            const currentType = state.ui.importQType;
            const { instructions, structure } = getImportInstructions(currentType);

            return `
                <div class="fixed inset-0 bg-slate-900 bg-opacity-70 flex items-center justify-center z-50 fade-in p-4" onclick="if (event.target === this) toggleImportData(false)">
                    <div class="bg-white p-6 md:p-8 rounded-2xl shadow-2xl w-full max-w-2xl transform transition-all">
                        <div class="flex justify-between items-center mb-6 border-b pb-4">
                            <h3 class="text-xl md:text-2xl font-bold text-yellow-700">Nh·∫≠p d·ªØ li·ªáu t·ª´ File (.txt)</h3>
                            <button onclick="toggleImportData(false)" class="text-slate-500 hover:text-red-500"><i data-lucide="x"></i></button>
                        </div>

                        <div class="mb-6 space-y-4">
                            <div>
                                <label for="import-q-type" class="block text-sm font-medium text-slate-700 mb-1">Ch·ªçn lo·∫°i d·ªØ li·ªáu ƒë·∫ßu v√†o</label>
                                <select id="import-q-type" onchange="setImportQType(this.value)" class="w-full p-3 border-2 rounded-lg bg-slate-50 focus:border-yellow-500">
                                    ${questionTypes.map(t => `<option value="${t.id}" ${currentType === t.id ? 'selected' : ''}>${t.label}</option>`).join('')}
                                </select>
                            </div>

                            <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4 rounded-lg">
                                <p class="font-bold text-yellow-800 mb-2">ƒê·ªãnh d·∫°ng file TXT cho lo·∫°i n√†y:</p>
                                <p class="text-sm text-yellow-700 mb-2">${instructions}</p>
                                <div class="bg-yellow-100 p-2 rounded text-xs font-mono border border-yellow-300 overflow-x-auto">
                                    <span class="font-bold">C·∫•u tr√∫c m·∫´u (M·ªói d√≤ng):</span> ${structure}
                                </div>
                            </div>
                            
                            <div>
                                <label for="file-upload" class="block text-sm font-medium text-slate-700 mb-1">T·∫£i l√™n File TXT</label>
                                <input type="file" id="file-upload" accept=".txt" class="w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
                            </div>
                        </div>

                        <button onclick="handleFileImport()" class="w-full bg-yellow-600 text-white py-3 rounded-xl font-bold hover:bg-yellow-700 flex items-center justify-center gap-2 transition">
                            <i data-lucide="chevrons-down" size="20"></i> T·∫°o c√¢u h·ªèi v√† Th√™m v√†o Ng√¢n h√†ng ƒë·ªÅ
                        </button>
                    </div>
                </div>
            `;
        };
        
        // --- Giao di·ªán d√πng chung cho t·∫°o/s·ª≠a assignment v√† bank (C·∫≠p nh·∫≠t Responsive) ---
        const renderQuestionInputSection = (isEditing) => `
            <div class="p-4 border border-blue-200 rounded-xl bg-blue-50 ${isEditing ? 'mt-6' : 'mb-6'}">
                <h4 class="font-bold text-blue-800 mb-3">Th√™m c√¢u h·ªèi ${isEditing ? 'v√†o ng√¢n h√†ng ƒë·ªÅ' : 'tr·ª±c ti·∫øp'}</h4>
                
                <div class="mb-3">
                    <label class="block text-sm font-medium text-blue-800 mb-1">Ch·ªçn lo·∫°i c√¢u h·ªèi</label>
                    <select id="q-type-select" onchange="changeQuestionType(this.value)" class="w-full p-2 border border-blue-300 rounded-lg">
                        <option value="mcq" ${state.ui.newQuestionType === 'mcq' ? 'selected' : ''}>1. Tr·∫Øc nghi·ªám</option>
                        <option value="fib" ${state.ui.newQuestionType === 'fib' ? 'selected' : ''}>2. ƒêi·ªÅn t·ª´ c√≤n thi·∫øu</option>
                        <option value="jumble" ${state.ui.newQuestionType === 'jumble' ? 'selected' : ''}>3. X·∫øp t·ª´ th√†nh c√¢u</option>
                        <option value="match" ${state.ui.newQuestionType === 'match' ? 'selected' : ''}>4. Gh√©p ƒë√¥i</option>
                        <option value="translation" ${state.ui.newQuestionType === 'translation' ? 'selected' : ''}>5. D·ªãch c√¢u (Vi·ªát - Trung)</option>
                        <option value="listen_mcq" ${state.ui.newQuestionType === 'listen_mcq' ? 'selected' : ''}>6. Nghe √¢m thanh ch·ªçn nghƒ©a (M·ªöI)</option>
                        <option value="listen_write" ${state.ui.newQuestionType === 'listen_write' ? 'selected' : ''}>7. Nghe c√¢u vi·∫øt l·∫°i (M·ªöI)</option>
                        <option value="listen_translate" ${state.ui.newQuestionType === 'listen_translate' ? 'selected' : ''}>8. Nghe c√¢u d·ªãch nghƒ©a (M·ªöI)</option>
                    </select>
                </div>

                ${renderQuestionInputForm()}

                <button onclick="addQuestion()" class="text-blue-600 font-bold text-sm mt-3">+ Th√™m v√†o danh s√°ch</button>
            </div>
        `;

        const getQuestionTypeLabel = (type) => {
            const labels = {
                mcq: 'Tr·∫Øc nghi·ªám', fib: 'ƒêi·ªÅn t·ª´', jumble: 'X·∫øp t·ª´', 
                match: 'Gh√©p ƒë√¥i', translation: 'D·ªãch c√¢u',
                listen_mcq: 'Nghe - Ch·ªçn nghƒ©a', listen_write: 'Nghe - Vi·∫øt l·∫°i',
                listen_translate: 'Nghe - D·ªãch nghƒ©a'
            };
            return labels[type] || 'Kh√¥ng x√°c ƒë·ªãnh';
        };

        const renderQuestionDisplay = (q, qIdx) => {
            const typeLabel = getQuestionTypeLabel(q.type);
            
            let content = '';
            let mainText = q.vietnamese || q.text || '';
            let audioInfo = '';
            
            if (q.audioText) {
                audioInfo = `<p class="text-purple-600 font-bold mb-2 flex items-center gap-1"><i data-lucide="volume-2" size="18"></i> √Çm thanh: ${q.audioText}</p>`;
            }

            switch(q.type) {
                case 'mcq':
                    const correctOption = q.options[q.correct];
                    content = `ƒê√°p √°n ƒë√∫ng: <span class="font-bold text-green-700">(${correctOption})</span>`;
                    content += `<div class="mt-2 space-y-1 text-xs">` + q.options.map((opt, i) => 
                        `<p class="${i === q.correct ? 'text-green-600 font-bold' : 'text-slate-500'}">${i+1}. ${opt}</p>`
                    ).join('') + `</div>`;
                    break;
                case 'listen_mcq':
                    mainText = `C√¢u h·ªèi: ${q.text}`; 
                    const correctListenOption = q.options[q.correct];
                    content = `ƒê√°p √°n ƒë√∫ng: <span class="font-bold text-green-700">(${correctListenOption})</span>`;
                    content += `<div class="mt-2 space-y-1 text-xs">` + q.options.map((opt, i) => 
                        `<p class="${i === q.correct ? 'text-green-600 font-bold' : 'text-slate-500'}">${i+1}. ${opt}</p>`
                    ).join('') + `</div>`;
                    break;
                case 'fib':
                    content = `C√¢u: ${q.text.replace('[BLANK]', '<span class="text-blue-600 font-bold">______</span>')}<br>ƒê√°p √°n: **${q.answer}**`;
                    break;
                case 'jumble':
                    content = `C√¢u ƒë√∫ng: **${q.answer.join(' ')}**`;
                    break;
                case 'match':
                    content = 'C√°c c·∫∑p gh√©p n·ªëi:<br>' + q.pairs.map(p => `**${p.a}** -> **${p.b}**`).join('<br>');
                    break;
                case 'translation':
                    content = `C√¢u TV: ${q.vietnamese}<br>ƒê√°p √°n TC: **${q.chinese}**`;
                    break;
                case 'listen_write':
                    mainText = `Y√™u c·∫ßu: ${q.text || 'Vi·∫øt l·∫°i c√¢u ƒë√£ nghe'}`;
                    content = `ƒê√°p √°n: **${q.answer}**`;
                    break;
                case 'listen_translate':
                    mainText = `Y√™u c·∫ßu: ${q.text || 'D·ªãch c√¢u ƒë√£ nghe sang ti·∫øng Vi·ªát'}`;
                    content = `ƒê√°p √°n (TV): **${q.answer}**`;
                    break;
            }

            const isEditable = state.ui.viewAssignmentId || state.ui.bankMode === 'view' || state.ui.bankMode === 'create' || state.ui.isCreatingAssignment;

            return `
                <div class="p-3 md:p-4 border border-slate-200 rounded-xl bg-white mb-2 flex justify-between items-start">
                    <div>
                        <div class="font-bold text-blue-600 mb-1 text-sm md:text-base">C√¢u ${qIdx+1}: ${typeLabel}</div>
                        ${audioInfo}
                        <p class="font-medium mb-1 text-sm md:text-base">${mainText}</p>
                        <div class="text-xs md:text-sm text-slate-700">
                            ${content}
                        </div>
                    </div>
                    ${isEditable ? `
                        <button onclick="removeQuestionInEdit(${qIdx})" class="text-red-400 hover:text-red-600 p-1 rounded-full bg-red-50 transition flex-shrink-0">
                            <i data-lucide="minus-circle" size="18"></i>
                        </button>
                    ` : ''}
                </div>
            `;
        };

        const renderQuestionInputForm = () => {
            const type = state.ui.newQuestionType;
            let inputs = '';
            
            switch (type) {
                case 'mcq':
                    inputs = `
                        <input id="q-text" class="w-full p-2 border rounded-lg mb-3" placeholder="N·ªôi dung c√¢u h·ªèi">
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 mb-3">
                            <input id="opt-0" class="p-2 border rounded" placeholder="ƒê√°p √°n 1">
                            <input id="opt-1" class="p-2 border rounded" placeholder="ƒê√°p √°n 2">
                            <input id="opt-2" class="p-2 border rounded" placeholder="ƒê√°p √°n 3">
                            <input id="opt-3" class="p-2 border rounded" placeholder="ƒê√°p √°n 4">
                        </div>
                        <select id="q-correct" class="w-full p-2 border rounded mb-3">
                            <option value="0">ƒê√°p √°n 1 ƒë√∫ng</option>
                            <option value="1">ƒê√°p √°n 2 ƒë√∫ng</option>
                            <option value="2">ƒê√°p √°n 3 ƒë√∫ng</option>
                            <option value="3">ƒê√°p √°n 4 ƒë√∫ng</option>
                        </select>
                    `;
                    break;
                case 'fib':
                    inputs = `
                        <p class="text-sm text-slate-500 mb-2">S·ª≠ d·ª•ng chu·ªói <code>[BLANK]</code> ƒë·ªÉ ƒë√°nh d·∫•u v·ªã tr√≠ ƒëi·ªÅn t·ª´.</p>
                        <input id="fib-text" class="w-full p-2 border rounded-lg mb-3" placeholder="V√≠ d·ª•: H√¥m nay t√¥i ƒëi [BLANK]...">
                        <input id="fib-answer" class="w-full p-2 border rounded-lg mb-3" placeholder="ƒê√°p √°n ƒë√∫ng (V√≠ d·ª•: ch·ª£)">
                    `;
                    break;
                case 'jumble':
                    inputs = `
                        <p class="text-sm text-slate-500 mb-2">Nh·∫≠p c√¢u ƒë√∫ng. C√°c t·ª´ s·∫Ω ƒë∆∞·ª£c t·ª± ƒë·ªông t√°ch v√† x√°o tr·ªôn.</p>
                        <input id="jumble-answer" class="w-full p-2 border rounded-lg mb-3" placeholder="V√≠ d·ª•: T√¥i y√™u h·ªçc ti·∫øng Vi·ªát">
                    `;
                    break;
                case 'match':
                    inputs = `
                        <p class="text-sm text-slate-500 mb-2">Nh·∫≠p 3 c·∫∑p gh√©p n·ªëi (C·ªôt A: C√¢u h·ªèi, C·ªôt B: ƒê√°p √°n).</p>
                        <div class="grid grid-cols-2 gap-3 mb-3">
                            <input id="match-a0" class="p-2 border rounded" placeholder="C·ªôt A - C√¢u h·ªèi 1">
                            <input id="match-b0" class="p-2 border rounded" placeholder="C·ªôt B - ƒê√°p √°n 1">
                            <input id="match-a1" class="p-2 border rounded" placeholder="C·ªôt A - C√¢u h·ªèi 2">
                            <input id="match-b1" class="p-2 border rounded" placeholder="C·ªôt B - ƒê√°p √°n 2">
                            <input id="match-a2" class="p-2 border rounded" placeholder="C·ªôt A - C√¢u h·ªèi 3">
                            <input id="match-b2" class="p-2 border rounded" placeholder="C·ªôt B - ƒê√°p √°n 3">
                        </div>
                    `;
                    break;
                case 'translation':
                    inputs = `
                        <p class="text-sm text-slate-500 mb-2">Y√™u c·∫ßu d·ªãch c√¢u ti·∫øng Vi·ªát sang ti·∫øng Trung.</p>
                        <input id="trans-vn" class="w-full p-2 border rounded-lg mb-3" placeholder="C√¢u ti·∫øng Vi·ªát (V√≠ d·ª•: T√¥i y√™u b·∫°n)">
                        <input id="trans-cn" class="w-full p-2 border rounded-lg mb-3" placeholder="ƒê√°p √°n ti·∫øng Trung (V√≠ d·ª•: ÊàëÁà±‰Ω†)">
                    `;
                    break;
                        
                case 'listen_mcq':
                    inputs = `
                        <p class="text-sm text-slate-500 mb-2">Nh·∫≠p vƒÉn b·∫£n ti·∫øng Trung c·∫ßn ph√°t √¢m (Web Speech API).</p>
                        <div class="flex items-center gap-2 mb-3">
                            <input id="listen-mcq-audio" class="flex-1 p-2 border rounded-lg" placeholder="VƒÉn b·∫£n ti·∫øng Trung (V√≠ d·ª•: Ë∞¢Ë∞¢)">
                            <button onclick="speakWord(document.getElementById('listen-mcq-audio').value)" class="bg-purple-200 p-2 rounded-lg text-purple-700 hover:bg-purple-300 transition"><i data-lucide="volume-2" size="20"></i></button>
                        </div>
                        <p class="text-sm text-slate-500 mb-2">C√°c l·ª±a ch·ªçn (ti·∫øng Vi·ªát - nghƒ©a):</p>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 mb-3">
                            <input id="lmcq-opt-0" class="p-2 border rounded" placeholder="Nghƒ©a 1">
                            <input id="lmcq-opt-1" class="p-2 border rounded" placeholder="Nghƒ©a 2">
                            <input id="lmcq-opt-2" class="p-2 border rounded" placeholder="Nghƒ©a 3">
                            <input id="lmcq-opt-3" class="p-2 border rounded" placeholder="Nghƒ©a 4">
                        </div>
                        <select id="lmcq-correct" class="w-full p-2 border rounded mb-3">
                            <option value="0">ƒê√°p √°n 1 ƒë√∫ng</option>
                            <option value="1">ƒê√°p √°n 2 ƒë√∫ng</option>
                            <option value="2">ƒê√°p √°n 3 ƒë√∫ng</option>
                            <option value="3">ƒê√°p √°n 4 ƒë√∫ng</option>
                        </select>
                    `;
                    break;
                case 'listen_write':
                    inputs = `
                        <p class="text-sm text-slate-500 mb-2">Nh·∫≠p c√¢u ti·∫øng Trung (TC) c·∫ßn ph√°t √¢m v√† ƒë√°p √°n ƒë√∫ng.</p>
                        <div class="flex items-center gap-2 mb-3">
                            <input id="listen-write-audio" class="flex-1 p-2 border rounded-lg" placeholder="C√¢u ti·∫øng Trung (V√≠ d·ª•: ÊàëÊòØÂ≠¶Áîü)">
                            <button onclick="speakWord(document.getElementById('listen-write-audio').value)" class="bg-purple-200 p-2 rounded-lg text-purple-700 hover:bg-purple-300 transition"><i data-lucide="volume-2" size="20"></i></button>
                        </div>
                        <input id="listen-write-answer" class="w-full p-2 border rounded-lg mb-3" placeholder="ƒê√°p √°n ƒë√∫ng (Vi·∫øt l·∫°i ch√≠nh x√°c c√¢u TC)">
                    `;
                    break;
                case 'listen_translate':
                    inputs = `
                        <p class="text-sm text-slate-500 mb-2">Nh·∫≠p c√¢u ti·∫øng Trung (TC) c·∫ßn ph√°t √¢m v√† ƒë√°p √°n d·ªãch (TV).</p>
                        <div class="flex items-center gap-2 mb-3">
                            <input id="listen-trans-audio" class="flex-1 p-2 border rounded-lg" placeholder="C√¢u ti·∫øng Trung (V√≠ d·ª•: ‰Ω†Â•ΩÂêó)">
                            <button onclick="speakWord(document.getElementById('listen-trans-audio').value)" class="bg-purple-200 p-2 rounded-lg text-purple-700 hover:bg-purple-300 transition"><i data-lucide="volume-2" size="20"></i></button>
                        </div>
                        <input id="listen-trans-answer" class="w-full p-2 border rounded-lg mb-3" placeholder="ƒê√°p √°n ƒë√∫ng (D·ªãch sang ti·∫øng Vi·ªát)">
                    `;
                    break;
            }

            return inputs;
        };

        const renderClassSelector = () => {
            const myClasses = state.data.classes.filter(c => c.teacherId === state.user.uid);
            
            if (myClasses.length === 0) {
                 return `
                    <div class="mb-4 p-3 bg-red-50 border border-red-300 rounded-xl text-red-700 text-sm">
                        <i data-lucide="alert-triangle" size="18" class="inline-block mr-1"></i> 
                        B·∫°n ch∆∞a c√≥ l·ªõp h·ªçc n√†o. Vui l√≤ng t·∫°o l·ªõp t·∫°i tab "Qu·∫£n l√Ω L·ªõp h·ªçc" tr∆∞·ªõc.
                    </div>
                `;
            }
            
            // L·∫•y danh s√°ch classIds ƒë√£ ch·ªçn t·ª´ state.ui.newAssignment
            const selectedIds = state.ui.newAssignment.selectedClassIds || [];

            return `
                <div class="mb-6 p-4 border border-green-300 rounded-xl bg-green-50">
                    <h4 class="font-bold text-green-800 mb-3">Ch·ªçn L·ªõp h·ªçc ƒë·ªÉ giao b√†i (B·∫Øt bu·ªôc)</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3 max-h-40 overflow-y-auto pr-2">
                        ${myClasses.map(c => `
                            <label class="flex items-center p-2 border rounded-lg cursor-pointer transition ${selectedIds.includes(c.id) ? 'bg-green-600 text-white border-green-700' : 'bg-white hover:bg-green-100'}">
                                <input type="checkbox" value="${c.id}" 
                                    onchange="handleClassSelection(this.value, this.checked)" 
                                    ${selectedIds.includes(c.id) ? 'checked' : ''} 
                                    class="mr-2 rounded text-green-600 focus:ring-green-500">
                                <span>${c.title} <span class="text-xs font-bold ${selectedIds.includes(c.id) ? 'text-green-300' : 'text-slate-500'}">(${c.classCode})</span></span>
                            </label>
                        `).join('')}
                    </div>
                    ${selectedIds.length === 0 ? '<p class="text-xs text-red-500 mt-2">Vui l√≤ng ch·ªçn √≠t nh·∫•t m·ªôt l·ªõp h·ªçc.</p>' : ''}
                </div>
            `;
        }

        const renderCreateAssignmentForm = () => {
            const qList = state.ui.newAssignment.questions.map((q, idx) => renderQuestionDisplay(q, idx)).join('');
            const myBanks = state.data.questionBanks.filter(b => b.createdBy === state.user.uid);
            
            // Check if this form was triggered from a specific class view
            const isClassContext = state.ui.newAssignment.selectedClassIds.length === 1 && 
                                   state.ui.viewClassId === state.ui.newAssignment.selectedClassIds[0];
            const contextClass = isClassContext ? state.data.classes.find(c => c.id === state.ui.viewClassId) : null;
            
            let classSelectorHtml = '';
            if (isClassContext && contextClass) {
                 classSelectorHtml = `
                    <div class="mb-6 p-4 border border-green-300 rounded-xl bg-green-50">
                        <h4 class="font-bold text-green-800 mb-1">Giao b√†i cho L·ªõp:</h4>
                        <p class="text-xl font-bold text-green-700 truncate">${contextClass.title}</p>
                        <p class="text-sm text-green-700">M√£ l·ªõp: ${contextClass.classCode}</p>
                        <button onclick="toggleCreate(false); viewClass('${contextClass.id}')" class="mt-3 text-xs text-green-800 underline hover:no-underline">
                           (Quay l·∫°i l·ªõp h·ªçc)
                        </button>
                    </div>
                 `;
            } else {
                 classSelectorHtml = renderClassSelector();
            }

            return `
                <div class="bg-white p-4 md:p-6 rounded-2xl shadow-lg fade-in max-w-4xl mx-auto">
                    <div class="flex justify-between mb-4 md:mb-6 border-b pb-3">
                        <h3 class="text-xl font-bold">T·∫°o b√†i t·∫≠p m·ªõi</h3>
                        <button onclick="${isClassContext ? `toggleCreate(false); viewClass('${contextClass.id}')` : `toggleCreate(false)`}" class="text-slate-500 hover:text-red-500"><i data-lucide="x"></i></button>
                    </div>
                    <div class="mb-6">
                        <input id="new-assign-title" class="w-full text-lg font-bold border-b-2 border-slate-200 p-2 outline-none focus:border-blue-500" placeholder="Ti√™u ƒë·ªÅ b√†i t·∫≠p..." value="${state.ui.newAssignment.title}">
                    </div>
                    <div class="mb-6">
                        <label class="block text-sm font-bold text-slate-700 mb-1">Th·ªùi gian l√†m b√†i (Ph√∫t)</label>
                        <div class="flex items-center gap-2">
                            <input id="new-assign-time" type="number" min="0" class="w-32 p-2 border-2 rounded-lg text-center font-bold focus:border-blue-500" placeholder="0" value="${state.ui.newAssignment.timeLimit || ''}">
                            <span class="text-slate-500 text-sm">(ƒê·ªÉ tr·ªëng ho·∫∑c 0 n·∫øu kh√¥ng gi·ªõi h·∫°n th·ªùi gian)</span>
                        </div>
                    </div>
                    ${classSelectorHtml}
                    
                    <h4 class="text-lg font-bold text-slate-800 mb-3">Danh s√°ch c√¢u h·ªèi (${state.ui.newAssignment.questions.length})</h4>
                    <div id="questions-preview" class="space-y-4 border p-4 rounded-xl bg-slate-50 max-h-96 overflow-y-auto">${qList || '<p class="text-slate-500">Ch∆∞a c√≥ c√¢u h·ªèi n√†o.</p>'}</div>

                    <div class="mb-6 space-y-4">
                        <button onclick="setSelectingBankQuestions(true)" ${myBanks.length === 0 ? 'disabled' : ''} class="w-full bg-yellow-100 text-yellow-700 py-3 rounded-xl font-bold border border-yellow-300 hover:bg-yellow-200 transition ${myBanks.length === 0 ? 'opacity-50 cursor-not-allowed' : ''}">
                            <i data-lucide="plus-square" size="18" class="inline-block mr-2"></i> L·∫•y c√¢u h·ªèi t·ª´ Ng√¢n h√†ng ƒë·ªÅ
                        </button>
                        ${myBanks.length === 0 ? '<p class="text-xs text-center text-red-500">Ch∆∞a c√≥ ng√¢n h√†ng ƒë·ªÅ n√†o. Vui l√≤ng t·∫°o t·∫°i tab "Ng√¢n h√†ng ƒë·ªÅ".</p>' : ''}
                    </div>

                    ${renderQuestionInputSection(false)}

                    <button onclick="publishAssignment()" class="w-full bg-blue-600 text-white py-3 rounded-xl font-bold hover:bg-blue-700 transition">Xu·∫•t b·∫£n b√†i t·∫≠p</button>
                </div>
            `;
        };
        
        const renderQuestionSelectionFromBank = () => {
            const myBanks = state.data.questionBanks.filter(b => b.createdBy === state.user.uid);
            const selectedBank = myBanks.find(b => b.id === state.ui.selectedBankId);
            
            if (!selectedBank) {
                return `
                    <div class="bg-white p-4 md:p-6 rounded-2xl shadow-lg fade-in max-w-4xl mx-auto">
                        <h3 class="text-xl font-bold text-yellow-600 mb-6 border-b pb-3">Ch·ªçn Ng√¢n h√†ng ƒë·ªÅ</h3>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            ${myBanks.map(bank => `
                                <button onclick="selectBankToDraw('${bank.id}')" class="p-4 rounded-xl shadow-md border border-slate-200 hover:bg-yellow-50 text-left transition">
                                    <p class="font-bold text-slate-800">${bank.title}</p>
                                    <p class="text-sm text-slate-500">${bank.questions.length} c√¢u h·ªèi</p>
                                </button>
                            `).join('')}
                        </div>
                        <button onclick="setSelectingBankQuestions(false)" class="mt-6 text-red-500 text-sm hover:text-red-700">Quay l·∫°i form B√†i t·∫≠p</button>
                    </div>
                `;
            }

            const availableQuestions = selectedBank.questions;
            const currentAssignmentQuestions = state.ui.newAssignment.questions.length;
            
            const qList = availableQuestions.map((q, idx) => {
                const questionInAssignment = state.ui.newAssignment.questions.some(aq => 
                    JSON.stringify(aq) === JSON.stringify(q) // Simple deep comparison
                );
                const typeLabel = getQuestionTypeLabel(q.type);
                
                return `
                    <div class="p-3 border rounded-xl mb-2 flex justify-between items-center ${questionInAssignment ? 'bg-green-50 border-green-300' : 'bg-white border-slate-200'}">
                        <div class="pr-2">
                            <p class="font-medium text-slate-700 text-sm truncate">${typeLabel}: ${q.text.length > 50 ? q.text.substring(0, 50) + '...' : q.text}</p>
                            <p class="text-xs text-slate-500 mt-0.5">${q.type === 'translation' ? `(VN: ${q.vietnamese})` : q.type === 'listen_translate' ? `(TC: ${q.audioText})` : ''}</p>
                        </div>
                        <button onclick="selectQuestionFromBank(${idx}, ${questionInAssignment})" class="px-3 py-1 rounded-lg text-xs font-bold transition flex-shrink-0 ${questionInAssignment ? 'bg-red-500 hover:bg-red-600 text-white' : 'bg-blue-500 hover:bg-blue-600 text-white'}">
                            ${questionInAssignment ? 'ƒê√£ th√™m' : 'Ch·ªçn'}
                        </button>
                    </div>
                `;
            }).join('');

            return `
                <div class="bg-white p-4 md:p-6 rounded-2xl shadow-lg fade-in max-w-4xl mx-auto">
                    <div class="flex justify-between items-center mb-4 md:mb-6 border-b pb-3">
                        <h3 class="text-xl font-bold text-yellow-600 truncate">L·∫•y t·ª´: ${selectedBank.title}</h3>
                        <button onclick="setSelectingBankQuestions(false)" class="text-slate-500 hover:text-red-500"><i data-lucide="x"></i></button>
                    </div>
                    
                    <div class="p-4 bg-blue-50 border border-blue-300 rounded-xl mb-6 flex flex-col sm:flex-row items-center justify-between">
                        <div>
                            <label for="random-count" class="font-bold text-blue-700 block mb-2">L·∫•y ng·∫´u nhi√™n:</label>
                            <div class="flex items-center gap-2">
                                <input id="random-count" type="number" min="10" max="${availableQuestions.length}" value="10" class="w-20 p-2 border rounded-lg text-center">
                                <span class="text-slate-600 text-sm">c√¢u h·ªèi (T·ªëi ƒëa ${availableQuestions.length})</span>
                            </div>
                        </div>
                        <button onclick="addRandomQuestions('${selectedBank.id}')" class="mt-4 sm:mt-0 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-bold transition text-sm">
                            <i data-lucide="shuffle" size="18" class="inline-block mr-1"></i> Th√™m ng·∫´u nhi√™n
                        </button>
                    </div>

                    <h4 class="text-lg font-bold text-slate-800 mb-3">Ch·ªçn th·ªß c√¥ng c√°c c√¢u h·ªèi:</h4>
                    <p class="text-sm text-slate-500 mb-4">B√†i t·∫≠p hi·ªán t·∫°i c√≥ ${currentAssignmentQuestions} c√¢u h·ªèi.</p>
                    <div class="h-80 md:h-96 overflow-y-auto pr-2">
                        ${qList}
                    </div>
                </div>
            `;
        }

        const renderAssignmentDetails = () => {
            const assign = state.data.assignments.find(a => a.id === state.ui.viewAssignmentId);
            if (!assign) return `<p class="text-red-500">Kh√¥ng t√¨m th·∫•y b√†i t·∫≠p.</p>`;
            
            if (state.ui.isSelectingBankQuestions) {
                 return renderQuestionSelectionFromBank(); 
            }

            // D√πng l·∫°i state.ui.newAssignment ƒë·ªÉ ch·ªânh s·ª≠a t·∫°m th·ªùi
            if (!state.ui.newAssignment.id || state.ui.newAssignment.id !== assign.id) {
                // Kh·ªüi t·∫°o tr·∫°ng th√°i ch·ªânh s·ª≠a
                state.ui.newAssignment = { 
                    ...assign, 
                    questions: JSON.parse(JSON.stringify(assign.questions)),
                    selectedClassIds: assign.classIds || [] 
                };
                state.ui.newQuestionType = 'mcq';
            }

            const qList = state.ui.newAssignment.questions.map((q, idx) => renderQuestionDisplay(q, idx)).join('');
            const myBanks = state.data.questionBanks.filter(b => b.createdBy === state.user.uid);


            return `
                <div class="bg-white p-4 md:p-6 rounded-2xl shadow-lg fade-in max-w-4xl mx-auto">
                    <div class="flex justify-between mb-4 md:mb-6 border-b pb-3">
                        <h3 class="text-xl font-bold text-yellow-600">Ch·ªânh s·ª≠a b√†i t·∫≠p</h3>
                        <button onclick="viewAssignmentDetails(null)" class="text-slate-500 hover:text-red-500"><i data-lucide="x"></i></button>
                    </div>
                    
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-slate-600 mb-1">Ti√™u ƒë·ªÅ</label>
                        <input id="edit-assign-title" class="w-full text-lg font-bold border-b-2 border-slate-200 p-2 outline-none focus:border-blue-500" value="${state.ui.newAssignment.title}">
                    </div>
                    <div class="mb-6">
                        <label class="block text-sm font-bold text-slate-700 mb-1">Th·ªùi gian l√†m b√†i (Ph√∫t)</label>
                        <div class="flex items-center gap-2">
                            <input id="edit-assign-time" type="number" min="0" 
                                class="w-32 p-2 border-2 rounded-lg text-center font-bold focus:border-blue-500" 
                                placeholder="0" 
                                value="${state.ui.newAssignment.timeLimit || ''}"> <span class="text-slate-500 text-sm">(ƒê·ªÉ tr·ªëng ho·∫∑c 0 n·∫øu kh√¥ng gi·ªõi h·∫°n)</span>
                        </div>
                    </div>
                    ${renderClassSelector()}

                    <h4 class="text-lg font-bold text-slate-800 mb-3">Danh s√°ch c√¢u h·ªèi (${state.ui.newAssignment.questions.length})</h4>
                    <div id="questions-preview" class="space-y-4 border p-4 rounded-xl bg-slate-50 max-h-96 overflow-y-auto">${qList || '<p class="text-slate-500">Ch∆∞a c√≥ c√¢u h·ªèi n√†o.</p>'}</div>

                    <div class="mb-6 space-y-4">
                        <button onclick="setSelectingBankQuestions(true)" ${myBanks.length === 0 ? 'disabled' : ''} class="w-full bg-yellow-100 text-yellow-700 py-3 rounded-xl font-bold border border-yellow-300 hover:bg-yellow-200 transition ${myBanks.length === 0 ? 'opacity-50 cursor-not-allowed' : ''}">
                            <i data-lucide="plus-square" size="18" class="inline-block mr-2"></i> Th√™m c√¢u h·ªèi t·ª´ Ng√¢n h√†ng ƒë·ªÅ
                        </button>
                        ${myBanks.length === 0 ? '<p class="text-xs text-center text-red-500">Ch∆∞a c√≥ ng√¢n h√†ng ƒë·ªÅ n√†o. Vui l√≤ng t·∫°o t·∫°i tab "Ng√¢n h√†ng ƒë·ªÅ".</p>' : ''}
                    </div>

                    ${renderQuestionInputSection(true)}

                    <button onclick="saveAssignmentChanges('${assign.id}')" class="w-full bg-green-600 text-white py-3 rounded-xl font-bold hover:bg-green-700 transition">L∆∞u thay ƒë·ªïi</button>
                </div>
            `;
        };
        
        // --- H√ÄM RENDER M·ªòT C√ÇU H·ªéI ƒê∆†N L·∫∫ KHI L√ÄM B√ÄI (C·∫≠p nh·∫≠t Responsive) ---
        const renderTakeAssignmentQuestion = (q, qIdx) => {
            const userAnswer = state.ui.assignmentAnswers[qIdx];
            let content = '';

            const audioText = q.audioText || q.audioWord;
            
            const audioLang = q.type === 'listen_translate' ? 'zh-CN' : 'zh-CN'; 
            
            const audioButton = audioText ? `
                <button onclick="speakWord('${audioText.replace(/'/g, "\\'")}', '${audioLang}')" 
                    class="inline-flex items-center gap-2 bg-purple-100 text-purple-700 px-4 py-2 rounded-full font-bold hover:bg-purple-200 transition text-sm mb-4">
                    <i data-lucide="volume-2" size="18"></i> Nghe l·∫°i
                </button>
            ` : '';

            let header = q.text || q.vietnamese || '';
            let placeholderText = '';
            let inputId = `input-q-${qIdx}`;

            switch (q.type) {
                case 'mcq':
                case 'listen_mcq': 
                    header = q.type === 'listen_mcq' ? `Nghe v√† ch·ªçn nghƒ©a ƒë√∫ng:` : header;
                    content = q.options.map((opt, oIdx) => `
                        <button onclick="selectAnswer(${qIdx}, ${oIdx})" 
                            class="w-full text-left p-3 md:p-4 border-2 rounded-xl transition-colors font-medium text-base md:text-lg
                            ${userAnswer === oIdx ? 'bg-blue-600 text-white border-blue-600 shadow-md' : 'bg-white border-slate-200 hover:bg-slate-50 text-slate-700'}">
                            <span class="font-bold mr-2">${String.fromCharCode(65 + oIdx)}.</span> ${opt}
                        </button>
                    `).join('');
                    content = `<div class="space-y-3">${content}</div>`;
                    break;

                case 'fib':
                    header = `ƒêi·ªÅn t·ª´ th√≠ch h·ª£p v√†o ch·ªó tr·ªëng:<br><span class="text-blue-600 font-bold">${q.text.replace('[BLANK]', '______')}</span>`;
                    placeholderText = 'Nh·∫≠p t·ª´/c·ª•m t·ª´ c√≤n thi·∫øu...';
                    break;
                case 'translation':
                    header = `D·ªãch c√¢u ti·∫øng Vi·ªát sang ti·∫øng Trung:<br><span class="text-blue-600 font-bold">${q.vietnamese}</span>`;
                    placeholderText = 'Nh·∫≠p c√¢u tr·∫£ l·ªùi b·∫±ng ti·∫øng Trung...';
                    break;
                case 'listen_write': 
                    header = `Nghe v√† vi·∫øt l·∫°i c√¢u ti·∫øng Trung:`;
                    placeholderText = 'Nh·∫≠p c√¢u ti·∫øng Trung ƒë√£ nghe...';
                    break;
                case 'listen_translate': 
                    header = `Nghe v√† d·ªãch c√¢u sang ti·∫øng Vi·ªát:`;
                    placeholderText = 'Nh·∫≠p b·∫£n d·ªãch ti·∫øng Vi·ªát...';
                    break;
                    
                case 'jumble':
                    header = `S·∫Øp x·∫øp c√°c t·ª´ th√†nh c√¢u ƒë√∫ng:`;
                    const availableWords = q.shuffledWords || q.answer; 
                    const placedWords = window.getJumbleAnswer(qIdx);
                    
                    const remainingWords = availableWords.filter(word => {
                        const availableCount = availableWords.filter(w => w === word).length;
                        const placedCount = placedWords.filter(w => w === word).length;
                        return placedCount < availableCount;
                    });

                    content = `
                        <div class="mb-6 p-3 md:p-4 border-2 border-dashed border-blue-300 rounded-xl bg-blue-50 min-h-[5rem] flex flex-wrap items-center">
                            ${placedWords.map((word, wIdx) => `
                                <button onclick="removeJumbleWord(${qIdx}, '${word}', ${wIdx})" 
                                    class="jumble-word bg-blue-600 text-white hover:bg-blue-700 transition transform active:scale-95 shadow-md">
                                    ${word} <i data-lucide="x" class="inline w-3 h-3 ml-1"></i>
                                </button>
                            `).join('')}
                            ${placedWords.length === 0 ? '<span class="text-slate-500 italic text-sm">Nh·∫•n v√†o t·ª´ b√™n d∆∞·ªõi ƒë·ªÉ s·∫Øp x·∫øp</span>' : ''}
                        </div>
                        <div class="flex flex-wrap gap-2 justify-center p-4 bg-slate-100 rounded-xl">
                            ${remainingWords.map(word => `
                                <button onclick="addJumbleWord(${qIdx}, '${word}')" class="jumble-word">
                                    ${word}
                                </button>
                            `).join('')}
                        </div>
                    `;
                    break;
                    
                case 'match':
                    const colB = q.shuffledColB || q.pairs.map(p => p.b).sort(() => Math.random() - 0.5); 
                    const colA = q.pairs.map(p => p.a);
                    const currentMatches = state.ui.assignmentAnswers[qIdx] || {};
                    
                    content = `
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <h4 class="font-bold text-slate-700 mb-2 text-lg">C·ªôt A</h4>
                                <div class="space-y-3">
                                ${colA.map((textA) => `
                                    <div class="p-3 bg-blue-100 border border-blue-200 rounded-xl text-blue-800 font-medium text-base">${textA}</div>
                                `).join('')}
                                </div>
                            </div>
                            <div>
                                <h4 class="font-bold text-slate-700 mb-2 text-lg">C·ªôt B (Gh√©p n·ªëi)</h4>
                                <div class="space-y-3">
                                ${colA.map((_, aIdx) => {
                                    const selectedBIndex = currentMatches[aIdx] === undefined ? "" : currentMatches[aIdx];
                                    return `
                                        <select onchange="selectMatchAnswer(${qIdx}, ${aIdx}, this.value, ${JSON.stringify(colB).replace(/'/g, "\\'")})" 
                                            class="w-full p-3 border-2 rounded-xl bg-white appearance-none focus:border-green-500 transition cursor-pointer text-base font-medium">
                                            <option value="">-- Ch·ªçn ƒë√°p √°n cho A${aIdx+1} --</option>
                                            ${colB.map((textB, bIdx) => `
                                                <option value="${bIdx}" ${selectedBIndex === bIdx ? 'selected' : ''}>${textB}</option>
                                            `).join('')}
                                        </select>
                                    `;
                                }).join('')}
                                </div>
                            </div>
                        </div>
                    `;
                    break;
            }
            
            if (['fib', 'translation', 'listen_write', 'listen_translate'].includes(q.type)) {
                const initialValue = userAnswer || '';
                content = `
                    <div class="text-center mt-6">
                        <input type="text" id="${inputId}" 
                            oninput="captureInputAnswer(${qIdx}, this.value)" 
                            value="${initialValue}"
                            class="w-full max-w-lg p-3 md:p-4 text-lg md:text-xl border-2 border-slate-300 rounded-xl focus:border-blue-500 outline-none text-center font-bold" 
                            placeholder="${placeholderText}" />
                    </div>
                `;
            }


            return `
                <div class="mb-8 fade-in text-center">
                    <div class="text-xl md:text-2xl font-bold text-slate-800 mb-4 leading-relaxed">${header}</div>
                    ${audioButton}
                    <div class="text-left">${content}</div>
                </div>
            `;
        };

        // --- H√ÄM C·∫¨P NH·∫¨T UI C·ª§C B·ªò CHO CH·∫æ ƒê·ªò L√ÄM B√ÄI T·∫¨P (FIX SCROLL JUMP) ---
        window.updateAssignmentQuestionUI = (assign, qIndex) => {
            const questionEl = document.getElementById('assignment-question-content');
            if (!questionEl) return;
            
            const totalQuestions = assign.questions.length;
            const currentQ = assign.questions[qIndex];
            const questionHtml = renderTakeAssignmentQuestion(currentQ, qIndex);

            // G√°n l·∫°i n·ªôi dung c√¢u h·ªèi
            questionEl.innerHTML = questionHtml;
            
            // C·∫≠p nh·∫≠t b·ªô ƒë·∫øm
            document.getElementById('assignment-q-counter').textContent = `C√¢u h·ªèi ${qIndex + 1} / ${totalQuestions}`;

            // C·∫≠p nh·∫≠t n√∫t ƒëi·ªÅu h∆∞·ªõng
            const isFirst = qIndex === 0;
            const isLast = qIndex === totalQuestions - 1;
            
            const prevBtn = document.getElementById('prev-q-btn');
            const nextContainer = document.getElementById('next-q-btn-container');

            if (prevBtn) {
                prevBtn.disabled = isFirst;
                prevBtn.classList.toggle('text-slate-400', isFirst);
                prevBtn.classList.toggle('cursor-not-allowed', isFirst);
                prevBtn.classList.toggle('bg-slate-100', isFirst);
                prevBtn.classList.toggle('bg-slate-200', !isFirst);
                prevBtn.classList.toggle('hover:bg-slate-300', !isFirst);
            }

            if (nextContainer) {
                nextContainer.innerHTML = isLast ? `
                    <button onclick="submitAssignment()" class="flex-1 bg-green-600 hover:bg-green-700 text-white py-3 px-6 rounded-xl font-bold text-lg shadow-lg transition">
                        <i data-lucide="send" size="20" class="inline-block mr-1"></i> N·ªôp b√†i
                    </button>
                ` : `
                    <button id="next-q-btn" onclick="goToNextQuestion()" 
                        class="flex items-center gap-2 px-6 py-3 rounded-xl font-bold transition bg-blue-600 hover:bg-blue-700 text-white">
                        Ti·∫øn <i data-lucide="arrow-right" size="20"></i>
                    </button>
                `;
            }

            renderIcons();
        };


        const renderTakeAssignment = () => {
            const assign = state.data.assignments.find(a => a.id === state.ui.takingAssignmentId);
            if (!assign) return '';
            
            if (!assign.questions.some(q => q.shuffledWords || q.shuffledColB)) { 
                assign.questions.forEach(q => {
                    if (q.type === 'jumble' && q.answer) {
                        q.shuffledWords = [...q.answer].sort(() => Math.random() - 0.5); 
                    } else if (q.type === 'match' && q.pairs) {
                        q.shuffledColB = q.pairs.map(p => p.b).sort(() => Math.random() - 0.5);
                    }
                });
            }

            const qIndex = state.ui.currentQuestionIndex;
            const totalQuestions = assign.questions.length;
            const currentQ = assign.questions[qIndex];
            
            const isFirst = qIndex === 0;
            const isLast = qIndex === totalQuestions - 1;

            const questionHtml = renderTakeAssignmentQuestion(currentQ, qIndex);
            let timerHtml = '';
            if (assign.timeLimit) {
                // Hi·ªÉn th·ªã ƒë·ªìng h·ªì treo g√≥c ph·∫£i m√†n h√¨nh
                timerHtml = `
                    <div class="fixed top-16 right-4 z-40 bg-white border-2 border-slate-200 shadow-lg rounded-xl px-4 py-2 flex items-center gap-2 animate-bounce-in">
                        <i data-lucide="clock" class="text-slate-500 w-5 h-5"></i>
                        <span id="assignment-timer-display" class="font-mono text-xl font-bold text-slate-700">
                            ${assign.timeLimit}:00
                        </span>
                    </div>
                `;
            }
            return `
                ${timerHtml}
                <div class="max-w-3xl mx-auto bg-white p-4 md:p-8 rounded-2xl shadow-lg fade-in">
                    <div class="flex justify-between items-center mb-6 pb-4 border-b">
                        <h3 class="text-xl md:text-2xl font-bold truncate">${assign.title}</h3>
                        <button onclick="startAssignment(null)" class="text-slate-400 hover:text-red-500"><i data-lucide="x"></i></button>
                    </div>
                    
                    <div class="text-center mb-6">
                        <span id="assignment-q-counter" class="bg-blue-100 text-blue-700 px-4 py-2 rounded-full font-bold text-sm">
                            C√¢u h·ªèi ${qIndex + 1} / ${totalQuestions}
                        </span>
                    </div>

                    <div id="assignment-question-content">${questionHtml}</div>

                    <div class="mt-8 pt-6 border-t flex justify-between items-center">
                        <button id="prev-q-btn" onclick="goToPreviousQuestion()" 
                            class="flex items-center gap-2 px-4 md:px-6 py-2 md:py-3 rounded-xl font-bold transition text-sm md:text-base ${isFirst ? 'text-slate-400 cursor-not-allowed bg-slate-100' : 'bg-slate-200 hover:bg-slate-300 text-slate-700'}" 
                            ${isFirst ? 'disabled' : ''}>
                            <i data-lucide="arrow-left" size="20"></i> L√πi
                        </button>
                        
                        <div id="next-q-btn-container">
                            ${isLast ? `
                                <button onclick="submitAssignment()" class="flex-1 bg-green-600 hover:bg-green-700 text-white py-3 px-6 rounded-xl font-bold text-lg shadow-lg transition">
                                    <i data-lucide="send" size="20" class="inline-block mr-1"></i> N·ªôp b√†i
                                </button>
                            ` : `
                                <button id="next-q-btn" onclick="goToNextQuestion()" 
                                    class="flex items-center gap-2 px-4 md:px-6 py-2 md:py-3 rounded-xl font-bold transition bg-blue-600 hover:bg-blue-700 text-white text-sm md:text-base">
                                    Ti·∫øn <i data-lucide="arrow-right" size="20"></i>
                                </button>
                            `}
                        </div>
                    </div>
                </div>
            `;
        };
        
        // M·ªöI: RENDER K·∫æT QU·∫¢ B√ÄI N·ªòP (C·∫≠p nh·∫≠t Responsive)
        const renderSubmissionResult = () => {
            const sub = state.ui.viewSubmission;
            const assign = state.data.assignments.find(a => a.id === sub.assignmentId);
            if (!assign) return `<p class="text-red-500">Kh√¥ng t√¨m th·∫•y b√†i t·∫≠p g·ªëc.</p>`;

            const renderQuestionReview = (q, qIdx) => {
                const userAnswer = sub.answers[qIdx];
                const type = q.type;
                let isCorrect = false;
                let explanation = '';

                const subQData = sub.questionData?.[qIdx] || {};
                
                switch(type) {
                    case 'mcq':
                    case 'listen_mcq':
                        isCorrect = userAnswer === q.correct;
                        explanation = `ƒê√°p √°n ƒë√∫ng: <span class="font-bold text-green-600">${q.options[q.correct]}</span>. B·∫°n ch·ªçn: <span class="${isCorrect ? 'text-green-600' : 'text-red-600'}">${q.options[userAnswer] || 'Ch∆∞a tr·∫£ l·ªùi'}</span>`;
                        break;
                    case 'fib':
                    case 'translation':
                    case 'listen_write':
                    case 'listen_translate':
                        if (userAnswer) {
                            let expectedAnswer;
                            if (type === 'translation') expectedAnswer = q.chinese;
                            else if (type === 'listen_translate') expectedAnswer = q.answer; 
                            else expectedAnswer = q.answer; 
                            
                            const userAnsClean = (userAnswer || '').trim().toLowerCase();
                            const expectedAnsClean = expectedAnswer.trim().toLowerCase();
                            isCorrect = userAnsClean === expectedAnsClean;
                            explanation = `ƒê√°p √°n ƒë√∫ng: **${expectedAnswer}**. B·∫°n tr·∫£ l·ªùi: <span class="${isCorrect ? 'text-green-600' : 'text-red-600'}">${userAnswer || 'Ch∆∞a tr·∫£ l·ªùi'}</span>`;
                        } else {
                            explanation = `ƒê√°p √°n ƒë√∫ng: **${q.answer || q.chinese}**. B·∫°n tr·∫£ l·ªùi: Ch∆∞a tr·∫£ l·ªùi.`;
                        }
                        break;
                    case 'jumble':
                        const jumbleUser = Array.isArray(userAnswer) ? userAnswer.join(' ') : '';
                        const jumbleCorrect = q.answer.join(' ');
                        isCorrect = jumbleUser === jumbleCorrect;
                        explanation = `C√¢u ƒë√∫ng: **${jumbleCorrect}**. B·∫°n s·∫Øp x·∫øp: <span class="${isCorrect ? 'text-green-600' : 'text-red-600'}">${jumbleUser || 'Ch∆∞a tr·∫£ x·∫øp'}</span>`;
                        break;
                    case 'match':
                        if (userAnswer) {
                             const userMatches = userAnswer;
                             const shuffledColB = subQData.shuffledColB || q.pairs.map(p => p.b).sort(() => Math.random() - 0.5); 
                             const numCorrectMatches = q.pairs.reduce((count, p, aIdx) => {
                                 const selectedBIndex = userMatches[aIdx];
                                 const selectedB = shuffledColB[selectedBIndex]; 
                                 return count + (selectedB && selectedB === p.b ? 1 : 0);
                             }, 0);
                             isCorrect = numCorrectMatches === q.pairs.length;
                             explanation = `B·∫°n gh√©p ƒë√∫ng: ${numCorrectMatches}/${q.pairs.length} c·∫∑p.`;
                        } else {
                            explanation = 'B·∫°n gh√©p ƒë√∫ng: 0/3 c·∫∑p.';
                        }
                        break;
                }
                
                const icon = isCorrect ? '<i data-lucide="check-circle" class="text-green-500 w-5 h-5 flex-shrink-0"></i>' : '<i data-lucide="x-circle" class="text-red-500 w-5 h-5 flex-shrink-0"></i>';
                const bgColor = isCorrect ? 'bg-green-50' : 'bg-red-50';
                
                const questionText = q.type === 'translation' ? q.vietnamese : 
                                     q.type.startsWith('listen_') ? `[Nghe] ${q.audioText}` : 
                                     q.text;


                return `
                    <div class="p-3 md:p-4 rounded-xl border mb-4 ${bgColor}">
                        <div class="flex items-start justify-between mb-2">
                            <p class="font-bold text-slate-800 text-sm md:text-base">C√¢u ${qIdx+1}: ${getQuestionTypeLabel(q.type)} - ${questionText}</p>
                            <div class="flex items-center gap-2 font-medium text-sm ml-4">${icon} <span class="hidden sm:inline">${isCorrect ? 'ƒê√∫ng' : 'Sai'}</span></div>
                        </div>
                        <p class="text-sm text-slate-600">${explanation}</p>
                    </div>
                `;
            }

            const qHtml = assign.questions.map(renderQuestionReview).join('');
            const isPassed = sub.score >= 50;

            return `
                <div class="max-w-3xl mx-auto bg-white p-4 md:p-8 rounded-2xl shadow-lg fade-in">
                    <div class="flex justify-between items-center mb-6 pb-4 border-b">
                        <h3 class="text-xl md:text-2xl font-bold truncate">K·∫øt qu·∫£ b√†i l√†m: ${assign.title}</h3>
                        <button onclick="viewSubmissionResult(null)" class="text-slate-400 hover:text-red-500"><i data-lucide="x"></i></button>
                    </div>

                    <div class="text-center p-6 rounded-xl mb-6 ${isPassed ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                        <p class="text-sm font-medium">ƒêi·ªÉm s·ªë c·ªßa b·∫°n:</p>
                        <p class="text-6xl font-black">${sub.score}<span class="text-3xl">/100</span></p>
                        <p class="text-lg font-bold mt-2">${isPassed ? 'üéâ Ch√∫c m·ª´ng, b·∫°n ƒë√£ ho√†n th√†nh t·ªët!' : 'üò¢ C·∫ßn c·ªë g·∫Øng h∆°n.'}</p>
                    </div>

                    <h4 class="text-xl font-bold text-slate-700 mb-4">Chi ti·∫øt t·ª´ng c√¢u h·ªèi</h4>
                    <div class="space-y-4">
                        ${qHtml}
                    </div>
                </div>
            `;
        };

        // RANKING (C·∫≠p nh·∫≠t Responsive)
        const renderRanking = () => {
            const sorted = [...state.data.users].sort((a,b) => (b.points||0) - (a.points||0));
            
            // Helper ƒë·ªÉ render huy hi·ªáu
            const renderMedal = (rank) => {
                if (rank === 1) return `<span class="text-2xl md:text-3xl">ü•á</span>`;
                if (rank === 2) return `<span class="text-2xl md:text-3xl">ü•à</span>`;
                if (rank === 3) return `<span class="text-2xl md:text-3xl">ü•â</span>`;
                return `<span class="font-bold text-sm md:text-base text-slate-500">#${rank}</span>`;
            };

            return `
                <div class="bg-white rounded-2xl shadow-md overflow-hidden max-w-4xl mx-auto fade-in">
                    <div class="bg-yellow-500 p-6 md:p-8 text-center text-white">
                        <i data-lucide="trophy" class="w-10 h-10 md:w-12 md:h-12 mx-auto drop-shadow-lg mb-2"></i>
                        <h3 class="text-2xl md:text-3xl font-bold">B·∫£ng X·∫øp H·∫°ng ƒêi·ªÉm</h3>
                    </div>
                    <div class="p-1 md:p-1">
                        <div class="overflow-x-auto">
                            <table class="w-full min-w-[200px]">
                                <thead>
                                    <tr class="text-left text-slate-500 text-sm border-b bg-slate-50">
                                        <th class="pb-3 pl-4 pt-3 w-16">H·∫°ng</th>
                                        <th class="pb-3 pt-3">H·ªçc sinh</th>
                                        <th class="pb-3 text-right pr-4 pt-3 w-20">ƒêi·ªÉm s·ªë</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${sorted.map((u, idx) => {
                                        let isMe = u.uid === state.user.uid;
                                        return `
                                        <tr class="border-b last:border-0 hover:bg-slate-100 transition ${isMe ? 'bg-blue-50 border-blue-200' : ''}">
                                            <td class="py-3 md:py-4 pl-4 font-bold">
                                                ${renderMedal(idx+1)}
                                            </td>
                                            <td class="py-3 md:py-4 flex items-center gap-3">
                                                <!--${renderAvatar(u, 'w-6 h-6', 'text-sm')} -->
                                                ${renderAvatar(u, 'w-6 h-6', 'text-sm')}
                                                <span class="font-medium ${isMe ? 'text-blue-700' : 'text-slate-700'} truncate">${u.name} ${isMe ? '(B·∫°n)' : ''}</span>
                                            </td>
                                            <td class="py-3 md:py-4 text-right pr-4 font-bold text-lg md:text-xl text-yellow-600">${u.points || 0}</td>
                                        </tr>`;
                                    }).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
        };

        // COMPETITION RENDERERS (C·∫≠p nh·∫≠t Responsive)

        const renderCompetitionLobby = () => `
             <div class="text-center py-8 md:py-12 bg-white rounded-3xl shadow-xl max-w-2xl mx-auto fade-in">
                <div class="inline-block p-4 md:p-6 bg-purple-100 rounded-full mb-4 md:mb-6">
                    <i data-lucide="swords" class="w-12 h-12 md:w-16 md:h-16 text-purple-600"></i>
                </div>
                <h2 class="text-2xl md:text-3xl font-bold text-slate-800 mb-4 md:mb-6">ƒê·∫•u tr∆∞·ªùng T·ª´ v·ª±ng</h2>
                <div class="mb-6">
                    <p class="text-slate-500 text-sm md:text-base">S·ªë l∆∞·ª£ng t·ª´ v·ª±ng hi·ªán c√≥: <span class="font-bold text-blue-600">${state.data.vocabulary.length}</span></p>
                    <p class="text-xs text-slate-400 mt-1">(D·ªØ li·ªáu load t·ª´ dataLMS/data.txt)</p>
                </div>
                <div class="flex flex-col sm:flex-row justify-center gap-4 md:gap-8 px-4">
                    <button onclick="createMatch()" class="bg-purple-600 hover:bg-purple-700 text-white px-6 py-3 md:px-8 md:py-4 rounded-xl md:rounded-2xl font-bold text-base md:text-lg shadow-lg transition transform hover:-translate-y-0.5">
                        T·∫°o Ph√≤ng M·ªõi
                    </button>
                    <button onclick="setCompetitionMode('join')" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 md:px-8 md:py-4 rounded-xl md:rounded-2xl font-bold text-base md:text-lg shadow-lg transition transform hover:-translate-y-0.5">
                        Tham Gia Ph√≤ng
                    </button>
                </div>
            </div>
        `;

        const renderCompetitionJoin = () => `
            <div class="max-w-sm mx-auto bg-white p-6 md:p-8 rounded-2xl shadow-xl text-center fade-in">
                <h3 class="text-xl md:text-2xl font-bold text-slate-700 mb-6">Nh·∫≠p M√£ Ph√≤ng</h3>
                <input id="room-code-input" type="text" class="w-full p-4 border-2 border-slate-300 rounded-xl text-center text-xl font-bold tracking-widest uppercase mb-4 focus:border-blue-500" maxlength="6" placeholder="CODE">
                <button onclick="joinMatch()" class="w-full bg-blue-600 text-white py-3 rounded-xl font-bold mb-4 transition hover:bg-blue-700">Tham Gia</button>
                <button onclick="setCompetitionMode('lobby')" class="text-slate-500 text-sm hover:text-slate-700">Quay l·∫°i</button>
            </div>
        `;

        const renderCompetitionWaiting = (match) => {
            const isOwner = match.player1.uid === state.user.uid;
            const p1Profile = state.data.users.find(u => u.uid === match.player1.uid);
            const p2Profile = match.player2 ? state.data.users.find(u => u.uid === match.player2.uid) : null;
            
            return `
                <div class="max-w-xl mx-auto bg-white p-6 md:p-8 rounded-2xl shadow-xl text-center fade-in">
                    <h3 class="text-xl md:text-2xl font-bold text-slate-700 mb-2">Ph√≤ng ch·ªù: <span class="text-purple-600">${match.roomCode}</span></h3>
                    <p class="text-slate-500 text-sm mb-6">Chia s·∫ª m√£ n√†y cho ƒë·ªëi th·ªß.</p>
                    <div class="flex justify-center gap-8 mb-8">
                        <div class="text-center">
                            ${renderAvatar(p1Profile, 'w-16 h-16', 'text-xl')}
                            <p class="font-bold text-blue-700 mt-2 truncate">${match.player1.name}</p>
                        </div>
                        <div class="self-center font-bold text-slate-300 text-xl">VS</div>
                        <div class="text-center">
                            ${match.player2 ? renderAvatar(p2Profile, 'w-16 h-16', 'text-xl') : `
                                <div class="w-16 h-16 bg-slate-100 text-slate-400 rounded-full flex items-center justify-center mx-auto mb-2 font-bold text-xl">
                                    ?
                                </div>
                            `}
                            <p class="font-bold ${match.player2 ? 'text-red-700' : 'text-slate-400'} mt-2 truncate">${match.player2 ? match.player2.name : 'ƒêang ch·ªù...'}</p>
                        </div>
                    </div>
                    ${isOwner && match.player2 ? `<button onclick="startMatch('${match.id}')" class="bg-green-600 text-white py-3 px-8 rounded-xl font-bold text-lg shadow-md transition transform hover:-translate-y-0.5 animate-pulse">B·∫Øt ƒë·∫ßu ngay</button>` : ''}
                    ${!match.player2 ? `<button onclick="leaveMatch('${match.id}')" class="mt-4 text-red-500 text-sm hover:text-red-700">H·ªßy ph√≤ng</button>` : ''}
                </div>
            `;
        };

        const renderCompetitionPlaying = (match) => {
            return `
                <div id="match-playing-container" class="max-w-4xl mx-auto">
                    <div class="flex justify-between items-center mb-6 md:mb-8">
                        <!-- Player 1 Box (Responsive) -->
                        <div class="bg-blue-600 text-white px-4 py-2 md:px-6 md:py-3 rounded-xl shadow-lg transition-all duration-300 flex items-center gap-2 md:gap-3 flex-1 mr-2" id="p1-box">
                            ${renderAvatar(state.data.users.find(u => u.uid === match.player1.uid), 'w-8 h-8', 'text-sm')}
                            <div class="truncate">
                                <p class="text-xs md:text-sm opacity-80 truncate">${match.player1.name}</p>
                                <p class="text-2xl md:text-3xl font-bold" id="p1-score">${match.player1.score}</p>
                            </div>
                        </div>
                        
                        <div class="text-xl font-extrabold text-slate-400 mx-2">VS</div>

                        <!-- Player 2 Box (Responsive) -->
                        <div class="bg-red-500 text-white px-4 py-2 md:px-6 md:py-3 rounded-xl shadow-lg text-right transition-all duration-300 flex items-center gap-2 md:gap-3 flex-1 ml-2" id="p2-box">
                            <div class="truncate">
                                <p class="text-xs md:text-sm opacity-80 truncate">${match.player2.name}</p>
                                <p class="text-2xl md:text-3xl font-bold" id="p2-score">${match.player2.score}</p>
                            </div>
                            ${renderAvatar(state.data.users.find(u => u.uid === match.player2.uid), 'w-8 h-8', 'text-sm')}
                        </div>
                    </div>

                    <div class="bg-white p-6 md:p-8 rounded-3xl shadow-2xl text-center border-b-8 border-slate-200">
                        <div class="mb-4 md:mb-6">
                            <span id="q-counter" class="bg-slate-100 text-slate-600 px-3 py-1 rounded-full text-sm font-bold uppercase"></span>
                        </div>
                        
                        <div id="audio-container" class="mb-4 hidden"></div>
                        
                        <h2 id="q-text" class="text-xl md:text-3xl font-medium text-slate-700 mb-6 md:mb-8 leading-relaxed min-h-[3rem] md:min-h-[4rem] flex items-center justify-center">
                            </h2>

                        <div id="options-grid" class="grid grid-cols-1 md:grid-cols-2 gap-3 md:gap-4">
                            </div>
                    </div>
                </div>
            `;
        };

        // H√†m Update th√¥ng minh (ch·∫°y m·ªói khi c√≥ d·ªØ li·ªáu m·ªõi)
        window.updatePlayingUI = () => {
            const match = state.ui.activeMatch;
            if (!match || !document.getElementById('match-playing-container')) return;

            const qIndex = match.qIndex || 0;
            const q = match.questions[qIndex];
            
            // 1. Update Scores
            document.getElementById('p1-score').textContent = match.player1.score;
            document.getElementById('p2-score').textContent = match.player2.score;

            // Highlight leader
            const p1Box = document.getElementById('p1-box');
            const p2Box = document.getElementById('p2-box');
            p1Box.classList.remove('scale-105', 'ring-4', 'ring-blue-300', 'z-10');
            p2Box.classList.remove('scale-105', 'ring-4', 'ring-red-300', 'z-10');

            if (match.player1.score > match.player2.score) {
                p1Box.classList.add('scale-105', 'ring-4', 'ring-blue-300', 'z-10');
            } else if (match.player2.score > match.player1.score) {
                p2Box.classList.add('scale-105', 'ring-4', 'ring-red-300', 'z-10');
            }

            // N·∫øu c√¢u h·ªèi hi·ªán t·∫°i ƒë√£ ƒë∆∞·ª£c tr·∫£ l·ªùi, v√¥ hi·ªáu h√≥a c√°c n√∫t
            const buttonsDisabled = state.ui.hasAnsweredCurrentQ;

            // 2. Update Counter
            document.getElementById('q-counter').textContent = `C√¢u h·ªèi ${qIndex + 1}/${match.questions.length}`;

            // 3. Update Audio Button
            const audioText = q.audioWord || q.audioSentence;
            const audioContainer = document.getElementById('audio-container');
            if (audioText) {
                audioContainer.innerHTML = `
                    <button onclick="speakWord('${audioText.replace(/'/g, "\\'")}', 'zh-CN')" class="inline-flex items-center gap-2 bg-purple-100 text-purple-700 px-6 py-3 rounded-full font-bold hover:bg-purple-200 transition text-sm md:text-base ${buttonsDisabled ? 'opacity-50 cursor-not-allowed' : ''}" ${buttonsDisabled ? 'disabled' : ''}>
                        <i data-lucide="volume-2"></i> Nghe √¢m thanh
                    </button>`;
                audioContainer.classList.remove('hidden');
            } else {
                audioContainer.classList.add('hidden');
            }
            renderIcons();

            // 4. Update Question Text
            const qTextEl = document.getElementById('q-text');
            if (qTextEl.innerHTML !== q.text) {
                qTextEl.innerHTML = q.text;
                if (audioText) setTimeout(() => speakWord(audioText, 'zh-CN'), 300); 
            }

            // 5. Update Options
            const grid = document.getElementById('options-grid');
            const currentQId = grid.getAttribute('data-qid');

            if (currentQId !== String(qIndex) || buttonsDisabled) { 
                grid.setAttribute('data-qid', qIndex);
                
                if (q.type === 'arena_input') {
                     grid.innerHTML = `
                        <div class="text-center mt-4 md:mt-6 col-span-full">
                            <input type="text" id="arena-input-q-${qIndex}" 
                                oninput="captureArenaInputAnswer(this.value)" 
                                class="w-full max-w-xl p-3 md:p-4 text-lg md:text-xl border-2 border-slate-300 rounded-xl focus:border-blue-500 outline-none text-center font-bold" 
                                placeholder="Nh·∫≠p c√¢u ti·∫øng Trung ƒë√£ nghe..." 
                                ${buttonsDisabled ? 'disabled' : ''} />
                            <button onclick="handleArenaInputAnswer('${match.id}')" 
                                class="mt-4 bg-blue-500 text-white px-6 py-3 rounded-xl font-bold hover:bg-blue-600 transition text-sm md:text-base"
                                ${buttonsDisabled ? 'disabled' : ''}>
                                <i data-lucide="send" size="20" class="inline-block mr-1"></i> Tr·∫£ l·ªùi
                            </button>
                        </div>
                     `;
                } else {
                    grid.innerHTML = q.options.map((opt, idx) => `
                        <button id="opt-btn-${idx}" onclick="handleAnswerAttempt(${idx === q.correct}, '${match.id}', ${idx})" class="p-4 md:p-6 bg-slate-50 border-2 border-slate-200 hover:border-blue-500 hover:bg-blue-50 hover:text-blue-700 rounded-2xl text-base md:text-xl font-bold transition-all transform active:scale-95 text-slate-700 ${buttonsDisabled ? 'opacity-50 cursor-not-allowed' : ''}" ${buttonsDisabled ? 'disabled' : ''}>
                            ${opt}
                        </button>
                    `).join('');
                }
            }
        };

        window.handleArenaInputAnswer = async (mid) => {
             const match = state.ui.activeMatch;
             if (!match || match.status !== 'playing' || state.ui.hasAnsweredCurrentQ) return;
             
             const qIndex = match.qIndex || 0;
             const q = match.questions[qIndex];
             const userAnswer = (document.getElementById(`arena-input-q-${qIndex}`).value || '').trim().toLowerCase();
             const correctAnswer = (q.correct || '').trim().toLowerCase();

             const isCorrect = userAnswer === correctAnswer;
             
             state.ui.hasAnsweredCurrentQ = true;
             
             const inputEl = document.getElementById(`arena-input-q-${qIndex}`);
             inputEl.disabled = true;
             
             if (isCorrect) {
                  inputEl.classList.add('bg-green-100', 'border-green-600');
                  showToast("Ch√≠nh x√°c!", "success");
             } else {
                 inputEl.classList.add('bg-red-100', 'border-red-600');
                 showToast(`Sai! ƒê√°p √°n ƒë√∫ng l√†: ${q.correct}`, "error");
             }
             
             if (isCorrect) {
                 try {
                     await runTransaction(db, async (transaction) => {
                         const matchRef = doc(db, getPath('matches'), mid);
                         const matchDoc = await transaction.get(matchRef);

                         if (!matchDoc.exists) { throw "Match does not exist!"; }

                         const matchData = matchDoc.data();
                         const currentQIndex = matchData.qIndex || 0;
                         const questionsLength = matchData.questions.length;

                         if (currentQIndex === state.ui.matchQIndex) {
                             const isP1 = match.player1.uid === state.user.uid;
                             const newScore = (isP1 ? matchData.player1.score : matchData.player2.score) + 10;
                             const nextQIndex = currentQIndex + 1;
                             
                             const updateData = {};
                             updateData[isP1 ? "player1.score" : "player2.score"] = newScore;
                             
                             if (nextQIndex < questionsLength) {
                                 updateData.qIndex = nextQIndex;
                             } else {
                                 updateData.status = 'finished';
                             }
                             
                             transaction.update(matchRef, updateData);
                             
                             if (updateData.status === 'finished') {
                                 transaction.update(matchRef, {...updateData, winnerScore: newScore, finishedBy: state.user.uid});
                             }

                             state.ui.matchQIndex = nextQIndex;
                             updatePlayingUI();
                         }
                     });
                 } catch (e) {
                     console.error("Transaction failed:", e);
                 }
             } else {
                 setTimeout(() => {
                    if (state.ui.activeMatch) {
                        state.ui.matchQIndex = state.ui.activeMatch.qIndex || 0;
                    }
                    state.ui.hasAnsweredCurrentQ = false;
                    updatePlayingUI();
                 }, 1500); 
             }
        }
        
        window.captureArenaInputAnswer = (value) => {};
        
        window.handleAnswerAttempt = async (isCorrect, mid, optionIndex) => {
             const match = state.ui.activeMatch;
             if (!match || match.status !== 'playing' || state.ui.hasAnsweredCurrentQ) return;
             
             state.ui.hasAnsweredCurrentQ = true;

             const btn = document.getElementById(`opt-btn-${optionIndex}`);
             if (btn) {
                 btn.disabled = true;
                 if (isCorrect) {
                     btn.classList.add('bg-green-500', 'text-white', 'scale-105', 'shadow-lg');
                 } else {
                     btn.classList.add('bg-red-500', 'text-white', 'scale-105', 'shadow-lg');
                     const correctBtn = document.getElementById(`opt-btn-${match.questions[match.qIndex].correct}`);
                     if (correctBtn) {
                          setTimeout(() => {
                            correctBtn.classList.add('bg-green-500', 'ring-2', 'ring-green-700');
                         }, 500);
                     }
                 }
             }

             const allBtns = document.getElementById('options-grid').querySelectorAll('button');
             allBtns.forEach(b => b.disabled = true);

             if (isCorrect) {
                 try {
                     await runTransaction(db, async (transaction) => {
                         const matchRef = doc(db, getPath('matches'), mid);
                         const matchDoc = await transaction.get(matchRef);

                         if (!matchDoc.exists) { throw "Match does not exist!"; }

                         const matchData = matchDoc.data();
                         const currentQIndex = matchData.qIndex || 0;
                         const questionsLength = matchData.questions.length;

                         if (currentQIndex === state.ui.matchQIndex) {
                             const isP1 = match.player1.uid === state.user.uid;
                             const newScore = (isP1 ? matchData.player1.score : matchData.player2.score) + 10;
                             const nextQIndex = currentQIndex + 1;
                             
                             const updateData = {};
                             updateData[isP1 ? "player1.score" : "player2.score"] = newScore;
                             
                             if (nextQIndex < questionsLength) {
                                 updateData.qIndex = nextQIndex;
                             } else {
                                 updateData.status = 'finished';
                             }
                             
                             transaction.update(matchRef, updateData);
                             
                             if (updateData.status === 'finished') {
                                 transaction.update(matchRef, {...updateData, winnerScore: newScore, finishedBy: state.user.uid});
                             }

                             state.ui.matchQIndex = nextQIndex;
                             updatePlayingUI();
                         }
                     });
                 } catch (e) {
                     console.error("Transaction failed:", e);
                 }

             } else {
                  setTimeout(() => {
                    if (state.ui.activeMatch) {
                        state.ui.matchQIndex = state.ui.activeMatch.qIndex || 0;
                    }
                    state.ui.hasAnsweredCurrentQ = false;
                    updatePlayingUI();
                 }, 1500); 
             }
         };

        const renderCompetition = () => {
            const mode = state.ui.competitionMode;
            const match = state.ui.activeMatch;
            switch(mode) {
                case 'create': return renderCompetitionCreate(); 
                case 'join': return renderCompetitionJoin();
                case 'waiting': return renderCompetitionWaiting(match);
                case 'playing': 
                    setTimeout(updatePlayingUI, 50);
                    return renderCompetitionPlaying(match);
                case 'lobby': default: return renderCompetitionLobby();
            }
        };
        
        // M·ªöI: RENDER MODAL AVATAR (Gi·ªØ nguy√™n)
        const renderAvatarModal = () => {
            const previewUrl = state.ui.tempAvatarUrl || (state.profile.avatarType === 'url' ? state.profile.avatarUrl : null);
            const previewEmoji = state.ui.tempAvatarType === 'emoji' ? state.ui.tempAvatarUrl : (state.profile.avatarType === 'emoji' ? state.profile.avatarUrl : null);
            
            // T·∫°o ƒë·ªëi t∆∞·ª£ng profile t·∫°m th·ªùi ƒë·ªÉ render preview
            const currentAvatar = { 
                name: state.profile.name,
                role: state.profile.role,
                avatarUrl: state.profile.name.charAt(0), // Default fallback
                avatarType: 'text'
            };
            
            // Logic ∆∞u ti√™n hi·ªÉn th·ªã: 1. Temp Emoji, 2. Temp URL, 3. Profile Emoji, 4. Profile URL
            if (state.ui.tempAvatarType === 'emoji' && state.ui.tempAvatarUrl) {
                currentAvatar.avatarUrl = state.ui.tempAvatarUrl;
                currentAvatar.avatarType = 'emoji';
            } else if (state.ui.tempAvatarType === 'url' && state.ui.tempAvatarUrl) {
                currentAvatar.avatarUrl = state.ui.tempAvatarUrl;
                currentAvatar.avatarType = 'url';
            } else if (state.profile.avatarType === 'emoji') {
                 currentAvatar.avatarUrl = state.profile.avatarUrl;
                 currentAvatar.avatarType = 'emoji';
            } else if (state.profile.avatarType === 'url') {
                 currentAvatar.avatarUrl = state.profile.avatarUrl;
                 currentAvatar.avatarType = 'url';
            }


            const emojiGrid = EMOJI_AVATARS.map(emoji => `
                <button onclick="selectEmojiAvatar('${emoji}')" 
                        class="p-3 text-2xl rounded-full hover:bg-slate-200 transition 
                        ${currentAvatar.avatarType === 'emoji' && currentAvatar.avatarUrl === emoji ? 'bg-blue-200 ring-2 ring-blue-500' : 'bg-slate-100'}">
                    ${emoji}
                </button>
            `).join('');

            return `
                <div class="fixed inset-0 bg-slate-900 bg-opacity-70 flex items-center justify-center z-50 fade-in p-4" onclick="if (event.target === this) toggleAvatarModal(false)">
                    <div class="bg-white p-6 md:p-8 rounded-2xl shadow-2xl w-full max-w-lg transform transition-all">
                        <div class="flex justify-between items-center mb-6 border-b pb-4">
                            <h3 class="text-xl md:text-2xl font-bold text-blue-700">Ch·ªânh s·ª≠a Avatar</h3>
                            <button onclick="toggleAvatarModal(false)" class="text-slate-500 hover:text-red-500"><i data-lucide="x"></i></button>
                        </div>
                        
                        <div class="flex flex-col items-center mb-6">
                            <div class="mb-4">
                                ${renderAvatar(currentAvatar, 'w-24 h-24', 'text-4xl')}
                            </div>
                            
                            <div class="w-full mb-4">
                                <label for="avatar-upload" class="block text-sm font-medium text-slate-700 mb-2">T·∫£i ·∫£nh l√™n (URL s·∫Ω hi·ªÉn th·ªã ·ªü tr√™n):</label>
                                <input type="file" id="avatar-upload" accept="image/*" onchange="handleImageUpload(event)" 
                                       class="w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
                                <p class="text-xs text-red-500 mt-2" id="upload-status"></p>
                            </div>
                        </div>

                        <div class="mb-6">
                            <h4 class="font-bold text-slate-700 mb-3">Ho·∫∑c ch·ªçn Emoji c√≥ s·∫µn:</h4>
                            <div class="grid grid-cols-6 gap-2 max-h-40 overflow-y-auto p-2 border rounded-xl bg-slate-50">
                                ${emojiGrid}
                            </div>
                        </div>

                        <button onclick="handleSaveAvatar()" class="w-full bg-green-600 text-white py-3 rounded-xl font-bold hover:bg-green-700 flex items-center justify-center gap-2 transition">
                            <i data-lucide="save" size="20"></i> L∆∞u Avatar
                        </button>
                    </div>
                </div>
            `;
        };

        // --- 7. HANDLERS (Assignments, Question Bank, Competition & CLASSES) ---
        
        // --- Avatar Handlers (Gi·ªØ nguy√™n) ---
        window.toggleAvatarModal = (val) => {
            state.ui.isAvatarModalOpen = val;
            if (val) {
                // Khi m·ªü modal, set tr·∫°ng th√°i t·∫°m th·ªùi t·ª´ profile hi·ªán t·∫°i
                state.ui.tempAvatarUrl = state.profile.avatarUrl;
                state.ui.tempAvatarType = state.profile.avatarType;
            } else {
                // Khi ƒë√≥ng modal, reset tr·∫°ng th√°i t·∫°m th·ªùi v√† input file
                state.ui.tempAvatarUrl = null;
                state.ui.tempAvatarType = null;
                
                const fileInput = document.getElementById('avatar-upload');
                if (fileInput) {
                    fileInput.value = '';
                }
                const statusEl = document.getElementById('upload-status');
                if(statusEl) statusEl.textContent = '';
            }
            // G·ªçi renderApp() ƒë·ªÉ render l·∫°i c·∫£ app v√† modal
            renderApp();
        };
        
        window.selectEmojiAvatar = (emoji) => {
            state.ui.tempAvatarUrl = emoji;
            state.ui.tempAvatarType = 'emoji';
            
            // TH√äM: Reset input file khi ch·ªçn emoji
            const fileInput = document.getElementById('avatar-upload');
            if (fileInput) {
                fileInput.value = '';
                document.getElementById('upload-status').textContent = '';
            }
            
            renderApp();
        };

        window.handleImageUpload = async (event) => {
            const file = event.target.files[0];
            if (!file) return;

            const statusEl = document.getElementById('upload-status');
            statusEl.textContent = 'ƒêang t·∫£i l√™n...';
            statusEl.classList.remove('text-green-600', 'text-red-500');
            statusEl.classList.add('text-blue-600');
            
            // TH√äM: X√≥a tr·∫°ng th√°i emoji t·∫°m th·ªùi khi b·∫Øt ƒë·∫ßu t·∫£i ·∫£nh
            state.ui.tempAvatarType = 'url';

            try {
                // T·∫°o tham chi·∫øu file trong Firebase Storage
                const avatarRef = storageRef(storage, `avatars/${state.user.uid}/${file.name}`);
                
                // T·∫£i file l√™n
                const snapshot = await uploadBytes(avatarRef, file);
                
                // L·∫•y URL c√¥ng khai
                const downloadURL = await getDownloadURL(snapshot.ref);
                
                state.ui.tempAvatarUrl = downloadURL;
                state.ui.tempAvatarType = 'url';
                
                statusEl.textContent = 'T·∫£i l√™n th√†nh c√¥ng!';
                statusEl.classList.remove('text-blue-600', 'text-red-500');
                statusEl.classList.add('text-green-600');
                
                renderApp();
                

            } catch (e) {
                console.error("L·ªói t·∫£i ·∫£nh l√™n:", e);
                statusEl.textContent = 'L·ªói t·∫£i ·∫£nh l√™n. Vui l√≤ng th·ª≠ l·∫°i.';
                statusEl.classList.remove('text-blue-600', 'text-green-600');
                statusEl.classList.add('text-red-500');
                
                // THAY ƒê·ªîI: Reset gi√° tr·ªã c·ªßa input ƒë·ªÉ cho ph√©p ch·ªçn l·∫°i file
                event.target.value = '';
                state.ui.tempAvatarUrl = null;
                state.ui.tempAvatarType = null;
                renderApp();
            }
        };

        window.handleSaveAvatar = async () => {
            const newAvatarUrl = state.ui.tempAvatarUrl;
            const newAvatarType = state.ui.tempAvatarType;

            // Ki·ªÉm tra xem c√≥ thay ƒë·ªïi n√†o kh√¥ng (d√π logic n√†y c≈©ng ƒë∆∞·ª£c x·ª≠ l√Ω b·ªüi Firestore)
            const isUnchanged = state.profile.avatarUrl === newAvatarUrl && state.profile.avatarType === newAvatarType;

            if (isUnchanged) {
                showToast("Kh√¥ng c√≥ thay ƒë·ªïi n√†o ƒë∆∞·ª£c l∆∞u.");
                toggleAvatarModal(false);
                return;
            }

            // Tr∆∞·ªùng h·ª£p ng∆∞·ªùi d√πng x√≥a ·∫£nh (ch·ªçn default)
            const isDefault = !newAvatarUrl;

            if (isDefault) {
                try {
                     await updateDoc(doc(db, getPath('users'), state.user.uid), {
                        avatarUrl: null,
                        avatarType: null,
                    });
                    showToast("ƒê√£ x√≥a avatar!");
                } catch (e) {
                     showToast("L·ªói x√≥a avatar.", "error");
                }
            } else {
                try {
                    await updateDoc(doc(db, getPath('users'), state.user.uid), {
                        avatarUrl: newAvatarUrl,
                        avatarType: newAvatarType,
                    });
                    showToast("ƒê√£ l∆∞u avatar th√†nh c√¥ng!");
                } catch (e) {
                    showToast("L·ªói l∆∞u avatar.", "error");
                    return;
                }
            }
            
            toggleAvatarModal(false);
        };
        
        // --- Student Class Handlers (M·ªöI) ---
        
        window.viewMyClassDetails = (id) => {
            state.ui.viewMyClassId = id;
            state.ui.isJoiningClass = false;
            renderApp();
        };

        window.toggleJoinClass = (val) => {
            state.ui.isJoiningClass = val;
            state.ui.viewMyClassId = null;
            renderApp();
        };

        window.handleJoinClass = async () => {
            const code = document.getElementById('join-class-code-input').value.trim().toUpperCase();
            if (code.length !== 6) return showToast("M√£ l·ªõp kh√¥ng h·ª£p l·ªá (6 k√Ω t·ª±)", "error");

            state.ui.isProcessingStudentCreation = true; // Use this existing flag for a loading state
            renderApp();

            try {
                // 1. T√¨m l·ªõp h·ªçc
                const classSnap = await getDocs(query(getRef('classes'), where('classCode', '==', code)));
                if (classSnap.empty) {
                    throw new Error("M√£ l·ªõp kh√¥ng t·ªìn t·∫°i.");
                }

                const classDoc = classSnap.docs[0];
                const classData = classDoc.data();
                const classId = classDoc.id;
                const studentUid = state.user.uid;

                // 2. Ki·ªÉm tra n·∫øu ƒë√£ tham gia
                if ((classData.studentIds || []).includes(studentUid)) {
                    throw new Error(`B·∫°n ƒë√£ l√† th√†nh vi√™n c·ªßa l·ªõp "${classData.title}".`);
                }

                // 3. C·∫≠p nh·∫≠t l·ªõp h·ªçc (th√™m studentId)
                await updateDoc(doc(db, getPath('classes'), classId), {
                    studentIds: arrayUnion(studentUid)
                });

                showToast(`Tham gia l·ªõp "${classData.title}" th√†nh c√¥ng!`);
                toggleJoinClass(false);
                viewMyClassDetails(classId); // Chuy·ªÉn sang xem chi ti·∫øt l·ªõp v·ª´a tham gia

            } catch(e) {
                console.error("L·ªói tham gia l·ªõp:", e);
                showToast(`L·ªói tham gia l·ªõp: ${e.message}`, "error");
            } finally {
                state.ui.isProcessingStudentCreation = false;
                renderApp();
            }
        };
        
        // --- Teacher Class Handlers (Gi·ªØ nguy√™n) ---
        window.toggleCreateClass = (val) => { state.ui.isCreatingClass = val; renderApp(); };
        window.viewClass = (id) => { 
            state.ui.viewClassId = id; 
            state.ui.isCreatingClass = false; 
            state.ui.viewClassMode = 'students'; // M·ªöI: Th√™m ch·∫ø ƒë·ªô xem m·∫∑c ƒë·ªãnh
            state.ui.isCreatingAssignment = false; // ƒê·∫£m b·∫£o tho√°t form t·∫°o b√†i t·∫≠p khi chuy·ªÉn l·ªõp
            state.ui.viewAssignmentId = null; // ƒê·∫£m b·∫£o tho√°t ch·∫ø ƒë·ªô xem/s·ª≠a b√†i t·∫≠p
            state.ui.selectedStatAssignmentId = null; // M·ªöI: Reset stat ID khi chuy·ªÉn l·ªõp
            renderApp(); 
        };
        window.setViewClassMode = (mode) => {
            state.ui.viewClassMode = mode;
            state.ui.viewAssignmentId = null;
            state.ui.isCreatingAssignment = false;
            // M·ªöI: Reset stat ID khi chuy·ªÉn tab, tr·ª´ khi chuy·ªÉn sang tab stats
            if (mode !== 'stats') {
                 state.ui.selectedStatAssignmentId = null; 
            }
            renderApp();
        };
        
        // --- M·ªöI: Handler cho Stats Detail View ---
        window.viewAssignmentStats = (assignmentId) => {
            state.ui.selectedStatAssignmentId = assignmentId;
            renderApp();
        }

        window.handleCreateClass = async () => {
            const title = document.getElementById('class-title').value.trim();
            if (!title) return showToast("Vui l√≤ng nh·∫≠p t√™n l·ªõp h·ªçc.", "error");
            
            const classCode = generateRoomCode();

            try {
                await addDoc(getRef('classes'), {
                    title,
                    teacherId: state.user.uid,
                    studentIds: [], 
                    classCode: classCode, 
                    createdAt: serverTimestamp()
                });
                toggleCreateClass(false);
                showToast("ƒê√£ t·∫°o l·ªõp h·ªçc th√†nh c√¥ng! M√£ l·ªõp l√†: " + classCode);
            } catch(e) {
                console.error("Firestore Error when creating class:", e);
                showToast("L·ªói t·∫°o l·ªõp h·ªçc.", "error");
            }
        };
        
        window.handleUpdateClassTitle = async (classId) => {
            const newTitle = document.getElementById('edit-class-title').value.trim();
            if (!newTitle) return showToast("T√™n l·ªõp kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng.", "error");
            
            try {
                await updateDoc(doc(db, getPath('classes'), classId), {
                    title: newTitle,
                    updatedAt: serverTimestamp()
                });
                showToast("ƒê√£ c·∫≠p nh·∫≠t t√™n l·ªõp h·ªçc!");
            } catch(e) {
                console.error("Firestore Error when updating class:", e);
                showToast("L·ªói c·∫≠p nh·∫≠t t√™n l·ªõp.", "error");
            }
        };

        window.confirmDeleteClass = (id, title) => {
            const confirmModal = document.createElement('div');
            confirmModal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
            confirmModal.innerHTML = `
                <div class="bg-white p-6 rounded-xl shadow-2xl max-w-sm w-full text-center">
                    <p class="font-bold text-lg mb-4 text-slate-800">X√°c nh·∫≠n x√≥a L·ªõp h·ªçc</p>
                    <p class="text-slate-600 mb-6 text-sm">B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a l·ªõp "${title}"? Thao t√°c n√†y s·∫Ω KH√îNG x√≥a t√†i kho·∫£n h·ªçc sinh, nh∆∞ng s·∫Ω lo·∫°i b·ªè l·ªõp n√†y.</p>
                    <div class="flex justify-around gap-4">
                        <button id="cancel-btn" class="flex-1 bg-slate-200 text-slate-700 py-2 rounded-lg font-medium hover:bg-slate-300 transition text-sm">H·ªßy</button>
                        <button id="delete-btn" class="flex-1 bg-red-600 text-white py-2 rounded-lg font-bold hover:bg-red-700 transition text-sm">X√°c nh·∫≠n X√ìA</button>
                    </div>
                </div>
            `;
            document.body.appendChild(confirmModal);

            const removeModal = () => document.body.removeChild(confirmModal);

            document.getElementById('cancel-btn').onclick = removeModal;
            document.getElementById('delete-btn').onclick = () => {
                deleteClass(id);
                removeModal();
            };
        };

        window.deleteClass = async (id) => {
            try {
                await deleteDoc(doc(db, getPath('classes'), id));
                showToast("ƒê√£ x√≥a l·ªõp h·ªçc th√†nh c√¥ng!");
                viewClass(null);
                renderApp();
            } catch (e) {
                console.error("Firestore Error when deleting class:", e);
                showToast(`L·ªói x√≥a l·ªõp: Ki·ªÉm tra quy·ªÅn truy c·∫≠p. Chi ti·∫øt: ${e.message}`, "error");
            }
        };
        
        window.confirmRemoveStudent = (classId, studentUid, studentName) => {
            const confirmModal = document.createElement('div');
            confirmModal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
            confirmModal.innerHTML = `
                <div class="bg-white p-6 rounded-xl shadow-2xl max-w-sm w-full text-center">
                    <p class="font-bold text-lg mb-4 text-slate-800">X√°c nh·∫≠n g·ª° H·ªçc sinh</p>
                    <p class="text-slate-600 mb-6 text-sm">B·∫°n c√≥ ch·∫Øc mu·ªën g·ª° "${studentName}" kh·ªèi l·ªõp? T√†i kho·∫£n c·ªßa h·ªçc sinh v·∫´n ƒë∆∞·ª£c gi·ªØ l·∫°i.</p>
                    <div class="flex justify-around gap-4">
                        <button id="cancel-btn" class="flex-1 bg-slate-200 text-slate-700 py-2 rounded-lg font-medium hover:bg-slate-300 transition text-sm">H·ªßy</button>
                        <button id="remove-btn" class="flex-1 bg-red-600 text-white py-2 rounded-lg font-bold hover:bg-red-700 transition text-sm">X√°c nh·∫≠n G·ª†</button>
                    </div>
                </div>
            `;
            document.body.appendChild(confirmModal);

            const removeModal = () => document.body.removeChild(confirmModal);

            document.getElementById('cancel-btn').onclick = removeModal;
            document.getElementById('remove-btn').onclick = () => {
                handleRemoveStudent(classId, studentUid, studentName);
                removeModal();
            };
        };

        window.handleRemoveStudent = async (classId, studentUid, studentName) => {
            try {
                await runTransaction(db, async (transaction) => {
                    const classRef = doc(db, getPath('classes'), classId);

                    transaction.update(classRef, {
                        studentIds: arrayRemove(studentUid)
                    });
                });
                showToast(`ƒê√£ g·ª° ${studentName} kh·ªèi l·ªõp!`);
            } catch(e) {
                console.error("Remove student error:", e);
                showToast("L·ªói g·ª° h·ªçc sinh.", "error");
            }
        };
        
        // --- Handlers Modal Nh·∫≠p d·ªØ li·ªáu (Gi·ªØ nguy√™n) ---
        
        // M·ªü/ƒë√≥ng modal nh·∫≠p li·ªáu
        window.toggleImportData = (val, fromBankForm = false) => {
            state.ui.isImportingBankData = val;
            // N·∫øu m·ªü modal t·ª´ trong form t·∫°o/s·ª≠a bank, reset importQType v√† gi·ªØ bankMode
            if (val && fromBankForm) {
                 state.ui.importQType = 'vocab_mcq'; 
            } 
            // N·∫øu m·ªü modal t·ª´ trang danh s√°ch, chuy·ªÉn sang ch·∫ø ƒë·ªô t·∫°o m·ªõi n·∫øu ch∆∞a c√≥
            else if (val && state.ui.bankMode === 'list') {
                 setBankMode('create');
            }
            renderApp();
        }

        window.setImportQType = (type) => { state.ui.importQType = type; renderApp(); };

        // H√†m x·ª≠ l√Ω vi·ªác ƒë·ªçc v√† ph√¢n t√≠ch file
        window.handleFileImport = () => {
            const fileInput = document.getElementById('file-upload');
            if (!fileInput.files.length) {
                return showToast("Vui l√≤ng ch·ªçn file .txt ƒë·ªÉ t·∫£i l√™n.", "error");
            }

            const file = fileInput.files[0];
            const reader = new FileReader();
            const qType = state.ui.importQType;

            reader.onload = (e) => {
                const text = e.target.result;
                const newQuestions = parseFileContent(text, qType);

                if (newQuestions.length > 0) {
                    state.ui.newAssignment.questions.push(...newQuestions);
                    showToast(`ƒê√£ th√™m th√†nh c√¥ng ${newQuestions.length} c√¢u h·ªèi m·ªõi!`);
                    toggleImportData(false); // ƒê√≥ng modal v√† render l·∫°i form
                } else {
                    showToast("File kh√¥ng c√≥ n·ªôi dung h·ª£p l·ªá ho·∫∑c sai ƒë·ªãnh d·∫°ng. Vui l√≤ng ki·ªÉm tra l·∫°i c·∫•u tr√∫c file TXT.", "error");
                }
            };

            reader.onerror = () => {
                showToast("L·ªói ƒë·ªçc file.", "error");
            };

            reader.readAsText(file);
        };
        
        // Logic ph√¢n t√≠ch c√∫ ph√°p file content
        const parseFileContent = (text, qType) => {
            const lines = text.split('\n').map(line => line.trim()).filter(line => line.length > 0);
            const newQuestions = [];

            lines.forEach(line => {
                try {
                    switch (qType) {
                        case 'vocab_mcq': // T·ª´ v·ª±ng|Pinyin|Nghƒ©a -> T·∫°o Tr·∫Øc nghi·ªám (ch·ªçn nghƒ©a, pinyin, t·ª´)
                        case 'listen_mcq': // T·ª´ v·ª±ng|Pinyin|Nghƒ©a -> T·∫°o Nghe (ch·ªçn nghƒ©a)
                            const parts_v = line.split('|');
                            if (parts_v.length < 3) throw new Error("Missing parts");
                            const [word, pinyin, meaning] = parts_v.map(p => p.trim());
                            
                            // L·∫•y danh s√°ch t·ª´ v·ª±ng hi·ªán c√≥ ƒë·ªÉ t·∫°o distractors
                            const vocabList = state.data.vocabulary;

                            // Helper ƒë·ªÉ l·∫•y 3 ƒë√°p √°n sai (distractors)
                            const getDistractors = (correctValue, field) => {
                                const distractors = [];
                                const candidates = shuffleArray([...vocabList]);
                                for (const item of candidates) {
                                    const value = item[field];
                                    if (value !== correctValue && distractors.length < 3 && !distractors.includes(value)) {
                                        distractors.push(value);
                                    }
                                    if (distractors.length === 3) break;
                                }
                                // ƒê·∫£m b·∫£o lu√¥n c√≥ 4 ƒë√°p √°n (c·∫£ ƒë√∫ng v√† sai)
                                while (distractors.length < 3) distractors.push(`[Distractor ${distractors.length + 1}]`);
                                return distractors;
                            };

                            // Lo·∫°i 1: Tr·∫Øc nghi·ªám - Ch·ªçn Nghƒ©a (cho T·ª´)
                            if (qType === 'vocab_mcq') {
                                const meaningDistractors = getDistractors(meaning, 'meaning');
                                const optionsM = shuffleArray([meaning, ...meaningDistractors]);
                                newQuestions.push({
                                    type: 'mcq',
                                    text: `Nghƒ©a c·ªßa t·ª´ **${word}** l√† g√¨?`,
                                    options: optionsM,
                                    correct: optionsM.indexOf(meaning)
                                });

                                // Lo·∫°i 1: Tr·∫Øc nghi·ªám - Ch·ªçn Pinyin (cho T·ª´)
                                const pinyinDistractors = getDistractors(pinyin, 'pinyin');
                                const optionsP = shuffleArray([pinyin, ...pinyinDistractors]);
                                newQuestions.push({
                                    type: 'mcq',
                                    text: `Pinyin c·ªßa t·ª´ **${word}** l√† g√¨?`,
                                    options: optionsP,
                                    correct: optionsP.indexOf(pinyin)
                                });
                            }


                            // Lo·∫°i 2: Nghe t·ª´ v√† ch·ªçn nghƒ©a
                            if (qType === 'listen_mcq') {
                                const meaningDistractors_L = getDistractors(meaning, 'meaning');
                                const optionsLM = shuffleArray([meaning, ...meaningDistractors_L]);
                                newQuestions.push({
                                    type: 'listen_mcq',
                                    audioText: word,
                                    text: `Nghe t·ª´ "**${word}**" v√† ch·ªçn nghƒ©a ƒë√∫ng:`,
                                    options: optionsLM,
                                    correct: optionsLM.indexOf(meaning)
                                });
                            }

                            break;

                        case 'fib': // C√¢u c√≥ |T·ª´ c·∫ßn ƒëi·ªÅn|
                            // T√¨m ki·∫øm t·ª´ c·∫ßn ƒëi·ªÅn n·∫±m gi·ªØa |...|
                            const match_fib = line.match(/\|([^|]+)\|/);
                            if (!match_fib) throw new Error("Missing | | markers");

                            const answer = match_fib[1].trim();
                            const text = line.replace(/\|[^|]+\|/, '[BLANK]').trim();
                            
                            if (!answer || !text) throw new Error("Invalid FIB structure");

                            newQuestions.push({
                                type: 'fib',
                                text: text,
                                answer: answer
                            });
                            break;

                        case 'jumble': // C√¢u ƒë√∫ng (c√°ch nhau b·∫±ng d·∫•u c√°ch)
                            const words = line.split(/\s+/).filter(w => w.length > 0);
                            if (words.length < 2) throw new Error("Sentence too short for Jumble");
                            
                            newQuestions.push({
                                type: 'jumble',
                                text: "S·∫Øp x·∫øp c√°c t·ª´ th√†nh c√¢u ƒë√∫ng:",
                                answer: words
                            });
                            break;

                        case 'translation': // C√¢u TC|C√¢u TV
                            const parts_t = line.split('|');
                            if (parts_t.length < 2) throw new Error("Missing | separator for Translation");
                            const [chinese_t, vietnamese_t] = parts_t.map(p => p.trim());
                            
                            newQuestions.push({
                                type: 'translation',
                                vietnamese: vietnamese_t,
                                chinese: chinese_t,
                                text: vietnamese_t // Text hi·ªÉn th·ªã l√† c√¢u ti·∫øng Vi·ªát c·∫ßn d·ªãch
                            });
                            break;

                        case 'listen_translate': // C√¢u TC|C√¢u TV (Nghe TC, d·ªãch TV)
                            const parts_lt = line.split('|');
                            if (parts_lt.length < 2) throw new Error("Missing | separator for Listen & Translate");
                            const [chinese_lt, vietnamese_lt] = parts_lt.map(p => p.trim());
                            
                            newQuestions.push({
                                type: 'listen_translate',
                                audioText: chinese_lt,
                                answer: vietnamese_lt,
                                text: "Nghe c√¢u ti·∫øng Trung v√† d·ªãch sang ti·∫øng Vi·ªát." 
                            });
                            break;

                        case 'listen_write': // C√¢u TC|C√¢u TV (Nghe TC, vi·∫øt l·∫°i TC)
                            const parts_lw = line.split('|');
                            if (parts_lw.length < 2) throw new Error("Missing | separator for Listen & Write");
                            const [chinese_lw, vietnamese_lw] = parts_lw.map(p => p.trim());
                            
                            newQuestions.push({
                                type: 'listen_write',
                                audioText: chinese_lw,
                                answer: chinese_lw, // ƒê√°p √°n l√† c√¢u ti·∫øng Trung
                                text: "Nghe c√¢u ti·∫øng Trung v√† vi·∫øt l·∫°i." 
                            });
                            break;
                    }
                } catch (error) {
                    console.warn(`B·ªè qua d√≤ng l·ªói (Lo·∫°i ${qType}): ${line} - ${error.message}`);
                }
            });

            return newQuestions;
        };

        // --- Handlers Ng√¢n h√†ng ƒë·ªÅ (Gi·ªØ nguy√™n) ---
        window.setBankMode = (mode, id = null) => {
            state.ui.bankMode = mode;
            state.ui.selectedBankId = id;
            if (mode === 'create' || mode === 'list') {
                state.ui.newAssignment = { title: '', questions: [], selectedClassIds: [] };
            }
            renderApp();
        };

        window.viewBankDetails = (id) => {
            state.ui.selectedBankId = id;
            state.ui.bankMode = id ? 'view' : 'list';
            if (id) {
                const bank = state.data.questionBanks.find(b => b.id === id);
                if (bank) {
                    state.ui.newAssignment = { ...bank, questions: JSON.parse(JSON.stringify(bank.questions)), selectedClassIds: [] };
                }
            } else {
                state.ui.newAssignment = { title: '', questions: [], selectedClassIds: [] }; 
            }
            renderApp();
        }

        window.publishQuestionBank = async () => {
            const title = document.getElementById('new-bank-title').value;
            if(!title || state.ui.newAssignment.questions.length === 0) return showToast("Vui l√≤ng nh·∫≠p ti√™u ƒë·ªÅ v√† th√™m √≠t nh·∫•t m·ªôt c√¢u h·ªèi", "error");
            
            try {
                await addDoc(getRef('question_banks'), {
                    title,
                    questions: state.ui.newAssignment.questions,
                    createdBy: state.user.uid,
                    createdAt: serverTimestamp()
                });
                setBankMode('list');
                showToast("ƒê√£ t·∫°o Ng√¢n h√†ng ƒë·ªÅ!");
            } catch(e) { 
                console.error("Firestore Error when publishing bank:", e);
                showToast("L·ªói t·∫°o Ng√¢n h√†ng ƒë·ªÅ: Vui l√≤ng ki·ªÉm tra quy·ªÅn truy c·∫≠p Firebase.", "error"); 
            }
        };
        
        window.saveBankChanges = async (id) => {
            const newTitle = document.getElementById('edit-bank-title').value;
            if(!newTitle || state.ui.newAssignment.questions.length === 0) return showToast("Vui l√≤ng nh·∫≠p ti√™u ƒë·ªÅ v√† th√™m √≠t nh·∫•t m·ªôt c√¢u h·ªèi", "error");

            try {
                const dataToUpdate = {
                    title: newTitle,
                    questions: state.ui.newAssignment.questions,
                    updatedAt: serverTimestamp()
                };

                await updateDoc(doc(db, getPath('question_banks'), id), dataToUpdate);
                viewBankDetails(null); 
                showToast("ƒê√£ l∆∞u thay ƒë·ªïi Ng√¢n h√†ng ƒë·ªÅ!");
            } catch(e) {
                console.error("Firestore Error when saving bank:", e);
                showToast(`L·ªói l∆∞u Ng√¢n h√†ng ƒë·ªÅ: Ki·ªÉm tra quy·ªÅn truy c·∫≠p. Chi ti·∫øt: ${e.message}`, "error");
            }
        };
        
        window.confirmDeleteBank = (id, title) => {
            const confirmModal = document.createElement('div');
            confirmModal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
            confirmModal.innerHTML = `
                <div class="bg-white p-6 rounded-xl shadow-2xl max-w-sm w-full text-center">
                    <p class="font-bold text-lg mb-4 text-slate-800">X√°c nh·∫≠n x√≥a Ng√¢n h√†ng ƒë·ªÅ</p>
                    <p class="text-slate-600 mb-6 text-sm">B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a Ng√¢n h√†ng ƒë·ªÅ "${title}"? Thao t√°c n√†y kh√¥ng th·ªÉ ho√†n t√°c.</p>
                    <div class="flex justify-around gap-4">
                        <button id="cancel-btn" class="flex-1 bg-slate-200 text-slate-700 py-2 rounded-lg font-medium hover:bg-slate-300 transition text-sm">H·ªßy</button>
                        <button id="delete-btn" class="flex-1 bg-red-600 text-white py-2 rounded-lg font-bold hover:bg-red-700 transition text-sm">X√°c nh·∫≠n X√ìA</button>
                    </div>
                </div>
            `;
            document.body.appendChild(confirmModal);

            const removeModal = () => document.body.removeChild(confirmModal);

            document.getElementById('cancel-btn').onclick = removeModal;
            document.getElementById('delete-btn').onclick = () => {
                deleteQuestionBank(id);
                removeModal();
            };
        };
        
        window.deleteQuestionBank = async (id) => {
            try {
                await deleteDoc(doc(db, getPath('question_banks'), id));
                showToast("ƒê√£ x√≥a Ng√¢n h√†ng ƒë·ªÅ th√†nh c√¥ng!");
                renderApp();
            } catch (e) {
                console.error("Firestore Error when deleting bank:", e);
                showToast(`L·ªói x√≥a Ng√¢n h√†ng ƒë·ªÅ: Ki·ªÉm tra quy·ªÅn truy c·∫≠p. Chi ti·∫øt: ${e.message}`, "error");
            }
        };

        // --- Handlers Th√™m c√¢u h·ªèi t·ª´ Bank v√†o Assignment (Gi·ªØ nguy√™n) ---

        window.setSelectingBankQuestions = (val) => {
            state.ui.isSelectingBankQuestions = val;
            state.ui.selectedBankId = null;
            renderApp();
        }

        window.selectBankToDraw = (bankId) => {
            state.ui.selectedBankId = bankId;
            renderApp();
        }
        
        window.selectQuestionFromBank = (qIdx) => {
            const selectedBank = state.data.questionBanks.find(b => b.id === state.ui.selectedBankId);
            if (!selectedBank) return;
            
            const questionToAdd = selectedBank.questions[qIdx];
            const currentIndex = state.ui.newAssignment.questions.findIndex(aq => JSON.stringify(aq) === JSON.stringify(questionToAdd));

            if (currentIndex === -1) {
                state.ui.newAssignment.questions.push(questionToAdd);
                showToast("ƒê√£ th√™m c√¢u h·ªèi!");
            } else {
                state.ui.newAssignment.questions.splice(currentIndex, 1);
                showToast("ƒê√£ x√≥a c√¢u h·ªèi kh·ªèi b√†i t·∫≠p!");
            }
            renderApp();
        }
        
        window.addRandomQuestions = (bankId) => {
            const count = parseInt(document.getElementById('random-count').value);
            const selectedBank = state.data.questionBanks.find(b => b.id === bankId);
            
            if (isNaN(count) || count <= 0) return showToast("Vui l√≤ng nh·∫≠p s·ªë l∆∞·ª£ng h·ª£p l·ªá.", "error");
            if (!selectedBank) return showToast("Kh√¥ng t√¨m th·∫•y ng√¢n h√†ng ƒë·ªÅ.", "error");
            
            const availableQuestions = selectedBank.questions;
            if (count > availableQuestions.length) return showToast("S·ªë l∆∞·ª£ng c√¢u h·ªèi y√™u c·∫ßu v∆∞·ª£t qu√° s·ªë l∆∞·ª£ng c√≥ s·∫µn.", "error");

            const newQuestionsCandidates = availableQuestions.filter(q => 
                !state.ui.newAssignment.questions.some(aq => JSON.stringify(aq) === JSON.stringify(q))
            );

            if (newQuestionsCandidates.length < count) {
                 state.ui.newAssignment.questions.push(...newQuestionsCandidates);
                 showToast(`ƒê√£ th√™m ${newQuestionsCandidates.length} c√¢u h·ªèi c√≤n l·∫°i!`);
            } else {
                 const randomSelection = shuffleArray([...newQuestionsCandidates]).slice(0, count);
                 state.ui.newAssignment.questions.push(...randomSelection);
                 showToast(`ƒê√£ th√™m ng·∫´u nhi√™n ${count} c√¢u h·ªèi!`);
            }
            
            setSelectingBankQuestions(false); 
        }


        // --- Assignment Handlers (Gi·ªØ nguy√™n) ---
        window.handleClassSelection = (classId, isChecked) => {
            const currentIds = state.ui.newAssignment.selectedClassIds;
            if (isChecked) {
                if (!currentIds.includes(classId)) {
                    state.ui.newAssignment.selectedClassIds = [...currentIds, classId];
                }
            } else {
                state.ui.newAssignment.selectedClassIds = currentIds.filter(id => id !== classId);
            }
            renderApp();
        }

        window.renderCompetitionCreate = () => `<div class="max-w-sm mx-auto bg-white p-6 md:p-8 rounded-2xl shadow-xl text-center fade-in">
                <h3 class="text-xl md:text-2xl font-bold text-slate-700 mb-6">T·∫°o ph√≤ng ƒë·∫•u m·ªõi</h3>
                <button onclick="createMatch()" class="w-full bg-green-600 hover:bg-green-700 text-white py-3 rounded-xl font-bold shadow-md transition">
                    T·∫°o Ph√≤ng Ngay (10 C√¢u h·ªèi)
                </button>
                <button onclick="setCompetitionMode('lobby')" class="mt-4 w-full text-slate-500 hover:text-slate-700 transition text-sm">Quay l·∫°i</button>
            </div>`; 

        window.changeQuestionType = (type) => { state.ui.newQuestionType = type; renderApp(); };
        
        // C·∫≠p nh·∫≠t toggleCreate ƒë·ªÉ ƒë·∫£m b·∫£o reset/gi·ªØ newAssignment title v√† classIds
        window.toggleCreate = (val) => {
            state.ui.isCreatingAssignment = val;
            state.ui.isSelectingBankQuestions = false;
            state.ui.selectedBankId = null;
            
            // N·∫øu tho√°t ch·∫ø ƒë·ªô t·∫°o, reset newAssignment
            if(!val) {
                state.ui.newAssignment = { title: '', questions: [], selectedClassIds: [] };
            } 
            // N·∫øu v√†o ch·∫ø ƒë·ªô t·∫°o (val=true), ƒë·∫£m b·∫£o newAssignment ƒë∆∞·ª£c gi·ªØ l·∫°i n·∫øu ƒë√£ set t·ª´ createClassAssignment,
            // ho·∫∑c ƒë∆∞·ª£c kh·ªüi t·∫°o n·∫øu v√†o t·ª´ tab Assignments
            else if (!state.ui.newAssignment || state.ui.newAssignment.questions.length === 0) {
                 state.ui.newAssignment = { title: '', questions: [], selectedClassIds: [] };
                 state.ui.newQuestionType = 'mcq';
            }
            renderApp();
        };

        window.createClassAssignment = (classId, classTitle) => {
            state.ui.isCreatingAssignment = true;
            state.ui.viewAssignmentId = null; // M·ªöI: Reset viewAssignmentId khi t·∫°o b√†i t·∫≠p
            // Set gi√° tr·ªã m·∫∑c ƒë·ªãnh cho title v√† classIds
            state.ui.newAssignment = { title: `B√†i t·∫≠p cho l·ªõp ${classTitle}`, questions: [], selectedClassIds: [classId] };
            state.ui.viewClassId = classId; // Gi·ªØ ng·ªØ c·∫£nh l·ªõp h·ªçc
            state.ui.newQuestionType = 'mcq';
            renderApp();
        };
        
        // C·∫≠p nh·∫≠t viewAssignmentDetails ƒë·ªÉ c√≥ th·ªÉ g·ªçi t·ª´ renderClassAssignments
        window.viewAssignmentDetailsInClass = (id) => {
            state.ui.isCreatingAssignment = false; 
            state.ui.takingAssignmentId = null;
            state.ui.viewSubmission = null;
            state.ui.isSelectingBankQuestions = false; 
            state.ui.viewAssignmentId = id;
            
            // Load data for editing
            if (id) {
                const assign = state.data.assignments.find(a => a.id === id);
                if (assign) {
                    state.ui.newAssignment = { 
                        ...assign, 
                        questions: JSON.parse(JSON.stringify(assign.questions)),
                        selectedClassIds: assign.classIds || []
                    };
                }
            } else {
                state.ui.newAssignment = { title: '', questions: [], selectedClassIds: [] }; 
            }
            renderApp();
        };
        // Gi·ªØ l·∫°i viewAssignmentDetails ban ƒë·∫ßu cho c√°c tab kh√°c
        window.viewAssignmentDetails = (id) => {
            state.ui.isCreatingAssignment = false; 
            state.ui.takingAssignmentId = null;
            state.ui.viewSubmission = null;
            state.ui.isSelectingBankQuestions = false; 

            state.ui.viewAssignmentId = id;
            if (id) {
                const assign = state.data.assignments.find(a => a.id === id);
                if (assign) {
                    state.ui.newAssignment = { 
                        ...assign, 
                        questions: JSON.parse(JSON.stringify(assign.questions)),
                        selectedClassIds: assign.classIds || []
                    };
                }
            } else {
                state.ui.newAssignment = { title: '', questions: [], selectedClassIds: [] }; 
            }
            renderApp();
        };
        

        window.removeQuestionInEdit = (qIdx) => {
            if (state.ui.newAssignment && state.ui.newAssignment.questions) {
                state.ui.newAssignment.questions.splice(qIdx, 1);
                renderApp();
            }
        };

        window.saveAssignmentChanges = async (id) => {
            const newTitle = document.getElementById('edit-assign-title').value;
            const timeLimit = parseInt(document.getElementById('edit-assign-time').value) || 0;
            const classIds = state.ui.newAssignment.selectedClassIds;
            
            if(!newTitle || state.ui.newAssignment.questions.length === 0 || classIds.length === 0) {
                 return showToast("Vui l√≤ng nh·∫≠p ti√™u ƒë·ªÅ, ch·ªçn √≠t nh·∫•t m·ªôt l·ªõp v√† th√™m √≠t nh·∫•t m·ªôt c√¢u h·ªèi", "error");
            }

            try {
                const dataToUpdate = {
                    title: newTitle,
	timeLimit,
                    questions: state.ui.newAssignment.questions,
                    classIds: classIds, 
                    updatedAt: serverTimestamp()
                };

                await updateDoc(doc(db, getPath('assignments'), id), dataToUpdate);
                
                // N·∫øu ƒëang ch·ªânh s·ª≠a t·ª´ ch·∫ø ƒë·ªô xem l·ªõp, quay l·∫°i ch·∫ø ƒë·ªô b√†i t·∫≠p c·ªßa l·ªõp ƒë√≥
                if (state.ui.viewClassId) {
                    // C·∫ßn reset viewAssignmentId c·ª•c b·ªô
                    state.ui.viewAssignmentId = null;
                    setViewClassMode('assignments');
                } else {
                    viewAssignmentDetails(null); 
                }

                showToast("ƒê√£ l∆∞u thay ƒë·ªïi b√†i t·∫≠p!");
            } catch(e) {
                console.error("Firestore Error when saving assignment:", e);
                showToast(`L·ªói l∆∞u b√†i: Ki·ªÉm tra quy·ªÅn truy c·∫≠p. Chi ti·∫øt: ${e.message}`, "error");
            }
        };
        
        window.confirmDeleteAssignment = (id, title) => {
            const confirmModal = document.createElement('div');
            confirmModal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
            confirmModal.innerHTML = `
                <div class="bg-white p-6 rounded-xl shadow-2xl max-w-sm w-full text-center">
                    <p class="font-bold text-lg mb-4 text-slate-800">X√°c nh·∫≠n x√≥a b√†i t·∫≠p</p>
                    <p class="text-slate-600 mb-6 text-sm">B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a b√†i t·∫≠p "${title}"? Thao t√°c n√†y kh√¥ng th·ªÉ ho√†n t√°c.</p>
                    <div class="flex justify-around gap-4">
                        <button id="cancel-btn" class="flex-1 bg-slate-200 text-slate-700 py-2 rounded-lg font-medium hover:bg-slate-300 transition text-sm">H·ªßy</button>
                        <button id="delete-btn" class="flex-1 bg-red-600 text-white py-2 rounded-lg font-bold hover:bg-red-700 transition text-sm">X√°c nh·∫≠n X√ìA</button>
                    </div>
                </div>
            `;
            document.body.appendChild(confirmModal);

            const removeModal = () => document.body.removeChild(confirmModal);

            document.getElementById('cancel-btn').onclick = removeModal;
            document.getElementById('delete-btn').onclick = () => {
                deleteAssignment(id);
                removeModal();
            };
        };

        window.deleteAssignment = async (id) => {
            try {
                await deleteDoc(doc(db, getPath('assignments'), id));
                showToast("ƒê√£ x√≥a b√†i t·∫≠p th√†nh c√¥ng!");
                renderApp();
            } catch (e) {
                console.error("Firestore Error when deleting assignment:", e);
                showToast(`L·ªói x√≥a b√†i: Ki·ªÉm tra quy·ªÅn truy c·∫≠p. Chi ti·∫øt: ${e.message}`, "error");
            }
        };


        window.addQuestion = () => {
            const type = state.ui.newQuestionType;
            let newQ = { type };
            let isValid = false;

            try {
                switch(type) {
                    case 'mcq':
                        const txt = document.getElementById('q-text').value;
                        const opts = [
                            document.getElementById('opt-0').value,
                            document.getElementById('opt-1').value,
                            document.getElementById('opt-2').value,
                            document.getElementById('opt-3').value
                        ];
                        const correct = parseInt(document.getElementById('q-correct').value);
                        if(!txt || opts.some(o => !o)) throw new Error("Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß n·ªôi dung c√¢u h·ªèi v√† 4 ƒë√°p √°n.");
                        newQ = { ...newQ, text: txt, options: opts, correct };
                        isValid = true;
                        document.getElementById('q-text').value = '';
                        opts.forEach((_, idx) => document.getElementById(`opt-${idx}`).value = '');
                        break;
                    case 'fib':
                        const fibText = document.getElementById('fib-text').value;
                        const fibAnswer = document.getElementById('fib-answer').value.trim();
                        if (!fibText.includes('[BLANK]')) throw new Error("N·ªôi dung c√¢u h·ªèi ph·∫£i c√≥ chu·ªói [BLANK] ƒë·ªÉ ƒëi·ªÅn t·ª´.");
                        if (!fibAnswer) throw new Error("Vui l√≤ng cung c·∫•p ƒë√°p √°n ƒë√∫ng.");
                        newQ = { ...newQ, text: fibText, answer: fibAnswer };
                        isValid = true;
                        document.getElementById('fib-text').value = '';
                        document.getElementById('fib-answer').value = '';
                        break;
                    case 'jumble':
                        const jumbleText = document.getElementById('jumble-answer').value.trim();
                        if (!jumbleText) throw new Error("Vui l√≤ng nh·∫≠p c√¢u ƒë√∫ng.");
                        const words = jumbleText.split(/\s+/).filter(w => w.length > 0);
                        if (words.length < 2) throw new Error("C√¢u ph·∫£i c√≥ √≠t nh·∫•t 2 t·ª´.");
                        newQ = { ...newQ, text: jumbleText, answer: words }; 
                        isValid = true;
                        document.getElementById('jumble-answer').value = '';
                        break;
                    case 'match':
                        const pairs = [];
                        for(let i=0; i<3; i++) {
                            const a = document.getElementById(`match-a${i}`).value.trim();
                            const b = document.getElementById(`match-b${i}`).value.trim();
                            if (!a || !b) throw new Error(`Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß C·∫∑p gh√©p n·ªëi ${i+1}.`);
                            pairs.push({ a, b });
                            document.getElementById(`match-a${i}`).value = '';
                            document.getElementById(`match-b${i}`).value = '';
                        }
                        newQ = { ...newQ, pairs, text: "Gh√©p ƒë√¥i c√°c m·ª•c sau:" };
                        isValid = true;
                        break;
                    case 'translation':
                        const vn = document.getElementById('trans-vn').value.trim();
                        const cn = document.getElementById('trans-cn').value.trim();
                        if (!vn || !cn) throw new Error("Vui l√≤ng nh·∫≠p c·∫£ c√¢u ti·∫øng Vi·ªát v√† c√¢u ti·∫øng Trung.");
                        newQ = { ...newQ, vietnamese: vn, chinese: cn, text: vn };
                        isValid = true;
                        document.getElementById('trans-vn').value = '';
                        document.getElementById('trans-cn').value = '';
                        break;
                        
                    case 'listen_mcq':
                        const lmcqAudio = document.getElementById('listen-mcq-audio').value.trim();
                        const lmcqOpts = [
                            document.getElementById('lmcq-opt-0').value,
                            document.getElementById('lmcq-opt-1').value,
                            document.getElementById('lmcq-opt-2').value,
                            document.getElementById('lmcq-opt-3').value
                        ];
                        const lmcqCorrect = parseInt(document.getElementById('lmcq-correct').value);
                        if(!lmcqAudio || lmcqOpts.some(o => !o)) throw new Error("Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß vƒÉn b·∫£n √¢m thanh v√† 4 ƒë√°p √°n nghƒ©a.");
                        newQ = { ...newQ, audioText: lmcqAudio, text: "Nghe √¢m thanh v√† ch·ªçn nghƒ©a ƒë√∫ng:", options: lmcqOpts, correct: lmcqCorrect };
                        isValid = true;
                        document.getElementById('listen-mcq-audio').value = '';
                        lmcqOpts.forEach((_, idx) => document.getElementById(`lmcq-opt-${idx}`).value = '');
                        break;
                    case 'listen_write':
                        const lwAudio = document.getElementById('listen-write-audio').value.trim();
                        const lwAnswer = document.getElementById('listen-write-answer').value.trim();
                        if (!lwAudio || !lwAnswer) throw new Error("Vui l√≤ng nh·∫≠p c√¢u ti·∫øng Trung c·∫ßn ph√°t √¢m v√† ƒë√°p √°n vi·∫øt l·∫°i.");
                        newQ = { ...newQ, audioText: lwAudio, answer: lwAnswer, text: "Nghe c√¢u v√† vi·∫øt l·∫°i." }; 
                        isValid = true;
                        document.getElementById('listen-write-audio').value = '';
                        document.getElementById('listen-write-answer').value = '';
                        break;
                    case 'listen_translate':
                        const ltAudio = document.getElementById('listen-trans-audio').value.trim();
                        const ltAnswer = document.getElementById('listen-trans-answer').value.trim();
                        if (!ltAudio || !ltAnswer) throw new Error("Vui l√≤ng nh·∫≠p c√¢u ti·∫øng Trung c·∫ßn ph√°t √¢m v√† ƒë√°p √°n d·ªãch ti·∫øng Vi·ªát.");
                        newQ = { ...newQ, audioText: ltAudio, answer: ltAnswer, text: "Nghe c√¢u v√† d·ªãch nghƒ©a sang ti·∫øng Vi·ªát." }; 
                        isValid = true;
                        document.getElementById('listen-trans-audio').value = '';
                        document.getElementById('listen-trans-answer').value = '';
                        break;
                }
            } catch (e) {
                return showToast(e.message, "error");
            }
            if (isValid) {
                state.ui.newAssignment.questions.push(newQ);
                renderApp(); 
            }
        };

        window.publishAssignment = async () => {
            const title = document.getElementById('new-assign-title').value;
            const timeLimit = parseInt(document.getElementById('new-assign-time').value) || 0;
            const classIds = state.ui.newAssignment.selectedClassIds;
            
            if(!title || state.ui.newAssignment.questions.length === 0 || classIds.length === 0) {
                 return showToast("Vui l√≤ng nh·∫≠p ti√™u ƒë·ªÅ, ch·ªçn √≠t nh·∫•t m·ªôt l·ªõp v√† th√™m √≠t nh·∫•t m·ªôt c√¢u h·ªèi", "error");
            }

            try {
                await addDoc(getRef('assignments'), {
                    title,
                    timeLimit,
                    questions: state.ui.newAssignment.questions,
                    classIds: classIds, 
                    createdBy: state.user.uid,
                    createdAt: serverTimestamp()
                });
                
                // N·∫øu ƒëang t·∫°o t·ª´ ng·ªØ c·∫£nh l·ªõp, quay l·∫°i ch·∫ø ƒë·ªô b√†i t·∫≠p c·ªßa l·ªõp ƒë√≥
                if (state.ui.viewClassId && classIds.includes(state.ui.viewClassId)) {
                    toggleCreate(false);
                    setViewClassMode('assignments'); 
                } else {
                    toggleCreate(false);
                }

                showToast("ƒê√£ xu·∫•t b·∫£n b√†i t·∫≠p!");
            } catch(e) { 
                console.error("Firestore Error when publishing assignment:", e);
                showToast("L·ªói t·∫°o b√†i: Vui l√≤ng ki·ªÉm tra quy·ªÅn truy c·∫≠p Firebase.", "error"); 
            }
        };

        // General Auth Handlers
        window.setAuthMode = (m) => { state.ui.authMode = m; renderApp(); };
        window.changeView = (v) => { 
            state.view = v; 
            if (state.ui.timerInterval) {
                clearInterval(state.ui.timerInterval);
                state.ui.timerInterval = null;
            }
            // Reset t·∫•t c·∫£ ch·∫ø ƒë·ªô xem/t·∫°o/l√†m b√†i/th·ªëng k√™
            state.ui.isCreatingAssignment = false;
            state.ui.takingAssignmentId = null;
            state.ui.viewAssignmentId = null;
            state.ui.viewSubmission = null;
            state.ui.isSelectingBankQuestions = false; 
            state.ui.bankMode = 'list'; 
            state.ui.selectedBankId = null;
            state.ui.viewClassId = null;
            state.ui.isCreatingClass = false;
            state.ui.isManagingStudent = false;
            state.ui.viewClassMode = 'students'; // Reset Class mode
            state.ui.isImportingBankData = false; // Reset Import Data modal
            state.ui.isAvatarModalOpen = false; // M·ªöI: Reset Avatar modal
            state.ui.selectedStatAssignmentId = null; // M·ªöI: Reset stat detail view
            
            // TH√äM: Reset Student Class View states
            state.ui.viewMyClassId = null;
            state.ui.isJoiningClass = false;
            
            // M·ªöI: ƒê√≥ng Sidebar tr√™n mobile khi chuy·ªÉn view
            if (window.innerWidth < 1024) {
                 state.ui.isSidebarOpen = false;
            }

            if(v!=='competition') { state.ui.competitionMode='lobby'; state.ui.activeMatch=null; }
            if(v==='competition') loadVocabulary();
            renderApp(); 
        };
        window.setCompetitionMode = (m) => { state.ui.competitionMode = m; renderApp(); };
        window.handleLogin = async (e) => { e.preventDefault(); const email=document.getElementById('login-email').value; const pass=document.getElementById('login-password').value; await signInWithEmailAndPassword(auth,email,pass).catch(e=>showToast("L·ªói ƒëƒÉng nh·∫≠p: Vui l√≤ng ki·ªÉm tra Email/M·∫≠t kh·∫©u.",'error')); };
        window.handleRegister = async (e) => { 
            e.preventDefault(); 
            const email=document.getElementById('join-email').value; 
            const pass=document.getElementById('join-password').value; 
            const name=document.getElementById('join-name').value;
            const role = document.querySelector('input[name="role"]:checked').value;
            
            const classCode = role === 'student' ? document.getElementById('class-code-input').value.trim().toUpperCase() : null;

            if (role === 'teacher' && document.getElementById('teacher-code').value !== TEACHER_CODE) return showToast("Sai m√£ gi√°o vi√™n", "error");

            try {
                const cred = await createUserWithEmailAndPassword(auth,email,pass);
                const uid = cred.user.uid;

                let classIdToJoin = null;
                let classTitle = '';

                if (role === 'student' && classCode) {
                    const classSnap = await getDocs(query(getRef('classes'), where('classCode', '==', classCode)));
                    if (!classSnap.empty) {
                        const classDoc = classSnap.docs[0];
                        classIdToJoin = classDoc.id;
                        classTitle = classDoc.data().title;
                    } else {
                        showToast("M√£ l·ªõp kh√¥ng t·ªìn t·∫°i. Ti·∫øp t·ª•c ƒëƒÉng k√Ω m√† kh√¥ng v√†o l·ªõp.", "error");
                    }
                }

                await setDoc(doc(db,getPath('users'),uid),{
                    uid: uid,
                    name: name,
                    role: role,
                    points: 0,
                    email: email,
                    // TH√äM: Avatar m·∫∑c ƒë·ªãnh
                    avatarUrl: null, 
                    avatarType: null,
                    createdAt: serverTimestamp()
                });
                
                if (classIdToJoin) {
                    await updateDoc(doc(db, getPath('classes'), classIdToJoin), {
                        studentIds: arrayUnion(uid)
                    });
                    showToast(`ƒêƒÉng k√Ω th√†nh c√¥ng! B·∫°n ƒë√£ tham gia l·ªõp "${classTitle}"`, "success");
                } else {
                    showToast("ƒêƒÉng k√Ω th√†nh c√¥ng!", "success");
                }

            } catch(e) { 
                showToast(`L·ªói ƒëƒÉng k√Ω: ${e.code ? e.code.replace('auth/', '') : e.message}`, 'error'); 
            }
        };
        window.handleSignOut = async () => { await signOut(auth); window.location.reload(); };

        // Competition Handlers
        window.createMatch = async () => {
            if(state.data.vocabulary.length<4) await loadVocabulary();
            const questions = generateArenaQuestions();
            if (questions.length === 0) return;
            const roomCode = generateRoomCode();
            await addDoc(getRef('matches'), { roomCode, player1:{uid:state.user.uid,name:state.profile.name,score:0}, player2:null, status:'waiting', questions, qIndex: 0, createdAt: serverTimestamp() });
            state.ui.competitionMode='waiting'; showToast(`T·∫°o ph√≤ng ${roomCode}`);
        };

        window.joinMatch = async () => {
            const code = document.getElementById('room-code-input').value.trim().toUpperCase();
            if (code.length !== 6) return showToast("M√£ ph√≤ng kh√¥ng h·ª£p l·ªá", "error");
            const snap = await getDocs(query(getRef('matches'), where('roomCode','==',code), where('status','==','waiting')));
            if(snap.empty) return showToast("Ph√≤ng kh√¥ng t·ªìn t·∫°i ho·∫∑c ƒë√£ ƒë·∫ßy", "error");
            const docRef = snap.docs[0];
            if(docRef.data().player1.uid===state.user.uid) return showToast("B·∫°n ƒë√£ ·ªü trong ph√≤ng n√†y");
            await updateDoc(doc(db,getPath('matches'),docRef.id), { player2:{uid:state.user.uid,name:state.profile.name,score:0} });
            state.ui.competitionMode='waiting'; showToast("ƒê√£ tham gia ph√≤ng!");
        };

        window.startMatch = async (mid) => updateDoc(doc(db,getPath('matches'),mid), {status:'playing', startTime: serverTimestamp()});
        window.leaveMatch = async (mid) => { deleteDoc(doc(db,getPath('matches'),mid)); state.ui.activeMatch=null; state.ui.competitionMode='lobby'; renderApp(); };


        // --- C√ÅC H√ÄM ƒêI·ªÄU H∆Ø·ªöNG B√ÄI L√ÄM (FIX SCROLL JUMP) ---
        window.goToNextQuestion = () => {
            const assign = state.data.assignments.find(a => a.id === state.ui.takingAssignmentId);
            if (!assign) return;

            const totalQuestions = assign.questions.length;
            if (state.ui.currentQuestionIndex < totalQuestions - 1) {
                state.ui.currentQuestionIndex++;
                // C·∫≠p nh·∫≠t UI c·ª•c b·ªô
                updateAssignmentQuestionUI(assign, state.ui.currentQuestionIndex);
            }
        };

        window.goToPreviousQuestion = () => {
            const assign = state.data.assignments.find(a => a.id === state.ui.takingAssignmentId);
            if (!assign) return;

            if (state.ui.currentQuestionIndex > 0) {
                state.ui.currentQuestionIndex--;
                // C·∫≠p nh·∫≠t UI c·ª•c b·ªô
                updateAssignmentQuestionUI(assign, state.ui.currentQuestionIndex);
            }
        };
        // -----------------------------

        window.startAssignment = (id) => {
            state.ui.takingAssignmentId = id;
            state.ui.assignmentAnswers = {};
            state.ui.currentQuestionIndex = 0; 
            state.ui.viewSubmission = null; 
           // TH√äM: K√≠ch ho·∫°t ƒë·ªìng h·ªì n·∫øu b√†i t·∫≠p c√≥ gi·ªõi h·∫°n th·ªùi gian
            const assign = state.data.assignments.find(a => a.id === id);
            if (assign && assign.timeLimit) {
                // G·ªçi h√†m ƒë·∫øm ng∆∞·ª£c
                window.runTimer(assign.timeLimit);
            } else {
                // N·∫øu kh√¥ng c√≥ th·ªùi gian, x√≥a timer c≈© ƒëi cho an to√†n
                if (state.ui.timerInterval) clearInterval(state.ui.timerInterval);
            }
            renderApp();
        };
        
        window.viewSubmissionResult = (subId) => {
            if (subId) {
                const sub = state.data.submissions.find(s => s.id === subId);
                const assign = state.data.assignments.find(a => a.id === sub.assignmentId);

                if (sub && assign) {
                    const questionsForReview = assign.questions.map((q, qIdx) => {
                         const subQData = sub.questionData?.[qIdx] || {};
                         let newQ = { ...q };
                         
                         if (q.type === 'jumble' && subQData.shuffledWords) {
                            newQ.shuffledWords = subQData.shuffledWords;
                         } else if (q.type === 'match' && subQData.shuffledColB) {
                            newQ.shuffledColB = subQData.shuffledColB;
                         }
                         
                        return newQ;
                    });

                    state.ui.viewSubmission = {
                        id: subId,
                        assignmentId: assign.id,
                        studentId: state.user.uid,
                        score: sub.score,
                        answers: sub.answers,
                        questionData: sub.questionData, 
                        createdAt: sub.createdAt,
                        assignment: { ...assign, questions: questionsForReview }
                    };

                    state.ui.takingAssignmentId = null; 
                    renderApp();
                } else {
                    showToast("Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu b√†i n·ªôp ho·∫∑c b√†i t·∫≠p.", "error");
                }
            } else {
                state.ui.viewSubmission = null;
                renderApp();
            }
        }


        // FIX SCROLL JUMP: C·∫≠p nh·∫≠t UI c·ª•c b·ªô
        window.selectAnswer = (qIdx, oIdx) => { 
            state.ui.assignmentAnswers[qIdx] = oIdx; 
            
            const assign = state.data.assignments.find(a => a.id === state.ui.takingAssignmentId);
            if (assign) {
                document.getElementById('assignment-question-content').innerHTML = renderTakeAssignmentQuestion(assign.questions[qIdx], qIdx);
                renderIcons();
            }
        };
        
        window.captureInputAnswer = (qIdx, value) => { state.ui.assignmentAnswers[qIdx] = value; };
        window.getJumbleAnswer = (qIdx) => { return state.ui.assignmentAnswers[qIdx] || []; };
        
        // FIX SCROLL JUMP: C·∫≠p nh·∫≠t UI c·ª•c b·ªô
        window.addJumbleWord = (qIdx, word) => { 
            const currentOrder = window.getJumbleAnswer(qIdx); 
            state.ui.assignmentAnswers[qIdx] = [...currentOrder, word]; 
            
            const assign = state.data.assignments.find(a => a.id === state.ui.takingAssignmentId);
            if (assign) {
                document.getElementById('assignment-question-content').innerHTML = renderTakeAssignmentQuestion(assign.questions[qIdx], qIdx);
                renderIcons();
            }
        };
        
        // FIX SCROLL JUMP: C·∫≠p nh·∫≠t UI c·ª•c b·ªô
        window.removeJumbleWord = (qIdx, wordToRemove, wIdx) => { 
            const currentOrder = window.getJumbleAnswer(qIdx); 
            currentOrder.splice(wIdx, 1); 
            state.ui.assignmentAnswers[qIdx] = currentOrder; 
            
            const assign = state.data.assignments.find(a => a.id === state.ui.takingAssignmentId);
            if (assign) {
                document.getElementById('assignment-question-content').innerHTML = renderTakeAssignmentQuestion(assign.questions[qIdx], qIdx);
                renderIcons();
            }
        };
        
        // FIX SCROLL JUMP: C·∫≠p nh·∫≠t UI c·ª•c b·ªô
        window.selectMatchAnswer = (qIdx, aIdx, bIdxValue) => {
            const currentMatches = state.ui.assignmentAnswers[qIdx] || {};
            
            if (bIdxValue === "") { delete currentMatches[aIdx]; } else {
                const bIdx = parseInt(bIdxValue);
                for (const key in currentMatches) {
                    if (currentMatches[key] === bIdx && parseInt(key) !== aIdx) { delete currentMatches[key]; }
                }
                currentMatches[aIdx] = bIdx;
            }
            state.ui.assignmentAnswers[qIdx] = {...currentMatches};
            
            const assign = state.data.assignments.find(a => a.id === state.ui.takingAssignmentId);
            if (assign) {
                document.getElementById('assignment-question-content').innerHTML = renderTakeAssignmentQuestion(assign.questions[qIdx], qIdx);
                renderIcons();
            }
        };

// H√†m h·ªó tr·ª£ Copy (Th√™m m·ªõi)
        window.copyToClipboard = (text, label = 'N·ªôi dung') => {
            if (navigator.clipboard && window.isSecureContext) {
                navigator.clipboard.writeText(text).then(() => {
                    showToast(`ƒê√£ sao ch√©p ${label}: ${text}`);
                });
            } else {
                // Fallback cho m·ªôt s·ªë tr√¨nh duy·ªát c≈© ho·∫∑c kh√¥ng b·∫£o m·∫≠t
                showToast(`M√£ l·ªõp: ${text} (H√£y copy th·ªß c√¥ng)`);
            }
        };
        window.submitAssignment = async () => {
            const assign = state.data.assignments.find(a => a.id === state.ui.takingAssignmentId);
            let score = 0;
            const totalQuestions = assign.questions.length;
            const scorePerQuestion = 100 / totalQuestions;
            const questionDataToSave = {}; 
            
            assign.questions.forEach((q, idx) => {
                const userAnswer = state.ui.assignmentAnswers[idx];
                let isCorrect = false;
                
                let shuffledColB = null;
                let shuffledWords = null;

                if (q.type === 'match' && q.shuffledColB) {
                    shuffledColB = q.shuffledColB;
                    questionDataToSave[idx] = { shuffledColB: shuffledColB };
                } else if (q.type === 'jumble' && q.shuffledWords) {
                    shuffledWords = q.shuffledWords;
                    questionDataToSave[idx] = { shuffledWords: shuffledWords };
                }

                switch(q.type) {
                    case 'mcq':
                    case 'listen_mcq': 
                        isCorrect = userAnswer === q.correct;
                        break;
                    case 'fib':
                    case 'translation':
                    case 'listen_write': 
                    case 'listen_translate': 
                        if (userAnswer) {
                            let expectedAnswer;
                            if (q.type === 'translation') expectedAnswer = q.chinese;
                            else expectedAnswer = q.answer; 
                            
                            isCorrect = userAnswer.trim().toLowerCase() === expectedAnswer.trim().toLowerCase();
                        }
                        break;
                    case 'jumble':
                        if (Array.isArray(userAnswer)) {
                            isCorrect = q.answer.join(' ') === userAnswer.join(' ');
                        }
                        break;
                    case 'match':
                        if (userAnswer) {
                             const userMatches = userAnswer;
                             const colBToUse = shuffledColB || q.pairs.map(p => p.b).sort(() => Math.random() - 0.5); 
                             const numCorrectMatches = q.pairs.reduce((count, p, aIdx) => {
                                 const selectedBIndex = userMatches[aIdx];
                                 const selectedB = colBToUse[selectedBIndex]; 
                                 return count + (selectedB && selectedB === p.b ? 1 : 0);
                             }, 0);
                             isCorrect = numCorrectMatches === q.pairs.length;
                        }
                        break;
                }
                
                if (isCorrect) score += scorePerQuestion; 
            });

            score = Math.round(score);
           if (state.ui.timerInterval) {
                clearInterval(state.ui.timerInterval);
                state.ui.timerInterval = null;
            }
            try {
                const subRef = await addDoc(getRef('submissions'), {
                    assignmentId: assign.id,
                    studentId: state.user.uid,
                    score,
                    answers: state.ui.assignmentAnswers,
                    questionData: questionDataToSave, 
                    createdAt: serverTimestamp()
                });
                await updateDoc(doc(db, getPath('users'), state.user.uid), {
                    points: (state.profile.points || 0) + score
                });
                
                state.ui.viewSubmission = {
                    id: subRef.id,
                    assignmentId: assign.id,
                    studentId: state.user.uid,
                    score,
                    answers: state.ui.assignmentAnswers,
                    questionData: questionDataToSave, 
                    createdAt: new Date(),
                    assignment: assign 
                };

                state.ui.takingAssignmentId = null;
                showToast(`N·ªôp b√†i th√†nh c√¥ng! +${score} ƒëi·ªÉm`);
                renderApp(); 
            } catch(e) { 
                console.error("L·ªói n·ªôp b√†i:", e);
                showToast("L·ªói n·ªôp b√†i", "error"); 
            }
        };

        // Bootstrap
        onAuthStateChanged(auth, (u) => {
            if (state.ui.isBulkCreating) return;
            state.user = u; state.isAuthReady = true;
            if(u) setupListeners(u.uid);
            else { state.profile = null; state.ui.authMode = 'login'; renderApp(); }
        });
// --- LOGIC ƒê·ªíNG H·ªí ƒê·∫æM NG∆Ø·ª¢C ---
        window.runTimer = (durationMinutes) => {
            if (!durationMinutes || durationMinutes <= 0) return;

            let secondsLeft = durationMinutes * 60;
            
            // X√≥a timer c≈© n·∫øu c√≥ ƒë·ªÉ tr√°nh ch·∫°y ch·ªìng ch√©o
            if (state.ui.timerInterval) clearInterval(state.ui.timerInterval);

            state.ui.timerInterval = setInterval(() => {
                secondsLeft--;

                // C·∫≠p nh·∫≠t giao di·ªán (T√¨m th·∫ª hi·ªÉn th·ªã th·ªùi gian)
                const timerDisplay = document.getElementById('assignment-timer-display');
                if (timerDisplay) {
                    const m = Math.floor(secondsLeft / 60);
                    const s = secondsLeft % 60;
                    // Format mm:ss (V√≠ d·ª•: 04:09)
                    timerDisplay.textContent = `${m < 10 ? '0' : ''}${m}:${s < 10 ? '0' : ''}${s}`;
                    
                    // ƒê·ªïi m√†u ƒë·ªè khi c√≤n d∆∞·ªõi 1 ph√∫t
                    if (secondsLeft < 60) {
                        timerDisplay.classList.add('text-red-600', 'animate-pulse');
                        timerDisplay.classList.remove('text-slate-700');
                    }
                }

                // H·∫øt gi·ªù
                if (secondsLeft <= 0) {
                    clearInterval(state.ui.timerInterval);
                    showToast("H·∫øt gi·ªù l√†m b√†i! H·ªá th·ªëng ƒëang t·ª± ƒë·ªông n·ªôp...", "error");
                    submitAssignment(); // T·ª± ƒë·ªông n·ªôp b√†i
                }
            }, 1000);
        };
// --- TI·ªÜN √çCH: X√≥a d·∫•u Ti·∫øng Vi·ªát ƒë·ªÉ t·∫°o Email ---
        window.removeVietnameseTones = (str) => {
            str = str.replace(/√†|√°|·∫°|·∫£|√£|√¢|·∫ß|·∫•|·∫≠|·∫©|·∫´|ƒÉ|·∫±|·∫Ø|·∫∑|·∫≥|·∫µ/g,"a"); 
            str = str.replace(/√®|√©|·∫π|·∫ª|·∫Ω|√™|·ªÅ|·∫ø|·ªá|·ªÉ|·ªÖ/g,"e"); 
            str = str.replace(/√¨|√≠|·ªã|·ªâ|ƒ©/g,"i"); 
            str = str.replace(/√≤|√≥|·ªç|·ªè|√µ|√¥|·ªì|·ªë|·ªô|·ªï|·ªó|∆°|·ªù|·ªõ|·ª£|·ªü|·ª°/g,"o"); 
            str = str.replace(/√π|√∫|·ª•|·ªß|≈©|∆∞|·ª´|·ª©|·ª±|·ª≠|·ªØ/g,"u"); 
            str = str.replace(/·ª≥|√Ω|·ªµ|·ª∑|·ªπ/g,"y"); 
            str = str.replace(/ƒë/g,"d");
            str = str.replace(/√Ä|√Å|·∫†|·∫¢|√É|√Ç|·∫¶|·∫§|·∫¨|·∫®|·∫™|ƒÇ|·∫∞|·∫Æ|·∫∂|·∫≤|·∫¥/g, "A");
            str = str.replace(/√à|√â|·∫∏|·∫∫|·∫º|√ä|·ªÄ|·∫æ|·ªÜ|·ªÇ|·ªÑ/g, "E");
            str = str.replace(/√å|√ç|·ªä|·ªà|ƒ®/g, "I");
            str = str.replace(/√í|√ì|·ªå|·ªé|√ï|√î|·ªí|·ªê|·ªò|·ªî|·ªñ|∆†|·ªú|·ªö|·ª¢|·ªû|·ª†/g, "O");
            str = str.replace(/√ô|√ö|·ª§|·ª¶|≈®|∆Ø|·ª™|·ª®|·ª∞|·ª¨|·ªÆ/g, "U");
            str = str.replace(/·ª≤|√ù|·ª¥|·ª∂|·ª∏/g, "Y");
            str = str.replace(/ƒê/g, "D");
            // X√≥a k√Ω t·ª± ƒë·∫∑c bi·ªát v√† kho·∫£ng tr·∫Øng d∆∞ th·ª´a
            str = str.replace(/!|@|%|\^|\*|\(|\)|\+|\=|\<|\>|\?|\/|,|\.|\:|\;|\'|\"|\&|\#|\[|\]|~|\$|_|`|-|{|}|\||\\/g," ");
            str = str.replace(/ + /g," ");
            str = str.trim(); 
            return str.toLowerCase().replace(/\s/g, ''); // Chuy·ªÉn th√†nh ch·ªØ th∆∞·ªùng v√† x√≥a h·∫øt kho·∫£ng tr·∫Øng
        };
        window.toggleBulkModal = (val) => {
            state.ui.isBulkModalOpen = val;
            renderApp();
        };
window.handleBulkCreate = async () => {
            const teacherCode = document.getElementById('bulk-teacher-code').value.trim();
            const globalPassword = document.getElementById('bulk-password').value.trim(); // ƒê·ªïi t√™n bi·∫øn cho r√µ
            const statusEl = document.getElementById('bulk-status');
            
            // 1. Validate
            if (teacherCode !== 'ruands10') return showToast("M√£ gi√°o vi√™n kh√¥ng ƒë√∫ng!", "error");
            if (globalPassword.length < 6) return showToast("M·∫≠t kh·∫©u chung ph·∫£i t·ª´ 6 k√Ω t·ª± tr·ªü l√™n", "error");

            // 2. L·∫•y d·ªØ li·ªáu
            let studentsToCreate = [];
            let targetClassCode = '';
            let targetClassName = '';

            const csvFile = document.getElementById('bulk-csv-file').files[0];
            
            if (csvFile) {
                // --- X·ª¨ L√ù CSV N√ÇNG C·∫§P (Kh·ªõp v·ªõi file t·∫£i v·ªÅ) ---
                const text = await csvFile.text();
                const rows = text.split('\n').slice(1); // B·ªè header
                
                rows.forEach(row => {
                    // T√°ch b·∫±ng d·∫•u ph·∫©y, nh∆∞ng c·∫©n th·∫≠n x·ª≠ l√Ω d·∫•u ngo·∫∑c k√©p n·∫øu c√≥
                    // ƒê∆°n gi·∫£n h√≥a: X√≥a h·∫øt d·∫•u " tr∆∞·ªõc khi split
                    const cleanRow = row.replace(/"/g, ''); 
                    const cols = cleanRow.split(',');
                    
                    if (cols.length >= 1 && cols[0].trim()) {
                        studentsToCreate.push({
                            name: cols[0]?.trim(),
                            email: cols[1]?.trim(),
                            classCode: cols[2]?.trim(),
                            className: cols[3]?.trim(),
                            password: cols[4]?.trim() // L·∫•y m·∫≠t kh·∫©u ri√™ng t·ª´ CSV
                        });
                    }
                });
            } else {
                // ... (Logic nh·∫≠p tay Textarea gi·ªØ nguy√™n nh∆∞ c≈©) ...
                const rawNames = document.getElementById('bulk-student-list').value;
                targetClassName = document.getElementById('bulk-class-name').value.trim();
                targetClassCode = document.getElementById('bulk-class-code').value.trim().toUpperCase();

                if (!rawNames || !targetClassName || !targetClassCode) {
                    return showToast("Vui l√≤ng nh·∫≠p ƒë·ªß T√™n l·ªõp, M√£ l·ªõp v√† Danh s√°ch t√™n.", "error");
                }

                const names = rawNames.split('\n').filter(n => n.trim().length > 0);
                studentsToCreate = names.map(name => {
                    const cleanName = removeVietnameseTones(name);
                    const cleanClass = removeVietnameseTones(targetClassName); 
                    const autoEmail = `${cleanName}_${cleanClass}@gmail.com`;
                    return { name: name.trim(), email: autoEmail };
                });
            }

            if (studentsToCreate.length === 0) return showToast("Kh√¥ng t√¨m th·∫•y h·ªçc sinh n√†o ƒë·ªÉ t·∫°o.", "error");

            // 3. B·∫ÆT ƒê·∫¶U QUY TR√åNH
            state.ui.isBulkCreating = true; 
            statusEl.classList.remove('text-red-500');
            statusEl.classList.add('text-blue-600');

            let successCount = 0;
            let classErrorCount = 0;
            let successList = []; 

            try {
                for (const st of studentsToCreate) {
                    if (!st.name) continue;
                    statusEl.textContent = `ƒêang x·ª≠ l√Ω: ${st.name}...`;

                    // ∆ØU TI√äN: M·∫≠t kh·∫©u ri√™ng trong CSV > M·∫≠t kh·∫©u chung
                    const userPassword = (st.password && st.password.length >=6) ? st.password : globalPassword;

                    try {
                        // A. T·∫°o & Login
                        const cred = await createUserWithEmailAndPassword(auth, st.email, userPassword);
                        const uid = cred.user.uid;

                        // B. Ghi Profile
                        await setDoc(doc(db, getPath('users'), uid), {
                            uid: uid,
                            name: st.name,
                            email: st.email,
                            role: 'student',
                            points: 0,
                            avatarUrl: null,
                            avatarType: null,
                            createdAt: serverTimestamp()
                        });

                        // C. X·ª≠ l√Ω L·ªõp h·ªçc
                        const currentClassCode = st.classCode || targetClassCode;
                        const currentClassName = st.className || targetClassName;

                        if (currentClassCode && currentClassName) {
                            try {
                                const q = query(getRef('classes'), where('classCode', '==', currentClassCode));
                                const querySnapshot = await getDocs(q);

                                if (!querySnapshot.empty) {
                                    const classDoc = querySnapshot.docs[0];
                                    await updateDoc(doc(db, getPath('classes'), classDoc.id), {
                                        studentIds: arrayUnion(uid)
                                    });
                                } else {
                                    await addDoc(getRef('classes'), {
                                        title: currentClassName,
                                        classCode: currentClassCode,
                                        teacherId: 'pending_teacher', 
                                        studentIds: [uid],
                                        createdAt: serverTimestamp()
                                    });
                                }
                            } catch (classErr) {
                                console.warn(`L·ªói th√™m l·ªõp cho ${st.name}:`, classErr);
                                classErrorCount++;
                            }
                        }

                        // L∆∞u v√†o danh s√°ch th√†nh c√¥ng (K√®m m·∫≠t kh·∫©u th·ª±c t·∫ø ƒë√£ d√πng)
                        successList.push({
                            name: st.name,
                            email: st.email,
                            classCode: currentClassCode || 'N/A',
                            className: currentClassName || 'N/A',
                            password: userPassword // Xu·∫•t l·∫°i m·∫≠t kh·∫©u ƒë·ªÉ GV bi·∫øt
                        });

                        successCount++;
                    } catch (err) {
                        console.error(`L·ªói t·∫°o user ${st.name}:`, err);
                    }

                    // D. ƒêƒÉng xu·∫•t
                    await signOut(auth);
                    await new Promise(r => setTimeout(r, 500)); // Delay ƒë·ªÉ tr√°nh l·ªói Auth
                }

                // K·∫øt th√∫c
                statusEl.textContent = "Ho√†n t·∫•t!";
                let msg = `ƒê√£ t·∫°o th√†nh c√¥ng ${successCount}/${studentsToCreate.length} t√†i kho·∫£n.`;
                if (classErrorCount > 0) {
                    msg += `\n(C√≥ ${classErrorCount} l·ªói khi th√™m v√†o l·ªõp - HS c·∫ßn t·ª± nh·∫≠p m√£ l·ªõp)`;
                }
                
                // T·ª∞ ƒê·ªòNG T·∫¢I FILE CSV
                if (successList.length > 0) {
                    // T√™n file xu·∫•t ra: DS_TaiKhoan_NgayGio.csv
                    const dateStr = new Date().toISOString().slice(0,10);
                    downloadCSV(successList, `DS_TaiKhoan_${dateStr}.csv`);
                    msg += `\n\nƒê√£ t·∫£i xu·ªëng file danh s√°ch t√†i kho·∫£n (k√®m m·∫≠t kh·∫©u)!`;
                }

                alert(msg);

            } catch (e) {
                console.error("Bulk process error:", e);
                showToast("L·ªói h·ªá th·ªëng: " + e.message, "error");
            } finally {
                state.ui.isBulkCreating = false;
                toggleBulkModal(false);
                state.ui.authMode = 'login';
                renderApp(); 
            }
        };
// --- TI·ªÜN √çCH: Xu·∫•t file CSV (H·ªó tr·ª£ Ti·∫øng Vi·ªát cho Excel) ---
        window.downloadCSV = (data, filename = 'danh_sach_tai_khoan.csv') => {
            if (!data || data.length === 0) return;

            // 1. T·∫°o Header
            const headers = ["T√™n H·ªçc Sinh", "Email", "M√£ L·ªõp", "T√™n L·ªõp", "M·∫≠t Kh·∫©u"];
            
            // 2. T·∫°o n·ªôi dung c√°c d√≤ng (Bao quanh b·∫±ng d·∫•u ngo·∫∑c k√©p ƒë·ªÉ tr√°nh l·ªói n·∫øu c√≥ d·∫•u ph·∫©y)
            const csvRows = [
                headers.join(','), 
                ...data.map(row => [
                    `"${row.name}"`,
                    `"${row.email}"`,
                    `"${row.classCode}"`,
                    `"${row.className}"`,
                    `"${row.password}"` // L∆∞u √Ω: Excel s·∫Ω t·ª± hi·ªÉu s·ªë, nh∆∞ng text n√™n ƒë·ªÉ trong ngo·∫∑c k√©p
                ].join(','))
            ];

            // 3. K·∫øt h·ª£p th√†nh chu·ªói
            const csvString = csvRows.join('\n');

            // 4. T·∫°o Blob v·ªõi BOM (\uFEFF) ƒë·ªÉ Excel hi·ªÉn th·ªã ƒë√∫ng Ti·∫øng Vi·ªát
            const blob = new Blob(["\uFEFF" + csvString], { type: 'text/csv;charset=utf-8;' });
            
            // 5. T·∫°o link ·∫£o v√† k√≠ch ho·∫°t t·∫£i v·ªÅ
            const url = URL.createObjectURL(blob);
            const link = document.createElement("a");
            link.setAttribute("href", url);
            link.setAttribute("download", filename);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        };
        initAuth();

    </script>
</body>
</html>