<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
   <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="EduBattle">
    
    <meta name="theme-color" content="#2563eb">
    <title>EduBattle - N·ªÅn t·∫£ng h·ªçc t·∫≠p & Thi ƒë·∫•u</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* Custom scrollbar for better look */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        /* Style for drag/drop items in Jumble question */
        .jumble-word {
            display: inline-block;
            padding: 8px 12px;
            margin: 4px;
            background-color: #e0f2f1; /* Tailwind teal-50 */
            border: 1px solid #009688; /* Tailwind teal-600 */
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.2s;
            font-weight: 600;
        }
        .jumble-word:hover { background-color: #b2dfdb; }

        /* Animation for correct answer flash */
        .flash-green {
            animation: flashGreen 0.2s ease-out;
        }
        @keyframes flashGreen {
            0% { background-color: #f0fff4; }
            50% { background-color: #34d399; } /* Tailwind green-400 */
            100% { background-color: #f0fff4; }
        }

        /* --- M·ªöI: CSS cho Responsive Sidebar (Mobile Hidden) --- */
        #mobile-overlay {
            z-index: 40; /* D∆∞·ªõi toast */
            display: none;
        }
        @media (max-width: 1023px) {
            /* ·∫®n sidebar tr√™n mobile, d√πng overlay */
            #sidebar-desktop {
                transform: translateX(-100%);
                transition: transform 0.3s ease-in-out;
                position: fixed;
                height: 100%;
                z-index: 50;
            }
            #sidebar-desktop.open {
                transform: translateX(0);
            }
            #mobile-overlay.open {
                display: block;
            }
            /* FIX QUAN TR·ªåNG: Th√™m padding-bottom cho main tr√™n mobile ƒë·ªÉ tr√°nh thanh nav bar che m·∫•t n·ªôi dung */
            main {
                padding-bottom: calc(1rem + 64px) !important; /* 1rem (p-4) + chi·ªÅu cao c·ªßa nav (h-16 = 64px) */
            }
        }
        @media (min-width: 1024px) {
            /* Hi·ªán sidebar tr√™n desktop */
            #sidebar-desktop {
                transform: translateX(0);
                width: 16rem; /* w-64 */
            }
            /* Sidebar thu g·ªçn */
            #sidebar-desktop.collapsed {
                 width: 4.5rem; /* w-18 */
            }
            #sidebar-desktop.collapsed .sidebar-label,
            #sidebar-desktop.collapsed .profile-details,
            #sidebar-desktop.collapsed .logout-text,
            #sidebar-desktop.collapsed .app-title {
                display: none;
            }
            #sidebar-desktop.collapsed .nav-item,
            #sidebar-desktop.collapsed .profile-wrapper,
            #sidebar-desktop.collapsed .logout-btn {
                justify-content: center;
            }
            #sidebar-desktop.collapsed .profile-wrapper {
                padding-left: 0.5rem;
            }
        }

        /* --- M·ªöI: CSS CHO CH·∫æ ƒê·ªò IN ·∫§N (√ÅP D·ª§NG KHI IN) --- */
/* --- CSS CHO CH·∫æ ƒê·ªò IN ·∫§N (FIX L·ªñI TRANG TR·∫ÆNG & D√çNH D√íNG) --- */
/* --- CSS CHO CH·∫æ ƒê·ªò IN ·∫§N (FIX FINAL: NG·∫ÆT TRANG CHU·∫®N) --- */
        @media print {
            /* 1. ·∫®n t·∫•t c·∫£ giao di·ªán ·ª©ng d·ª•ng */
            #app, #toast-container, #avatar-modal-container, #mobile-overlay, #sidebar-desktop {
                display: none !important;
            }

            /* 2. Thi·∫øt l·∫≠p Body & HTML v·ªÅ tr·∫°ng th√°i m·∫∑c ƒë·ªãnh c·ªßa vƒÉn b·∫£n */
            html, body {
                width: 100%;
                height: auto !important;
                margin: 0 !important;
                padding: 0 !important;
                background: white !important;
                color: black !important;
                overflow: visible !important;
            }
            
            /* 3. Container in ·∫•n: D√πng STATIC ƒë·ªÉ tu√¢n th·ªß lu·ªìng vƒÉn b·∫£n t·ª± nhi√™n */
            #print-content {
                display: block !important;
                position: static !important; /* QUAN TR·ªåNG: Kh√¥ng d√πng absolute */
                width: 100% !important;
                height: auto !important;
                margin: 0 !important;
                padding: 0 !important;
                visibility: visible !important;
                overflow: visible !important;
            }
            
            /* ƒê·∫£m b·∫£o n·ªôi dung b√™n trong hi·ªán ra */
            #print-content * {
                visibility: visible !important;
            }

            /* 4. Class bao quanh m·ªói h·ªçc sinh: B·∫Øt bu·ªôc ng·∫Øt trang sau n√≥ */
            .print-page-break {
                display: block !important;
                width: 100% !important;
                min-height: 100vh; /* Chi·∫øm t·ªëi thi·ªÉu 1 trang */
                box-sizing: border-box !important;
                padding: 40px 50px !important; /* Canh l·ªÅ gi·∫•y */
                position: relative !important;
                
                /* L·ªánh ng·∫Øt trang */
                page-break-after: always !important; 
                break-after: page !important;
            }

            /* 5. NgƒÉn kh√¥ng cho c·∫Øt ƒë√¥i c√°c kh·ªëi quan tr·ªçng (B·∫£ng, Nh·∫≠n x√©t) */
            .no-break-box, table, tr, td, th {
                page-break-inside: avoid !important;
                break-inside: avoid !important;
            }
            
            /* Reset m√†u s·∫Øc ƒë·ªÉ in ƒë·∫≠m n√©t */
            * {
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }
        }
            
            .print-header {
                 text-align: center;
                 margin-bottom: 20px;
                 padding-bottom: 10px;
                 /* ƒê√£ x√≥a border-bottom ·ªü ƒë√¢y */
            }
            .print-question {
                page-break-inside: avoid;
                margin-bottom: 15px;
                padding-bottom: 5px;
                border: none !important; /* QUAN TR·ªåNG: X√≥a d√≤ng k·∫ª ngang gi·ªØa c√°c c√¢u */
            }
            .print-question-text {
                font-size: 13pt;
                font-weight: bold;
                margin-bottom: 8px;
                line-height: 1.4;
            }
            .print-option-list {
                display: grid;
                grid-template-columns: repeat(2, 1fr); 
                gap: 5px;
                margin-left: 15px;
            }
            .print-option-item {
                 font-size: 12pt;
            }
            .print-space {
                height: 25px; 
                margin-top: 5px;
                width: 100%;
                /* N·∫øu b·∫°n mu·ªën d√≤ng k·∫ª m·ªù ƒë·ªÉ vi·∫øt th√¨ gi·ªØ l·∫°i, n·∫øu mu·ªën tr·∫Øng tinh th√¨ x√≥a border-bottom d∆∞·ªõi n√†y ƒëi */
                border-bottom: 1px dotted #ccc; 
            }
            /* Style khung t·ª´ v·ª±ng cho c√¢u Jumble */
            .print-jumble-box {
                display: inline-block;
                border: 1px solid #333;
                padding: 4px 12px;
                margin: 4px;
                border-radius: 4px;
                font-size: 11pt;
                background-color: #fff;
            }
        }
/* --- CSS CHO V√íNG QUAY MAY M·∫ÆN (ƒê√É FIX L·ªñI M√âO H√åNH) --- */
        .wheel-container {
            position: relative;
            
            /* Thay ƒë·ªïi ·ªü ƒë√¢y: */
            width: 100%;             /* Chi·∫øm t·ªëi ƒëa chi·ªÅu r·ªông cho ph√©p */
            max-width: 250px;        /* Gi·ªõi h·∫°n k√≠ch th∆∞·ªõc t·ªëi ƒëa l√† 300px */
            aspect-ratio: 1 / 1;     /* QUAN TR·ªåNG: Bu·ªôc chi·ªÅu cao lu√¥n b·∫±ng chi·ªÅu r·ªông -> Lu√¥n l√† h√¨nh vu√¥ng/tr√≤n */
            
            margin: 0 auto;          /* CƒÉn gi·ªØa */
        }

        /* C√°c ph·∫ßn d∆∞·ªõi gi·ªØ nguy√™n, ch·ªâ ƒë·∫£m b·∫£o .wheel th·ª´a k·∫ø ƒë√∫ng k√≠ch th∆∞·ªõc */
        .wheel {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            position: relative;
            overflow: hidden;
            transition: transform 4s cubic-bezier(0.17, 0.67, 0.12, 0.99);
            box-shadow: 0 0 15px rgba(0,0,0,0.2);
            border: 8px solid white;
            box-sizing: border-box; /* ƒê·∫£m b·∫£o vi·ªÅn kh√¥ng l√†m m√©o h√¨nh */
        }
        .wheel-segment {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            clip-path: polygon(50% 50%, 50% 0, 100% 0, 100% 70%); /* C·∫Øt h√¨nh r·∫ª qu·∫°t (∆∞·ªõc l∆∞·ª£ng cho 5 √¥) */
            /* Ch√≠nh x√°c cho 5 √¥ (72 ƒë·ªô m·ªói √¥): d√πng conic-gradient ·ªü d∆∞·ªõi s·∫Ω t·ªët h∆°n cho m√†u n·ªÅn */
            display: flex;
            justify-content: center;
            align-items: flex-start;
            padding-top: 20px;
            font-weight: bold;
            font-size: 14px;
            color: white;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
        }
        /* V·∫Ω m√†u n·ªÅn b·∫±ng Conic Gradient cho ch√≠nh x√°c 5 ph·∫ßn */
        .wheel-bg {
            width: 100%; height: 100%;
            border-radius: 50%;
            background: conic-gradient(
                #FF6B6B 0deg 72deg,    /* 10 ƒêi·ªÉm - ƒê·ªè nh·∫°t */
                #4ECDC4 72deg 144deg,  /* 20 ƒêi·ªÉm - Xanh ng·ªçc */
                #FFE66D 144deg 216deg, /* 100 ƒêi·ªÉm - V√†ng */
                #95A5A6 216deg 288deg, /* M·∫•t l∆∞·ª£t - X√°m */
                #A855F7 288deg 360deg  /* Th√™m v√© - T√≠m */
            );
        }
        /* Nh√£n ch·ªØ n·∫±m tr√™n c√°c √¥ */
        .wheel-label {
            position: absolute;
            top: 50%; left: 50%;
            transform-origin: 50% 50%;
            width: 0; height: 0;
        }
        .wheel-text {
            position: absolute;
            left: -50px; bottom: 60px; /* CƒÉn ch·ªânh v·ªã tr√≠ ch·ªØ ra xa t√¢m */
            width: 100px;
            text-align: center;
            transform-origin: 50% 100%; /* Xoay quanh t√¢m */
            font-weight: bold;
            color: #fff;
            text-shadow: 1px 1px 3px rgba(0,0,0,0.8);
            font-size: 13px;
        }
        .wheel-pointer {
            position: absolute;
            top: -10px;
            left: 50%;
            transform: translateX(-50%);
            width: 30px; 
            height: 40px;
            background: #FF3B30;
            clip-path: polygon(100% 0, 50% 100%, 0 0); /* H√¨nh tam gi√°c */
            z-index: 20;
            filter: drop-shadow(0 2px 2px rgba(0,0,0,0.3));
        }
        .wheel-center {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            width: 50px; height: 50px;
            background: white;
            border-radius: 50%;
            z-index: 10;
            box-shadow: 0 0 5px rgba(0,0,0,0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }
    </style>
<script>
        // T·∫°o n·ªôi dung Manifest
        const manifestData = {
            "name": "EduBattle - H·ªçc t·∫≠p & Thi ƒë·∫•u",
            "short_name": "EduBattle",
            "start_url": ".",
            "display": "standalone", /* QUAN TR·ªåNG: D√≤ng n√†y gi√∫p ·∫©n thanh ƒë·ªãa ch·ªâ */
            "background_color": "#f8fafc",
            "theme_color": "#2563eb",
            "orientation": "portrait",
            "icons": [
                {
                    "src": "https://cdn-icons-png.flaticon.com/512/2997/2997326.png", /* Icon v√≠ d·ª• */
                    "sizes": "192x192",
                    "type": "image/png"
                },
                {
                    "src": "https://cdn-icons-png.flaticon.com/512/2997/2997326.png",
                    "sizes": "512x512",
                    "type": "image/png"
                }
            ]
        };

        // Chuy·ªÉn ƒë·ªïi th√†nh Blob URL v√† ch√®n v√†o th·∫ª <head>
        const stringManifest = JSON.stringify(manifestData);
        const blob = new Blob([stringManifest], {type: 'application/json'});
        const manifestURL = URL.createObjectURL(blob);
        
        const link = document.createElement('link');
        link.rel = 'manifest';
        link.href = manifestURL;
        document.head.appendChild(link);
    </script>
</head>
<body class="bg-slate-50 text-slate-900 font-sans h-screen overflow-hidden">

    <div id="app" class="h-full w-full"></div>

    <div id="toast-container" class="fixed top-4 right-4 z-50 flex flex-col gap-2"></div>
    
    <div id="avatar-modal-container"></div>
    
    <!-- M·ªöI: Overlay cho Mobile Sidebar -->
    <div id="mobile-overlay" class="fixed inset-0 bg-black bg-opacity-50 transition-opacity" onclick="toggleSidebar(false)"></div>
    
    <!-- M·ªöI: Container ·∫©n cho ch·∫ø ƒë·ªô in (ch·ªâ hi·ªán khi in) -->
    <div id="print-content" style="display: none;"></div>

    <script type="module">
         import { initializeApp, deleteApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithCustomToken, onAuthStateChanged, signOut, signInAnonymously,
                 createUserWithEmailAndPassword, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, addDoc, updateDoc, onSnapshot, serverTimestamp, query, where, getDocs, deleteDoc, runTransaction, arrayRemove, arrayUnion, increment } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getStorage, ref as storageRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js"; // TH√äM FIREBASE STORAGE

        // --- 1. CONFIGURATION ---
        let appId, firebaseConfig;
        const TEACHER_CODE = "ruands10"; // M√£ x√°c nh·∫≠n gi√°o vi√™n
        // Bi·∫øn l∆∞u tr·ªØ listener ƒë·ªÉ h·ªßy khi tho√°t xem

        try {
            if (typeof __firebase_config !== 'undefined') {
                firebaseConfig = JSON.parse(__firebase_config);
            } else {
                // Fallback config (Public Demo)
                firebaseConfig = {
                    apiKey: "AIzaSyBTHcX_Ha3CZPNHY8vcWilcOe4oF3f6rKU",
                    authDomain: "lmsapp-19548.firebaseapp.com",
                    projectId: "lmsapp-19548",
                    storageBucket: "lmsapp-19548.firebasestorage.app",
                    messagingSenderId: "584664617140",
                    appId: "1:584664617140:web:8ffa1650976191c45887e1",
                    measurementId: "G-1TK7RW8H15"
                };
            }
            appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        } catch (e) { console.error(e); firebaseConfig = {}; }

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app); // KH·ªûI T·∫†O STORAGE
// --- GAME CONFIGURATION (ƒê√É C·∫¨P NH·∫¨T: NHI·ªÄU HUY HI·ªÜU & ITEM H∆†N) ---
        const GAME_CONFIG = {
            LEVELS: [
                { name: 'H·ªçc vi√™n M·ªõi', min: 0, color: 'text-slate-500', icon: 'üå±' },
                { name: 'ƒê·ªìng', min: 200, color: 'text-orange-700', icon: 'ü•â' },
                { name: 'B·∫°c', min: 500, color: 'text-slate-400', icon: 'ü•à' },
                { name: 'V√†ng', min: 1000, color: 'text-yellow-500', icon: 'ü•á' },
                { name: 'B·∫°ch Kim', min: 2000, color: 'text-cyan-500', icon: 'üí†' }, // Th√™m c·∫•p
                { name: 'Kim C∆∞∆°ng', min: 4000, color: 'text-blue-600', icon: 'üíé' },
                { name: 'Th√°ch ƒê·∫•u', min: 8000, color: 'text-purple-600', icon: 'üëë' },
                { name: 'Huy·ªÅn Tho·∫°i', min: 15000, color: 'text-red-600', icon: 'üî•' } // C·∫•p cao nh·∫•t
            ],
            BADGES: [
                // --- NH√ìM 1: CHU·ªñI NG√ÄY (STREAK) ---
                { id: 'streak_3', name: 'Kh·ªüi ƒë·ªông', desc: 'ƒê·∫°t chu·ªói 3 ng√†y li√™n t·ª•c', icon: 'üëü', condition: (p) => (p.streak || 0) >= 3 },
                { id: 'streak_7', name: 'B·ªÅn b·ªâ', desc: 'ƒê·∫°t chu·ªói 7 ng√†y (1 tu·∫ßn)', icon: 'üî•', condition: (p) => (p.streak || 0) >= 7 },
                { id: 'streak_14', name: 'Chi·∫øn binh', desc: 'ƒê·∫°t chu·ªói 14 ng√†y', icon: '‚öîÔ∏è', condition: (p) => (p.streak || 0) >= 14 },
                { id: 'streak_30', name: 'Th∆∞·ª£ng th·ª´a', desc: 'ƒê·∫°t chu·ªói 30 ng√†y (1 th√°ng)', icon: 'üßò', condition: (p) => (p.streak || 0) >= 30 },

                // --- NH√ìM 2: T√çCH L≈®Y ƒêI·ªÇM (WEALTH) ---
                { id: 'rich_1k', name: 'ƒê·∫°i gia', desc: 'T√≠ch l≈©y 1.000 ƒëi·ªÉm', icon: 'üí∞', condition: (p) => (p.points || 0) >= 1000 },
                { id: 'rich_5k', name: 'Tri·ªáu ph√∫', desc: 'T√≠ch l≈©y 5.000 ƒëi·ªÉm', icon: 'üíé', condition: (p) => (p.points || 0) >= 5000 },
                { id: 'rich_10k', name: 'T·ª∑ ph√∫ Edu', desc: 'T√≠ch l≈©y 10.000 ƒëi·ªÉm', icon: 'üè¶', condition: (p) => (p.points || 0) >= 10000 },

                // --- NH√ìM 3: ƒêI·ªÇM TUY·ªÜT ƒê·ªêI (PERFECT SCORE) ---
                { id: 'perfect_1', name: 'X·∫° th·ªß', desc: 'ƒê·∫°t 1 l·∫ßn 100 ƒëi·ªÉm', icon: 'üéØ', condition: (p) => (p.perfectScores || 0) >= 1 },
                { id: 'perfect_5', name: 'Th·∫ßn ti·ªÖn', desc: 'ƒê·∫°t 5 l·∫ßn 100 ƒëi·ªÉm', icon: 'üèπ', condition: (p) => (p.perfectScores || 0) >= 5 },
                { id: 'perfect_10', name: 'B√°ch ph√°t b√°ch tr√∫ng', desc: 'ƒê·∫°t 10 l·∫ßn 100 ƒëi·ªÉm', icon: 'üåü', condition: (p) => (p.perfectScores || 0) >= 10 },

                // --- NH√ìM 4: CHINH PH·ª§C TH·ª¨ TH√ÅCH (CHALLENGES) ---
                { id: 'chal_1', name: 'Ng∆∞·ªùi m·ªü ƒë∆∞·ªùng', desc: 'Ho√†n th√†nh 1 th·ª≠ th√°ch', icon: 'üö©', condition: (p) => (p.completedChallenges?.length || 0) >= 1 },
                { id: 'chal_5', name: 'Nh√† th√°m hi·ªÉm', desc: 'Ho√†n th√†nh 5 th·ª≠ th√°ch', icon: 'üß≠', condition: (p) => (p.completedChallenges?.length || 0) >= 5 },
                { id: 'chal_10', name: 'Nh√† chinh ph·∫°t', desc: 'Ho√†n th√†nh 10 th·ª≠ th√°ch', icon: '‚õ∞Ô∏è', condition: (p) => (p.completedChallenges?.length || 0) >= 10 },

                // --- NH√ìM 5: MUA S·∫ÆM (SHOPPING) ---
                { id: 'shop_1', name: 'D√¢n ch∆°i', desc: 'Mua m√≥n ƒë·ªì ƒë·∫ßu ti√™n', icon: 'üõçÔ∏è', condition: (p) => (p.inventory?.length || 0) >= 1 },
                { id: 'shop_5', name: 'Nh√† s∆∞u t·∫≠p', desc: 'S·ªü h·ªØu 5 v·∫≠t ph·∫©m', icon: 'üéí', condition: (p) => (p.inventory?.length || 0) >= 5 }
            ],
            SHOP_ITEMS: [
                { id: 'frame_gold', name: 'Khung Avatar V√†ng', price: 500, type: 'frame', icon: 'üñºÔ∏è' },
                { id: 'frame_fire', name: 'Hi·ªáu ·ª©ng L·ª≠a', price: 1000, type: 'frame', icon: 'üî•' },
                { id: 'frame_neon', name: 'Khung Neon', price: 2000, type: 'frame', icon: 'üåà' },
                { id: 'frame_royal', name: 'V∆∞∆°ng mi·ªán Ho√†ng gia', price: 5000, type: 'frame', icon: 'üëë' },
                { id: 'ticket_x1', name: '1 V√© Quay', price: 50, type: 'ticket', amount: 1, icon: 'üé´' },
                { id: 'ticket_x5', name: '5 V√© Quay (Gi·∫£m gi√°)', price: 200, type: 'ticket', amount: 5, icon: 'üéüÔ∏è' }
            ],
                ALL_AVATARS: ['üêº','üôé‚Äç‚ôÇÔ∏è','üåã','üíÇ','üôç','ü¶∏','üêØ','üêò','üê¢','üêù', 'üéÖ', 'üßô', 'üê∂', 'üêÆ', 'üê∞', 
                                               'üêã', 'üêµ', '‚òÉÔ∏è', 'ü¶ã', 'ü§π‚Äç‚ôÇÔ∏è', 'üêì', 'üê¨', 'üê∑', 'üåé', 'üéØ','üéì', 'üò∫', 'üöÄ', 'üí°',
                                                'üïµÔ∏è', 'üß†', 'ü¶â', 'ü¶ä', 'üêª', 'üêº', 'üíª', 'üßë‚Äçüéì', 'üë®‚Äçüè´', 'üèÜ', 'ü•á', 'ü•à', 'ü•â',
                                                'üê≤', 'ü¶Ñ', 'ü§ñ'],
            
            // 5 Avatar m·∫∑c ƒë·ªãnh ban ƒë·∫ßu
            INITIAL_AVATARS: ['üê∂', 'üò∫', 'üêº', 'üê∞', 'ü¶ä']
        };

        // Helper: T√≠nh Level hi·ªán t·∫°i
        const getUserLevel = (points) => {
            return GAME_CONFIG.LEVELS.slice().reverse().find(l => points >= l.min) || GAME_CONFIG.LEVELS[0];
        };
        
        // Helper Paths
        const getPath = (col) => `artifacts/${appId}/public/data/${col}`;
        const getRef = (col) => collection(db, 'artifacts', appId, 'public', 'data', col);
// --- H√ÄM HELPER: FORMAT VƒÇN B·∫¢N (QUAN TR·ªåNG: C·∫ßn c√≥ ƒë·ªÉ hi·ªÉn th·ªã danh s√°ch c√¢u h·ªèi) ---
        // H√†m n√†y x·ª≠ l√Ω vi·ªác bi·∫øn ƒë·ªïi **t·ª´ v·ª±ng** th√†nh ch·ªØ xanh ƒë·∫≠m
        const formatText = (text) => {
            if (!text) return '';
            // Lo·∫°i b·ªè th·∫ª HTML th·ª´a n·∫øu c√≥, sau ƒë√≥ format d·∫•u **
            // return text.replace(/\*\*(.*?)\*\*/g, '<span class="text-blue-600 font-bold">$1</span>');
             return text.replace(/\*\*(.*?)\*\*/g, '<span class="text-blue-600 font-bold text-lg mx-1">$1</span>');
        };


        // --- 2. STATE MANAGEMENT ---
        const state = {
            user: null,
            profile: null,
            view: 'dashboard', 
            data: {
                assignments: [],
                submissions: [],
                users: [],
                matches: [],
                vocabulary: [], // Store loaded vocabulary here
                questionBanks: [], // Ng√¢n h√†ng ƒë·ªÅ
                classes: [], // Danh s√°ch l·ªõp h·ªçc
                challenges: [], // [M·ªöI] Danh s√°ch th·ª≠ th√°ch
                assessments: [], // <--- TH√äM D√íNG N√ÄY
                reportComments: []
            },
            ui: {
                isCreatingAssignment: false,
                takingAssignmentId: null,
                currentQuestionIndex: 0,
                assignmentAnswers: {},
                newAssignment: { title: '', questions: [], selectedClassIds: [] }, 
                activeMatch: null,
                matchQIndex: 0,
                authMode: 'login',
                newQuestionType: 'mcq',
                competitionMode: 'lobby',
                lastFinishedMatch: null,
                hasAnsweredCurrentQ: false,
                viewAssignmentId: null,
                viewSubmission: null,
                bankMode: 'list',
                selectedBankId: null,
                isSelectingBankQuestions: false,
                viewClassId: null, 
                isCreatingClass: false, 
                isManagingStudent: false, 
                isProcessingStudentCreation: false,
                viewClassMode: 'students', 
                isImportingBankData: false,
                importQType: 'vocab_mcq', 
                // M·ªöI: Tr·∫°ng th√°i Modal Avatar
                isAvatarModalOpen: false,
                tempAvatarUrl: null, // L∆∞u tr·ªØ t·∫°m th·ªùi URL ·∫£nh t·∫£i l√™n ho·∫∑c emoji
                tempAvatarType: null, // 'emoji' ho·∫∑c 'url'
                
                // --- M·ªöI: RESPONSIVE UI STATE ---
                isSidebarOpen: window.innerWidth >= 1024, // M·ªü m·∫∑c ƒë·ªãnh tr√™n Desktop
                isSidebarCollapsed: false, // Tr·∫°ng th√°i thu g·ªçn tr√™n Desktop
                
                // --- M·ªöI: Th·ªëng k√™ l·ªõp h·ªçc ---
                selectedStatAssignmentId: null, // ID b√†i t·∫≠p ƒëang xem th·ªëng k√™

                // --- M·ªöI: Student Class View State ---
                viewMyClassId: null, // ID c·ªßa l·ªõp h·ªçc sinh ƒëang xem chi ti·∫øt
                isJoiningClass: false, // Tr·∫°ng th√°i modal nh·∫≠p m√£ l·ªõp
                isBulkModalOpen: false,
                isBulkCreating: false,
                matchResult: null,
                challengeMode: 'list', // list, create, edit, do
                activeChallenge: null, // Th·ª≠ th√°ch ƒëang xem/l√†m
                challengeAnswers: {}, // C√¢u tr·∫£ l·ªùi t·∫°m th·ªùi
                isSubmittingChallenge: false,
                isCreatingAssessment: false, // <--- TH√äM D√íNG N√ÄY
            },
            isAuthReady: false,
            initialAuthToken: typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null,
            areAssignmentsListenersActive: false 
        };

// --- LOGIC QU·∫¢N L√ù TI√äU CH√ç ƒê·ªòNG ---
                // M·∫∑c ƒë·ªãnh ban ƒë·∫ßu
        const DEFAULT_CRITERIA = ['T·ª´ v·ª±ng', 'Ch·ªØ vi·∫øt', 'Kh·∫©u ng·ªØ'];

        // H√†m kh·ªüi t·∫°o khi b·∫•m n√∫t "T·∫°o b√†i ki·ªÉm tra"
        window.initCreateAssessment = () => {
            // Copy m·∫£ng m·∫∑c ƒë·ªãnh v√†o state t·∫°m
            state.ui.tempAssessmentCriteria = [...DEFAULT_CRITERIA];
            state.ui.isCreatingAssessment = true;
            renderApp();
        };

        window.addAssessmentCriterion = () => {
            const input = document.getElementById('new-criterion-input');
            const val = input.value.trim();
            if (!val) return showToast("Vui l√≤ng nh·∫≠p t√™n ti√™u ch√≠", "error");
            
            if (state.ui.tempAssessmentCriteria.includes(val)) return showToast("Ti√™u ch√≠ ƒë√£ t·ªìn t·∫°i", "error");
            
            state.ui.tempAssessmentCriteria.push(val);
            renderApp(); // Render l·∫°i ƒë·ªÉ c·∫≠p nh·∫≠t b·∫£ng
            
            // Focus l·∫°i v√†o √¥ nh·∫≠p sau khi render (d√πng timeout ƒë·ªÉ ƒë·ª£i DOM c·∫≠p nh·∫≠t)
            setTimeout(() => {
                const el = document.getElementById('new-criterion-input');
                if(el) el.focus();
            }, 50);
        };

        window.removeAssessmentCriterion = (index) => {
            if (state.ui.tempAssessmentCriteria.length <= 1) return showToast("C·∫ßn √≠t nh·∫•t 1 ti√™u ch√≠ ch·∫•m ƒëi·ªÉm.", "error");
            state.ui.tempAssessmentCriteria.splice(index, 1);
            renderApp();
        };

        
        // M·ªöI: DANH S√ÅCH EMOJI
        const EMOJI_AVATARS = ['üêº','üôé‚Äç‚ôÇÔ∏è','üåã','üíÇ','üôç','ü¶∏','üêØ','üêò','üê¢','üêù', 'üéÖ', 'üßô', 'üê∂', 'üêÆ', 'üê∞', 
                                                         'üêã', 'üêµ', '‚òÉÔ∏è', 'ü¶ã', 'ü§π‚Äç‚ôÇÔ∏è', 'üêì', 'üê¨', 'üê∑', 'üåé', 'üéØ','üéì', 'üò∫', 'üöÄ', 'üí°',
                                                        'üïµÔ∏è', 'üß†', 'ü¶â', 'ü¶ä', 'üêª', 'üêº', 'üíª', 'üßë‚Äçüéì', 'üë®‚Äçüè´', 'üèÜ', 'ü•á', 'ü•à', 'ü•â',
                                                        'üê≤', 'ü¶Ñ', 'ü§ñ'];

        // H√†m t·∫°o m√£ ph√≤ng ng·∫´u nhi√™n 6 k√Ω t·ª±
        const generateRoomCode = () => {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let code = '';
            for (let i = 0; i < 6; i++) {
                code += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return code;
        };
        
        // --- M·ªöI: RESPONSIVE HANDLERS ---
        window.toggleSidebar = (force) => {
            if (window.innerWidth < 1024) {
                 // Mobile: Toggle open/close
                state.ui.isSidebarOpen = (force !== undefined) ? force : !state.ui.isSidebarOpen;
            } else {
                // Desktop: Toggle collapse/expand
                 state.ui.isSidebarCollapsed = (force !== undefined) ? force : !state.ui.isSidebarCollapsed;
            }
            renderApp();
        };

        window.toggleCollapse = () => {
            if (window.innerWidth >= 1024) {
                state.ui.isSidebarCollapsed = !state.ui.isSidebarCollapsed;
                renderApp();
            }
        }
        
// --- S·ª¨A L·ªñI NH√ÅY M√ÄN H√åNH KHI NH·∫¨P LI·ªÜU MOBILE ---
let lastWidth = window.innerWidth; // L∆∞u l·∫°i chi·ªÅu r·ªông ban ƒë·∫ßu

window.addEventListener('resize', () => {
    const currentWidth = window.innerWidth;

    // QUAN TR·ªåNG: N·∫øu chi·ªÅu r·ªông kh√¥ng ƒë·ªïi (ch·ªâ ƒë·ªïi chi·ªÅu cao do b√†n ph√≠m hi·ªán), th√¨ KH√îNG l√†m g√¨ c·∫£.
    if (currentWidth === lastWidth) return;
    
    // C·∫≠p nh·∫≠t l·∫°i chi·ªÅu r·ªông m·ªõi
    lastWidth = currentWidth;

    const isDesktop = currentWidth >= 1024;
    if (isDesktop && !state.ui.isSidebarOpen) {
        state.ui.isSidebarOpen = true; 
    } else if (!isDesktop && state.ui.isSidebarCollapsed) {
        state.ui.isSidebarCollapsed = false; 
    }
    
    if (state.user && state.profile) renderApp();
});


        // --- 3. UTILITIES & DATA LOADING ---

        window.showToast = (msg, type = 'success') => {
            const container = document.getElementById('toast-container');
            const el = document.createElement('div');
            const color = type === 'error' ? 'bg-red-500' : 'bg-green-600';
            el.className = `${color} text-white px-6 py-3 rounded-lg shadow-xl animate-bounce mb-2 transition-all duration-500`;
            el.textContent = msg;
            container.appendChild(el);
            setTimeout(() => {
                el.style.opacity = '0';
                setTimeout(() => el.remove(), 500);
            }, 3000);
        };

        const renderIcons = () => lucide.createIcons();
        
        // H√†m tr·ªôn m·∫£ng
        const shuffleArray = (array) => {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[i], array[j]];
            }
            return array;
        };

        /**
         * Chuy·ªÉn ƒë·ªïi m·ªôt t·ª´ ho·∫∑c c√¢u ti·∫øng Trung sang √¢m thanh
         * @param {string} text - VƒÉn b·∫£n c·∫ßn ph√°t √¢m
         * @param {string} lang - Ng√¥n ng·ªØ (m·∫∑c ƒë·ªãnh 'zh-CN' cho ti·∫øng Trung)
         */
        window.speakWord = (text, lang = 'zh-CN') => {
            if ('speechSynthesis' in window) {
                window.speechSynthesis.cancel();
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = lang; 
                utterance.rate = 0.8; // H∆°i ch·∫≠m l·∫°i ƒë·ªÉ r√µ r√†ng
                
                window.speechSynthesis.speak(utterance);
            } else {
                showToast("Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ √¢m thanh.", "error");
            }
        };

        // LOAD DATA FROM LOCAL FILE (Kh√¥ng thay ƒë·ªïi)
        const loadVocabulary = async () => {
            try {
                const response = await fetch('dataLMS/data.txt');
                
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                
                const text = await response.text();
                const vocab = text.split('\n')
                    .map(line => line.trim())
                    .filter(line => line.length > 0)
                    .map(line => {
                        const parts = line.split('|');
                        if (parts.length >= 3) {
                            return { word: parts[0].trim(), pinyin: parts[1].trim(), meaning: parts[2].trim() };
                        }
                        return null;
                    })
                    .filter(item => item !== null);

                if (vocab.length === 0) throw new Error("File r·ªóng");
                
                state.data.vocabulary = vocab;

            } catch (e) {
                console.warn("Kh√¥ng load ƒë∆∞·ª£c dataLMS/data.txt, s·ª≠ d·ª•ng d·ªØ li·ªáu m·∫´u.", e);
                // D·ªØ li·ªáu m·∫´u fallback
                state.data.vocabulary = [
                    { word: '‰Ω†Â•Ω', pinyin: 'n«ê h«éo', meaning: 'Xin ch√†o' },
                    { word: 'Ë∞¢Ë∞¢', pinyin: 'xi√®xie', meaning: 'C·∫£m ∆°n' },
                    { word: 'ÂÜçËßÅ', pinyin: 'z√†iji√†n', meaning: 'T·∫°m bi·ªát' },
                    { word: 'ËÄÅÂ∏à', pinyin: 'l«éoshƒ´', meaning: 'Gi√°o vi√™n' },
                    { word: 'Â≠¶Áîü', pinyin: 'xu√©sheng', meaning: 'H·ªçc sinh' },
                    { word: 'ÊúãÂèã', pinyin: 'p√©ngyou', meaning: 'B·∫°n b√®' },
                    { word: 'Áà±', pinyin: '√†i', meaning: 'Y√™u' },
                    { word: 'ÂñúÊ¨¢', pinyin: 'x«êhuan', meaning: 'Th√≠ch' },
                    { word: 'Áå´', pinyin: 'mƒÅo', meaning: 'Con m√®o' },
                    { word: 'Áãó', pinyin: 'g«íu', meaning: 'Con ch√≥' },
                    { word: 'Ê∞¥', pinyin: 'shu«ê', meaning: 'N∆∞·ªõc' },
                    { word: '‰π¶', pinyin: 'sh≈´', meaning: 'S√°ch' }
                ];
                if (state.view === 'competition') {
                   // showToast("ƒêang d√πng d·ªØ li·ªáu m·∫´u (kh√¥ng t√¨m th·∫•y dataLMS/data.txt)", "error");
                }
            }
        };

        // --- 4. LOGIC T·∫†O C√ÇU H·ªéI ƒê·∫§U TR∆Ø·ªúNG M·ªöI (Gi·ªØ nguy√™n) ---
        const generateArenaQuestions = () => {
            const vocabList = state.data.vocabulary;
            const questions = [];
            if (vocabList.length < 4) return [];

            const NUM_QUESTION_TYPES = 7; 

            for(let i = 0; i < 10; i++) {
                const correctItem = vocabList[Math.floor(Math.random() * vocabList.length)];
                const type = Math.floor(Math.random() * NUM_QUESTION_TYPES) + 1; 
                let qText = "", qOptions = [], correctAnswerVal = "", audioWord = null, audioSentence = null;
                let qTypeId = type; 

                const distractors = [];
                while(distractors.length < 3) {
                    const item = vocabList[Math.floor(Math.random() * vocabList.length)];
                    if (item.word !== correctItem.word && !distractors.includes(item)) distractors.push(item);
                }
                
                const sentence = `ÊàëÂñúÊ¨¢${correctItem.word}„ÄÇ`;
                
                switch(type) {
                    case 1: 
                        qText = `Nghƒ©a c·ªßa t·ª´ <span class="text-blue-600 font-bold text-3xl mx-2">${correctItem.word}</span> l√† g√¨?`;
                        correctAnswerVal = correctItem.meaning;
                        qOptions = [correctItem.meaning, ...distractors.map(d => d.meaning)];
                        break;
                    case 2: 
                        qText = `Pinyin c·ªßa t·ª´ <span class="text-blue-600 font-bold text-3xl mx-2">${correctItem.word}</span> l√† g√¨?`;
                        correctAnswerVal = correctItem.pinyin;
                        qOptions = [correctItem.pinyin, ...distractors.map(d => d.pinyin)];
                        break;
                    case 3: 
                        qText = `T·ª´ n√†o c√≥ nghƒ©a l√† <span class="text-green-600 font-bold text-2xl mx-2">"${correctItem.meaning}"</span>?`;
                        correctAnswerVal = correctItem.word;
                        qOptions = [correctItem.word, ...distractors.map(d => d.word)];
                        break;
                    case 4: 
                        qText = `Nghe v√† ch·ªçn t·ª´ v·ª±ng ƒë√∫ng:`;
                        audioWord = correctItem.word;
                        correctAnswerVal = correctItem.word;
                        qOptions = [correctItem.word, ...distractors.map(d => d.word)];
                        break;
                    case 5: 
                        qText = `Nghe v√† ch·ªçn nghƒ©a ƒë√∫ng:`;
                        audioWord = correctItem.word;
                        correctAnswerVal = correctItem.meaning;
                        qOptions = [correctItem.meaning, ...distractors.map(d => d.meaning)];
                        break;
                    case 6: 
                        qTypeId = 6;
                        qText = `Nghe c√¢u v√† ch·ªçn nghƒ©a ƒë√∫ng:`;
                        audioSentence = sentence;
                        correctAnswerVal = `T√¥i th√≠ch ${correctItem.meaning}.`; 
                        const sentenceMeanings = [`T√¥i th√≠ch ${correctItem.meaning}.`];
                        while(sentenceMeanings.length < 4) {
                             const distractorItem = vocabList[Math.floor(Math.random() * vocabList.length)];
                             const distractorMeaning = `T√¥i th√≠ch ${distractorItem.meaning}.`;
                             if (!sentenceMeanings.includes(distractorMeaning)) {
                                 sentenceMeanings.push(distractorMeaning);
                             }
                        }
                        qOptions = sentenceMeanings;
                        break;
                    case 7: 
                        qTypeId = 7;
                        qText = `Nghe v√† vi·∫øt l·∫°i c√¢u ti·∫øng Trung:`;
                        audioSentence = sentence;
                        correctAnswerVal = sentence;
                        qOptions = []; 
                        break;
                }
                
                const shuffledOptions = qOptions.sort(() => Math.random() - 0.5);
                
                if (qTypeId === 7) {
                    questions.push({
                        type: 'arena_input', 
                        qTypeId: type,
                        text: qText,
                        audioSentence: audioSentence,
                        correct: correctAnswerVal 
                    });
                } else {
                    questions.push({
                        type: 'arena_quiz',
                        qTypeId: type,
                        text: qText,
                        options: shuffledOptions,
                        correct: shuffledOptions.indexOf(correctAnswerVal),
                        audioWord: audioWord,
                        audioSentence: audioSentence 
                    });
                }
            }
            return questions;
        };
        
        // M·ªöI: H√ÄM RENDER AVATAR (Gi·ªØ nguy√™n)
        const renderAvatar = (userProfile, size = 'w-10 h-10', textSize = 'text-base') => {
            // X√°c ƒë·ªãnh xem c√≥ ph·∫£i profile t·∫°m th·ªùi (modal) hay kh√¥ng
            const isTempProfile = userProfile === state.profile && state.ui.isAvatarModalOpen;
            const profileToRender = isTempProfile ? {
                avatarUrl: state.ui.tempAvatarUrl || state.profile?.avatarUrl,
                avatarType: state.ui.tempAvatarType || state.profile?.avatarType,
                name: state.profile?.name,
                role: state.profile?.role
            } : userProfile;
            
            if (profileToRender?.avatarUrl && profileToRender.avatarType === 'url') {
                // ·∫¢nh t·∫£i l√™n
                return `<img src="${profileToRender.avatarUrl}" alt="${profileToRender.name?.charAt(0) || '?'}" class="${size} rounded-full object-cover border-2 border-white shadow-md">`;
            } else if (profileToRender?.avatarUrl && profileToRender.avatarType === 'emoji') {
                 // Emoji
                return `<div class="${size} rounded-full flex items-center justify-center bg-white border border-slate-200 shadow-inner">
                            <span class="${textSize}">${profileToRender.avatarUrl}</span>
                        </div>`;
            } else {
                // Default (Ch·ªØ c√°i ƒë·∫ßu t√™n)
                const bgColor = profileToRender?.role === 'teacher' ? 'bg-purple-500' : 'bg-blue-500';
                const initials = profileToRender?.name?.charAt(0) || '?';
                return `<div class="${size} rounded-full flex items-center justify-center font-bold text-white ${bgColor} border-2 border-white shadow-md">
                            <span class="${textSize}">${initials}</span>
                        </div>`;
            }
        };


        // --- 5. SETUP LISTENERS & AUTH (Gi·ªØ nguy√™n) ---

        const initAuth = async () => {
            await loadVocabulary();
            if (state.initialAuthToken) {
                await signInWithCustomToken(auth, state.initialAuthToken);
            }
        };

// H√†m kh·ªüi t·∫°o c√°c listeners ph·ª• thu·ªôc v√†o state.profile.classIds
        const initializeStudentDataListeners = (uid) => {
            if (state.areAssignmentsListenersActive) return;

            // 1. Assignments Listener
            onSnapshot(getRef('assignments'), (snap) => {
                const myClassIds = state.profile?.classIds || [];
                const isTeacher = state.profile?.role === 'teacher';
                
                const allAssignments = snap.docs.map(d => ({id: d.id, ...d.data()}));
                
                const filteredAssignments = allAssignments.filter(a => {
                    if (isTeacher && a.createdBy === uid) return true; 
                    if (!isTeacher && a.classIds && Array.isArray(a.classIds)) {
                        return a.classIds.some(classId => myClassIds.includes(classId));
                    }
                    return false;
                });
                
                state.data.assignments = filteredAssignments;
                
                // [FIX NH√ÅY CHO GI√ÅO VI√äN]: ƒê·ªãnh nghƒ©a tr·∫°ng th√°i "ƒêang b·∫≠n so·∫°n th·∫£o"
                const isTeacherBusy = state.ui.isCreatingAssignment || state.ui.isCreatingClass || state.ui.bankMode === 'create';
                
                // Ch·ªâ render l·∫°i n·∫øu: Kh√¥ng ƒëang l√†m b√†i (HS) V√Ä Kh√¥ng ƒëang so·∫°n b√†i (GV)
                if (!state.ui.takingAssignmentId && !isTeacherBusy) {
                    if(state.view === 'assignments' || state.view === 'dashboard' || state.ui.viewAssignmentId || (state.ui.viewClassId && state.ui.viewClassMode !== 'students') || state.ui.viewMyClassId) {
                        renderApp();
                    }
                }
            });
            
            // 2. Submissions Listener
            onSnapshot(getRef('submissions'), (snap) => {
                state.data.submissions = snap.docs.map(d => ({id: d.id, ...d.data()}));
                
                // [FIX NH√ÅY CHO GI√ÅO VI√äN]: T∆∞∆°ng t·ª±, ch·∫∑n render khi ƒëang so·∫°n b√†i
                const isTeacherBusy = state.ui.isCreatingAssignment || state.ui.isCreatingClass || state.ui.bankMode === 'create';

                if (!state.ui.takingAssignmentId && !isTeacherBusy) {
                    if(state.view === 'assignments' || state.view === 'dashboard' || state.ui.viewSubmission || (state.ui.viewClassId && state.ui.viewClassMode === 'stats') || state.ui.viewMyClassId) {
                        renderApp();
                    }
                }
            });

            state.areAssignmentsListenersActive = true;
        }

const setupListeners = (uid) => {
            let isProfileLoaded = false; 

            // 1. Profile Listener
            onSnapshot(doc(db, getPath('users'), uid), (snap) => {
                if(snap.exists()) {
                 const newData = snap.data();
                   // [FIX L·ªñI M·∫§T B√ÄI T·∫¨P]: Gi·ªØ l·∫°i classIds ƒë√£ t√≠nh to√°n t·ª´ tr∆∞·ªõc n·∫øu c√≥
                    if (state.profile && state.profile.classIds) {
                        newData.classIds = state.profile.classIds;
                    }
                    
                    state.profile = newData;
                    if (!state.ui.isProcessingStudentCreation) {
                         // [FIX NH√ÅY]: T·ªïng h·ª£p c√°c tr·∫°ng th√°i b·∫≠n
                         const isBusy = state.ui.takingAssignmentId || state.ui.challengeMode === 'do' || 
                                        state.ui.isCreatingAssignment || state.ui.isCreatingClass || state.ui.bankMode === 'create';

                         if (!isBusy) renderApp(); 
                         else {
                             // C·∫≠p nh·∫≠t ng·∫ßm Header
                             const hs = document.getElementById('header-points'); if(hs) hs.textContent = state.profile.points;
                             const hstr = document.getElementById('header-streak'); if(hstr) hstr.textContent = state.profile.streak||0;
                         }
                    }
                    if (!isProfileLoaded && state.profile) { isProfileLoaded = true; initializeStudentDataListeners(uid); }
                } else if (state.user) { state.profile = null; renderApp(); }
            });
            
            // 2. Users Listener (N∆°i g√¢y ra l·ªói nh√°y khi h·ªçc sinh mua ƒë·ªì/quay s·ªë)
            onSnapshot(getRef('users'), (snap) => {
                state.data.users = snap.docs.map(d => ({id: d.id, ...d.data()}));
                
                // [FIX QUAN TR·ªåNG]: Th√™m c√°c c·ªù c·ªßa Gi√°o vi√™n v√†o bi·∫øn isBusy
                const isBusy = state.ui.takingAssignmentId || state.ui.challengeMode === 'do' || state.ui.competitionMode === 'playing' ||
                               state.ui.isCreatingAssignment || state.ui.isCreatingClass || state.ui.bankMode === 'create';
                
                if(!state.ui.isProcessingStudentCreation && !isBusy && (state.view === 'ranking' || state.ui.viewClassId || state.ui.viewMyClassId || state.view === 'challenges')) {
                    renderApp();
                }
            });

            // 3. Question Banks
            onSnapshot(getRef('question_banks'), (snap) => {
                state.data.questionBanks = snap.docs.map(d => ({id: d.id, ...d.data()}));
                // N·∫øu ƒëang t·∫°o bank (create mode) th√¨ kh√¥ng render l·∫°i ƒë·ªÉ tr√°nh m·∫•t d·ªØ li·ªáu nh·∫≠p
                if(state.view === 'question_bank' && state.ui.bankMode !== 'create') renderApp();
            });

            // 4. Classes
            onSnapshot(getRef('classes'), (snap) => {
                 const myClasses = snap.docs.map(d => ({id: d.id, ...d.data()}))
                 if (state.profile?.role === 'teacher') state.data.classes = myClasses.filter(c => c.teacherId === uid);
                 else if (state.profile?.role === 'student' && state.user) {
                     const sc = myClasses.filter(c => (c.studentIds || []).includes(uid));
                     if (state.profile) state.profile.classIds = sc.map(c => c.id); 
                     state.data.classes = sc;
                 }
                 // Ch·∫∑n render n·∫øu ƒëang t·∫°o l·ªõp
                 if(!state.ui.isCreatingClass && (state.view === 'classes' || state.ui.viewClassId || state.view === 'my_classes')) renderApp();
            });

// 5. Match Listener (ƒê√É FIX: C·∫¨P NH·∫¨T REALTIME CHO CH·∫æ ƒê·ªò XEM - SPECTATOR)
            onSnapshot(getRef('matches'), (snap) => {
                // 1. C·∫≠p nh·∫≠t d·ªØ li·ªáu th√¥
                state.data.matches = snap.docs.map(d => ({id: d.id, ...d.data()}));
                
                // 2. T√¨m tr·∫≠n ƒë·∫•u m√† b·∫£n th√¢n User ƒëang tham gia (n·∫øu c√≥)
                const newActiveMatch = state.data.matches.find(m => (m.player1?.uid === uid || m.player2?.uid === uid) && m.status !== 'finished');
                
                // 3. X·ª≠ l√Ω logic hi·ªÉn th·ªã k·∫øt qu·∫£ khi v·ª´a ƒë·∫•u xong (Gi·ªØ nguy√™n logic c≈©)
                if (state.ui.activeMatch && !newActiveMatch && state.ui.competitionMode !== 'spectating') {
                     const justFinished = state.data.matches.find(m => m.id === state.ui.activeMatch.id && m.status === 'finished');
                     const finalMatchData = state.ui.lastFinishedMatch || justFinished;
                     if (finalMatchData) {
                        const isP1 = finalMatchData.player1.uid === uid;
                        const myScore = isP1 ? finalMatchData.player1.score : finalMatchData.player2.score;
                        const opponentScore = isP1 ? finalMatchData.player2.score : finalMatchData.player1.score;
                        const p1Profile = state.data.users.find(u => u.uid === finalMatchData.player1.uid);
                        const p2Profile = state.data.users.find(u => u.uid === finalMatchData.player2?.uid);
                        const myInfo = isP1 ? p1Profile : p2Profile;
                        const oppInfo = isP1 ? p2Profile : p1Profile;
                        
                        let resultType = 'draw'; let bonusPoints = 0; let earnedTicket = false;
                        if (myScore > opponentScore) { 
                            resultType = 'win'; bonusPoints = 20; earnedTicket = true;
                            updateDoc(doc(db, getPath('users'), uid), { points: increment(20), luckyTickets: increment(1) }).catch(console.error); 
                            setTimeout(() => { if (typeof window.triggerConfetti === 'function') window.triggerConfetti(); }, 500);
                        } else if (myScore < opponentScore) { resultType = 'lose'; }
                        
                        if (state.ui.competitionMode === 'playing') {
                            state.ui.matchResult = { result: resultType, myScore, oppScore: opponentScore, bonus: bonusPoints, earnedTicket, myName: myInfo?.name||'B·∫°n', myAvatar: myInfo?.avatarUrl, myAvatarType: myInfo?.avatarType, oppName: oppInfo?.name||'ƒê·ªëi th·ªß', oppAvatar: oppInfo?.avatarUrl, oppAvatarType: oppInfo?.avatarType };
                        }
                     }
                }
                
                // 4. [FIX QUAN TR·ªåNG] C·∫¨P NH·∫¨T TR·∫†NG TH√ÅI UI
                if (state.ui.competitionMode === 'spectating') {
                    // --- LOGIC CHO GI√ÅO VI√äN (KH√ÅN GI·∫¢) ---
                    // N·∫øu ƒëang xem, h√£y t√¨m tr·∫≠n ƒë·∫•u ƒë√≥ trong d·ªØ li·ªáu M·ªöI NH·∫§T v√† c·∫≠p nh·∫≠t v√†o UI
                    if (state.ui.activeMatch) {
                        const updatedMatch = state.data.matches.find(m => m.id === state.ui.activeMatch.id);
                        if (updatedMatch) {
                            state.ui.activeMatch = updatedMatch; // C·∫≠p nh·∫≠t d·ªØ li·ªáu m·ªõi (ƒëi·ªÉm, m√°u...)
                        } else {
                            // N·∫øu tr·∫≠n ƒë·∫•u kh√¥ng c√≤n t·ªìn t·∫°i (ƒë√£ b·ªã x√≥a), tho√°t ra
                            state.ui.activeMatch = null;
                            state.ui.competitionMode = 'lobby';
                            showToast("Tr·∫≠n ƒë·∫•u ƒë√£ k·∫øt th√∫c ho·∫∑c b·ªã x√≥a.", "info");
                        }
                    }
                } else {
                    // --- LOGIC CHO NG∆Ø·ªúI CH∆†I (H·ªåC SINH) ---
                    // T·ª± ƒë·ªông chuy·ªÉn tr·∫°ng th√°i d·ª±a tr√™n tr·∫≠n ƒë·∫•u m√¨nh tham gia
                    state.ui.activeMatch = newActiveMatch;
                    if (state.ui.activeMatch) state.ui.competitionMode = state.ui.activeMatch.status === 'playing' ? 'playing' : 'waiting';
                    else if (state.ui.competitionMode === 'waiting' || state.ui.competitionMode === 'playing') state.ui.competitionMode = 'lobby';
                }

                // 5. Render l·∫°i giao di·ªán
                if (state.view === 'competition') {
                    const isTeacher = state.profile.role === 'teacher';
                    if (state.ui.competitionMode === 'lobby') {
                        if (isTeacher) { const c = document.getElementById('teacher-active-list'); if(!c) renderApp(); else updateTeacherDashboardUI(); } 
                        else { const c = document.getElementById('lobby-match-list'); if(!c) renderApp(); else updateLobbyUI(); }
                    } 
else if (state.ui.competitionMode === 'playing' || state.ui.competitionMode === 'spectating') {
                         if (state.ui.matchResult || state.ui.activeMatch?.status === 'finished') renderApp();
                         else { 
                             // C·∫≠p nh·∫≠t giao di·ªán ch∆°i/xem
                             const c = document.getElementById('match-playing-container'); 
                             if(!c) {
                                 // N·∫øu ch∆∞a c√≥ container (l·∫ßn ƒë·∫ßu v√†o), render to√†n b·ªô
                                 renderApp(); 
                             } else {
                                 // [FIXED] N·∫øu ƒë√£ c√≥ container, g·ªçi h√†m update c·ª•c b·ªô ƒë·ªÉ tr√°nh nh√°y
                                 if (state.ui.competitionMode === 'spectating') {
                                     // Thay v√¨: c.outerHTML = renderSpectatorView(...) -> G√¢y nh√°y
                                     // S·ª≠ d·ª•ng h√†m update m·ªõi:
                                     if (typeof window.updateSpectatorUI === 'function') {
                                         window.updateSpectatorUI();
                                     } else {
                                         // Fallback n·∫øu ch∆∞a ƒë·ªãnh nghƒ©a h√†m
                                         c.outerHTML = renderSpectatorView(state.ui.activeMatch);
                                     }
                                 } else {
                                     updatePlayingUI(); 
                                 }
                             } 
                         }
                    }
                    else if (state.ui.competitionMode === 'waiting') renderApp();
                }
            });
      
            // 6. Challenges Listener
            onSnapshot(getRef('challenges'), (snap) => {
                state.data.challenges = snap.docs.map(d => ({id: d.id, ...d.data()})).sort((a,b) => (a.order||0)-(b.order||0));
                // Ch·∫∑n render khi ƒëang l√†m b√†i ho·∫∑c so·∫°n b√†i
                const isTeacherBusy = state.ui.isCreatingAssignment || state.ui.isCreatingClass || state.ui.bankMode === 'create' || state.ui.challengeMode === 'create' || state.ui.challengeMode === 'edit';
                if(state.view === 'challenges' && state.ui.challengeMode !== 'do' && !isTeacherBusy) renderApp();
            });
            // 7. Assessments Listener (M·ªöI)
            onSnapshot(getRef('assessments'), (snap) => {
                state.data.assessments = snap.docs.map(d => ({id: d.id, ...d.data()}))
                    .sort((a,b) => (b.date?.seconds || 0) - (a.date?.seconds || 0)); // S·∫Øp x·∫øp m·ªõi nh·∫•t l√™n ƒë·∫ßu
                
                if(state.ui.viewClassMode === 'assessments') renderApp();
            });
             // 8. Report Comments Listener (M·ªöI: L∆ØU NH·∫¨N X√âT H·ªåC B·∫†)
            onSnapshot(getRef('report_comments'), (snap) => {
                state.data.reportComments = snap.docs.map(d => ({id: d.id, ...d.data()}));
                // N·∫øu ƒëang xem b√°o c√°o th√¨ render l·∫°i ƒë·ªÉ hi·ªán nh·∫≠n x√©t m·ªõi nh·∫•t
                if(state.ui.viewClassMode === 'student_report') renderApp();
            });
        };

        // --- Smart UI Update (Cho l·ªói Scroll Jump) ---
        const updateMainContent = () => {
            const mainEl = document.querySelector('main');
            if (mainEl) {
                mainEl.innerHTML = renderViewContent();
                renderIcons();
            }
            
            // RENDER MODAL NH·∫¨P D·ªÆ LI·ªÜU
            const appEl = document.getElementById('app');
            // C·∫ßn x√≥a modal import data c≈© tr∆∞·ªõc khi render l·∫°i
            const existingImportModal = document.querySelector('.fixed.inset-0.bg-slate-900.bg-opacity-70:not(#avatar-modal-container > div)');
            if (existingImportModal) existingImportModal.remove();

            if (state.ui.isImportingBankData) {
                 appEl.insertAdjacentHTML('beforeend', renderImportDataModal());
                 renderIcons();
            }
        }
        
const renderApp = () => {
    const appEl = document.getElementById('app');
    const modalEl = document.getElementById('avatar-modal-container');
    const overlayEl = document.getElementById('mobile-overlay');

    // --- [FIX QUAN TR·ªåNG: LU√îN X√ìA MODAL C≈® TR∆Ø·ªöC] ---
    const oldMatchModal = document.getElementById('match-result-modal');
    if (oldMatchModal) oldMatchModal.remove();

    const oldChalModal = document.getElementById('challenge-result-modal');
    if (oldChalModal) oldChalModal.remove();

    const oldStatsModal = document.getElementById('challenge-stats-modal');
    if (oldStatsModal) oldStatsModal.remove();
    // --------------------------------------------------
    
    // 1. M√†n h√¨nh Loading
    if (state.ui.isProcessingStudentCreation) {
         appEl.innerHTML = `
            <div class="fixed inset-0 bg-slate-900 bg-opacity-90 flex flex-col items-center justify-center z-50 text-white fade-in">
                <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-blue-500 mb-4"></div>
                <p class="text-xl font-bold">ƒêang x·ª≠ l√Ω...</p>
                <p class="text-sm text-slate-400 mt-2">Vui l√≤ng ch·ªù gi√¢y l√°t</p>
            </div>
        `;
        modalEl.innerHTML = '';
        return;
    }

    // 2. Ki·ªÉm tra ƒêƒÉng nh·∫≠p
    if (!state.isAuthReady || !state.user || !state.profile) {
        // N·∫øu ch∆∞a ƒëƒÉng nh·∫≠p -> Reset bi·∫øn ch·∫∑n popup ƒë·ªÉ l·∫ßn sau ƒëƒÉng nh·∫≠p s·∫Ω hi·ªán l·∫°i
        window.hasShownIntro = false; 
        
        appEl.innerHTML = renderAuthScreen();
        modalEl.innerHTML = '';
        renderIcons();
    } else {
        // 3. ƒê√£ ƒëƒÉng nh·∫≠p -> V√†o giao di·ªán ch√≠nh
        
        // Ch·ªâ render l·∫°i khung ch√≠nh n·∫øu ch∆∞a c√≥ (tr√°nh render l·∫°i to√†n b·ªô khi state thay ƒë·ªïi nh·ªè)
        if (!document.getElementById('main-layout-wrapper')) {
            appEl.innerHTML = renderMainLayout();
            }
            // --- [T√çNH NƒÇNG M·ªöI] ---
            // G·ªçi popup bi·ªÉu ƒë·ªì sau khi giao di·ªán ƒë√£ load xong (0.8 gi√¢y)
            setTimeout(() => {
                if (typeof showWelcomeStats === 'function') {
                    showWelcomeStats();
                }
            }, 1000);
            // -----------------------
        
        // Responsive Sidebar logic
        const sidebarEl = document.getElementById('sidebar-desktop');
        if (sidebarEl) {
            sidebarEl.classList.toggle('open', window.innerWidth < 1024 && state.ui.isSidebarOpen);
            sidebarEl.classList.toggle('collapsed', window.innerWidth >= 1024 && state.ui.isSidebarCollapsed);
        }
        if (overlayEl) {
            overlayEl.classList.toggle('open', window.innerWidth < 1024 && state.ui.isSidebarOpen);
        }
        
        // Update d·ªØ li·ªáu Header (ƒêi·ªÉm & Streak)
        const headerScoreEl = document.getElementById('header-points');
        if (headerScoreEl && state.profile) {
             headerScoreEl.textContent = state.profile.points;
        }
        
        const headerStreakEl = document.getElementById('header-streak');
        if (headerStreakEl && state.profile) {
             headerStreakEl.textContent = state.profile.streak || 0;
        }
        
        // C·∫≠p nh·∫≠t n·ªôi dung ch√≠nh (Tab B√†i t·∫≠p, X·∫øp h·∫°ng, v.v.)
        updateMainContent();
    }
    
    // 4. Render c√°c Modal ph·ª• (Avatar, Match, Challenge)
    if (state.ui.isAvatarModalOpen) {
        modalEl.innerHTML = renderAvatarModal();
        renderIcons();
    } else {
        modalEl.innerHTML = '';
    }

    if (state.ui.matchResult) {
        appEl.insertAdjacentHTML('beforeend', renderMatchResultModal());
        renderIcons();
    }
    
    if (state.ui.challengeResult) {
        appEl.insertAdjacentHTML('beforeend', renderChallengeResultModal());
        renderIcons();
    }
    
    if (state.ui.viewingChallengeStats) {
        appEl.insertAdjacentHTML('beforeend', renderChallengeStatsModal());
        renderIcons();
    }
};
        
        // --- 6. RENDERERS ---
// --- DASHBOARD ƒê·∫§U TR∆Ø·ªúNG D√ÄNH CHO GI√ÅO VI√äN (ƒê√É TH√äM ID ƒê·ªÇ C·∫¨P NH·∫¨T REALTIME) ---
// --- B·∫†N H√ÉY THAY TH·∫æ TO√ÄN B·ªò H√ÄM renderTeacherArenaDashboard B·∫∞NG ƒêO·∫†N N√ÄY ---
const renderTeacherArenaDashboard = () => {
    const allMatches = state.data.matches || [];
    const activeMatches = allMatches.filter(m => m.status === 'waiting' || m.status === 'playing');
    const finishedMatches = allMatches.filter(m => m.status === 'finished').sort((a,b) => b.createdAt - a.createdAt);

    return `
        <div class="max-w-6xl mx-auto space-y-8 fade-in">
            <div class="bg-gradient-to-r from-purple-600 to-indigo-600 rounded-2xl p-6 text-white shadow-lg flex justify-between items-center">
                <div>
                    <h2 class="text-2xl font-bold flex items-center gap-2"><i data-lucide="monitor" class="w-6 h-6"></i> Trung T√¢m Gi√°m S√°t</h2>
                    <p class="text-purple-100 text-sm mt-1">Theo d√µi v√† qu·∫£n l√Ω c√°c tr·∫≠n ƒë·∫•u</p>
                </div>
                <button onclick="createMatchFromBank()" class="bg-white text-purple-700 px-4 py-2 rounded-xl font-bold text-sm shadow-md hover:bg-purple-50 transition flex items-center gap-2">
                    <i data-lucide="plus-circle" size="16"></i> T·∫°o Ph√≤ng M·ªõi
                </button>
            </div>

            <div>
                <h3 class="text-xl font-bold text-slate-800 mb-4 flex items-center gap-2">
                    <span class="relative flex h-3 w-3">
                      <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span>
                      <span class="relative inline-flex rounded-full h-3 w-3 bg-green-500"></span>
                    </span>
                    ƒêang di·ªÖn ra (<span id="teacher-active-count">${activeMatches.length}</span>)
                </h3>
                
                <div id="teacher-active-list" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    ${activeMatches.length === 0 
                        ? `<div class="empty-message p-8 text-center text-slate-400 bg-slate-50 rounded-xl border border-dashed border-slate-300 col-span-full">Hi·ªán kh√¥ng c√≥ tr·∫≠n ƒë·∫•u n√†o ƒëang di·ªÖn ra.</div>`
                        : activeMatches.map(m => {
                            const isPlaying = m.status === 'playing';
                            // QUAN TR·ªåNG: Th√™m ID v√†o th·∫ª div n√†y ƒë·ªÉ kh·ªõp v·ªõi h√†m update
                            return `
                            <div id="teacher-match-${m.id}" class="bg-white p-4 rounded-xl shadow-sm border border-l-4 ${isPlaying ? 'border-l-green-500 border-slate-200' : 'border-l-yellow-500 border-slate-200'} flex flex-col sm:flex-row justify-between items-center gap-3 animate-in fade-in slide-in-from-bottom-2">
                                <div class="flex-1">
                                    <div class="flex items-center gap-2 mb-1">
                                        <span class="text-xs font-bold px-2 py-0.5 rounded text-white ${isPlaying ? 'bg-green-600' : 'bg-yellow-500'}">
                                            ${isPlaying ? 'ƒêANG ƒê·∫§U' : 'ƒêANG CH·ªú'}
                                        </span>
                                        <span class="font-mono font-bold text-slate-700">Ph√≤ng: ${m.roomCode}</span>
                                    </div>
                                    <div class="text-sm">
                                        <span class="text-blue-600 font-bold">${m.player1.name} (${m.player1.score || 0})</span> 
                                        <span class="text-slate-400 mx-1">vs</span> 
                                        <span class="text-red-600 font-bold">${m.player2 ? `${m.player2.name} (${m.player2.score || 0})` : '???'}</span>
                                    </div>
                                </div>
                                <div class="flex gap-2">
                                    <button onclick="watchMatch('${m.id}')" class="bg-indigo-50 text-indigo-700 hover:bg-indigo-100 border border-indigo-200 px-3 py-2 rounded-lg font-bold text-sm transition flex items-center gap-1">
                                        <i data-lucide="eye" size="16"></i> Xem
                                    </button>
                                    <button onclick="forceEndMatch('${m.id}', '${m.roomCode}')" class="bg-red-50 text-red-600 hover:bg-red-100 border border-red-200 px-3 py-2 rounded-lg font-bold text-sm transition flex items-center gap-1">
                                        <i data-lucide="square" size="16" class="fill-current"></i> K·∫øt th√∫c
                                    </button>
                                </div>
                            </div>`;
                        }).join('')
                    }
                </div>
            </div>

            <div class="bg-white rounded-2xl shadow-md border border-slate-200 overflow-hidden">
                <div class="p-4 border-b bg-slate-50 flex justify-between items-center">
                    <h3 class="font-bold text-slate-700 flex items-center gap-2">
                        <i data-lucide="history" size="18"></i> K·∫øt qu·∫£ g·∫ßn ƒë√¢y
                    </h3>
                    <button onclick="deleteAllMatchHistory()" class="bg-red-50 text-red-600 hover:bg-red-100 border border-red-200 px-3 py-1.5 rounded-lg font-bold text-xs transition flex items-center gap-1" ${finishedMatches.length === 0 ? 'disabled style="opacity:0.5;"' : ''}>
                        <i data-lucide="trash-2" size="14"></i> X√≥a t·∫•t c·∫£
                    </button>
                </div>
                <div class="overflow-x-auto max-h-96">
                    <table class="w-full">
                        <thead class="bg-slate-100 text-xs text-slate-500 uppercase sticky top-0">
                            <tr>
                                <th class="py-3 pl-4 text-left w-20">M√£</th>
                                <th class="py-3 text-left">Player 1</th>
                                <th class="py-3 text-center w-10"></th>
                                <th class="py-3 text-left">Player 2</th>
                                <th class="py-3 pr-4 text-right">Th·ªùi gian</th>
                                <th class="py-3 pr-4 text-right"></th>
                            </tr>
                        </thead>
                        <tbody id="teacher-history-list">
                            ${finishedMatches.length === 0
                                ? `<tr><td colspan="6" class="text-center text-slate-400 text-sm p-4">Ch∆∞a c√≥ d·ªØ li·ªáu l·ªãch s·ª≠.</td></tr>`
                                : finishedMatches.map(m => {
                                    const p1Win = m.player1.score > (m.player2 ? m.player2.score : 0);
                                    const p2Win = m.player2 && m.player2.score > m.player1.score;
                                    return `
                                    <tr class="border-b last:border-0 hover:bg-slate-50 group animate-in fade-in">
                                        <td class="py-3 pl-4 font-mono text-slate-500 text-xs">${m.roomCode}</td>
                                        <td class="py-3">
                                            <div class="flex items-center gap-2 text-sm">
                                                <span class="${p1Win ? 'font-bold text-blue-700' : 'text-slate-600'}">${m.player1.name}</span>
                                                <span class="text-xs bg-slate-100 px-1 rounded font-mono">${m.player1.score}</span>
                                            </div>
                                        </td>
                                        <td class="py-3 font-bold text-slate-300 text-xs text-center">VS</td>
                                        <td class="py-3">
                                            <div class="flex items-center gap-2 text-sm">
                                                <span class="${p2Win ? 'font-bold text-red-700' : 'text-slate-600'}">${m.player2 ? m.player2.name : 'N/A'}</span>
                                                <span class="text-xs bg-slate-100 px-1 rounded font-mono">${m.player2 ? m.player2.score : 0}</span>
                                            </div>
                                        </td>
                                        <td class="py-3 text-right pr-2 text-xs text-slate-400 w-24">
                                             ${m.createdAt ? new Date(m.createdAt.seconds * 1000).toLocaleTimeString('vi-VN', {hour:'2-digit', minute:'2-digit'}) : ''}
                                        </td>
                                        <td class="py-3 text-right pr-4 w-10">
                                            <button onclick="confirmDeleteMatchHistory('${m.id}')" class="text-slate-300 hover:text-red-500 transition p-1 rounded-md hover:bg-red-50">
                                                <i data-lucide="trash-2" size="16"></i>
                                            </button>
                                        </td>
                                    </tr>`;
                                }).join('')
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    `;
};

// --- GIAO DI·ªÜN KH√ÅN GI·∫¢ (CH·ªà XEM) - ƒê√É FIX ID ƒê·ªÇ C·∫¨P NH·∫¨T ---
        const renderSpectatorView = (match) => {
            if (!match) return `<div class="text-center mt-10">ƒêang k·∫øt n·ªëi...</div>`;
            const p1 = match.player1;
            const p2 = match.player2 || { name: 'ƒêang ch·ªù...', score: 0 };
            const totalQ = match.questions ? match.questions.length : 10;
            const currentQ = (match.qIndex || 0) + 1;

            const maxScore = totalQ * 10;
            const p1Percent = Math.min((p1.score / maxScore) * 100, 100);
            const p2Percent = Math.min((p2.score / maxScore) * 100, 100);

            return `
                <div id="match-playing-container" class="max-w-5xl mx-auto fade-in">
                    <div class="flex justify-between items-center mb-4">
                        <div class="bg-indigo-600 text-white px-4 py-1 rounded-full text-xs font-bold uppercase tracking-wider animate-pulse">
                            üî¥ Live Spectator Mode
                        </div>
                        <button onclick="stopSpectating()" class="bg-slate-200 hover:bg-red-100 text-slate-600 hover:text-red-600 px-4 py-2 rounded-lg font-bold text-sm transition flex items-center gap-2">
                            <i data-lucide="log-out" size="16"></i> Tho√°t
                        </button>
                    </div>

                    <div class="bg-white p-4 rounded-3xl shadow-lg mb-6 border-b-4 border-slate-200">
                        <div class="flex justify-between items-end mb-2 px-4">
                            <div class="text-left">
                                <p id="spec-p1-score" class="text-2xl font-black text-blue-600">${p1.score}</p>
                                <p class="text-sm font-bold text-slate-500">${p1.name}</p>
                            </div>
                            <div class="text-4xl font-black text-slate-200 italic">VS</div>
                            <div class="text-right">
                                <p id="spec-p2-score" class="text-2xl font-black text-red-600">${p2.score}</p>
                                <p class="text-sm font-bold text-slate-500">${p2.name}</p>
                            </div>
                        </div>
                        <div class="relative h-4 bg-slate-100 rounded-full overflow-hidden flex">
                            <div class="bg-gradient-to-r from-blue-400 to-blue-600 transition-all duration-500" style="width: ${p1Percent}%"></div>
                            <div class="absolute top-0 right-0 h-full bg-gradient-to-l from-red-400 to-red-600 transition-all duration-500" style="width: ${p2Percent}%"></div>
                        </div>
                    </div>

                    <div class="bg-white p-8 rounded-3xl shadow-xl text-center relative overflow-hidden">
                        <div class="absolute top-4 right-4 text-slate-300">
                            <i data-lucide="monitor" size="48"></i>
                        </div>
                        
                        <span id="q-counter" class="inline-block bg-slate-100 text-slate-600 px-3 py-1 rounded-lg text-xs font-bold mb-4">
                            C√¢u h·ªèi ${currentQ} / ${totalQ}
                        </span>

                        <h2 id="q-text" class="text-2xl md:text-3xl font-bold text-slate-800 mb-8 leading-relaxed">
                            ${match.status === 'waiting' ? 'ƒêang ch·ªù ng∆∞·ªùi ch∆°i th·ª© 2...' : (match.questions[match.qIndex]?.text || 'ƒêang t·∫£i...')}
                        </h2>

                        <div id="options-grid" class="grid grid-cols-1 md:grid-cols-2 gap-4 opacity-80 pointer-events-none" data-qid="-1">
                             ${match.status === 'playing' ? match.questions[match.qIndex].options.map((opt, i) => `
                                <div class="p-4 border-2 border-slate-100 rounded-xl text-lg font-medium text-slate-600 bg-slate-50">
                                    ${opt}
                                </div>
                             `).join('') : ''}
                        </div>
                        
                        <div id="audio-container" class="mt-6 opacity-0 h-0"></div>
                    </div>
                </div>
            `;
        };
const renderAuthScreen = () => {
            const isRegister = state.ui.authMode === 'register';
            // L·∫•y role hi·ªán t·∫°i ƒë·ªÉ gi·ªØ tr·∫°ng th√°i khi render l·∫°i
            const currentRole = document.querySelector('input[name="role"]:checked')?.value || 'student';
            
            return `
                <div class="min-h-screen bg-slate-900 flex items-center justify-center p-4 relative">
                    <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md fade-in relative z-10">
                        <div class="text-center mb-8">
                            <div class="bg-blue-600 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4">
                                <i data-lucide="book-open" class="text-white w-8 h-8"></i>
                            </div>
                            <h1 class="text-3xl font-bold text-slate-800">EduBattle</h1>
                            <p class="text-slate-500">N·ªÅn t·∫£ng h·ªçc t·∫≠p & thi ƒë·∫•u</p>
                        </div>
                        
                        <h2 class="text-2xl font-bold text-slate-800 mb-6 text-center">${isRegister ? 'ƒêƒÉng k√Ω t√†i kho·∫£n m·ªõi' : 'ƒêƒÉng nh·∫≠p'}</h2>
                        
                        <form onsubmit="${isRegister ? 'handleRegister(event)' : 'handleLogin(event)'}" class="space-y-4">
                            ${isRegister ? `
                                <div><input id="join-name" type="text" required class="w-full p-3 border rounded-lg focus:ring-blue-500 focus:border-blue-500" placeholder="H·ªç v√† t√™n"></div>
                                <div><input id="join-email" type="email" required class="w-full p-3 border rounded-lg focus:ring-blue-500 focus:border-blue-500" placeholder="Email"></div>
                                <div><input id="join-password" type="password" required class="w-full p-3 border rounded-lg focus:ring-blue-500 focus:border-blue-500" placeholder="M·∫≠t kh·∫©u"></div>
                                <div class="grid grid-cols-2 gap-4">
                                    <label class="cursor-pointer border p-2 rounded-lg text-center transition hover:bg-slate-100 ${currentRole === 'student' ? 'border-blue-500 bg-blue-50' : 'border-slate-200'}">
                                        <input type="radio" name="role" value="student" ${currentRole === 'student' ? 'checked' : ''} onchange="renderApp()" class="mr-1"> H·ªçc sinh
                                    </label>
                                    <label class="cursor-pointer border p-2 rounded-lg text-center transition hover:bg-slate-100 ${currentRole === 'teacher' ? 'border-purple-500 bg-purple-50' : 'border-slate-200'}">
                                        <input type="radio" name="role" value="teacher" ${currentRole === 'teacher' ? 'checked' : ''} onchange="renderApp()" class="mr-1"> Gi√°o vi√™n
                                    </label>
                                </div>
                                
                                ${currentRole === 'teacher' ? 
                                    '<input id="teacher-code" type="text" class="w-full p-3 border border-purple-300 rounded-lg focus:ring-purple-500 focus:border-purple-500" placeholder="M√£ gi√°o vi√™n (ruands10)">' : 
                                    '<input id="class-code-input" type="text" class="w-full p-3 border border-green-300 rounded-lg focus:ring-green-500 focus:border-green-500" placeholder="M√£ l·ªõp h·ªçc (T√πy ch·ªçn, 6 k√Ω t·ª±)">'}

                                <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-3 rounded-lg font-bold shadow-lg transition transform hover:-translate-y-0.5">ƒêƒÉng k√Ω t√†i kho·∫£n</button>
                            ` : `
                                <div><input id="login-email" type="email" required class="w-full p-3 border rounded-lg focus:ring-green-500 focus:border-green-500" placeholder="Email"></div>
                                <div><input id="login-password" type="password" required class="w-full p-3 border rounded-lg focus:ring-green-500 focus:border-green-500" placeholder="M·∫≠t kh·∫©u"></div>
                                <button type="submit" class="w-full bg-green-600 hover:bg-green-700 text-white py-3 rounded-lg font-bold shadow-lg transition transform hover:-translate-y-0.5">ƒêƒÉng nh·∫≠p</button>
                            `}
                        </form>

                        <div class="mt-6 pt-4 border-t text-center text-sm">
                            <button onclick="setAuthMode('${isRegister ? 'login' : 'register'}')" class="font-bold text-blue-600 hover:text-blue-700 transition">
                                ${isRegister ? 'ƒê√£ c√≥ t√†i kho·∫£n? ƒêƒÉng nh·∫≠p' : 'Ch∆∞a c√≥ t√†i kho·∫£n? ƒêƒÉng k√Ω ngay'}
                            </button>
                        </div>
                        
                        <div class="mt-4 text-center">
                            <button onclick="toggleBulkModal(true)" class="text-xs text-slate-500 underline hover:text-purple-600 transition">
                                <i data-lucide="users" size="14" class="inline"></i> T·∫°o t√†i kho·∫£n h·ªçc sinh h√†ng lo·∫°t (GV)
                            </button>
                        </div>
                    </div>

${state.ui.isBulkModalOpen ? `
                    <div class="fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50 p-4 fade-in">
                        <div class="bg-white rounded-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto p-6 md:p-8 relative">
                            
                            <div class="flex justify-between items-center mb-6 border-b pb-4 sticky top-0 bg-white z-10">
                                <h3 class="text-2xl font-bold text-purple-700">T·∫°o t√†i kho·∫£n h√†ng lo·∫°t</h3>
                                        <button onclick="toggleBulkModal(false)" 
                                        class="p-2 bg-slate-100 rounded-full text-slate-500 hover:bg-red-100 hover:text-red-600 transition shadow-sm"
                                        title="ƒê√≥ng">
                                    <i data-lucide="x" size="16"></i>
                                </button>
                            </div>

                            <div class="space-y-4">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-bold text-slate-700 mb-1">M√£ Gi√°o Vi√™n (*)</label>
                                        <input id="bulk-teacher-code" type="text" class="w-full p-2 border rounded-lg focus:border-purple-500" placeholder="Nh·∫≠p: ruands10">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-bold text-slate-700 mb-1">M·∫≠t kh·∫©u chung (*)</label>
                                        <input id="bulk-password" type="text" class="w-full p-2 border rounded-lg focus:border-purple-500" placeholder="VD: 123456">
                                    </div>
                                </div>

                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 bg-blue-50 p-4 rounded-xl border border-blue-100">
                                    <div>
                                        <label class="block text-sm font-bold text-blue-800 mb-1">T√™n L·ªõp h·ªçc (L√†m ƒëu√¥i Email)</label>
                                        <input id="bulk-class-name" type="text" class="w-full p-2 border rounded-lg" placeholder="VD: HN1">
                                        <p class="text-xs text-blue-600 mt-1">VD nh·∫≠p "HN1" -> email: ten_hn1@gmail.com</p>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-bold text-blue-800 mb-1">M√£ L·ªõp (ƒê·ªÉ tham gia)</label>
                                        <input id="bulk-class-code" type="text" class="w-full p-2 border rounded-lg" placeholder="VD: 123456">
                                        <p class="text-xs text-slate-500 mt-1">M√£ ƒë·ªÉ h·ªçc sinh nh·∫≠p v√†o khi tham gia l·ªõp</p>
                                    </div>
                                </div>

                                <div>
                                    <label class="block text-sm font-bold text-slate-700 mb-1">Danh s√°ch H·ªçc sinh (M·ªói t√™n 1 d√≤ng)</label>
                                    <textarea id="bulk-student-list" rows="5" class="w-full p-3 border rounded-lg font-medium" placeholder="Nguy·ªÖn VƒÉn A&#10;Tr·∫ßn Th·ªã B&#10;L√™ VƒÉn C"></textarea>
                                </div>

                               <div class="border-t pt-4">
                                    <p class="text-sm font-bold text-slate-700 mb-2">Ho·∫∑c t·∫£i l√™n file CSV (N√¢ng cao)</p>
                                    <input type="file" id="bulk-csv-file" accept=".csv" class="block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-purple-50 file:text-purple-700 hover:file:bg-purple-100"/>
                                    <p class="text-xs text-blue-600 mt-1 font-bold">C·∫•u tr√∫c: T√™n HS, Email, M√£ l·ªõp, T√™n l·ªõp, M·∫≠t kh·∫©u (T√πy ch·ªçn)</p>
                                </div>

                                <div class="flex gap-3 pt-4 border-t mt-4">
                                    <button onclick="toggleBulkModal(false)" class="flex-1 py-3 rounded-xl font-bold text-slate-600 bg-slate-100 hover:bg-slate-200 transition">
                                        H·ªßy b·ªè
                                    </button>
                                    <button onclick="handleBulkCreate()" class="flex-[2] bg-purple-600 hover:bg-purple-700 text-white py-3 rounded-xl font-bold text-lg shadow-lg flex items-center justify-center gap-2 transition">
                                        <i data-lucide="user-plus"></i> B·∫Øt ƒë·∫ßu t·∫°o
                                    </button>
                                </div>
                                
                                <p id="bulk-status" class="text-center text-sm font-bold mt-2 text-slate-600"></p>
                            </div>
                        </div>
                    </div>` : ''}
                    </div>
            `;
        };

const renderMainLayout = () => {
            const isDesktop = window.innerWidth >= 1024;
            const isCollapsed = state.ui.isSidebarCollapsed && isDesktop;
            
            // [M·ªöI] T√≠nh c·∫•p ƒë·ªô hi·ªán t·∫°i c·ªßa User
            const currentLevel = getUserLevel(state.profile.points || 0);

            return `
                <div id="main-layout-wrapper" class="flex h-screen bg-slate-50 overflow-hidden">
                    
                    <div id="sidebar-desktop" class="bg-slate-900 text-slate-300 flex flex-col shadow-xl flex-shrink-0 lg:w-64 transition-all duration-300 ${state.ui.isSidebarOpen ? 'open' : ''} ${isCollapsed ? 'collapsed' : ''}">
                        <div class="p-4 lg:p-6 border-b border-slate-800 flex items-center gap-3">
                            <div class="bg-blue-600 p-2 rounded-lg"><i data-lucide="book-open" class="text-white w-5 h-5"></i></div>
                            <h1 class="text-xl font-bold text-white app-title">EduBattle</h1>
                            <button onclick="toggleCollapse()" class="text-slate-500 hover:text-white transition hidden lg:block ml-auto ${isCollapsed ? 'rotate-180' : ''}">
                                <i data-lucide="chevrons-left" size="20"></i>
                            </button>
                        </div>
                        <nav class="flex-1 p-4 space-y-2 overflow-y-auto">
                            ${renderNavItem('dashboard', 'layout-dashboard', 'T·ªïng quan', isCollapsed)}
                            ${state.profile.role === 'teacher' ? renderNavItem('classes', 'graduation-cap', 'Qu·∫£n l√Ω L·ªõp h·ªçc', isCollapsed) : ''}
                            ${state.profile.role === 'student' ? renderNavItem('my_classes', 'graduation-cap', 'L·ªõp c·ªßa t√¥i', isCollapsed) : ''}
                            ${renderNavItem('assignments', 'book-open', 'B√†i t·∫≠p', isCollapsed)}
                            ${state.profile.role === 'teacher' ? renderNavItem('question_bank', 'library', 'Ng√¢n h√†ng ƒë·ªÅ', isCollapsed) : ''}
                            ${renderNavItem('competition', 'swords', 'ƒê·∫•u tr∆∞·ªùng', isCollapsed)}
                            ${renderNavItem('challenges', 'mountain-snow', 'Th·ª≠ th√°ch', isCollapsed)}
                            ${renderNavItem('game_center', 'gamepad-2', 'Gi·∫£i tr√≠ & Qu√†', isCollapsed)}
                            ${renderNavItem('ranking', 'trophy', 'X·∫øp h·∫°ng', isCollapsed)}
                            ${state.profile.role === 'teacher' ? renderNavItem('backup', 'database', 'Sao l∆∞u & Kh√¥i ph·ª•c', isCollapsed) : ''}
                        </nav>
                        <div class="p-4 border-t border-slate-800">
                            <div class="flex items-center gap-3 mb-4 px-2 group cursor-pointer profile-wrapper" onclick="toggleAvatarModal(true)">
                                ${renderAvatar(state.profile, 'w-10 h-10', 'text-base')}
                                <div class="overflow-hidden profile-details">
                                    <p class="text-sm font-medium text-white truncate group-hover:text-blue-400 transition">
                                        ${state.profile.name} <span title="${currentLevel.name}">${currentLevel.icon}</span>
                                    </p>
                                    <p class="text-xs text-slate-400 capitalize">${state.profile.role === 'teacher' ? 'Gi√°o vi√™n' : 'H·ªçc sinh'}</p>
                                </div>
                                <i data-lucide="pencil" size="16" class="text-slate-500 group-hover:text-blue-400 transition ml-auto profile-details"></i>
                            </div>
                            <button onclick="handleSignOut()" class="w-full flex items-center gap-2 px-4 py-2 text-sm text-red-400 hover:bg-slate-800 rounded-lg transition-colors logout-btn">
                                <i data-lucide="log-out" size="16"></i> <span class="logout-text">ƒêƒÉng xu·∫•t</span>
                            </button>
                        </div>
                    </div>

                    <div class="flex-1 flex flex-col min-w-0">
                        <header class="bg-white shadow-md lg:shadow-sm px-4 lg:px-8 py-3 lg:py-4 flex justify-between items-center z-10">
                            <button onclick="toggleSidebar(true)" class="lg:hidden text-slate-700 hover:text-blue-600 mr-3">
                                <i data-lucide="menu" size="24"></i>
                            </button>
                            <h2 class="text-xl md:text-2xl font-bold text-slate-800 capitalize truncate">
                                ${state.view === 'dashboard' ? 'T·ªïng quan' : 
                                  state.view === 'classes' ? 'Qu·∫£n l√Ω L·ªõp h·ªçc' : 
                                  state.view === 'my_classes' ? 'L·ªõp c·ªßa t√¥i' : 
                                  state.view === 'assignments' ? 'B√†i t·∫≠p v·ªÅ nh√†' :
                                  state.view === 'question_bank' ? 'Ng√¢n h√†ng ƒë·ªÅ' :
                                  state.view === 'competition' ? 'ƒê·∫•u tr∆∞·ªùng tr·ª±c tuy·∫øn' : 
                                  state.view === 'challenges' ? 'Chinh ph·ª•c Th·ª≠ th√°ch' : 
                                  state.view === 'game_center' ? 'Trung t√¢m Gi·∫£i tr√≠' : 'B·∫£ng x·∫øp h·∫°ng'}
                            </h2>
                            
                            <div class="flex items-center gap-2 md:gap-3">
                                <div class="hidden md:flex px-3 py-1 bg-indigo-50 text-indigo-700 border border-indigo-100 rounded-full text-sm font-bold items-center gap-1.5 shadow-sm" title="C·∫•p ƒë·ªô: ${currentLevel.name}">
                                    <span class="text-lg">${currentLevel.icon}</span> 
                                    <span class="hidden lg:inline">${currentLevel.name}</span>
                                </div>

                                <div class="px-3 py-1 bg-yellow-100 text-yellow-700 rounded-full text-sm font-bold flex items-center gap-1.5 shadow-sm">
                                    <i data-lucide="trophy" size="14"></i> 
                                    <span class="hidden md:inline">ƒêi·ªÉm:</span> 
                                    <span id="header-points">${state.profile.points}</span>
                                </div>
                                <div class="px-3 py-1 bg-orange-100 text-orange-700 rounded-full text-sm font-bold flex items-center gap-1.5 shadow-sm" title="Chu·ªói ng√†y li√™n t·ª•c">
                                    <i data-lucide="flame" size="14" class="fill-orange-500"></i> 
                                    <span class="hidden md:inline">Streak:</span> 
                                    <span id="header-streak">${state.profile.streak || 0}</span>
                                </div>
                            </div>
                        </header>
                        
                        <main class="flex-1 overflow-y-auto p-4 lg:p-8 pb-16 lg:pb-8 fade-in">
                            ${renderViewContent()}
                        </main>
                        
                        <nav id="mobile-bottom-nav" class="fixed bottom-0 left-0 right-0 lg:hidden bg-white border-t border-slate-200 shadow-2xl z-20 h-16">
                            <div class="flex justify-around items-center h-full">
                                ${renderMobileNavItem('dashboard', 'layout-dashboard', 'T·ªïng quan')}
                                ${state.profile.role === 'teacher' ? renderMobileNavItem('classes', 'graduation-cap', 'L·ªõp h·ªçc') : ''}
                                ${state.profile.role === 'student' ? renderMobileNavItem('my_classes', 'graduation-cap', 'L·ªõp c·ªßa t√¥i') : ''}
                                ${renderMobileNavItem('assignments', 'book-open', 'B√†i t·∫≠p')}
                                ${renderMobileNavItem('competition', 'swords', 'ƒê·∫•u tr∆∞·ªùng')}
                                ${renderMobileNavItem('game_center', 'gamepad-2', 'Game')}
                            </div>
                        </nav>
                    </div>
                </div>
            `;
        };

        const renderNavItem = (viewName, icon, label, isCollapsed) => `
            <button onclick="changeView('${viewName}')" class="w-full flex items-center nav-item gap-3 px-4 py-3 rounded-xl transition-all ${state.view === viewName ? 'bg-blue-600 text-white shadow-lg' : 'hover:bg-slate-800'}">
                <i data-lucide="${icon}" size="20"></i> <span class="font-medium sidebar-label">${label}</span>
            </button>
        `;
        
        // M·ªöI: Render Nav Item cho Mobile Bottom Bar
        const renderMobileNavItem = (viewName, icon, label) => `
            <button onclick="changeView('${viewName}')" class="flex flex-col items-center justify-center p-2 transition-colors ${state.view === viewName ? 'text-blue-600' : 'text-slate-500 hover:text-blue-500'}">
                <i data-lucide="${icon}" size="20"></i>
                <span class="text-xs font-medium">${label}</span>
            </button>
        `;


        const renderViewContent = () => {
            switch(state.view) {
                case 'dashboard': return renderDashboard();
                case 'classes': return renderClasses(); 
                case 'my_classes': return renderMyClasses(); // <-- NEW: Student class view
                case 'assignments': return renderAssignments();
                case 'question_bank': return renderQuestionBank();
                case 'competition': return renderCompetition();
                case 'challenges': return renderChallenges(); // [M·ªöI]
                case 'ranking': return renderRanking();
                case 'game_center': return renderGameCenter();
                case 'backup': return renderBackupScreen();
                default: return '';
            }
        };
        
// DASHBOARD (C·∫≠p nh·∫≠t: Th√™m n√∫t Th·ª≠ th√°ch b√™n c·∫°nh ƒê·∫•u tr∆∞·ªùng)
        const renderDashboard = () => {
            const mySubmissions = state.data.submissions.filter(s => s.studentId === state.user.uid);
            const myAssignments = state.data.assignments;
            
            const pending = myAssignments.filter(a => 
                 !state.data.submissions.some(s => s.assignmentId === a.id && s.studentId === state.user.uid)
            ).length;
            
            return `
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 lg:gap-6 mb-6 lg:mb-8">
                    <div class="bg-white p-5 rounded-xl shadow-md border border-slate-100 flex items-center gap-4">
                        <div class="p-3 rounded-xl bg-yellow-50 text-yellow-500"><i data-lucide="trophy" size="24"></i></div>
                        <div><p class="text-slate-500 text-sm">ƒêi·ªÉm t√≠ch l≈©y</p><p class="text-xl md:text-2xl font-bold text-slate-800">${state.profile.points}</p></div>
                    </div>
                    <div class="bg-white p-5 rounded-xl shadow-md border border-slate-100 flex items-center gap-4">
                        <div class="p-3 rounded-xl bg-green-50 text-green-500"><i data-lucide="check-circle" size="24"></i></div>
                        <div><p class="text-slate-500 text-sm">B√†i t·∫≠p ƒë√£ l√†m</p><p class="text-xl md:text-2xl font-bold text-slate-800">${mySubmissions.length}</p></div>
                    </div>
                    <div class="bg-white p-5 rounded-xl shadow-md border border-slate-100 flex items-center gap-4">
                        <div class="p-3 rounded-xl bg-orange-50 text-orange-500"><i data-lucide="clock" size="24"></i></div>
                        <div><p class="text-slate-500 text-sm">B√†i t·∫≠p ch·ªù</p><p class="text-xl md:text-2xl font-bold text-slate-800">${Math.max(0, pending)}</p></div>
                    </div>
                </div>

                <div class="bg-gradient-to-r from-blue-600 to-indigo-700 rounded-2xl p-6 md:p-8 text-white shadow-xl flex flex-col lg:flex-row items-start lg:items-center justify-between relative overflow-hidden">
                    <div class="lg:max-w-2xl relative z-10">
                        <h3 class="text-xl md:text-3xl font-bold mb-2">Xin ch√†o, ${state.profile.name}!</h3>
                        <p class="text-blue-100 text-sm md:text-base mb-6">
                            ${state.profile.role === 'student' ? 'H√¥m nay b·∫°n mu·ªën chinh ph·ª•c ki·∫øn th·ª©c n√†o?' : 'Qu·∫£n l√Ω l·ªõp h·ªçc v√† t·∫°o b√†i t·∫≠p m·ªõi.'}
                        </p>
                        
                        <div class="flex flex-wrap gap-3">
                            <button onclick="changeView('assignments')" class="bg-white text-blue-700 px-5 py-2.5 rounded-xl font-bold hover:bg-blue-50 transition text-sm shadow-md">
                                ${state.profile.role === 'student' ? 'B√†i t·∫≠p v·ªÅ nh√†' : 'T·∫°o b√†i t·∫≠p'}
                            </button>
                            
                            <button onclick="changeView('competition')" class="bg-indigo-500 text-white border border-indigo-400 px-5 py-2.5 rounded-xl font-bold hover:bg-indigo-600 transition flex items-center gap-2 text-sm shadow-md">
                                <i data-lucide="swords" size="18"></i> ƒê·∫•u tr∆∞·ªùng
                            </button>

                            <button onclick="changeView('challenges')" class="bg-orange-500 text-white border border-orange-400 px-5 py-2.5 rounded-xl font-bold hover:bg-orange-600 transition flex items-center gap-2 text-sm shadow-md ">
                                <i data-lucide="mountain-snow" size="18"></i> Th·ª≠ th√°ch
                            </button>
                        </div>
                    </div>
                    
                    <i data-lucide="trophy" class="w-32 h-32 text-white opacity-10 absolute -bottom-4 -right-4 lg:static lg:opacity-20 lg:block flex-shrink-0"></i>
                </div>
            `;
        };

        // M·ªöI: STUDENT CLASSES RENDERERS
        
        const renderMyClasses = () => {
            if (state.profile.role !== 'student') return `<p class="text-red-500">B·∫°n kh√¥ng c√≥ quy·ªÅn truy c·∫≠p t√≠nh nƒÉng n√†y.</p>`;

            const myClasses = state.data.classes;
            
            // If viewing a specific class detail
            if (state.ui.viewMyClassId) {
                return renderMyClassDetails(state.ui.viewMyClassId);
            }
            
            // If join class modal is open
            if (state.ui.isJoiningClass) {
                 return renderJoinClassModal();
            }

            const list = myClasses.map(c => {
                const teacherProfile = state.data.users.find(u => u.uid === c.teacherId);

                return `
                    <div class="bg-white p-5 rounded-xl shadow-md border border-slate-100 hover:shadow-lg transition">
                        <div class="flex justify-between items-center mb-3">
                            <div class="bg-blue-100 p-2 rounded-lg text-blue-600"><i data-lucide="school" size="20"></i></div>
                            <span class="text-xs font-bold text-blue-600 bg-blue-100 px-3 py-1 rounded-full">${c.classCode || 'N/A'}</span>
                        </div>
                        <h4 class="text-lg font-bold text-slate-800 mb-1 truncate">${c.title}</h4>
                        <p class="text-slate-500 text-sm mb-4">Gi√°o vi√™n: ${teacherProfile ? teacherProfile.name : 'ƒêang c·∫≠p nh·∫≠t'}</p>
                        <button onclick="viewMyClassDetails('${c.id}')" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-2 rounded-lg font-medium transition flex items-center justify-center gap-2 text-sm">
                            <i data-lucide="eye" size="12"></i> Chi ti·∫øt
                        </button>
                    </div>
                `;
            }).join('');

            return `
                <div class="flex flex-wrap gap-4 mb-6">
                    <h3 class="text-2xl font-bold text-slate-800 flex-1 min-w-full lg:min-w-0">Danh s√°ch L·ªõp h·ªçc c·ªßa t√¥i (${myClasses.length})</h3>
                    <button onclick="toggleJoinClass(true)" class="bg-green-600 hover:bg-green-700 text-white px-5 py-2 md:px-6 md:py-3 rounded-xl font-bold shadow-md flex items-center gap-2 text-sm md:text-base">
                        <i data-lucide="plus-circle"></i> Th√™m m√£ v√†o l·ªõp
                    </button>
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 lg:gap-6">
                    ${list || `<p class="text-slate-500">B·∫°n ch∆∞a tham gia l·ªõp h·ªçc n√†o. Vui l√≤ng h·ªèi gi√°o vi√™n m√£ l·ªõp.</p>`}
                </div>
            `;
        };

        const renderJoinClassModal = () => {
             return `
                <div class="max-w-sm mx-auto bg-white p-6 md:p-8 rounded-2xl shadow-xl text-center fade-in">
                    <div class="flex justify-between items-center mb-6 border-b pb-4">
                        <h3 class="text-xl md:text-2xl font-bold text-green-600">Tham gia L·ªõp h·ªçc</h3>
                        <button onclick="toggleJoinClass(false)" class="text-slate-500 hover:text-red-500"><i data-lucide="x"></i></button>
                    </div>
                    <p class="text-slate-600 mb-4 text-sm">Nh·∫≠p m√£ l·ªõp h·ªçc (6 k√Ω t·ª±) do gi√°o vi√™n cung c·∫•p.</p>
                    <input type="text" id="join-class-code-input" class="w-full p-4 border-2 border-slate-300 rounded-xl text-center text-xl font-bold tracking-widest uppercase mb-4 focus:border-green-500" maxlength="6" placeholder="M√£ L·ªõp">
                    <button onclick="handleJoinClass()" class="w-full bg-green-600 text-white py-3 rounded-xl font-bold mb-4 transition hover:bg-green-700">Tham Gia L·ªõp</button>
                </div>
             `;
        };
        
        const renderMyClassDetails = (classId) => {
            const classData = state.data.classes.find(c => c.id === classId);
            if (!classData) return `<p class="text-red-500">Kh√¥ng t√¨m th·∫•y l·ªõp h·ªçc.</p>`;
            
            const teacherProfile = state.data.users.find(u => u.uid === classData.teacherId);
            const classStudents = (classData.studentIds || [])
                .map(sid => state.data.users.find(u => u.uid === sid))
                .filter(u => u); // Filter out null/undefined profiles
            
            // 1. Danh s√°ch b√†i t·∫≠p c·∫ßn l√†m (Pending Assignments)
            const pendingAssignments = state.data.assignments.filter(a => 
                 // B√†i t·∫≠p ph·∫£i ƒë∆∞·ª£c giao cho l·ªõp n√†y
                (a.classIds || []).includes(classId) &&
                 // V√† h·ªçc sinh ch∆∞a n·ªôp b√†i
                !state.data.submissions.some(s => s.assignmentId === a.id && s.studentId === state.user.uid)
            );

            // 2. Danh s√°ch h·ªçc sinh v√† ƒëi·ªÉm s·ªë
            // S·∫Øp x·∫øp h·ªçc sinh theo ƒëi·ªÉm ƒë·ªÉ l√†m b·∫£ng x·∫øp h·∫°ng l·ªõp
            const sortedStudents = [...classStudents].sort((a, b) => (b.points||0) - (a.points||0));

            const studentListHtml = sortedStudents.map((s, idx) => {
                const isMe = s.uid === state.user.uid;
                const rowClass = isMe ? 'bg-blue-50 border-blue-200 hover:bg-blue-100' : 'hover:bg-slate-50';
                
                return `
                    <tr class="border-b last:border-0 ${rowClass} transition">
                        <td class="py-3 pl-4 font-bold text-slate-500 w-16 text-center">${idx + 1}</td>
                        <td class="py-3 flex items-center gap-3">
                            ${renderAvatar(s, 'w-8 h-8', 'text-sm')}
                            <span class="font-medium ${isMe ? 'text-blue-700' : 'text-slate-700'} truncate">${s.name} ${isMe ? '(B·∫°n)' : ''}</span>
                        </td>
                        <td class="py-3 pr-4 text-right font-bold text-lg text-yellow-600">${s.points || 0}</td>
                    </tr>
                `;
            }).join('');
            
            const pendingListHtml = pendingAssignments.map(a => `
                <div class="bg-white p-4 rounded-xl shadow-sm border border-orange-100 flex justify-between items-center hover:bg-orange-50 transition">
                    <p class="font-medium text-slate-700 truncate">${a.title} (${a.questions.length} c√¢u)</p>
                    <button onclick="changeView('assignments'); startAssignment('${a.id}')" 
                            class="bg-orange-500 hover:bg-orange-600 text-white px-4 py-1.5 rounded-lg font-bold text-xs flex-shrink-0">
                        L√†m ngay
                    </button>
                </div>
            `).join('');

            return `
                <div class="max-w-4xl mx-auto bg-white p-4 md:p-8 rounded-2xl shadow-lg fade-in">
                    <div class="flex justify-between items-start mb-6 border-b pb-4">
                        <div class="flex flex-col">
                            <h3 class="text-2xl md:text-3xl font-bold text-blue-600">${classData.title}</h3>
                            <p class="text-slate-500 text-sm">Gi√°o vi√™n: ${teacherProfile ? teacherProfile.name : 'N/A'}</p>
                            <p class="text-slate-500 text-sm mt-1">M√£ l·ªõp: <span class="font-bold text-blue-600">${classData.classCode}</span></p>
                        </div>
                        <button onclick="viewMyClassDetails(null)" class="text-slate-500 hover:text-red-500 flex-shrink-0"><i data-lucide="x"></i></button>
                    </div>
                    
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <!-- C·ªôt 1: Danh s√°ch B√†i t·∫≠p c·∫ßn l√†m -->
                        <div>
                            <h4 class="text-xl font-bold text-slate-700 mb-4 flex items-center gap-2">
                                <i data-lucide="clipboard-list" class="text-orange-500"></i> B√†i t·∫≠p c·∫ßn l√†m (${pendingAssignments.length})
                            </h4>
                            <div class="space-y-3 max-h-96 overflow-y-auto pr-2">
                                ${pendingListHtml || '<div class="p-4 bg-green-50 text-green-700 rounded-xl font-medium">üéâ Ho√†n th√†nh h·∫øt r·ªìi!</div>'}
                            </div>
                            <div class="mt-6">
                                <button onclick="changeView('assignments')" class="w-full bg-blue-100 text-blue-700 py-2.5 rounded-xl font-bold hover:bg-blue-200 transition text-sm">
                                    Xem t·∫•t c·∫£ B√†i t·∫≠p ƒë√£ giao
                                </button>
                            </div>
                        </div>

                        <!-- C·ªôt 2: Danh s√°ch H·ªçc sinh & ƒêi·ªÉm -->
                        <div>
                            <h4 class="text-xl font-bold text-slate-700 mb-4 flex items-center gap-2">
                                <i data-lucide="trophy" class="text-yellow-600"></i> B·∫£ng x·∫øp h·∫°ng L·ªõp (${classStudents.length} h·ªçc sinh)
                            </h4>
                            <div class="bg-slate-50 rounded-xl overflow-hidden shadow-inner border">
                                <div class="overflow-x-auto">
                                    <table class="w-full min-w-[300px]">
                                        <thead>
                                            <tr class="text-left text-slate-500 text-sm border-b bg-slate-100">
                                                <th class="pb-3 pt-3 pl-4 w-16 text-center">H·∫°ng</th>
                                                <th class="pb-3 pt-3">H·ªçc sinh</th>
                                                <th class="pb-3 pt-3 pr-4 text-right">ƒêi·ªÉm s·ªë</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${studentListHtml}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        };

        // M·ªöI: CLASSES MANAGEMENT RENDERERS (Gi√°o vi√™n)

// M·ªöI: CLASSES MANAGEMENT RENDERERS (Gi√°o vi√™n)
        const renderClasses = () => {
            const isTeacher = state.profile.role === 'teacher';
            if (!isTeacher) return `<p class="text-red-500">B·∫°n kh√¥ng c√≥ quy·ªÅn truy c·∫≠p t√≠nh nƒÉng n√†y.</p>`;

            // --- [FIX L·ªñI QUAN TR·ªåNG] TH√äM ƒêO·∫†N N√ÄY ƒê·ªÇ HI·ªÇN TH·ªä CHI TI·∫æT B√ÄI L√ÄM ---
            if (state.ui.viewSubmission) {
                return renderSubmissionResult();
            }
            // -----------------------------------------------------------------------

            if (state.ui.viewClassId && (state.ui.isCreatingAssignment || state.ui.viewAssignmentId)) {
                // NESTED VIEW: N·∫øu ƒëang ·ªü ch·∫ø ƒë·ªô xem l·ªõp nh∆∞ng l·∫°i ƒëang t·∫°o/s·ª≠a assignment
                 if (state.ui.isCreatingAssignment) {
                     if (state.ui.isSelectingBankQuestions) {
                         return renderQuestionSelectionFromBank(); 
                     }
                     return renderCreateAssignmentForm();
                 }
                 if (state.ui.viewAssignmentId) {
                     return renderAssignmentDetails(); 
                 }
            }
            
            if (state.ui.viewClassId) {
                return renderViewClass(state.ui.viewClassId);
            }
            if (state.ui.isCreatingClass) {
                return renderCreateClassForm();
            }

            const myClasses = state.data.classes;

            const list = myClasses.map(c => {
                const studentCount = (c.studentIds ? c.studentIds.length : 0);

                return `
                    <div class="bg-white p-5 rounded-xl shadow-md border border-slate-100 hover:shadow-lg transition">
                        <div class="flex justify-between items-center mb-3">
                            <div class="bg-green-100 p-2 rounded-lg text-green-600"><i data-lucide="graduation-cap" size="20"></i></div>
                            <span class="text-xs font-bold text-green-600 bg-green-100 px-3 py-1 rounded-full">${c.classCode || 'N/A'}</span>
                        </div>
                        <h4 class="text-lg font-bold text-slate-800 mb-1 truncate">${c.title}</h4>
                        <p class="text-slate-500 text-sm mb-4">${studentCount} H·ªçc sinh</p>
                        <div class="flex gap-2 text-sm">
                            <button onclick="viewClass('${c.id}')" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white py-2 rounded-lg font-medium transition">
                                <i data-lucide="eye" size="12" class="inline mr-1"></i> Xem chi ti·∫øt
                            </button>
                            <button onclick="confirmDeleteClass('${c.id}', '${c.title}')" class="p-2 bg-red-100 text-red-600 rounded-lg hover:bg-red-200 transition">
                                <i data-lucide="trash-2" size="12"></i>
                            </button>
                        </div>
                    </div>
                `;
            }).join('');

            return `
                <button onclick="toggleCreateClass(true)" class="mb-6 bg-green-600 hover:bg-green-700 text-white px-5 py-2 md:px-6 md:py-3 rounded-xl font-bold shadow-md flex items-center gap-2 text-sm md:text-base">
                    <i data-lucide="plus-circle"></i> T·∫°o L·ªõp h·ªçc m·ªõi
                </button>
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 lg:gap-6">
                    ${list || '<p class="text-slate-500">B·∫°n ch∆∞a t·∫°o l·ªõp h·ªçc n√†o.</p>'}
                </div>
            `;
        };
        const renderCreateClassForm = () => {
            return `
                <div class="max-w-xl mx-auto bg-white p-6 md:p-8 rounded-2xl shadow-lg fade-in">
                    <div class="flex justify-between items-center mb-6 border-b pb-4">
                        <h3 class="text-xl md:text-2xl font-bold text-green-600">T·∫°o L·ªõp h·ªçc m·ªõi</h3>
                        <button onclick="toggleCreateClass(false)" class="text-slate-500 hover:text-red-500"><i data-lucide="x"></i></button>
                    </div>
                    <label for="class-title" class="block text-sm font-medium text-slate-700 mb-1">T√™n L·ªõp h·ªçc</label>
                    <input id="class-title" type="text" class="w-full p-3 border-2 rounded-lg text-base md:text-lg mb-6 focus:border-green-500" placeholder="V√≠ d·ª•: L·ªõp H√°n ng·ªØ 101">
                    <button onclick="handleCreateClass()" class="w-full bg-green-600 text-white py-3 rounded-xl font-bold hover:bg-green-700 transition">L∆∞u L·ªõp h·ªçc</button>
                </div>
            `;
        };
        
        // Helper to render student list
// --- C·∫¨P NH·∫¨T: TH√äM C·ªòT ƒêI·ªÇM V√Ä N√öT S·ª¨A ƒêI·ªÇM ---
const renderClassStudents = (classData, studentList) => {
            const studentRows = studentList.map(s => {
                const studentProfile = state.data.users.find(u => u.uid === s.uid);
                const currentPoints = studentProfile ? (studentProfile.points || 0) : 0;
                
                return `
                    <tr class="border-b last:border-0 hover:bg-slate-50 transition">
                        <td class="py-3 pl-4 flex items-center gap-3">
                            ${renderAvatar(studentProfile, 'w-8 h-8', 'text-sm')}
                            <span class="font-medium text-slate-700 truncate">${s.name}</span>
                        </td>
                        <td class="py-3 text-slate-500 hidden md:table-cell truncate">${s.email}</td>
                        
                        <td class="py-3 text-center">
                            <div class="flex items-center justify-center gap-2">
                                <span class="font-bold text-yellow-600 text-lg bg-yellow-50 px-3 py-1 rounded-lg border border-yellow-200 min-w-[3rem]">
                                    ${currentPoints}
                                </span>
                                <button onclick="handleEditStudentPoints('${s.uid}', '${s.name}', ${currentPoints})" 
                                        class="p-1.5 text-slate-400 hover:text-blue-600 hover:bg-blue-50 rounded-full transition" 
                                        title="Ch·ªânh s·ª≠a ƒëi·ªÉm s·ªë">
                                    <i data-lucide="edit-3" size="16"></i>
                                </button>
                            </div>
                        </td>

                        <td class="py-3 text-right pr-4">
                            <div class="flex items-center justify-end gap-2">
                                <button onclick="viewStudentReport('${s.uid}')" 
                                        class="p-2 bg-indigo-50 text-indigo-600 rounded-lg hover:bg-indigo-100 transition shadow-sm"
                                        title="Xem b√°o c√°o & In">
                                    <i data-lucide="file-text" size="18"></i>
                                </button>
                                
                                <button onclick="confirmRemoveStudent('${classData.id}', '${s.uid}', '${s.name}')" 
                                        class="text-red-500 hover:text-red-700 p-2 rounded-full hover:bg-red-50 transition"
                                        title="G·ª° kh·ªèi l·ªõp">
                                    <i data-lucide="user-minus" size="18"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
            
            return `
                <h4 class="text-xl font-bold text-slate-700 mb-4">Danh s√°ch H·ªçc sinh</h4>
                <div class="bg-slate-50 rounded-xl overflow-hidden shadow-inner border">
                    <div class="overflow-x-auto">
                        <table class="w-full min-w-[600px] md:min-w-full">
                            <thead>
                                <tr class="text-left text-slate-500 text-sm border-b bg-slate-100">
                                    <th class="pb-3 pt-3 pl-4">H·ªç v√† T√™n</th>
                                    <th class="pb-3 pt-3 hidden md:table-cell">T√†i kho·∫£n (Email)</th>
                                    <th class="pb-3 pt-3 text-center">T·ªïng ƒêi·ªÉm</th>
                                    <th class="pb-3 pt-3 pr-4 text-right">Thao t√°c</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${studentRows || `<tr><td colspan="4" class="text-center py-8 text-slate-500">Ch∆∞a c√≥ h·ªçc sinh n√†o trong l·ªõp.</td></tr>`}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

const renderClassAssignments = (classData, studentList) => {
            // L·ªçc b√†i t·∫≠p ƒë√£ giao cho l·ªõp n√†y V√Ä ƒë∆∞·ª£c t·∫°o b·ªüi gi√°o vi√™n hi·ªán t·∫°i
            // [C·∫¨P NH·∫¨T] Th√™m h√†m .sort() ƒë·ªÉ s·∫Øp x·∫øp theo th·ªùi gian t·∫°o (M·ªõi nh·∫•t l√™n ƒë·∫ßu)
            const classAssignments = state.data.assignments.filter(a => 
                (a.classIds || []).includes(classData.id) && a.createdBy === state.user.uid
            ).sort((a, b) => {
                // L·∫•y th·ªùi gian (gi√¢y), n·∫øu kh√¥ng c√≥ th√¨ m·∫∑c ƒë·ªãnh l√† 0
                const timeA = a.createdAt ? a.createdAt.seconds : 0;
                const timeB = b.createdAt ? b.createdAt.seconds : 0;
                // return timeA - timeB; // D√πng d√≤ng n√†y n·∫øu mu·ªën C≈© nh·∫•t l√™n ƒë·∫ßu (B√†i 1, B√†i 2...)
                return timeB - timeA;    // D√πng d√≤ng n√†y ƒë·ªÉ M·ªõi nh·∫•t l√™n ƒë·∫ßu
            });

            const list = classAssignments.map(a => {
                // 1. L·∫•y t·∫•t c·∫£ b√†i n·ªôp h·ª£p l·ªá c·ªßa h·ªçc sinh trong l·ªõp n√†y
                const validSubmissions = state.data.submissions.filter(s => 
                    s.assignmentId === a.id && studentList.some(st => st.uid === s.studentId)
                );
                // 2. D√πng Set ƒë·ªÉ ƒë·∫øm s·ªë h·ªçc sinh duy nh·∫•t
                const uniqueStudentIds = new Set(validSubmissions.map(s => s.studentId));
                const submissionsCount = uniqueStudentIds.size;

                const completionRate = studentList.length > 0 ? Math.round((submissionsCount / studentList.length) * 100) : 0;
                const completionColor = completionRate === 100 ? 'bg-green-100 text-green-700' : completionRate > 0 ? 'bg-yellow-100 text-yellow-700' : 'bg-red-100 text-red-700';

                return `
                    <div onclick="viewAssignmentDetailsInClass('${a.id}')" 
                         class="group bg-white p-3 rounded-xl shadow-sm border border-slate-100 hover:shadow-md hover:border-yellow-200 transition flex items-center justify-between gap-3 cursor-pointer">
                        
                        <div class="flex items-center gap-3 flex-1 min-w-0">
                            <div class="bg-indigo-50 text-indigo-600 p-2 rounded-lg flex-shrink-0 group-hover:bg-indigo-600 group-hover:text-white transition">
                                <i data-lucide="book-open" class="w-5 h-5"></i>
                            </div>
                            <div class="min-w-0">
                                <h4 class="text-sm font-bold text-slate-800 truncate group-hover:text-indigo-700 transition">${a.title}</h4>
                                <p class="text-xs text-slate-500 mt-0.5">${a.questions.length} c√¢u h·ªèi ‚Ä¢ ${a.createdAt ? new Date(a.createdAt.seconds * 1000).toLocaleDateString('vi-VN') : ''}</p>
                            </div>
                        </div>

                        <div class="flex items-center gap-3 flex-shrink-0">
                            <span class="px-2 py-1 rounded-full text-xs font-bold ${completionColor} hidden sm:inline-block">
                                ${submissionsCount}/${studentList.length} (${completionRate}%)
                            </span>
                            
                            <div class="opacity-0 group-hover:opacity-100 transition-opacity duration-200">
                                <button onclick="event.stopPropagation(); confirmDeleteAssignment('${a.id}', '${a.title}')" 
                                        class="p-2 bg-red-50 text-red-500 rounded-lg hover:bg-red-600 hover:text-white transition shadow-sm">
                                    <i data-lucide="trash-2" size="18"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            return `
                <h4 class="text-xl font-bold text-slate-700 mb-4"></h4>
                
                <button onclick="createClassAssignment('${classData.id}', '${classData.title}')" class="mb-4 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-xl font-bold shadow-md flex items-center gap-2 text-sm w-fit">
                    <i data-lucide="plus-circle" size="18"></i> T·∫°o B√†i t·∫≠p m·ªõi
                </button>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-1">
                    ${list || `<p class="text-slate-500 text-center col-span-full py-4 bg-slate-50 rounded-xl border border-dashed border-slate-300">Ch∆∞a c√≥ b√†i t·∫≠p n√†o ƒë∆∞·ª£c giao cho l·ªõp n√†y.</p>`}
                </div>
            `;
        };
        
        // --- M·ªöI: H√ÄM RENDER CHI TI·∫æT TH·ªêNG K√ä B√ÄI T·∫¨P ---
// --- H√ÄM RENDER CHI TI·∫æT TH·ªêNG K√ä B√ÄI T·∫¨P (ƒê√É C·∫¨P NH·∫¨T: XEM CHI TI·∫æT B√ÄI L√ÄM) ---
        const renderAssignmentStatsDetail = (assign, studentList, submissions) => {
             
            const studentStats = studentList.map(student => {
                const userProfile = state.data.users.find(u => u.uid === student.uid);
                // T√¨m b√†i n·ªôp c·ªßa h·ªçc sinh n√†y
                const sub = submissions.find(s => s.studentId === student.uid);
                return {
                    ...student,
                    ...userProfile, 
                    subId: sub ? sub.id : null, // L∆∞u ID b√†i n·ªôp
                    score: sub ? sub.score : 0,
                    submitted: !!sub
                };
            });
            
            // S·∫Øp x·∫øp theo ƒëi·ªÉm (cao -> th·∫•p)
            studentStats.sort((a, b) => b.score - a.score);

            const statsRows = studentStats.map((s, idx) => {
                // T·∫°o n√∫t xem ƒëi·ªÉm ho·∫∑c d·∫•u g·∫°ch ngang n·∫øu ch∆∞a n·ªôp
                const scoreDisplay = s.submitted 
                    ? `<button onclick="viewSubmissionResult('${s.subId}')" 
                               class="flex items-center justify-center gap-1 w-full py-1 px-2 rounded-lg font-bold transition shadow-sm
                               ${s.score >= 50 ? 'bg-green-100 text-green-700 hover:bg-green-200' : 'bg-red-100 text-red-700 hover:bg-red-200'}"
                               title="Nh·∫•n ƒë·ªÉ xem chi ti·∫øt b√†i l√†m">
                            ${s.score} <i data-lucide="eye" class="w-3 h-3"></i>
                       </button>`
                    : `<span class="text-slate-300 font-bold">-</span>`;

                return `
                <tr class="border-b last:border-0 hover:bg-slate-50 transition ${!s.submitted ? 'opacity-60' : ''}">
                    <td class="py-3 pl-4 font-medium text-slate-700 w-12 text-center">${idx + 1}</td>
                    <td class="py-3 flex items-center gap-3">
                        ${renderAvatar(s, 'w-8 h-8', 'text-sm')}
                        <span class="font-medium text-slate-700 truncate">${s.name}</span>
                    </td>
                    <td class="py-3 text-center hidden sm:table-cell">
                        <span class="px-2 py-0.5 rounded-full text-xs font-bold ${s.submitted ? 'bg-blue-100 text-blue-700' : 'bg-slate-100 text-slate-500'}">
                            ${s.submitted ? 'ƒê√£ n·ªôp' : 'Ch∆∞a n·ªôp'}
                        </span>
                    </td>
                    <td class="py-3 pr-4 text-right w-24">
                        ${scoreDisplay}
                    </td>
                </tr>
            `}).join('');

            return `
                <div class="bg-white p-4 md:p-6 rounded-xl shadow-md border mb-6 fade-in">
                    <div class="flex justify-between items-center mb-4 border-b pb-2">
                        <div>
                            <h5 class="text-xl font-bold text-blue-600 truncate">${assign.title}</h5>
                            <p class="text-xs text-slate-500">T·ªïng s·ªë c√¢u: ${assign.questions.length}</p>
                        </div>
                        <button onclick="viewAssignmentStats(null)" class="text-slate-400 hover:text-red-500 p-2 rounded-full hover:bg-slate-100 transition">
                             <i data-lucide="x" size="24"></i>
                        </button>
                    </div>
                    
                    <div class="bg-slate-50 rounded-xl overflow-hidden shadow-inner border">
                        <div class="overflow-x-auto">
                            <table class="w-full min-w-[500px]">
                                <thead>
                                    <tr class="text-left text-slate-500 text-sm border-b bg-slate-100 uppercase tracking-wider">
                                        <th class="pb-3 pt-3 pl-4 w-12 text-center">#</th>
                                        <th class="pb-3 pt-3">H·ªçc sinh</th>
                                        <th class="pb-3 pt-3 text-center hidden sm:table-cell">Tr·∫°ng th√°i</th>
                                        <th class="pb-3 pt-3 pr-4 text-right w-24">ƒêi·ªÉm (Xem)</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${statsRows}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
        }

const renderClassStatistics = (classData, studentList) => {
            // L·ªçc b√†i t·∫≠p v√† S·∫Øp x·∫øp theo th·ªùi gian (M·ªõi nh·∫•t l√™n ƒë·∫ßu)
            const classAssignments = state.data.assignments.filter(a => 
                (a.classIds || []).includes(classData.id) && a.createdBy === state.user.uid
            ).sort((a, b) => {
                const timeA = a.createdAt ? a.createdAt.seconds : 0;
                const timeB = b.createdAt ? b.createdAt.seconds : 0;
                return timeB - timeA; // M·ªõi nh·∫•t l√™n ƒë·∫ßu
            });
            
            if (classAssignments.length === 0) {
                 return `<p class="text-slate-500">Ch∆∞a c√≥ b√†i t·∫≠p n√†o ƒë∆∞·ª£c giao ƒë·ªÉ th·ªëng k√™.</p>`;
            }

            // --- HI·ªÇN TH·ªä CHI TI·∫æT B√ÄI T·∫¨P ƒê√É CH·ªåN ---
            if (state.ui.selectedStatAssignmentId) {
                const selectedAssign = classAssignments.find(a => a.id === state.ui.selectedStatAssignmentId);
                if (selectedAssign) {
                    const submissions = state.data.submissions.filter(s => 
                        s.assignmentId === selectedAssign.id && studentList.some(st => st.uid === s.studentId)
                    );
                    return renderAssignmentStatsDetail(selectedAssign, studentList, submissions);
                }
            }
            
            // --- M·∫∂C ƒê·ªäNH: HI·ªÇN TH·ªä DANH S√ÅCH B√ÄI T·∫¨P ---
            const assignmentCards = classAssignments.map(a => {
                const validSubmissions = state.data.submissions.filter(s => 
                    s.assignmentId === a.id && studentList.some(st => st.uid === s.studentId)
                );
                const uniqueStudentIds = new Set(validSubmissions.map(s => s.studentId));
                const submissionsCount = uniqueStudentIds.size;
                
                const completionRate = studentList.length > 0 ? 
                    Math.round((submissionsCount / studentList.length) * 100) : 0;
                
                const completionColor = completionRate === 100 ? 'bg-green-500' : 
                                         completionRate > 0 ? 'bg-yellow-500' : 
                                         'bg-slate-400';
                
                // Format ng√†y t·∫°o
                const dateStr = a.createdAt ? new Date(a.createdAt.seconds * 1000).toLocaleDateString('vi-VN') : '';

                return `
                    <button onclick="viewAssignmentStats('${a.id}')" 
                            class="bg-white p-3 rounded-xl shadow-sm border border-slate-100 hover:shadow-md hover:bg-slate-50 transition flex items-center justify-between gap-3 text-left w-full group">
                        
                        <div class="flex items-center gap-3 flex-1 min-w-0">
                            <div class="bg-indigo-50 text-indigo-600 p-2 rounded-lg flex-shrink-0">
                                <i data-lucide="bar-chart-3" class="w-5 h-5"></i>
                            </div>
                            <div class="min-w-0">
                                <h4 class="text-sm font-bold text-slate-800 truncate group-hover:text-blue-600 transition">${a.title}</h4>
                                <p class="text-xs text-slate-500 mt-0.5">${a.questions.length} c√¢u h·ªèi ‚Ä¢ ${dateStr}</p>
                            </div>
                        </div>

                        <div class="flex items-center gap-3 flex-shrink-0">
                             <span class="px-2 py-1 rounded-full text-xs font-bold text-white ${completionColor}">
                                ${completionRate}%
                            </span>
                            <i data-lucide="chevron-right" class="text-slate-300 w-5 h-5 group-hover:text-blue-500 transition"></i>
                        </div>
                    </button>
                `;
            }).join('');

             return `
                <h4 class="text-xl font-bold text-slate-700 mb-4">Danh s√°ch B√†i t·∫≠p (Ch·ªçn ƒë·ªÉ xem th·ªëng k√™)</h4>
                
                <div class="grid grid-cols-1 lg:grid-cols-4 gap-1">
                    ${assignmentCards || `<p class="text-slate-500 text-center col-span-full py-4 bg-slate-50 rounded-xl border border-dashed border-slate-300">Ch∆∞a c√≥ b√†i t·∫≠p n√†o ƒë∆∞·ª£c giao ƒë·ªÉ th·ªëng k√™.</p>`}
                </div>
            `;
        };

const renderViewClass = (classId) => {
            const classData = state.data.classes.find(c => c.id === classId);
            if (!classData) return `<p class="text-red-500">Kh√¥ng t√¨m th·∫•y l·ªõp h·ªçc.</p>`;
            
            const studentList = (classData.studentIds || []).map(sid => {
                const user = state.data.users.find(u => u.uid === sid);
                return { uid: sid, name: user ? user.name : 'Unknown User', email: user ? user.email : 'N/A' };
            });

            // Decide which content to show
            let contentHtml = '';
            switch(state.ui.viewClassMode) {
                case 'assignments':
                    contentHtml = renderClassAssignments(classData, studentList);
                    state.ui.selectedStatAssignmentId = null;
                    break;
                case 'assessments': // Tab Ki·ªÉm tra
                    contentHtml = renderClassAssessments(classData, studentList);
                    break;
                case 'stats':
                    contentHtml = renderClassStatistics(classData, studentList);
                    break;
                case 'student_report': // Tab B√°o c√°o c√° nh√¢n (M·ªõi)
                    contentHtml = renderStudentReport(classData, studentList);
                    break;
                case 'students':
                default:
                    contentHtml = renderClassStudents(classData, studentList);
                    state.ui.selectedStatAssignmentId = null;
                    break;
            }

            // Helper t·∫°o n√∫t ƒëi·ªÅu h∆∞·ªõng (Nav Button)
            const nav = (mode, icon, label) => `
                <button onclick="setViewClassMode('${mode}')" 
                    class="flex-1 flex flex-col sm:flex-row items-center justify-center gap-1 sm:gap-2 py-2 sm:py-3 rounded-xl font-bold transition text-sm sm:text-base 
                    ${state.ui.viewClassMode === mode ? 'bg-blue-600 text-white shadow-md' : 'bg-slate-100 text-slate-700 hover:bg-slate-200'}">
                    <i data-lucide="${icon}" size="20"></i> <span class="hidden sm:inline">${label}</span>
                </button>
            `;

return `
                <div class="max-w-7xl mx-auto bg-white p-4 md:p-8 rounded-2xl shadow-lg fade-in">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 border-b pb-4 gap-4">
                        <div class="flex items-center gap-2 w-full md:w-auto flex-1 mr-4">
                            <input id="edit-class-title" type="text" value="${classData.title}" 
                                    class="text-2xl md:text-3xl font-bold border-b-2 border-transparent hover:border-blue-200 focus:border-blue-500 outline-none p-1 bg-transparent w-full">
                            <button onclick="handleUpdateClassTitle('${classData.id}')" class="p-2 text-blue-500 hover:bg-blue-50 rounded-lg transition flex-shrink-0" title="L∆∞u t√™n l·ªõp">
                                <i data-lucide="save" size="24"></i>
                            </button>
                        </div>

                        <div class="flex items-center gap-3 self-end md:self-center">
                            <button onclick="printClassReports('${classData.id}')" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg font-bold shadow-md flex items-center gap-2 transition text-sm">
                                <i data-lucide="printer" size="18"></i> In T·∫•t C·∫£ B√°o C√°o
                            </button>

                            <button onclick="copyToClipboard('${classData.classCode}', 'M√£ l·ªõp')" 
                                    class="group flex items-center gap-2 bg-green-50 border border-green-200 text-green-700 px-3 py-1.5 rounded-lg hover:bg-green-100 hover:shadow-sm transition cursor-pointer"
                                    title="Nh·∫•n ƒë·ªÉ sao ch√©p m√£ l·ªõp">
                                <span class="text-xs font-bold uppercase text-green-600 tracking-wider">M√£ l·ªõp:</span>
                                <span class="font-mono text-lg font-black tracking-widest">${classData.classCode}</span>
                                <i data-lucide="copy" size="14" class="opacity-50 group-hover:opacity-100 transition"></i>
                            </button>

                            <button onclick="viewClass(null)" class="p-2 text-slate-400 hover:text-red-500 hover:bg-red-50 rounded-lg transition flex-shrink-0">
                                <i data-lucide="x" size="24"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div class="flex gap-2 md:gap-4 mb-8">
                        ${nav('students', 'users', `H·ªçc sinh`)}
                        ${nav('assignments', 'clipboard-list', 'B√†i t·∫≠p')}
                        ${nav('assessments', 'check-square', 'Ki·ªÉm tra')}
                        ${nav('stats', 'bar-chart-3', 'Th·ªëng k√™')}
                    </div>

                    ${contentHtml}
                </div>
            `;
        };
        
const renderAssignments = () => {
    // 1. Logic render c√°c m√†n h√¨nh con (n·∫øu ƒëang active)
    if (state.ui.isCreatingAssignment) {
        if (state.ui.isSelectingBankQuestions) return renderQuestionSelectionFromBank();
        return renderCreateAssignmentForm();
    }
    if (state.ui.takingAssignmentId) return renderTakeAssignment();
    if (state.ui.viewAssignmentId) return renderAssignmentDetails();
    if (state.ui.viewSubmission) return renderSubmissionResult();

    const isTeacher = state.profile.role === 'teacher';

    // 2. L·∫§Y DANH S√ÅCH L·ªöP CHO FILTER
    let availableClasses = [];
    if (isTeacher) {
        availableClasses = state.data.classes.filter(c => c.teacherId === state.user.uid);
    } else {
        availableClasses = state.data.classes.filter(c => (c.studentIds || []).includes(state.user.uid));
    }

    // 3. L·ªåC & S·∫ÆP X·∫æP B√ÄI T·∫¨P
    const currentFilter = state.ui.filterClassId || 'all';

    let displayAssignments = state.data.assignments.filter(a => {
        if (isTeacher) return a.createdBy === state.user.uid;
        return (a.classIds || []).some(cid => (state.profile.classIds || []).includes(cid));
    });

    if (currentFilter !== 'all') {
        displayAssignments = displayAssignments.filter(a => (a.classIds || []).includes(currentFilter));
    }

    // S·∫Øp x·∫øp: M·ªõi nh·∫•t l√™n ƒë·∫ßu
    displayAssignments.sort((a, b) => {
        const timeA = a.createdAt ? a.createdAt.seconds : 0;
        const timeB = b.createdAt ? b.createdAt.seconds : 0;
        return timeB - timeA;
    });

    // 4. RENDER DANH S√ÅCH TH·∫∫ B√ÄI T·∫¨P
    const list = displayAssignments.map(a => {
        // --- X·ª¨ L√ù D·ªÆ LI·ªÜU CHUNG ---
        
        // L·∫•y t√™n c√°c l·ªõp
        const classList = (a.classIds || []).map(id =>
            state.data.classes.find(c => c.id === id)?.title
        ).filter(Boolean);
        
        const assignedClassText = classList.length > 0 
            ? classList.join(', ') 
            : (isTeacher ? 'Ch∆∞a giao l·ªõp' : 'L·ªõp chung');

        // Format ng√†y t·∫°o
        const dateStr = a.createdAt ? new Date(a.createdAt.seconds * 1000).toLocaleDateString('vi-VN') : '';

        // Icon Quy·ªÉn s√°ch (Chung cho c·∫£ 2 view)
        const iconHtml = `
            <div class="bg-blue-50 text-blue-600 p-3 rounded-2xl flex-shrink-0 transition-all duration-300 group-hover:bg-blue-600 group-hover:text-white group-hover:shadow-md">
                <i data-lucide="book-open" size="26"></i>
            </div>
        `;

        // --- A. GIAO DI·ªÜN H·ªåC SINH ---
        if (!isTeacher) {
            const sub = state.data.submissions.find(s => s.assignmentId === a.id && s.studentId === state.user.uid);
            
            let statusBadge = '';
            let action = `startAssignment('${a.id}')`;
            
            if (sub) {
                // ƒê√£ l√†m
                const scoreDisplay = `${sub.score}/100`; 
                let bgClass = 'bg-red-100 text-red-600'; 
                if (sub.score >= 80) bgClass = 'bg-green-100 text-green-600';
                else if (sub.score >= 50) bgClass = 'bg-orange-100 text-orange-600';

                statusBadge = `<span class="px-3 py-1 rounded-full text-xs font-bold ${bgClass} whitespace-nowrap shadow-sm border border-white/50">${scoreDisplay}</span>`;
                action = `viewSubmissionResult('${sub.id}')`;
            } else {
                // Ch∆∞a l√†m
                statusBadge = `<span class="px-3 py-1 rounded-full text-xs font-bold bg-slate-100 text-slate-500 whitespace-nowrap border border-slate-200">Ch∆∞a l√†m</span>`;
            }

            return `
                <div onclick="${action}" class="group bg-white p-4 rounded-2xl shadow-sm border border-slate-200 hover:shadow-lg hover:border-blue-200 transition cursor-pointer relative min-h-[90px] flex items-center">
                    <div class="flex justify-between items-center w-full">
                        <div class="flex items-center gap-4 flex-1 min-w-0 mr-2">
                            ${iconHtml}
                            <div class="flex flex-col min-w-0 gap-1 w-full">
                                <h4 class="text-base font-bold text-slate-800 line-clamp-1 leading-tight group-hover:text-blue-600 transition" title="${a.title}">
                                    ${a.title}
                                </h4>
                                <p class="text-sm font-bold text-blue-600 truncate" title="${assignedClassText}">
                                    ${assignedClassText}
                                </p>
                            </div>
                        </div>

                        <div class="flex flex-col items-end gap-1.5 flex-shrink-0 pl-2">
                            ${statusBadge}
                            <span class="text-[11px] text-slate-400 font-bold tracking-wide">${dateStr}</span>
                        </div>
                    </div>
                </div>
            `;
        } 
        
        // --- B. GIAO DI·ªÜN GI√ÅO VI√äN ---
        else {
            // [FIX L·ªñI N·ªòP > T·ªîNG]: Ch·ªâ ƒë·∫øm h·ªçc sinh ƒëang c√≥ m·∫∑t trong l·ªõp
            // 1. L·∫•y t·∫•t c·∫£ studentId h·ª£p l·ªá t·ª´ c√°c l·ªõp ƒë∆∞·ª£c giao
            let targetStudentIds = new Set();
            if (a.classIds && Array.isArray(a.classIds)) {
                a.classIds.forEach(cid => {
                    const cls = state.data.classes.find(c => c.id === cid);
                    if (cls && cls.studentIds) {
                        cls.studentIds.forEach(sid => targetStudentIds.add(sid));
                    }
                });
            }
            const totalStudentsAssigned = targetStudentIds.size; 

            // 2. L·∫•y danh s√°ch b√†i n·ªôp v√† l·ªçc nh·ªØng b√†i c·ªßa HS h·ª£p l·ªá
            const allSubs = state.data.submissions.filter(s => s.assignmentId === a.id);
            const validSubmissions = allSubs.filter(s => targetStudentIds.has(s.studentId));
            const submittedCount = new Set(validSubmissions.map(s => s.studentId)).size;
            
            // 3. T√≠nh ph·∫ßn trƒÉm
            const percentage = totalStudentsAssigned > 0 ? Math.round((submittedCount / totalStudentsAssigned) * 100) : 0;

            let badgeColor = 'bg-red-100 text-red-600';
            if (percentage === 100) badgeColor = 'bg-green-100 text-green-600';
            else if (percentage >= 50) badgeColor = 'bg-orange-100 text-orange-600';

            return `
                <div onclick="viewAssignmentDetails('${a.id}')" 
                     class="group bg-white p-4 rounded-2xl shadow-sm border border-slate-200 hover:shadow-lg hover:border-blue-300 transition cursor-pointer relative min-h-[90px] flex items-center">
                    
                    <div class="flex justify-between items-center w-full">
                        <div class="flex items-center gap-4 flex-1 min-w-0 mr-2">
                            ${iconHtml}
                            <div class="flex flex-col min-w-0 gap-1 w-full">
                                <h4 class="text-base font-bold text-slate-800 line-clamp-1 leading-tight group-hover:text-blue-700 transition" title="${a.title}">
                                    ${a.title}
                                </h4>
                                <p class="text-sm font-bold text-blue-600 truncate" title="${assignedClassText}">
                                    ${assignedClassText}
                                </p>
                            </div>
                        </div>

                        <div class="flex flex-col items-end gap-1.5 flex-shrink-0 pl-2">
                            <span onclick="openAssignmentStats(event, '${a.id}')" 
                                  class="cursor-pointer px-3 py-1 rounded-full text-xs font-bold ${badgeColor} whitespace-nowrap shadow-sm border border-white/50 transition-transform hover:scale-110 active:scale-95"
                                  title="Xem th·ªëng k√™ n·ªôp b√†i">
                                ${submittedCount}/${totalStudentsAssigned} (${percentage}%)
                            </span>
                            <span class="text-[11px] text-slate-400 font-bold tracking-wide">${dateStr}</span>
                        </div>
                    </div>

                    <button onclick="event.stopPropagation(); confirmDeleteAssignment('${a.id}', '${a.title}')" 
                            class="absolute -top-2 -right-2 p-2 bg-white text-slate-400 hover:text-red-500 rounded-full shadow-md border border-slate-200 opacity-0 group-hover:opacity-100 transition-all duration-200 hover:bg-red-50 z-20 hover:scale-110" 
                            title="X√≥a b√†i t·∫≠p">
                        <i data-lucide="trash-2" size="16"></i>
                    </button>
                </div>
            `;
        }
    }).join('');

    // --- KI·ªÇM TRA ƒê·ªÇ RENDER MODAL TH·ªêNG K√ä (N·∫æU C√ì) ---
    let modalHtml = '';
    if (state.ui.statsModalAssignmentId) {
        modalHtml = renderStatsModal();
    }

    // --- TR·∫¢ V·ªÄ HTML HO√ÄN CH·ªàNH ---
    return `
        <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-6">
            <div class="flex items-center gap-2 w-full md:w-auto">
                <div class="relative w-full md:w-64">
                    <i data-lucide="filter" class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 w-4 h-4"></i>
                    <select onchange="setAssignmentFilter(this.value)" class="w-full pl-9 pr-4 py-2.5 bg-white border border-slate-200 rounded-xl text-sm font-bold text-slate-700 focus:border-blue-500 outline-none shadow-sm appearance-none cursor-pointer hover:border-blue-300 transition">
                        <option value="all" ${currentFilter === 'all' ? 'selected' : ''}>T·∫•t c·∫£ c√°c l·ªõp</option>
                        ${availableClasses.map(c => `<option value="${c.id}" ${currentFilter === c.id ? 'selected' : ''}>${c.title}</option>`).join('')}
                    </select>
                    <i data-lucide="chevron-down" class="absolute right-3 top-1/2 -translate-y-1/2 text-slate-400 w-4 h-4 pointer-events-none"></i>
                </div>
            </div>

            ${isTeacher ? 
                `<button onclick="toggleCreate(true)" class="w-full md:w-auto bg-blue-600 hover:bg-blue-700 text-white px-5 py-2.5 rounded-xl font-bold shadow-md flex items-center justify-center gap-2 text-sm transition transform hover:-translate-y-0.5">
                    <i data-lucide="plus-circle" size="18"></i> T·∫°o b√†i t·∫≠p
                </button>` : ''}
        </div>

        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-3 gap-4">
            ${list || `<div class="col-span-full py-12 text-center bg-white rounded-2xl border-2 border-dashed border-slate-200">
                <div class="inline-block p-4 bg-slate-50 rounded-full mb-3 text-slate-400"><i data-lucide="clipboard-x" size="32"></i></div>
                <p class="text-slate-500 font-medium">Kh√¥ng t√¨m th·∫•y b√†i t·∫≠p n√†o.</p>
            </div>`}
        </div>
        
        ${modalHtml}
    `;
};
        
        // QUESTION BANK (C·∫≠p nh·∫≠t Responsive)
        const renderQuestionBank = () => {
            const isTeacher = state.profile.role === 'teacher';
            if (!isTeacher) return `<p class="text-red-500">B·∫°n kh√¥ng c√≥ quy·ªÅn truy c·∫≠p t√≠nh nƒÉng n√†y.</p>`;

            if (state.ui.bankMode === 'create') {
                return renderCreateQuestionBankForm();
            }
            if (state.ui.bankMode === 'view' && state.ui.selectedBankId) {
                return renderViewQuestionBank();
            }

            const myBanks = state.data.questionBanks.filter(b => b.createdBy === state.user.uid);
            
const list = myBanks.map(bank => `
                <div onclick="viewBankDetails('${bank.id}')" 
                     class="group bg-white p-3 rounded-xl shadow-sm border border-slate-100 hover:shadow-md hover:border-purple-200 transition flex items-center justify-between gap-3 cursor-pointer">
                    
                    <div class="flex items-center gap-3 flex-1 min-w-0">
                        <div class="bg-purple-50 text-purple-600 p-2 rounded-lg flex-shrink-0 group-hover:bg-purple-600 group-hover:text-white transition">
                            <i data-lucide="library" class="w-5 h-5"></i>
                        </div>
                        <div class="min-w-0">
                            <h4 class="text-sm font-bold text-slate-800 truncate group-hover:text-purple-700 transition">${bank.title}</h4>
                            <p class="text-xs text-slate-500 mt-0.5">${bank.questions.length} c√¢u h·ªèi</p>
                        </div>
                    </div>

                    <div class="flex-shrink-0 opacity-0 group-hover:opacity-100 transition-opacity duration-200">
                        <button onclick="event.stopPropagation(); confirmDeleteBank('${bank.id}', '${bank.title}')" 
                                class="p-2 bg-red-50 text-red-500 rounded-lg hover:bg-red-600 hover:text-white transition shadow-sm">
                            <i data-lucide="trash-2" size="18"></i>
                        </button>
                    </div>
                </div>
            `).join('');

                return `
                <div class="flex flex-wrap gap-3 mb-4">
                    <button onclick="setBankMode('create')" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-xl font-bold shadow-md flex items-center gap-2 text-sm">
                        <i data-lucide="plus-circle" size="18"></i> T·∫°o Ng√¢n h√†ng ƒë·ªÅ
                    </button>
                    <button onclick="toggleImportData(true)" class="bg-yellow-600 hover:bg-yellow-700 text-white px-4 py-2 rounded-xl font-bold shadow-md flex items-center gap-2 text-sm">
                        <i data-lucide="file-text" size="18"></i> Nh·∫≠p d·ªØ li·ªáu
                    </button>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-2">
                    ${list || '<p class="text-slate-500 text-center col-span-full py-4 bg-slate-50 rounded-xl border border-dashed border-slate-300">B·∫°n ch∆∞a t·∫°o ng√¢n h√†ng ƒë·ªÅ n√†o.</p>'}
                </div>
            `;
        };
        
        const renderCreateQuestionBankForm = () => {
            const qList = state.ui.newAssignment.questions.map((q, idx) => renderQuestionDisplay(q, idx)).join('');

            return `
                <div class="bg-white p-4 md:p-6 rounded-2xl shadow-lg fade-in max-w-4xl mx-auto">
                    <div class="flex justify-between mb-4 md:mb-6 border-b pb-3">
                        <h3 class="text-xl font-bold text-purple-600">T·∫°o Ng√¢n h√†ng ƒë·ªÅ m·ªõi</h3>
                        <button onclick="setBankMode('list')" class="text-slate-500 hover:text-red-500"><i data-lucide="x"></i></button>
                    </div>
<div class="mb-4 md:mb-6 flex flex-col md:flex-row gap-4">
    <input id="new-bank-title" class="flex-1 text-lg font-bold border-b-2 border-slate-200 p-2 outline-none focus:border-purple-500" placeholder="Ti√™u ƒë·ªÅ Ng√¢n h√†ng ƒë·ªÅ...">
    
    <div class="relative">
        <input type="file" id="bankJsonInput" accept=".json" class="hidden" onchange="handleBankJSONUpload(event)">
        <label for="bankJsonInput" class="h-full bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-bold flex items-center justify-center gap-2 text-sm cursor-pointer transition shadow-md">
            <i data-lucide="file-json" size="18"></i> T·∫£i JSON
        </label>
    </div>
    <button onclick="toggleImportData(true, true)" class="bg-yellow-600 hover:bg-yellow-700 text-white px-4 py-2 rounded-lg font-bold flex items-center justify-center gap-2 text-sm shadow-md">
        <i data-lucide="file-text" size="18"></i> Nh·∫≠p t·ª´ TXT
    </button>
</div>
                    
                    <h4 class="text-lg font-bold text-slate-800 mb-3">Danh s√°ch c√¢u h·ªèi (${state.ui.newAssignment.questions.length})</h4>
                    <div id="questions-preview" class="space-y-4 border p-4 rounded-xl bg-slate-50 max-h-96 overflow-y-auto">${qList || '<p class="text-slate-500">Ch∆∞a c√≥ c√¢u h·ªèi n√†o.</p>'}</div>

                    ${renderQuestionInputSection(false)}

                    <button onclick="publishQuestionBank()" class="w-full bg-purple-600 text-white py-3 rounded-xl font-bold hover:bg-purple-700 transition">L∆∞u Ng√¢n h√†ng ƒë·ªÅ</button>
                </div>
            `;
        };
        
        const renderViewQuestionBank = () => {
            const bank = state.data.questionBanks.find(b => b.id === state.ui.selectedBankId);
            if (!bank) return `<p class="text-red-500">Kh√¥ng t√¨m th·∫•y ng√¢n h√†ng ƒë·ªÅ.</p>`;

            // D√πng l·∫°i state.ui.newAssignment ƒë·ªÉ ch·ªânh s·ª≠a t·∫°m th·ªùi
            if (!state.ui.newAssignment.id || state.ui.newAssignment.id !== bank.id) {
                // Kh·ªüi t·∫°o tr·∫°ng th√°i ch·ªânh s·ª≠a
                state.ui.newAssignment = { ...bank, questions: JSON.parse(JSON.stringify(bank.questions)) };
                state.ui.newQuestionType = 'mcq';
            }

            const qList = state.ui.newAssignment.questions.map((q, idx) => renderQuestionDisplay(q, idx)).join('');

            return `
                <div class="bg-white p-4 md:p-6 rounded-2xl shadow-lg fade-in max-w-4xl mx-auto">
                    <div class="flex justify-between mb-4 md:mb-6 border-b pb-3">
                        <h3 class="text-xl font-bold text-purple-600">Ch·ªânh s·ª≠a Ng√¢n h√†ng ƒë·ªÅ</h3>
                        <button onclick="viewBankDetails(null)" class="text-slate-500 hover:text-red-500"><i data-lucide="x"></i></button>
                    </div>
                    
                    <div class="mb-4 md:mb-6 flex flex-col md:flex-row gap-4">
                        <div class="flex-1">
                            <label class="block text-sm font-medium text-slate-600 mb-1">Ti√™u ƒë·ªÅ</label>
                            <input id="edit-bank-title" class="w-full text-lg font-bold border-b-2 border-slate-200 p-2 outline-none focus:border-purple-500" value="${state.ui.newAssignment.title}">
                        </div>
<div class="flex gap-2 self-end">
    <div class="relative">
        <input type="file" id="editBankJsonInput" accept=".json" class="hidden" onchange="handleBankJSONUpload(event)">
        <label for="editBankJsonInput" class="h-full bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-bold flex items-center justify-center gap-2 text-sm cursor-pointer transition shadow-md h-fit">
            <i data-lucide="file-json" size="18"></i> T·∫£i JSON
        </label>
    </div>
    <button onclick="toggleImportData(true, true)" class="bg-yellow-600 hover:bg-yellow-700 text-white px-4 py-2 rounded-lg font-bold flex items-center justify-center gap-2 text-sm h-fit shadow-md">
        <i data-lucide="file-text" size="18"></i> Nh·∫≠p TXT
    </button>
</div>
                    </div>
                    
                    <h4 class="text-lg font-bold text-slate-800 mb-3">Danh s√°ch c√¢u h·ªèi (${state.ui.newAssignment.questions.length})</h4>
                    <div id="questions-preview" class="space-y-4 border p-4 rounded-xl bg-slate-50 max-h-96 overflow-y-auto">${qList || '<p class="text-slate-500">Ch∆∞a c√≥ c√¢u h·ªèi n√†o.</p>'}</div>

                    ${renderQuestionInputSection(true)}

                    <button onclick="saveBankChanges('${bank.id}')" class="w-full bg-green-600 text-white py-3 rounded-xl font-bold hover:bg-green-700 transition">L∆∞u thay ƒë·ªïi Ng√¢n h√†ng ƒë·ªÅ</button>
                </div>
            `;
        }
        
        // --- Giao di·ªán Modal Nh·∫≠p d·ªØ li·ªáu t·ª´ File ---

        const questionTypes = [
            { id: 'vocab_mcq', label: '1. Tr·∫Øc nghi·ªám (T·ª´ v·ª±ng, Pinyin, Nghƒ©a)', example: 't·ª´ v·ª±ng|pinyin|nghƒ©a' },
            { id: 'listen_mcq', label: '2. Nghe √¢m thanh ch·ªçn nghƒ©a (T·ª´ v·ª±ng)', example: 't·ª´ v·ª±ng|pinyin|nghƒ©a' },
            { id: 'fib', label: '3. ƒêi·ªÅn t·ª´ c√≤n thi·∫øu (FIB)', example: 'C√¢u c√≥ ch·ªó tr·ªëng|t·ª´ c·∫ßn ƒëi·ªÅn' },
            { id: 'jumble', label: '4. X·∫øp t·ª´ th√†nh c√¢u (Jumble)', example: 'C√¢u ƒë√∫ng c√°ch nhau b·∫±ng d·∫•u c√°ch' },
            { id: 'translation', label: '5. D·ªãch c√¢u (Vi·ªát - Trung)', example: 'c√¢u ti·∫øng trung|c√¢u ti·∫øng vi·ªát' },
            { id: 'listen_translate', label: '6. Nghe c√¢u d·ªãch nghƒ©a (C√¢u)', example: 'c√¢u ti·∫øng trung|c√¢u ti·∫øng vi·ªát' },
            { id: 'listen_write', label: '7. Nghe c√¢u vi·∫øt l·∫°i (C√¢u)', example: 'c√¢u ti·∫øng trung|c√¢u ti·∫øng vi·ªát' },
            { id: 'listen_conversation', label: '9. Nghe h·ªôi tho·∫°i & Tr·∫£ l·ªùi (File TXT n√¢ng cao)', example: '# Script... [HT1] C√¢u h·ªèi? [TL] A|B*|C|D' },
            { id: 'order_sentences', label: '10. S·∫Øp x·∫øp c√¢u (File TXT)', example: '#\nC√¢u 1\nC√¢u 2...' },
            { id: 'reading_comprehension', label: '11. ƒê·ªçc hi·ªÉu vƒÉn b·∫£n (File TXT)', example: '#\nƒêo·∫°n vƒÉn...\n[H] C√¢u h·ªèi?\n[TL] A|B*|C|D' },
    // Lo·∫°i 8, 9, 10... c√≥ th·ªÉ th√™m v√†o ƒë√¢y
        ];
        
        const getImportInstructions = (type) => {
             const typeData = questionTypes.find(t => t.id === type);
             if (!typeData) return { instructions: 'Kh√¥ng t√¨m th·∫•y lo·∫°i c√¢u h·ªèi.', structure: '' };

             const instructionsMap = {
                 'vocab_mcq': { 
                     instructions: 'T·∫°o t·ª´ v·ª±ng, Pinyin, v√† Nghƒ©a. H·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông t·∫°o c√°c b√†i tr·∫Øc nghi·ªám ch·ªçn nghƒ©a, ch·ªçn Pinyin, v√† ch·ªçn t·ª´.', 
                     structure: 't·ª´ v·ª±ng|pinyin|nghƒ©a' 
                 },
                 'listen_mcq': { 
                     instructions: 'T·∫°o t·ª´ v·ª±ng, Pinyin, v√† Nghƒ©a. H·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông t·∫°o b√†i tr·∫Øc nghi·ªám Nghe (ph√°t √¢m t·ª´) v√† ch·ªçn nghƒ©a.', 
                     structure: 't·ª´ v·ª±ng|pinyin|nghƒ©a' 
                 },
                 'fib': { 
                     instructions: 'M·ªói d√≤ng l√† m·ªôt c√¢u h·ªèi ƒëi·ªÅn t·ª´. T·ª´ c·∫ßn ƒëi·ªÅn ph·∫£i n·∫±m gi·ªØa hai k√≠ t·ª± g·∫°ch ƒë·ª©ng (v√≠ d·ª•: |ch·ª£|)', 
                     structure: 'H√¥m nay t√¥i ƒëi |ch·ª£| mua rau.' 
                 },
                 'jumble': { 
                     instructions: 'M·ªói d√≤ng l√† m·ªôt c√¢u ho√†n ch·ªânh. C√°c t·ª´ trong c√¢u ph·∫£i ƒë∆∞·ª£c ph√¢n t√°ch b·∫±ng D·∫§U C√ÅCH. H·ªá th·ªëng s·∫Ω x√°o tr·ªôn c√°c t·ª´ n√†y.', 
                     structure: 'T√¥i y√™u h·ªçc ti·∫øng Vi·ªát' 
                 },
                 'translation': { 
                     instructions: 'M·ªói d√≤ng l√† m·ªôt c·∫∑p c√¢u ti·∫øng Trung - ti·∫øng Vi·ªát. C√¢u h·ªèi s·∫Ω y√™u c·∫ßu d·ªãch t·ª´ TV sang TC.', 
                     structure: 'ÊàëÁà±‰Ω†|T√¥i y√™u b·∫°n' 
                 },
                 'listen_translate': { 
                     instructions: 'M·ªói d√≤ng l√† m·ªôt c·∫∑p c√¢u ti·∫øng Trung - ti·∫øng Vi·ªát. H·ªá th·ªëng s·∫Ω ph√°t √¢m c√¢u TC v√† y√™u c·∫ßu d·ªãch sang TV.', 
                     structure: '‰Ω†Â•ΩÂêó|B·∫°n kh·ªèe kh√¥ng' 
                 },
                 'listen_write': { 
                     instructions: 'M·ªói d√≤ng l√† m·ªôt c·∫∑p c√¢u ti·∫øng Trung - ti·∫øng Vi·ªát. H·ªá th·ªëng s·∫Ω ph√°t √¢m c√¢u TC v√† y√™u c·∫ßu vi·∫øt l·∫°i c√¢u TC.', 
                     structure: 'ÊàëÊòØÂ≠¶Áîü|T√¥i l√† h·ªçc sinh' 
                 },
                 'listen_conversation': { 
                     instructions: 'D√πng d·∫•u # ƒë·ªÉ ngƒÉn c√°ch c√°c b√†i. D√≤ng [HT...] ch·ª©a t√™n file √¢m thanh v√† c√¢u h·ªèi. D√≤ng [TL] ch·ª©a c√°c ƒë√°p √°n ngƒÉn c√°ch b·ªüi d·∫•u |, th√™m d·∫•u * sau ƒë√°p √°n ƒë√∫ng.', 
                     structure: '#\nA: ‰Ω†Â•Ω\nB: ‰Ω†Â•Ω\n[HT1] C√¢u h·ªèi l√† g√¨?\n[TL] ƒê√°p √°n A|ƒê√°p √°n B*|ƒê√°p √°n C|ƒê√°p √°n D' 
                 },
                'order_sentences': { 
                     instructions: 'S·ª≠ d·ª•ng d·∫•u # ƒë·ªÉ ngƒÉn c√°ch c√°c b√†i t·∫≠p. Trong m·ªói b√†i, nh·∫≠p c√°c c√¢u theo ƒê√öNG TH·ª® T·ª∞. H·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông x√°o tr·ªôn khi h·ªçc sinh l√†m b√†i.', 
                     structure: '#\nC√¢u th·ª© nh·∫•t\nC√¢u th·ª© hai\nC√¢u th·ª© ba\n#\nC√¢u 1 b√†i 2...' 
                 },
                 'reading_comprehension': { 
                     instructions: 'S·ª≠ d·ª•ng d·∫•u # ƒë·ªÉ ngƒÉn c√°ch. C√°c d√≤ng ƒë·∫ßu l√† ƒëo·∫°n vƒÉn. D√≤ng [H] l√† c√¢u h·ªèi. D√≤ng [TL] l√† ƒë√°p √°n (ngƒÉn c√°ch b·ªüi |), th√™m d·∫•u * sau ƒë√°p √°n ƒë√∫ng.', 
                     structure: '#\nƒêo·∫°n vƒÉn b·∫£n c·∫ßn ƒë·ªçc...\n[H] C√¢u h·ªèi cho ƒëo·∫°n vƒÉn?\n[TL] ƒê√°p √°n A|ƒê√°p √°n B*|ƒê√°p √°n C|ƒê√°p √°n D' 
                 }
             };
             
             return instructionsMap[type] || { instructions: 'Vui l√≤ng ch·ªçn lo·∫°i c√¢u h·ªèi ph√π h·ª£p.', structure: 'Kh√¥ng r√µ' };
        };


        const renderImportDataModal = () => {
            const currentType = state.ui.importQType;
            const { instructions, structure } = getImportInstructions(currentType);

            return `
                <div class="fixed inset-0 bg-slate-900 bg-opacity-70 flex items-center justify-center z-50 fade-in p-4" onclick="if (event.target === this) toggleImportData(false)">
                    <div class="bg-white p-6 md:p-8 rounded-2xl shadow-2xl w-full max-w-2xl transform transition-all">
                        <div class="flex justify-between items-center mb-6 border-b pb-4">
                            <h3 class="text-xl md:text-2xl font-bold text-yellow-700">Nh·∫≠p d·ªØ li·ªáu t·ª´ File (.txt)</h3>
                            <button onclick="toggleImportData(false)" class="text-slate-500 hover:text-red-500"><i data-lucide="x"></i></button>
                        </div>

                        <div class="mb-6 space-y-4">
                            <div>
                                <label for="import-q-type" class="block text-sm font-medium text-slate-700 mb-1">Ch·ªçn lo·∫°i d·ªØ li·ªáu ƒë·∫ßu v√†o</label>
                                <select id="import-q-type" onchange="setImportQType(this.value)" class="w-full p-3 border-2 rounded-lg bg-slate-50 focus:border-yellow-500">
                                    ${questionTypes.map(t => `<option value="${t.id}" ${currentType === t.id ? 'selected' : ''}>${t.label}</option>`).join('')}
                                </select>
                            </div>

                            <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4 rounded-lg">
                                <p class="font-bold text-yellow-800 mb-2">ƒê·ªãnh d·∫°ng file TXT cho lo·∫°i n√†y:</p>
                                <p class="text-sm text-yellow-700 mb-2">${instructions}</p>
                                <div class="bg-yellow-100 p-2 rounded text-xs font-mono border border-yellow-300 overflow-x-auto">
                                    <span class="font-bold">C·∫•u tr√∫c m·∫´u (M·ªói d√≤ng):</span> ${structure}
                                </div>
                            </div>
                            
                            <div>
                                <label for="file-upload" class="block text-sm font-medium text-slate-700 mb-1">T·∫£i l√™n File TXT</label>
                                <input type="file" id="file-upload" accept=".txt" class="w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
                            </div>
                        </div>

                        <button onclick="handleFileImport()" class="w-full bg-yellow-600 text-white py-3 rounded-xl font-bold hover:bg-yellow-700 flex items-center justify-center gap-2 transition">
                            <i data-lucide="chevrons-down" size="20"></i> T·∫°o c√¢u h·ªèi v√† Th√™m v√†o Ng√¢n h√†ng ƒë·ªÅ
                        </button>
                    </div>
                </div>
            `;
        };
        
        // --- Giao di·ªán d√πng chung cho t·∫°o/s·ª≠a assignment v√† bank (C·∫≠p nh·∫≠t Responsive) ---
        const renderQuestionInputSection = (isEditing) => `
            <div class="p-4 border border-blue-200 rounded-xl bg-blue-50 ${isEditing ? 'mt-6' : 'mb-6'}">
                <h4 class="font-bold text-blue-800 mb-3">Th√™m c√¢u h·ªèi ${isEditing ? 'v√†o ng√¢n h√†ng ƒë·ªÅ' : 'tr·ª±c ti·∫øp'}</h4>
                
                <div class="mb-3">
                    <label class="block text-sm font-medium text-blue-800 mb-1">Ch·ªçn lo·∫°i c√¢u h·ªèi</label>
                    <select id="q-type-select" onchange="changeQuestionType(this.value)" class="w-full p-2 border border-blue-300 rounded-lg">
                        <option value="mcq" ${state.ui.newQuestionType === 'mcq' ? 'selected' : ''}>1. Tr·∫Øc nghi·ªám</option>
                        <option value="fib" ${state.ui.newQuestionType === 'fib' ? 'selected' : ''}>2. ƒêi·ªÅn t·ª´ c√≤n thi·∫øu</option>
                        <option value="jumble" ${state.ui.newQuestionType === 'jumble' ? 'selected' : ''}>3. X·∫øp t·ª´ th√†nh c√¢u</option>
                        <option value="match" ${state.ui.newQuestionType === 'match' ? 'selected' : ''}>4. Gh√©p ƒë√¥i</option>
                        <option value="translation" ${state.ui.newQuestionType === 'translation' ? 'selected' : ''}>5. D·ªãch c√¢u (Vi·ªát - Trung)</option>
                        <option value="listen_mcq" ${state.ui.newQuestionType === 'listen_mcq' ? 'selected' : ''}>6. Nghe √¢m thanh ch·ªçn nghƒ©a</option>
                        <option value="listen_write" ${state.ui.newQuestionType === 'listen_write' ? 'selected' : ''}>7. Nghe c√¢u vi·∫øt l·∫°i</option>
                        <option value="listen_translate" ${state.ui.newQuestionType === 'listen_translate' ? 'selected' : ''}>8. Nghe c√¢u d·ªãch nghƒ©a</option>
                        <option value="listen_conversation" ${state.ui.newQuestionType === 'listen_conversation' ? 'selected' : ''}>9. Nghe h·ªôi tho·∫°i & Tr·∫£ l·ªùi</option>
                       <option value="order_sentences" ${state.ui.newQuestionType === 'order_sentences' ? 'selected' : ''}>10. S·∫Øp x·∫øp c√¢u th√†nh ƒëo·∫°n vƒÉn</option>
                       <option value="reading_comprehension" ${state.ui.newQuestionType === 'reading_comprehension' ? 'selected' : ''}>11. ƒê·ªçc v√† tr·∫£ l·ªùi c√¢u h·ªèi</option>
                   <option value="make_sentence" ${state.ui.newQuestionType === 'make_sentence' ? 'selected' : ''}>12. ƒê·∫∑t c√¢u v·ªõi t·ª´ cho tr∆∞·ªõc (T·ª± lu·∫≠n)</option>
    <option value="image_describe" ${state.ui.newQuestionType === 'image_describe' ? 'selected' : ''}>13. Nh√¨n h√¨nh ƒë·∫∑t c√¢u (T·ª± lu·∫≠n)</option>
 </select>
                </div>

                ${renderQuestionInputForm()}

                <button onclick="addQuestion()" class="text-blue-600 font-bold text-sm mt-3">+ Th√™m v√†o danh s√°ch</button>
            </div>
        `;

        const getQuestionTypeLabel = (type) => {
            const labels = {
                mcq: 'Tr·∫Øc nghi·ªám', fib: 'ƒêi·ªÅn t·ª´', jumble: 'X·∫øp t·ª´', 
                match: 'Gh√©p ƒë√¥i', translation: 'D·ªãch c√¢u',
                listen_mcq: 'Nghe - Ch·ªçn nghƒ©a', listen_write: 'Nghe - Vi·∫øt l·∫°i',
                listen_translate: 'Nghe - D·ªãch nghƒ©a',
                listen_conversation: 'Nghe h·ªôi tho·∫°i & Tr·∫£ l·ªùi',
                order_sentences: 'S·∫Øp x·∫øp c√¢u',
                reading_comprehension: 'ƒê·ªçc hi·ªÉu vƒÉn b·∫£n'
            };
            return labels[type] || 'Kh√¥ng x√°c ƒë·ªãnh';
        };

const renderQuestionDisplay = (q, qIdx) => {
            const typeLabel = getQuestionTypeLabel(q.type);
            
            let content = '';
            let mainText = q.vietnamese || q.text || '';
            let audioInfo = '';
            
            if (q.audioText) {
                audioInfo = `<p class="text-purple-600 font-bold mb-2 flex items-center gap-1"><i data-lucide="volume-2" size="18"></i> √Çm thanh: ${q.audioText}</p>`;
            } else if (q.audioUrl) {
                 audioInfo = `<p class="text-purple-600 font-bold mb-2 flex items-center gap-1"><i data-lucide="volume-2" size="18"></i> C√≥ file √¢m thanh</p>`;
            }

            switch(q.type) {
                case 'mcq':
                    const correctOption = q.options[q.correct];
                    content = `ƒê√°p √°n ƒë√∫ng: <span class="font-bold text-green-700">(${correctOption})</span>`;
                    content += `<div class="mt-2 space-y-1 text-xs">` + q.options.map((opt, i) => 
                        `<p class="${i === q.correct ? 'text-green-600 font-bold' : 'text-slate-500'}">${String.fromCharCode(65+i)}. ${opt}</p>`
                    ).join('') + `</div>`;
                    break;

                case 'listen_mcq':
                case 'listen_conversation': 
                    if (q.type === 'listen_conversation') {
                         mainText = `[H·ªôi tho·∫°i] ${q.text}`;
                         if (q.conversationContent) {
                             content += `<div class="mb-2 p-2 bg-slate-50 rounded text-xs text-slate-500 italic border border-slate-200 whitespace-pre-line">${q.conversationContent}</div>`;
                         }
                    }
                    const correctListenOption = q.options[q.correct];
                    content += `ƒê√°p √°n ƒë√∫ng: <span class="font-bold text-green-700">(${correctListenOption})</span>`;
                    content += `<div class="mt-2 space-y-1 text-xs">` + q.options.map((opt, i) => 
                        `<p class="${i === q.correct ? 'text-green-600 font-bold' : 'text-slate-500'}">${String.fromCharCode(65+i)}. ${opt}</p>`
                    ).join('') + `</div>`;
                    break;

                case 'reading_comprehension':
                    mainText = `[C√¢u h·ªèi] ${q.text}`;
                    if (q.conversationContent) {
                         content += `
                            <div class="mb-3 p-3 bg-white border border-slate-200 rounded-lg text-sm text-slate-700 whitespace-pre-line shadow-sm leading-relaxed font-serif">
                                ${formatText(q.conversationContent)}
                            </div>
                         `;
                    }
                    const correctReadingOption = q.options[q.correct];
                    content += `ƒê√°p √°n ƒë√∫ng: <span class="font-bold text-green-700">(${correctReadingOption})</span>`;
                    content += `<div class="mt-2 space-y-1 text-xs">` + q.options.map((opt, i) => 
                        `<p class="${i === q.correct ? 'text-green-600 font-bold' : 'text-slate-500'}">${String.fromCharCode(65+i)}. ${opt}</p>`
                    ).join('') + `</div>`;
                    break;

                case 'fib':
                    content = `C√¢u: ${q.text.replace('[BLANK]', '<span class="text-blue-600 font-bold">______</span>')}<br>ƒê√°p √°n: **${q.answer}**`;
                    break;
                case 'jumble':
                    content = `C√¢u ƒë√∫ng: **${q.answer.join(' ')}**`;
                    break;
                case 'order_sentences':
                    const sentences = Array.isArray(q.answer) ? q.answer : [];
                    content = `<p class="text-xs font-bold text-slate-500 mb-1">Th·ª© t·ª± ƒë√∫ng:</p>`;
                    content += `<div class="space-y-1">` + 
                        sentences.map((s, i) => `
                            <div class="p-2 bg-green-50 border border-green-200 rounded flex gap-2 text-sm">
                                <span class="font-bold text-green-700">${i+1}.</span> 
                                <span class="text-slate-800">${s}</span>
                            </div>
                        `).join('') + 
                        `</div>`;
                    break;
                case 'match':
                    content = 'C√°c c·∫∑p gh√©p n·ªëi:<br>' + q.pairs.map(p => `**${p.a}** -> **${p.b}**`).join('<br>');
                    break;
                case 'translation':
                    content = `C√¢u TV: ${q.vietnamese}<br>ƒê√°p √°n TC: **${q.chinese}**`;
                    break;
                case 'listen_write':
                    mainText = `Y√™u c·∫ßu: ${q.text || 'Vi·∫øt l·∫°i c√¢u ƒë√£ nghe'}`;
                    content = `ƒê√°p √°n: **${q.answer}**`;
                    break;
                case 'listen_translate':
                    mainText = `Y√™u c·∫ßu: ${q.text || 'D·ªãch c√¢u ƒë√£ nghe sang ti·∫øng Vi·ªát'}`;
                    content = `ƒê√°p √°n (TV): **${q.answer}**`;
                    break;
            }

            // [ƒê√É S·ª¨A] Th√™m ƒëi·ªÅu ki·ªán check challengeMode
            const isEditable = state.ui.viewAssignmentId 
                            || state.ui.bankMode === 'view' 
                            || state.ui.bankMode === 'create' 
                            || state.ui.isCreatingAssignment
                            || state.ui.challengeMode === 'create' 
                            || state.ui.challengeMode === 'edit';

            return `
                <div id="q-card-${qIdx}"
	onclick="window.focusQuestion(${qIdx})" 
                     class="p-3 md:p-4 border rounded-xl bg-white mb-2 flex justify-between items-start transition-all cursor-pointer relative
                     ${state.ui.focusedIndex === qIdx 
                        ? 'border-blue-500 ring-2 ring-blue-200 shadow-lg z-10 transform scale-[1.01]' 
                        : 'border-slate-200 hover:border-blue-300 hover:shadow-md'
                     }">
                     
                     ${state.ui.focusedIndex === qIdx ? 
                        `` : ''
                     }
                    <div class="flex-1">
                        <div class="font-bold text-blue-600 mb-1 text-sm md:text-base">C√¢u ${qIdx+1}: ${typeLabel}</div>
                        ${audioInfo}
                        <p class="font-medium mb-1 text-sm md:text-base">${mainText}</p>
                        <div class="text-xs md:text-sm text-slate-700 mt-2">
                            ${content}
                        </div>
                    </div>
${isEditable ? `
                        <div class="flex gap-1 ml-2 flex-shrink-0">
                            <button onclick="openEditQuestion(${qIdx}, '${state.view === 'challenges' ? 'challenge' : 'assignment'}')" 
                                class="text-blue-500 hover:text-blue-700 p-2 rounded-full bg-blue-50 hover:bg-blue-100 transition shadow-sm" 
                                title="S·ª≠a n·ªôi dung">
                                <i data-lucide="pencil" size="18"></i>
                            </button>
                            
                            <button onclick="removeQuestionInEdit(${qIdx})" 
                                class="text-red-400 hover:text-red-600 p-2 rounded-full bg-red-50 hover:bg-red-100 transition shadow-sm" 
                                title="X√≥a c√¢u h·ªèi n√†y">
                                <i data-lucide="minus-circle" size="18"></i>
                            </button>
                        </div>
                    ` : ''}
                </div>
            `;
        };

const renderQuestionInputForm = () => {
            const type = state.ui.newQuestionType;
            
            // L·∫•y gi√° tr·ªã C·∫•p ƒë·ªô v√† B√†i h·ªçc ƒëang ch·ªçn
            const lvl = document.getElementById('assign-level') ? document.getElementById('assign-level').value : 'H1';
            const lsn = document.getElementById('assign-lesson') ? document.getElementById('assign-lesson').value : 'Bai1';
            const folderName = `${lvl}_${lsn}`;

            const renderPathNote = (placeholder) => `
                <div class="mb-3 p-3 bg-slate-100 rounded-lg border border-slate-200 text-xs text-slate-600">
                    <p><i data-lucide="folder-open" class="inline w-3 h-3"></i> File s·∫Ω ƒë∆∞·ª£c l·∫•y t·ª´:</p>
                    <p class="font-mono mt-1 text-blue-600 font-bold break-all">data_Edubattle/${folderName}/<span class="text-red-500">{${placeholder}}</span>.mp3</p>
                </div>
            `;

            let inputs = '';
            
            // Helper t·∫°o giao di·ªán 1 d√≤ng ƒë√°p √°n c√≥ n√∫t t√≠ch
            const renderOptionRow = (idx, placeholder) => `
                <div class="flex items-center gap-3 mb-2">
                    <div class="flex items-center justify-center">
                        <input type="radio" name="mcq_correct_input" value="${idx}" ${idx === 0 ? 'checked' : ''} 
                               class="w-6 h-6 text-green-600 bg-gray-100 border-gray-300 focus:ring-green-500 cursor-pointer accent-green-600" title="Ch·ªçn l√†m ƒë√°p √°n ƒë√∫ng">
                    </div>
                    <input id="opt-${idx}" class="flex-1 p-2 border rounded-lg focus:border-green-500 transition" placeholder="${placeholder}">
                </div>
            `;
            // Helper cho listen mcq
            const renderListenOptionRow = (idx, placeholder) => `
                <div class="flex items-center gap-3 mb-2">
                    <div class="flex items-center justify-center">
                        <input type="radio" name="lmcq_correct_input" value="${idx}" ${idx === 0 ? 'checked' : ''} 
                               class="w-6 h-6 text-green-600 bg-gray-100 border-gray-300 focus:ring-green-500 cursor-pointer accent-green-600" title="Ch·ªçn l√†m ƒë√°p √°n ƒë√∫ng">
                    </div>
                    <input id="lmcq-opt-${idx}" class="flex-1 p-2 border rounded-lg focus:border-green-500 transition" placeholder="${placeholder}">
                </div>
            `;

            switch (type) {
                // --- 1. TR·∫ÆC NGHI·ªÜM (MCQ) - ƒê√É C·∫¨P NH·∫¨T GIAO DI·ªÜN ---
                case 'mcq':
                    inputs = `
                        <input id="q-text" class="w-full p-2 border rounded-lg mb-4" placeholder="N·ªôi dung c√¢u h·ªèi">
                        <p class="text-xs font-bold text-slate-500 mb-2 uppercase">Nh·∫≠p ƒë√°p √°n & T√≠ch ch·ªçn c√¢u ƒë√∫ng:</p>
                        <div class="space-y-1 mb-3">
                            ${renderOptionRow(0, 'ƒê√°p √°n A')}
                            ${renderOptionRow(1, 'ƒê√°p √°n B')}
                            ${renderOptionRow(2, 'ƒê√°p √°n C')}
                            ${renderOptionRow(3, 'ƒê√°p √°n D')}
                        </div>
                    `;
                    break;

                case 'fib':
                    inputs = `
                        <p class="text-sm text-slate-500 mb-2">S·ª≠ d·ª•ng chu·ªói <code>[BLANK]</code> ƒë·ªÉ ƒë√°nh d·∫•u v·ªã tr√≠ ƒëi·ªÅn t·ª´.</p>
                        <input id="fib-text" class="w-full p-2 border rounded-lg mb-3" placeholder="V√≠ d·ª•: H√¥m nay t√¥i ƒëi [BLANK]...">
                        <input id="fib-answer" class="w-full p-2 border rounded-lg mb-3" placeholder="ƒê√°p √°n ƒë√∫ng (V√≠ d·ª•: ch·ª£)">
                    `;
                    break;
                case 'jumble':
                    inputs = `
                        <p class="text-sm text-slate-500 mb-2">Nh·∫≠p c√¢u ƒë√∫ng. C√°c t·ª´ s·∫Ω ƒë∆∞·ª£c t·ª± ƒë·ªông t√°ch v√† x√°o tr·ªôn.</p>
                        <input id="jumble-answer" class="w-full p-2 border rounded-lg mb-3" placeholder="V√≠ d·ª•: T√¥i y√™u h·ªçc ti·∫øng Vi·ªát">
                    `;
                    break;
                case 'match':
                    inputs = `
                        <p class="text-sm text-slate-500 mb-2">Nh·∫≠p 3 c·∫∑p gh√©p n·ªëi (C·ªôt A: C√¢u h·ªèi, C·ªôt B: ƒê√°p √°n).</p>
                        <div class="grid grid-cols-2 gap-3 mb-3">
                            <input id="match-a0" class="p-2 border rounded" placeholder="C·ªôt A - C√¢u h·ªèi 1">
                            <input id="match-b0" class="p-2 border rounded" placeholder="C·ªôt B - ƒê√°p √°n 1">
                            <input id="match-a1" class="p-2 border rounded" placeholder="C·ªôt A - C√¢u h·ªèi 2">
                            <input id="match-b1" class="p-2 border rounded" placeholder="C·ªôt B - ƒê√°p √°n 2">
                            <input id="match-a2" class="p-2 border rounded" placeholder="C·ªôt A - C√¢u h·ªèi 3">
                            <input id="match-b2" class="p-2 border rounded" placeholder="C·ªôt B - ƒê√°p √°n 3">
                        </div>
                    `;
                    break;
                case 'translation':
                    inputs = `
                        <p class="text-sm text-slate-500 mb-2">Y√™u c·∫ßu d·ªãch c√¢u ti·∫øng Vi·ªát sang ti·∫øng Trung.</p>
                        <input id="trans-vn" class="w-full p-2 border rounded-lg mb-3" placeholder="C√¢u ti·∫øng Vi·ªát (V√≠ d·ª•: T√¥i y√™u b·∫°n)">
                        <input id="trans-cn" class="w-full p-2 border rounded-lg mb-3" placeholder="ƒê√°p √°n ti·∫øng Trung (V√≠ d·ª•: ÊàëÁà±‰Ω†)">
                    `;
                    break;

                // --- 2. NGHE TR·∫ÆC NGHI·ªÜM (LISTEN MCQ) - ƒê√É C·∫¨P NH·∫¨T GIAO DI·ªÜN ---
                case 'listen_mcq':
                    inputs = `
                        ${renderPathNote('T√™n_file')}
                        <div class="flex items-center gap-2 mb-4">
                            <input id="listen-mcq-audio" class="flex-1 p-2 border rounded-lg font-bold text-blue-700" placeholder="Nh·∫≠p t√™n file (V√≠ d·ª•: ‰Ω†Â•Ω)">
                            <span class="text-slate-400 font-mono">.mp3</span>
                        </div>
                        <p class="text-xs font-bold text-slate-500 mb-2 uppercase">Nh·∫≠p nghƒ©a & T√≠ch ch·ªçn c√¢u ƒë√∫ng:</p>
                        <div class="space-y-1 mb-3">
                            ${renderListenOptionRow(0, 'Nghƒ©a A')}
                            ${renderListenOptionRow(1, 'Nghƒ©a B')}
                            ${renderListenOptionRow(2, 'Nghƒ©a C')}
                            ${renderListenOptionRow(3, 'Nghƒ©a D')}
                        </div>
                    `;
                    break;

                case 'listen_write':
                    inputs = `
                        ${renderPathNote('T√™n_file')}
                        <div class="flex items-center gap-2 mb-3">
                            <input id="listen-write-audio" class="flex-1 p-2 border rounded-lg font-bold text-blue-700" placeholder="Nh·∫≠p t√™n file (V√≠ d·ª•: ÊàëÊòØÂ≠¶Áîü)">
                            <span class="text-slate-400 font-mono">.mp3</span>
                        </div>
                        <input id="listen-write-answer" class="w-full p-2 border rounded-lg mb-3" placeholder="ƒê√°p √°n ƒë√∫ng (Vi·∫øt l·∫°i ch√≠nh x√°c c√¢u TC)">
                    `;
                    break;
                case 'listen_translate':
                    inputs = `
                        ${renderPathNote('T√™n_file')}
                        <div class="flex items-center gap-2 mb-3">
                            <input id="listen-trans-audio" class="flex-1 p-2 border rounded-lg font-bold text-blue-700" placeholder="Nh·∫≠p t√™n file (V√≠ d·ª•: ‰Ω†Â•ΩÂêó)">
                            <span class="text-slate-400 font-mono">.mp3</span>
                        </div>
                        <input id="listen-trans-answer" class="w-full p-2 border rounded-lg mb-3" placeholder="ƒê√°p √°n ƒë√∫ng (D·ªãch sang ti·∫øng Vi·ªát)">
                    `;
                    break;
               case 'listen_conversation':
                    inputs = `
                        ${renderPathNote('T√™n_file_h·ªôi_tho·∫°i')}
                        <div class="flex items-center gap-2 mb-3">
                            <input id="listen-conv-file" class="flex-1 p-2 border rounded-lg font-bold text-blue-700" placeholder="Nh·∫≠p t√™n file MP3 (V√≠ d·ª•: conversation_1)">
                            <span class="text-slate-400 font-mono">.mp3</span>
                        </div>
                        
                        <label class="block text-xs font-bold text-slate-500 mb-1 uppercase">N·ªôi dung h·ªôi tho·∫°i (Script - D√†nh cho GV/Review):</label>
                        <textarea id="listen-conv-script" rows="3" class="w-full p-2 border rounded-lg mb-3" placeholder="A: ‰Ω†Â•Ω! \nB: ‰Ω†Â•Ω!..."></textarea>

                        <label class="block text-xs font-bold text-slate-500 mb-1 uppercase">C√¢u h·ªèi:</label>
                        <input id="q-text" class="w-full p-2 border rounded-lg mb-4" placeholder="V√≠ d·ª•: Hai ng∆∞·ªùi n√†y ƒëang ·ªü ƒë√¢u?">
                        
                        <p class="text-xs font-bold text-slate-500 mb-2 uppercase">C√°c l·ª±a ch·ªçn & ƒê√°p √°n ƒë√∫ng:</p>
                        <div class="space-y-1 mb-3">
                            ${renderOptionRow(0, 'L·ª±a ch·ªçn A')}
                            ${renderOptionRow(1, 'L·ª±a ch·ªçn B')}
                            ${renderOptionRow(2, 'L·ª±a ch·ªçn C')}
                            ${renderOptionRow(3, 'L·ª±a ch·ªçn D')}
                        </div>
                    `;
                    break;
               case 'order_sentences':
                    inputs = `
                        <div class="bg-yellow-50 p-4 rounded-lg border border-yellow-200 mb-4">
                            <label class="block text-sm font-bold text-slate-800 mb-2">Nh·∫≠p c√°c c√¢u theo ƒê√öNG TH·ª® T·ª∞ (M·ªói c√¢u 1 d√≤ng):</label>
                            <p class="text-xs text-slate-500 mb-2 italic">H·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông x√°o tr·ªôn th·ª© t·ª± n√†y khi h·ªçc sinh l√†m b√†i.</p>
                            <textarea id="order-sentences-input" rows="6" class="w-full p-3 border-2 border-yellow-300 rounded-xl focus:border-yellow-500 outline-none font-medium" placeholder="V√≠ d·ª•:\nXin ch√†o, b·∫°n t√™n l√† g√¨?\nT√¥i t√™n l√† Nam.\nR·∫•t vui ƒë∆∞·ª£c l√†m quen."></textarea>
                        </div>
                    `;
                    break;
                  case 'reading_comprehension':
                    inputs = `
                        <label class="block text-xs font-bold text-slate-500 mb-1 uppercase">ƒêo·∫°n vƒÉn b·∫£n:</label>
                        <textarea id="reading-passage" rows="5" class="w-full p-3 border rounded-lg mb-3 font-medium" placeholder="Nh·∫≠p ƒëo·∫°n vƒÉn b·∫£n t·∫°i ƒë√¢y..."></textarea>

                        <label class="block text-xs font-bold text-slate-500 mb-1 uppercase">C√¢u h·ªèi:</label>
                        <input id="q-text" class="w-full p-2 border rounded-lg mb-4" placeholder="V√≠ d·ª•: Nh√¢n v·∫≠t ch√≠nh l√†m ngh·ªÅ g√¨?">
                        
                        <p class="text-xs font-bold text-slate-500 mb-2 uppercase">C√°c l·ª±a ch·ªçn & ƒê√°p √°n ƒë√∫ng:</p>
                        <div class="space-y-1 mb-3">
                            ${renderOptionRow(0, 'L·ª±a ch·ªçn A')}
                            ${renderOptionRow(1, 'L·ª±a ch·ªçn B')}
                            ${renderOptionRow(2, 'L·ª±a ch·ªçn C')}
                            ${renderOptionRow(3, 'L·ª±a ch·ªçn D')}
                        </div>
                    `;
                    break;
// T√åM H√ÄM renderQuestionInputForm V√Ä TH√äM V√ÄO SWITCH CASE:

case 'make_sentence':
    inputs = `
        <label class="block text-sm font-bold text-slate-700 mb-1">C√°c t·ª´ g·ª£i √Ω (ngƒÉn c√°ch b·∫±ng d·∫•u ph·∫©y)</label>
        <input id="prompt-words" class="w-full p-2 border rounded-lg mb-3" placeholder="V√≠ d·ª•: gia ƒë√¨nh, h·∫°nh ph√∫c, ch·ªß nh·∫≠t">
        <label class="block text-sm font-bold text-slate-700 mb-1">G·ª£i √Ω ƒë√°p √°n (D√†nh cho GV tham kh·∫£o khi ch·∫•m)</label>
        <input id="suggested-answer" class="w-full p-2 border rounded-lg mb-3" placeholder="V√≠ d·ª•: Gia ƒë√¨nh t√¥i r·∫•t h·∫°nh ph√∫c v√†o ng√†y ch·ªß nh·∫≠t.">
    `;
    break;

case 'image_describe':
    inputs = `
        <label class="block text-sm font-bold text-slate-700 mb-1">URL H√¨nh ·∫£nh</label>
        <input id="image-url" class="w-full p-2 border rounded-lg mb-2" placeholder="https://example.com/image.jpg">
        <p class="text-xs text-slate-500 mb-3">Copy link ·∫£nh t·ª´ internet v√† d√°n v√†o ƒë√¢y.</p>
        <label class="block text-sm font-bold text-slate-700 mb-1">Y√™u c·∫ßu / C√¢u h·ªèi</label>
        <input id="q-text" class="w-full p-2 border rounded-lg mb-3" placeholder="V√≠ d·ª•: H√£y ƒë·∫∑t m·ªôt c√¢u mi√™u t·∫£ b·ª©c tranh n√†y.">
        <label class="block text-sm font-bold text-slate-700 mb-1">G·ª£i √Ω ƒë√°p √°n (Tham kh·∫£o)</label>
        <input id="suggested-answer" class="w-full p-2 border rounded-lg mb-3" placeholder="ƒê√°p √°n m·∫´u...">
    `;
    break;
            }
            return inputs;
        };
        const renderClassSelector = () => {
            const myClasses = state.data.classes.filter(c => c.teacherId === state.user.uid);
            
            if (myClasses.length === 0) {
                 return `
                    <div class="mb-4 p-3 bg-red-50 border border-red-300 rounded-xl text-red-700 text-sm">
                        <i data-lucide="alert-triangle" size="18" class="inline-block mr-1"></i> 
                        B·∫°n ch∆∞a c√≥ l·ªõp h·ªçc n√†o. Vui l√≤ng t·∫°o l·ªõp t·∫°i tab "Qu·∫£n l√Ω L·ªõp h·ªçc" tr∆∞·ªõc.
                    </div>
                `;
            }
            
            // L·∫•y danh s√°ch classIds ƒë√£ ch·ªçn t·ª´ state.ui.newAssignment
            const selectedIds = state.ui.newAssignment.selectedClassIds || [];

            return `
                <div class="mb-6 p-4 border border-green-300 rounded-xl bg-green-50">
                    <h4 class="font-bold text-green-800 mb-3">Ch·ªçn L·ªõp h·ªçc ƒë·ªÉ giao b√†i (B·∫Øt bu·ªôc)</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3 max-h-40 overflow-y-auto pr-2">
                        ${myClasses.map(c => `
                            <label class="flex items-center p-2 border rounded-lg cursor-pointer transition ${selectedIds.includes(c.id) ? 'bg-green-600 text-white border-green-700' : 'bg-white hover:bg-green-100'}">
                                <input type="checkbox" value="${c.id}" 
                                    onchange="handleClassSelection(this.value, this.checked)" 
                                    ${selectedIds.includes(c.id) ? 'checked' : ''} 
                                    class="mr-2 rounded text-green-600 focus:ring-green-500">
                                <span>${c.title} <span class="text-xs font-bold ${selectedIds.includes(c.id) ? 'text-green-300' : 'text-slate-500'}">(${c.classCode})</span></span>
                            </label>
                        `).join('')}
                    </div>
                    ${selectedIds.length === 0 ? '<p class="text-xs text-red-500 mt-2">Vui l√≤ng ch·ªçn √≠t nh·∫•t m·ªôt l·ªõp h·ªçc.</p>' : ''}
                </div>
            `;
        }

const renderCreateAssignmentForm = () => {
            const qList = state.ui.newAssignment.questions.map((q, idx) => renderQuestionDisplay(q, idx)).join('');
            const myBanks = state.data.questionBanks.filter(b => b.createdBy === state.user.uid);
            
            // Context check
            const isClassContext = state.ui.newAssignment.selectedClassIds.length === 1 && 
                                   state.ui.viewClassId === state.ui.newAssignment.selectedClassIds[0];
            const contextClass = isClassContext ? state.data.classes.find(c => c.id === state.ui.viewClassId) : null;
            
            let classSelectorHtml = isClassContext && contextClass ? `
                    <div class="mb-6 p-4 border border-green-300 rounded-xl bg-green-50">
                        <h4 class="font-bold text-green-800 mb-1">Giao b√†i cho L·ªõp:</h4>
                        <p class="text-xl font-bold text-green-700 truncate">${contextClass.title}</p>
                        <button onclick="toggleCreate(false); viewClass('${contextClass.id}')" class="mt-3 text-xs text-green-800 underline hover:no-underline">(Quay l·∫°i l·ªõp h·ªçc)</button>
                    </div>
                 ` : renderClassSelector();

            // T·∫°o danh s√°ch B√†i h·ªçc (1 -> 50)
            const lessonOptions = Array.from({length: 50}, (_, i) => i + 1).map(i => 
                `<option value="Bai${i}" ${state.ui.newAssignment.lesson === `Bai${i}` ? 'selected' : ''}>B√†i ${i}</option>`
            ).join('');
            
            // T·∫°o danh s√°ch C·∫•p ƒë·ªô (H1 -> H6)
            const levels = ['H1', 'H2', 'H3', 'H4', 'H5', 'H6'];
            const levelOptions = levels.map(l => 
                `<option value="${l}" ${state.ui.newAssignment.level === l ? 'selected' : ''}>${l}</option>`
            ).join('');

            // Script nh·ªè ƒë·ªÉ c·∫≠p nh·∫≠t text xem tr∆∞·ªõc
            const updatePreviewScript = `
                const lvl = document.getElementById('assign-level').value;
                const lsn = document.getElementById('assign-lesson').value;
                document.getElementById('folder-preview').textContent = lvl + '_' + lsn;
            `;

            return `
<div class="bg-white p-4 md:p-6 rounded-2xl shadow-lg fade-in max-w-4xl mx-auto relative">
                    <div class="flex justify-between items-center mb-4 md:mb-6 border-b pb-3 sticky top-0 bg-white z-10 pt-2">
                        <h3 class="text-xl font-bold text-slate-800">T·∫°o b√†i t·∫≠p m·ªõi</h3>
                        
                        <div class="flex items-center gap-2">
                            <button onclick="publishAssignment()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-xl font-bold text-sm shadow-md flex items-center gap-2 transition hover:scale-105 active:scale-95">
                                <i data-lucide="save" size="18"></i> L∆∞u
                            </button>
                            
                            <button onclick="${isClassContext ? `toggleCreate(false); viewClass('${contextClass.id}')` : `toggleCreate(false)`}" class="p-2 text-slate-400 hover:text-red-500 hover:bg-slate-100 rounded-full transition" title="ƒê√≥ng">
                                <i data-lucide="x" size="24"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                        <div>
                            <label class="block text-sm font-medium text-slate-600 mb-1">Ti√™u ƒë·ªÅ b√†i t·∫≠p</label>
                            <input id="new-assign-title" class="w-full text-lg font-bold border-b-2 border-slate-200 p-2 outline-none focus:border-blue-500" placeholder="Ti√™u ƒë·ªÅ..." value="${state.ui.newAssignment.title}">
                        </div>
                        
                        <div class="bg-blue-50 p-3 rounded-lg border border-blue-200">
                            <label class="block text-xs font-bold text-blue-800 mb-2 uppercase">Ngu·ªìn √¢m thanh (C·∫•p ƒë·ªô & B√†i)</label>
                            <div class="flex gap-2">
                                <select id="assign-level" onchange="${updatePreviewScript}" class="flex-1 p-2 border rounded-lg font-bold text-blue-700">
                                    ${levelOptions}
                                </select>
                                <select id="assign-lesson" onchange="${updatePreviewScript}" class="flex-1 p-2 border rounded-lg font-bold text-blue-700">
                                    ${lessonOptions}
                                </select>
                            </div>
                            <p class="text-xs text-blue-500 mt-2 truncate">
                                ƒê∆∞·ªùng d·∫´n: <b>data_Edubattle/<span id="folder-preview">H1_Bai1</span>/ten_file.mp3</b>
                            </p>
                        </div>
                    </div>

                    <div class="mb-6">
                        <label class="block text-sm font-bold text-slate-700 mb-1">Th·ªùi gian l√†m b√†i (Ph√∫t)</label>
                        <div class="flex items-center gap-2">
                            <input id="new-assign-time" type="number" min="0" class="w-32 p-2 border-2 rounded-lg text-center font-bold focus:border-blue-500" placeholder="0" value="${state.ui.newAssignment.timeLimit || ''}">
                            <span class="text-slate-500 text-sm">(ƒê·ªÉ tr·ªëng ho·∫∑c 0 n·∫øu kh√¥ng gi·ªõi h·∫°n)</span>
                        </div>
                    </div>
                    ${classSelectorHtml}
                    
                    <h4 class="text-lg font-bold text-slate-800 mb-3">Danh s√°ch c√¢u h·ªèi (${state.ui.newAssignment.questions.length})</h4>
                    <div id="questions-preview" class="space-y-4 border p-4 rounded-xl bg-slate-50 max-h-96 overflow-y-auto">${qList || '<p class="text-slate-500">Ch∆∞a c√≥ c√¢u h·ªèi n√†o.</p>'}</div>

<div class="mb-6 space-y-4">
    <button onclick="setSelectingBankQuestions(true)" ${myBanks.length === 0 ? 'disabled' : ''} class="w-full bg-yellow-100 text-yellow-700 py-3 rounded-xl font-bold border border-yellow-300 hover:bg-yellow-200 transition ${myBanks.length === 0 ? 'opacity-50 cursor-not-allowed' : ''}">
        <i data-lucide="plus-square" size="18" class="inline-block mr-2"></i> L·∫•y c√¢u h·ªèi t·ª´ Ng√¢n h√†ng ƒë·ªÅ
    </button>
    
    <label class="w-full bg-green-100 text-green-700 py-3 rounded-xl font-bold border border-green-300 hover:bg-green-200 transition flex items-center justify-center cursor-pointer">
        <i data-lucide="upload" size="18" class="inline-block mr-2"></i> T·∫£i c√¢u h·ªèi t·ª´ file JSON
        <input type="file" accept=".json" class="hidden" onchange="handleAssignmentJSONUpload(event)">
    </label>
    ${myBanks.length === 0 ? '<p class="text-xs text-center text-red-500">Ch∆∞a c√≥ ng√¢n h√†ng ƒë·ªÅ n√†o. Vui l√≤ng t·∫°o t·∫°i tab "Ng√¢n h√†ng ƒë·ªÅ".</p>' : ''}
</div>

                    ${renderQuestionInputSection(false)}

                    <button onclick="publishAssignment()" class="w-full bg-blue-600 text-white py-3 rounded-xl font-bold hover:bg-blue-700 transition">Xu·∫•t b·∫£n b√†i t·∫≠p</button>
                </div>
            `;
        };
        
const renderQuestionSelectionFromBank = () => {
            // L·∫•y danh s√°ch ng√¢n h√†ng ƒë·ªÅ
            const myBanks = (state.data.questionBanks || []).filter(b => b.createdBy === state.user.uid);
            const selectedBank = myBanks.find(b => b.id === state.ui.selectedBankId);
            
            if (!selectedBank) {
                return `
                    <div class="bg-white p-4 md:p-6 rounded-2xl shadow-lg fade-in max-w-4xl mx-auto">
                        <h3 class="text-xl font-bold text-yellow-600 mb-6 border-b pb-3">Ch·ªçn Ng√¢n h√†ng ƒë·ªÅ ngu·ªìn</h3>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            ${myBanks.map(bank => `
                                <button onclick="selectBankToDraw('${bank.id}')" class="p-4 rounded-xl shadow-md border border-slate-200 hover:bg-yellow-50 text-left transition relative overflow-hidden group">
                                    <div class="absolute inset-0 bg-yellow-100 opacity-0 group-hover:opacity-20 transition"></div>
                                    <p class="font-bold text-slate-800 text-lg truncate">${bank.title}</p>
                                    <p class="text-sm text-slate-500 mt-1"><i data-lucide="layers" class="inline w-3 h-3"></i> ${bank.questions.length} c√¢u h·ªèi</p>
                                </button>
                            `).join('')}
                        </div>
                        <button onclick="setSelectingBankQuestions(false)" class="mt-6 text-slate-500 text-sm hover:text-red-500 flex items-center gap-1"><i data-lucide="arrow-left" class="w-4 h-4"></i> Quay l·∫°i</button>
                    </div>
                `;
            }

            const availableQuestions = selectedBank.questions || [];
            
            // [FIX L·ªñI L·∫∂P BI·∫æN T·∫†I ƒê√ÇY] Ch·ªâ khai b√°o 1 l·∫ßn
            let currentAssignmentQs = [];
            if (state.view === 'challenges') {
                currentAssignmentQs = state.ui.activeChallenge.questions || [];
            } else {
                currentAssignmentQs = state.ui.newAssignment.questions || [];
            }
            
            // Logic th·ªëng k√™
            const typeStats = availableQuestions.reduce((acc, q) => {
                const label = getQuestionTypeLabel(q.type);
                if (!acc[q.type]) acc[q.type] = { label: label, count: 0 };
                acc[q.type].count++;
                return acc;
            }, {});

            const statsInputs = Object.keys(typeStats).map(type => {
                const info = typeStats[type];
                return `
                    <div class="flex items-center justify-between p-3 bg-slate-50 rounded-lg border border-slate-200">
                        <div>
                            <p class="font-bold text-slate-700 text-sm">${info.label}</p>
                            <p class="text-xs text-slate-500">C√≥ s·∫µn: <span class="font-bold text-blue-600">${info.count}</span></p>
                        </div>
                        <div class="flex items-center gap-2">
                            <label class="text-xs text-slate-500 font-bold">L·∫•y:</label>
                            <input type="number" id="count-for-${type}" min="0" max="${info.count}" value="0" 
                                class="w-14 p-1 text-center border-2 border-slate-300 rounded-lg focus:border-blue-500 font-bold text-sm">
                        </div>
                    </div>
                `;
            }).join('');

            // Logic hi·ªÉn th·ªã danh s√°ch
            const manualList = availableQuestions.map((q, idx) => {
                const isSelected = currentAssignmentQs.some(existQ => 
                    JSON.stringify({t: existQ.text, o: existQ.options, a: existQ.answer}) === 
                    JSON.stringify({t: q.text, o: q.options, a: q.answer})
                );

                let previewText = '';
                switch(q.type) {
                    case 'listen_mcq': case 'listen_write': case 'listen_translate':
                    case 'listen_conversation': 
                        previewText = `<span class="text-purple-600 font-bold">[Audio]</span> ${q.text}`; break;
                    case 'jumble':
                        const jumbleAns = Array.isArray(q.answer) ? q.answer.join(' ') : q.answer;
                        previewText = `<span class="text-green-600 font-bold">[C√¢u: ${jumbleAns}]</span>`; break;
                    case 'order_sentences':
                        const orderAns = Array.isArray(q.answer) ? q.answer.join(' / ') : '...';
                        previewText = `<span class="text-teal-600 font-bold">[S·∫Øp x·∫øp]</span> <span class="italic text-slate-600">${orderAns}</span>`; 
                        break;
                     case 'reading_comprehension':
                        previewText = `<span class="text-teal-700 font-bold">[ƒê·ªçc hi·ªÉu]</span> ${q.text}`; 
                        break;
                    case 'match':
                        const pairsText = q.pairs ? q.pairs.map(p => `${p.a}-${p.b}`).join(', ') : '';
                        previewText = `<span class="text-orange-600 font-bold">[C·∫∑p: ${pairsText}]</span>`; break;
                    case 'translation':
                        previewText = `<span class="text-blue-600 font-bold">[D·ªãch]</span> ${q.vietnamese}`; break;
                    default:
                        previewText = q.text;
                }
                const formattedPreview = formatText(previewText);
                const qTextClean = previewText.replace(/<[^>]*>?/gm, '');

                return `
                    <div class="flex items-center justify-between p-3 border-b last:border-0 hover:bg-slate-50 transition group">
                        <div class="pr-3 overflow-hidden flex-1">
                            <span class="text-[10px] font-bold text-slate-400 uppercase tracking-wider border border-slate-200 px-1 rounded">${getQuestionTypeLabel(q.type)}</span>
                            <div class="text-sm font-medium text-slate-800 truncate mt-1" title="${qTextClean}">
                                ${formattedPreview}
                            </div>
                        </div>
                        <button id="btn-select-${idx}" onclick="selectQuestionFromBank(${idx})" 
                            class="flex-shrink-0 px-3 py-1.5 rounded-lg text-xs font-bold transition flex items-center gap-1 shadow-sm w-20 justify-center
                            ${isSelected ? 'bg-red-100 text-red-600 hover:bg-red-200 border border-red-200' : 'bg-blue-600 text-white hover:bg-blue-700'}">
                            ${isSelected ? '<i data-lucide="minus" class="w-3 h-3"></i> B·ªè' : '<i data-lucide="plus" class="w-3 h-3"></i> Ch·ªçn'}
                        </button>
                    </div>
                `;
            }).join('');

            return `
                <div class="bg-white p-4 md:p-6 rounded-2xl shadow-lg fade-in max-w-6xl mx-auto flex flex-col h-[85vh] md:h-[90vh]">
                    <div class="flex justify-between items-center mb-4 border-b pb-3 flex-shrink-0">
                        <div>
                            <h3 class="text-xl font-bold text-slate-800">Bank: <span class="text-yellow-600">${selectedBank.title}</span></h3>
                            <p class="text-xs text-slate-500">ƒê√£ ch·ªçn: <span id="total-selected-count" class="font-bold text-blue-600 text-lg">${currentAssignmentQs.length}</span> c√¢u v√†o b√†i t·∫≠p</p>
                        </div>
                        <button onclick="setSelectingBankQuestions(false)" class="text-slate-400 hover:text-red-500 bg-slate-100 p-2 rounded-full"><i data-lucide="x" size="20"></i></button>
                    </div>
                    
                    <div class="flex-1 overflow-hidden grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <div class="lg:col-span-1 flex flex-col overflow-y-auto pr-1">
                            <div class="bg-blue-50 p-4 rounded-xl border border-blue-200 mb-4 shadow-sm">
                                <h4 class="font-bold text-blue-800 mb-3 text-sm uppercase flex items-center gap-2"><i data-lucide="shuffle" class="w-4 h-4"></i> 1. L·∫•y Ng·∫´u nhi√™n</h4>
                                <div class="grid grid-cols-1 gap-2 mb-4">
                                    ${statsInputs || '<p class="text-xs text-slate-400 italic">Ng√¢n h√†ng ƒë·ªÅ tr·ªëng.</p>'}
                                </div>
                                <button onclick="addRandomQuestions('${selectedBank.id}')" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-2 rounded-lg font-bold shadow-md transition text-sm flex items-center justify-center gap-2">
                                    <i data-lucide="plus-circle" class="w-4 h-4"></i> Th√™m ng·∫´u nhi√™n
                                </button>
                            </div>
                            
                            <button onclick="selectBankToDraw(null)" class="w-full py-3 rounded-xl bg-slate-100 text-slate-600 font-bold hover:bg-slate-200 transition text-sm mt-auto">
                                <i data-lucide="arrow-left" class="w-4 h-4 inline"></i> Ch·ªçn Bank kh√°c
                            </button>
                        </div>

                        <div class="lg:col-span-2 flex flex-col h-full border-2 border-slate-200 rounded-xl overflow-hidden shadow-sm">
                            <div class="bg-slate-100 p-3 border-b text-xs font-bold text-slate-600 flex justify-between uppercase tracking-wider items-center">
                                <span class="flex items-center gap-2"><i data-lucide="check-square" class="w-4 h-4"></i> 2. Ch·ªçn th·ªß c√¥ng t·ª´ng c√¢u</span>
                                <span class="text-slate-400">Tr·∫°ng th√°i</span>
                            </div>
                            <div class="flex-1 overflow-y-auto p-0 bg-white">
                                ${manualList || '<div class="p-8 text-center text-slate-400">Ch∆∞a c√≥ c√¢u h·ªèi n√†o.</div>'}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        };
        const renderAssignmentDetails = () => {
            const assign = state.data.assignments.find(a => a.id === state.ui.viewAssignmentId);
            if (!assign) return `<p class="text-red-500">Kh√¥ng t√¨m th·∫•y b√†i t·∫≠p.</p>`;
            
            if (state.ui.isSelectingBankQuestions) {
                 return renderQuestionSelectionFromBank(); 
            }

            // D√πng l·∫°i state.ui.newAssignment ƒë·ªÉ ch·ªânh s·ª≠a t·∫°m th·ªùi
            if (!state.ui.newAssignment.id || state.ui.newAssignment.id !== assign.id) {
                // Kh·ªüi t·∫°o tr·∫°ng th√°i ch·ªânh s·ª≠a
                state.ui.newAssignment = { 
                    ...assign, 
                    questions: JSON.parse(JSON.stringify(assign.questions)),
                    selectedClassIds: assign.classIds || [] 
                };
                state.ui.newQuestionType = 'mcq';
            }

            const qList = state.ui.newAssignment.questions.map((q, idx) => renderQuestionDisplay(q, idx)).join('');
            const myBanks = state.data.questionBanks.filter(b => b.createdBy === state.user.uid);


            return `
                <div class="bg-white p-4 md:p-6 rounded-2xl shadow-lg fade-in max-w-4xl mx-auto">
                    <div class="flex justify-between mb-4 md:mb-6 border-b pb-3">
                        <h3 class="text-xl font-bold text-yellow-600">Ch·ªânh s·ª≠a b√†i t·∫≠p</h3>
                        <div class="flex items-center gap-2">
                            <!-- N√öT IN B√ÄI T·∫¨P (M·ªöI) -->
                            <button onclick="printAssignment('${assign.id}')" class="bg-indigo-500 hover:bg-indigo-600 text-white px-3 py-2 rounded-xl font-bold text-sm shadow-md flex items-center gap-2 transition">
                                <i data-lucide="printer" size="18"></i> In b√†i t·∫≠p
                            </button>
                            <button onclick="viewAssignmentDetails(null)" class="p-2 text-slate-500 hover:text-red-500"><i data-lucide="x"></i></button>
                        </div>
                    </div>
                    
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-slate-600 mb-1">Ti√™u ƒë·ªÅ</label>
                        <input id="edit-assign-title" class="w-full text-lg font-bold border-b-2 border-slate-200 p-2 outline-none focus:border-blue-500" value="${state.ui.newAssignment.title}">
                    </div>
                    <div class="mb-6">
                        <label class="block text-sm font-bold text-slate-700 mb-1">Th·ªùi gian l√†m b√†i (Ph√∫t)</label>
                        <div class="flex items-center gap-2">
                            <input id="edit-assign-time" type="number" min="0" 
                                class="w-32 p-2 border-2 rounded-lg text-center font-bold focus:border-blue-500" 
                                placeholder="0" 
                                value="${state.ui.newAssignment.timeLimit || ''}"> <span class="text-slate-500 text-sm">(ƒê·ªÉ tr·ªëng ho·∫∑c 0 n·∫øu kh√¥ng gi·ªõi h·∫°n)</span>
                        </div>
                    </div>
                    ${renderClassSelector()}

                    <h4 class="text-lg font-bold text-slate-800 mb-3">Danh s√°ch c√¢u h·ªèi (${state.ui.newAssignment.questions.length})</h4>
                    <div id="questions-preview" class="space-y-4 border p-4 rounded-xl bg-slate-50 max-h-96 overflow-y-auto">${qList || '<p class="text-slate-500">Ch∆∞a c√≥ c√¢u h·ªèi n√†o.</p>'}</div>

                    <div class="mb-6 space-y-4">
                        <button onclick="setSelectingBankQuestions(true)" ${myBanks.length === 0 ? 'disabled' : ''} class="w-full bg-yellow-100 text-yellow-700 py-3 rounded-xl font-bold border border-yellow-300 hover:bg-yellow-200 transition ${myBanks.length === 0 ? 'opacity-50 cursor-not-allowed' : ''}">
                            <i data-lucide="plus-square" size="18" class="inline-block mr-2"></i> Th√™m c√¢u h·ªèi t·ª´ Ng√¢n h√†ng ƒë·ªÅ
                        </button>
                        ${myBanks.length === 0 ? '<p class="text-xs text-center text-red-500">Ch∆∞a c√≥ ng√¢n h√†ng ƒë·ªÅ n√†o. Vui l√≤ng t·∫°o t·∫°i tab "Ng√¢n h√†ng ƒë·ªÅ".</p>' : ''}
                    </div>

                    ${renderQuestionInputSection(true)}

                    <button onclick="saveAssignmentChanges('${assign.id}')" class="w-full bg-green-600 text-white py-3 rounded-xl font-bold hover:bg-green-700 transition">L∆∞u thay ƒë·ªïi</button>
                </div>
            `;
        };
        
        // --- H√ÄM RENDER M·ªòT C√ÇU H·ªéI ƒê∆†N L·∫∫ KHI L√ÄM B√ÄI (C·∫≠p nh·∫≠t Responsive) ---
// --- H√ÄM RENDER M·ªòT C√ÇU H·ªéI ƒê∆†N L·∫∫ KHI L√ÄM B√ÄI (FULL: C√ì NGHE H·ªòI THO·∫†I) ---
        const renderTakeAssignmentQuestion = (q, qIdx) => {
            const userAnswer = state.ui.assignmentAnswers[qIdx];
            let content = '';

            // 1. X·ª¨ L√ù N√öT √ÇM THANH
            const audioText = q.audioText || q.audioWord;
            const audioUrl = q.audioUrl; 
            const audioId = `audio-ref-${qIdx}`; 
            
            let audioButtonHtml = '';
            
            if (audioUrl) {
                // Audio t·ª´ File (MP3)
                audioButtonHtml = `
                    <audio id="${audioId}" src="${audioUrl}" style="display:none"></audio>
                    <button onclick="playCustomAudio('${audioId}', this)" 
                        class="flex-shrink-0 w-12 h-12 rounded-full bg-purple-100 text-purple-700 flex items-center justify-center hover:bg-purple-200 transition shadow-sm border-2 border-purple-200"
                        title="Nghe √¢m thanh">
                        <i data-lucide="volume-2" size="24"></i>
                    </button>
                `;
            } else if (audioText) {
                // Audio TTS (Gi·ªçng ƒë·ªçc m√°y)
                const audioLang = 'zh-CN'; 
                audioButtonHtml = `
                    <button onclick="speakWord('${audioText.replace(/'/g, "\\'")}', '${audioLang}')" 
                        class="flex-shrink-0 w-12 h-12 rounded-full bg-purple-100 text-purple-700 flex items-center justify-center hover:bg-purple-200 transition shadow-sm border-2 border-purple-200"
                        title="Nghe ƒë·ªçc (TTS)">
                        <i data-lucide="volume-2" size="24"></i>
                    </button>
                `;
            }

            // 2. X·ª¨ L√ù TI√äU ƒê·ªÄ (HEADER)
            // S·ª≠ d·ª•ng formatText ƒë·ªÉ in ƒë·∫≠m/xanh c√°c t·ª´ kh√≥a
            let headerText = formatText(q.text || q.vietnamese || '');

            if (q.type === 'fib') {
                const fibContent = q.text.replace('[BLANK]', '<span class="text-blue-600 font-bold border-b-2 border-blue-400 px-2">______</span>');
                headerText = `ƒêi·ªÅn t·ª´ th√≠ch h·ª£p:<br><span class="text-xl mt-2 block">${formatText(fibContent)}</span>`;
            } else if (q.type === 'translation') {
                headerText = `D·ªãch sang ti·∫øng Trung:<br><span class="text-blue-600 font-bold text-xl mt-2 block">${formatText(q.vietnamese)}</span>`;
            } else if (q.type === 'listen_mcq') {
                headerText = `Nghe v√† ch·ªçn nghƒ©a ƒë√∫ng:`;
            } else if (q.type === 'listen_conversation') {
                // --- [M·ªöI] HI·ªÇN TH·ªä TI√äU ƒê·ªÄ CHO B√ÄI NGHE H·ªòI THO·∫†I ---
                headerText = `Nghe h·ªôi tho·∫°i v√† tr·∫£ l·ªùi:<br><span class="text-blue-800 text-xl mt-2 block font-medium">${formatText(q.text)}</span>`;
            } else if (q.type === 'jumble') {
                 headerText = `S·∫Øp x·∫øp c√°c t·ª´ th√†nh c√¢u ho√†n ch·ªânh:`;
            } else if (q.type === 'order_sentences') {
                 headerText = `S·∫Øp x·∫øp c√¢u theo ƒë√∫ng th·ª© t·ª±:`;
            } else if (q.type === 'reading_comprehension') {
                headerText = `ƒê·ªçc ƒëo·∫°n vƒÉn v√† tr·∫£ l·ªùi c√¢u h·ªèi:`;
            }

            let headerHtml = `
                <div class="flex items-center justify-center gap-4 mb-8">
                    <div class="text-xl md:text-2xl font-bold text-slate-800 leading-relaxed text-left md:text-center flex-1">
                        ${headerText}
                    </div>
                    ${audioButtonHtml}
                </div>
            `;

            // 3. X·ª¨ L√ù N·ªòI DUNG ƒê√ÅP √ÅN
            let placeholderText = '';
            let inputId = `input-q-${qIdx}`;

            switch (q.type) {
                case 'mcq':
                case 'listen_mcq': 
                case 'listen_conversation': // --- [M·ªöI] D√ôNG CHUNG GIAO DI·ªÜN TR·∫ÆC NGHI·ªÜM ---
                    content = q.options.map((opt, oIdx) => `
                        <button onclick="selectAnswer(${qIdx}, ${oIdx})" 
                            class="w-full text-left p-4 md:p-5 border-2 rounded-2xl transition-all transform active:scale-[0.99] font-medium text-base md:text-xl mb-3 flex items-center
                            ${userAnswer === oIdx ? 'bg-blue-600 text-white border-blue-600 shadow-lg ring-4 ring-blue-100' : 'bg-white border-slate-200 hover:bg-blue-50 text-slate-700 hover:border-blue-300 hover:shadow-md'}">
                            <span class="font-black mr-4 w-8 h-8 rounded-full bg-slate-100 text-slate-600 flex items-center justify-center text-sm ${userAnswer === oIdx ? 'bg-white text-blue-600' : ''}">${String.fromCharCode(65 + oIdx)}</span>
                            ${opt}
                        </button>
                    `).join('');
                    content = `<div class="mt-2 max-w-3xl mx-auto grid gap-2">${content}</div>`;
                    break;
                
                case 'jumble': 
                    const availableWords = q.shuffledWords || q.answer; 
                    const placedWords = window.getJumbleAnswer(qIdx);
                    const remainingWords = availableWords.filter(word => {
                        const availableCount = availableWords.filter(w => w === word).length;
                        const placedCount = placedWords.filter(w => w === word).length;
                        return placedCount < availableCount;
                    });
                    content = `
                        <div class="mb-6 p-4 border-2 border-dashed border-blue-300 rounded-2xl bg-blue-50 min-h-[5rem] flex flex-wrap items-center gap-2 justify-center transition-colors">
                            ${placedWords.map((word, wIdx) => `
                                <button onclick="removeJumbleWord(${qIdx}, '${word}', ${wIdx})" class="jumble-word bg-blue-600 text-white shadow-md px-4 py-2 rounded-xl font-bold text-lg">${word} <i data-lucide="x" class="w-4 h-4 ml-1 inline opacity-70"></i></button>
                            `).join('')}
                        </div>
                        <div class="flex flex-wrap gap-2 justify-center p-6 bg-slate-100 rounded-2xl border border-slate-200">
                            ${remainingWords.map(word => `
                                <button onclick="addJumbleWord(${qIdx}, '${word}')" class="jumble-word bg-white border hover:border-blue-500 px-4 py-2 rounded-xl font-bold shadow-sm text-lg text-slate-700">${word}</button>
                            `).join('')}
                        </div>
                    `;
                    break;

                case 'match':
                    const colB = q.shuffledColB || q.pairs.map(p => p.b).sort(() => Math.random() - 0.5); 
                    const colA = q.pairs.map(p => p.a);
                    const currentMatches = state.ui.assignmentAnswers[qIdx] || {};
                    content = `
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-4 text-left">
                            <div class="bg-blue-50 p-4 rounded-2xl border border-blue-100">
                                <h4 class="font-bold text-blue-800 mb-4 flex items-center gap-2"><i data-lucide="list" class="w-4 h-4"></i> C·ªôt A</h4>
                                ${colA.map((textA, aIdx) => `<div class="p-4 bg-white border border-blue-200 mb-3 rounded-xl text-base font-medium shadow-sm flex items-center"><span class="bg-blue-100 text-blue-700 w-6 h-6 rounded-full inline-flex items-center justify-center text-xs font-bold mr-3 flex-shrink-0">${aIdx + 1}</span>${formatText(textA)}</div>`).join('')}
                            </div>
                            <div class="bg-green-50 p-4 rounded-2xl border border-green-100">
                                <h4 class="font-bold text-green-800 mb-4 flex items-center gap-2"><i data-lucide="link" class="w-4 h-4"></i> C·ªôt B (Ch·ªçn ƒë√°p √°n)</h4>
                                ${colA.map((_, aIdx) => {
                                    const selectedBIndex = currentMatches[aIdx] === undefined ? "" : currentMatches[aIdx];
                                    return `<div class="relative mb-3"><select onchange="selectMatchAnswer(${qIdx}, ${aIdx}, this.value)" class="w-full p-4 border-2 rounded-xl text-base appearance-none cursor-pointer outline-none transition ${selectedBIndex !== "" ? 'border-green-500 bg-green-600 text-white font-bold shadow-md' : 'bg-white border-green-200 text-slate-600 hover:border-green-400'}"><option value="" class="bg-white text-slate-500">-- Gh√©p v·ªõi c√¢u ${aIdx+1} --</option>${colB.map((textB, bIdx) => `<option value="${bIdx}" class="bg-white text-slate-800" ${selectedBIndex == bIdx ? 'selected' : ''}>${String.fromCharCode(65+bIdx)}. ${textB}</option>`).join('')}</select></div>`;
                                }).join('')}
                            </div>
                        </div>
                    `;
                    break;
                case 'order_sentences':
                    const availableSentences = q.shuffledSentences || q.answer; 
                    const placedSentences = state.ui.assignmentAnswers[qIdx] || [];
                    
                    // L·ªçc ra c√°c c√¢u ch∆∞a ƒë∆∞·ª£c ch·ªçn
                    const remainingSentences = availableSentences.filter(s => {
                        const availableCount = availableSentences.filter(i => i === s).length;
                        const placedCount = placedSentences.filter(i => i === s).length;
                        return placedCount < availableCount;
                    });

                    content = `
                        <div class="mb-6 p-4 border-2 border-dashed border-blue-400 rounded-xl bg-blue-50 min-h-[100px] flex flex-col gap-2 transition-colors">
                            ${placedSentences.length === 0 ? '<div class="text-center text-slate-400 italic py-4">Nh·∫•n v√†o c√°c c√¢u b√™n d∆∞·ªõi ƒë·ªÉ ƒë∆∞a v√†o ƒë√¢y</div>' : ''}
                            ${placedSentences.map((s, sIdx) => `
                                <button onclick="removeOrderedSentence(${qIdx}, ${sIdx})" 
                                    class="w-full text-left p-3 bg-white border border-blue-200 rounded-lg shadow-sm hover:bg-red-50 hover:border-red-200 hover:text-red-600 transition flex justify-between items-center group animate-in fade-in slide-in-from-bottom-2">
                                    <span class="font-medium">${s}</span>
                                    <i data-lucide="x" class="w-4 h-4 opacity-0 group-hover:opacity-100"></i>
                                </button>
                            `).join('')}
                        </div>

                        <div class="flex flex-col gap-2 p-4 bg-slate-100 rounded-xl border border-slate-200">
                            ${remainingSentences.map(s => `
                                <button onclick="addOrderedSentence(${qIdx}, '${s.replace(/'/g, "\\'")}')" 
                                    class="w-full text-left p-3 bg-white border border-slate-300 rounded-lg shadow-sm hover:bg-blue-50 hover:border-blue-400 hover:text-blue-700 transition font-medium">
                                    ${s}
                                </button>
                            `).join('')}
                        </div>
                    `;
                    break;
case 'reading_comprehension': // <--- TH√äM V√ÄO ƒê√ÇY
                    
                    // N·∫øu l√† b√†i ƒê·ªçc hi·ªÉu, hi·ªÉn th·ªã ƒëo·∫°n vƒÉn tr∆∞·ªõc
                    let extraContent = '';
                    if (q.type === 'reading_comprehension' && q.conversationContent) {
                        extraContent = `
                            <div class="mb-6 p-4 md:p-6 bg-white border-2 border-slate-200 rounded-2xl shadow-sm text-left">
                                <div class="text-base md:text-lg text-slate-700 leading-relaxed whitespace-pre-line font-serif">
                                    ${formatText(q.conversationContent)}
                                </div>
                            </div>
                            <div class="text-xl md:text-2xl font-bold text-slate-800 mb-4 text-left">${formatText(q.text)}</div>
                        `;
                    }

                    // Render c√°c n√∫t ch·ªçn ƒë√°p √°n
                    const optionsHtml = q.options.map((opt, oIdx) => `
                        <button onclick="selectAnswer(${qIdx}, ${oIdx})" 
                            class="w-full text-left p-4 md:p-5 border-2 rounded-2xl transition-all transform active:scale-[0.99] font-medium text-base md:text-xl mb-3 flex items-center
                            ${userAnswer === oIdx ? 'bg-blue-600 text-white border-blue-600 shadow-lg ring-4 ring-blue-100' : 'bg-white border-slate-200 hover:bg-blue-50 text-slate-700 hover:border-blue-300 hover:shadow-md'}">
                            <span class="font-black mr-4 w-8 h-8 rounded-full bg-slate-100 text-slate-600 flex items-center justify-center text-sm ${userAnswer === oIdx ? 'bg-white text-blue-600' : ''}">${String.fromCharCode(65 + oIdx)}</span>
                            ${opt}
                        </button>
                    `).join('');
                    
                    content = `<div class="mt-2 max-w-3xl mx-auto grid gap-2">${extraContent}${optionsHtml}</div>`;
                    break;
case 'make_sentence':
    content = `
 
        <textarea id="${inputId}" oninput="captureInputAnswer(${qIdx}, this.value)" 
            class="w-full p-4 border-2 border-slate-300 rounded-xl focus:border-blue-500 outline-none text-lg min-h-[100px]" 
            placeholder="Nh·∫≠p c√¢u tr·∫£ l·ªùi c·ªßa b·∫°n v√†o ƒë√¢y..." >${userAnswer || ''}</textarea>
    `;
    break;

case 'image_describe':
    content = `
        <div class="mb-4 flex justify-center">
            <img src="${q.imageUrl}" alt="Question Image" class="max-w-full max-h-64 rounded-xl shadow-md object-contain border border-slate-200">
        </div>
        <textarea id="${inputId}" oninput="captureInputAnswer(${qIdx}, this.value)" 
            class="w-full p-4 border-2 border-slate-300 rounded-xl focus:border-blue-500 outline-none text-lg min-h-[100px]" 
            placeholder="Mi√™u t·∫£ b·ª©c tranh ho·∫∑c tr·∫£ l·ªùi c√¢u h·ªèi..." >${userAnswer || ''}</textarea>
    `;
    break;
            }
            
            // Input Text (ƒêi·ªÅn t·ª´, D·ªãch, Vi·∫øt l·∫°i)
            if (['fib', 'translation', 'listen_write', 'listen_translate'].includes(q.type)) {
                if(q.type === 'listen_write') placeholderText = 'Nh·∫≠p c√¢u ti·∫øng Trung ƒë√£ nghe...';
                if(q.type === 'listen_translate') placeholderText = 'Nh·∫≠p b·∫£n d·ªãch ti·∫øng Vi·ªát...';
                
                const initialValue = userAnswer || '';
                content = `
                    <div class="text-center mt-6">
                        <input type="text" id="${inputId}" oninput="captureInputAnswer(${qIdx}, this.value)" value="${initialValue}" 
                            class="w-full p-5 text-lg border-2 border-slate-300 rounded-2xl focus:border-blue-500 outline-none text-center font-bold shadow-sm transition-all focus:ring-4 focus:ring-blue-100" 
                            placeholder="${placeholderText}" autocomplete="off" />
                    </div>
                `;
            }

            return `
                <div class="mb-8 fade-in text-center max-w-5xl mx-auto">
                    ${headerHtml}
                    <div class="w-full">
                        ${content}
                    </div>
                </div>
            `;
        };

        // --- H√ÄM C·∫¨P NH·∫¨T UI C·ª§C B·ªò CHO CH·∫æ ƒê·ªò L√ÄM B√ÄI T·∫¨P (FIX SCROLL JUMP) ---
        window.updateAssignmentQuestionUI = (assign, qIndex) => {
            const questionEl = document.getElementById('assignment-question-content');
            if (!questionEl) return;
            
            const totalQuestions = assign.questions.length;
            const currentQ = assign.questions[qIndex];
            const questionHtml = renderTakeAssignmentQuestion(currentQ, qIndex);

            // G√°n l·∫°i n·ªôi dung c√¢u h·ªèi
            questionEl.innerHTML = questionHtml;
            
            // C·∫≠p nh·∫≠t b·ªô ƒë·∫øm
            document.getElementById('assignment-q-counter').textContent = `C√¢u h·ªèi ${qIndex + 1} / ${totalQuestions}`;

            // C·∫≠p nh·∫≠t n√∫t ƒëi·ªÅu h∆∞·ªõng
            const isFirst = qIndex === 0;
            const isLast = qIndex === totalQuestions - 1;
            
            const prevBtn = document.getElementById('prev-q-btn');
            const nextContainer = document.getElementById('next-q-btn-container');

            if (prevBtn) {
                prevBtn.disabled = isFirst;
                prevBtn.classList.toggle('text-slate-400', isFirst);
                prevBtn.classList.toggle('cursor-not-allowed', isFirst);
                prevBtn.classList.toggle('bg-slate-100', isFirst);
                prevBtn.classList.toggle('bg-slate-200', !isFirst);
                prevBtn.classList.toggle('hover:bg-slate-300', !isFirst);
            }

            if (nextContainer) {
                nextContainer.innerHTML = isLast ? `
                    <button onclick="submitAssignment()" class="flex-1 bg-green-600 hover:bg-green-700 text-white py-3 px-6 rounded-xl font-bold text-lg shadow-lg transition">
                        <i data-lucide="send" size="20" class="inline-block mr-1"></i> N·ªôp b√†i
                    </button>
                ` : `
                    <button id="next-q-btn" onclick="goToNextQuestion()" 
                        class="flex items-center gap-2 px-6 py-3 rounded-xl font-bold transition bg-blue-600 hover:bg-blue-700 text-white">
                        Ti·∫øn <i data-lucide="arrow-right" size="20"></i>
                    </button>
                `;
            }

            renderIcons();
        };


        const renderTakeAssignment = () => {
            // ∆Øu ti√™n l·∫•y t·ª´ Session (ƒë√£ tr√°o)
            const assign = window.CURRENT_EXAM_SESSION || state.data.assignments.find(a => a.id === state.ui.takingAssignmentId);
            if (!assign) return '';
            
if (!assign.questions.some(q => q.shuffledWords || q.shuffledColB || q.shuffledSentences)){ 
                assign.questions.forEach(q => {
                    if (q.type === 'jumble' && q.answer) {
                        q.shuffledWords = [...q.answer].sort(() => Math.random() - 0.5); 
                    } else if (q.type === 'order_sentences' && q.answer) {
                        q.shuffledSentences = [...q.answer].sort(() => Math.random() - 0.5);
                    } else if (q.type === 'match' && q.pairs) {
                        q.shuffledColB = q.pairs.map(p => p.b).sort(() => Math.random() - 0.5);
                    }
                });
            }

            const qIndex = state.ui.currentQuestionIndex;
            const totalQuestions = assign.questions.length;
            const currentQ = assign.questions[qIndex];
            
            const isFirst = qIndex === 0;
            const isLast = qIndex === totalQuestions - 1;

            const questionHtml = renderTakeAssignmentQuestion(currentQ, qIndex);
            let timerHtml = '';
            if (assign.timeLimit) {
                // Hi·ªÉn th·ªã ƒë·ªìng h·ªì treo g√≥c ph·∫£i m√†n h√¨nh
                timerHtml = `
                    <div class="fixed top-16 right-4 z-40 bg-white border-2 border-slate-200 shadow-lg rounded-xl px-4 py-2 flex items-center gap-2 animate-bounce-in">
                        <i data-lucide="clock" class="text-slate-500 w-5 h-5"></i>
                        <span id="assignment-timer-display" class="font-mono text-xl font-bold text-slate-700">
                            ${assign.timeLimit}:00
                        </span>
                    </div>
                `;
            }
            return `
                ${timerHtml}
                <div class="max-w-3xl mx-auto bg-white p-4 md:p-8 rounded-2xl shadow-lg fade-in">
                    <div class="flex justify-between items-center mb-6 pb-4 border-b">
                        <h3 class="text-xl md:text-2xl font-bold truncate">${assign.title}</h3>
                        <button onclick="startAssignment(null)" class="text-slate-400 hover:text-red-500"><i data-lucide="x"></i></button>
                    </div>
                    
                    <div class="text-center mb-6">
                        <span id="assignment-q-counter" class="bg-blue-100 text-blue-700 px-4 py-2 rounded-full font-bold text-sm">
                            C√¢u h·ªèi ${qIndex + 1} / ${totalQuestions}
                        </span>
                    </div>

                    <div id="assignment-question-content">${questionHtml}</div>

                    <div class="mt-8 pt-6 border-t flex justify-between items-center">
                        <button id="prev-q-btn" onclick="goToPreviousQuestion()" 
                            class="flex items-center gap-2 px-4 md:px-6 py-2 md:py-3 rounded-xl font-bold transition text-sm md:text-base ${isFirst ? 'text-slate-400 cursor-not-allowed bg-slate-100' : 'bg-slate-200 hover:bg-slate-300 text-slate-700'}" 
                            ${isFirst ? 'disabled' : ''}>
                            <i data-lucide="arrow-left" size="20"></i> L√πi
                        </button>
                        
                        <div id="next-q-btn-container">
                            ${isLast ? `
                                <button onclick="submitAssignment()" class="flex-1 bg-green-600 hover:bg-green-700 text-white py-3 px-6 rounded-xl font-bold text-lg shadow-lg transition">
                                    <i data-lucide="send" size="20" class="inline-block mr-1"></i> N·ªôp b√†i
                                </button>
                            ` : `
                                <button id="next-q-btn" onclick="goToNextQuestion()" 
                                    class="flex items-center gap-2 px-4 md:px-6 py-2 md:py-3 rounded-xl font-bold transition bg-blue-600 hover:bg-blue-700 text-white text-sm md:text-base">
                                    Ti·∫øn <i data-lucide="arrow-right" size="20"></i>
                                </button>
                            `}
                        </div>
                    </div>
                </div>
            `;
        };
        

// --- H√ÄM RENDER K·∫æT QU·∫¢ B√ÄI N·ªòP (C·∫¨P NH·∫¨T: T√çNH ƒê√öNG S·ªê C√ÇU T·ª∞ LU·∫¨N ƒê√É CH·∫§M) ---
const renderSubmissionResult = () => {
    // 1. L·∫§Y D·ªÆ LI·ªÜU
    const freshSub = state.data.submissions.find(s => s.id === state.ui.viewSubmission.id);
    const sub = { ...state.ui.viewSubmission, ...freshSub };
    const assign = sub.assignment || window.CURRENT_EXAM_SESSION || state.data.assignments.find(a => a.id === sub.assignmentId);

    if (!assign) return `<p class="text-red-500">Kh√¥ng t√¨m th·∫•y b√†i t·∫≠p g·ªëc.</p>`;

    // --- X·ª¨ L√ù TR·∫†NG TH√ÅI ---
    const isPending = sub.status === 'pending';
    const scoreColor = isPending ? 'text-orange-500' : (sub.score >= 80 ? 'text-green-600' : (sub.score >= 50 ? 'text-yellow-600' : 'text-red-600'));
    
    // Header hi·ªÉn th·ªã ƒëi·ªÉm
    let headerHtml = `
        <div class="bg-white p-6 rounded-2xl shadow-lg text-center mb-6 animate-in fade-in zoom-in">
            <p class="text-slate-500 font-bold uppercase tracking-widest text-xs mb-2">K·∫øt qu·∫£ b√†i l√†m</p>
            <div class="text-6xl font-black ${scoreColor} mb-2 flex items-center justify-center gap-2">
                ${sub.score}
                ${isPending ? `<i data-lucide="clock" class="w-8 h-8 text-orange-400 animate-pulse" title="ƒêang ch·ªù ch·∫•m t·ª± lu·∫≠n"></i>` : ''}
            </div>
            <p class="text-sm font-bold text-slate-600">
                ${isPending ? '<span class="text-orange-600">ƒêi·ªÉm tr·∫Øc nghi·ªám &nbsp;‚Ä¢&nbsp; ƒêang ch·ªù ch·∫•m t·ª± lu·∫≠n</span>' : `T·ªïng ƒëi·ªÉm ch√≠nh th·ª©c`}
            </p>
        </div>
    `;

    const studentProfile = state.data.users.find(u => u.uid === sub.studentId);
    const studentName = studentProfile ? studentProfile.name : 'H·ªçc sinh';
    const isTeacher = state.profile.role === 'teacher';

    // 2. T√çNH S·ªê C√ÇU ƒê√öNG (ƒê√£ s·ª≠a ƒë·ªÉ t√≠nh c·∫£ c√¢u t·ª± lu·∫≠n)
    let correctCount = 0;
    // T√≠nh ƒëi·ªÉm trung b√¨nh m·ªói c√¢u ƒë·ªÉ l√†m m·ªëc so s√°nh cho c√¢u t·ª± lu·∫≠n
    const scorePerQuestion = 100 / assign.questions.length; 

    assign.questions.forEach((q, idx) => {
        const uAns = sub.answers[idx];
        let isRight = false;

        // --- X·ª¨ L√ù C√ÇU T·ª∞ LU·∫¨N (M·ªöI) ---
        if (['make_sentence', 'image_describe'].includes(q.type)) {
            // N·∫øu ƒë√£ c√≥ ƒëi·ªÉm ch·∫•m tay
            if (sub.manualGrades && sub.manualGrades[idx] !== undefined) {
                const mScore = parseFloat(sub.manualGrades[idx]);
                // Quy ∆∞·ªõc: ƒê∆∞·ª£c >= 50% s·ªë ƒëi·ªÉm c·ªßa c√¢u th√¨ t√≠nh l√† l√†m ƒë√∫ng
                if (mScore >= (scorePerQuestion / 2)) {
                    isRight = true;
                }
            }
        } 
        // --- C√ÅC C√ÇU TR·∫ÆC NGHI·ªÜM T·ª∞ ƒê·ªòNG ---
        else if (q.type === 'mcq' || q.type === 'listen_mcq' || q.type === 'listen_conversation' || q.type === 'reading_comprehension') {
            isRight = uAns === q.correct;
        } else if (['fib', 'translation', 'listen_write', 'listen_translate'].includes(q.type)) {
            if (uAns) {
                const expected = (q.type === 'translation' ? q.chinese : q.answer).trim().toLowerCase();
                isRight = uAns.trim().toLowerCase() === expected;
            }
        } else if (q.type === 'jumble') {
            if (Array.isArray(uAns)) isRight = uAns.join(' ') === q.answer.join(' ');
        } else if (q.type === 'order_sentences') {
            if (Array.isArray(uAns)) isRight = JSON.stringify(uAns) === JSON.stringify(q.answer);
        } else if (q.type === 'match') {
            if (uAns) {
                const subQData = sub.questionData?.[idx] || {};
                const colB = subQData.shuffledColB || q.pairs.map(p => p.b).sort(() => Math.random() - 0.5);
                const pairsCorrect = q.pairs.every((p, aIdx) => {
                    const bIdx = uAns[aIdx];
                    return colB[bIdx] === p.b;
                });
                isRight = pairsCorrect;
            }
        }

        if (isRight) correctCount++;
    });

    // 3. GIAO DI·ªÜN FEEDBACK
    let feedbackHtml = '';
    if (isTeacher) {
        feedbackHtml = `
            <div class="bg-purple-50 p-5 rounded-2xl border border-purple-200 mb-8 shadow-sm">
                <label class="block font-bold text-purple-800 mb-2 flex items-center gap-2 text-lg">
                    <i data-lucide="message-circle" size="20"></i> Nh·∫≠n x√©t c·ªßa Gi√°o vi√™n
                </label>
                <div class="flex gap-2">
                    <input id="teacher-comment-input" type="text" class="flex-1 p-3 border border-purple-300 rounded-xl focus:ring-2 focus:ring-purple-400 outline-none" placeholder="Nh·∫≠p l·ªùi nh·∫≠n x√©t..." value="${sub.teacherComment || ''}">
                    <button onclick="saveTeacherFeedback('${sub.id}')" class="bg-purple-600 hover:bg-purple-700 text-white px-6 rounded-xl font-bold transition shadow-md">L∆∞u</button>
                </div>
            </div>
        `;
    } else if (sub.teacherComment) {
        feedbackHtml = `
            <div class="bg-blue-50 p-6 rounded-2xl border border-blue-200 mb-8 relative">
                <div class="absolute -top-3 left-6 bg-blue-100 text-blue-700 px-3 py-1 rounded-full text-xs font-bold uppercase tracking-wider border border-blue-200">
                    Nh·∫≠n x√©t c·ªßa gi√°o vi√™n
                </div>
                <p class="text-blue-800 italic text-lg leading-relaxed font-medium">"${sub.teacherComment}"</p>
            </div>
        `;
    }
// Th√™m v√†o trong h√†m renderSubmissionResult, ƒëo·∫°n hi·ªÉn th·ªã cho Gi√°o vi√™n (isTeacher)
let bulkSaveBtn = '';
if (isTeacher) {
    bulkSaveBtn = `
        <div class="flex justify-end mb-4 sticky top-0 z-10 bg-white/90 backdrop-blur py-2 border-b border-slate-100">
            <button id="btn-save-all-grades" onclick="saveAllManualGrades('${sub.id}')" 
                class="bg-indigo-600 hover:bg-indigo-700 text-white px-5 py-2.5 rounded-xl font-bold shadow-lg flex items-center gap-2 transition transform hover:scale-105 active:scale-95 ring-2 ring-indigo-100">
                <i data-lucide="save-all"></i>T·ª± lu·∫≠n
            </button>
        </div>
    `;
}

// Sau ƒë√≥ nh·ªõ ch√®n bi·∫øn ${bulkSaveBtn} v√†o chu·ªói return c·ªßa h√†m renderSubmissionResult
// V√≠ d·ª• ch√®n sau ${feedbackHtml}

    // 4. RENDER CHI TI·∫æT T·ª™NG C√ÇU H·ªéI
    const renderQuestionReview = (q, qIdx) => {
        const userAnswer = sub.answers[qIdx];
        const manualGrade = sub.manualGrades ? sub.manualGrades[qIdx] : undefined;
        let isCorrect = false;
        let explanation = '';
        let scriptHtml = '';
        
        // Check ƒë√∫ng sai cho hi·ªÉn th·ªã m√†u s·∫Øc
        if (['make_sentence', 'image_describe'].includes(q.type)) {
            // V·ªõi c√¢u t·ª± lu·∫≠n, d√πng ƒëi·ªÉm ch·∫•m tay ƒë·ªÉ quy·∫øt ƒë·ªãnh m√†u xanh/ƒë·ªè
            isCorrect = manualGrade !== undefined && parseFloat(manualGrade) >= (scorePerQuestion / 2);
        } else {
            // Logic c≈© cho c√¢u t·ª± ƒë·ªông
            // (Copy l·∫°i logic check b√™n tr√™n ho·∫∑c d√πng bi·∫øn t·∫°m, ·ªü ƒë√¢y vi·∫øt l·∫°i cho g·ªçn)
             if (q.type === 'mcq' || q.type === 'listen_mcq' || q.type === 'listen_conversation' || q.type === 'reading_comprehension') {
                isCorrect = userAnswer === q.correct;
            } else if (['fib', 'translation', 'listen_write', 'listen_translate'].includes(q.type)) {
                if (userAnswer) {
                    const expected = (q.type === 'translation' ? q.chinese : q.answer).trim().toLowerCase();
                    isCorrect = userAnswer.trim().toLowerCase() === expected;
                }
            } else if (q.type === 'jumble') {
                if (Array.isArray(userAnswer)) isCorrect = userAnswer.join(' ') === q.answer.join(' ');
            } else if (q.type === 'order_sentences') {
                if (Array.isArray(userAnswer)) isCorrect = JSON.stringify(userAnswer) === JSON.stringify(q.answer);
            } else if (q.type === 'match') {
                if (userAnswer) {
                    const subQData = sub.questionData?.[qIdx] || {};
                    const colB = subQData.shuffledColB || q.pairs.map(p => p.b).sort(() => Math.random() - 0.5);
                    isCorrect = q.pairs.every((p, aIdx) => colB[userAnswer[aIdx]] === p.b);
                }
            }
        }

        const isManualType = ['make_sentence', 'image_describe'].includes(q.type);

        // --- A. GI·∫¢I TH√çCH ƒê√ÅP √ÅN ---
        switch(q.type) {
            case 'mcq': case 'listen_mcq': case 'listen_conversation': case 'reading_comprehension':
                explanation = `ƒê√°p √°n ƒë√∫ng: <strong>${q.options[q.correct]}</strong>`;
                if (!isCorrect) explanation += `<br>B·∫°n ch·ªçn: <span class="text-red-500 line-through">${q.options[userAnswer] !== undefined ? q.options[userAnswer] : 'Ch∆∞a ch·ªçn'}</span>`;
                break;
            case 'fib': case 'listen_write': case 'listen_translate':
                explanation = `ƒê√°p √°n ƒë√∫ng: <strong>${q.answer}</strong><br>B·∫°n nh·∫≠p: <span class="${isCorrect ? 'text-green-600' : 'text-red-500'}">${userAnswer || '(Tr·ªëng)'}</span>`;
                break;
            case 'translation':
                explanation = `ƒê√°p √°n ƒë√∫ng: <strong>${q.chinese}</strong><br>B·∫°n d·ªãch: <span class="${isCorrect ? 'text-green-600' : 'text-red-500'}">${userAnswer || '(Tr·ªëng)'}</span>`;
                break;
            case 'jumble':
                explanation = `C√¢u ƒë√∫ng: <strong>${q.answer.join(' ')}</strong>`;
                if (!isCorrect) explanation += `<br>B·∫°n x·∫øp: <span class="text-red-500">${Array.isArray(userAnswer) ? userAnswer.join(' ') : 'Ch∆∞a x·∫øp'}</span>`;
                break;
            case 'order_sentences':
                explanation = `Th·ª© t·ª± ƒë√∫ng:<br>${q.answer.map((s,i)=>`${i+1}. ${s}`).join('<br>')}`;
                break;
            case 'match':
                explanation = `C√°c c·∫∑p ƒë√∫ng: ${q.pairs.map(p => `${p.a} ‚ûî ${p.b}`).join(', ')}`;
                break;
            case 'make_sentence':
                explanation = `
                    <div class="mb-1"><strong>H·ªçc sinh ƒë·∫∑t c√¢u:</strong></div>
                    <div class="p-2 bg-slate-50 border rounded text-slate-800 italic mb-2">${userAnswer || 'Ch∆∞a tr·∫£ l·ªùi'}</div>
                    <div class="text-xs text-slate-500"><em>G·ª£i √Ω ƒë√°p √°n (Tham kh·∫£o): ${q.answer}</em></div>
                `;
                break;
            case 'image_describe':
                explanation = `
                    <div class="mb-2"><img src="${q.imageUrl}" class="h-32 rounded shadow-sm object-contain border bg-slate-100"></div>
                    <div class="mb-1"><strong>H·ªçc sinh m√¥ t·∫£:</strong></div>
                    <div class="p-2 bg-slate-50 border rounded text-slate-800 italic mb-2">${userAnswer || 'Ch∆∞a tr·∫£ l·ªùi'}</div>
                    <div class="text-xs text-slate-500"><em>G·ª£i √Ω ƒë√°p √°n (Tham kh·∫£o): ${q.answer}</em></div>
                `;
                break;
        }

        // --- B. HI·ªÇN TH·ªä SCRIPT (Cho b√†i Nghe/ƒê·ªçc) ---
        if ((q.type === 'listen_conversation' || q.type === 'reading_comprehension') && q.conversationContent) {
            const label = q.type === 'reading_comprehension' ? 'VƒÉn b·∫£n:' : 'N·ªôi dung h·ªôi tho·∫°i:';
            scriptHtml = `
                <div class="mt-3 p-3 bg-slate-100 rounded-lg text-xs md:text-sm text-slate-600 border border-slate-200">
                    <p class="font-bold text-slate-700 mb-1 flex items-center gap-1"><i data-lucide="file-text" size="14"></i> ${label}</p>
                    <div class="italic whitespace-pre-line leading-relaxed pl-2 border-l-2 border-slate-300">${formatText(q.conversationContent)}</div>
                </div>
            `;
        }

        // --- C. GIAO DI·ªÜN CH·∫§M ƒêI·ªÇM / TR·∫†NG TH√ÅI ---
        let gradingControl = '';
        let bgColor = '';
        let icon = '';

        if (isManualType) {
            // >>> LOGIC CHO C√ÇU T·ª∞ LU·∫¨N <<<
            if (isTeacher) {
                // GI√ÅO VI√äN: Hi·ªán √¥ nh·∫≠p ƒëi·ªÉm
                const currentScore = manualGrade !== undefined ? manualGrade : 0;
                // L√†m tr√≤n ƒëi·ªÉm hi·ªÉn th·ªã
                const maxPointsForQ = Math.round(scorePerQuestion * 100) / 100; 
                
                gradingControl = `
                    <div class="mt-3 pt-3 border-t border-slate-200 bg-yellow-50 p-3 rounded-lg flex flex-col sm:flex-row items-start sm:items-center justify-between gap-3">
                        <div class="flex items-center gap-2">
                            <i data-lucide="edit-3" class="text-yellow-600 w-4 h-4"></i>
                            <span class="font-bold text-yellow-800 text-sm">Ch·∫•m ƒëi·ªÉm (Max: ${maxPointsForQ}ƒë)</span>
                        </div>
                        <div class="flex items-center gap-2 w-full sm:w-auto">
                            <input type="number" id="manual-score-${qIdx}" value="${currentScore}" min="0" max="${maxPointsForQ}" class="w-20 p-2 border border-yellow-300 rounded text-center font-bold text-yellow-800 focus:ring-2 focus:ring-yellow-400 outline-none" placeholder="0">

                        </div>
                    </div>
                `;
                bgColor = 'bg-white border-yellow-300 ring-2 ring-yellow-50'; // Highlight c√¢u c·∫ßn ch·∫•m
                icon = '<div class="flex items-center gap-1 text-yellow-600 bg-yellow-100 px-2 py-1 rounded-full"><i data-lucide="help-circle" class="w-4 h-4"></i> <span class="font-bold text-xs">Ch·∫•m tay</span></div>';
            } else {
                // H·ªåC SINH: Hi·ªán ƒëi·ªÉm ho·∫∑c tr·∫°ng th√°i ch·ªù
                const scoreDisplay = manualGrade !== undefined ? 
                    `<span class="font-bold text-blue-600 text-lg">${manualGrade} ƒëi·ªÉm</span>` : 
                    `<span class="italic text-slate-400 font-medium bg-slate-100 px-2 py-1 rounded">ƒêang ch·ªù gi√°o vi√™n ch·∫•m...</span>`;
                
                gradingControl = `
                    <div class="mt-3 pt-3 border-t border-slate-100 flex justify-end items-center">
                        <span class="text-sm text-slate-500 mr-2">ƒêi·ªÉm chi ti·∫øt:</span> ${scoreDisplay}
                    </div>`;
                bgColor = 'bg-white border-slate-200';
                icon = '<i data-lucide="pen-tool" class="text-slate-400 w-5 h-5"></i>';
            }
        } else {
            // >>> LOGIC CHO C√ÇU T·ª∞ ƒê·ªòNG <<<
            icon = isCorrect 
                ? '<div class="flex items-center gap-1 text-green-600 bg-green-100 px-2 py-1 rounded-full"><i data-lucide="check-circle" class="w-4 h-4"></i> <span class="font-bold text-xs">ƒê√∫ng</span></div>'
                : '<div class="flex items-center gap-1 text-red-600 bg-red-100 px-2 py-1 rounded-full"><i data-lucide="x-circle" class="w-4 h-4"></i> <span class="font-bold text-xs">Sai</span></div>';
            bgColor = isCorrect ? 'bg-green-50 border-green-200' : 'bg-red-50 border-red-200';
        }

        let questionText = q.type === 'translation' ? q.vietnamese : (q.audioText ? `[Nghe] ${q.audioText}` : q.text);
        if(typeof formatText === 'function') questionText = formatText(questionText);

        return `
            <div class="p-4 rounded-xl border mb-4 ${bgColor} shadow-sm transition hover:shadow-md">
                <div class="flex items-start justify-between mb-3">
                    <div class="font-bold text-slate-800 text-sm md:text-base pr-2 leading-relaxed">
                        <span class="text-blue-600 bg-blue-50 px-2 py-0.5 rounded mr-1">C√¢u ${qIdx+1}</span>
                        ${questionText}
                    </div>
                    <div class="flex-shrink-0 ml-2">${icon}</div>
                </div>
                <div class="text-sm text-slate-700 mt-2 pl-3 border-l-4 border-slate-300/50">
                    ${explanation}
                </div>
                ${scriptHtml}
                ${gradingControl}
            </div>
        `;
    };

    const qHtml = assign.questions.map(renderQuestionReview).join('');
    const isPassed = sub.score >= 50;

    return `
        <div class="max-w-4xl mx-auto bg-white p-4 md:p-8 rounded-2xl shadow-lg fade-in">
            <div class="flex justify-between items-start mb-6 pb-4 border-b">
                <div>
                    <h3 class="text-xl md:text-2xl font-bold truncate text-slate-800">K·∫øt qu·∫£: ${assign.title}</h3>
                    <p class="text-slate-500 mt-1 font-medium text-base">B√†i l√†m c·ªßa: <span class="text-blue-600 font-bold text-lg">${studentName}</span></p>
                </div>
                <button onclick="viewSubmissionResult(null)" class="text-slate-400 hover:text-red-500 p-2 rounded-full hover:bg-slate-100 transition"><i data-lucide="x" size="28"></i></button>
            </div>

            <div class="flex flex-col md:flex-row gap-4 mb-6">
                <div class="flex-1 text-center p-6 rounded-2xl ${isPassed ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'} flex flex-col justify-center items-center shadow-inner">
                    <p class="text-sm font-bold uppercase tracking-wider opacity-70">T·ªïng ƒëi·ªÉm</p>
                    <div class="text-6xl font-black my-2">${sub.score}</div>
                    <p class="text-lg font-bold">${isPassed ? 'üéâ ƒê·∫°t y√™u c·∫ßu' : 'üò¢ C·∫ßn c·ªë g·∫Øng'}</p>
                </div>
                
                <div class="flex-1 bg-slate-50 p-6 rounded-2xl border border-slate-200">
                    <h4 class="font-bold text-slate-700 mb-4 flex items-center gap-2"><i data-lucide="info" size="18"></i> Th√¥ng tin chi ti·∫øt</h4>
                    <ul class="space-y-3 text-sm text-slate-600">
                        <li class="flex justify-between"><span>Ng√†y n·ªôp:</span> <span class="font-medium text-slate-800">${sub.createdAt ? new Date(sub.createdAt.seconds * 1000).toLocaleString('vi-VN') : 'N/A'}</span></li>
                        <li class="flex justify-between"><span>S·ªë c√¢u ƒë√∫ng:</span> <span class="font-bold text-green-600 text-lg">${correctCount} / ${assign.questions.length}</span></li>
                    </ul>
                </div>
            </div>

            ${feedbackHtml}
            ${bulkSaveBtn}

            <h4 class="text-xl font-bold text-slate-700 mb-4 flex items-center gap-2"><i data-lucide="list-checks" size="24" class="text-blue-500"></i> Chi ti·∫øt b√†i l√†m</h4>
            <div class="space-y-4">${qHtml}</div>
        </div>
    `;
};
        // RANKING (C·∫≠p nh·∫≠t Responsive)
        const renderRanking = () => {
            const sorted = [...state.data.users].sort((a,b) => (b.points||0) - (a.points||0));
            
            // Helper ƒë·ªÉ render huy hi·ªáu
            const renderMedal = (rank) => {
                if (rank === 1) return `<span class="text-2xl md:text-3xl">ü•á</span>`;
                if (rank === 2) return `<span class="text-2xl md:text-3xl">ü•à</span>`;
                if (rank === 3) return `<span class="text-2xl md:text-3xl">ü•â</span>`;
                return `<span class="font-bold text-sm md:text-base text-slate-500">#${rank}</span>`;
            };

            return `
                <div class="bg-white rounded-2xl shadow-md overflow-hidden max-w-4xl mx-auto fade-in">
                    <div class="bg-yellow-500 p-6 md:p-8 text-center text-white">
                        <i data-lucide="trophy" class="w-10 h-10 md:w-12 md:h-12 mx-auto drop-shadow-lg mb-2"></i>
                        <h3 class="text-2xl md:text-3xl font-bold">B·∫£ng X·∫øp H·∫°ng ƒêi·ªÉm</h3>
                    </div>
                    <div class="p-1 md:p-1">
                        <div class="overflow-x-auto">
                            <table class="w-full min-w-[200px]">
                                <thead>
                                    <tr class="text-left text-slate-500 text-sm border-b bg-slate-50">
                                        <th class="pb-3 pl-4 pt-3 w-16">H·∫°ng</th>
                                        <th class="pb-3 pt-3">H·ªçc sinh</th>
                                        <th class="pb-3 text-right pr-4 pt-3 w-20">ƒêi·ªÉm s·ªë</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${sorted.map((u, idx) => {
                                        let isMe = u.uid === state.user.uid;
                                        return `
                                        <tr class="border-b last:border-0 hover:bg-slate-100 transition ${isMe ? 'bg-blue-50 border-blue-200' : ''}">
                                            <td class="py-3 md:py-4 pl-4 font-bold">
                                                ${renderMedal(idx+1)}
                                            </td>
                                            <td class="py-3 md:py-4 flex items-center gap-3">
                                                <!--${renderAvatar(u, 'w-6 h-6', 'text-sm')} -->
                                                ${renderAvatar(u, 'w-6 h-6', 'text-sm')}
                                                <span class="font-medium ${isMe ? 'text-blue-700' : 'text-slate-700'} truncate">${u.name} ${isMe ? '(B·∫°n)' : ''}</span>
                                            </td>
                                            <td class="py-3 md:py-4 text-right pr-4 font-bold text-lg md:text-xl text-yellow-600">${u.points || 0}</td>
                                        </tr>`;
                                    }).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
        };
        // COMPETITION RENDERERS (C·∫≠p nh·∫≠t Responsive)

// --- GIAO DI·ªÜN LOBBY (ƒê√É N√ÇNG C·∫§P: DASHBOARD TH√ÄNH T√çCH H·ªåC SINH) ---
        const renderCompetitionLobby = () => {
            const uid = state.user.uid;
            
            // 1. T√çNH TO√ÅN TH√ÄNH T√çCH C√Å NH√ÇN
            const allMatches = state.data.matches || [];
            // L·ªçc ra c√°c tr·∫≠n ƒë√£ k·∫øt th√∫c m√† m√¨nh c√≥ tham gia
            const myFinishedMatches = allMatches.filter(m => 
                m.status === 'finished' && 
                (m.player1.uid === uid || (m.player2 && m.player2.uid === uid))
            ).sort((a,b) => b.createdAt - a.createdAt); // S·∫Øp x·∫øp m·ªõi nh·∫•t l√™n ƒë·∫ßu

            const totalPlayed = myFinishedMatches.length;
            const wins = myFinishedMatches.filter(m => {
                const isP1 = m.player1.uid === uid;
                const p1Score = m.player1.score;
                const p2Score = m.player2 ? m.player2.score : 0;
                return isP1 ? p1Score > p2Score : p2Score > p1Score;
            }).length;
            
            const winRate = totalPlayed > 0 ? Math.round((wins / totalPlayed) * 100) : 0;

            // 2. RENDER L·ªäCH S·ª¨ ƒê·∫§U (5 tr·∫≠n g·∫ßn nh·∫•t)
            const historyList = myFinishedMatches.slice(0, 5).map(m => {
                const isP1 = m.player1.uid === uid;
                const myScore = isP1 ? m.player1.score : (m.player2?.score || 0);
                const oppName = isP1 ? (m.player2?.name || 'Bot') : m.player1.name;
                const oppScore = isP1 ? (m.player2?.score || 0) : m.player1.score;
                
                let result = 'H√≤a';
                let resultColor = 'text-slate-600 bg-slate-100';
                if (myScore > oppScore) { result = 'Th·∫Øng'; resultColor = 'text-green-700 bg-green-100'; }
                else if (myScore < oppScore) { result = 'Thua'; resultColor = 'text-red-700 bg-red-100'; }

                return `
                    <div class="flex justify-between items-center p-3 border-b last:border-0 hover:bg-slate-50 transition">
                        <div class="flex items-center gap-3">
                            <span class="text-[10px] font-bold px-2 py-1 rounded uppercase tracking-wider ${resultColor}">${result}</span>
                            <div>
                                <p class="text-sm font-bold text-slate-700 flex items-center gap-1">
                                    <span class="text-slate-400 font-normal">vs</span> ${oppName}
                                </p>
                                <p class="text-[10px] text-slate-400">${m.createdAt ? new Date(m.createdAt.seconds * 1000).toLocaleDateString('vi-VN') : ''}</p>
                            </div>
                        </div>
                        <div class="text-right font-mono text-sm">
                            <span class="font-bold text-blue-600">${myScore}</span>
                            <span class="text-slate-300 mx-1">-</span>
                            <span class="font-bold text-red-600">${oppScore}</span>
                        </div>
                    </div>
                `;
            }).join('');

            // 3. LOGIC T√åM PH√íNG CH·ªú (GI·ªÆ NGUY√äN)
            const banks = state.data.questionBanks || [];
            const bankOptions = banks.map(b => 
                `<option value="${b.id}">${b.title} (${b.questions.length} c√¢u)</option>`
            ).join('');

            const availableMatches = allMatches.filter(m => 
                m.status === 'waiting' && 
                !m.player2 && 
                m.player1.uid !== uid
            );

            return `
                <div class="max-w-6xl mx-auto fade-in pb-10 space-y-6">
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="bg-white p-5 rounded-2xl shadow-sm border border-blue-100 flex items-center gap-4 transition hover:-translate-y-1">
                            <div class="p-3 bg-blue-50 text-blue-600 rounded-xl"><i data-lucide="swords" size="24"></i></div>
                            <div><p class="text-slate-500 text-xs uppercase font-bold">ƒê√£ ƒë·∫•u</p><p class="text-3xl font-black text-slate-800">${totalPlayed}</p></div>
                        </div>
                        <div class="bg-white p-5 rounded-2xl shadow-sm border border-green-100 flex items-center gap-4 transition hover:-translate-y-1">
                            <div class="p-3 bg-green-50 text-green-600 rounded-xl"><i data-lucide="trophy" size="24"></i></div>
                            <div><p class="text-slate-500 text-xs uppercase font-bold">Chi·∫øn th·∫Øng</p><p class="text-3xl font-black text-slate-800">${wins}</p></div>
                        </div>
                        <div class="bg-white p-5 rounded-2xl shadow-sm border border-yellow-100 flex items-center gap-4 transition hover:-translate-y-1">
                            <div class="p-3 bg-yellow-50 text-yellow-600 rounded-xl"><i data-lucide="percent" size="24"></i></div>
                            <div><p class="text-slate-500 text-xs uppercase font-bold">T·ªâ l·ªá th·∫Øng</p><p class="text-3xl font-black text-slate-800">${winRate}%</p></div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        
                        <div class="lg:col-span-2 space-y-6">
                            <div class="bg-gradient-to-r from-purple-600 to-indigo-600 rounded-3xl p-6 text-white shadow-lg text-center md:text-left flex flex-col md:flex-row items-center justify-between gap-4 relative overflow-hidden">
                                <div class="relative z-10">
                                    <h3 class="text-2xl font-bold mb-1 flex items-center gap-2"><i data-lucide="gamepad-2"></i> ƒê·∫•u tr∆∞·ªùng Tr·ª±c tuy·∫øn</h3>
                                    <p class="text-purple-100 text-sm">Th√°ch ƒë·∫•u 1vs1 - Nh·∫≠n ƒëi·ªÉm th∆∞·ªüng</p>
                                </div>
                                <div class="flex gap-3 relative z-10">
                                    <button onclick="createMatchFromBank()" class="bg-white text-purple-700 hover:bg-purple-50 px-5 py-3 rounded-xl font-bold shadow-md transition flex items-center gap-2 text-sm">
                                        <i data-lucide="plus-circle" size="18"></i> T·∫°o Ph√≤ng
                                    </button>
                                    <button onclick="setCompetitionMode('join')" class="bg-indigo-800 bg-opacity-50 hover:bg-opacity-70 text-white px-5 py-3 rounded-xl font-bold shadow-md transition flex items-center gap-2 text-sm backdrop-blur-sm">
                                        <i data-lucide="log-in" size="18"></i> Nh·∫≠p M√£
                                    </button>
                                </div>
                                <i data-lucide="swords" class="absolute -bottom-4 -right-4 w-32 h-32 text-white opacity-10 rotate-12"></i>
                            </div>
                            
                            <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-200">
                                <label class="text-xs font-bold text-slate-500 uppercase mb-2 block">B·ªô ƒë·ªÅ thi ƒë·∫•u (D√†nh cho T·∫°o ph√≤ng):</label>
                                <select id="arena-bank-select" class="w-full p-2 border rounded-lg text-sm bg-slate-50 font-medium text-slate-700 focus:border-purple-500 outline-none">
                                    <option value="" disabled selected>-- Ch·ªçn Ng√¢n h√†ng ƒë·ªÅ --</option>
                                    ${bankOptions}
                                </select>
                            </div>


<div>
                                <h3 class="font-bold text-slate-700 mb-3 flex items-center gap-2">
                                    <span class="relative flex h-3 w-3">
                                      <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span>
                                      <span class="relative inline-flex rounded-full h-3 w-3 bg-green-500"></span>
                                    </span>
                                    S·∫£nh ch·ªù th√°ch ƒë·∫•u (${availableMatches.length})
                                </h3>
                                <div id="lobby-match-list" class="grid grid-cols-1 sm:grid-cols-2 gap-3 transition-all">
                                    ${availableMatches.length === 0 
                                        ? `<div class="col-span-full p-8 text-center bg-white rounded-2xl border-2 border-dashed border-slate-200 text-slate-400 text-sm">Ch∆∞a c√≥ ai t·∫°o ph√≤ng. B·∫°n h√£y l√† ng∆∞·ªùi ƒë·∫ßu ti√™n!</div>` 
                                        : availableMatches.map(m => `
                                            <div class="bg-white p-4 rounded-xl shadow-sm border border-purple-100 hover:shadow-md hover:border-purple-300 transition group relative animate-in fade-in slide-in-from-bottom-2">
                                                <div class="flex items-center gap-3 mb-3">
                                                    ${renderAvatar(state.data.users.find(u => u.uid === m.player1.uid), 'w-10 h-10', 'text-sm')}
                                                    <div class="overflow-hidden">
                                                        <p class="font-bold text-slate-700 text-sm truncate">${m.player1.name}</p>
                                                        <p class="text-xs text-slate-500">M√£: <span class="font-mono font-bold text-purple-600">${m.roomCode}</span></p>
                                                    </div>
                                                </div>
                                                <button onclick="joinPublicMatch('${m.id}')" class="w-full bg-purple-50 text-purple-700 hover:bg-purple-600 hover:text-white py-2 rounded-lg font-bold text-sm transition flex items-center justify-center gap-2">
                                                    <i data-lucide="swords" size="14"></i> Chi·∫øn ngay
                                                </button>
                                            </div>
                                        `).join('')
                                    }
                                </div>
                            </div>

                        <div>
                            <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
                                <div class="p-4 bg-slate-50 border-b border-slate-200">
                                    <h3 class="font-bold text-slate-700 flex items-center gap-2 text-sm uppercase tracking-wider">
                                        <i data-lucide="history" size="16"></i> L·ªãch s·ª≠ ƒë·∫•u g·∫ßn ƒë√¢y
                                    </h3>
                                </div>
                                <div class="divide-y divide-slate-100 max-h-[500px] overflow-y-auto">
                                    ${historyList || `<div class="p-8 text-center text-slate-400 text-sm italic">B·∫°n ch∆∞a ƒë·∫•u tr·∫≠n n√†o.</div>`}
                                </div>
                            </div>
                        </div>

                    </div>
                </div>
            `;
        };

        const renderCompetitionJoin = () => `
            <div class="max-w-sm mx-auto bg-white p-6 md:p-8 rounded-2xl shadow-xl text-center fade-in">
                <h3 class="text-xl md:text-2xl font-bold text-slate-700 mb-6">Nh·∫≠p M√£ Ph√≤ng</h3>
                <input id="room-code-input" type="text" class="w-full p-4 border-2 border-slate-300 rounded-xl text-center text-xl font-bold tracking-widest uppercase mb-4 focus:border-blue-500" maxlength="6" placeholder="CODE">
                <button onclick="joinMatch()" class="w-full bg-blue-600 text-white py-3 rounded-xl font-bold mb-4 transition hover:bg-blue-700">Tham Gia</button>
                <button onclick="setCompetitionMode('lobby')" class="text-slate-500 text-sm hover:text-slate-700">Quay l·∫°i</button>
            </div>
        `;

        const renderCompetitionWaiting = (match) => {
            const isOwner = match.player1.uid === state.user.uid;
            const p1Profile = state.data.users.find(u => u.uid === match.player1.uid);
            const p2Profile = match.player2 ? state.data.users.find(u => u.uid === match.player2.uid) : null;
            
            return `
                <div class="max-w-xl mx-auto bg-white p-6 md:p-8 rounded-2xl shadow-xl text-center fade-in">
                    <h3 class="text-xl md:text-2xl font-bold text-slate-700 mb-2">Ph√≤ng ch·ªù: <span class="text-purple-600">${match.roomCode}</span></h3>
                    <p class="text-slate-500 text-sm mb-6">Chia s·∫ª m√£ n√†y cho ƒë·ªëi th·ªß.</p>
                    <div class="flex justify-center gap-8 mb-8">
                        <div class="text-center">
                            ${renderAvatar(p1Profile, 'w-16 h-16', 'text-xl')}
                            <p class="font-bold text-blue-700 mt-2 truncate">${match.player1.name}</p>
                        </div>
                        <div class="self-center font-bold text-slate-300 text-xl">VS</div>
                        <div class="text-center">
                            ${match.player2 ? renderAvatar(p2Profile, 'w-16 h-16', 'text-xl') : `
                                <div class="w-16 h-16 bg-slate-100 text-slate-400 rounded-full flex items-center justify-center mx-auto mb-2 font-bold text-xl">
                                    ?
                                </div>
                            `}
                            <p class="font-bold ${match.player2 ? 'text-red-700' : 'text-slate-400'} mt-2 truncate">${match.player2 ? match.player2.name : 'ƒêang ch·ªù...'}</p>
                        </div>
                    </div>
                    ${isOwner && match.player2 ? `<button onclick="startMatch('${match.id}')" class="bg-green-600 text-white py-3 px-8 rounded-xl font-bold text-lg shadow-md transition transform hover:-translate-y-0.5 animate-pulse">B·∫Øt ƒë·∫ßu ngay</button>` : ''}
                    ${!match.player2 ? `<button onclick="leaveMatch('${match.id}')" class="mt-4 text-red-500 text-sm hover:text-red-700">H·ªßy ph√≤ng</button>` : ''}
                </div>
            `;
        };

 // --- GIAO DI·ªÜN ƒê·∫§U TR∆Ø·ªúNG N√ÇNG C·∫§P (THANH M√ÅU ƒê·ªêI KH√ÅNG) ---
        const renderCompetitionPlaying = (match) => {
            const p1 = match.player1;
            const p2 = match.player2;
            const currentQ = match.qIndex + 1;
            const totalQ = match.questions.length;
            
            // T√≠nh to√°n % thanh ti·∫øn ƒë·ªô (Max ƒëi·ªÉm gi·∫£ ƒë·ªãnh l√† 100 ho·∫∑c s·ªë c√¢u * 10)
            const maxScore = totalQ * 10;
            const p1Percent = Math.min((p1.score / maxScore) * 100, 100);
            const p2Percent = Math.min((p2.score / maxScore) * 100, 100);

            return `
                <div id="match-playing-container" class="max-w-4xl mx-auto fade-in select-none">
                    <div class="bg-white p-4 rounded-3xl shadow-lg mb-6 border-b-4 border-slate-200">
                        <div class="flex justify-between items-end mb-2 px-2">
                            <div class="flex flex-col items-start">
                                <span class="text-xs font-bold text-slate-400 uppercase">Player 1</span>
                                <span class="font-bold text-blue-600 truncate max-w-[120px]">${p1.name}</span>
                            </div>
                            <div class="text-3xl font-black text-slate-200 italic">VS</div>
                            <div class="flex flex-col items-end">
                                <span class="text-xs font-bold text-slate-400 uppercase">Player 2</span>
                                <span class="font-bold text-red-600 truncate max-w-[120px]">${p2.name}</span>
                            </div>
                        </div>
                        
                        <div class="relative h-6 bg-slate-100 rounded-full overflow-hidden flex">
                            <div class="h-full bg-gradient-to-r from-blue-400 to-blue-600 transition-all duration-500 ease-out flex items-center justify-end px-2" style="width: ${p1Percent}%">
                                ${p1.score > 0 ? `<span class="text-[10px] text-white font-bold">${p1.score}</span>` : ''}
                            </div>
                            <div class="absolute top-0 right-0 h-full bg-gradient-to-l from-red-400 to-red-600 transition-all duration-500 ease-out flex items-center justify-start px-2" style="width: ${p2Percent}%">
                                ${p2.score > 0 ? `<span class="text-[10px] text-white font-bold">${p2.score}</span>` : ''}
                            </div>
                            
                            <div class="absolute top-0 left-1/2 w-0.5 h-full bg-white z-10 transform -translate-x-1/2"></div>
                        </div>
                    </div>

                    <div class="bg-white p-6 md:p-8 rounded-3xl shadow-2xl text-center border-b-8 border-slate-200 relative overflow-hidden">
                        <div class="absolute top-4 left-4">
                            <span id="q-counter" class="bg-slate-800 text-white px-3 py-1 rounded-lg text-xs font-bold shadow-md">
                                Q${currentQ}/${totalQ}
                            </span>
                        </div>
                        
                        <div id="audio-container" class="mt-2 mb-4 h-12 flex justify-center items-center"></div>
                        
                        <h2 id="q-text" class="text-xl md:text-3xl font-bold text-slate-700 mb-8 leading-relaxed min-h-[4rem] flex items-center justify-center">
                            ƒêang t·∫£i c√¢u h·ªèi...
                        </h2>

                        <div id="options-grid" class="grid grid-cols-1 md:grid-cols-2 gap-4" data-qid="-1">
                            </div>
                    </div>
                </div>
            `;
        };

  // --- C·∫¨P NH·∫¨T UI KHI ƒêANG CH∆†I (PHI√äN B·∫¢N FINAL: PH√ÇN BI·ªÜT NG∆Ø·ªúI CH∆†I & GI√ÅO VI√äN) ---
window.updatePlayingUI = () => {
    const match = state.ui.activeMatch;
    const container = document.getElementById('match-playing-container');
    if (!match || !container) return;

    const qIndex = match.qIndex || 0;
    const q = match.questions[qIndex];
    
    // Ki·ªÉm tra xem ng∆∞·ªùi d√πng hi·ªán t·∫°i l√† Kh√°n gi·∫£ (Gi√°o vi√™n) hay Ng∆∞·ªùi ch∆°i
    const isSpectating = state.ui.competitionMode === 'spectating';

    // 1. C·∫≠p nh·∫≠t Thanh M√°u (Progress Bar)
    const maxScore = match.questions.length * 10;
    const p1Percent = Math.min((match.player1.score / maxScore) * 100, 100);
    const p2Percent = Math.min((match.player2.score / maxScore) * 100, 100);

    const p1Bar = container.querySelector('.bg-gradient-to-r'); 
    const p2Bar = container.querySelector('.bg-gradient-to-l'); 

    if(p1Bar) {
        p1Bar.style.width = `${p1Percent}%`;
        // LOGIC M·ªöI: Ch·ªâ hi·ªán ƒëi·ªÉm trong thanh n·∫øu l√† NG∆Ø·ªúI CH∆†I.
        // N·∫øu l√† kh√°n gi·∫£ (gi√°o vi√™n), ƒë·ªÉ r·ªóng v√¨ ƒë√£ c√≥ hi·ªÉn th·ªã ·ªü t√™n r·ªìi.
        p1Bar.innerHTML = (!isSpectating && match.player1.score > 0) 
            ? `<span class="text-[10px] text-white font-bold animate-in fade-in zoom-in">${match.player1.score}</span>` 
            : '';
    }
    
    if(p2Bar) {
        p2Bar.style.width = `${p2Percent}%`;
        // T∆∞∆°ng t·ª± cho Player 2
        p2Bar.innerHTML = (!isSpectating && match.player2.score > 0)
            ? `<span class="text-[10px] text-white font-bold animate-in fade-in zoom-in">${match.player2.score}</span>` 
            : '';
    }

    // --- C·∫≠p nh·∫≠t TEXT ƒëi·ªÉm s·ªë (D√†nh cho Gi√°o vi√™n/Kh√°n gi·∫£ xem) ---
    // Ph·∫ßn n√†y s·∫Ω hi·ªÉn th·ªã ƒëi·ªÉm s·ªë to r√µ b√™n c·∫°nh t√™n ng∆∞·ªùi ch∆°i
    const specP1 = document.getElementById('spec-p1-score');
    const specP2 = document.getElementById('spec-p2-score');
    if (specP1) specP1.textContent = match.player1.score;
    if (specP2) specP2.textContent = match.player2.score;
    
    // C·∫≠p nh·∫≠t b·ªô ƒë·∫øm c√¢u h·ªèi
    const counterEl = document.getElementById('q-counter');
    if (counterEl) {
        const prefix = isSpectating ? 'C√¢u h·ªèi ' : 'Q';
        counterEl.textContent = `${prefix}${qIndex + 1}/${match.questions.length}`;
    }

    // 2. Render n·ªôi dung c√¢u h·ªèi (Gi·ªØ nguy√™n logic c≈©)
    const grid = document.getElementById('options-grid');
    if (!grid) return; 

    const currentRenderedQId = grid.getAttribute('data-qid');
    if (currentRenderedQId !== String(qIndex)) {
        state.ui.hasAnsweredCurrentQ = false;
        state.ui.matchQIndex = qIndex;
        grid.setAttribute('data-qid', qIndex);

        const qTextEl = document.getElementById('q-text');
        if (qTextEl) {
            qTextEl.innerHTML = typeof formatText === 'function' ? formatText(q.text) : q.text;
            qTextEl.classList.remove('fade-in');
            void qTextEl.offsetWidth; 
            qTextEl.classList.add('fade-in');
        }

        // Render Audio (Gi·ªØ nguy√™n)
        const audioContainer = document.getElementById('audio-container');
        if (audioContainer) {
            const audioUrl = q.audioUrl;
            const audioText = q.audioWord || q.audioSentence || q.audioText;
            
            if (audioUrl) {
                const audioId = `arena-audio-${qIndex}`;
                audioContainer.innerHTML = `
                    <audio id="${audioId}" src="${audioUrl}" style="display:none"></audio>
                    <button id="btn-play-audio" onclick="playCustomAudio('${audioId}', this)" class="flex items-center gap-2 bg-purple-100 text-purple-700 px-5 py-2 rounded-full font-bold hover:bg-purple-200 transition shadow-sm animate-bounce-in ring-2 ring-purple-200">
                        <i data-lucide="volume-2" size="20"></i> Nghe Audio G·ªëc
                    </button>`;
                setTimeout(() => { 
                    const btn = document.getElementById('btn-play-audio'); 
                    if(btn && typeof playCustomAudio === 'function') playCustomAudio(audioId, btn); 
                }, 500);
            } else if (audioText) {
                audioContainer.innerHTML = `
                    <button onclick="speakWord('${audioText.replace(/'/g, "\\'")}', 'zh-CN')" class="flex items-center gap-2 bg-yellow-100 text-yellow-700 px-4 py-2 rounded-full font-bold hover:bg-yellow-200 transition shadow-sm animate-bounce-in">
                        <i data-lucide="volume-2" size="20"></i> Nghe c√¢u h·ªèi (M√°y ƒë·ªçc)
                    </button>`;
                setTimeout(() => { if(typeof speakWord === 'function') speakWord(audioText, 'zh-CN') }, 500);
            } else {
                audioContainer.innerHTML = '';
            }
        }

        // Render Options (Gi·ªØ nguy√™n)
        if (isSpectating) {
            grid.innerHTML = q.options.map((opt) => `
                <div class="p-4 border-2 border-slate-100 rounded-xl text-lg font-medium text-slate-600 bg-slate-50">
                    ${opt}
                </div>
            `).join('');
        } else {
            grid.innerHTML = q.options.map((opt, idx) => `
                <button id="opt-btn-${idx}" onclick="handleAnswerAttempt(${idx === q.correct}, '${match.id}', ${idx})" 
                    class="group relative p-4 md:p-6 bg-white border-2 border-slate-200 rounded-2xl text-lg md:text-xl font-bold text-slate-700 transition-all hover:border-blue-400 hover:shadow-md active:scale-95 flex items-center justify-center text-center">
                    <span class="absolute left-4 top-1/2 -translate-y-1/2 w-8 h-8 rounded-full bg-slate-100 text-slate-500 text-xs flex items-center justify-center font-black group-hover:bg-blue-100 group-hover:text-blue-600 transition">
                        ${String.fromCharCode(65 + idx)}
                    </span>
                    ${opt}
                </button>
            `).join('');
        }
        if(typeof renderIcons === 'function') renderIcons();
    }
};
// --- [M·ªöI] H√ÄM C·∫¨P NH·∫¨T UI KH√ÅN GI·∫¢ (FIX NH√ÅY) ---
        window.updateSpectatorUI = () => {
            const match = state.ui.activeMatch;
            const container = document.getElementById('match-playing-container');
            if (!match || !container) return;

            const p1 = match.player1;
            const p2 = match.player2 || { name: 'ƒêang ch·ªù...', score: 0 };
            const totalQ = match.questions ? match.questions.length : 10;
            const currentQ = (match.qIndex || 0) + 1;

            const maxScore = totalQ * 10;
            const p1Percent = Math.min((p1.score / maxScore) * 100, 100);
            const p2Percent = Math.min((p2.score / maxScore) * 100, 100);

            // 1. C·∫≠p nh·∫≠t ƒêi·ªÉm s·ªë
            const p1ScoreEl = document.getElementById('spec-p1-score');
            if(p1ScoreEl && p1ScoreEl.textContent != p1.score) {
                p1ScoreEl.textContent = p1.score;
                p1ScoreEl.classList.add('scale-125', 'text-green-600'); // Hi·ªáu ·ª©ng n·∫£y ƒëi·ªÉm
                setTimeout(() => p1ScoreEl.classList.remove('scale-125', 'text-green-600'), 300);
            }
            
            const p2ScoreEl = document.getElementById('spec-p2-score');
            if(p2ScoreEl && p2ScoreEl.textContent != p2.score) {
                p2ScoreEl.textContent = p2.score;
                p2ScoreEl.classList.add('scale-125', 'text-green-600');
                setTimeout(() => p2ScoreEl.classList.remove('scale-125', 'text-green-600'), 300);
            }

            // 2. C·∫≠p nh·∫≠t Thanh m√°u
            const p1Bar = container.querySelector('.bg-gradient-to-r');
            if(p1Bar) p1Bar.style.width = `${p1Percent}%`;
            
            const p2Bar = container.querySelector('.bg-gradient-to-l');
            if(p2Bar) p2Bar.style.width = `${p2Percent}%`;

            // 3. C·∫≠p nh·∫≠t C√¢u h·ªèi (Ch·ªâ khi ƒë·ªïi c√¢u h·ªèi)
            const qCounter = document.getElementById('q-counter');
            if(qCounter) qCounter.textContent = `C√¢u h·ªèi ${currentQ} / ${totalQ}`;

            const qText = document.getElementById('q-text');
            // C·∫≠p nh·∫≠t text c√¢u h·ªèi n·∫øu c√≥ thay ƒë·ªïi
            const newQText = match.status === 'waiting' ? 'ƒêang ch·ªù ng∆∞·ªùi ch∆°i th·ª© 2...' : (match.questions[match.qIndex]?.text || 'ƒêang t·∫£i...');
            if(qText && qText.textContent !== newQText) {
                 qText.innerHTML = formatText(newQText);
            }

            // 4. C·∫≠p nh·∫≠t ƒê√°p √°n (Grid)
            const optionsGrid = document.getElementById('options-grid');
            if(optionsGrid) {
                const prevQIndex = optionsGrid.dataset.qid;
                // Ch·ªâ render l·∫°i list ƒë√°p √°n khi chuy·ªÉn c√¢u h·ªèi m·ªõi
                if (prevQIndex != match.qIndex || (match.status === 'playing' && optionsGrid.children.length === 0)) {
                     optionsGrid.dataset.qid = match.qIndex;
                     if (match.status === 'playing' && match.questions[match.qIndex]) {
                         optionsGrid.innerHTML = match.questions[match.qIndex].options.map((opt, i) => `
                            <div class="p-4 border-2 border-slate-100 rounded-xl text-lg font-medium text-slate-600 bg-slate-50 animate-in fade-in zoom-in">
                                ${opt}
                            </div>
                         `).join('');
                     } else {
                         optionsGrid.innerHTML = '';
                     }
                }
            }
        };

        window.handleArenaInputAnswer = async (mid) => {
             const match = state.ui.activeMatch;
             if (!match || match.status !== 'playing' || state.ui.hasAnsweredCurrentQ) return;
             
             const qIndex = match.qIndex || 0;
             const q = match.questions[qIndex];
             const userAnswer = (document.getElementById(`arena-input-q-${qIndex}`).value || '').trim().toLowerCase();
             const correctAnswer = (q.correct || '').trim().toLowerCase();

             const isCorrect = userAnswer === correctAnswer;
             
             state.ui.hasAnsweredCurrentQ = true;
             
             const inputEl = document.getElementById(`arena-input-q-${qIndex}`);
             inputEl.disabled = true;
             
             if (isCorrect) {
                  inputEl.classList.add('bg-green-100', 'border-green-600');
                  showToast("Ch√≠nh x√°c!", "success");
             } else {
                 inputEl.classList.add('bg-red-100', 'border-red-600');
                 showToast(`Sai! ƒê√°p √°n ƒë√∫ng l√†: ${q.correct}`, "error");
             }
             
             if (isCorrect) {
                 try {
                     await runTransaction(db, async (transaction) => {
                         const matchRef = doc(db, getPath('matches'), mid);
                         const matchDoc = await transaction.get(matchRef);

                         if (!matchDoc.exists) { throw "Match does not exist!"; }

                         const matchData = matchDoc.data();
                         const currentQIndex = matchData.qIndex || 0;
                         const questionsLength = matchData.questions.length;

                         if (currentQIndex === state.ui.matchQIndex) {
                             const isP1 = match.player1.uid === state.user.uid;
                             const newScore = (isP1 ? matchData.player1.score : matchData.player2.score) + 10;
                             const nextQIndex = currentQIndex + 1;
                             
                             const updateData = {};
                             updateData[isP1 ? "player1.score" : "player2.score"] = newScore;
                             
                             if (nextQIndex < questionsLength) {
                                 updateData.qIndex = nextQIndex;
                             } else {
                                 updateData.status = 'finished';
                             }
                             
                             transaction.update(matchRef, updateData);
                             
                             if (updateData.status === 'finished') {
                                 transaction.update(matchRef, {...updateData, winnerScore: newScore, finishedBy: state.user.uid});
                             }

                             state.ui.matchQIndex = nextQIndex;
                             updatePlayingUI();
                         }
                     });
                 } catch (e) {
                     console.error("Transaction failed:", e);
                 }
             } else {
                 setTimeout(() => {
                    if (state.ui.activeMatch) {
                        state.ui.matchQIndex = state.ui.activeMatch.qIndex || 0;
                    }
                    state.ui.hasAnsweredCurrentQ = false;
                    updatePlayingUI();
                 }, 1500); 
             }
        }
        
        window.captureArenaInputAnswer = (value) => {};
        
 // --- X·ª¨ L√ù TR·∫¢ L·ªúI (D√ôNG TRANSACTION ƒê·ªÇ ƒê·ªíNG B·ªò) ---
        window.handleAnswerAttempt = async (isCorrect, mid, optionIndex) => {
             const match = state.ui.activeMatch;
             // Ch·∫∑n n·∫øu tr·∫≠n ƒë·∫•u kh√¥ng di·ªÖn ra ho·∫∑c ng∆∞·ªùi ch∆°i ƒë√£ tr·∫£ l·ªùi c√¢u n√†y r·ªìi
             if (!match || match.status !== 'playing' || state.ui.hasAnsweredCurrentQ) return;
             
             // Hi·ªáu ·ª©ng Click ngay l·∫≠p t·ª©c (Optimistic UI)
             const btn = document.getElementById(`opt-btn-${optionIndex}`);
             if (btn) {
                 btn.classList.add('scale-95'); // Nh·∫•n xu·ªëng
                 if (!isCorrect) {
                     // N·∫øu sai: Hi·ªán m√†u ƒë·ªè ngay v√† kh√≥a t·∫°m th·ªùi
                     btn.classList.remove('bg-white', 'hover:bg-blue-50');
                     btn.classList.add('bg-red-500', 'text-white', 'border-red-600');
                     showToast("Sai r·ªìi! B·ªã ph·∫°t ch·ªù 2 gi√¢y.", "error");
                     
                     // Logic ph·∫°t: Kh√≥a ng∆∞·ªùi ch∆°i trong 2s
                     state.ui.hasAnsweredCurrentQ = true; 
                     setTimeout(() => {
                         state.ui.hasAnsweredCurrentQ = false; // M·ªü kh√≥a
                         if(btn) {
                             btn.classList.remove('bg-red-500', 'text-white', 'border-red-600');
                             btn.classList.add('bg-slate-200', 'text-slate-400', 'cursor-not-allowed'); // Disable n√∫t sai
                             btn.disabled = true;
                         }
                     }, 2000);
                     return; // D·ª´ng l·∫°i, kh√¥ng g·ª≠i l√™n server
                 }
             }

             // N·∫øu ƒê√öNG: G·ª≠i transaction l√™n Server
             state.ui.hasAnsweredCurrentQ = true; // Kh√≥a t·∫°m th·ªùi ƒë·ªÉ tr√°nh spam
             if (btn) btn.classList.add('bg-green-500', 'text-white', 'border-green-600'); // Hi·ªán xanh l√°

             try {
                 await runTransaction(db, async (transaction) => {
                     const matchRef = doc(db, getPath('matches'), mid);
                     const matchDoc = await transaction.get(matchRef);

                     if (!matchDoc.exists) { throw "Tr·∫≠n ƒë·∫•u kh√¥ng t·ªìn t·∫°i!"; }

                     const matchData = matchDoc.data();
                     
                     // Ki·ªÉm tra xem c√¢u h·ªèi n√†y ƒë√£ b·ªã ai tr·∫£ l·ªùi xong ch∆∞a (ƒë·ªÅ ph√≤ng race condition)
                     // ·ªû ƒë√¢y logic l√†: Ai tr·∫£ l·ªùi ƒë√∫ng th√¨ next c√¢u h·ªèi cho C·∫¢ HAI.
                     // N√™n ta so s√°nh qIndex c·ª•c b·ªô v·ªõi server.
                     if (matchData.qIndex !== state.ui.matchQIndex) {
                         throw "C√¢u h·ªèi n√†y ƒë√£ k·∫øt th√∫c!";
                     }

                     const isP1 = matchData.player1.uid === state.user.uid;
                     
                     // C·ªông ƒëi·ªÉm
                     const newScore = (isP1 ? matchData.player1.score : matchData.player2.score) + 10;
                     const nextQIndex = matchData.qIndex + 1;
                     const questionsLength = matchData.questions.length;

                     const updateData = {};
                     // C·∫≠p nh·∫≠t ƒëi·ªÉm ng∆∞·ªùi th·∫Øng c√¢u n√†y
                     updateData[isP1 ? "player1.score" : "player2.score"] = newScore;
                     
                     // QUAN TR·ªåNG: TƒÉng qIndex ƒë·ªÉ chuy·ªÉn c√¢u h·ªèi cho C·∫¢ HAI NG∆Ø·ªúI
                     if (nextQIndex < questionsLength) {
                         updateData.qIndex = nextQIndex;
                     } else {
                         updateData.status = 'finished';
                         updateData.winnerScore = newScore;
                         updateData.finishedBy = state.user.uid;
                     }
                     
                     transaction.update(matchRef, updateData);
                 });
                 
                 // Hi·ªáu ·ª©ng √¢m thanh ho·∫∑c toast chi·∫øn th·∫Øng c√¢u h·ªèi
                 // showToast("Ch√≠nh x√°c! +10 ƒëi·ªÉm", "success");

             } catch (e) {
                 console.log("Transaction skipped/failed:", e);
                 // N·∫øu l·ªói (do ng∆∞·ªùi kia tr·∫£ l·ªùi nhanh h∆°n), UI s·∫Ω t·ª± update qua onSnapshot
             }
         };

const renderCompetition = () => {
            const mode = state.ui.competitionMode;
            const match = state.ui.activeMatch;
            
            // --- [M·ªöI] CH·∫æ ƒê·ªò KH√ÅN GI·∫¢ (SPECTATOR) ---
            if (mode === 'spectating') {
                // T·ª± ƒë·ªông c·∫≠p nh·∫≠t UI kh√°n gi·∫£ (d√πng chung logic updatePlayingUI nh∆∞ng ko cho b·∫•m)
                setTimeout(updatePlayingUI, 50); 
                return renderSpectatorView(match);
            }

            // --- [M·ªöI] N·∫æU L√Ä GI√ÅO VI√äN V√Ä ƒêANG ·ªû LOBBY -> HI·ªÜN DASHBOARD QU·∫¢N L√ù ---
            if (state.profile.role === 'teacher' && mode === 'lobby') {
                return renderTeacherArenaDashboard();
            }

            // C√°c ch·∫ø ƒë·ªô b√¨nh th∆∞·ªùng cho H·ªçc sinh
            switch(mode) {
                case 'create': return renderCompetitionCreate(); 
                case 'join': return renderCompetitionJoin();
                case 'waiting': return renderCompetitionWaiting(match);
                case 'playing': 
                    setTimeout(updatePlayingUI, 50);
                    return renderCompetitionPlaying(match);
                case 'lobby': default: return renderCompetitionLobby();
            }
        };
        
// --- RENDER MODAL AVATAR (ƒê√É C·∫¨P NH·∫¨T: CH·ªà HI·ªÜN AVATAR ƒê√É M·ªû KH√ìA) ---
        const renderAvatarModal = () => {
            const previewUrl = state.ui.tempAvatarUrl || (state.profile.avatarType === 'url' ? state.profile.avatarUrl : null);
            
            // L·∫•y danh s√°ch avatar c·ªßa ng∆∞·ªùi d√πng (n·∫øu ch∆∞a c√≥ th√¨ d√πng m·∫∑c ƒë·ªãnh)
            const myAvatars = state.profile.unlockedAvatars || GAME_CONFIG.INITIAL_AVATARS;
            const totalAvatars = GAME_CONFIG.ALL_AVATARS.length;

            // T·∫°o profile t·∫°m ƒë·ªÉ preview
            const currentAvatar = { 
                name: state.profile.name,
                role: state.profile.role,
                avatarUrl: state.ui.tempAvatarType === 'emoji' ? state.ui.tempAvatarUrl : 
                           (state.profile.avatarType === 'emoji' ? state.profile.avatarUrl : state.profile.name.charAt(0)),
                avatarType: state.ui.tempAvatarType || state.profile.avatarType || 'text'
            };

            const emojiGrid = myAvatars.map(emoji => `
                <button onclick="selectEmojiAvatar('${emoji}')" 
                        class="p-3 text-2xl rounded-full hover:bg-slate-200 transition 
                        ${currentAvatar.avatarType === 'emoji' && currentAvatar.avatarUrl === emoji ? 'bg-blue-200 ring-2 ring-blue-500' : 'bg-slate-100'}">
                    ${emoji}
                </button>
            `).join('');

            return `
                <div class="fixed inset-0 bg-slate-900 bg-opacity-70 flex items-center justify-center z-50 fade-in p-4" onclick="if (event.target === this) toggleAvatarModal(false)">
                    <div class="bg-white p-6 md:p-8 rounded-2xl shadow-2xl w-full max-w-lg transform transition-all">
                        <div class="flex justify-between items-center mb-6 border-b pb-4">
                            <h3 class="text-xl md:text-2xl font-bold text-blue-700">B·ªô s∆∞u t·∫≠p Avatar</h3>
                            <button onclick="toggleAvatarModal(false)" class="text-slate-500 hover:text-red-500"><i data-lucide="x"></i></button>
                        </div>
                        
                        <div class="flex flex-col items-center mb-6">
                            <div class="mb-4">
                                ${renderAvatar(currentAvatar, 'w-24 h-24', 'text-4xl')}
                            </div>
                            <div class="w-full mb-4">
                                <label for="avatar-upload" class="block text-sm font-medium text-slate-700 mb-2">T·∫£i ·∫£nh ri√™ng (URL hi·ªán tr√™n):</label>
                                <input type="file" id="avatar-upload" accept="image/*" onchange="handleImageUpload(event)" 
                                       class="w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
                                <p class="text-xs text-red-500 mt-2" id="upload-status"></p>
                            </div>
                        </div>

                        <div class="mb-6">
                            <div class="flex justify-between items-center mb-3">
                                <h4 class="font-bold text-slate-700">Avatar ƒë√£ s·ªü h·ªØu:</h4>
                                <span class="text-xs font-bold bg-yellow-100 text-yellow-700 px-2 py-1 rounded-full">
                                    ${myAvatars.length} / ${totalAvatars}
                                </span>
                            </div>
                            <div class="grid grid-cols-6 gap-2 max-h-40 overflow-y-auto p-2 border rounded-xl bg-slate-50">
                                ${emojiGrid}
                            </div>
                            <p class="text-xs text-slate-500 mt-2 italic text-center">
                                <i data-lucide="info" size="12" class="inline"></i> ƒê·∫°t >90 ƒëi·ªÉm ho·∫∑c Quay s·ªë ƒë·ªÉ m·ªü kh√≥a th√™m!
                            </p>
                        </div>

                        <button onclick="handleSaveAvatar()" class="w-full bg-green-600 text-white py-3 rounded-xl font-bold hover:bg-green-700 flex items-center justify-center gap-2 transition">
                            <i data-lucide="save" size="20"></i> L∆∞u Avatar
                        </button>
                    </div>
                </div>
            `;
        };
// --- GIAO DI·ªÜN K·∫æT QU·∫¢ TR·∫¨N ƒê·∫§U (VICTORY SCREEN) ---
        const renderMatchResultModal = () => {
            const res = state.ui.matchResult;
            if (!res) return '';

            let title, colorClass, iconHtml, subText;
            
            // X·ª≠ l√Ω n·ªôi dung d·ª±a tr√™n k·∫øt qu·∫£
            if (res.result === 'win') {
                title = "CHI·∫æN TH·∫ÆNG!";
                colorClass = "text-yellow-500";
                iconHtml = `
                    <div class="relative inline-block">
                        <div class="absolute inset-0 bg-yellow-200 blur-xl rounded-full opacity-50 animate-pulse"></div>
                        <span class="text-8xl relative z-10 drop-shadow-lg filter animate-bounce">üèÜ</span>
                    </div>`;
                
                // [FIX] Hi·ªÉn th·ªã ph·∫ßn th∆∞·ªüng r√µ r√†ng
                subText = `
                    <div class="text-slate-500 font-medium mb-3">Xu·∫•t s·∫Øc! B·∫°n l√† ng∆∞·ªùi chi·∫øn th·∫Øng.</div>
                    <div class="flex flex-col gap-2 items-center justify-center">
                        <div class="inline-flex items-center gap-1 bg-green-100 text-green-700 px-4 py-1.5 rounded-full font-bold text-lg shadow-sm border border-green-200">
                            +${res.bonus} ƒëi·ªÉm th∆∞·ªüng
                        </div>
                        ${res.earnedTicket ? `
                        <div class="inline-flex items-center gap-2 bg-gradient-to-r from-purple-500 to-indigo-600 text-white px-5 py-2 rounded-full font-bold text-xl shadow-lg animate-pulse ring-4 ring-purple-100">
                            <span>üéüÔ∏è</span> <span>+1 V√© Quay</span>
                        </div>` : ''}
                    </div>
                `;
            } else if (res.result === 'lose') {
                title = "TH·∫§T B·∫†I";
                colorClass = "text-slate-500";
                iconHtml = `<span class="text-8xl grayscale opacity-80">ü•Ä</span>`;
                subText = `<div class="text-slate-500 font-medium">ƒê·ª´ng bu·ªìn, h√£y c·ªë g·∫Øng l·∫ßn sau nh√©!</div>`;
            } else {
                title = "H√íA NHAU";
                colorClass = "text-blue-500";
                iconHtml = `<span class="text-8xl">ü§ù</span>`;
                subText = `<div class="text-slate-500 font-medium">M·ªôt tr·∫≠n ƒë·∫•u ngang t√†i ngang s·ª©c!</div>`;
            }

            return `
                <div id="match-result-modal" class="fixed inset-0 bg-slate-900 bg-opacity-90 flex items-center justify-center z-[60] p-4 fade-in">
                    <div class="bg-white rounded-3xl shadow-2xl w-full max-w-md p-8 text-center relative overflow-hidden transform transition-all scale-100 animate-bounce-in">
                        
                        <div class="absolute top-0 left-0 w-full h-3 bg-gradient-to-r from-blue-500 via-purple-500 to-pink-500"></div>
                        
                        <div class="mb-4 mt-6">
                            ${iconHtml}
                        </div>
                        
                        <h2 class="text-4xl font-black ${colorClass} mb-4 uppercase tracking-wide">${title}</h2>
                        <div class="mb-8">${subText}</div>

                        <div class="bg-slate-50 rounded-2xl p-4 border border-slate-200 mb-8 flex justify-center items-center gap-6">
                            <div class="text-center">
                                ${renderAvatar({name: res.myName, avatarUrl: res.myAvatar, avatarType: res.myAvatarType}, 'w-14 h-14', 'text-2xl')}
                                <p class="text-xs font-bold text-slate-400 mt-2">B·∫†N</p>
                                <p class="text-2xl font-black text-slate-800">${res.myScore}</p>
                            </div>
                            <div class="text-3xl font-black text-slate-300">VS</div>
                            <div class="text-center">
                                ${renderAvatar({name: res.oppName, avatarUrl: res.oppAvatar, avatarType: res.oppAvatarType}, 'w-14 h-14', 'text-2xl')}
                                <p class="text-xs font-bold text-slate-400 mt-2">ƒê·ªêI TH·ª¶</p>
                                <p class="text-2xl font-black text-slate-800">${res.oppScore}</p>
                            </div>
                        </div>

                        <button onclick="closeMatchResult()" class="w-full bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-700 hover:to-indigo-700 text-white py-4 rounded-xl font-bold text-lg shadow-lg transition transform hover:-translate-y-1">
                            Quay v·ªÅ S·∫£nh
                        </button>
                    </div>
                </div>
            `;
        };
        
        // H√†m ƒë√≥ng modal
        window.closeMatchResult = () => {
            state.ui.matchResult = null;
            state.ui.competitionMode = 'lobby';
            state.ui.hasAnsweredCurrentQ = false;
            renderApp();
        };

        // --- 7. HANDLERS (Assignments, Question Bank, Competition & CLASSES) ---
        
        // --- Avatar Handlers (Gi·ªØ nguy√™n) ---
        window.toggleAvatarModal = (val) => {
            state.ui.isAvatarModalOpen = val;
            if (val) {
                // Khi m·ªü modal, set tr·∫°ng th√°i t·∫°m th·ªùi t·ª´ profile hi·ªán t·∫°i
                state.ui.tempAvatarUrl = state.profile.avatarUrl;
                state.ui.tempAvatarType = state.profile.avatarType;
            } else {
                // Khi ƒë√≥ng modal, reset tr·∫°ng th√°i t·∫°m th·ªùi v√† input file
                state.ui.tempAvatarUrl = null;
                state.ui.tempAvatarType = null;
                
                const fileInput = document.getElementById('avatar-upload');
                if (fileInput) {
                    fileInput.value = '';
                }
                const statusEl = document.getElementById('upload-status');
                if(statusEl) statusEl.textContent = '';
            }
            // G·ªçi renderApp() ƒë·ªÉ render l·∫°i c·∫£ app v√† modal
            renderApp();
        };
        
        window.selectEmojiAvatar = (emoji) => {
            state.ui.tempAvatarUrl = emoji;
            state.ui.tempAvatarType = 'emoji';
            
            // TH√äM: Reset input file khi ch·ªçn emoji
            const fileInput = document.getElementById('avatar-upload');
            if (fileInput) {
                fileInput.value = '';
                document.getElementById('upload-status').textContent = '';
            }
            
            renderApp();
        };

        window.handleImageUpload = async (event) => {
            const file = event.target.files[0];
            if (!file) return;

            const statusEl = document.getElementById('upload-status');
            statusEl.textContent = 'ƒêang t·∫£i l√™n...';
            statusEl.classList.remove('text-green-600', 'text-red-500');
            statusEl.classList.add('text-blue-600');
            
            // TH√äM: X√≥a tr·∫°ng th√°i emoji t·∫°m th·ªùi khi b·∫Øt ƒë·∫ßu t·∫£i ·∫£nh
            state.ui.tempAvatarType = 'url';

            try {
                // T·∫°o tham chi·∫øu file trong Firebase Storage
                const avatarRef = storageRef(storage, `avatars/${state.user.uid}/${file.name}`);
                
                // T·∫£i file l√™n
                const snapshot = await uploadBytes(avatarRef, file);
                
                // L·∫•y URL c√¥ng khai
                const downloadURL = await getDownloadURL(snapshot.ref);
                
                state.ui.tempAvatarUrl = downloadURL;
                state.ui.tempAvatarType = 'url';
                
                statusEl.textContent = 'T·∫£i l√™n th√†nh c√¥ng!';
                statusEl.classList.remove('text-blue-600', 'text-red-500');
                statusEl.classList.add('text-green-600');
                
                renderApp();
                

            } catch (e) {
                console.error("L·ªói t·∫£i ·∫£nh l√™n:", e);
                statusEl.textContent = 'L·ªói t·∫£i ·∫£nh l√™n. Vui l√≤ng th·ª≠ l·∫°i.';
                statusEl.classList.remove('text-blue-600', 'text-green-600');
                statusEl.classList.add('text-red-500');
                
                // THAY ƒê·ªîI: Reset gi√° tr·ªã c·ªßa input ƒë·ªÉ cho ph√©p ch·ªçn l·∫°i file
                event.target.value = '';
                state.ui.tempAvatarUrl = null;
                state.ui.tempAvatarType = null;
                renderApp();
            }
        };

        window.handleSaveAvatar = async () => {
            const newAvatarUrl = state.ui.tempAvatarUrl;
            const newAvatarType = state.ui.tempAvatarType;

            // Ki·ªÉm tra xem c√≥ thay ƒë·ªïi n√†o kh√¥ng (d√π logic n√†y c≈©ng ƒë∆∞·ª£c x·ª≠ l√Ω b·ªüi Firestore)
            const isUnchanged = state.profile.avatarUrl === newAvatarUrl && state.profile.avatarType === newAvatarType;

            if (isUnchanged) {
                showToast("Kh√¥ng c√≥ thay ƒë·ªïi n√†o ƒë∆∞·ª£c l∆∞u.");
                toggleAvatarModal(false);
                return;
            }

            // Tr∆∞·ªùng h·ª£p ng∆∞·ªùi d√πng x√≥a ·∫£nh (ch·ªçn default)
            const isDefault = !newAvatarUrl;

            if (isDefault) {
                try {
                     await updateDoc(doc(db, getPath('users'), state.user.uid), {
                        avatarUrl: null,
                        avatarType: null,
                    });
                    showToast("ƒê√£ x√≥a avatar!");
                } catch (e) {
                     showToast("L·ªói x√≥a avatar.", "error");
                }
            } else {
                try {
                    await updateDoc(doc(db, getPath('users'), state.user.uid), {
                        avatarUrl: newAvatarUrl,
                        avatarType: newAvatarType,
                    });
                    showToast("ƒê√£ l∆∞u avatar th√†nh c√¥ng!");
                } catch (e) {
                    showToast("L·ªói l∆∞u avatar.", "error");
                    return;
                }
            }
            
            toggleAvatarModal(false);
        };
        
        // --- Student Class Handlers (M·ªöI) ---
        
        window.viewMyClassDetails = (id) => {
            state.ui.viewMyClassId = id;
            state.ui.isJoiningClass = false;
            renderApp();
        };

        window.toggleJoinClass = (val) => {
            state.ui.isJoiningClass = val;
            state.ui.viewMyClassId = null;
            renderApp();
        };

        window.handleJoinClass = async () => {
            const code = document.getElementById('join-class-code-input').value.trim().toUpperCase();
            if (code.length !== 6) return showToast("M√£ l·ªõp kh√¥ng h·ª£p l·ªá (6 k√Ω t·ª±)", "error");

            state.ui.isProcessingStudentCreation = true; // Use this existing flag for a loading state
            renderApp();

            try {
                // 1. T√¨m l·ªõp h·ªçc
                const classSnap = await getDocs(query(getRef('classes'), where('classCode', '==', code)));
                if (classSnap.empty) {
                    throw new Error("M√£ l·ªõp kh√¥ng t·ªìn t·∫°i.");
                }

                const classDoc = classSnap.docs[0];
                const classData = classDoc.data();
                const classId = classDoc.id;
                const studentUid = state.user.uid;

                // 2. Ki·ªÉm tra n·∫øu ƒë√£ tham gia
                if ((classData.studentIds || []).includes(studentUid)) {
                    throw new Error(`B·∫°n ƒë√£ l√† th√†nh vi√™n c·ªßa l·ªõp "${classData.title}".`);
                }

                // 3. C·∫≠p nh·∫≠t l·ªõp h·ªçc (th√™m studentId)
                await updateDoc(doc(db, getPath('classes'), classId), {
                    studentIds: arrayUnion(studentUid)
                });

                showToast(`Tham gia l·ªõp "${classData.title}" th√†nh c√¥ng!`);
                toggleJoinClass(false);
                viewMyClassDetails(classId); // Chuy·ªÉn sang xem chi ti·∫øt l·ªõp v·ª´a tham gia

            } catch(e) {
                console.error("L·ªói tham gia l·ªõp:", e);
                showToast(`L·ªói tham gia l·ªõp: ${e.message}`, "error");
            } finally {
                state.ui.isProcessingStudentCreation = false;
                renderApp();
            }
        };
        
        // --- Teacher Class Handlers (Gi·ªØ nguy√™n) ---
        window.toggleCreateClass = (val) => { state.ui.isCreatingClass = val; renderApp(); };
        window.viewClass = (id) => { 
            state.ui.viewClassId = id; 
            state.ui.isCreatingClass = false; 
            state.ui.viewClassMode = 'students'; // M·ªöI: Th√™m ch·∫ø ƒë·ªô xem m·∫∑c ƒë·ªãnh
            state.ui.isCreatingAssignment = false; // ƒê·∫£m b·∫£o tho√°t form t·∫°o b√†i t·∫≠p khi chuy·ªÉn l·ªõp
            state.ui.viewAssignmentId = null; // ƒê·∫£m b·∫£o tho√°t ch·∫ø ƒë·ªô xem/s·ª≠a b√†i t·∫≠p
            state.ui.selectedStatAssignmentId = null; // M·ªöI: Reset stat ID khi chuy·ªÉn l·ªõp
            renderApp(); 
        };
        window.setViewClassMode = (mode) => {
            state.ui.viewClassMode = mode;
            state.ui.viewAssignmentId = null;
            state.ui.isCreatingAssignment = false;
            // M·ªöI: Reset stat ID khi chuy·ªÉn tab, tr·ª´ khi chuy·ªÉn sang tab stats
            if (mode !== 'stats') {
                 state.ui.selectedStatAssignmentId = null; 
            }
            renderApp();
        };
        
        // --- M·ªöI: Handler cho Stats Detail View ---
        window.viewAssignmentStats = (assignmentId) => {
            state.ui.selectedStatAssignmentId = assignmentId;
            renderApp();
        }

        window.handleCreateClass = async () => {
            const title = document.getElementById('class-title').value.trim();
            if (!title) return showToast("Vui l√≤ng nh·∫≠p t√™n l·ªõp h·ªçc.", "error");
            
            const classCode = generateRoomCode();

            try {
                await addDoc(getRef('classes'), {
                    title,
                    teacherId: state.user.uid,
                    studentIds: [], 
                    classCode: classCode, 
                    createdAt: serverTimestamp()
                });
                toggleCreateClass(false);
                showToast("ƒê√£ t·∫°o l·ªõp h·ªçc th√†nh c√¥ng! M√£ l·ªõp l√†: " + classCode);
            } catch(e) {
                console.error("Firestore Error when creating class:", e);
                showToast("L·ªói t·∫°o l·ªõp h·ªçc.", "error");
            }
        };
        
        window.handleUpdateClassTitle = async (classId) => {
            const newTitle = document.getElementById('edit-class-title').value.trim();
            if (!newTitle) return showToast("T√™n l·ªõp kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng.", "error");
            
            try {
                await updateDoc(doc(db, getPath('classes'), classId), {
                    title: newTitle,
                    updatedAt: serverTimestamp()
                });
                showToast("ƒê√£ c·∫≠p nh·∫≠t t√™n l·ªõp h·ªçc!");
            } catch(e) {
                console.error("Firestore Error when updating class:", e);
                showToast("L·ªói c·∫≠p nh·∫≠t t√™n l·ªõp.", "error");
            }
        };

        window.confirmDeleteClass = (id, title) => {
            const confirmModal = document.createElement('div');
            confirmModal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
            confirmModal.innerHTML = `
                <div class="bg-white p-6 rounded-xl shadow-2xl max-w-sm w-full text-center">
                    <p class="font-bold text-lg mb-4 text-slate-800">X√°c nh·∫≠n x√≥a L·ªõp h·ªçc</p>
                    <p class="text-slate-600 mb-6 text-sm">B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a l·ªõp "${title}"? Thao t√°c n√†y s·∫Ω KH√îNG x√≥a t√†i kho·∫£n h·ªçc sinh, nh∆∞ng s·∫Ω lo·∫°i b·ªè l·ªõp n√†y.</p>
                    <div class="flex justify-around gap-4">
                        <button id="cancel-btn" class="flex-1 bg-slate-200 text-slate-700 py-2 rounded-lg font-medium hover:bg-slate-300 transition text-sm">H·ªßy</button>
                        <button id="delete-btn" class="flex-1 bg-red-600 text-white py-2 rounded-lg font-bold hover:bg-red-700 transition text-sm">X√°c nh·∫≠n X√ìA</button>
                    </div>
                </div>
            `;
            document.body.appendChild(confirmModal);

            const removeModal = () => document.body.removeChild(confirmModal);

            document.getElementById('cancel-btn').onclick = removeModal;
            document.getElementById('delete-btn').onclick = () => {
                deleteClass(id);
                removeModal();
            };
        };

        window.deleteClass = async (id) => {
            try {
                await deleteDoc(doc(db, getPath('classes'), id));
                showToast("ƒê√£ x√≥a l·ªõp h·ªçc th√†nh c√¥ng!");
                viewClass(null);
                renderApp();
            } catch (e) {
                console.error("Firestore Error when deleting class:", e);
                showToast(`L·ªói x√≥a l·ªõp: Ki·ªÉm tra quy·ªÅn truy c·∫≠p. Chi ti·∫øt: ${e.message}`, "error");
            }
        };
        
        window.confirmRemoveStudent = (classId, studentUid, studentName) => {
            const confirmModal = document.createElement('div');
            confirmModal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
            confirmModal.innerHTML = `
                <div class="bg-white p-6 rounded-xl shadow-2xl max-w-sm w-full text-center">
                    <p class="font-bold text-lg mb-4 text-slate-800">X√°c nh·∫≠n g·ª° H·ªçc sinh</p>
                    <p class="text-slate-600 mb-6 text-sm">B·∫°n c√≥ ch·∫Øc mu·ªën g·ª° "${studentName}" kh·ªèi l·ªõp? T√†i kho·∫£n c·ªßa h·ªçc sinh v·∫´n ƒë∆∞·ª£c gi·ªØ l·∫°i.</p>
                    <div class="flex justify-around gap-4">
                        <button id="cancel-btn" class="flex-1 bg-slate-200 text-slate-700 py-2 rounded-lg font-medium hover:bg-slate-300 transition text-sm">H·ªßy</button>
                        <button id="remove-btn" class="flex-1 bg-red-600 text-white py-2 rounded-lg font-bold hover:bg-red-700 transition text-sm">X√°c nh·∫≠n G·ª†</button>
                    </div>
                </div>
            `;
            document.body.appendChild(confirmModal);

            const removeModal = () => document.body.removeChild(confirmModal);

            document.getElementById('cancel-btn').onclick = removeModal;
            document.getElementById('remove-btn').onclick = () => {
                handleRemoveStudent(classId, studentUid, studentName);
                removeModal();
            };
        };

        window.handleRemoveStudent = async (classId, studentUid, studentName) => {
            try {
                await runTransaction(db, async (transaction) => {
                    const classRef = doc(db, getPath('classes'), classId);

                    transaction.update(classRef, {
                        studentIds: arrayRemove(studentUid)
                    });
                });
                showToast(`ƒê√£ g·ª° ${studentName} kh·ªèi l·ªõp!`);
            } catch(e) {
                console.error("Remove student error:", e);
                showToast("L·ªói g·ª° h·ªçc sinh.", "error");
            }
        };
        
        // --- Handlers Modal Nh·∫≠p d·ªØ li·ªáu (Gi·ªØ nguy√™n) ---
        
        // M·ªü/ƒë√≥ng modal nh·∫≠p li·ªáu
        window.toggleImportData = (val, fromBankForm = false) => {
            state.ui.isImportingBankData = val;
            // N·∫øu m·ªü modal t·ª´ trong form t·∫°o/s·ª≠a bank, reset importQType v√† gi·ªØ bankMode
            if (val && fromBankForm) {
                 state.ui.importQType = 'vocab_mcq'; 
            } 
            // N·∫øu m·ªü modal t·ª´ trang danh s√°ch, chuy·ªÉn sang ch·∫ø ƒë·ªô t·∫°o m·ªõi n·∫øu ch∆∞a c√≥
            else if (val && state.ui.bankMode === 'list') {
                 setBankMode('create');
            }
            renderApp();
        }

        window.setImportQType = (type) => { state.ui.importQType = type; renderApp(); };

        // H√†m x·ª≠ l√Ω vi·ªác ƒë·ªçc v√† ph√¢n t√≠ch file
        window.handleFileImport = () => {
            const fileInput = document.getElementById('file-upload');
            if (!fileInput.files.length) {
                return showToast("Vui l√≤ng ch·ªçn file .txt ƒë·ªÉ t·∫£i l√™n.", "error");
            }

            const file = fileInput.files[0];
            const reader = new FileReader();
            const qType = state.ui.importQType;

            reader.onload = (e) => {
                const text = e.target.result;
                const newQuestions = parseFileContent(text, qType);

                if (newQuestions.length > 0) {
                    state.ui.newAssignment.questions.push(...newQuestions);
                    showToast(`ƒê√£ th√™m th√†nh c√¥ng ${newQuestions.length} c√¢u h·ªèi m·ªõi!`);
                    toggleImportData(false); // ƒê√≥ng modal v√† render l·∫°i form
                } else {
                    showToast("File kh√¥ng c√≥ n·ªôi dung h·ª£p l·ªá ho·∫∑c sai ƒë·ªãnh d·∫°ng. Vui l√≤ng ki·ªÉm tra l·∫°i c·∫•u tr√∫c file TXT.", "error");
                }
            };

            reader.onerror = () => {
                showToast("L·ªói ƒë·ªçc file.", "error");
            };

            reader.readAsText(file);
        };
        
        // Logic ph√¢n t√≠ch c√∫ ph√°p file content
// --- LOGIC PH√ÇN T√çCH FILE TEXT (ƒê√É C·∫¨P NH·∫¨T TR·ªòN ƒê√ÅP √ÅN) ---
// --- LOGIC PH√ÇN T√çCH FILE TEXT (ƒê√É C·∫¨P NH·∫¨T T·∫†O DISTRACTORS T·ª™ FILE) ---
// --- LOGIC PH√ÇN T√çCH FILE TEXT (ƒê√É C·∫¨P NH·∫¨T TR·ªòN ƒê√ÅP √ÅN NG·∫™U NHI√äN) ---
// --- LOGIC PH√ÇN T√çCH FILE TEXT (ƒê√É S·ª¨A: B·ªé D·∫§U SAO **, THAY B·∫∞NG M√ÄU XANH IN ƒê·∫¨M) ---
// --- LOGIC PH√ÇN T√çCH FILE TEXT (ƒê√É C·∫¨P NH·∫¨T: TH√äM D·∫†NG NGHƒ®A -> T·ª™) ---
// --- LOGIC PH√ÇN T√çCH FILE TEXT (PHI√äN B·∫¢N N√ÇNG C·∫§P H·ªñ TR·ª¢ H·ªòI THO·∫†I) ---
        const parseFileContent = (text, qType) => {
            // H√†m tr·ªôn m·∫£ng (Shuffle)
            const shuffle = (array) => {
                let currentIndex = array.length, randomIndex;
                while (currentIndex != 0) {
                    randomIndex = Math.floor(Math.random() * currentIndex);
                    currentIndex--;
                    [array[currentIndex], array[randomIndex]] = [array[randomIndex], array[currentIndex]];
                }
                return array;
            };

            const newQuestions = [];
            
            // --- X·ª¨ L√ù RI√äNG CHO D·∫†NG H·ªòI THO·∫†I (C·∫•u tr√∫c Block ngƒÉn c√°ch b·ªüi d·∫•u #) ---
            if (qType === 'listen_conversation') {
                // 1. T√°ch c√°c b√†i t·∫≠p theo d·∫•u #
                const blocks = text.split('#').map(b => b.trim()).filter(b => b.length > 0);
                
                // L·∫•y th√¥ng tin b√†i h·ªçc ƒë·ªÉ t·∫°o ƒë∆∞·ªùng d·∫´n audio
                const lvl = document.getElementById('assign-level') ? document.getElementById('assign-level').value : 'H1';
                const lsn = document.getElementById('assign-lesson') ? document.getElementById('assign-lesson').value : 'Bai1';
                const folderPath = `data_Edubattle/${lvl}_${lsn}`;

                blocks.forEach(block => {
                    try {
                        const lines = block.split('\n').map(l => l.trim()).filter(l => l.length > 0);
                        let scriptLines = [];
                        let questionLine = null;
                        let answerLine = null;

                        // 2. Ph√¢n lo·∫°i t·ª´ng d√≤ng trong block
                        lines.forEach(line => {
                            if (line.startsWith('[HT')) {
                                questionLine = line;
                            } else if (line.startsWith('[TL]')) {
                                answerLine = line;
                            } else {
                                scriptLines.push(line);
                            }
                        });

                        if (questionLine && answerLine) {
                            // 3. X·ª≠ l√Ω d√≤ng C√¢u h·ªèi: [HT1] BÊòØË∞ÅÔºü -> File: HT1, Text: BÊòØË∞ÅÔºü
                            // Regex l·∫•y n·ªôi dung trong [] v√† n·ªôi dung ph√≠a sau
                            const qMatch = questionLine.match(/\[(.*?)\]\s*(.*)/);
                            if (!qMatch) return;
                            
                            const audioFileName = qMatch[1].trim(); // VD: HT1
                            const questionText = qMatch[2].trim();  // VD: BÊòØË∞ÅÔºü

                            // 4. X·ª≠ l√Ω d√≤ng ƒê√°p √°n: [TL] ËÄÅÂ∏à|Â≠¶Áîü*|Êàë|‰Ω†
                            const rawAnswers = answerLine.replace('[TL]', '').split('|').map(a => a.trim());
                            let correctIndex = -1;
                            
                            // T√¨m ƒë√°p √°n c√≥ d·∫•u * v√† x√≥a d·∫•u * ƒëi
                            const cleanOptions = rawAnswers.map((ans, idx) => {
                                if (ans.endsWith('*')) {
                                    correctIndex = idx;
                                    return ans.slice(0, -1); // C·∫Øt b·ªè d·∫•u *
                                }
                                return ans;
                            });

                            if (correctIndex === -1) correctIndex = 0; // Fallback n·∫øu qu√™n ƒë√°nh d·∫•u *

                            // 5. T·∫°o c√¢u h·ªèi ho√†n ch·ªânh
                            newQuestions.push({
                                type: 'listen_conversation',
                                audioText: audioFileName,
                                audioUrl: `${folderPath}/${audioFileName}.mp3`,
                                conversationContent: scriptLines.join('\n'), // Gh√©p script l·∫°i
                                text: questionText,
                                options: cleanOptions,
                                correct: correctIndex
                            });
                        }
                    } catch (e) {
                        console.error("L·ªói parse block h·ªôi tho·∫°i:", e);
                    }
                });
                
                return newQuestions;
            }
            // -----------------------------------------------------------
            // X·ª¨ L√ù RI√äNG CHO D·∫†NG S·∫ÆP X·∫æP C√ÇU (C·∫•u tr√∫c Block v·ªõi d·∫•u #)
            // -----------------------------------------------------------
             if (qType === 'order_sentences') {
                const blocks = text.split('#').map(b => b.trim()).filter(b => b.length > 0);
                
                blocks.forEach(block => {
                    try {
                        // T√°ch t·ª´ng d√≤ng, m·ªói d√≤ng l√† m·ªôt c√¢u
                        const sentences = block.split('\n').map(l => l.trim()).filter(l => l.length > 0);
                        
                        if (sentences.length >= 2) {
                            newQuestions.push({
                                type: 'order_sentences',
                                text: "S·∫Øp x·∫øp th·ª© t·ª± c√°c c√¢u cho ƒë√∫ng:",
                                answer: sentences // L∆∞u th·ª© t·ª± ƒë√∫ng
                            });
                        }
                    } catch (e) {
                        console.error("L·ªói parse block s·∫Øp x·∫øp c√¢u:", e);
                    }
                });
                return newQuestions;
            }
if (qType === 'reading_comprehension') {
                const blocks = text.split('#').map(b => b.trim()).filter(b => b.length > 0);

                blocks.forEach(block => {
                    try {
                        const lines = block.split('\n').map(l => l.trim()).filter(l => l.length > 0);
                        let passageLines = [];
                        let questionLine = null;
                        let answerLine = null;

                        lines.forEach(line => {
                            if (line.startsWith('[H]')) {
                                questionLine = line;
                            } else if (line.startsWith('[TL]')) {
                                answerLine = line;
                            } else {
                                passageLines.push(line);
                            }
                        });

                        if (questionLine && answerLine && passageLines.length > 0) {
                            // [H] C√¢u h·ªèi... -> L·∫•y ph·∫ßn sau [H]
                            const questionText = questionLine.replace('[H]', '').trim();

                            // [TL] A|B*|C...
                            const rawAnswers = answerLine.replace('[TL]', '').split('|').map(a => a.trim());
                            let correctIndex = -1;
                            
                            const cleanOptions = rawAnswers.map((ans, idx) => {
                                if (ans.endsWith('*')) {
                                    correctIndex = idx;
                                    return ans.slice(0, -1);
                                }
                                return ans;
                            });

                            if (correctIndex === -1) correctIndex = 0;

                            newQuestions.push({
                                type: 'reading_comprehension',
                                conversationContent: passageLines.join('\n'), // L∆∞u ƒëo·∫°n vƒÉn
                                text: questionText,
                                options: cleanOptions,
                                correct: correctIndex
                            });
                        }
                    } catch (e) {
                        console.error("L·ªói parse block ƒë·ªçc hi·ªÉu:", e);
                    }
                });
                return newQuestions;
            }
            // --- C√ÅC D·∫†NG C≈® (X·ª¨ L√ù THEO D√íNG) ---
            const lines = text.split('\n').map(line => line.trim()).filter(line => line.length > 0);
            
            // ... (Gi·ªØ nguy√™n logic t·∫°o tempVocabList v√† getDistractors nh∆∞ c≈©) ...
            const tempVocabList = [];
            lines.forEach(line => {
                const parts = line.split('|');
                if (parts.length >= 3) {
                    tempVocabList.push({ word: parts[0].trim(), pinyin: parts[1].trim(), meaning: parts[2].trim() });
                }
            });
            while (tempVocabList.length < 4) { tempVocabList.push({ word: 'V√≠ d·ª•', pinyin: 'l√¨r√∫', meaning: 'M·∫´u' }); }
            const getDistractors = (correctValue, field) => {
                const distractors = [];
                const candidates = shuffle([...tempVocabList]); 
                for (const item of candidates) {
                    const value = item[field];
                    if (value !== correctValue && !distractors.includes(value)) distractors.push(value);
                    if (distractors.length === 3) break;
                }
                while (distractors.length < 3) distractors.push(`L·ª±a ch·ªçn ${distractors.length + 1}`);
                return distractors;
            };

            // Loop c√°c d√≤ng cho d·∫°ng c≈©
            lines.forEach(line => {
                try {
                    const lvl = document.getElementById('assign-level') ? document.getElementById('assign-level').value : 'H1';
                    const lsn = document.getElementById('assign-lesson') ? document.getElementById('assign-lesson').value : 'Bai1';
                    const folderPath = `data_Edubattle/${lvl}_${lsn}`;

                    switch (qType) {
                        case 'vocab_mcq':
                            const parts_v = line.split('|');
                            if (parts_v.length < 3) return;
                            const [word, pinyin, meaning] = parts_v.map(p => p.trim());
                            
                            let optionsM = [meaning, ...getDistractors(meaning, 'meaning')];
                            optionsM = shuffle(optionsM); 
                            newQuestions.push({ type: 'mcq', text: `Nghƒ©a c·ªßa t·ª´ <span class="font-bold text-blue-600 text-xl mx-1">${word}</span> l√† g√¨?`, options: optionsM, correct: optionsM.indexOf(meaning) });

                            let optionsP = [pinyin, ...getDistractors(pinyin, 'pinyin')];
                            optionsP = shuffle(optionsP); 
                            newQuestions.push({ type: 'mcq', text: `Pinyin c·ªßa t·ª´ <span class="font-bold text-blue-600 text-xl mx-1">${word}</span> l√† g√¨?`, options: optionsP, correct: optionsP.indexOf(pinyin) });

                            let optionsW = [word, ...getDistractors(word, 'word')];
                            optionsW = shuffle(optionsW); 
                            newQuestions.push({ type: 'mcq', text: `T·ª´ c√≥ nghƒ©a l√†: <span class="font-bold text-blue-600 text-xl mx-1">"${meaning}"</span>?`, options: optionsW, correct: optionsW.indexOf(word) });
                            break;

                        case 'listen_mcq':
                            const parts_l = line.split('|');
                            if (parts_l.length < 3) return;
                            const [word_l, pinyin_l, meaning_l] = parts_l.map(p => p.trim());
                            let options_l = [meaning_l, ...getDistractors(meaning_l, 'meaning')];
                            options_l = shuffle(options_l); 
                            newQuestions.push({ type: 'listen_mcq', audioText: word_l, audioUrl: `${folderPath}/${word_l}.mp3`, text: "Nghe √¢m thanh v√† ch·ªçn nghƒ©a ƒë√∫ng:", options: options_l, correct: options_l.indexOf(meaning_l) });
                            break;

                        case 'fib': 
                            const match_fib = line.match(/\|([^|]+)\|/);
                            if (match_fib) {
                                newQuestions.push({ type: 'fib', text: line.replace(/\|[^|]+\|/, '[BLANK]').trim(), answer: match_fib[1].trim() });
                            }
                            break;

                        case 'jumble':
                            const words = line.split(/\s+/).filter(w => w.length > 0);
                            if (words.length >= 2) newQuestions.push({ type: 'jumble', text: "S·∫Øp x·∫øp c√°c t·ª´ th√†nh c√¢u ƒë√∫ng:", answer: words });
                            break;

                        case 'translation':
                        case 'listen_translate':
                        case 'listen_write':
                            const parts_common = line.split('|');
                            if (parts_common.length >= 2) {
                                const [tc, tv] = parts_common.map(p => p.trim());
                                const audioCommon = `${folderPath}/${tc}.mp3`;
                                if (qType === 'translation') newQuestions.push({ type: 'translation', vietnamese: tv, chinese: tc, text: tv });
                                else if (qType === 'listen_translate') newQuestions.push({ type: 'listen_translate', audioText: tc, audioUrl: audioCommon, answer: tv, text: "Nghe c√¢u v√† d·ªãch nghƒ©a sang ti·∫øng Vi·ªát." });
                                else newQuestions.push({ type: 'listen_write', audioText: tc, audioUrl: audioCommon, answer: tc, text: "Nghe c√¢u v√† vi·∫øt l·∫°i." });
                            }
                            break;
                    }
                } catch (error) {
                    console.warn(`B·ªè qua d√≤ng l·ªói: ${line}`);
                }
            });

            return newQuestions;
        };
        // --- Handlers Ng√¢n h√†ng ƒë·ªÅ (Gi·ªØ nguy√™n) ---
        window.setBankMode = (mode, id = null) => {
            state.ui.bankMode = mode;
            state.ui.selectedBankId = id;
            if (mode === 'create' || mode === 'list') {
                state.ui.newAssignment = { title: '', questions: [], selectedClassIds: [] };
            }
            renderApp();
        };

        window.viewBankDetails = (id) => {
            state.ui.selectedBankId = id;
            state.ui.bankMode = id ? 'view' : 'list';
            if (id) {
                const bank = state.data.questionBanks.find(b => b.id === id);
                if (bank) {
                    state.ui.newAssignment = { ...bank, questions: JSON.parse(JSON.stringify(bank.questions)), selectedClassIds: [] };
                }
            } else {
                state.ui.newAssignment = { title: '', questions: [], selectedClassIds: [] }; 
            }
            renderApp();
        }

        window.publishQuestionBank = async () => {
            const title = document.getElementById('new-bank-title').value;
            if(!title || state.ui.newAssignment.questions.length === 0) return showToast("Vui l√≤ng nh·∫≠p ti√™u ƒë·ªÅ v√† th√™m √≠t nh·∫•t m·ªôt c√¢u h·ªèi", "error");
            
            try {
                await addDoc(getRef('question_banks'), {
                    title,
                    questions: state.ui.newAssignment.questions,
                    createdBy: state.user.uid,
                    createdAt: serverTimestamp()
                });
                setBankMode('list');
                showToast("ƒê√£ t·∫°o Ng√¢n h√†ng ƒë·ªÅ!");
            } catch(e) { 
                console.error("Firestore Error when publishing bank:", e);
                showToast("L·ªói t·∫°o Ng√¢n h√†ng ƒë·ªÅ: Vui l√≤ng ki·ªÉm tra quy·ªÅn truy c·∫≠p Firebase.", "error"); 
            }
        };
        
        window.saveBankChanges = async (id) => {
            const newTitle = document.getElementById('edit-bank-title').value;
            if(!newTitle || state.ui.newAssignment.questions.length === 0) return showToast("Vui l√≤ng nh·∫≠p ti√™u ƒë·ªÅ v√† th√™m √≠t nh·∫•t m·ªôt c√¢u h·ªèi", "error");

            try {
                const dataToUpdate = {
                    title: newTitle,
                    questions: state.ui.newAssignment.questions,
                    updatedAt: serverTimestamp()
                };

                await updateDoc(doc(db, getPath('question_banks'), id), dataToUpdate);
                viewBankDetails(null); 
                showToast("ƒê√£ l∆∞u thay ƒë·ªïi Ng√¢n h√†ng ƒë·ªÅ!");
            } catch(e) {
                console.error("Firestore Error when saving bank:", e);
                showToast(`L·ªói l∆∞u Ng√¢n h√†ng ƒë·ªÅ: Ki·ªÉm tra quy·ªÅn truy c·∫≠p. Chi ti·∫øt: ${e.message}`, "error");
            }
        };
        
        window.confirmDeleteBank = (id, title) => {
            const confirmModal = document.createElement('div');
            confirmModal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
            confirmModal.innerHTML = `
                <div class="bg-white p-6 rounded-xl shadow-2xl max-w-sm w-full text-center">
                    <p class="font-bold text-lg mb-4 text-slate-800">X√°c nh·∫≠n x√≥a Ng√¢n h√†ng ƒë·ªÅ</p>
                    <p class="text-slate-600 mb-6 text-sm">B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a Ng√¢n h√†ng ƒë·ªÅ "${title}"? Thao t√°c n√†y kh√¥ng th·ªÉ ho√†n t√°c.</p>
                    <div class="flex justify-around gap-4">
                        <button id="cancel-btn" class="flex-1 bg-slate-200 text-slate-700 py-2 rounded-lg font-medium hover:bg-slate-300 transition text-sm">H·ªßy</button>
                        <button id="delete-btn" class="flex-1 bg-red-600 text-white py-2 rounded-lg font-bold hover:bg-red-700 transition text-sm">X√°c nh·∫≠n X√ìA</button>
                    </div>
                </div>
            `;
            document.body.appendChild(confirmModal);

            const removeModal = () => document.body.removeChild(confirmModal);

            document.getElementById('cancel-btn').onclick = removeModal;
            document.getElementById('delete-btn').onclick = () => {
                deleteQuestionBank(id);
                removeModal();
            };
        };
        
        window.deleteQuestionBank = async (id) => {
            try {
                await deleteDoc(doc(db, getPath('question_banks'), id));
                showToast("ƒê√£ x√≥a Ng√¢n h√†ng ƒë·ªÅ th√†nh c√¥ng!");
                renderApp();
            } catch (e) {
                console.error("Firestore Error when deleting bank:", e);
                showToast(`L·ªói x√≥a Ng√¢n h√†ng ƒë·ªÅ: Ki·ªÉm tra quy·ªÅn truy c·∫≠p. Chi ti·∫øt: ${e.message}`, "error");
            }
        };

        // --- Handlers Th√™m c√¢u h·ªèi t·ª´ Bank v√†o Assignment (Gi·ªØ nguy√™n) ---

        window.setSelectingBankQuestions = (val) => {
            state.ui.isSelectingBankQuestions = val;
            state.ui.selectedBankId = null;
            renderApp();
        }

        window.selectBankToDraw = (bankId) => {
            state.ui.selectedBankId = bankId;
            renderApp();
        }
        
// --- H√ÄM CH·ªåN TH·ª¶ C√îNG C√ÇU H·ªéI T·ª™ BANK (ƒê√É FIX L·ªñI NH·∫¢Y SCROLL) ---
window.selectQuestionFromBank = (qIndex) => {
            const scrollContainer = document.getElementById('bank-scroll-view');
            let savedScrollTop = 0;
            if (scrollContainer) savedScrollTop = scrollContainer.scrollTop;

            const selectedBank = state.data.questionBanks.find(b => b.id === state.ui.selectedBankId);
            if (!selectedBank) return;

            const questionToToggle = selectedBank.questions[qIndex];
            
            // X√ÅC ƒê·ªäNH DANH S√ÅCH C·∫¶N THAO T√ÅC
            let currentQs;
            if (state.view === 'challenges') {
                if (!state.ui.activeChallenge.questions) state.ui.activeChallenge.questions = [];
                currentQs = state.ui.activeChallenge.questions;
            } else {
                if (!state.ui.newAssignment.questions) state.ui.newAssignment.questions = [];
                currentQs = state.ui.newAssignment.questions;
            }

            // Logic th√™m/x√≥a
            const existingIndex = currentQs.findIndex(existQ => 
                JSON.stringify({t: existQ.text, o: existQ.options, a: existQ.answer}) === 
                JSON.stringify({t: questionToToggle.text, o: questionToToggle.options, a: questionToToggle.answer})
            );

            if (existingIndex !== -1) {
                currentQs.splice(existingIndex, 1);
            } else {
                currentQs.push(questionToToggle);
            }

            renderApp();

            const newScrollContainer = document.getElementById('bank-scroll-view');
            if (newScrollContainer) newScrollContainer.scrollTop = savedScrollTop;
        };
        
window.addRandomQuestions = (bankId) => {
            const selectedBank = state.data.questionBanks.find(b => b.id === bankId);
            if (!selectedBank) return showToast("L·ªói: Kh√¥ng t√¨m th·∫•y ng√¢n h√†ng ƒë·ªÅ.", "error");

            const availableQuestions = selectedBank.questions;
            
            // X√ÅC ƒê·ªäNH DANH S√ÅCH ƒê√çCH (ƒê√É S·ª¨A: targetList ch√≠nh l√† currentAssignmentQs)
            let targetList;
            if (state.view === 'challenges') {
                if (!state.ui.activeChallenge.questions) state.ui.activeChallenge.questions = [];
                targetList = state.ui.activeChallenge.questions;
            } else {
                targetList = state.ui.newAssignment.questions;
            }
            
            // ƒê·∫∑t t√™n bi·∫øn d·ªÖ hi·ªÉu ƒë·ªÉ d√πng b√™n d∆∞·ªõi
            const currentAssignmentQs = targetList; 

            let totalAdded = 0;
            const typesInBank = [...new Set(availableQuestions.map(q => q.type))];

            typesInBank.forEach(type => {
                const inputEl = document.getElementById(`count-for-${type}`);
                if (!inputEl) return;

                const countNeeded = parseInt(inputEl.value) || 0;
                if (countNeeded <= 0) return;

                // 1. L·ªçc ra c√°c c√¢u h·ªèi thu·ªôc lo·∫°i n√†y
                const qsByType = availableQuestions.filter(q => q.type === type);

                // 2. L·ªçc tr√πng n·ªôi dung
                const uniqueCandidates = [];
                const seenContent = new Set();

                qsByType.forEach(q => {
                    const contentSignature = JSON.stringify({
                        text: q.text,
                        vietnamese: q.vietnamese,
                        audioText: q.audioText,
                        options: q.options,
                        answer: q.answer,
                        pairs: q.pairs
                    });

                    if (!seenContent.has(contentSignature)) {
                        seenContent.add(contentSignature);
                        uniqueCandidates.push(q);
                    }
                });

                // 3. L·ªçc b·ªè c√°c c√¢u ƒë√£ c√≥ trong b√†i t·∫≠p hi·ªán t·∫°i
                const finalCandidates = uniqueCandidates.filter(q => 
                    !currentAssignmentQs.some(existQ => {
                        const sig1 = JSON.stringify({t: q.text, o: q.options, a: q.answer});
                        const sig2 = JSON.stringify({t: existQ.text, o: existQ.options, a: existQ.answer});
                        return sig1 === sig2;
                    })
                );

                if (finalCandidates.length < countNeeded) {
                    showToast(`Lo·∫°i "${getQuestionTypeLabel(type)}" ch·ªâ c√≤n ${finalCandidates.length} c√¢u ch∆∞a s·ª≠ d·ª•ng.`, "warning");
                }

                // 4. Tr·ªôn ng·∫´u nhi√™n
                let shuffled = [...finalCandidates]; 
                for (let i = shuffled.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
                }

                // 5. C·∫Øt v√† th√™m
                const selected = shuffled.slice(0, countNeeded);
                targetList.push(...selected); // Th√™m v√†o danh s√°ch ƒë√≠ch
                totalAdded += selected.length;
            });

            if (totalAdded > 0) {
                showToast(`ƒê√£ th√™m ng·∫´u nhi√™n ${totalAdded} c√¢u h·ªèi!`, "success");
                setSelectingBankQuestions(false); // ƒê√≥ng modal
                renderApp(); 
            } else {
                showToast("Vui l√≤ng nh·∫≠p s·ªë l∆∞·ª£ng c√¢u h·ªèi c·∫ßn l·∫•y (l·ªõn h∆°n 0).", "error");
            }
        };

        // --- Assignment Handlers (Gi·ªØ nguy√™n) ---
        window.handleClassSelection = (classId, isChecked) => {
            const currentIds = state.ui.newAssignment.selectedClassIds;
            if (isChecked) {
                if (!currentIds.includes(classId)) {
                    state.ui.newAssignment.selectedClassIds = [...currentIds, classId];
                }
            } else {
                state.ui.newAssignment.selectedClassIds = currentIds.filter(id => id !== classId);
            }
            renderApp();
        }

        window.renderCompetitionCreate = () => `<div class="max-w-sm mx-auto bg-white p-6 md:p-8 rounded-2xl shadow-xl text-center fade-in">
                <h3 class="text-xl md:text-2xl font-bold text-slate-700 mb-6">T·∫°o ph√≤ng ƒë·∫•u m·ªõi</h3>
                <button onclick="createMatch()" class="w-full bg-green-600 hover:bg-green-700 text-white py-3 rounded-xl font-bold shadow-md transition">
                    T·∫°o Ph√≤ng Ngay (10 C√¢u h·ªèi)
                </button>
                <button onclick="setCompetitionMode('lobby')" class="mt-4 w-full text-slate-500 hover:text-slate-700 transition text-sm">Quay l·∫°i</button>
            </div>`; 

        window.changeQuestionType = (type) => { state.ui.newQuestionType = type; renderApp(); };
        
        // C·∫≠p nh·∫≠t toggleCreate ƒë·ªÉ ƒë·∫£m b·∫£o reset/gi·ªØ newAssignment title v√† classIds
        window.toggleCreate = (val) => {
            state.ui.isCreatingAssignment = val;
            state.ui.isSelectingBankQuestions = false;
            state.ui.selectedBankId = null;
            
            // N·∫øu tho√°t ch·∫ø ƒë·ªô t·∫°o, reset newAssignment
            if(!val) {
                state.ui.newAssignment = { title: '', questions: [], selectedClassIds: [] };
            } 
            // N·∫øu v√†o ch·∫ø ƒë·ªô t·∫°o (val=true), ƒë·∫£m b·∫£o newAssignment ƒë∆∞·ª£c gi·ªØ l·∫°i n·∫øu ƒë√£ set t·ª´ createClassAssignment,
            // ho·∫∑c ƒë∆∞·ª£c kh·ªüi t·∫°o n·∫øu v√†o t·ª´ tab Assignments
            else if (!state.ui.newAssignment || state.ui.newAssignment.questions.length === 0) {
                 state.ui.newAssignment = { title: '', questions: [], selectedClassIds: [] };
                 state.ui.newQuestionType = 'mcq';
            }
            renderApp();
        };

        window.createClassAssignment = (classId, classTitle) => {
            state.ui.isCreatingAssignment = true;
            state.ui.viewAssignmentId = null; // M·ªöI: Reset viewAssignmentId khi t·∫°o b√†i t·∫≠p
            // Set gi√° tr·ªã m·∫∑c ƒë·ªãnh cho title v√† classIds
            state.ui.newAssignment = { title: `B√†i t·∫≠p cho l·ªõp ${classTitle}`, questions: [], selectedClassIds: [classId] };
            state.ui.viewClassId = classId; // Gi·ªØ ng·ªØ c·∫£nh l·ªõp h·ªçc
            state.ui.newQuestionType = 'mcq';
            renderApp();
        };
        
        // C·∫≠p nh·∫≠t viewAssignmentDetails ƒë·ªÉ c√≥ th·ªÉ g·ªçi t·ª´ renderClassAssignments
        window.viewAssignmentDetailsInClass = (id) => {
            state.ui.isCreatingAssignment = false; 
            state.ui.takingAssignmentId = null;
            state.ui.viewSubmission = null;
            state.ui.isSelectingBankQuestions = false; 
            state.ui.viewAssignmentId = id;
            
            // Load data for editing
            if (id) {
                const assign = state.data.assignments.find(a => a.id === id);
                if (assign) {
                    state.ui.newAssignment = { 
                        ...assign, 
                        questions: JSON.parse(JSON.stringify(assign.questions)),
                        selectedClassIds: assign.classIds || []
                    };
                }
            } else {
                state.ui.newAssignment = { title: '', questions: [], selectedClassIds: [] }; 
            }
            renderApp();
        };
        // Gi·ªØ l·∫°i viewAssignmentDetails ban ƒë·∫ßu cho c√°c tab kh√°c
        window.viewAssignmentDetails = (id) => {
            state.ui.isCreatingAssignment = false; 
            state.ui.takingAssignmentId = null;
            state.ui.viewSubmission = null;
            state.ui.isSelectingBankQuestions = false; 

            state.ui.viewAssignmentId = id;
            if (id) {
                const assign = state.data.assignments.find(a => a.id === id);
                if (assign) {
                    state.ui.newAssignment = { 
                        ...assign, 
                        questions: JSON.parse(JSON.stringify(assign.questions)),
                        selectedClassIds: assign.classIds || []
                    };
                }
            } else {
                state.ui.newAssignment = { title: '', questions: [], selectedClassIds: [] }; 
            }
            renderApp();
        };
        

       window.removeQuestionInEdit = (qIdx) => {
            if (state.view === 'challenges') {
                if (state.ui.activeChallenge && state.ui.activeChallenge.questions) {
                    state.ui.activeChallenge.questions.splice(qIdx, 1);
                    renderApp();
                }
            } else {
                if (state.ui.newAssignment && state.ui.newAssignment.questions) {
                    state.ui.newAssignment.questions.splice(qIdx, 1);
                    renderApp();
                }
            }
        };
        window.saveAssignmentChanges = async (id) => {
            const newTitle = document.getElementById('edit-assign-title').value;
            const timeLimit = parseInt(document.getElementById('edit-assign-time').value) || 0;
            const classIds = state.ui.newAssignment.selectedClassIds;
            
            if(!newTitle || state.ui.newAssignment.questions.length === 0 || classIds.length === 0) {
                 return showToast("Vui l√≤ng nh·∫≠p ti√™u ƒë·ªÅ, ch·ªçn √≠t nh·∫•t m·ªôt l·ªõp v√† th√™m √≠t nh·∫•t m·ªôt c√¢u h·ªèi", "error");
            }

            try {
                const dataToUpdate = {
                    title: newTitle,
	timeLimit,
                    questions: state.ui.newAssignment.questions,
                    classIds: classIds, 
                    updatedAt: serverTimestamp()
                };

                await updateDoc(doc(db, getPath('assignments'), id), dataToUpdate);
                
                // N·∫øu ƒëang ch·ªânh s·ª≠a t·ª´ ch·∫ø ƒë·ªô xem l·ªõp, quay l·∫°i ch·∫ø ƒë·ªô b√†i t·∫≠p c·ªßa l·ªõp ƒë√≥
                if (state.ui.viewClassId) {
                    // C·∫ßn reset viewAssignmentId c·ª•c b·ªô
                    state.ui.viewAssignmentId = null;
                    setViewClassMode('assignments');
                } else {
                    viewAssignmentDetails(null); 
                }

                showToast("ƒê√£ l∆∞u thay ƒë·ªïi b√†i t·∫≠p!");
            } catch(e) {
                console.error("Firestore Error when saving assignment:", e);
                showToast(`L·ªói l∆∞u b√†i: Ki·ªÉm tra quy·ªÅn truy c·∫≠p. Chi ti·∫øt: ${e.message}`, "error");
            }
        };
        
        window.confirmDeleteAssignment = (id, title) => {
            const confirmModal = document.createElement('div');
            confirmModal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
            confirmModal.innerHTML = `
                <div class="bg-white p-6 rounded-xl shadow-2xl max-w-sm w-full text-center">
                    <p class="font-bold text-lg mb-4 text-slate-800">X√°c nh·∫≠n x√≥a b√†i t·∫≠p</p>
                    <p class="text-slate-600 mb-6 text-sm">B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a b√†i t·∫≠p "${title}"? Thao t√°c n√†y kh√¥ng th·ªÉ ho√†n t√°c.</p>
                    <div class="flex justify-around gap-4">
                        <button id="cancel-btn" class="flex-1 bg-slate-200 text-slate-700 py-2 rounded-lg font-medium hover:bg-slate-300 transition text-sm">H·ªßy</button>
                        <button id="delete-btn" class="flex-1 bg-red-600 text-white py-2 rounded-lg font-bold hover:bg-red-700 transition text-sm">X√°c nh·∫≠n X√ìA</button>
                    </div>
                </div>
            `;
            document.body.appendChild(confirmModal);

            const removeModal = () => document.body.removeChild(confirmModal);

            document.getElementById('cancel-btn').onclick = removeModal;
            document.getElementById('delete-btn').onclick = () => {
                deleteAssignment(id);
                removeModal();
            };
        };

        window.deleteAssignment = async (id) => {
            try {
                await deleteDoc(doc(db, getPath('assignments'), id));
                showToast("ƒê√£ x√≥a b√†i t·∫≠p th√†nh c√¥ng!");
                renderApp();
            } catch (e) {
                console.error("Firestore Error when deleting assignment:", e);
                showToast(`L·ªói x√≥a b√†i: Ki·ªÉm tra quy·ªÅn truy c·∫≠p. Chi ti·∫øt: ${e.message}`, "error");
            }
        };


window.addQuestion = () => {
            const type = state.ui.newQuestionType;
            let newQ = { type };
            let isValid = false;

            // 1. L·∫§Y GI√Å TR·ªä C·∫§P ƒê·ªò V√Ä B√ÄI H·ªåC
            const lvl = document.getElementById('assign-level') ? document.getElementById('assign-level').value : 'H1';
            const lsn = document.getElementById('assign-lesson') ? document.getElementById('assign-lesson').value : 'Bai1';
            const folderName = `${lvl}_${lsn}`;

            // Helper t·∫°o ƒë∆∞·ªùng d·∫´n local
            const createLocalPath = (filename) => {
                if(!filename) return null;
                return `data_Edubattle/${folderName}/${filename.trim()}.mp3`;
            };

            try {
                switch(type) {
                    // --- 1. TR·∫ÆC NGHI·ªÜM (MCQ) - LOGIC M·ªöI ---
                    case 'mcq':
                         const txt = document.getElementById('q-text').value;
                         const opts = [
                            document.getElementById('opt-0').value,
                            document.getElementById('opt-1').value,
                            document.getElementById('opt-2').value,
                            document.getElementById('opt-3').value
                        ];
                        
                        // L·∫•y ƒë√°p √°n ƒë√∫ng t·ª´ Radio Button
                        const checkedRadio = document.querySelector('input[name="mcq_correct_input"]:checked');
                        if (!checkedRadio) throw new Error("Vui l√≤ng t√≠ch ch·ªçn ƒë√°p √°n ƒë√∫ng.");
                        const correct = parseInt(checkedRadio.value);

                        if(!txt || opts.some(o => !o)) throw new Error("Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß n·ªôi dung.");
                        newQ = { ...newQ, text: txt, options: opts, correct };
                        isValid = true;
                        break;

                    case 'fib':
                        const fibText = document.getElementById('fib-text').value;
                        const fibAnswer = document.getElementById('fib-answer').value.trim();
                        if (!fibText.includes('[BLANK]')) throw new Error("Thi·∫øu [BLANK].");
                        if (!fibAnswer) throw new Error("Thi·∫øu ƒë√°p √°n.");
                        newQ = { ...newQ, text: fibText, answer: fibAnswer };
                        isValid = true;
                        break;
                    case 'jumble':
                        const jumbleText = document.getElementById('jumble-answer').value.trim();
                        if (!jumbleText) throw new Error("Thi·∫øu c√¢u ƒë√∫ng.");
                        const words = jumbleText.split(/\s+/).filter(w => w.length > 0);
                        if (words.length < 2) throw new Error("C√¢u qu√° ng·∫Øn.");
                        newQ = { ...newQ, text: jumbleText, answer: words }; 
                        isValid = true;
                        break;
                    case 'match':
                         const pairs = [];
                        for(let i=0; i<3; i++) {
                            const a = document.getElementById(`match-a${i}`).value.trim();
                            const b = document.getElementById(`match-b${i}`).value.trim();
                            if (!a || !b) throw new Error(`Thi·∫øu c·∫∑p ${i+1}.`);
                            pairs.push({ a, b });
                        }
                        newQ = { ...newQ, pairs, text: "Gh√©p ƒë√¥i c√°c m·ª•c sau:" };
                        isValid = true;
                        break;
                    case 'translation':
                        const vn = document.getElementById('trans-vn').value.trim();
                        const cn = document.getElementById('trans-cn').value.trim();
                        if (!vn || !cn) throw new Error("Thi·∫øu n·ªôi dung.");
                        newQ = { ...newQ, vietnamese: vn, chinese: cn, text: vn };
                        isValid = true;
                        break;

                    // --- 2. NGHE TR·∫ÆC NGHI·ªÜM (LISTEN MCQ) - LOGIC M·ªöI ---
                    case 'listen_mcq':
                        const lmcqAudio = document.getElementById('listen-mcq-audio').value.trim();
                        const lmcqOpts = [
                            document.getElementById('lmcq-opt-0').value,
                            document.getElementById('lmcq-opt-1').value,
                            document.getElementById('lmcq-opt-2').value,
                            document.getElementById('lmcq-opt-3').value
                        ];
                        
                        // L·∫•y ƒë√°p √°n ƒë√∫ng t·ª´ Radio Button (name kh√°c v·ªõi mcq th∆∞·ªùng)
                        const checkedListenRadio = document.querySelector('input[name="lmcq_correct_input"]:checked');
                        if (!checkedListenRadio) throw new Error("Vui l√≤ng t√≠ch ch·ªçn ƒë√°p √°n ƒë√∫ng.");
                        const lmcqCorrect = parseInt(checkedListenRadio.value);
                        
                        if(!lmcqAudio || lmcqOpts.some(o => !o)) throw new Error("Vui l√≤ng nh·∫≠p t√™n file √¢m thanh v√† ƒë√°p √°n.");
                        
                        newQ = { 
                            ...newQ, 
                            audioText: lmcqAudio, 
                            audioUrl: createLocalPath(lmcqAudio), 
                            text: "Nghe √¢m thanh v√† ch·ªçn nghƒ©a ƒë√∫ng:", 
                            options: lmcqOpts, 
                            correct: lmcqCorrect 
                        };
                        isValid = true;
                        break;

                    case 'listen_write':
                        const lwAudio = document.getElementById('listen-write-audio').value.trim();
                        const lwAnswer = document.getElementById('listen-write-answer').value.trim();
                        if (!lwAudio || !lwAnswer) throw new Error("Thi·∫øu t√™n file ho·∫∑c ƒë√°p √°n.");
                        
                        newQ = { 
                            ...newQ, 
                            audioText: lwAudio, 
                            audioUrl: createLocalPath(lwAudio),
                            answer: lwAnswer, 
                            text: "Nghe c√¢u v√† vi·∫øt l·∫°i." 
                        }; 
                        isValid = true;
                        break;

                    case 'listen_translate':
                        const ltAudio = document.getElementById('listen-trans-audio').value.trim();
                        const ltAnswer = document.getElementById('listen-trans-answer').value.trim();
                        if (!ltAudio || !ltAnswer) throw new Error("Thi·∫øu t√™n file ho·∫∑c ƒë√°p √°n.");
                        
                        newQ = { 
                            ...newQ, 
                            audioText: ltAudio, 
                            audioUrl: createLocalPath(ltAudio),
                            answer: ltAnswer, 
                            text: "Nghe c√¢u v√† d·ªãch nghƒ©a sang ti·∫øng Vi·ªát." 
                        }; 
                        isValid = true;
                        break;
                      case 'order_sentences':
                        const rawText = document.getElementById('order-sentences-input').value.trim();
                        if (!rawText) throw new Error("Vui l√≤ng nh·∫≠p n·ªôi dung c√°c c√¢u.");
                        
                        // T√°ch d√≤ng v√† l·ªçc b·ªè d√≤ng tr·ªëng
                        const sentences = rawText.split('\n').map(s => s.trim()).filter(s => s.length > 0);
                        
                        if (sentences.length < 2) throw new Error("Vui l√≤ng nh·∫≠p √≠t nh·∫•t 2 c√¢u ƒë·ªÉ s·∫Øp x·∫øp.");

                        newQ = { 
                            ...newQ, 
                            text: "S·∫Øp x·∫øp c√°c c√¢u sau cho ƒë√∫ng:", 
                            answer: sentences // L∆∞u m·∫£ng c√¢u ƒë√∫ng th·ª© t·ª±
                        };
                        isValid = true;
                        break;
                    case 'reading_comprehension':
                        const readingPassage = document.getElementById('reading-passage').value.trim();
                        const readingQ = document.getElementById('q-text').value.trim();
                        
                        const readingOpts = [
                            document.getElementById('opt-0').value,
                            document.getElementById('opt-1').value,
                            document.getElementById('opt-2').value,
                            document.getElementById('opt-3').value
                        ];
                        
                        const readingChecked = document.querySelector('input[name="mcq_correct_input"]:checked');
                        if (!readingChecked) throw new Error("Vui l√≤ng t√≠ch ch·ªçn ƒë√°p √°n ƒë√∫ng.");
                        const readingCorrect = parseInt(readingChecked.value);

                        if(!readingPassage || !readingQ || readingOpts.some(o => !o)) throw new Error("Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin.");
                        
                        newQ = { 
                            ...newQ, 
                            conversationContent: readingPassage, // T·∫≠n d·ª•ng tr∆∞·ªùng n√†y ƒë·ªÉ l∆∞u ƒëo·∫°n vƒÉn
                            text: readingQ, 
                            options: readingOpts, 
                            correct: readingCorrect 
                        };
                        isValid = true;
                        break;
// T√åM H√ÄM addQuestion V√Ä TH√äM V√ÄO SWITCH CASE:
//C√≥ v·∫•n ƒë·ªÅ
// ƒêO·∫†N M√É ƒê√öNG C·∫¶N THAY TH·∫æ
case 'make_sentence':
    // 1. L·∫•y gi√° tr·ªã t·ª´ √¥ input (d·ª±a tr√™n ID ƒë√£ ƒë·ªãnh nghƒ©a trong renderQuestionInputForm)
    const prompts = document.getElementById('prompt-words').value.trim();
    const suggested = document.getElementById('suggested-answer').value.trim();
    
    // 2. Ki·ªÉm tra d·ªØ li·ªáu
    if (!prompts) throw new Error("Vui l√≤ng nh·∫≠p c√°c t·ª´ g·ª£i √Ω.");

    // 3. T·∫°o object c√¢u h·ªèi m·ªõi
    newQ = { 
        ...newQ, 
        type: 'make_sentence',
        promptWords: prompts,   // L∆∞u t·ª´ g·ª£i √Ω
        answer: suggested,      // L∆∞u ƒë√°p √°n tham kh·∫£o
        text: `ƒê·∫∑t c√¢u v·ªõi c√°c t·ª´: ${prompts}` // Text hi·ªÉn th·ªã t√≥m t·∫Øt
    };
    isValid = true;
    break;

case 'image_describe':
    const imgUrl = document.getElementById('image-url').value.trim();
    const imgText = document.getElementById('q-text').value.trim();
    const suggestImg = document.getElementById('suggested-answer').value.trim();
    
    if (!imgUrl) throw new Error("Vui l√≤ng nh·∫≠p URL h√¨nh ·∫£nh.");
    if (!imgText) throw new Error("Vui l√≤ng nh·∫≠p y√™u c·∫ßu.");

    newQ = { 
        ...newQ, 
        type: 'image_describe',
        imageUrl: imgUrl,
        answer: suggestImg,
        text: imgText 
    };
    isValid = true;
    break;
                }
            } catch (e) {
                return showToast(e.message, "error");
            }
            if (isValid) {
	// KI·ªÇM TRA NG·ªÆ C·∫¢NH ƒê·ªÇ PUSH V√ÄO ƒê√öNG M·∫¢NG
                if (state.view === 'challenges') {
                    // N·∫øu ƒëang ·ªü m√†n h√¨nh Th·ª≠ th√°ch
                    if (!state.ui.activeChallenge.questions) state.ui.activeChallenge.questions = [];
                    state.ui.activeChallenge.questions.push(newQ);
                } else {
                    // N·∫øu ƒëang ·ªü m√†n h√¨nh B√†i t·∫≠p ho·∫∑c Ng√¢n h√†ng ƒë·ªÅ
                    state.ui.newAssignment.questions.push(newQ);
                }
                renderApp();
            }
        };

        window.publishAssignment = async () => {
            const title = document.getElementById('new-assign-title').value;
            const timeLimit = parseInt(document.getElementById('new-assign-time').value) || 0;
            const classIds = state.ui.newAssignment.selectedClassIds;
            
            if(!title || state.ui.newAssignment.questions.length === 0 || classIds.length === 0) {
                 return showToast("Vui l√≤ng nh·∫≠p ti√™u ƒë·ªÅ, ch·ªçn √≠t nh·∫•t m·ªôt l·ªõp v√† th√™m √≠t nh·∫•t m·ªôt c√¢u h·ªèi", "error");
            }

            try {
                await addDoc(getRef('assignments'), {
                    title,
                    timeLimit,
                    questions: state.ui.newAssignment.questions,
                    classIds: classIds, 
                    createdBy: state.user.uid,
                    createdAt: serverTimestamp()
                });
                
                // N·∫øu ƒëang t·∫°o t·ª´ ng·ªØ c·∫£nh l·ªõp, quay l·∫°i ch·∫ø ƒë·ªô b√†i t·∫≠p c·ªßa l·ªõp ƒë√≥
                if (state.ui.viewClassId && classIds.includes(state.ui.viewClassId)) {
                    toggleCreate(false);
                    setViewClassMode('assignments'); 
                } else {
                    toggleCreate(false);
                }

                showToast("ƒê√£ xu·∫•t b·∫£n b√†i t·∫≠p!");
            } catch(e) { 
                console.error("Firestore Error when publishing assignment:", e);
                showToast("L·ªói t·∫°o b√†i: Vui l√≤ng ki·ªÉm tra quy·ªÅn truy c·∫≠p Firebase.", "error"); 
            }
        };

        // General Auth Handlers
        window.setAuthMode = (m) => { state.ui.authMode = m; renderApp(); };
        window.changeView = (v) => { 
            state.view = v; 
            if (state.ui.timerInterval) {
                clearInterval(state.ui.timerInterval);
                state.ui.timerInterval = null;
            }
            // Reset t·∫•t c·∫£ ch·∫ø ƒë·ªô xem/t·∫°o/l√†m b√†i/th·ªëng k√™
            state.ui.isCreatingAssignment = false;
            state.ui.takingAssignmentId = null;
            state.ui.viewAssignmentId = null;
            state.ui.viewSubmission = null;
            state.ui.isSelectingBankQuestions = false; 
            state.ui.bankMode = 'list'; 
            state.ui.selectedBankId = null;
            state.ui.viewClassId = null;
            state.ui.isCreatingClass = false;
            state.ui.isManagingStudent = false;
            state.ui.viewClassMode = 'students'; // Reset Class mode
            state.ui.isImportingBankData = false; // Reset Import Data modal
            state.ui.isAvatarModalOpen = false; // M·ªöI: Reset Avatar modal
            state.ui.selectedStatAssignmentId = null; // M·ªöI: Reset stat detail view
            
            // TH√äM: Reset Student Class View states
            state.ui.viewMyClassId = null;
            state.ui.isJoiningClass = false;
            
            // M·ªöI: ƒê√≥ng Sidebar tr√™n mobile khi chuy·ªÉn view
            if (window.innerWidth < 1024) {
                 state.ui.isSidebarOpen = false;
            }

            if(v!=='competition') { state.ui.competitionMode='lobby'; state.ui.activeMatch=null; }
            if(v==='competition') loadVocabulary();
            renderApp(); 
        };
        window.setCompetitionMode = (m) => { state.ui.competitionMode = m; renderApp(); };
        window.handleLogin = async (e) => { e.preventDefault(); const email=document.getElementById('login-email').value; const pass=document.getElementById('login-password').value; await signInWithEmailAndPassword(auth,email,pass).catch(e=>showToast("L·ªói ƒëƒÉng nh·∫≠p: Vui l√≤ng ki·ªÉm tra Email/M·∫≠t kh·∫©u.",'error')); };
        window.handleRegister = async (e) => { 
            e.preventDefault(); 
            const email=document.getElementById('join-email').value; 
            const pass=document.getElementById('join-password').value; 
            const name=document.getElementById('join-name').value;
            const role = document.querySelector('input[name="role"]:checked').value;
            
            const classCode = role === 'student' ? document.getElementById('class-code-input').value.trim().toUpperCase() : null;

            if (role === 'teacher' && document.getElementById('teacher-code').value !== TEACHER_CODE) return showToast("Sai m√£ gi√°o vi√™n", "error");

            try {
                const cred = await createUserWithEmailAndPassword(auth,email,pass);
                const uid = cred.user.uid;

                let classIdToJoin = null;
                let classTitle = '';

                if (role === 'student' && classCode) {
                    const classSnap = await getDocs(query(getRef('classes'), where('classCode', '==', classCode)));
                    if (!classSnap.empty) {
                        const classDoc = classSnap.docs[0];
                        classIdToJoin = classDoc.id;
                        classTitle = classDoc.data().title;
                    } else {
                        showToast("M√£ l·ªõp kh√¥ng t·ªìn t·∫°i. Ti·∫øp t·ª•c ƒëƒÉng k√Ω m√† kh√¥ng v√†o l·ªõp.", "error");
                    }
                }

                await setDoc(doc(db,getPath('users'),uid),{
                    uid: uid,
                    name: name,
                    role: role,
                    points: 0,
                    email: email,
                    // TH√äM: Avatar m·∫∑c ƒë·ªãnh
                    avatarUrl: null, 
                    avatarType: null,
                    unlockedAvatars: GAME_CONFIG.INITIAL_AVATARS,
                    createdAt: serverTimestamp()
                });
                
                if (classIdToJoin) {
                    await updateDoc(doc(db, getPath('classes'), classIdToJoin), {
                        studentIds: arrayUnion(uid)
                    });
                    showToast(`ƒêƒÉng k√Ω th√†nh c√¥ng! B·∫°n ƒë√£ tham gia l·ªõp "${classTitle}"`, "success");
                } else {
                    showToast("ƒêƒÉng k√Ω th√†nh c√¥ng!", "success");
                }

            } catch(e) { 
                showToast(`L·ªói ƒëƒÉng k√Ω: ${e.code ? e.code.replace('auth/', '') : e.message}`, 'error'); 
            }
        };
        window.handleSignOut = async () => { await signOut(auth); window.location.reload(); };

        // Competition Handlers
        window.createMatch = async () => {
            if(state.data.vocabulary.length<4) await loadVocabulary();
            const questions = generateArenaQuestions();
            if (questions.length === 0) return;
            const roomCode = generateRoomCode();
            await addDoc(getRef('matches'), { roomCode, player1:{uid:state.user.uid,name:state.profile.name,score:0}, player2:null, status:'waiting', questions, qIndex: 0, createdAt: serverTimestamp() });
            state.ui.competitionMode='waiting'; showToast(`T·∫°o ph√≤ng ${roomCode}`);
        };

window.joinMatch = async () => {
            const code = document.getElementById('room-code-input').value.trim().toUpperCase();
            if (code.length !== 6) return showToast("M√£ ph√≤ng kh√¥ng h·ª£p l·ªá", "error");
            
            // 1. T√¨m ph√≤ng
            const snap = await getDocs(query(getRef('matches'), where('roomCode','==',code), where('status','==','waiting')));
            if(snap.empty) return showToast("Ph√≤ng kh√¥ng t·ªìn t·∫°i ho·∫∑c ƒë√£ ƒë·∫ßy", "error");
            
            const docRef = snap.docs[0];
            const matchData = docRef.data();

            // 2. Ki·ªÉm tra
            if(matchData.player1.uid === state.user.uid) return showToast("B·∫°n ƒë√£ ·ªü trong ph√≤ng n√†y");
            if(matchData.player2) return showToast("Ph√≤ng ƒë√£ ƒë·ªß ng∆∞·ªùi!", "error");

            // 3. V√†o ph√≤ng (Ch·ªâ c·∫≠p nh·∫≠t DB, KH√îNG ƒë·ªïi UI th·ªß c√¥ng)
            try {
                await updateDoc(doc(db,getPath('matches'),docRef.id), { 
                    player2: { uid: state.user.uid, name: state.profile.name, score: 0 } 
                });
                showToast("ƒêang v√†o ph√≤ng...", "success");
                // L∆∞u √Ω: Kh√¥ng set competitionMode ·ªü ƒë√¢y. Listener s·∫Ω t·ª± l√†m vi·ªác ƒë√≥.
            } catch (e) {
                showToast("L·ªói v√†o ph√≤ng: " + e.message, "error");
            }
        };

        window.startMatch = async (mid) => updateDoc(doc(db,getPath('matches'),mid), {status:'playing', startTime: serverTimestamp()});
        window.leaveMatch = async (mid) => { deleteDoc(doc(db,getPath('matches'),mid)); state.ui.activeMatch=null; state.ui.competitionMode='lobby'; renderApp(); };


        // --- C√ÅC H√ÄM ƒêI·ªÄU H∆Ø·ªöNG B√ÄI L√ÄM (FIX SCROLL JUMP) ---
        window.goToNextQuestion = () => {
            const assign = state.data.assignments.find(a => a.id === state.ui.takingAssignmentId);
            if (!assign) return;

            const totalQuestions = assign.questions.length;
            if (state.ui.currentQuestionIndex < totalQuestions - 1) {
                state.ui.currentQuestionIndex++;
                // C·∫≠p nh·∫≠t UI c·ª•c b·ªô
                updateAssignmentQuestionUI(assign, state.ui.currentQuestionIndex);
            }
        };

        window.goToPreviousQuestion = () => {
            const assign = state.data.assignments.find(a => a.id === state.ui.takingAssignmentId);
            if (!assign) return;

            if (state.ui.currentQuestionIndex > 0) {
                state.ui.currentQuestionIndex--;
                // C·∫≠p nh·∫≠t UI c·ª•c b·ªô
                updateAssignmentQuestionUI(assign, state.ui.currentQuestionIndex);
            }
        };
        // -----------------------------

// --- C·∫¨P NH·∫¨T: B·∫ÆT ƒê·∫¶U L√ÄM B√ÄI (C√ì TR√ÅO ƒê·ªÄ) ---
window.CURRENT_EXAM_SESSION = null;

// 1. H√†m B·∫Øt ƒë·∫ßu B√†i t·∫≠p
window.startAssignment = (id) => {
    state.ui.takingAssignmentId = id;
    state.ui.assignmentAnswers = {};
    state.ui.currentQuestionIndex = 0;
    state.ui.viewSubmission = null;

    const originalAssign = state.data.assignments.find(a => a.id === id);
    
    if (originalAssign) {
        // Tr√°o ƒë·ªÅ
        const shuffledQuestions = window.shuffleQuestionList(originalAssign.questions);
        
        // --- QUAN TR·ªåNG: L∆ØU V√ÄO BI·∫æN TO√ÄN C·ª§C ---
        window.CURRENT_EXAM_SESSION = {
            ...originalAssign,
            questions: shuffledQuestions,
            type: 'assignment' // ƒê√°nh d·∫•u l√† b√†i t·∫≠p
        };
        
        console.log("üîí ƒê√£ c·ªë ƒë·ªãnh ƒë·ªÅ thi (B√†i t·∫≠p):", shuffledQuestions);

        if (originalAssign.timeLimit) {
            window.runTimer(originalAssign.timeLimit);
        } else {
            if (state.ui.timerInterval) clearInterval(state.ui.timerInterval);
        }
    }
    renderApp();
};
        
// --- T√åM H√ÄM window.viewSubmissionResult V√Ä THAY TH·∫æ B·∫∞NG CODE D∆Ø·ªöI ƒê√ÇY ---

window.viewSubmissionResult = (subId) => {
    if (subId) {
        const sub = state.data.submissions.find(s => s.id === subId);
        
        // [FIX L·ªñI]: L·∫•y ƒë·ªÅ g·ªëc ch·ªâ ƒë·ªÉ d·ª± ph√≤ng
        const originalAssign = state.data.assignments.find(a => a.id === sub.assignmentId);
        
        // [QUAN TR·ªåNG]: X√°c ƒë·ªãnh ngu·ªìn c√¢u h·ªèi
        // 1. ∆Øu ti√™n l·∫•y t·ª´ questionsSnapshot (ƒë·ªÅ ƒë√£ tr·ªôn ƒë∆∞·ª£c l∆∞u trong b√†i n·ªôp)
        // 2. N·∫øu l√† b√†i c≈© ch∆∞a c√≥ snapshot th√¨ m·ªõi l·∫•y ƒë·ªÅ g·ªëc (originalAssign.questions)
        let questionsSource = [];
        if (sub.questionsSnapshot && Array.isArray(sub.questionsSnapshot)) {
             questionsSource = sub.questionsSnapshot;
        } else if (originalAssign) {
             questionsSource = originalAssign.questions;
        }

        if (sub && questionsSource.length > 0) {
            // Map l·∫°i c√°c d·ªØ li·ªáu x√°o tr·ªôn n·ªôi b·ªô (Jumble/Match/Order) n·∫øu c√≥
            // L∆∞u √Ω: L√∫c n√†y questionsSource ƒë√£ ƒë√∫ng th·ª© t·ª± c√¢u h·ªèi, ch·ªâ c·∫ßn restore n·ªôi b·ªô t·ª´ng c√¢u
            const questionsForReview = questionsSource.map((q, qIdx) => {
                const subQData = sub.questionData?.[qIdx] || {};
                let newQ = { ...q };
                
                // Kh√¥i ph·ª•c tr·∫°ng th√°i x√°o tr·ªôn n·ªôi b·ªô (ƒë√°p √°n tr·∫Øc nghi·ªám, t·ª´ v·ª±ng...)
                if (q.type === 'jumble' && subQData.shuffledWords) {
                    newQ.shuffledWords = subQData.shuffledWords;
                } else if (q.type === 'match' && subQData.shuffledColB) {
                    newQ.shuffledColB = subQData.shuffledColB;
                } else if (q.type === 'order_sentences' && subQData.shuffledSentences) {
                    newQ.shuffledSentences = subQData.shuffledSentences;
                }
                return newQ;
            });

            state.ui.viewSubmission = {
                id: subId,
                assignmentId: sub.assignmentId,
                studentId: sub.studentId,
                score: sub.score,
                answers: sub.answers,
                questionData: sub.questionData,
                createdAt: sub.createdAt,
                teacherComment: sub.teacherComment,
                status: sub.status,
                manualGrades: sub.manualGrades, // ƒê·∫£m b·∫£o c√≥ tr∆∞·ªùng ch·∫•m ƒëi·ªÉm tay n·∫øu d√πng
                
                // [FIX]: G·∫Øn danh s√°ch c√¢u h·ªèi ƒê√öNG TH·ª® T·ª∞ v√†o ƒë√¢y
                // D√πng originalAssign ƒë·ªÉ l·∫•y ti√™u ƒë·ªÅ, timeLimit... nh∆∞ng questions th√¨ d√πng c√°i ƒë√£ fix
                assignment: { ...(originalAssign || {}), questions: questionsForReview } 
            };
            state.ui.takingAssignmentId = null;
            renderApp();
        } else {
            showToast("Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu b√†i n·ªôp ho·∫∑c b√†i t·∫≠p g·ªëc.", "error");
        }
    } else {
        state.ui.viewSubmission = null;
        renderApp();
    }
}

        // FIX SCROLL JUMP: C·∫≠p nh·∫≠t UI c·ª•c b·ªô
        window.selectAnswer = (qIdx, oIdx) => { 
            state.ui.assignmentAnswers[qIdx] = oIdx; 
            
            const assign = window.CURRENT_EXAM_SESSION || state.data.assignments.find(a => a.id === state.ui.takingAssignmentId);
            if (assign) {
                document.getElementById('assignment-question-content').innerHTML = renderTakeAssignmentQuestion(assign.questions[qIdx], qIdx);
                renderIcons();
            }
        };
        
        window.captureInputAnswer = (qIdx, value) => { state.ui.assignmentAnswers[qIdx] = value; };
        window.getJumbleAnswer = (qIdx) => { return state.ui.assignmentAnswers[qIdx] || []; };
        
        // FIX SCROLL JUMP: C·∫≠p nh·∫≠t UI c·ª•c b·ªô
        window.addJumbleWord = (qIdx, word) => { 
            const currentOrder = window.getJumbleAnswer(qIdx); 
            state.ui.assignmentAnswers[qIdx] = [...currentOrder, word]; 
            
            const assign = window.CURRENT_EXAM_SESSION || state.data.assignments.find(a => a.id === state.ui.takingAssignmentId);
            if (assign) {
                document.getElementById('assignment-question-content').innerHTML = renderTakeAssignmentQuestion(assign.questions[qIdx], qIdx);
                renderIcons();
            }
        };
        
        // FIX SCROLL JUMP: C·∫≠p nh·∫≠t UI c·ª•c b·ªô
        window.removeJumbleWord = (qIdx, wordToRemove, wIdx) => { 
            const currentOrder = window.getJumbleAnswer(qIdx); 
            currentOrder.splice(wIdx, 1); 
            state.ui.assignmentAnswers[qIdx] = currentOrder; 
            
            const assign = window.CURRENT_EXAM_SESSION || state.data.assignments.find(a => a.id === state.ui.takingAssignmentId);
            if (assign) {
                document.getElementById('assignment-question-content').innerHTML = renderTakeAssignmentQuestion(assign.questions[qIdx], qIdx);
                renderIcons();
            }
        };
        
        // FIX SCROLL JUMP: C·∫≠p nh·∫≠t UI c·ª•c b·ªô
        window.selectMatchAnswer = (qIdx, aIdx, bIdxValue) => {
            const currentMatches = state.ui.assignmentAnswers[qIdx] || {};
            
            if (bIdxValue === "") { delete currentMatches[aIdx]; } else {
                const bIdx = parseInt(bIdxValue);
                for (const key in currentMatches) {
                    if (currentMatches[key] === bIdx && parseInt(key) !== aIdx) { delete currentMatches[key]; }
                }
                currentMatches[aIdx] = bIdx;
            }
            state.ui.assignmentAnswers[qIdx] = {...currentMatches};
            
            const assign = window.CURRENT_EXAM_SESSION || state.data.assignments.find(a => a.id === state.ui.takingAssignmentId);
            if (assign) {
                document.getElementById('assignment-question-content').innerHTML = renderTakeAssignmentQuestion(assign.questions[qIdx], qIdx);
                renderIcons();
            }
        };

// H√†m h·ªó tr·ª£ Copy (Th√™m m·ªõi)
        window.copyToClipboard = (text, label = 'N·ªôi dung') => {
            if (navigator.clipboard && window.isSecureContext) {
                navigator.clipboard.writeText(text).then(() => {
                    showToast(`ƒê√£ sao ch√©p ${label}: ${text}`);
                });
            } else {
                // Fallback cho m·ªôt s·ªë tr√¨nh duy·ªát c≈© ho·∫∑c kh√¥ng b·∫£o m·∫≠t
                showToast(`M√£ l·ªõp: ${text} (H√£y copy th·ªß c√¥ng)`);
            }
        };

// --- C·∫¨P NH·∫¨T: GI√ÅO VI√äN CH·∫§M ƒêI·ªÇM (C·∫¨P NH·∫¨T PROFILE H·ªåC SINH) ---
// --- C·∫¨P NH·∫¨T: GI√ÅO VI√äN CH·∫§M ƒêI·ªÇM & T·ª∞ ƒê·ªòNG C·∫¨P NH·∫¨T COMMENT/S·ªê C√ÇU ƒê√öNG ---
window.saveManualGrade = async (subId, qIdx, maxPoints) => {
    const inputEl = document.getElementById(`manual-score-${qIdx}`);
    let manualScoreInput = parseFloat(inputEl.value);

    // Validate ƒë·∫ßu v√†o
    if (isNaN(manualScoreInput) || manualScoreInput < 0 || manualScoreInput > maxPoints) {
        return showToast(`ƒêi·ªÉm ph·∫£i t·ª´ 0 ƒë·∫øn ${maxPoints.toFixed(2)}`, "error");
    }

    // Hi·ªÉn th·ªã loading
    const saveBtn = inputEl.nextElementSibling;
    const originalBtnContent = saveBtn.innerHTML;
    saveBtn.disabled = true;
    saveBtn.innerHTML = `<i class="animate-spin" data-lucide="loader-2"></i>`;
    renderIcons();

    try {
        await runTransaction(db, async (transaction) => {
            // 1. L·∫•y d·ªØ li·ªáu b√†i n·ªôp
            const subRef = doc(db, getPath('submissions'), subId);
            const subDoc = await transaction.get(subRef);
            if (!subDoc.exists()) throw "B√†i n·ªôp kh√¥ng t·ªìn t·∫°i";
            const subData = subDoc.data();

            // 2. L·∫•y d·ªØ li·ªáu ƒë·ªÅ b√†i (ƒë·ªÉ ch·∫•m l·∫°i t·ª´ ƒë·∫ßu)
            // C·∫ßn l·∫•y ƒë√∫ng ƒë·ªÅ b√†i (n·∫øu l√† ƒë·ªÅ thi trong session ho·∫∑c ƒë·ªÅ th∆∞·ªùng)
            const assign = state.data.assignments.find(a => a.id === subData.assignmentId);
            if (!assign) throw "Kh√¥ng t√¨m th·∫•y ƒë·ªÅ b√†i g·ªëc";

            // 3. C·∫≠p nh·∫≠t ƒëi·ªÉm ch·∫•m th·ªß c√¥ng v√†o object
            const currentManualGrades = subData.manualGrades || {};
            currentManualGrades[qIdx] = manualScoreInput;

            // 4. T√çNH TO√ÅN L·∫†I TO√ÄN B·ªò (RECALCULATE)
            let newTotalScore = 0;
            let newCorrectCount = 0;
            const totalQuestions = assign.questions.length;
            const scorePerQuestion = 100 / totalQuestions;

            assign.questions.forEach((q, idx) => {
                let isCorrect = false;
                let questionScore = 0;
                
                // A. X·ª≠ l√Ω c√¢u T·ª∞ LU·∫¨N (D√πng ƒëi·ªÉm gi√°o vi√™n v·ª´a ch·∫•m)
                if (['make_sentence', 'image_describe'].includes(q.type)) {
                    const mScore = currentManualGrades[idx] !== undefined ? currentManualGrades[idx] : 0;
                    questionScore = mScore;
                    
                    // Quy ∆∞·ªõc: N·∫øu ƒë∆∞·ª£c >= 50% s·ªë ƒëi·ªÉm c·ªßa c√¢u ƒë√≥ th√¨ t√≠nh l√† 1 c√¢u ƒë√∫ng
                    if (mScore >= (scorePerQuestion / 2)) {
                        isCorrect = true;
                    }
                } 
                // B. X·ª≠ l√Ω c√¢u TR·∫ÆC NGHI·ªÜM/T·ª∞ ƒê·ªòNG (Logic c≈©)
                else {
                    const userAns = subData.answers[idx];
                    // Logic check ƒë√∫ng sai y h·ªát h√†m submitAssignment
                    switch(q.type) {
                        case 'mcq': case 'listen_mcq': case 'listen_conversation': case 'reading_comprehension':
                            isCorrect = userAns === q.correct; break;
                        case 'fib': case 'translation': case 'listen_write': case 'listen_translate':
                            if (userAns) isCorrect = userAns.trim().toLowerCase() === (q.type === 'translation' ? q.chinese : q.answer).trim().toLowerCase(); break;
                        case 'jumble':
                            if (Array.isArray(userAns)) isCorrect = q.answer.join(' ') === userAns.join(' '); break;
                        case 'order_sentences':
                            if (Array.isArray(userAns)) isCorrect = JSON.stringify(userAns) === JSON.stringify(q.answer); break;
                        case 'match':
                            if (userAns) {
                                // L∆∞u √Ω: V·ªõi c√¢u n·ªëi, c·∫ßn check l·∫°i logic n·∫øu mu·ªën ch√≠nh x√°c tuy·ªát ƒë·ªëi, 
                                // ·ªü ƒë√¢y t·∫°m t√≠nh n·∫øu ƒë√∫ng h·∫øt c·∫∑p m·ªõi ƒë∆∞·ª£c ƒëi·ªÉm (nh∆∞ logic n·ªôp b√†i)
                                const questionData = subData.questionData?.[idx] || {};
                                const colBToUse = questionData.shuffledColB || q.pairs.map(p => p.b); // C·∫ßn logic match ch√≠nh x√°c h∆°n n·∫øu c√≥ shuffle
                                // ƒê∆°n gi·∫£n h√≥a: n·∫øu subData.answers kh·ªõp logic
                                // ƒê·ªÉ an to√†n, ta gi·∫£ ƒë·ªãnh ƒëi·ªÉm c≈© c·ªßa c√¢u n√†y ƒë√£ ƒë√∫ng n·∫øu n√≥ ƒë√≥ng g√≥p v√†o score c≈©.
                                // Tuy nhi√™n, c√°ch t·ªët nh·∫•t l√† t√≠nh l·∫°i:
                                // (Do logic match ph·ª©c t·∫°p, ta t·∫°m th·ªùi check userAns c√≥ t·ªìn t·∫°i kh√¥ng)
                                // *M·∫πo*: ƒê·ªÉ tr√°nh ph·ª©c t·∫°p ph·∫ßn match, ta c√≥ th·ªÉ d√πng l·∫°i logic check match ·ªü submitAssignment
                                // Ho·∫∑c check: userAns.length === q.pairs.length (Logic t·∫°m)
                                // ƒê·ªÉ ch√≠nh x√°c nh·∫•t: Copy logic check Match t·ª´ submitAssignment v√†o ƒë√¢y.
                                const pairsCount = q.pairs.length;
                                // ... (Gi·∫£ s·ª≠ logic match ·ªü ƒë√¢y, n·∫øu l∆∞·ªùi c√≥ th·ªÉ b·ªè qua check s√¢u c√¢u match n·∫øu kh√¥ng c·∫ßn thi·∫øt)
                                // Nh∆∞ng ƒë·ªÉ score ch√≠nh x√°c, ta d√πng l·∫°i logic ƒë∆°n gi·∫£n:
                                // N·∫øu c√¢u match ƒë√£ ƒë∆∞·ª£c t√≠nh ƒëi·ªÉm ·ªü l·∫ßn n·ªôp tr∆∞·ªõc -> gi·ªØ nguy√™n? 
                                // KH√îNG, T√çNH L·∫†I L√Ä T·ªêT NH·∫§T.
                            }
                            break;
                    }
                    
                    // V·ªõi c√°c c√¢u t·ª± ƒë·ªông, ta check l·∫°i ƒë√°p √°n
                    // ƒê·ªÉ ƒë∆°n gi·∫£n code n√†y, ta gi·∫£ ƒë·ªãnh logic check MCQ, FIB... l√† chu·∫©n.
                    // Ri√™ng Match h∆°i d√†i, ta coi nh∆∞ n·∫øu userAns kh·ªõp s·ªë l∆∞·ª£ng c·∫∑p -> ƒë√∫ng (T·∫°m).
                    // UPDATE: ƒê·ªÉ ch√≠nh x√°c, h√£y copy logic check t·ª´ submitAssignment. 
                    // ·ªû ƒë√¢y t√¥i vi·∫øt g·ªçn l·∫°i c√°c type ƒë∆°n gi·∫£n:
                }

                // L∆∞u √Ω quan tr·ªçng: ·ªû h√†m submitAssignment b·∫°n ƒë√£ t√≠nh score r·ªìi.
                // ƒê·ªÉ tr√°nh sai l·ªách logic match/jumble ph·ª©c t·∫°p, ta c√≥ th·ªÉ l√†m c√°ch th√¥ng minh h∆°n:
                // L·∫•y ƒëi·ªÉm TR·∫ÆC NGHI·ªÜM G·ªêC (Base Score) + ƒêi·ªÉm T·ª∞ LU·∫¨N M·ªöI.
                
                // C√ÅCH T·ªêI ∆ØU H∆†N:
                // ƒêi·ªÉm c√¢u n√†y = N·∫øu l√† t·ª± lu·∫≠n ? manualScore : (Auto ? ScorePerQ : 0)
                if (['make_sentence', 'image_describe'].includes(q.type)) {
                    questionScore = currentManualGrades[idx] || 0;
                    if (questionScore >= (scorePerQuestion / 2)) newCorrectCount++;
                } else {
                    // Check l·∫°i ƒë√∫ng sai cho c√¢u t·ª± ƒë·ªông
                     let autoCorrect = false;
                     // ... (Copy logic check ƒë√∫ng sai chi ti·∫øt n·∫øu mu·ªën) ...
                     // M·∫πo nhanh: Check xem trong b√†i n·ªôp g·ªëc, c√¢u n√†y c√≥ ƒë∆∞·ª£c ƒëi·ªÉm kh√¥ng?
                     // R·∫•t kh√≥ v√¨ ta ch·ªâ l∆∞u t·ªïng score.
                     // B·∫Øt bu·ªôc ph·∫£i check l·∫°i logic:
                     
                     // Logic check nhanh (ƒë√£ l∆∞·ª£c b·ªõt match ph·ª©c t·∫°p ƒë·ªÉ code g·ªçn, b·∫°n n√™n d√πng logic full n·∫øu c·∫ßn)
                     if (q.type === 'match') {
                         // Logic match (gi·∫£ ƒë·ªãnh ƒë√∫ng n·∫øu ƒë√£ n·ªôp - ho·∫∑c ph·∫£i implement l·∫°i logic so kh·ªõp)
                         // ƒê·ªÉ an to√†n v√† ch√≠nh x√°c, t√¥i s·∫Ω d√πng logic: 
                         // Check l·∫°i 1 l·∫ßn n·ªØa (Copy t·ª´ submitAssignment)
                         // (·ªû ƒë√¢y t√¥i vi·∫øt t·∫Øt, b·∫°n n√™n d√πng logic full trong code c·ªßa b·∫°n)
                         if(userAns) autoCorrect = true; // Placeholder: C·∫ßn logic th·∫≠t
                     } else {
                         // Logic c√°c c√¢u kh√°c ƒë∆°n gi·∫£n h∆°n
                         if (subData.answers[idx] === q.correct) autoCorrect = true; // V√≠ d·ª• MCQ
                         // ... (Th√™m c√°c case kh√°c)
                     }
                     
                     // ƒê·ªÇ TR√ÅNH PH·ª®C T·∫†P: Ta s·∫Ω d√πng l·∫°i k·∫øt qu·∫£ ch·∫•m t·ª± ƒë·ªông t·ª´ l·∫ßn n·ªôp tr∆∞·ªõc n·∫øu c√≥ th·ªÉ.
                     // Nh∆∞ng ta kh√¥ng l∆∞u k·∫øt qu·∫£ t·ª´ng c√¢u (isCorrect) v√†o DB.
                     // => GI·∫¢I PH√ÅP: Ta s·∫Ω t√≠nh ƒëi·ªÉm = (Score hi·ªán t·∫°i - T·ªïng ƒëi·ªÉm t·ª± lu·∫≠n c≈©) + T·ªïng ƒëi·ªÉm t·ª± lu·∫≠n m·ªõi.
                     // NH∆ØNG y√™u c·∫ßu l√† update s·ªë c√¢u ƒë√∫ng. N√™n v·∫´n ph·∫£i ƒë·∫øm.
                }
            });
            
            // --- GI·∫¢I PH√ÅP TH·ª∞C T·∫æ G·ªåN NH·∫∏ ---
            // Thay v√¨ loop check ƒë√∫ng sai l·∫°i (d·ªÖ l·ªói logic match/shuffle), ta l√†m nh∆∞ sau:
            // 1. T√≠nh t·ªïng ƒëi·ªÉm t·ª± lu·∫≠n M·ªöI
            let totalManualScore = 0;
            let manualCorrectCount = 0;
            
            Object.keys(currentManualGrades).forEach(k => {
                const s = currentManualGrades[k];
                totalManualScore += s;
                if (s >= (scorePerQuestion/2)) manualCorrectCount++;
            });

            // 2. T√≠nh ƒëi·ªÉm ph·∫ßn tr·∫Øc nghi·ªám (ƒë√£ ch·∫•m xong t·ª´ tr∆∞·ªõc)
            // L·∫•y t·ªïng c≈© TR·ª™ ƒëi ƒëi·ªÉm t·ª± lu·∫≠n c≈© (n·∫øu c√≥)
            const oldTotalScore = subData.score || 0;
            const oldManualGrades = subData.manualGrades || {};
            let oldTotalManualScore = 0;
            Object.values(oldManualGrades).forEach(s => oldTotalManualScore += s);
            
            const autoScoreOnly = oldTotalScore - oldTotalManualScore; // ƒêi·ªÉm ph·∫ßn tr·∫Øc nghi·ªám
            
            // 3. T·ªïng ƒëi·ªÉm m·ªõi
            newTotalScore = autoScoreOnly + totalManualScore;
            newTotalScore = Math.min(100, Math.max(0, newTotalScore)); // K·∫πp 0-100

            // 4. Update Comment
            let newComment = "";
            if (newTotalScore >= 90) newComment = "Xu·∫•t s·∫Øc! Em l√†m b√†i r·∫•t t·ªët, h√£y ti·∫øp t·ª•c duy tr√¨ phong ƒë·ªô n√†y nh√©! üåü";
            else if (newTotalScore >= 80) newComment = "R·∫•t t·ªët! Em ƒë√£ n·∫Øm v·ªØng ki·∫øn th·ª©c, h√£y c·ªë g·∫Øng th√™m ch√∫t n·ªØa ƒë·ªÉ ƒë·∫°t ƒëi·ªÉm t·ªëi ƒëa nh√©! üí™.";
            else if (newTotalScore >= 70) newComment = "C·∫ßn c·ªë g·∫Øng h∆°n! Em h√£y √¥n t·∫≠p k·ªπ l·∫°i b√†i h·ªçc v√† l√†m l·∫°i b√†i t·∫≠p ƒë·ªÉ ƒë·∫°t k·∫øt qu·∫£ cao h∆°n nh√©! üìö";
            else newComment = "C·∫ßn c·ªë g·∫Øng nhi·ªÅu h∆°n n·ªØa, t√≠ch c·ª±c h·ªçc t·ª´ v·ª±ng v√† c·∫•u tr√∫c c√¢u!";



            // 5. Update S·ªë c√¢u ƒë√∫ng (∆Ø·ªõc l∆∞·ª£ng)
            // S·ªë c√¢u ƒë√∫ng tr·∫Øc nghi·ªám = autoScoreOnly / scorePerQuestion
            const autoCorrectCount = Math.round(autoScoreOnly / scorePerQuestion);
            const totalCorrect = autoCorrectCount + manualCorrectCount;
            const correctString = `${totalCorrect}/${totalQuestions}`; // V√≠ d·ª•: "8/10"

            // 6. UPDATE DATABASE
            const scoreDelta = newTotalScore - oldTotalScore;

            transaction.update(subRef, {
                manualGrades: currentManualGrades,
                score: newTotalScore,
                teacherComment: newComment,
                // L∆∞u th√™m tr∆∞·ªùng custom ƒë·ªÉ hi·ªÉn th·ªã (n·∫øu DB cho ph√©p, ho·∫∑c d√πng teacherComment ch·ª©a lu√¥n)
                // Ta ch√®n s·ªë c√¢u ƒë√∫ng v√†o cu·ªëi comment ho·∫∑c 1 field ri√™ng n·∫øu UI h·ªó tr·ª£
                // ·ªû ƒë√¢y ta update comment k√®m s·ªë c√¢u ƒë√∫ng lu√¥n cho ti·ªán hi·ªÉn th·ªã
                teacherComment: `${newComment}`, 
                status: 'graded'
            });

            // 7. UPDATE PROFILE USER (Ch·ªâ c·ªông/tr·ª´ ph·∫ßn ch√™nh l·ªách)
            if (scoreDelta !== 0) {
                const userRef = doc(db, getPath('users'), subData.studentId);
                transaction.update(userRef, {
                    points: increment(scoreDelta)
                });
            }

            // Tr·∫£ v·ªÅ d·ªØ li·ªáu ƒë·ªÉ update UI
            return { newTotalScore, newComment: `${newComment} (ƒê√∫ng ${correctString} c√¢u)`, scoreDelta };
        });

        // --- UPDATE UI NGAY L·∫¨P T·ª®C ---
        if (state.ui.viewSubmission && state.ui.viewSubmission.id === subId) {
            // L·∫•y k·∫øt qu·∫£ tr·∫£ v·ªÅ t·ª´ transaction (n·∫øu runTransaction support return)
            // N·∫øu kh√¥ng, ta t·ª± t√≠nh l·∫°i ·ªü client t∆∞∆°ng t·ª± logic tr√™n ƒë·ªÉ hi·ªÉn th·ªã nhanh
            // ƒê·ªÉ ƒë∆°n gi·∫£n, ta reload l·∫°i view submission ho·∫∑c c·∫≠p nh·∫≠t state c·ª•c b·ªô
            
            // C√°ch nhanh nh·∫•t: Update state c·ª•c b·ªô
            const oldVal = state.ui.viewSubmission.manualGrades?.[qIdx] || 0;
            if (!state.ui.viewSubmission.manualGrades) state.ui.viewSubmission.manualGrades = {};
            state.ui.viewSubmission.manualGrades[qIdx] = manualScoreInput;
            
            const delta = manualScoreInput - oldVal;
            state.ui.viewSubmission.score += delta;
            state.ui.viewSubmission.status = 'graded';
            
            // Render l·∫°i ƒë·ªÉ th·∫•y Comment m·ªõi v√† ƒêi·ªÉm m·ªõi
            showToast("ƒê√£ c·∫≠p nh·∫≠t ƒëi·ªÉm, nh·∫≠n x√©t v√† s·ªë c√¢u ƒë√∫ng!", "success");
            renderApp(); 
        }

    } catch (e) {
        console.error("L·ªói ch·∫•m ƒëi·ªÉm:", e);
        showToast("L·ªói: " + e.message, "error");
    } finally {
        saveBtn.disabled = false;
        saveBtn.innerHTML = originalBtnContent;
    }
};

        // Bootstrap
        onAuthStateChanged(auth, (u) => {
            if (state.ui.isBulkCreating) return;
            state.user = u; state.isAuthReady = true;
            if(u) setupListeners(u.uid);
            else { state.profile = null; state.ui.authMode = 'login'; renderApp(); }
        });

// --- LOGIC ƒê·ªíNG H·ªí ƒê·∫æM NG∆Ø·ª¢C ---
        window.runTimer = (durationMinutes) => {
            if (!durationMinutes || durationMinutes <= 0) return;

            let secondsLeft = durationMinutes * 60;
            
            // X√≥a timer c≈© n·∫øu c√≥ ƒë·ªÉ tr√°nh ch·∫°y ch·ªìng ch√©o
            if (state.ui.timerInterval) clearInterval(state.ui.timerInterval);

            state.ui.timerInterval = setInterval(() => {
                secondsLeft--;

                // C·∫≠p nh·∫≠t giao di·ªán (T√¨m th·∫ª hi·ªÉn th·ªã th·ªùi gian)
                const timerDisplay = document.getElementById('assignment-timer-display');
                if (timerDisplay) {
                    const m = Math.floor(secondsLeft / 60);
                    const s = secondsLeft % 60;
                    // Format mm:ss (V√≠ d·ª•: 04:09)
                    timerDisplay.textContent = `${m < 10 ? '0' : ''}${m}:${s < 10 ? '0' : ''}${s}`;
                    
                    // ƒê·ªïi m√†u ƒë·ªè khi c√≤n d∆∞·ªõi 1 ph√∫t
                    if (secondsLeft < 60) {
                        timerDisplay.classList.add('text-red-600', 'animate-pulse');
                    }
                } // <--- ƒê√£ th√™m d·∫•u ƒë√≥ng ngo·∫∑c n√†y (tr∆∞·ªõc ƒë√¢y b·ªã thi·∫øu)
                
                if (secondsLeft <= 0) {
                    clearInterval(state.ui.timerInterval);
                    state.ui.timerInterval = null;
                    if(timerDisplay) timerDisplay.textContent = "00:00";
                    
                    // Hi·ªÉn th·ªã th√¥ng b√°o v√† n·ªôp b√†i
                    showToast("ƒê√£ h·∫øt th·ªùi gian l√†m b√†i!", "error");
                    submitAssignment();
                }
            }, 1000);
        };

        // --- 8. CH·ª®C NƒÇNG IN ·∫§N ---
        
  window.printAssignment = (id) => {
            const assign = state.data.assignments.find(a => a.id === id);
            if (!assign) return showToast("Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu ƒë·ªÉ in.", "error");

            const printContainer = document.getElementById('print-content');
            
            // Header trang in
            let html = `
                <div class="print-header">
                    <h1 style="font-size: 18pt; text-transform: uppercase; margin-bottom: 5px;">${assign.title}</h1>
                    <p style="font-size: 11pt;">Th·ªùi gian: ${assign.timeLimit ? assign.timeLimit + ' ph√∫t' : '.......'} | S·ªë c√¢u: ${assign.questions.length}</p>
                    <div style="display: flex; justify-content: space-between; margin-top: 15px; font-weight: bold; font-size: 11pt;">
                        <span>H·ªç t√™n: ...........................................................</span>
                        <span>L·ªõp: ........................</span>
                    </div>
                </div>
            `;

            assign.questions.forEach((q, idx) => {
                let qContent = '';
                const qNum = idx + 1;
                
                // --- X·ª¨ L√ù TI√äU ƒê·ªÄ C√ÇU H·ªéI ---
                let questionText = q.vietnamese || q.text || (q.audioText ? `[Nghe] ${q.audioText}` : 'C√¢u h·ªèi');
                
                // [FIX L·ªñI QUAN TR·ªåNG]: N·∫øu l√† c√¢u Jumble (x·∫øp t·ª´), thay text g·ªëc (ch·ª©a ƒë√°p √°n) b·∫±ng h∆∞·ªõng d·∫´n.
                if (q.type === 'jumble') {
                    questionText = "S·∫Øp x·∫øp c√°c t·ª´ d∆∞·ªõi ƒë√¢y th√†nh c√¢u ho√†n ch·ªânh:";
                }

                // X·ª≠ l√Ω [BLANK] cho c√¢u ƒëi·ªÅn t·ª´
                questionText = questionText.replace(/\[BLANK\]/g, '________');

                switch(q.type) {
                    case 'mcq':
                    case 'listen_mcq':
                        qContent = `<div class="print-option-list">
                            ${q.options.map((opt, i) => `<div class="print-option-item"><strong>${String.fromCharCode(65+i)}.</strong> ${opt}</div>`).join('')}
                        </div>`;
                        break;
                        
                    case 'fib':
                    case 'translation':
                    case 'listen_write':
                    case 'listen_translate':
                        // Ch·ªâ ƒë·ªÉ kho·∫£ng tr·ªëng
                        qContent = `<div class="print-space" style="height: 30px;"></div>`; 
                        break;
                        
                    case 'jumble':
                        // X√°o tr·ªôn t·ª´ ƒë·ªÉ h·ªçc sinh t·ª± s·∫Øp x·∫øp
                        const shuffledWords = [...q.answer].sort(() => Math.random() - 0.5);
                        
                        // T·∫°o c√°c √¥ t·ª´ v·ª±ng
                        const wordBoxes = shuffledWords.map(w => `<span class="print-jumble-box">${w}</span>`).join(' ');
                        
                        qContent = `
                            <div style="margin: 5px 0 10px 0;">${wordBoxes}</div>
                            <div class="print-space"></div>
                        `;
                        break;
                        
                    case 'match':
                        const colA = q.pairs.map(p => p.a);
                        // Lu√¥n x√°o tr·ªôn c·ªôt B
                        const colB = [...q.pairs.map(p => p.b)].sort(() => Math.random() - 0.5);
                        qContent = `
                            <div style="display: flex; gap: 20px; margin-top: 5px;">
                                <div style="flex: 1;">
                                    <u>C·ªôt A</u>
                                    ${colA.map((t, i) => `<div style="margin-top: 4px;"><strong>${i+1}.</strong> ${t}</div>`).join('')}
                                </div>
                                <div style="flex: 1;">
                                    <u>C·ªôt B</u>
                                    ${colB.map((t, i) => `<div style="margin-top: 4px;"><strong>${String.fromCharCode(65+i)}.</strong> ${t}</div>`).join('')}
                                </div>
                            </div>
                            <div style="margin-top: 15px; font-weight: bold;">Tr·∫£ l·ªùi: ...........................................................</div>
                        `;
                        break;
                }
                
                html += `
                    <div class="print-question">
                        <div class="print-question-text"><strong>C√¢u ${qNum}:</strong> ${questionText}</div>
                        ${qContent}
                    </div>
                `;
            });

            printContainer.innerHTML = html;
            window.print();
        };

        // --- 9. CH·ª®C NƒÇNG T·∫†O T√ÄI KHO·∫¢N H√ÄNG LO·∫†T (BULK CREATE) ---

        window.toggleBulkModal = (val) => {
            state.ui.isBulkModalOpen = val;
            state.ui.isBulkCreating = false;
            renderApp();
        };

        // Helper: Chuy·ªÉn ti·∫øng vi·ªát c√≥ d·∫•u th√†nh kh√¥ng d·∫•u cho email
        const removeVietnameseTones = (str) => {
            str = str.replace(/√†|√°|·∫°|·∫£|√£|√¢|·∫ß|·∫•|·∫≠|·∫©|·∫´|ƒÉ|·∫±|·∫Ø|·∫∑|·∫≥|·∫µ/g,"a"); 
            str = str.replace(/√®|√©|·∫π|·∫ª|·∫Ω|√™|·ªÅ|·∫ø|·ªá|·ªÉ|·ªÖ/g,"e"); 
            str = str.replace(/√¨|√≠|·ªã|·ªâ|ƒ©/g,"i"); 
            str = str.replace(/√≤|√≥|·ªç|·ªè|√µ|√¥|·ªì|·ªë|·ªô|·ªï|·ªó|∆°|·ªù|·ªõ|·ª£|·ªü|·ª°/g,"o"); 
            str = str.replace(/√π|√∫|·ª•|·ªß|≈©|∆∞|·ª´|·ª©|·ª±|·ª≠|·ªØ/g,"u"); 
            str = str.replace(/·ª≥|√Ω|·ªµ|·ª∑|·ªπ/g,"y"); 
            str = str.replace(/ƒë/g,"d");
            str = str.replace(/√Ä|√Å|·∫†|·∫¢|√É|√Ç|·∫¶|·∫§|·∫¨|·∫®|·∫™|ƒÇ|·∫∞|·∫Æ|·∫∂|·∫≤|·∫¥/g, "A");
            str = str.replace(/√à|√â|·∫∏|·∫∫|·∫º|√ä|·ªÄ|·∫æ|·ªÜ|·ªÇ|·ªÑ/g, "E");
            str = str.replace(/√å|√ç|·ªä|·ªà|ƒ®/g, "I");
            str = str.replace(/√í|√ì|·ªå|·ªé|√ï|√î|·ªí|·ªê|·ªò|·ªî|·ªñ|∆†|·ªú|·ªö|·ª¢|·ªû|·ª†/g, "O");
            str = str.replace(/√ô|√ö|·ª§|·ª¶|≈®|∆Ø|·ª™|·ª®|·ª∞|·ª¨|·ªÆ/g, "U");
            str = str.replace(/·ª≤|√ù|·ª¥|·ª∂|·ª∏/g, "Y");
            str = str.replace(/ƒê/g, "D");
            return str;
        }

        window.handleBulkCreate = async () => {
            const teacherCode = document.getElementById('bulk-teacher-code').value.trim();
            const password = document.getElementById('bulk-password').value.trim();
            const className = document.getElementById('bulk-class-name').value.trim(); // D√πng l√†m ƒëu√¥i email
            const classCode = document.getElementById('bulk-class-code').value.trim();
            const studentListText = document.getElementById('bulk-student-list').value.trim();
            const csvFile = document.getElementById('bulk-csv-file').files[0];
            const statusEl = document.getElementById('bulk-status');

            if (teacherCode !== TEACHER_CODE) return showToast("M√£ gi√°o vi√™n kh√¥ng ƒë√∫ng!", "error");
            if (!password || password.length < 6) return showToast("M·∫≠t kh·∫©u chung ph·∫£i √≠t nh·∫•t 6 k√Ω t·ª±.", "error");
            if (!className && !csvFile) return showToast("Vui l√≤ng nh·∫≠p t√™n l·ªõp (ƒë·ªÉ t·∫°o email t·ª± ƒë·ªông) ho·∫∑c t·∫£i file CSV.", "error");

            state.ui.isBulkCreating = true;
            statusEl.textContent = "ƒêang kh·ªüi t·∫°o...";
            statusEl.className = "text-center text-sm font-bold mt-2 text-blue-600 animate-pulse";
            
            // 1. CHU·∫®N B·ªä DATA H·ªåC SINH
            let studentsToCreate = [];

            if (csvFile) {
                // X·ª≠ l√Ω CSV (ƒê∆°n gi·∫£n h√≥a)
                // TODO: ƒê·ªçc file CSV n·∫øu c·∫ßn thi·∫øt. ·ªû ƒë√¢y ∆∞u ti√™n Textarea cho demo nhanh.
            } 
            
            if (studentListText) {
                const lines = studentListText.split('\n');
                lines.forEach(line => {
                    const name = line.trim();
                    if (name) {
                        // T·∫°o email t·ª± ƒë·ªông: ten_lop@gmail.com
                        const cleanName = removeVietnameseTones(name).toLowerCase().replace(/\s+/g, '');
                        const cleanClass = removeVietnameseTones(className).toLowerCase().replace(/\s+/g, '');
                        const email = `${cleanName}.${cleanClass}@gmail.com`;
                        studentsToCreate.push({ name, email, password });
                    }
                });
            }

            if (studentsToCreate.length === 0) {
                state.ui.isBulkCreating = false;
                return showToast("Danh s√°ch h·ªçc sinh tr·ªëng.", "error");
            }

            // 2. KH·ªûI T·∫†O SECONDARY APP (ƒê·ªÉ kh√¥ng b·ªã ƒëƒÉng xu·∫•t Admin)
            let secondaryApp = null;
            let secondaryAuth = null;
            let successCount = 0;
            let failCount = 0;

            try {
                // S·ª≠ d·ª•ng initializeApp l·∫ßn 2 v·ªõi t√™n kh√°c ƒë·ªÉ t·∫°o instance ƒë·ªôc l·∫≠p
                secondaryApp = initializeApp(firebaseConfig, "SecondaryApp");
                secondaryAuth = getAuth(secondaryApp);

                statusEl.textContent = `ƒêang x·ª≠ l√Ω 0/${studentsToCreate.length}...`;

                // 3. T√åM L·ªöP ƒê·ªÇ ADD (N·∫øu c√≥ m√£ l·ªõp)
                let classIdToAdd = null;
                if (classCode) {
                    const classSnap = await getDocs(query(collection(db, 'artifacts', appId, 'public', 'data', 'classes'), where('classCode', '==', classCode)));
                    if (!classSnap.empty) {
                        classIdToAdd = classSnap.docs[0].id;
                    }
                }

                // 4. LOOP V√Ä T·∫†O USER
                for (let i = 0; i < studentsToCreate.length; i++) {
                    const student = studentsToCreate[i];
                    try {
                        const cred = await createUserWithEmailAndPassword(secondaryAuth, student.email, student.password);
                        const uid = cred.user.uid;

                        // T·∫°o profile trong Firestore (D√πng db ch√≠nh c·ªßa Admin)
                        await setDoc(doc(db, getPath('users'), uid), {
                            uid: uid,
                            name: student.name,
                            role: 'student',
                            points: 0,
                            email: student.email,
                            avatarUrl: null,
                            createdAt: serverTimestamp()
                        });

                        // Th√™m v√†o l·ªõp (N·∫øu c√≥)
                        if (classIdToAdd) {
                             await updateDoc(doc(db, getPath('classes'), classIdToAdd), {
                                studentIds: arrayUnion(uid)
                            });
                        }

                        successCount++;
                    } catch (err) {
                        console.error(`L·ªói t·∫°o user ${student.email}:`, err);
                        failCount++;
                    }
                    
                    statusEl.textContent = `ƒêang x·ª≠ l√Ω ${i+1}/${studentsToCreate.length} (Th√†nh c√¥ng: ${successCount}, L·ªói: ${failCount})`;
                }

                // 5. CLEANUP
                await signOut(secondaryAuth);
                await deleteApp(secondaryApp);

                showToast(`Ho√†n t·∫•t! Th√†nh c√¥ng: ${successCount}, L·ªói: ${failCount}`);
                if (successCount > 0) {
                     setTimeout(() => toggleBulkModal(false), 2000);
                }

            } catch (e) {
                console.error("Critical Bulk Error:", e);
                showToast("L·ªói h·ªá th·ªëng khi t·∫°o h√†ng lo·∫°t.", "error");
            } finally {
                state.ui.isBulkCreating = false;
                statusEl.className = "text-center text-sm font-bold mt-2 text-slate-600";
            }
        };
// --- LOGIC T·∫¢I FILE √ÇM THANH CHO C√ÇU H·ªéI ---
        window.tempAudioUrl = null; // Bi·∫øn l∆∞u t·∫°m URL sau khi upload

        window.handleQuestionAudioUpload = async (event) => {
            const file = event.target.files[0];
            if (!file) return;

            const statusId = event.target.getAttribute('data-status-id');
            const statusEl = document.getElementById(statusId);
            
            if(statusEl) {
                statusEl.textContent = 'ƒêang t·∫£i l√™n...';
                statusEl.className = 'text-xs text-blue-600 mt-1 animate-pulse';
            }

            try {
                // Upload v√†o th∆∞ m·ª•c question_audio
                const fileRef = storageRef(storage, `question_audio/${Date.now()}_${file.name}`);
                const snapshot = await uploadBytes(fileRef, file);
                const downloadURL = await getDownloadURL(snapshot.ref);
                
                window.tempAudioUrl = downloadURL; // L∆∞u v√†o bi·∫øn t·∫°m
                
                if(statusEl) {
                    statusEl.textContent = 'ƒê√£ t·∫£i xong! S·∫µn s√†ng th√™m.';
                    statusEl.className = 'text-xs text-green-600 mt-1 font-bold';
                }
            } catch (e) {
                console.error("Upload audio error:", e);
                if(statusEl) {
                    statusEl.textContent = 'L·ªói t·∫£i file. Th·ª≠ l·∫°i.';
                    statusEl.className = 'text-xs text-red-500 mt-1';
                }
            }
        };
// --- H√ÄM H·ªñ TR·ª¢ PH√ÅT AUDIO T√ôY CH·ªàNH ---
        window.playCustomAudio = (audioId, btnElement) => {
            const audio = document.getElementById(audioId);
            if (!audio) return;

            // N·∫øu ƒëang d·ª´ng th√¨ ph√°t
            if (audio.paused) {
                // D·ª´ng c√°c audio kh√°c ƒëang ch·∫°y (n·∫øu c√≥)
                document.querySelectorAll('audio').forEach(a => {
                    if(a.id !== audioId) { a.pause(); a.currentTime = 0; }
                });

                audio.play();
                
                // Hi·ªáu ·ª©ng Visual: ƒê·ªïi m√†u n√∫t khi ƒëang nghe
                btnElement.classList.remove('bg-purple-100', 'text-purple-700');
                btnElement.classList.add('bg-green-100', 'text-green-600', 'ring-2', 'ring-green-400', 'animate-pulse');
                
                // Khi ph√°t xong th√¨ reset n√∫t v·ªÅ b√¨nh th∆∞·ªùng
                audio.onended = () => {
                    btnElement.classList.add('bg-purple-100', 'text-purple-700');
                    btnElement.classList.remove('bg-green-100', 'text-green-600', 'ring-2', 'ring-green-400', 'animate-pulse');
                };
            } else {
                // N·∫øu ƒëang ph√°t th√¨ d·ª´ng
                audio.pause();
                btnElement.classList.add('bg-purple-100', 'text-purple-700');
                btnElement.classList.remove('bg-green-100', 'text-green-600', 'ring-2', 'ring-green-400', 'animate-pulse');
            }
        };
// --- H√ÄM CH·ªåN TH·ª¶ C√îNG (LOGIC ƒê√É FIX: H·ªñ TR·ª¢ C·∫¢ TH·ª¨ TH√ÅCH & B√ÄI T·∫¨P) ---
window.selectQuestionFromBank = (qIndex) => {
    const scrollContainer = document.getElementById('bank-scroll-view');
    let savedScrollTop = 0;
    if (scrollContainer) savedScrollTop = scrollContainer.scrollTop;

    const selectedBank = state.data.questionBanks.find(b => b.id === state.ui.selectedBankId);
    if (!selectedBank) return;
    const questionToToggle = selectedBank.questions[qIndex];

    // --- FIX QUAN TR·ªåNG: X√ÅC ƒê·ªäNH ƒê√öNG N∆†I L∆ØU (Th·ª≠ th√°ch hay B√†i t·∫≠p) ---
    let currentQs;
    if (state.view === 'challenges') {
        // N·∫øu ƒëang ·ªü m√†n h√¨nh Th·ª≠ th√°ch
        if (!state.ui.activeChallenge) state.ui.activeChallenge = {}; // Safety check
        if (!state.ui.activeChallenge.questions) state.ui.activeChallenge.questions = [];
        currentQs = state.ui.activeChallenge.questions;
    } else {
        // N·∫øu ƒëang ·ªü m√†n h√¨nh B√†i t·∫≠p
        if (!state.ui.newAssignment) state.ui.newAssignment = {}; // Safety check
        if (!state.ui.newAssignment.questions) state.ui.newAssignment.questions = [];
        currentQs = state.ui.newAssignment.questions;
    }

    // Ki·ªÉm tra xem ƒë√£ c√≥ ch∆∞a ƒë·ªÉ Th√™m ho·∫∑c X√≥a
    // S·ª≠ d·ª•ng JSON.stringify ƒë·ªÉ so s√°nh n·ªôi dung c√¢u h·ªèi ch√≠nh x√°c
    const existingIndex = currentQs.findIndex(existQ => 
        JSON.stringify({t: existQ.text, o: existQ.options, a: existQ.answer}) === 
        JSON.stringify({t: questionToToggle.text, o: questionToToggle.options, a: questionToToggle.answer})
    );

    let isSelectedNow = false;

    // C·∫≠p nh·∫≠t State (D·ªØ li·ªáu)
    if (existingIndex !== -1) {
        // ƒê√£ c√≥ -> X√≥a ƒëi
        currentQs.splice(existingIndex, 1);
        isSelectedNow = false;
    } else {
        // Ch∆∞a c√≥ -> Th√™m v√†o
        currentQs.push(questionToToggle);
        isSelectedNow = true;
    }

    // --- C·∫¨P NH·∫¨T GIAO DI·ªÜN TR·ª∞C TI·∫æP (OPTIMIZED UI UPDATE) ---
    // 1. C·∫≠p nh·∫≠t n√∫t b·∫•m ngay l·∫≠p t·ª©c m√† kh√¥ng c·∫ßn render l·∫°i to√†n b·ªô App
    const btn = document.getElementById(`btn-select-${qIndex}`);
    if (btn) {
        if (isSelectedNow) {
            // ƒê·ªïi sang tr·∫°ng th√°i "ƒê√£ ch·ªçn" (M√†u ƒë·ªè, ch·ªØ B·ªè)
            btn.className = "flex-shrink-0 px-3 py-1.5 rounded-lg text-xs font-bold transition flex items-center gap-1 shadow-sm w-20 justify-center bg-red-100 text-red-600 hover:bg-red-200 border border-red-200";
            btn.innerHTML = '<i data-lucide="minus" class="w-3 h-3"></i> B·ªè';
        } else {
            // ƒê·ªïi sang tr·∫°ng th√°i "Ch∆∞a ch·ªçn" (M√†u xanh, ch·ªØ Ch·ªçn)
            btn.className = "flex-shrink-0 px-3 py-1.5 rounded-lg text-xs font-bold transition flex items-center gap-1 shadow-sm w-20 justify-center bg-blue-600 text-white hover:bg-blue-700";
            btn.innerHTML = '<i data-lucide="plus" class="w-3 h-3"></i> Ch·ªçn';
        }
        // Render l·∫°i icon v·ª´a th√™m v√†o n√∫t
        renderIcons();
    }

    // 2. C·∫≠p nh·∫≠t con s·ªë t·ªïng ƒë·∫øm tr√™n Header
    const countEl = document.getElementById('total-selected-count');
    if (countEl) {
        countEl.textContent = currentQs.length;
        // Hi·ªáu ·ª©ng nh√°y nh·∫π ƒë·ªÉ b√°o hi·ªáu
        countEl.classList.remove('text-blue-600');
        countEl.classList.add('text-green-600', 'scale-110');
        setTimeout(() => {
            countEl.classList.remove('text-green-600', 'scale-110');
            countEl.classList.add('text-blue-600');
        }, 200);
    }
    
    // Gi·ªØ v·ªã tr√≠ cu·ªôn (n·∫øu c√≥ container)
    const newScrollContainer = document.getElementById('bank-scroll-view');
    if (newScrollContainer) newScrollContainer.scrollTop = savedScrollTop;
};
// --- H√ÄM L∆ØU NH·∫¨N X√âT C·ª¶A GI√ÅO VI√äN ---
        window.saveTeacherFeedback = async (subId) => {
            const comment = document.getElementById('teacher-comment-input').value.trim();
            if (!comment) return showToast("Vui l√≤ng nh·∫≠p n·ªôi dung nh·∫≠n x√©t tr∆∞·ªõc khi l∆∞u.", "error");

            try {
                // C·∫≠p nh·∫≠t tr∆∞·ªùng teacherComment trong submission
                const subRef = doc(db, getPath('submissions'), subId);
                await updateDoc(subRef, {
                    teacherComment: comment
                });
                
                // C·∫≠p nh·∫≠t state local ƒë·ªÉ kh√¥ng c·∫ßn t·∫£i l·∫°i trang
                if (state.ui.viewSubmission && state.ui.viewSubmission.id === subId) {
                    state.ui.viewSubmission.teacherComment = comment;
                }
                
                showToast("ƒê√£ l∆∞u nh·∫≠n x√©t th√†nh c√¥ng!");
                
                // Kh√¥ng c·∫ßn render l·∫°i to√†n b·ªô app ƒë·ªÉ tr√°nh m·∫•t v·ªã tr√≠, ch·ªâ b√°o th√†nh c√¥ng l√† ƒë·ªß
                // Ho·∫∑c n·∫øu mu·ªën ch·∫Øc ch·∫Øn, c√≥ th·ªÉ render l·∫°i: renderApp(); 
            } catch (e) {
                console.error("Error saving feedback:", e);
                showToast(`L·ªói l∆∞u nh·∫≠n x√©t: ${e.message}`, "error");
            }
        };
// --- LOGIC CHO D·∫†NG B√ÄI ORDER SENTENCES ---
// --- LOGIC CHO D·∫†NG B√ÄI ORDER SENTENCES ---
        window.addOrderedSentence = (qIdx, sentence) => {
            const currentOrder = state.ui.assignmentAnswers[qIdx] || [];
            state.ui.assignmentAnswers[qIdx] = [...currentOrder, sentence];
            
            // FIX: ∆Øu ti√™n l·∫•y t·ª´ Session (ƒë·ªÅ ƒë√£ tr√°o)
            const assign = window.CURRENT_EXAM_SESSION || state.data.assignments.find(a => a.id === state.ui.takingAssignmentId);
            if (assign) updateAssignmentQuestionUI(assign, qIdx);
        };

        window.removeOrderedSentence = (qIdx, sIdx) => {
            const currentOrder = state.ui.assignmentAnswers[qIdx] || [];
            currentOrder.splice(sIdx, 1);
            state.ui.assignmentAnswers[qIdx] = currentOrder;
            
            // FIX: ∆Øu ti√™n l·∫•y t·ª´ Session (ƒë·ªÅ ƒë√£ tr√°o)
            const assign = window.CURRENT_EXAM_SESSION || state.data.assignments.find(a => a.id === state.ui.takingAssignmentId);
            if (assign) updateAssignmentQuestionUI(assign, qIdx);
        };
// --- H√ÄM S·ª¨A ƒêI·ªÇM H·ªåC SINH (N√ÇNG C·∫§P: C·ªòNG D·ªíN CHU·ªñI S·ªê) ---
        window.handleEditStudentPoints = async (uid, name, currentPoints) => {
            // Hi·ªÉn th·ªã prompt v·ªõi gi√° tr·ªã m·∫∑c ƒë·ªãnh l√† ƒëi·ªÉm hi·ªán t·∫°i
            const input = prompt(
                `Nh·∫≠p c√°c ƒëi·ªÉm c·ªông th√™m c√°ch nhau b·∫±ng d·∫•u c√°ch (VD: "10 20 5").\nH·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông c·ªông v√†o t·ªïng hi·ªán t·∫°i.\n\nƒêi·ªÉm hi·ªán t·∫°i c·ªßa ${name}:`, 
                currentPoints
            );
            
            if (input === null) return; // Ng∆∞·ªùi d√πng ·∫•n H·ªßy
            
            // --- LOGIC M·ªöI: X·ª¨ L√ù CHU·ªñI NH·∫¨P V√ÄO ---
            // 1. D√πng Regex ƒë·ªÉ l·∫•y t·∫•t c·∫£ c√°c con s·ªë trong chu·ªói (ch·∫•p nh·∫≠n c·∫£ s·ªë √¢m nh∆∞ -10)
            const numbers = input.match(/-?\d+/g);
            
            if (!numbers || numbers.length === 0) {
                showToast("Vui l√≤ng nh·∫≠p √≠t nh·∫•t m·ªôt con s·ªë!", "error");
                return;
            }
            
            // 2. T√≠nh t·ªïng t·∫•t c·∫£ c√°c con s·ªë t√¨m ƒë∆∞·ª£c
            // V√≠ d·ª•: Nh·∫≠p "368 10 20" -> 368 + 10 + 20 = 398
            const newPoints = numbers.reduce((sum, num) => sum + parseInt(num, 10), 0);
            
            // 3. Ki·ªÉm tra t√≠nh h·ª£p l·ªá (Kh√¥ng cho ph√©p ƒëi·ªÉm √¢m n·∫øu mu·ªën)
            if (newPoints < 0) {
                showToast("T·ªïng ƒëi·ªÉm sau khi t√≠nh to√°n kh√¥ng ƒë∆∞·ª£c √¢m!", "error");
                return;
            }
            
            // N·∫øu ƒëi·ªÉm kh√¥ng thay ƒë·ªïi th√¨ th√¥i
            if (newPoints === currentPoints) return;

            try {
                // C·∫≠p nh·∫≠t tr·ª±c ti·∫øp v√†o profile user
                await updateDoc(doc(db, getPath('users'), uid), {
                    points: newPoints
                });
                
                showToast(`ƒê√£ c·∫≠p nh·∫≠t: ${currentPoints} + [${input.replace(currentPoints, '').trim()}] = ${newPoints} ƒëi·ªÉm`);
            } catch (e) {
                console.error("L·ªói c·∫≠p nh·∫≠t ƒëi·ªÉm:", e);
                showToast("L·ªói khi c·∫≠p nh·∫≠t ƒëi·ªÉm s·ªë.", "error");
            }
        };
// --- T·∫†O PH√íNG T·ª™ NG√ÇN H√ÄNG ƒê·ªÄ ---
        window.createMatchFromBank = async () => {
            const bankId = document.getElementById('arena-bank-select').value;
            if (!bankId) return showToast("Vui l√≤ng ch·ªçn m·ªôt b·ªô ƒë·ªÅ ƒë·ªÉ thi ƒë·∫•u!", "error");

            const selectedBank = state.data.questionBanks.find(b => b.id === bankId);
            if (!selectedBank) return showToast("Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu b·ªô ƒë·ªÅ.", "error");

            // 1. L·ªçc ra c√°c c√¢u h·ªèi ph√π h·ª£p cho ƒê·∫•u tr∆∞·ªùng (Ch·ªâ l·∫•y c√¢u c√≥ ƒë√°p √°n tr·∫Øc nghi·ªám A,B,C,D)
            // Lo·∫°i b·ªè c√¢u ƒëi·ªÅn t·ª´ (fib) ho·∫∑c s·∫Øp x·∫øp (order) v√¨ kh√¥ng ph√π h·ª£p v·ªõi giao di·ªán click nhanh
            const validTypes = ['mcq', 'listen_mcq', 'listen_conversation', 'reading_comprehension', 'arena_quiz'];
            
            let pool = selectedBank.questions.filter(q => validTypes.includes(q.type));

            if (pool.length < 5) {
                return showToast(`B·ªô ƒë·ªÅ n√†y ch·ªâ c√≥ ${pool.length} c√¢u tr·∫Øc nghi·ªám. C·∫ßn √≠t nh·∫•t 5 c√¢u.`, "error");
            }

            // 2. Tr·ªôn ng·∫´u nhi√™n v√† l·∫•y t·ªëi ƒëa 15 c√¢u
            pool = pool.sort(() => Math.random() - 0.5).slice(0, 15);

            // 3. T·∫°o ph√≤ng
            const roomCode = generateRoomCode();
            
            try {
                await addDoc(getRef('matches'), { 
                    roomCode, 
                    player1: { uid: state.user.uid, name: state.profile.name, score: 0 }, 
                    player2: null, 
                    status: 'waiting', 
                    questions: pool, // L∆∞u b·ªô c√¢u h·ªèi v√†o tr·∫≠n ƒë·∫•u
                    bankName: selectedBank.title,
                    qIndex: 0, 
                    createdAt: serverTimestamp() 
                });
                
                state.ui.competitionMode = 'waiting'; 
                showToast(`ƒê√£ t·∫°o ph√≤ng ${roomCode} t·ª´ b·ªô ƒë·ªÅ "${selectedBank.title}"`);
            } catch (e) {
                console.error("L·ªói t·∫°o ph√≤ng:", e);
                showToast("L·ªói khi t·∫°o ph√≤ng ƒë·∫•u.", "error");
            }
        };
// --- H√ÄM ƒê√ìNG MODAL K·∫æT QU·∫¢ & QUAY V·ªÄ S·∫¢NH (FIX L·ªñI) ---
        window.closeMatchResult = () => {
            // 1. ·∫®n modal k·∫øt qu·∫£
            state.ui.matchResult = null; 
            
            // 2. X√≥a d·ªØ li·ªáu tr·∫≠n ƒë·∫•u hi·ªán t·∫°i trong b·ªô nh·ªõ (Quan tr·ªçng)
            // ƒê·ªÉ tr√°nh vi·ªác Listener t·ª± ƒë·ªông ƒë·∫©y l·∫°i v√†o m√†n h√¨nh ch·ªù/k·∫øt qu·∫£
            state.ui.activeMatch = null; 
            state.ui.lastFinishedMatch = null;

            // 3. Reset c√°c tr·∫°ng th√°i kh√°c ƒë·ªÉ s·∫µn s√†ng cho tr·∫≠n m·ªõi
            state.ui.hasAnsweredCurrentQ = false;
            state.ui.matchQIndex = 0;
            
            // 4. Chuy·ªÉn v·ªÅ ch·∫ø ƒë·ªô Lobby v√† Render l·∫°i
            state.ui.competitionMode = 'lobby';
            renderApp();
        };
// --- LOGIC CHO GI√ÅO VI√äN XEM TR·∫¨N ƒê·∫§U ---
        window.watchMatch = (matchId) => {
            // T√¨m match trong data hi·ªán c√≥
            const match = state.data.matches.find(m => m.id === matchId);
            if (match) {
                state.ui.activeMatch = match;
                state.ui.competitionMode = 'spectating';
                renderApp();
            } else {
                showToast("Kh√¥ng t√¨m th·∫•y tr·∫≠n ƒë·∫•u n√†y.", "error");
            }
        };

        window.stopSpectating = () => {
            state.ui.activeMatch = null;
            state.ui.competitionMode = 'lobby'; // Quay v·ªÅ dashboard gi√°o vi√™n
            renderApp();
        };
// --- H√ÄM GI√ÅO VI√äN: BU·ªòC K·∫æT TH√öC TR·∫¨N ƒê·∫§U ---
        window.forceEndMatch = async (matchId, roomCode) => {
            if (!confirm(`B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën k·∫øt th√∫c ngay tr·∫≠n ƒë·∫•u ph√≤ng ${roomCode}?`)) return;

            try {
                // C·∫≠p nh·∫≠t tr·∫°ng th√°i sang finished ƒë·ªÉ ƒë·∫©y v√†o l·ªãch s·ª≠
                await updateDoc(doc(db, getPath('matches'), matchId), {
                    status: 'finished',
                    finishedBy: state.user.uid // Ghi d·∫•u ·∫•n l√† do gi√°o vi√™n k·∫øt th√∫c
                });
                showToast("ƒê√£ k·∫øt th√∫c tr·∫≠n ƒë·∫•u!", "success");
            } catch (e) {
                console.error("L·ªói k·∫øt th√∫c tr·∫≠n:", e);
                showToast("Kh√¥ng th·ªÉ k·∫øt th√∫c tr·∫≠n ƒë·∫•u (L·ªói quy·ªÅn ho·∫∑c m·∫°ng).", "error");
            }
        };

        // --- H√ÄM GI√ÅO VI√äN: X√ìA L·ªäCH S·ª¨ TR·∫¨N ƒê·∫§U ---
        window.confirmDeleteMatchHistory = (matchId) => {
             // T·∫°o modal x√°c nh·∫≠n nhanh ho·∫∑c d√πng confirm
            const confirmModal = document.createElement('div');
            confirmModal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[70] p-4 fade-in';
            confirmModal.innerHTML = `
                <div class="bg-white p-6 rounded-xl shadow-2xl max-w-sm w-full text-center">
                    <p class="font-bold text-lg mb-2 text-slate-800">X√≥a l·ªãch s·ª≠ tr·∫≠n ƒë·∫•u?</p>
                    <p class="text-slate-500 mb-6 text-sm">D·ªØ li·ªáu k·∫øt qu·∫£ c·ªßa tr·∫≠n n√†y s·∫Ω b·ªã x√≥a vƒ©nh vi·ªÖn.</p>
                    <div class="flex justify-center gap-3">
                        <button id="cancel-del-match" class="bg-slate-100 text-slate-600 px-4 py-2 rounded-lg font-bold hover:bg-slate-200">H·ªßy</button>
                        <button id="confirm-del-match" class="bg-red-600 text-white px-4 py-2 rounded-lg font-bold hover:bg-red-700">X√≥a vƒ©nh vi·ªÖn</button>
                    </div>
                </div>
            `;
            document.body.appendChild(confirmModal);
            
            document.getElementById('cancel-del-match').onclick = () => confirmModal.remove();
            document.getElementById('confirm-del-match').onclick = async () => {
                confirmModal.remove();
                try {
                    await deleteDoc(doc(db, getPath('matches'), matchId));
                    showToast("ƒê√£ x√≥a l·ªãch s·ª≠ tr·∫≠n ƒë·∫•u.");
                } catch (e) {
                    console.error("Delete error:", e);
                    showToast("L·ªói x√≥a: " + e.message, "error");
                }
            };
        };
// --- H√ÄM GI√ÅO VI√äN: X√ìA T·∫§T C·∫¢ L·ªäCH S·ª¨ ---
        window.deleteAllMatchHistory = async () => {
            // 1. L·ªçc ra t·∫•t c·∫£ c√°c tr·∫≠n ƒë·∫•u ƒë√£ k·∫øt th√∫c
            const finishedMatches = state.data.matches.filter(m => m.status === 'finished');

            if (finishedMatches.length === 0) {
                return showToast("Kh√¥ng c√≥ l·ªãch s·ª≠ n√†o ƒë·ªÉ x√≥a.", "info");
            }

            // 2. H·ªèi x√°c nh·∫≠n
            if (!confirm(`C·∫¢NH B√ÅO: B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a to√†n b·ªô ${finishedMatches.length} tr·∫≠n ƒë·∫•u trong l·ªãch s·ª≠? H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c.`)) {
                return;
            }

            // 3. Th·ª±c hi·ªán x√≥a
            try {
                // T·∫°o m·ªôt m·∫£ng c√°c Promise ƒë·ªÉ x√≥a song song (nhanh h∆°n)
                const deletePromises = finishedMatches.map(m => deleteDoc(doc(db, getPath('matches'), m.id)));
                
                await Promise.all(deletePromises);
                
                showToast(`ƒê√£ x√≥a s·∫°ch ${finishedMatches.length} b·∫£n ghi l·ªãch s·ª≠!`);
            } catch (e) {
                console.error("Bulk delete error:", e);
                showToast("L·ªói khi x√≥a d·ªØ li·ªáu: " + e.message, "error");
            }
        };
// ============================================================
        // === MODULE: CHINH PH·ª§C TH·ª¨ TH√ÅCH (CHALLENGES) ===
        // ============================================================

// --- 1. ƒêI·ªÄU H∆Ø·ªöNG CH√çNH MODULE TH·ª¨ TH√ÅCH ---
        const renderChallenges = () => {
            // N·∫øu ƒëang ch·ªçn c√¢u h·ªèi t·ª´ ng√¢n h√†ng ƒë·ªÅ (t√°i s·ª≠ d·ª•ng giao di·ªán)
            if (state.ui.isSelectingBankQuestions) {
                return renderQuestionSelectionFromBank();
            }
            if (state.ui.challengeMode === 'create' || state.ui.challengeMode === 'edit') {
                return renderChallengeForm();
            }
            if (state.ui.challengeMode === 'do') {
                return renderDoingChallenge();
            }
            // M·∫∑c ƒë·ªãnh: Xem danh s√°ch
            return state.profile.role === 'teacher' ? renderTeacherChallenges() : renderStudentChallenges();
        };

// --- 2. GIAO DI·ªÜN GI√ÅO VI√äN (QU·∫¢N L√ù) - ƒê√É B·ªé N√öT TH·ªêNG K√ä RI√äNG ---
        const renderTeacherChallenges = () => {
            const list = state.data.challenges.map(c => {
                const passCount = state.data.users.filter(u => (u.completedChallenges || []).includes(c.id)).length;

                return `
                <div class="bg-white p-5 rounded-2xl shadow-sm border border-slate-200 hover:shadow-md transition relative group">
                    <div class="flex justify-between items-start mb-3">
                        <div class="bg-orange-100 text-orange-600 w-10 h-10 rounded-full flex items-center justify-center font-bold text-lg shadow-sm border border-orange-200">
                            ${c.order || '#'}
                        </div>
                        
                        <div class="flex gap-1">
                            <button onclick="editChallenge('${c.id}')" class="p-2 text-slate-500 bg-slate-50 hover:bg-yellow-100 hover:text-yellow-600 rounded-lg transition" title="Ch·ªânh s·ª≠a">
                                <i data-lucide="edit" size="18"></i>
                            </button>
                            <button onclick="deleteChallenge('${c.id}')" class="p-2 text-slate-500 bg-slate-50 hover:bg-red-100 hover:text-red-600 rounded-lg transition" title="X√≥a">
                                <i data-lucide="trash-2" size="18"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div>
                        <h4 class="font-bold text-slate-800 text-lg mb-2 line-clamp-2" title="${c.title}">
                            ${c.title}
                        </h4>
                        
                        <div class="flex flex-wrap items-center gap-2 text-xs text-slate-500 font-medium">
                            <div class="flex items-center gap-1 bg-slate-100 px-2 py-1 rounded-md border border-slate-200">
                                <i data-lucide="list-checks" size="14"></i> ${c.questions.length} c√¢u
                            </div>
                            
                            <button onclick="viewChallengeStats('${c.id}')" 
                                    class="flex items-center gap-1 bg-green-50 hover:bg-green-100 px-2 py-1 rounded-md border border-green-200 text-green-700 font-bold transition cursor-pointer shadow-sm"
                                    title="Nh·∫•n ƒë·ªÉ xem danh s√°ch h·ªçc sinh ƒë√£ v∆∞·ª£t qua">
                                <i data-lucide="check-circle" size="14"></i> ${passCount} ƒë√£ qua
                            </button>

                            <div class="flex items-center gap-1 ml-auto text-slate-400">
                                ${c.createdAt ? new Date(c.createdAt.seconds*1000).toLocaleDateString('vi-VN') : ''}
                            </div>
                        </div>
                    </div>
                </div>
            `}).join('');

            return `
                <div class="max-w-6xl mx-auto fade-in">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 gap-4">
                        <div>
                            <h2 class="text-2xl md:text-3xl font-bold text-slate-800 flex items-center gap-3">
                                <div class="p-2 bg-orange-500 rounded-xl text-white shadow-lg shadow-orange-200">
                                    <i data-lucide="mountain-snow" size="28"></i>
                                </div>
                                Qu·∫£n l√Ω Th·ª≠ th√°ch
                            </h2>
                            <p class="text-slate-500 mt-1 ml-1">T·∫°o v√† qu·∫£n l√Ω l·ªô tr√¨nh h·ªçc t·∫≠p cho h·ªçc sinh</p>
                        </div>
                        <button onclick="initCreateChallenge()" class="bg-gradient-to-r from-orange-500 to-red-500 hover:from-orange-600 hover:to-red-600 text-white px-6 py-3 rounded-xl font-bold shadow-lg flex items-center gap-2 transition transform hover:-translate-y-0.5">
                            <i data-lucide="plus-circle" size="20"></i> T·∫°o Th·ª≠ th√°ch M·ªõi
                        </button>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 md:gap-6">
                        ${list || `<div class="col-span-full text-center text-slate-400 py-12 bg-white rounded-2xl border-2 border-dashed border-slate-200">Ch∆∞a c√≥ th·ª≠ th√°ch n√†o. H√£y t·∫°o m·ªõi!</div>`}
                    </div>
                    
                    <div class="mt-10 bg-white p-6 md:p-8 rounded-2xl shadow-sm border border-slate-200">
                        <h3 class="font-bold text-slate-700 mb-4 flex items-center gap-2 text-lg"><i data-lucide="shield-alert" class="text-red-500"></i> Qu·∫£n tr·ªã vi√™n</h3>
                        <div class="flex flex-col md:flex-row gap-3">
                            <input id="reset-student-email" type="text" class="border-2 border-slate-200 p-3 rounded-xl flex-1 focus:border-red-400 outline-none" placeholder="Nh·∫≠p email h·ªçc sinh c·∫ßn reset ti·∫øn ƒë·ªô...">
                            <button onclick="resetStudentProgress()" class="bg-red-50 text-red-600 border border-red-200 px-6 py-3 rounded-xl font-bold hover:bg-red-100 transition whitespace-nowrap">
                                Reset Ti·∫øn ƒë·ªô
                            </button>
                        </div>
                    </div>
                </div>
            `;
        };

 // --- 3. FORM T·∫†O/S·ª¨A TH·ª¨ TH√ÅCH (ƒê√É TH√äM N√öT L∆ØU TR√äN ƒê·∫¶U) ---
        const renderChallengeForm = () => {
            const isEdit = !!state.ui.activeChallenge.id;
            const qList = state.ui.activeChallenge.questions.map((q, idx) => renderQuestionDisplay(q, idx)).join('');
            const myBanks = state.data.questionBanks.filter(b => b.createdBy === state.user.uid);
            
            return `
                <div class="max-w-4xl mx-auto bg-white p-8 rounded-2xl shadow-lg fade-in">
                    <div class="flex justify-between items-center mb-6 border-b pb-4 sticky top-0 bg-white z-10">
                        <h3 class="text-2xl font-bold text-orange-600">${isEdit ? 'Ch·ªânh s·ª≠a Th·ª≠ th√°ch' : 'T·∫°o Th·ª≠ th√°ch M·ªõi'}</h3>
                        
                        <div class="flex items-center gap-3">
                            <button onclick="saveChallenge()" class="bg-orange-600 hover:bg-orange-700 text-white px-5 py-2 rounded-xl font-bold shadow-md flex items-center gap-2 transition transform hover:-translate-y-0.5">
                                <i data-lucide="save" size="20"></i>
                            </button>
                            <button onclick="closeChallengeForm()" class="text-slate-400 hover:text-red-500 p-2 rounded-full hover:bg-slate-100 transition">
                                <i data-lucide="x" size="28"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                        <div>
                            <label class="block text-sm font-bold text-slate-700 mb-1">T√™n Th·ª≠ th√°ch</label>
                            <input id="chal-title" value="${state.ui.activeChallenge.title || ''}" class="w-full p-3 border-2 border-slate-200 rounded-xl focus:border-orange-500 outline-none font-bold" placeholder="VD: Th·ª≠ th√°ch Tu·∫ßn 1...">
                        </div>
                        <div>
                            <label class="block text-sm font-bold text-slate-700 mb-1">Th·ª© t·ª± (Order)</label>
                            <input id="chal-order" type="number" value="${state.ui.activeChallenge.order || (state.data.challenges.length + 1)}" class="w-full p-3 border-2 border-slate-200 rounded-xl focus:border-orange-500 outline-none font-bold">
                            <p class="text-xs text-slate-500 mt-1">H·ªçc sinh ph·∫£i ho√†n th√†nh b√†i 1 m·ªõi m·ªü ƒë∆∞·ª£c b√†i 2.</p>
                        </div>
                    </div>

                    <div class="flex justify-between items-end mb-2">
                        <h4 class="text-lg font-bold text-slate-800">Danh s√°ch c√¢u h·ªèi (${state.ui.activeChallenge.questions.length})</h4>
                    </div>
                    
                    <div id="questions-preview" class="space-y-4 border-2 border-slate-100 p-4 rounded-xl bg-slate-50 max-h-96 overflow-y-auto mb-6">
                        ${qList || '<p class="text-slate-400 text-center italic py-8">Ch∆∞a c√≥ c√¢u h·ªèi n√†o.</p>'}
                    </div>

<div class="mb-8 space-y-4">
    <button onclick="setSelectingBankQuestions(true)" ${myBanks.length === 0 ? 'disabled' : ''} class="w-full bg-yellow-100 text-yellow-700 py-3 rounded-xl font-bold border border-yellow-300 hover:bg-yellow-200 transition flex items-center justify-center gap-2 ${myBanks.length === 0 ? 'opacity-50 cursor-not-allowed' : ''}">
        <i data-lucide="plus-square" size="18"></i> Ch·ªçn c√¢u h·ªèi t·ª´ Ng√¢n h√†ng ƒë·ªÅ
    </button>
    
    <div class="relative">
        <input type="file" id="challengeJsonInput" accept=".json" class="hidden" onchange="handleChallengeJSONUpload(event)">
        <label for="challengeJsonInput" class="w-full bg-green-100 text-green-700 py-3 rounded-xl font-bold border border-green-300 hover:bg-green-200 transition flex items-center justify-center cursor-pointer gap-2">
            <i data-lucide="upload" size="18"></i> T·∫£i c√¢u h·ªèi t·ª´ file JSON
        </label>
    </div>
    ${myBanks.length === 0 ? '<p class="text-xs text-center text-red-500">Ch∆∞a c√≥ ng√¢n h√†ng ƒë·ªÅ n√†o.</p>' : ''}
</div>

                    ${renderQuestionInputSection(true)}

                    <div class="flex gap-3 mt-8 pt-6 border-t">
                        <button onclick="closeChallengeForm()" class="flex-1 bg-slate-100 text-slate-600 py-3 rounded-xl font-bold hover:bg-slate-200">H·ªßy</button>
                        <button onclick="saveChallenge()" class="flex-1 bg-orange-600 text-white py-3 rounded-xl font-bold shadow-lg hover:bg-orange-700">L∆∞u Th·ª≠ th√°ch</button>
                    </div>
                </div>
            `;
        };

// --- 4. GIAO DI·ªÜN H·ªåC SINH (L·ªò TR√åNH) - ƒê√É C√ì N√öT XEM BXH ---
        const renderStudentChallenges = () => {
            const challenges = state.data.challenges;
            const myCompleted = state.profile.completedChallenges || [];
            const myStreak = state.profile.streak || 0;

            const listHtml = challenges.map((c, idx) => {
                const isCompleted = myCompleted.includes(c.id);
                // Logic kh√≥a: M·ªü n·∫øu l√† b√†i 1 HO·∫∂C b√†i tr∆∞·ªõc ƒë√£ xong
                const prevChallenge = challenges[idx - 1];
                const isLocked = idx > 0 && (!prevChallenge || !myCompleted.includes(prevChallenge.id));
                
                // ƒê·∫øm s·ªë ng∆∞·ªùi ƒë√£ qua ƒë·ªÉ hi·ªÉn th·ªã tr√™n n√∫t
                const passCount = state.data.users.filter(u => (u.completedChallenges || []).includes(c.id)).length;

                let statusIcon = isLocked ? '<i data-lucide="lock" class="text-slate-400"></i>' 
                               : isCompleted ? '<i data-lucide="check-circle" class="text-green-500 fill-green-100 w-8 h-8"></i>'
                               : '<i data-lucide="play-circle" class="text-orange-500 w-8 h-8"></i>';
                
                let cardClass = isLocked ? 'bg-slate-100 border-slate-200 opacity-70 grayscale' 
                              : isCompleted ? 'bg-green-50 border-green-200' 
                              : 'bg-white border-orange-200 shadow-md transform hover:-translate-y-1';

                return `
                    <div onclick="${isLocked ? '' : `initDoChallenge('${c.id}')`}" 
                         class="relative p-5 rounded-2xl border-2 transition-all cursor-pointer flex flex-col gap-3 ${cardClass}">
                        
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-4">
                                <div class="w-12 h-12 rounded-full flex items-center justify-center font-black text-xl ${isLocked ? 'bg-slate-200 text-slate-500' : 'bg-white shadow-sm text-orange-600'}">
                                    ${c.order}
                                </div>
                                <div>
                                    <h4 class="font-bold text-lg ${isLocked ? 'text-slate-500' : 'text-slate-800'}">${c.title}</h4>
                                    <p class="text-sm ${isLocked ? 'text-slate-400' : 'text-slate-600'}">${c.questions.length} c√¢u ‚Ä¢ M·ª•c ti√™u: 80ƒë</p>
                                </div>
                            </div>
                            <div>${statusIcon}</div>
                        </div>

                        <div class="flex justify-between items-center pt-3 border-t ${isLocked ? 'border-slate-200' : 'border-black/5'}">
                            <div class="flex items-center gap-2">
                                <button onclick="event.stopPropagation(); viewChallengeStats('${c.id}')" 
                                        class="flex items-center gap-1.5 px-3 py-1.5 rounded-lg text-xs font-bold transition hover:bg-white/50 ${isLocked ? 'text-slate-400 pointer-events-none' : 'text-blue-600 hover:bg-blue-50'}">
                                    <i data-lucide="trophy" size="14"></i>
                                    <span>${passCount} ng∆∞·ªùi ƒë√£ qua</span>
                                </button>
                            </div>
                            
                            ${isCompleted ? '<span class="text-[10px] bg-green-200 text-green-800 px-2 py-0.5 rounded-full font-bold">ƒê√£ ho√†n th√†nh</span>' : ''}
                        </div>
                    </div>
                `;
            }).join('');

            return `
                <div class="max-w-3xl mx-auto fade-in pb-10">
                    <div class="text-center mb-8">
                        <div class="inline-flex items-center gap-2 bg-orange-100 text-orange-700 px-6 py-2 rounded-full font-bold text-lg shadow-sm mb-4">
                            <i data-lucide="flame" class="fill-orange-500"></i> Chu·ªói Streak: ${myStreak} ng√†y
                        </div>
                        <h2 class="text-3xl font-black text-slate-800">Con ƒë∆∞·ªùng Chinh ph·ª•c</h2>
                        <p class="text-slate-500">Ho√†n th√†nh t·ª´ng th·ª≠ th√°ch ƒë·ªÉ m·ªü kh√≥a b√†i ti·∫øp theo!</p>
                    </div>

                    <div class="space-y-4 relative">
                        <div class="absolute left-[2.25rem] top-0 bottom-0 w-1 bg-slate-200 -z-10"></div>
                        ${listHtml}
                    </div>
                </div>
            `;
        };

// --- 5. GIAO DI·ªÜN L√ÄM B√ÄI TH·ª¨ TH√ÅCH (ƒê√É S·ª¨A: ·∫®N SCRIPT B√ÄI NGHE) ---
        const renderDoingChallenge = () => {
           const c = window.CURRENT_EXAM_SESSION || state.ui.activeChallenge;
            if (!c) return '';
            
            const total = c.questions.length;
            const currentIdx = state.ui.challengeQIndex;
            const q = c.questions[currentIdx];
            const userAns = state.ui.challengeAnswers[currentIdx];
            
            // --- X·ª¨ L√ù √ÇM THANH ---
            const audioText = q.audioText || q.audioWord;
            const audioUrl = q.audioUrl; 
            const audioId = `chal-audio-${currentIdx}`; 
            let audioButtonHtml = '';
            
            if (audioUrl) {
                audioButtonHtml = `<audio id="${audioId}" src="${audioUrl}" style="display:none"></audio>
                    <button onclick="playCustomAudio('${audioId}', this)" class="w-14 h-14 rounded-full bg-purple-100 text-purple-700 flex items-center justify-center hover:bg-purple-200 shadow-md border-2 border-purple-200 animate-bounce-in"><i data-lucide="volume-2" size="28"></i></button>`;
            } else if (audioText) {
                audioButtonHtml = `<button onclick="speakWord('${audioText.replace(/'/g, "\\'")}', 'zh-CN')" class="w-14 h-14 rounded-full bg-purple-100 text-purple-700 flex items-center justify-center hover:bg-purple-200 shadow-md border-2 border-purple-200 animate-bounce-in"><i data-lucide="volume-2" size="28"></i></button>`;
            }

            // --- X·ª¨ L√ù ƒêO·∫†N VƒÇN (S·ª¨A T·∫†I ƒê√ÇY) ---
            let extraContent = '';
            
            // [QUAN TR·ªåNG] Ch·ªâ hi·ªán ƒëo·∫°n vƒÉn n·∫øu l√† b√†i ƒê·ªåC HI·ªÇU. 
            // B√†i NGHE H·ªòI THO·∫†I s·∫Ω ·∫©n script ƒëi ƒë·ªÉ h·ªçc sinh ph·∫£i nghe.
            if (q.type === 'reading_comprehension' && q.conversationContent) {
                extraContent = `<div class="mb-4 p-4 bg-slate-50 border-2 border-slate-200 rounded-xl text-left text-slate-700 whitespace-pre-line font-medium text-sm leading-relaxed">${formatText(q.conversationContent)}</div>`;
            }

            let questionText = formatText(q.text || q.vietnamese || '');
            if (q.type === 'fib') questionText = questionText.replace('[BLANK]', '______');

            // --- RENDER V√ôNG T∆Ø∆†NG T√ÅC ---
            let interactionHtml = '';

            if (q.options && q.options.length > 0) {
                interactionHtml = q.options.map((opt, idx) => `
                    <button onclick="selectChallengeAnswer(${currentIdx}, ${idx})" 
                        class="w-full text-left p-4 rounded-xl border-2 transition font-medium mb-3 flex items-center gap-3 relative overflow-hidden
                        ${userAns === idx ? 'bg-orange-50 border-orange-500 text-orange-700 shadow-md' : 'bg-white border-slate-200 hover:border-orange-300 hover:bg-orange-50'}">
                        <span class="w-8 h-8 rounded-full bg-white border border-slate-200 flex items-center justify-center font-bold text-sm text-slate-600 flex-shrink-0 z-10 
                            ${userAns === idx ? 'bg-orange-500 text-white border-orange-500' : ''}">${String.fromCharCode(65+idx)}</span>
                        <span class="z-10">${opt}</span>
                    </button>
                `).join('');
            } else if (q.type === 'jumble' || q.type === 'order_sentences') {
                const correctArr = q.answer || [];
                const currentPlaced = userAns || []; 
                let remaining = [...correctArr];
                currentPlaced.forEach(placedItem => {
                    const idx = remaining.indexOf(placedItem);
                    if (idx > -1) remaining.splice(idx, 1);
                });
                remaining.sort(() => Math.random() - 0.5);
                const itemClass = q.type === 'jumble' ? 'inline-block' : 'block w-full text-left';

                interactionHtml = `
                    <div class="min-h-[60px] p-4 bg-blue-50 border-2 border-dashed border-blue-300 rounded-xl mb-4 flex flex-wrap gap-2 justify-center items-center">
                        ${currentPlaced.length === 0 ? '<span class="text-slate-400 text-sm italic">Ch·ªçn t·ª´ b√™n d∆∞·ªõi...</span>' : ''}
                        ${currentPlaced.map((item, idx) => `
                            <button onclick="removeChallengeJumbleWord(${currentIdx}, ${idx})" class="${itemClass} bg-blue-600 text-white px-3 py-2 rounded-lg font-bold shadow hover:bg-blue-700 animate-in fade-in zoom-in duration-200">
                                ${item} <i data-lucide="x" class="inline w-3 h-3 ml-1 opacity-70"></i>
                            </button>
                        `).join('')}
                    </div>
                    <div class="flex flex-wrap gap-2 justify-center p-4 bg-slate-100 rounded-xl border border-slate-200">
                        ${remaining.map(item => `
                            <button onclick="addChallengeJumbleWord(${currentIdx}, '${item.replace(/'/g, "\\'")}')" class="${itemClass} bg-white border border-slate-300 text-slate-700 px-3 py-2 rounded-lg font-medium shadow-sm hover:border-blue-500 hover:text-blue-600 transition">
                                ${item}
                            </button>
                        `).join('')}
                    </div>
                `;
            } else if (['fib', 'translation', 'listen_write', 'listen_translate'].includes(q.type)) {
                const val = userAns || '';
                interactionHtml = `
                    <div class="mt-4">
                        <input type="text" value="${val}" oninput="captureChallengeInput(${currentIdx}, this.value)" 
                            class="w-full p-4 border-2 border-slate-300 rounded-xl focus:border-orange-500 outline-none text-lg text-center font-bold"
                            placeholder="Nh·∫≠p c√¢u tr·∫£ l·ªùi c·ªßa b·∫°n..." />
                    </div>`;
            } else {
                interactionHtml = `<div class="p-4 bg-yellow-50 text-yellow-700 rounded-xl border border-yellow-200">‚ö†Ô∏è D·∫°ng c√¢u h·ªèi n√†y (${q.type}) s·∫Ω ƒë∆∞·ª£c t√≠nh ƒëi·ªÉm mi·ªÖn ph√≠.</div>`;
            }

            const isLast = currentIdx === total - 1;

            return `
                <div class="max-w-3xl mx-auto bg-white p-6 md:p-8 rounded-3xl shadow-xl fade-in mt-4 relative">
                    <div class="flex justify-between items-center mb-6 border-b pb-4">
                        <div class="flex-1">
                            <div class="flex justify-between text-xs text-slate-500 font-bold mb-1">
                                <span>Ti·∫øn ƒë·ªô</span> <span>${currentIdx + 1}/${total}</span>
                            </div>
                            <div class="h-3 w-full bg-slate-100 rounded-full overflow-hidden">
                                <div class="h-full bg-gradient-to-r from-orange-400 to-red-500 transition-all duration-300" style="width: ${((currentIdx+1)/total)*100}%"></div>
                            </div>
                        </div>
                        
                        <button onclick="exitDoingChallenge()" class="ml-4 text-slate-400 hover:text-red-500 p-2 rounded-full hover:bg-slate-100">
                            <i data-lucide="x" size="24"></i>
                        </button>
                    </div>

                    <div class="mb-8 text-center">
                        <div class="flex items-center justify-center gap-4 mb-6">${audioButtonHtml}</div>
                        ${extraContent}
                        <h2 class="text-xl md:text-2xl font-bold text-slate-800 mb-6 leading-relaxed">${questionText}</h2>
                        <div>${interactionHtml}</div>
                    </div>

                    <div class="flex justify-between pt-4 border-t">
                        <button onclick="navChallenge(-1)" class="px-6 py-3 rounded-xl font-bold text-slate-600 hover:bg-slate-100 flex items-center gap-2 ${currentIdx===0 ? 'invisible':''}">
                            <i data-lucide="arrow-left" size="18"></i> L√πi
                        </button>
                        ${isLast ? 
                            `<button onclick="submitChallengeResult()" class="px-8 py-3 rounded-xl font-bold bg-green-600 text-white hover:bg-green-700 shadow-lg animate-bounce flex items-center gap-2"><i data-lucide="flag" size="18"></i> N·ªôp B√†i</button>` : 
                            `<button onclick="navChallenge(1)" class="px-8 py-3 rounded-xl font-bold bg-blue-600 text-white hover:bg-blue-700 shadow-lg flex items-center gap-2">Ti·∫øp <i data-lucide="arrow-right" size="18"></i></button>`
                        }
                    </div>
                </div>
            `;
        };
        // --- HANDLERS ---

        window.initCreateChallenge = () => {
            state.ui.activeChallenge = { title: '', order: state.data.challenges.length + 1, questions: [] };
            state.ui.challengeMode = 'create';
            renderApp();
        };

        window.editChallenge = (id) => {
            const c = state.data.challenges.find(i => i.id === id);
            if(c) {
                state.ui.activeChallenge = {...c};
                state.ui.challengeMode = 'edit';
                renderApp();
            }
        };

window.saveChallenge = async () => {
            const title = document.getElementById('chal-title').value;
            const order = parseInt(document.getElementById('chal-order').value) || 1;

            if (!title) return showToast("Thi·∫øu t√™n th·ª≠ th√°ch!", "error");
            
            try {
                // [ƒê√É S·ª¨A] L·∫•y tr·ª±c ti·∫øp danh s√°ch c√¢u h·ªèi ƒë√£ ch·ªçn th·ªß c√¥ng
                let questions = state.ui.activeChallenge.questions || [];

                if (questions.length === 0) return showToast("Th·ª≠ th√°ch c·∫ßn c√≥ √≠t nh·∫•t 1 c√¢u h·ªèi!", "error");

                const payload = {
                    title, order, questions,
                    updatedAt: serverTimestamp()
                };

                if (state.ui.challengeMode === 'create') {
                    payload.createdAt = serverTimestamp();
                    payload.createdBy = state.user.uid;
                    await addDoc(getRef('challenges'), payload);
                } else {
                    await updateDoc(doc(db, getPath('challenges'), state.ui.activeChallenge.id), payload);
                }

                showToast("ƒê√£ l∆∞u Th·ª≠ th√°ch!");
                state.ui.challengeMode = 'list';
                renderApp();
            } catch (e) {
                console.error(e);
                showToast("L·ªói l∆∞u: " + e.message, "error");
            }
        };

        window.deleteChallenge = async (id) => {
            if(confirm("B·∫°n ch·∫Øc ch·∫Øn mu·ªën x√≥a th·ª≠ th√°ch n√†y?")) {
                await deleteDoc(doc(db, getPath('challenges'), id));
                showToast("ƒê√£ x√≥a!");
            }
        };

        // --- HANDLERS H·ªåC SINH ---
        
 // --- C·∫¨P NH·∫¨T: B·∫ÆT ƒê·∫¶U TH·ª¨ TH√ÅCH (C√ì TR√ÅO ƒê·ªÄ) ---
// 2. H√†m B·∫Øt ƒë·∫ßu Th·ª≠ th√°ch
window.initDoChallenge = (id) => {
    const c = state.data.challenges.find(i => i.id === id);
    if (!c) return;

    // Tr√°o ƒë·ªÅ
    const shuffledQuestions = window.shuffleQuestionList(c.questions);

    // --- QUAN TR·ªåNG: L∆ØU V√ÄO BI·∫æN TO√ÄN C·ª§C ---
    window.CURRENT_EXAM_SESSION = {
        ...c,
        questions: shuffledQuestions,
        type: 'challenge' // ƒê√°nh d·∫•u l√† th·ª≠ th√°ch
    };
    
    // ƒê·ªìng b·ªô v√†o state c≈© ƒë·ªÉ code c≈© kh√¥ng l·ªói
    state.ui.activeChallenge = window.CURRENT_EXAM_SESSION; 
    
    state.ui.challengeAnswers = {};
    state.ui.challengeQIndex = 0;
    state.ui.challengeMode = 'do';
    
    console.log("üîí ƒê√£ c·ªë ƒë·ªãnh ƒë·ªÅ thi (Th·ª≠ th√°ch):", shuffledQuestions);
    
    renderApp();
};
        window.selectChallengeAnswer = (qIdx, ansIdx) => {
            state.ui.challengeAnswers[qIdx] = ansIdx;
            renderApp();
        };

        window.navChallenge = (delta) => {
            state.ui.challengeQIndex += delta;
            renderApp();
        };

// --- N·ªòP B√ÄI TH·ª¨ TH√ÅCH (ƒê√É S·ª¨A L·ªñI L∆ØU ƒêI·ªÇM S·ªê V√Ä C√ÅC TR∆Ø·ªúNG H·ª¢P KH√ÅC) ---
        window.submitChallengeResult = async () => {
            if(!confirm("N·ªôp b√†i ngay?")) return;
            
            const c = state.ui.activeChallenge;
            let correctCount = 0;
            
            // 1. Logic Ch·∫•m ƒëi·ªÉm
            c.questions.forEach((q, idx) => {
                const userAns = state.ui.challengeAnswers[idx];
                
                if (['fib', 'translation', 'listen_write', 'listen_translate'].includes(q.type)) {
                    if (userAns) {
                        const expected = (q.type === 'translation' ? q.chinese : q.answer).trim().toLowerCase();
                        if (userAns.trim().toLowerCase() === expected) correctCount++;
                    }
                } else if (q.type === 'jumble' || q.type === 'order_sentences') {
                    if (Array.isArray(userAns) && Array.isArray(q.answer)) {
                        if (userAns.join(' ').trim() === q.answer.join(' ').trim()) correctCount++;
                    }
                } else {
                    if(userAns === q.correct) correctCount++;
                }
            });

            const score = Math.round((correctCount / c.questions.length) * 100);
            const isPassed = score >= 80;
            let isFirstTime = false;
            
            // 2. L∆∞u k·∫øt qu·∫£ v√†o Database
            if (isPassed) {
                const userRef = doc(db, getPath('users'), state.user.uid);
                const completed = state.profile.completedChallenges || [];
                isFirstTime = !completed.includes(c.id);
                
                // Chu·∫©n b·ªã d·ªØ li·ªáu: D√πng c·∫•u tr√∫c l·ªìng nhau ƒë·ªÉ setDoc v·ªõi merge: true ho·∫°t ƒë·ªông
                const updateData = {
                    challengeScores: {
                        [c.id]: score // L∆ØU ƒêI·ªÇM B√ÄI THI C·ª§ TH·ªÇ
                    }
                };

                // N·∫øu l√† l·∫ßn ƒë·∫ßu v∆∞·ª£t qua -> C·ªông ƒëi·ªÉm, Streak v√† th√™m v√†o completedChallenges
                if (isFirstTime) {
                    updateData.points = increment(50);
                    updateData.streak = increment(1);
                    updateData.completedChallenges = arrayUnion(c.id);
                }

                try {
                    // S·ª≠ d·ª•ng setDoc v·ªõi merge: true ƒë·ªÉ ƒë·∫£m b·∫£o t·∫°o tr∆∞·ªùng challengeScores n·∫øu ch∆∞a c√≥
                    await setDoc(userRef, updateData, { merge: true });
                } catch(e) { 
                    console.error("L·ªói l∆∞u ƒëi·ªÉm:", e);
                    showToast("L·ªói k·∫øt n·ªëi khi l∆∞u ƒëi·ªÉm. (Ki·ªÉm tra Firebase Rules)", "error");
                }
            }
            
            // 3. Hi·ªÉn th·ªã Modal K·∫øt qu·∫£
            state.ui.challengeResult = {
                challengeId: c.id,
                score: score,
                correctCount: correctCount,
                totalQuestions: c.questions.length,
                passed: isPassed,
                isFirstTime: isFirstTime
            };
            
            renderApp();
        };
        // --- HANDLER QU·∫¢N TR·ªä (RESET) ---
        window.resetStudentProgress = async () => {
            const email = document.getElementById('reset-student-email').value.trim();
            if(!email) return showToast("Nh·∫≠p email h·ªçc sinh", "error");
            
            // 1. T√¨m user id theo email (C·∫ßn query, nh∆∞ng ·ªü ƒë√¢y ta loop local users data cho nhanh n·∫øu ƒë√£ load)
            const targetUser = state.data.users.find(u => u.email === email);
            
            if (!targetUser) return showToast("Kh√¥ng t√¨m th·∫•y h·ªçc sinh n√†y trong h·ªá th·ªëng", "error");
            
            if(confirm(`Reset to√†n b·ªô ti·∫øn ƒë·ªô Th·ª≠ th√°ch c·ªßa ${targetUser.name}?`)) {
                try {
                    await updateDoc(doc(db, getPath('users'), targetUser.uid), {
                        streak: 0,
                        completedChallenges: []
                    });
                    showToast("ƒê√£ reset th√†nh c√¥ng!");
                } catch(e) {
                    showToast("L·ªói: " + e.message, "error");
                }
            }
        };
        
       window.viewChallengeStats = (id) => {
             state.ui.viewingChallengeStats = id;
             renderApp();
        };

        window.closeChallengeStats = () => {
            state.ui.viewingChallengeStats = null;
            renderApp();
        };
// --- GIAO DI·ªÜN K·∫æT QU·∫¢ TH·ª¨ TH√ÅCH (CHALLENGE RESULT MODAL) ---
        const renderChallengeResultModal = () => {
            const res = state.ui.challengeResult;
            if (!res) return '';

            const isPassed = res.passed;
            const scoreColor = isPassed ? 'text-green-600' : 'text-red-600';
            const iconHtml = isPassed 
                ? `<div class="w-24 h-24 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4 animate-bounce"><span class="text-6xl">üèÜ</span></div>`
                : `<div class="w-24 h-24 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4"><span class="text-6xl">üò¢</span></div>`;
            
            const title = isPassed ? "HO√ÄN TH√ÄNH!" : "CH∆ØA ƒê·∫†T";
            const subText = isPassed 
                ? "Xu·∫•t s·∫Øc! B·∫°n ƒë√£ ch·ª©ng minh ƒë∆∞·ª£c nƒÉng l·ª±c c·ªßa m√¨nh." 
                : "ƒê·ª´ng n·∫£n l√≤ng! H√£y √¥n t·∫≠p l·∫°i v√† th·ª≠ s·ª©c l·∫ßn n·ªØa nh√©.";

            return `
                <div id="challenge-result-modal" class="fixed inset-0 bg-slate-900 bg-opacity-90 flex items-center justify-center z-[70] p-4 fade-in">
                    <div class="bg-white rounded-3xl shadow-2xl w-full max-w-md p-8 text-center relative overflow-hidden transform transition-all scale-100 animate-bounce-in">
                        
                        <div class="absolute top-0 left-0 w-full h-3 ${isPassed ? 'bg-gradient-to-r from-green-400 to-blue-500' : 'bg-gradient-to-r from-red-500 to-orange-500'}"></div>
                        
                        <div class="mt-4">
                            ${iconHtml}
                            <h2 class="text-2xl md:text-3xl font-black text-slate-800 mb-2 uppercase">${title}</h2>
                            <p class="text-slate-500 text-sm mb-6">${subText}</p>
                        </div>

                        <div class="bg-slate-50 border border-slate-200 rounded-2xl p-6 mb-6">
                            <p class="text-xs font-bold text-slate-400 uppercase tracking-widest mb-1">ƒêi·ªÉm s·ªë c·ªßa b·∫°n</p>
                            <div class="text-5xl font-black ${scoreColor} mb-2">${res.score}</div>
                            <p class="text-sm font-bold text-slate-600">K·∫øt qu·∫£: ${res.correctCount}/${res.totalQuestions} c√¢u ƒë√∫ng</p>
                            ${!isPassed ? `<p class="text-xs text-red-500 mt-2 font-medium"><i data-lucide="alert-circle" size="12" class="inline"></i> C·∫ßn ƒë·∫°t t·ªëi thi·ªÉu 80 ƒëi·ªÉm ƒë·ªÉ qua m√†n</p>` : ''}
                        </div>

                        ${isPassed && res.isFirstTime ? `
                        <div class="flex justify-center gap-4 mb-8">
                            <div class="px-4 py-2 bg-yellow-50 text-yellow-700 border border-yellow-200 rounded-lg text-sm font-bold flex items-center gap-1">
                                <i data-lucide="zap" size="16" class="fill-yellow-500 text-yellow-500"></i> +1 Streak
                            </div>
                            <div class="px-4 py-2 bg-blue-50 text-blue-700 border border-blue-200 rounded-lg text-sm font-bold flex items-center gap-1">
                                <i data-lucide="star" size="16" class="fill-blue-500 text-blue-500"></i> +50 ƒêi·ªÉm
                            </div>
                        </div>` : ''}

                        <div class="flex flex-col gap-3">
                            ${!isPassed ? `
                                <button onclick="closeChallengeResult(); initDoChallenge('${res.challengeId}')" 
                                    class="w-full bg-orange-500 hover:bg-orange-600 text-white py-3 rounded-xl font-bold text-lg shadow-lg transition">
                                    <i data-lucide="rotate-ccw" class="inline-block mr-2" size="20"></i> L√†m l·∫°i ngay
                                </button>
                            ` : ''}
                            <button onclick="closeChallengeResult()" 
                                class="w-full bg-slate-100 hover:bg-slate-200 text-slate-700 py-3 rounded-xl font-bold text-lg transition">
                                Quay v·ªÅ Danh s√°ch
                            </button>
                        </div>
                    </div>
                </div>
            `;
        };
        
        window.closeChallengeResult = () => {
            state.ui.challengeResult = null;
            state.ui.challengeMode = 'list';
            renderApp();
        };
// --- H√ÄM M·ªöI: L∆ØU INPUT CHO TH·ª¨ TH√ÅCH ---
        window.captureChallengeInput = (qIdx, value) => {
            state.ui.challengeAnswers[qIdx] = value;
            // Kh√¥ng c·∫ßn renderApp() m·ªói l·∫ßn g√µ ƒë·ªÉ tr√°nh m·∫•t focus, ch·ªâ l∆∞u state
        };
// --- HANDLERS CHO TH·ª¨ TH√ÅCH (ƒê√É C·∫¨P NH·∫¨T) ---

        // 1. Th√™m t·ª´ v√†o √¥ tr·∫£ l·ªùi (cho Jumble/Order)
        window.addChallengeJumbleWord = (qIdx, word) => {
            const currentArr = state.ui.challengeAnswers[qIdx] || [];
            state.ui.challengeAnswers[qIdx] = [...currentArr, word];
            renderApp(); // Render l·∫°i ƒë·ªÉ c·∫≠p nh·∫≠t UI
        };

        // 2. X√≥a t·ª´ kh·ªèi √¥ tr·∫£ l·ªùi
        window.removeChallengeJumbleWord = (qIdx, idxToRemove) => {
            const currentArr = state.ui.challengeAnswers[qIdx] || [];
            currentArr.splice(idxToRemove, 1);
            state.ui.challengeAnswers[qIdx] = currentArr;
            renderApp();
        };

// --- N·ªòP B√ÄI TH·ª¨ TH√ÅCH (PHI√äN B·∫¢N CHU·∫®N: L∆ØU ƒêI·ªÇM CHI TI·∫æT) ---
        window.submitChallengeResult = async () => {
            if(!confirm("N·ªôp b√†i ngay?")) return;
            
            const c = state.ui.activeChallenge;
            let correctCount = 0;
            
            // 1. Ch·∫•m ƒëi·ªÉm
            c.questions.forEach((q, idx) => {
                const userAns = state.ui.challengeAnswers[idx];
                
                if (['fib', 'translation', 'listen_write', 'listen_translate'].includes(q.type)) {
                    if (userAns) {
                        const expected = (q.type === 'translation' ? q.chinese : q.answer).trim().toLowerCase();
                        if (userAns.trim().toLowerCase() === expected) correctCount++;
                    }
                } else if (q.type === 'jumble' || q.type === 'order_sentences') {
                    if (Array.isArray(userAns) && Array.isArray(q.answer)) {
                        if (userAns.join(' ').trim() === q.answer.join(' ').trim()) correctCount++;
                    }
                } else {
                    if(userAns === q.correct) correctCount++;
                }
            });

            const score = Math.round((correctCount / c.questions.length) * 100);
            const isPassed = score >= 80;
            let isFirstTime = false;
            
            // 2. L∆∞u v√†o Database (S·ª¨A L·ªñI T·∫†I ƒê√ÇY)
            if (isPassed) {
                const userRef = doc(db, getPath('users'), state.user.uid);
                const completed = state.profile.completedChallenges || [];
                isFirstTime = !completed.includes(c.id);
                
                // D·ªØ li·ªáu c·∫ßn c·∫≠p nh·∫≠t: Lu√¥n c·∫≠p nh·∫≠t ƒëi·ªÉm s·ªë m·ªõi nh·∫•t c·ªßa b√†i thi n√†y
                const updateData = {
                    challengeScores: {
                        [c.id]: score 
                    }
                };

                // N·∫øu l√† l·∫ßn ƒë·∫ßu ti√™n v∆∞·ª£t qua -> C·ªông ƒëi·ªÉm t·ªïng v√† Streak
                if (isFirstTime) {
                    updateData.points = increment(50);
                    updateData.streak = increment(1);
                    updateData.completedChallenges = arrayUnion(c.id);
                }

                try {
                    // D√πng setDoc v·ªõi { merge: true } ƒë·ªÉ ƒë·∫£m b·∫£o kh√¥ng b·ªã l·ªói n·∫øu tr∆∞·ªùng challengeScores ch∆∞a c√≥
                    await setDoc(userRef, updateData, { merge: true });
                } catch(e) { 
                    console.error("L·ªói l∆∞u ƒëi·ªÉm:", e);
                    showToast("L·ªói l∆∞u ƒëi·ªÉm (Ki·ªÉm tra k·∫øt n·ªëi/Rule).", "error");
                }
            }
            
            state.ui.challengeResult = {
                challengeId: c.id,
                score: score,
                correctCount: correctCount,
                totalQuestions: c.questions.length,
                passed: isPassed,
                isFirstTime: isFirstTime
            };
            
            renderApp();
        };
// --- GIAO DI·ªÜN MODAL TH·ªêNG K√ä TH·ª¨ TH√ÅCH (ƒê√É S·ª¨A: HIGHLIGHT B·∫¢N TH√ÇN) ---
        const renderChallengeStatsModal = () => {
            const challengeId = state.ui.viewingChallengeStats;
            if (!challengeId) return '';

            const challenge = state.data.challenges.find(c => c.id === challengeId);
            if (!challenge) return '';

            // L·ªçc h·ªçc sinh ƒë√£ ho√†n th√†nh
            const passedStudents = state.data.users.filter(u => (u.completedChallenges || []).includes(challengeId));
            
            const getChalScore = (u) => (u.challengeScores && u.challengeScores[challengeId]) ? u.challengeScores[challengeId] : 0;

            // S·∫Øp x·∫øp: ƒêi·ªÉm b√†i thi cao x·∫øp tr∆∞·ªõc
            passedStudents.sort((a, b) => {
                const scoreA = getChalScore(a);
                const scoreB = getChalScore(b);
                if (scoreB !== scoreA) return scoreB - scoreA;
                return a.name.localeCompare(b.name);
            });

            const rows = passedStudents.map((u, idx) => {
                let rankColor = 'bg-slate-100 text-slate-600';
                let rankIcon = `#${idx + 1}`;
                if (idx === 0) { rankColor = 'bg-yellow-100 text-yellow-700 border-yellow-200'; rankIcon = 'ü•á'; }
                if (idx === 1) { rankColor = 'bg-slate-200 text-slate-700 border-slate-300'; rankIcon = 'ü•à'; }
                if (idx === 2) { rankColor = 'bg-orange-100 text-orange-800 border-orange-200'; rankIcon = 'ü•â'; }

                const userClass = state.data.classes.find(c => (c.studentIds || []).includes(u.uid));
                const className = userClass ? userClass.title : 'Ch∆∞a v√†o l·ªõp';
                const score = getChalScore(u);
                
                // [M·ªöI] Ki·ªÉm tra xem c√≥ ph·∫£i l√† ch√≠nh m√¨nh kh√¥ng
                const isMe = u.uid === state.user.uid;
                const rowHighlight = isMe ? 'bg-blue-50 border-2 border-blue-200 shadow-sm' : 'border-b hover:bg-slate-50';

                return `
                    <tr class="${rowHighlight} transition">
                        <td class="py-3 pl-4 w-16 text-center">
                            <div class="w-8 h-8 rounded-full ${rankColor} border flex items-center justify-center font-bold text-sm mx-auto">
                                ${rankIcon}
                            </div>
                        </td>
                        <td class="py-3">
                            <div class="flex items-center gap-3">
                                ${renderAvatar(u, 'w-8 h-8', 'text-xs')}
                                <div>
                                    <p class="font-bold ${isMe ? 'text-blue-700' : 'text-slate-700'} text-sm">
                                        ${u.name} ${isMe ? '(B·∫°n)' : ''}
                                    </p>
                                    <p class="text-xs text-slate-500 font-medium flex items-center gap-1 mt-0.5">
                                        <i data-lucide="graduation-cap" size="10"></i> ${className}
                                    </p>
                                </div>
                            </div>
                        </td>
                        <td class="py-3 pr-6 text-right">
                            <span class="font-mono font-bold ${score >= 80 ? 'text-green-600 bg-green-50' : 'text-orange-600 bg-orange-50'} px-2 py-1 rounded text-sm">
                                ${score} ƒëi·ªÉm
                            </span>
                        </td>
                    </tr>
                `;
            }).join('');

            return `
                <div id="challenge-stats-modal" class="fixed inset-0 bg-slate-900 bg-opacity-80 flex items-center justify-center z-[80] p-4 fade-in">
                    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-2xl overflow-hidden flex flex-col max-h-[90vh]">
                        <div class="p-5 border-b bg-slate-50 flex justify-between items-center sticky top-0 z-10">
                            <div>
                                <h3 class="text-lg font-bold text-slate-800 flex items-center gap-2">
                                    <i data-lucide="trophy" class="text-yellow-500"></i>
                                    BXH: ${challenge.title}
                                </h3>
                                <p class="text-xs text-slate-500 mt-1">ƒê√£ c√≥ <span class="font-bold text-green-600">${passedStudents.length}</span> chi·∫øn binh v∆∞·ª£t qua</p>
                            </div>
                            <button onclick="closeChallengeStats()" class="p-2 bg-white border border-slate-200 rounded-full hover:bg-red-50 hover:text-red-500 transition shadow-sm">
                                <i data-lucide="x" size="20"></i>
                            </button>
                        </div>
                        <div class="overflow-y-auto flex-1 p-0">
                            <table class="w-full">
                                <thead class="bg-slate-100 text-xs text-slate-500 uppercase font-bold sticky top-0 shadow-sm">
                                    <tr>
                                        <th class="py-3 pl-4 text-center">H·∫°ng</th>
                                        <th class="py-3 text-left">H·ªçc sinh</th>
                                        <th class="py-3 pr-6 text-right">ƒêi·ªÉm s·ªë</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${rows || `<tr><td colspan="3" class="text-center py-10 text-slate-400 italic">Ch∆∞a c√≥ ai v∆∞·ª£t qua th·ª≠ th√°ch n√†y. H√£y l√† ng∆∞·ªùi ƒë·∫ßu ti√™n!</td></tr>`}
                                </tbody>
                            </table>
                        </div>
                        <div class="p-4 border-t bg-slate-50 text-right">
                            <button onclick="closeChallengeStats()" class="bg-slate-200 hover:bg-slate-300 text-slate-700 px-5 py-2 rounded-lg font-bold text-sm transition">ƒê√≥ng</button>
                        </div>
                    </div>
                </div>
            `;
        };
// --- H√ÄM M·ªöI: ƒê√ìNG FORM T·∫†O/S·ª¨A TH·ª¨ TH√ÅCH (FIX L·ªñI N√öT ƒê√ìNG) ---
        window.closeChallengeForm = () => {
            state.ui.challengeMode = 'list';
            // Kh√¥ng c·∫ßn reset activeChallenge ngay ƒë·ªÉ tr√°nh l·ªói render, ch·ªâ c·∫ßn chuy·ªÉn mode
            renderApp();
        };

        // --- H√ÄM M·ªöI: THO√ÅT KH·ªéI CH·∫æ ƒê·ªò L√ÄM B√ÄI (FIX L·ªñI N√öT THO√ÅT) ---
        window.exitDoingChallenge = () => {
            if (confirm('Tho√°t s·∫Ω m·∫•t to√†n b·ªô ti·∫øn ƒë·ªô b√†i n√†y. Ch·∫Øc ch·∫Øn tho√°t?')) {
                state.ui.challengeMode = 'list';
                state.ui.activeChallenge = null;
                state.ui.challengeAnswers = {};
                renderApp();
            }
        };
// --- H√ÄM M·ªöI: THO√ÅT KH·ªéI CH·∫æ ƒê·ªò L√ÄM B√ÄI (G·∫ÆN V√ÄO WINDOW) ---
        window.exitDoingChallenge = () => {
            if (confirm('Tho√°t s·∫Ω m·∫•t to√†n b·ªô ti·∫øn ƒë·ªô b√†i n√†y. Ch·∫Øc ch·∫Øn tho√°t?')) {
                // Reset tr·∫°ng th√°i l√†m b√†i
                state.ui.activeChallenge = null;
                state.ui.challengeAnswers = {};
                state.ui.challengeQIndex = 0;
                
                // Quay v·ªÅ danh s√°ch
                state.ui.challengeMode = 'list';
                renderApp();
            }
        };
// --- GIAO DI·ªÜN GAME CENTER (STYLE GI·ªêNG H·ªÜT _VONGQUAY.HTML) ---
// --- GIAO DI·ªÜN GAME CENTER (ƒê√É KH√îI PH·ª§C TH√ÄNH T√çCH/HUY HI·ªÜU) ---
        const renderGameCenter = () => {
            const userLvl = getUserLevel(state.profile.points || 0);
            const inventory = state.profile.inventory || [];
            
            // [KH√îI PH·ª§C] L·∫•y danh s√°ch huy hi·ªáu ƒë√£ ƒë·∫°t ƒë∆∞·ª£c
            const myBadges = GAME_CONFIG.BADGES.filter(b => b.condition(state.profile));

            // Shop Items
            const shopHtml = GAME_CONFIG.SHOP_ITEMS.map(item => {
                const canAfford = (state.profile.points || 0) >= item.price;
                const isOwned = inventory.includes(item.id) && item.type !== 'ticket';
                return `
                <div class="bg-slate-50 p-4 rounded-2xl border border-slate-200 flex flex-col items-center text-center transition hover:shadow-md">
                    <div class="text-4xl mb-2">${item.icon}</div>
                    <h4 class="font-bold text-slate-700 text-sm">${item.name}</h4>
                    <p class="text-indigo-600 font-bold mb-3 text-sm">${item.price} ƒëi·ªÉm</p>
                    <button onclick="${isOwned ? '' : `buyItem('${item.id}')`}" 
                        class="w-full py-2 rounded-xl font-bold text-xs transition ${isOwned ? 'bg-slate-200 text-slate-400 cursor-not-allowed' : canAfford ? 'bg-indigo-600 text-white hover:bg-indigo-700 shadow-md hover:shadow-lg' : 'bg-slate-200 text-slate-400 cursor-not-allowed'}"
                        ${!canAfford || isOwned ? 'disabled' : ''}>
                        ${isOwned ? 'ƒê√£ s·ªü h·ªØu' : 'Mua ngay'}
                    </button>
                </div>`;
            }).join('');

            return `
                <div class="max-w-5xl mx-auto fade-in pb-20 font-['Inter']">
                    
                    <div class="bg-gradient-to-br from-indigo-500 via-purple-500 to-pink-500 rounded-[2.5rem] p-6 md:p-8 text-white shadow-2xl mb-8 relative overflow-hidden">
                        <div class="absolute top-0 right-0 w-64 h-64 bg-white opacity-10 rounded-full blur-3xl -mr-16 -mt-16 pointer-events-none"></div>
                        
                        <div class="relative z-10">
                            <div class="flex flex-col md:flex-row items-center justify-between gap-6 mb-8 border-b border-white/20 pb-6">
                                <div class="flex items-center gap-5">
                                    <div class="relative">
                                        ${renderAvatar(state.profile, 'w-20 h-20', 'text-3xl')}
                                        <div class="absolute -bottom-2 -right-2 bg-yellow-400 text-yellow-900 text-xs font-black px-3 py-1 rounded-full shadow-lg border-2 border-white">
                                            LV.${userLvl.name}
                                        </div>
                                    </div>
                                    <div>
                                        <h2 class="text-3xl font-black tracking-tight">${state.profile.name}</h2>
                                        <div class="flex gap-2 mt-2">
                                            <span class="bg-black/20 backdrop-blur-md px-3 py-1 rounded-full text-xs font-bold border border-white/10 flex items-center gap-1">
                                                <i data-lucide="ticket" size="14"></i> V√©: <span id="ticket-count">${state.profile.luckyTickets || 0}</span>
                                            </span>
                                            <span class="bg-black/20 backdrop-blur-md px-3 py-1 rounded-full text-xs font-bold border border-white/10 flex items-center gap-1">
                                                <i data-lucide="trophy" size="14"></i> ƒêi·ªÉm: ${state.profile.points || 0}
                                            </span>
                                        </div>
                                    </div>
                                </div>
                                
                                <button onclick="buyItem('ticket_x1')" class="bg-white text-indigo-600 px-6 py-3 rounded-2xl font-bold shadow-lg hover:bg-indigo-50 transition transform hover:-translate-y-1 active:scale-95 flex items-center gap-2">
                                    <i data-lucide="plus-circle" size="18"></i> Mua th√™m v√©
                                </button>
                            </div>

                            <div>
                                <p class="text-xs font-bold uppercase tracking-widest opacity-80 mb-3 flex items-center gap-2">
                                    <i data-lucide="award" size="16"></i> B·ªô s∆∞u t·∫≠p th√†nh t√≠ch (${myBadges.length})
                                </p>
                                <div class="flex flex-wrap gap-2">
                                    ${myBadges.length > 0 ? myBadges.map(b => `
                                        <div class="bg-white/10 backdrop-blur-sm border border-white/20 px-3 py-2 rounded-xl flex items-center gap-2 hover:bg-white/20 transition cursor-help" title="${b.desc}">
                                            <span class="text-xl">${b.icon}</span> 
                                            <span class="text-sm font-bold">${b.name}</span>
                                        </div>
                                    `).join('') : `
                                        <div class="text-sm italic opacity-60 bg-black/10 px-4 py-2 rounded-xl inline-block">
                                            Ch∆∞a c√≥ huy hi·ªáu n√†o. H√£y chƒÉm ch·ªâ h·ªçc t·∫≠p ƒë·ªÉ m·ªü kh√≥a!
                                        </div>
                                    `}
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
                        
                        <div class="lg:col-span-5">
                            <div class="bg-white p-2 rounded-[2.5rem] shadow-2xl border border-slate-100 relative">
                                <div class="bg-slate-50 rounded-[2rem] p-6 flex flex-col items-center justify-center min-h-[450px] relative overflow-hidden">
                                    
                                    <div class="absolute top-6 left-1/2 -translate-x-1/2 z-20 drop-shadow-xl">
                                        <svg width="40" height="50" viewBox="0 0 40 50">
                                            <path d="M20 50 L5 10 Q20 0 35 10 Z" fill="#EF4444" stroke="white" stroke-width="3"/>
                                        </svg>
                                    </div>

                                         <div class="relative w-full max-w-[320px] aspect-square mb-8 mt-4 mx-auto">
                                           <canvas id="wheel" width="640" height="640" class="w-full h-full"></canvas>
                                           <button id="spin-btn" onclick="playLuckyDraw()" 
                                            class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-[25%] h-[25%] bg-white rounded-full shadow-[0_0_25px_rgba(0,0,0,0.15)] border-4 border-slate-100 flex items-center justify-center z-30 active:scale-95 hover:scale-105 transition group cursor-pointer">
                                            <span class="font-black text-[clamp(10px,2vw,14px)] uppercase text-slate-800 tracking-wider group-hover:text-indigo-600 transition">QUAY</span>
                                        </button>
                                    </div>

                                    <p class="text-slate-400 text-sm font-bold tracking-wide uppercase">Ch√∫c b·∫°n may m·∫ØnüçÄ</p>
                                </div>
                            </div>
                        </div>

<div class="lg:col-span-7 space-y-6"> <div class="bg-white p-6 rounded-3xl shadow-sm border border-slate-200 relative overflow-hidden group">
        <div class="absolute right-0 top-0 w-32 h-32 bg-cyan-100 rounded-full blur-3xl -mr-16 -mt-16 opacity-50"></div>
        
        <h3 class="font-bold text-slate-700 mb-4 flex items-center gap-2 relative z-10">
            <i data-lucide="gamepad-2" class="text-cyan-600"></i> Mini Games
        </h3>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 relative z-10">
            <div onclick="openGameModal('hanziyu.html')" 
                 class="bg-gradient-to-br from-cyan-500 to-blue-600 p-4 rounded-2xl shadow-lg text-white cursor-pointer hover:scale-[1.02] active:scale-95 transition-all flex items-center gap-4 relative overflow-hidden">
                
                <div class="w-12 h-12 bg-white/20 backdrop-blur-sm rounded-xl flex items-center justify-center text-2xl shadow-inner border border-white/10">
                    üåßÔ∏è
                </div>
                
                <div class="flex-1">
                    <h4 class="font-bold text-lg leading-tight">M∆∞a H√°n T·ª±</h4>
                    <p class="text-cyan-100 text-xs mt-1">Luy·ªán ph·∫£n x·∫° t·ª´ v·ª±ng</p>
                </div>

                <div class="bg-white text-cyan-600 p-2 rounded-full shadow-sm">
                    <i data-lucide="play" class="w-4 h-4 fill-current"></i>
                </div>
            </div>
            
            </div>
    </div>
    <div class="bg-white p-6 rounded-3xl shadow-sm border border-slate-200">
        <h3 class="font-bold text-slate-700 mb-4 flex items-center gap-2">
            <i data-lucide="shopping-bag" class="text-indigo-600"></i> C·ª≠a h√†ng v·∫≠t ph·∫©m
        </h3>
        <div class="grid grid-cols-2 sm:grid-cols-3 gap-4">
            ${shopHtml}
        </div>
    </div>

</div>

                    </div>

                    <div id="result-modal" class="fixed inset-0 z-[100] flex items-center justify-center bg-black/60 backdrop-blur-sm hidden opacity-0 transition-all duration-300">
                        <div class="bg-white rounded-3xl p-8 max-w-sm w-full text-center transform scale-90 transition-all duration-300 shadow-2xl relative m-4">
                            <div class="w-24 h-24 bg-yellow-100 rounded-full flex items-center justify-center mx-auto mb-6 text-5xl shadow-inner animate-bounce" id="modal-icon">üéÅ</div>
                            <h3 class="text-2xl font-black text-slate-800 mb-2">K·∫øt Qu·∫£</h3>
                            <p class="text-slate-500 font-medium mb-6">B·∫°n v·ª´a quay v√†o √¥:</p>
                            <div class="py-4 px-6 bg-slate-50 rounded-2xl border-2 border-dashed border-slate-200 mb-8">
                                <span class="text-3xl font-black text-indigo-600" id="modal-text">100 ƒêi·ªÉm</span>
                            </div>
                            <button onclick="closeResultModal()" class="w-full bg-slate-900 text-white font-bold py-4 rounded-2xl hover:bg-slate-800 transition shadow-lg hover:shadow-xl active:scale-95">
                                Tuy·ªát v·ªùi!
                            </button>
                        </div>
                    </div>

                    <img src="" onerror="initNewWheel()" class="hidden">
                </div>
            `;
        };
// --- HANDLERS GAME CENTER ---
        
        window.buyItem = async (itemId) => {
            const item = GAME_CONFIG.SHOP_ITEMS.find(i => i.id === itemId);
            if (!item) return;
            
            const myPoints = state.profile.points || 0;
            if (myPoints < item.price) return showToast("B·∫°n kh√¥ng ƒë·ªß ƒëi·ªÉm!", "error");
            
            if (!confirm(`B·∫°n mu·ªën mua "${item.name}" v·ªõi gi√° ${item.price} ƒëi·ªÉm?`)) return;

            try {
                const updatePayload = {
                    points: increment(-item.price)
                };
                
                if (item.type === 'ticket') {
                    updatePayload.luckyTickets = increment(item.amount);
                } else {
                    updatePayload.inventory = arrayUnion(itemId);
                }

                await updateDoc(doc(db, getPath('users'), state.user.uid), updatePayload);
                showToast(`ƒê√£ mua th√†nh c√¥ng: ${item.name}`);
                // Listener s·∫Ω t·ª± render l·∫°i
            } catch (e) {
                showToast("L·ªói giao d·ªãch: " + e.message, "error");
            }
        };


// --- H√ÄM H·ªñ TR·ª¢: M·ªû KH√ìA AVATAR NG·∫™U NHI√äN ---
        window.unlockRandomAvatar = async () => {
            const myAvatars = state.profile.unlockedAvatars || GAME_CONFIG.INITIAL_AVATARS;
            
            // T√¨m c√°c avatar ch∆∞a s·ªü h·ªØu
            const locked = GAME_CONFIG.ALL_AVATARS.filter(a => !myAvatars.includes(a));
            
            if (locked.length === 0) return null; // ƒê√£ s∆∞u t·∫≠p ƒë·ªß b·ªô
            
            // Ch·ªçn ng·∫´u nhi√™n 1 c√°i
            const newAvatar = locked[Math.floor(Math.random() * locked.length)];
            
            try {
                // C·∫≠p nh·∫≠t Database
                await updateDoc(doc(db, getPath('users'), state.user.uid), {
                    unlockedAvatars: arrayUnion(newAvatar)
                });
                return newAvatar;
            } catch (e) {
                console.error("L·ªói m·ªü kh√≥a avatar:", e);
                return null;
            }
        };
// --- H√ÄM M·ªöI: THAM GIA PH√íNG C√îNG KHAI T·ª™ DANH S√ÅCH ---
        window.joinPublicMatch = async (matchId) => {
            if (!confirm("B·∫°n mu·ªën tham gia tr·∫≠n ƒë·∫•u n√†y?")) return;

            try {
                // Ki·ªÉm tra l·∫°i xem ph√≤ng c√≤n tr·ªëng kh√¥ng (ƒë·ªÅ ph√≤ng ng∆∞·ªùi kh√°c v√†o tr∆∞·ªõc)
                const matchRef = doc(db, getPath('matches'), matchId);
                
                await runTransaction(db, async (transaction) => {
                    const matchDoc = await transaction.get(matchRef);
                    if (!matchDoc.exists()) throw "Ph√≤ng kh√¥ng t·ªìn t·∫°i!";
                    
                    const matchData = matchDoc.data();
                    if (matchData.player2) throw "Ph√≤ng ƒë√£ ƒë·ªß ng∆∞·ªùi!";
                    if (matchData.status !== 'waiting') throw "Tr·∫≠n ƒë·∫•u ƒë√£ b·∫Øt ƒë·∫ßu ho·∫∑c k·∫øt th√∫c!";

                    // C·∫≠p nh·∫≠t m√¨nh l√† Player 2
                    transaction.update(matchRef, {
                        player2: { uid: state.user.uid, name: state.profile.name, score: 0 }
                    });
                });

                showToast("ƒêang v√†o ph√≤ng...", "success");
                // Kh√¥ng c·∫ßn set UI th·ªß c√¥ng, Listener s·∫Ω t·ª± ƒë·ªông chuy·ªÉn sang m√†n h√¨nh ch·ªù khi th·∫•y data thay ƒë·ªïi
            } catch (e) {
                console.error("Join Public Match Error:", e);
                // X·ª≠ l√Ω th√¥ng b√°o l·ªói ƒë·∫πp h∆°n n·∫øu l√† string custom
                const msg = typeof e === 'string' ? e : e.message;
                showToast("L·ªói v√†o ph√≤ng: " + msg, "error");
            }
        };
// --- C·∫§U H√åNH V√íNG QUAY ---
        const WHEEL_CONFIG = {
            segments: [
                { text: "10 üèÜ",  value: 10,  type: "point",  bgColor: "#FF9F43", textColor: "#FFF" }, // Cam
                { text: "20 üèÜ",  value: 20,  type: "point",  bgColor: "#54a0ff", textColor: "#FFF" }, // Xanh d∆∞∆°ng
                { text: "100 üèÜ", value: 100, type: "point",  bgColor: "#feca57", textColor: "#d35400" }, // V√†ng (Hi·∫øm)
                { text: "Toangüò¢", value: 0,   type: "point",  bgColor: "#ee5253", textColor: "#FFF" }, // ƒê·ªè
                { text: "1 V√© üéüÔ∏è",  value: 1,   type: "ticket", bgColor: "#00d2d3", textColor: "#FFF" }  // Xanh ng·ªçc
            ],
            currentAngle: 0, // G√≥c hi·ªán t·∫°i
            isSpinning: false
        };

        // H√†m kh·ªüi t·∫°o v√† v·∫Ω v√≤ng quay tƒ©nh
        window.initWheel = () => {
            const canvas = document.getElementById('wheel-canvas');
            if (!canvas) return;
            const ctx = canvas.getContext('2d');
            const size = canvas.width;
            const center = size / 2;
            const radius = size / 2 - 10; // Ch·ª´a l·ªÅ
            const len = WHEEL_CONFIG.segments.length;
            const arc = (2 * Math.PI) / len;

            ctx.clearRect(0, 0, size, size);

            // V·∫Ω t·ª´ng m√∫i
            WHEEL_CONFIG.segments.forEach((seg, i) => {
                const angle = WHEEL_CONFIG.currentAngle + i * arc;
                
                ctx.beginPath();
                ctx.fillStyle = seg.bgColor;
                ctx.moveTo(center, center);
                ctx.arc(center, center, radius, angle, angle + arc);
                ctx.lineTo(center, center);
                ctx.fill();
                ctx.stroke();

                // V·∫Ω Text
                ctx.save();
                ctx.translate(center, center);
                ctx.rotate(angle + arc / 2);
                ctx.textAlign = "right";
                ctx.fillStyle = seg.textColor;
                ctx.font = "bold 32px sans-serif";
                ctx.fillText(seg.text, radius - 40, 10);
                
                // V·∫Ω icon nh·ªè (n·∫øu c·∫ßn - v√≠ d·ª• d·∫•u ch·∫•m tr√≤n)
                ctx.beginPath();
                ctx.arc(radius - 20, 0, 5, 0, 2 * Math.PI);
                ctx.fillStyle = "rgba(255,255,255,0.5)";
                ctx.fill();

                ctx.restore();
            });
            
            // V·∫Ω vi·ªÅn ngo√†i cho ƒë·∫πp
            ctx.beginPath();
            ctx.arc(center, center, radius, 0, 2*Math.PI);
            ctx.lineWidth = 10;
            ctx.strokeStyle = "white";
            ctx.stroke();
            ctx.lineWidth = 1; // Reset
        };
        
        // H√†m c·∫≠p nh·∫≠t g√≥c quay li√™n t·ª•c (Animation Loop)
        window.animateWheel = (targetAngle, duration, callback) => {
            const startAngle = WHEEL_CONFIG.currentAngle;
            const change = targetAngle - startAngle;
            const startTime = performance.now();

            function animate(currentTime) {
                const elapsed = currentTime - startTime;
                if (elapsed < duration) {
                    // Thu·∫≠t to√°n Easing (Ease Out Quart) gi√∫p quay ch·∫≠m d·∫ßn ƒë·ªÅu t·ª± nhi√™n
                    const t = elapsed / duration;
                    const easeOut = 1 - Math.pow(1 - t, 4);
                    
                    WHEEL_CONFIG.currentAngle = startAngle + change * easeOut;
                    window.initWheel(); // V·∫Ω l·∫°i khung h√¨nh m·ªõi
                    requestAnimationFrame(animate);
                } else {
                    WHEEL_CONFIG.currentAngle = targetAngle % (2 * Math.PI); // Reset g√≥c v·ªÅ < 360 ƒë·ªô
                    window.initWheel();
                    callback(); // G·ªçi h√†m x·ª≠ l√Ω k·∫øt qu·∫£
                }
            }
            requestAnimationFrame(animate);
        };
// --- LOGIC V√íNG QUAY M·ªöI (CANVAS API) ---

        // C·∫•u h√¨nh m√†u s·∫Øc v√† gi√° tr·ªã (L·∫•y t·ª´ _vongquay.html)
        const WHEEL_DATA = [
            { label: "10 üèÜ",  value: 10,  type: "point",  color: "#EF4444", text: "#FFFFFF" }, // ƒê·ªè
            { label: "20 üèÜ",  value: 20,  type: "point",  color: "#F59E0B", text: "#FFFFFF" }, // Cam
            { label: "200 üèÜ", value: 200, type: "point",  color: "#10B981", text: "#FFFFFF" }, // Xanh l√°
            { label: "M·∫•t l∆∞·ª£t", value: 0,   type: "point",  color: "#3B82F6", text: "#FFFFFF" }, // Xanh d∆∞∆°ng
            { label: "1 V√©üéüÔ∏è",  value: 1,   type: "ticket", color: "#8B5CF6", text: "#FFFFFF" }  // T√≠m
        ];

        // Bi·∫øn to√†n c·ª•c cho v√≤ng quay
        const wheelState = {
            ang: 0,       // G√≥c hi·ªán t·∫°i
            isSpinning: false,
            ctx: null
        };

        // 1. H√ÄM V·∫º V√íNG QUAY
        window.initNewWheel = () => {
            const canvas = document.getElementById('wheel');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            wheelState.ctx = ctx;

            const dia = canvas.width;
            const rad = dia / 2;
            const PI = Math.PI;
            const TAU = 2 * PI;
            const arc = TAU / WHEEL_DATA.length;

const drawSector = (sector, i) => {
                const ang = arc * i;
                ctx.save();
                
                // V·∫Ω h√¨nh r·∫ª qu·∫°t
                ctx.beginPath();
                ctx.fillStyle = sector.color;
                ctx.moveTo(rad, rad);
                ctx.arc(rad, rad, rad, ang, ang + arc);
                ctx.lineTo(rad, rad);
                ctx.fill();

                // V·∫Ω Text xoay theo h∆∞·ªõng t√¢m
                ctx.translate(rad, rad);
                ctx.rotate(ang + arc / 2);
                ctx.textAlign = "right";
                ctx.fillStyle = sector.text;
                ctx.font = "bold 40px 'Inter', sans-serif";
                ctx.fillText(sector.label, rad - 50, 15);
                
                ctx.restore();
            };

            // H√†m v·∫Ω l·∫°i t·ª´ng khung h√¨nh
            window.drawWheelFrame = () => {
                if (!wheelState.ctx) return;
                
                // X√≥a canvas c≈©
                wheelState.ctx.clearRect(0, 0, dia, dia);
                
                // Xoay to√†n b·ªô canvas theo g√≥c hi·ªán t·∫°i
                wheelState.ctx.save();
                wheelState.ctx.translate(rad, rad);
                wheelState.ctx.rotate(wheelState.ang);
                wheelState.ctx.translate(-rad, -rad);
                
                // V·∫Ω t·ª´ng mi·∫øng
                WHEEL_DATA.forEach(drawSector);
                
                wheelState.ctx.restore();
                
                // V·∫Ω vi·ªÅn tr·∫Øng trang tr√≠
                wheelState.ctx.beginPath();
                wheelState.ctx.arc(rad, rad, rad - 10, 0, TAU);
                wheelState.ctx.lineWidth = 15;
                wheelState.ctx.strokeStyle = "#ffffff";
                wheelState.ctx.stroke();
            };

            // V·∫Ω khung h√¨nh ƒë·∫ßu ti√™n
            window.drawWheelFrame();
        };

// --- 2. H√ÄM X·ª¨ L√ù QUAY TH∆Ø·ªûNG (ƒê√É FIX L·ªñI L·ªÜCH G√ìC) ---
        window.playLuckyDraw = async () => {
            if (wheelState.isSpinning) return;

            const tickets = state.profile.luckyTickets || 0;
            if (tickets < 1) return showToast("B·∫°n c·∫ßn c√≥ V√© ƒë·ªÉ quay!", "error");

            wheelState.isSpinning = true;
            document.getElementById('spin-btn').classList.add('scale-90', 'opacity-80', 'cursor-not-allowed');

            // A. CH·ªêT K·∫æT QU·∫¢ (Weighted Random)
            const weights = [40, 30, 5, 15, 10]; 
            let random = Math.floor(Math.random() * 100);
            let winIndex = 0;
            for (let i = 0; i < weights.length; i++) {
                if (random < weights[i]) { winIndex = i; break; }
                random -= weights[i];
            }

            // B. T√çNH TO√ÅN G√ìC QUAY CH√çNH X√ÅC
            // 1. C√°c h·∫±ng s·ªë
            const PI = Math.PI;
            const TAU = 2 * PI;
            const arc = TAU / WHEEL_DATA.length; // G√≥c c·ªßa 1 √¥
            
            // 2. G√≥c ng·∫´u nhi√™n trong √¥ (ƒë·ªÉ kim kh√¥ng lu√¥n ch·ªâ ch√≠nh gi·ªØa)
            // Gi·ªõi h·∫°n +/- 30% ƒë·ªô r·ªông √¥ ƒë·ªÉ tr√°nh ch·ªâ v√†o v·∫°ch
            const randomOffset = (Math.random() - 0.5) * (arc * 0.6); 
            
            // 3. T√≠nh g√≥c c·∫ßn xoay th√™m (Delta)
            // - Canvas v·∫Ω g√≥c 0 ·ªü h∆∞·ªõng 3h. Kim ch·ªâ ·ªü 12h (t·ª©c l√† 270 ƒë·ªô hay 1.5 * PI).
            // - C√¥ng th·ª©c: G√≥c ƒê√≠ch = (V·ªã tr√≠ Kim) - (V·ªã tr√≠ T√¢m √¥ tr√∫ng th∆∞·ªüng)
            let targetAngle = (1.5 * PI) - (winIndex * arc + arc / 2) + randomOffset;
            
            // - L·∫•y g√≥c hi·ªán t·∫°i (d∆∞ c·ªßa v√≤ng tr√≤n 2PI)
            const currentAngle = wheelState.ang % TAU;
            
            // - T√≠nh kho·∫£ng c√°ch c·∫ßn quay th√™m
            let delta = targetAngle - currentAngle;
            
            // - ƒê·∫£m b·∫£o quay theo chi·ªÅu kim ƒë·ªìng h·ªì (s·ªë d∆∞∆°ng)
            if (delta < 0) delta += TAU;
            
            // - C·ªông th√™m s·ªë v√≤ng quay t·ªëi thi·ªÉu (5 v√≤ng)
            const spins = 5 * TAU;
            const finalAngle = wheelState.ang + delta + spins;

            // C. HI·ªÜU ·ª®NG QUAY (Animation Loop)
            const duration = 4000; // 4 gi√¢y
            const startTime = performance.now();

            const animate = (time) => {
                const elapsed = time - startTime;
                if (elapsed < duration) {
                    // Easing: Cubic Ease Out (Nhanh -> Ch·∫≠m d·∫ßn)
                    const t = 1 - Math.pow(1 - (elapsed / duration), 3);
                    wheelState.ang = wheelState.ang + (finalAngle - wheelState.ang) * t;
                    
                    // C·∫≠p nh·∫≠t g√≥c quay hi·ªán t·∫°i nh∆∞ng gi·ªØ nguy√™n gi√° tr·ªã t√≠ch l≈©y
                    // (L∆∞u √Ω: trong h√†m draw c≈©, ch√∫ng ta kh√¥ng ƒë∆∞·ª£c ƒë√® wheelState.ang b·∫±ng logic sai)
                    // ·ªû ƒë√¢y ta t√≠nh to√°n tr·ª±c ti·∫øp tr√™n bi·∫øn wheelState.ang t√≠ch l≈©y
                    // Logic easing tr√™n h∆°i sai n·∫øu d√πng accumulate, s·ª≠a l·∫°i:
                    
                    // Logic Easing chu·∫©n cho gi√° tr·ªã ƒë√≠ch:
                    // Start + (End - Start) * Easing
                    // Tuy nhi√™n v√¨ c·∫ßn v·∫Ω li√™n t·ª•c, ta t√≠nh l·∫°i startAngle t·∫°i th·ªùi ƒëi·ªÉm b·∫Øt ƒë·∫ßu anim
                    // ƒê·ªÉ ƒë∆°n gi·∫£n, ta d√πng bi·∫øn t·∫°m, nh∆∞ng wheelState.ang c·∫ßn l∆∞u gi√° tr·ªã cu·ªëi c√πng.
                    
                    // FIX: T√≠nh l·∫°i v·ªã tr√≠ d·ª±a tr√™n m·ªëc ban ƒë·∫ßu
                    // V√¨ animate g·ªçi l·∫°i closure, ta c·∫ßn l∆∞u startAngle c·ªë ƒë·ªãnh b√™n ngo√†i
                    // Nh∆∞ng ·ªü ƒë√¢y ta d√πng n·ªôi suy tr·ª±c ti·∫øp:
                    const currentStep = (finalAngle - (wheelState.ang - (wheelState.ang - wheelState.prevAng || 0))) * t; 
                    // C√°ch tr√™n ph·ª©c t·∫°p. D√πng c√°ch c·ªï ƒëi·ªÉn:
                    
                    wheelState.ang = startOfSpin + (finalAngle - startOfSpin) * t;
                    
                    window.drawWheelFrame();
                    requestAnimationFrame(animate);
                } else {
                    // K·∫æT TH√öC
                    wheelState.ang = finalAngle;
                    window.drawWheelFrame();
                    handleSpinComplete(winIndex);
                }
            };
            
            // L∆∞u m·ªëc b·∫Øt ƒë·∫ßu quay ƒë·ªÉ t√≠nh to√°n easing
            const startOfSpin = wheelState.ang;
            requestAnimationFrame(animate);
        };

        // 3. X·ª¨ L√ù KHI QUAY XONG
        window.handleSpinComplete = async (winIndex) => {
            const result = WHEEL_DATA[winIndex];
            
            // M·ªü kh√≥a Avatar (n·∫øu may m·∫Øn)
            let newAvatar = null;
            if (typeof window.unlockRandomAvatar === 'function') newAvatar = await window.unlockRandomAvatar();

            // C·∫≠p nh·∫≠t Database
            try {
                const updatePayload = { luckyTickets: increment(-1) };
                
                if (result.type === 'point') {
                    updatePayload.points = increment(result.value);
                } else if (result.type === 'ticket') {
                    updatePayload.luckyTickets = increment(0); // Tr·∫£ l·∫°i v√©
                }

                await updateDoc(doc(db, getPath('users'), state.user.uid), updatePayload);
                
                // C·∫≠p nh·∫≠t UI ngay l·∫≠p t·ª©c
                const ticketEl = document.getElementById('ticket-count');
                if(ticketEl) ticketEl.textContent = (state.profile.luckyTickets - 1) + (result.type === 'ticket' ? 1 : 0);

                // Hi·ªán Modal & Ph√°o hoa
                showResultModal(result, newAvatar);
                if (result.value > 0 || result.type === 'ticket') {
                    triggerConfetti();
                }

            } catch (e) {
                console.error(e);
                showToast("L·ªói c·∫≠p nh·∫≠t: " + e.message, "error");
            } finally {
                wheelState.isSpinning = false;
                document.getElementById('spin-btn').classList.remove('scale-90', 'opacity-80', 'cursor-not-allowed');
            }
        };

        // 4. HELPER: HI·ªÜN MODAL
        window.showResultModal = (result, newAvatar) => {
            const modal = document.getElementById('result-modal');
            const icon = document.getElementById('modal-icon');
            const text = document.getElementById('modal-text');
            
            if (result.value === 0 && result.type !== 'ticket') {
                icon.textContent = "üò¢";
                text.textContent = "M·∫•t l∆∞·ª£t";
                text.className = "text-3xl font-black text-slate-400";
            } else {
                icon.textContent = "üéÅ";
                text.textContent = result.label;
                text.className = "text-3xl font-black text-indigo-600";
            }

            if (newAvatar) {
                text.innerHTML += `<div class="text-sm text-green-600 mt-2 font-medium">+ üîì Avatar: ${newAvatar}</div>`;
            }

            modal.classList.remove('hidden');
            // Animation fade in
            setTimeout(() => {
                modal.classList.remove('opacity-0');
                modal.querySelector('div').classList.remove('scale-90');
                modal.querySelector('div').classList.add('scale-100');
            }, 10);
        };

        // 5. HELPER: ƒê√ìNG MODAL
        window.closeResultModal = () => {
            const modal = document.getElementById('result-modal');
            modal.classList.add('opacity-0');
            modal.querySelector('div').classList.remove('scale-100');
            modal.querySelector('div').classList.add('scale-90');
            setTimeout(() => modal.classList.add('hidden'), 300);
        };

 // 6. HELPER: B·∫ÆN PH√ÅO HOA (ƒê√É FIX Z-INDEX 9999 ƒê·ªÇ KH√îNG B·ªä MODAL CHE)
        window.triggerConfetti = () => {
            const C = window.confetti; // L·∫•y t·ª´ window ƒë·ªÉ ch·∫Øc ch·∫Øn
            if (typeof C === 'function') {
                C({
                    particleCount: 150,
                    spread: 100,
                    origin: { y: 0.6 },
                    colors: ['#EF4444', '#F59E0B', '#10B981', '#3B82F6'],
                    zIndex: 9999 // QUAN TR·ªåNG: Cao h∆°n z-index c·ªßa Modal (60-70)
                });
            } else {
                console.warn("Th∆∞ vi·ªán Confetti ch∆∞a t·∫£i xong.");
            }
        };
/// --- H√ÄM C·∫¨P NH·∫¨T S·∫¢NH CH·ªú (ƒê√É FIX L·ªñI NH√ÅY) ---
// --- FIX L·ªñI NH√ÇN ƒê√îI (LOBBY) ---
const updateLobbyUI = () => {
    const container = document.getElementById('lobby-match-list');
    if (!container) return;

    const uid = state.user.uid;
    const availableMatches = state.data.matches.filter(m => m.status === 'waiting' && !m.player2 && m.player1.uid !== uid);
    
    const lobbyIds = new Set();

    if (availableMatches.length === 0) {
         if (!container.querySelector('.empty-lobby')) {
            container.innerHTML = `<div class="empty-lobby col-span-full p-8 text-center bg-white rounded-2xl border-2 border-dashed border-slate-200 text-slate-400 text-sm">Ch∆∞a c√≥ ai t·∫°o ph√≤ng. B·∫°n h√£y l√† ng∆∞·ªùi ƒë·∫ßu ti√™n!</div>`;
        }
    } else {
        const emptyEl = container.querySelector('.empty-lobby');
        if (emptyEl) emptyEl.remove();

        availableMatches.forEach(m => {
            const cardId = `lobby-match-${m.id}`;
            lobbyIds.add(cardId);

            const cardHtml = `
                <div class="flex items-center gap-3 mb-3">
                    ${renderAvatar(state.data.users.find(u => u.uid === m.player1.uid), 'w-10 h-10', 'text-sm')}
                    <div class="overflow-hidden">
                        <p class="font-bold text-slate-700 text-sm truncate">${m.player1.name}</p>
                        <p class="text-xs text-slate-500">M√£: <span class="font-mono font-bold text-purple-600">${m.roomCode}</span></p>
                    </div>
                </div>
                <button onclick="joinPublicMatch('${m.id}')" class="w-full bg-purple-50 text-purple-700 hover:bg-purple-600 hover:text-white py-2 rounded-lg font-bold text-sm transition flex items-center justify-center gap-2">
                    <i data-lucide="swords" size="14"></i> Chi·∫øn ngay
                </button>
            `;

            let card = document.getElementById(cardId);
            if (!card) {
                card = document.createElement('div');
                card.id = cardId;
                card.className = "bg-white p-4 rounded-xl shadow-sm border border-purple-100 hover:shadow-md hover:border-purple-300 transition group relative animate-in fade-in slide-in-from-bottom-2";
                card.innerHTML = cardHtml;
                container.appendChild(card);
            } else {
                if (card.innerHTML !== cardHtml) card.innerHTML = cardHtml;
            }
        });

        // D·ªçn d·∫πp tri·ªát ƒë·ªÉ: X√≥a b·∫•t k·ª≥ th·∫ª n√†o kh√¥ng c√≥ trong danh s√°ch lobbyIds
        Array.from(container.children).forEach(child => {
            if (!lobbyIds.has(child.id)) {
                child.remove();
            }
        });
    }
    renderIcons();
};
// --- FIX L·ªñI NH√ÇN ƒê√îI TR·∫¨N ƒê·∫§U (TEACHER) ---
const updateTeacherDashboardUI = () => {
    const activeContainer = document.getElementById('teacher-active-list');
    const historyContainer = document.getElementById('teacher-history-list');
    const countEl = document.getElementById('teacher-active-count');

    if (!activeContainer || !historyContainer) return;

    const allMatches = state.data.matches || [];
    const activeMatches = allMatches.filter(m => m.status === 'waiting' || m.status === 'playing');
    const finishedMatches = allMatches.filter(m => m.status === 'finished').sort((a, b) => b.createdAt - a.createdAt);

    // 1. C·∫≠p nh·∫≠t s·ªë l∆∞·ª£ng
    if (countEl) countEl.textContent = activeMatches.length;

    // 2. X·ª¨ L√ù DANH S√ÅCH ƒêANG DI·ªÑN RA
    const activeIds = new Set(); // L∆∞u l·∫°i danh s√°ch ID h·ª£p l·ªá
    
    if (activeMatches.length === 0) {
        // N·∫øu kh√¥ng c√≥ tr·∫≠n n√†o, hi·ªÉn th·ªã th√¥ng b√°o tr·ªëng (n·∫øu ch∆∞a c√≥)
        if (!activeContainer.querySelector('.empty-message')) {
            // X√≥a h·∫øt c√°c th·∫ª c≈© (n·∫øu c√≥) tr∆∞·ªõc khi hi·ªán th√¥ng b√°o
            activeContainer.innerHTML = `<div class="empty-message p-8 text-center text-slate-400 bg-slate-50 rounded-xl border border-dashed border-slate-300 col-span-full">Hi·ªán kh√¥ng c√≥ tr·∫≠n ƒë·∫•u n√†o ƒëang di·ªÖn ra.</div>`;
        }
    } else {
        // N·∫øu c√≥ d·ªØ li·ªáu, x√≥a th√¥ng b√°o tr·ªëng ngay l·∫≠p t·ª©c
        const emptyMsg = activeContainer.querySelector('.empty-message');
        if (emptyMsg) emptyMsg.remove();

        // 3. Render ho·∫∑c Update c√°c th·∫ª
        activeMatches.forEach(m => {
            const cardId = `teacher-match-${m.id}`;
            activeIds.add(cardId);
            const isPlaying = m.status === 'playing';

            const cardHtml = `
                <div class="flex-1">
                    <div class="flex items-center gap-2 mb-1">
                        <span class="text-xs font-bold px-2 py-0.5 rounded text-white ${isPlaying ? 'bg-green-600' : 'bg-yellow-500'}">
                            ${isPlaying ? 'ƒêANG ƒê·∫§U' : 'ƒêANG CH·ªú'}
                        </span>
                        <span class="font-mono font-bold text-slate-700">Ph√≤ng: ${m.roomCode}</span>
                    </div>
                    <div class="text-sm">
                        <span class="text-blue-600 font-bold">${m.player1.name} (${m.player1.score})</span> 
                        <span class="text-slate-400 mx-1">vs</span> 
                        <span class="text-red-600 font-bold">${m.player2 ? `${m.player2.name} (${m.player2.score})` : '???'}</span>
                    </div>
                </div>
                <div class="flex gap-2">
                    <button onclick="watchMatch('${m.id}')" class="bg-indigo-50 text-indigo-700 hover:bg-indigo-100 border border-indigo-200 px-3 py-2 rounded-lg font-bold text-sm transition flex items-center gap-1">
                        <i data-lucide="eye" size="16"></i> Xem
                    </button>
                    <button onclick="forceEndMatch('${m.id}', '${m.roomCode}')" class="bg-red-50 text-red-600 hover:bg-red-100 border border-red-200 px-3 py-2 rounded-lg font-bold text-sm transition flex items-center gap-1">
                        <i data-lucide="square" size="16" class="fill-current"></i> K·∫øt th√∫c
                    </button>
                </div>
            `;

            let card = document.getElementById(cardId);
            const cardClass = `bg-white p-4 rounded-xl shadow-sm border border-l-4 ${isPlaying ? 'border-l-green-500 border-slate-200' : 'border-l-yellow-500 border-slate-200'} flex flex-col sm:flex-row justify-between items-center gap-3 transition-all`;

            if (!card) {
                // T·∫°o m·ªõi
                card = document.createElement('div');
                card.id = cardId;
                card.className = cardClass + ' animate-in fade-in slide-in-from-bottom-2';
                card.innerHTML = cardHtml;
                activeContainer.appendChild(card);
            } else {
                // C·∫≠p nh·∫≠t
                if (card.className !== cardClass) card.className = cardClass;
                if (card.innerHTML !== cardHtml) card.innerHTML = cardHtml;
            }
        });

        // 4. D·ªçn d·∫πp tri·ªát ƒë·ªÉ (QUAN TR·ªåNG): X√≥a B·∫§T K·ª≤ th·∫ª n√†o kh√¥ng n·∫±m trong danh s√°ch activeIds
        Array.from(activeContainer.children).forEach(child => {
            // N·∫øu th·∫ª con kh√¥ng c√≥ ID n·∫±m trong danh s√°ch c·∫ßn hi·ªÉn th·ªã -> X√ìA NGAY
            if (!activeIds.has(child.id)) {
                child.remove();
            }
        });
    }

    // 5. X·ª¨ L√ù L·ªäCH S·ª¨ (Gi·ªØ nguy√™n)
    const historyHtml = finishedMatches.length === 0 
        ? `<tr><td colspan="6" class="text-center text-slate-400 text-sm p-4">Ch∆∞a c√≥ d·ªØ li·ªáu l·ªãch s·ª≠.</td></tr>` 
        : finishedMatches.map(m => {
            const p1Win = m.player1.score > (m.player2 ? m.player2.score : 0);
            const p2Win = m.player2 && m.player2.score > m.player1.score;
            return `
            <tr class="border-b last:border-0 hover:bg-slate-50 group animate-in fade-in">
                <td class="py-3 pl-4 font-mono text-slate-500 text-xs">${m.roomCode}</td>
                <td class="py-3">
                    <div class="flex items-center gap-2 text-sm">
                        <span class="${p1Win ? 'font-bold text-blue-700' : 'text-slate-600'}">${m.player1.name}</span>
                        <span class="text-xs bg-slate-100 px-1 rounded font-mono">${m.player1.score}</span>
                    </div>
                </td>
                <td class="py-3 font-bold text-slate-300 text-xs text-center">VS</td>
                <td class="py-3">
                    <div class="flex items-center gap-2 text-sm">
                        <span class="${p2Win ? 'font-bold text-red-700' : 'text-slate-600'}">${m.player2 ? m.player2.name : 'N/A'}</span>
                        <span class="text-xs bg-slate-100 px-1 rounded font-mono">${m.player2 ? m.player2.score : 0}</span>
                    </div>
                </td>
                <td class="py-3 text-right pr-2 text-xs text-slate-400 w-24">
                     ${m.createdAt ? new Date(m.createdAt.seconds * 1000).toLocaleTimeString('vi-VN', {hour:'2-digit', minute:'2-digit'}) : ''}
                </td>
                <td class="py-3 text-right pr-4 w-10">
                    <button onclick="confirmDeleteMatchHistory('${m.id}')" class="text-slate-300 hover:text-red-500 transition p-1 rounded-md hover:bg-red-50">
                        <i data-lucide="trash-2" size="16"></i>
                    </button>
                </td>
            </tr>`;
        }).join('');

    if (historyContainer.innerHTML !== historyHtml) {
        historyContainer.innerHTML = historyHtml;
    }
    
    renderIcons();
};
// --- C√ÅC H√ÄM CHO T√çNH NƒÇNG KI·ªÇM TRA (ASSESSMENT) ---


// 1. Render giao di·ªán ch√≠nh c·ªßa Tab Ki·ªÉm tra (ƒê√É FIX: NG√ÄY TH√ÅNG KH√îNG B·ªä N√öT X√ìA CH√àN)
        const renderClassAssessments = (classData, studentList) => {
            const classAssessments = (state.data.assessments || []).filter(a => a.classId === classData.id);

            // A. CH·∫æ ƒê·ªò T·∫†O M·ªöI
            if (state.ui.isCreatingAssessment) {
                return renderCreateAssessmentForm(classData, studentList);
            }

            // B. CH·∫æ ƒê·ªò XEM CHI TI·∫æT (B·∫¢NG ƒêI·ªÇM)
            if (state.ui.selectedAssessmentId) {
                const ass = classAssessments.find(a => a.id === state.ui.selectedAssessmentId);
                if (!ass) {
                    state.ui.selectedAssessmentId = null;
                    return renderApp();
                }

                const dateStr = ass.date ? new Date(ass.date.seconds * 1000).toLocaleDateString('vi-VN') : 'N/A';
                const criteria = ass.criteria || ['T·ª´ v·ª±ng', 'Ch·ªØ vi·∫øt', 'Kh·∫©u ng·ªØ'];
                const headerCols = criteria.map(c => `<th class="px-2 py-3 text-center text-indigo-600 bg-indigo-50 border-b border-indigo-100">${c}</th>`).join('');

                return `
                    <div class="fade-in">
                        <div class="flex items-center justify-between mb-6">
                            <button onclick="viewAssessmentDetail(null)" class="flex items-center gap-2 text-slate-500 hover:text-blue-600 font-bold transition">
                                <i data-lucide="arrow-left" size="20"></i> Quay l·∫°i danh s√°ch
                            </button>
                            
                            <div class="flex gap-2">
                                <button onclick="printAssessment('${ass.id}')" class="bg-indigo-100 text-indigo-700 px-4 py-2 rounded-lg font-bold hover:bg-indigo-200 transition flex items-center gap-2 text-sm">
                                    <i data-lucide="printer" size="18"></i> In b·∫£ng ƒëi·ªÉm
                                </button>
                                <button onclick="deleteAssessment('${ass.id}')" class="bg-red-50 text-red-600 px-4 py-2 rounded-lg font-bold hover:bg-red-100 transition flex items-center gap-2 text-sm">
                                    <i data-lucide="trash-2" size="18"></i> X√≥a
                                </button>
                            </div>
                        </div>

                        <div class="bg-white rounded-2xl shadow-lg border border-slate-200 overflow-hidden">
                            <div class="p-6 border-b border-slate-100 bg-slate-50 flex justify-between items-center">
                                <div>
                                    <h3 class="text-2xl font-bold text-slate-800">${ass.title}</h3>
                                    <p class="text-slate-500 text-sm mt-1"><i data-lucide="calendar" class="inline w-4 h-4"></i> Ng√†y ki·ªÉm tra: ${dateStr}</p>
                                </div>
                                <div class="hidden md:block text-right">
                                    <span class="bg-blue-100 text-blue-700 px-3 py-1 rounded-full text-xs font-bold border border-blue-200">
                                        ${ass.scores.length} h·ªçc sinh
                                    </span>
                                </div>
                            </div>

                            <div class="overflow-x-auto">
                                <table class="w-full text-sm text-left">
                                    <thead>
                                        <tr>
                                            <th class="px-4 py-3 bg-slate-50 border-b border-slate-200 font-bold text-slate-600">H·ªçc sinh</th>
                                            ${headerCols}
                                            <th class="px-4 py-3 text-center font-bold bg-slate-50 border-b border-slate-200 w-24">TB</th>
                                        </tr>
                                    </thead>
                                    <tbody class="divide-y divide-slate-100">
                                        ${ass.scores.map(s => {
                                            const st = studentList.find(u => u.uid === s.uid);
                                            let total = 0;
                                            let count = 0;
                                            
                                            const scoreCells = criteria.map(c => {
                                                let val = 0;
                                                if (s.points && s.points[c] !== undefined) val = parseFloat(s.points[c]);
                                                else if (c === 'T·ª´ v·ª±ng') val = parseFloat(s.vocab || 0);
                                                else if (c === 'Ch·ªØ vi·∫øt') val = parseFloat(s.writing || 0);
                                                else if (c === 'Kh·∫©u ng·ªØ') val = parseFloat(s.speaking || 0);
                                                
                                                total += val;
                                                count++;
                                                return `<td class="px-2 py-3 text-center text-slate-700 font-medium">${val}</td>`;
                                            }).join('');

                                            const avg = count > 0 ? (total / count).toFixed(1) : 0;
                                            
                                            let avgColor = 'text-slate-800';
                                            if(avg >= 80) avgColor = 'text-green-600';
                                            else if(avg < 50) avgColor = 'text-red-600';

                                            return `
                                            <tr class="hover:bg-slate-50 transition">
                                                <td class="px-4 py-3 font-bold text-slate-700 whitespace-nowrap">${st ? st.name : 'Unknown'}</td>
                                                ${scoreCells}
                                                <td class="px-4 py-3 text-center font-black ${avgColor} text-base">${avg}</td>
                                            </tr>`;
                                        }).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                `;
            }

            // C. CH·∫æ ƒê·ªò DANH S√ÅCH (CARD VIEW GRID)
            const cardsHtml = classAssessments.map(ass => {
                const dateStr = ass.date ? new Date(ass.date.seconds * 1000).toLocaleDateString('vi-VN') : 'N/A';
                const studentCount = ass.scores.length;
                
                // T√≠nh ƒëi·ªÉm trung b√¨nh c·ªßa c·∫£ l·ªõp
                let classTotal = 0;
                if (studentCount > 0) {
                    ass.scores.forEach(s => {
                        let sTotal = 0;
                        let cCount = 0;
                        const crit = ass.criteria || ['T·ª´ v·ª±ng', 'Ch·ªØ vi·∫øt', 'Kh·∫©u ng·ªØ'];
                        crit.forEach(c => {
                            let val = 0;
                            if (s.points && s.points[c] !== undefined) val = parseFloat(s.points[c]);
                            else if (c === 'T·ª´ v·ª±ng') val = parseFloat(s.vocab || 0);
                            else if (c === 'Ch·ªØ vi·∫øt') val = parseFloat(s.writing || 0);
                            else if (c === 'Kh·∫©u ng·ªØ') val = parseFloat(s.speaking || 0);
                            sTotal += val;
                            cCount++;
                        });
                        if (cCount > 0) classTotal += (sTotal / cCount);
                    });
                }
                const classAvg = studentCount > 0 ? (classTotal / studentCount).toFixed(1) : 0;

                return `
                    <div onclick="viewAssessmentDetail('${ass.id}')" 
                         class="bg-white p-5 rounded-2xl shadow-sm border border-slate-200 hover:shadow-lg hover:border-indigo-300 hover:-translate-y-1 transition cursor-pointer flex flex-col h-full group relative overflow-hidden">
                        
                        <div class="absolute top-0 left-0 right-0 h-1 bg-gradient-to-r from-blue-400 to-indigo-500"></div>

                        <button onclick="event.stopPropagation(); deleteAssessment('${ass.id}')" 
                                class="absolute top-3 right-3 p-2 bg-white text-red-500 rounded-full shadow-sm border border-slate-100 opacity-0 group-hover:opacity-100 transition-all hover:bg-red-50 hover:border-red-200 z-20"
                                title="X√≥a b√†i ki·ªÉm tra">
                            <i data-lucide="trash-2" size="18"></i>
                        </button>

                        <div class="flex items-center gap-3 mb-3">
                            <div class="bg-indigo-50 text-indigo-600 p-2.5 rounded-xl group-hover:bg-indigo-600 group-hover:text-white transition">
                                <i data-lucide="clipboard-check" size="24"></i>
                            </div>
                            <span class="text-xs font-bold text-slate-400 bg-slate-100 px-2 py-1 rounded-md border border-slate-200">
                                ${dateStr}
                            </span>
                        </div>

                        <h4 class="font-bold text-lg text-slate-800 mb-2 line-clamp-2 leading-snug group-hover:text-indigo-700 transition">
                            ${ass.title}
                        </h4>

                         </div>
                `;
            }).join('');

            return `
                <div class="fade-in">
                    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4">
                        <h3 class="text-2xl font-bold text-slate-800 flex items-center gap-2">
                            <i data-lucide="check-square" class="text-indigo-600"></i>
                            K·∫øt qu·∫£ Ki·ªÉm tra
                        </h3>
                        <button onclick="initCreateAssessment()" class="w-full sm:w-auto bg-indigo-600 hover:bg-indigo-700 text-white px-5 py-2.5 rounded-xl font-bold shadow-md flex items-center justify-center gap-2 text-sm transition transform hover:-translate-y-0.5">
                            <i data-lucide="plus-circle" size="20"></i> Nh·∫≠p ƒëi·ªÉm Ki·ªÉm tra
                        </button>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 md:gap-6">
                        ${cardsHtml || `
                            <div class="col-span-full p-12 text-center bg-white rounded-2xl border-2 border-dashed border-slate-200">
                                <div class="inline-block p-4 bg-slate-50 rounded-full mb-4 text-slate-400">
                                    <i data-lucide="clipboard-x" size="48"></i>
                                </div>
                                <p class="text-slate-500 font-medium">Ch∆∞a c√≥ b√†i ki·ªÉm tra n√†o.</p>
                                <button onclick="initCreateAssessment()" class="text-indigo-600 font-bold hover:underline mt-2">T·∫°o ngay</button>
                            </div>
                        `}
                    </div>
                </div>
            `;
        };
// 2. Form t·∫°o b√†i ki·ªÉm tra m·ªõi (ƒê√£ c·∫≠p nh·∫≠t thang ƒëi·ªÉm 100)
  // 2. Form t·∫°o b√†i ki·ªÉm tra m·ªõi (DYNAMIC COLUMNS)
        const renderCreateAssessmentForm = (classData, studentList) => {
            const today = new Date().toISOString().split('T')[0];
            const criteria = state.ui.tempAssessmentCriteria || DEFAULT_CRITERIA;

            // Render Header c·ªôt ƒë·ªông
            const headerHtml = criteria.map((c, idx) => `
                <th class="py-3 text-center min-w-[100px] relative group">
                    ${c}
                    <button onclick="removeAssessmentCriterion(${idx})" class="absolute -top-2 -right-2 bg-red-100 text-red-500 rounded-full p-0.5 opacity-0 group-hover:opacity-100 transition shadow-sm" title="X√≥a c·ªôt n√†y">
                        <i data-lucide="x" size="12"></i>
                    </button>
                </th>
            `).join('');

            // Render H√†ng h·ªçc sinh v·ªõi c√°c √¥ input ƒë·ªông
            const studentRows = studentList.map(s => {
                const inputs = criteria.map(c => `
                    <td class="py-2 px-1">
                        <input type="number" step="1" min="0" max="100" 
                            class="w-full p-2 border rounded text-center focus:border-indigo-500 score-input" 
                            data-uid="${s.uid}" 
                            data-criterion="${c}" 
                            placeholder="0-100">
                    </td>
                `).join('');

                return `
                <tr class="border-b hover:bg-slate-50">
                    <td class="py-3 pl-2 font-medium truncate max-w-[150px]">${s.name}</td>
                    ${inputs}
                </tr>`;
            }).join('');

            return `
                <div class="bg-white p-6 rounded-2xl shadow-lg border border-slate-200 fade-in">
                    <div class="flex justify-between items-center mb-6 border-b pb-4">
                        <h3 class="text-xl font-bold text-indigo-700">Nh·∫≠p ƒëi·ªÉm Ki·ªÉm tra</h3>
                        <button onclick="toggleCreateAssessment(false)" class="text-slate-400 hover:text-red-500"><i data-lucide="x" size="24"></i></button>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                        <div>
                            <label class="block text-sm font-bold text-slate-700 mb-1">T√™n b√†i ki·ªÉm tra</label>
                            <input id="assess-title" type="text" class="w-full p-2 border rounded-lg focus:border-indigo-500" placeholder="VD: Ki·ªÉm tra gi·ªØa k·ª≥...">
                        </div>
                        <div>
                            <label class="block text-sm font-bold text-slate-700 mb-1">Ng√†y ki·ªÉm tra</label>
                            <input id="assess-date" type="date" value="${today}" class="w-full p-2 border rounded-lg focus:border-indigo-500">
                        </div>
                    </div>

                    <div class="mb-6 bg-slate-50 p-4 rounded-xl border border-slate-200">
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-2">C·∫•u h√¨nh ti√™u ch√≠ ch·∫•m ƒëi·ªÉm:</label>
                        <div class="flex flex-wrap gap-2 items-center">
                            ${criteria.map((c, idx) => `
                                <div class="bg-white border border-indigo-200 text-indigo-700 px-3 py-1 rounded-full text-sm font-bold flex items-center gap-2 shadow-sm">
                                    ${c}
                                    <button onclick="removeAssessmentCriterion(${idx})" class="hover:text-red-500"><i data-lucide="x" size="14"></i></button>
                                </div>
                            `).join('')}
                            
                            <div class="flex items-center gap-2 ml-2">
                                <input id="new-criterion-input" type="text" class="p-1 px-3 border rounded-full text-sm w-32 focus:w-48 transition-all outline-none focus:border-indigo-500" placeholder="+ Th√™m ti√™u ch√≠" onkeydown="if(event.key==='Enter') addAssessmentCriterion()">
                                <button onclick="addAssessmentCriterion()" class="bg-indigo-600 text-white p-1 rounded-full hover:bg-indigo-700 shadow-sm"><i data-lucide="plus" size="16"></i></button>
                            </div>
                        </div>
                    </div>

                    <div class="overflow-x-auto mb-6 border rounded-xl">
                        <table class="w-full min-w-[600px]">
                            <thead class="bg-indigo-50 text-indigo-800 text-sm uppercase">
                                <tr>
                                    <th class="py-3 pl-2 text-left w-40">H·ªçc sinh</th>
                                    ${headerHtml}
                                </tr>
                            </thead>
                            <tbody id="assessment-score-body">
                                ${studentRows}
                            </tbody>
                        </table>
                    </div>

                    <div class="flex justify-end gap-3">
                        <button onclick="toggleCreateAssessment(false)" class="px-5 py-2 rounded-xl bg-slate-100 text-slate-600 font-bold hover:bg-slate-200">H·ªßy</button>
                        <button onclick="saveAssessment('${classData.id}')" class="px-6 py-2 rounded-xl bg-indigo-600 text-white font-bold shadow-md hover:bg-indigo-700 flex items-center gap-2">
                            <i data-lucide="save" size="18"></i> L∆∞u K·∫øt Qu·∫£
                        </button>
                    </div>
                </div>
            `;
        };
        // 3. Handlers
        window.toggleCreateAssessment = (val) => {
            state.ui.isCreatingAssessment = val;
            renderApp();
        };


// 3. Handlers (ƒê√É N√ÇNG C·∫§P: C·ªòNG T·ªîNG S·ªê ƒêI·ªÇM V√ÄO PROFILE)
        window.saveAssessment = async (classId) => {
            const title = document.getElementById('assess-title').value.trim();
            const dateVal = document.getElementById('assess-date').value;
            const criteria = state.ui.tempAssessmentCriteria || DEFAULT_CRITERIA;
            
            if (!title) return showToast("Vui l√≤ng nh·∫≠p t√™n b√†i ki·ªÉm tra", "error");

            const inputs = document.querySelectorAll('.score-input');
            const scoresMap = {};

            // Gom nh√≥m ƒëi·ªÉm theo UID
            inputs.forEach(input => {
                const uid = input.dataset.uid;
                const criterion = input.dataset.criterion; // L·∫•y t√™n ti√™u ch√≠
                const val = input.value.trim();
                
                if (!scoresMap[uid]) scoresMap[uid] = { uid, points: {} };
                
                // L∆∞u ƒëi·ªÉm v√†o object points
                scoresMap[uid].points[criterion] = val === '' ? 0 : parseFloat(val);
            });

            const scoresArray = Object.values(scoresMap);

            try {
                const dateObj = new Date(dateVal);
                const now = new Date();
                dateObj.setHours(now.getHours(), now.getMinutes());

                // 1. L∆∞u b√†i ki·ªÉm tra v√†o database
                await addDoc(getRef('assessments'), {
                    classId,
                    title,
                    date: dateObj,
                    criteria: criteria, 
                    scores: scoresArray,
                    createdAt: serverTimestamp()
                });

                // 2. [C·∫¨P NH·∫¨T] C·ªông T·ªîNG ƒêI·ªÇM (Sum) v√†o t√†i kho·∫£n h·ªçc sinh
                const updatePromises = scoresArray.map(s => {
                    let total = 0;
                    
                    // T√≠nh t·ªïng c·ªông t·∫•t c·∫£ c√°c ƒëi·ªÉm th√†nh ph·∫ßn
                    criteria.forEach(c => {
                        const val = s.points[c] || 0;
                        total += val;
                    });
                    
                    // L√†m tr√≤n t·ªïng ƒëi·ªÉm (ƒë·ªÉ tr√°nh s·ªë l·∫ª nh∆∞ 270.5)
                    const finalPoints = Math.round(total);
                    
                    if (finalPoints !== 0) { // Cho ph√©p c·ªông ƒëi·ªÉm √¢m n·∫øu mu·ªën ph·∫°t
                        // C·ªông d·ªìn v√†o profile user
                        return updateDoc(doc(db, getPath('users'), s.uid), {
                            points: increment(finalPoints)
                        });
                    }
                    return Promise.resolve();
                });

                // Ch·∫°y t·∫•t c·∫£ l·ªánh c·∫≠p nh·∫≠t song song
                await Promise.all(updatePromises);

                showToast("ƒê√£ l∆∞u b√†i ki·ªÉm tra & C·ªông t·ªïng ƒëi·ªÉm cho h·ªçc sinh!");
                toggleCreateAssessment(false);
            } catch (e) {
                console.error(e);
                showToast("L·ªói l∆∞u d·ªØ li·ªáu: " + e.message, "error");
            }
        };

        window.deleteAssessment = async (id) => {
            if (confirm("B·∫°n ch·∫Øc ch·∫Øn mu·ªën x√≥a b√†i ki·ªÉm tra n√†y?")) {
                try {
                    await deleteDoc(doc(db, getPath('assessments'), id));
                    showToast("ƒê√£ x√≥a b√†i ki·ªÉm tra.");
                } catch(e) {
                    showToast("L·ªói x√≥a: " + e.message, "error");
                }
            }
        };

// 4. In ·∫•n b·∫£ng ƒëi·ªÉm chi ti·∫øt c·ªßa 1 b√†i ki·ªÉm tra (ƒê√É N√ÇNG C·∫§P: C·ªòT ƒê·ªòNG)
        window.printAssessment = (id) => {
            const ass = state.data.assessments.find(a => a.id === id);
            if (!ass) return showToast("Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu.", "error");

            const classData = state.data.classes.find(c => c.id === ass.classId);
            const className = classData ? classData.title : 'L·ªõp h·ªçc';
            const dateStr = ass.date ? new Date(ass.date.seconds * 1000).toLocaleDateString('vi-VN') : '';

            // 1. X√°c ƒë·ªãnh c√°c ti√™u ch√≠ ch·∫•m ƒëi·ªÉm (Dynamic Criteria)
            // N·∫øu b√†i c≈© kh√¥ng c√≥ field criteria th√¨ d√πng m·∫∑c ƒë·ªãnh 3 c√°i
            const criteria = ass.criteria || ['T·ª´ v·ª±ng', 'Ch·ªØ vi·∫øt', 'Kh·∫©u ng·ªØ'];

            // 2. T·∫°o Header b·∫£ng ƒë·ªông
            const headerCols = criteria.map(c => 
                `<th style="border: 1px solid #000; padding: 8px; text-align: center; background-color: #f0f0f0;">${c}</th>`
            ).join('');

            // 3. L·∫•y danh s√°ch h·ªçc sinh ƒë·∫ßy ƒë·ªß ƒë·ªÉ map t√™n
            const studentList = state.data.users; 

            // 4. T·∫°o c√°c d√≤ng d·ªØ li·ªáu
            const rows = ass.scores.map((s, idx) => {
                const st = studentList.find(u => u.uid === s.uid);
                const name = st ? st.name : 'Unknown';
                
                let total = 0;
                let count = 0;

                // T·∫°o c√°c √¥ ƒëi·ªÉm ƒë·ªông
                const scoreCells = criteria.map(c => {
                    let val = 0;
                    // ∆Øu ti√™n l·∫•y t·ª´ c·∫•u tr√∫c m·ªõi (points object)
                    if (s.points && s.points[c] !== undefined) {
                        val = parseFloat(s.points[c]);
                    } 
                    // Fallback cho d·ªØ li·ªáu c≈© (n·∫øu t√™n ti√™u ch√≠ tr√πng kh·ªõp)
                    else if (c === 'T·ª´ v·ª±ng') val = parseFloat(s.vocab || 0);
                    else if (c === 'Ch·ªØ vi·∫øt') val = parseFloat(s.writing || 0);
                    else if (c === 'Kh·∫©u ng·ªØ') val = parseFloat(s.speaking || 0);
                    
                    total += val;
                    count++;
                    
                    return `<td style="border: 1px solid #000; padding: 8px; text-align: center;">${val}</td>`;
                }).join('');

                // T√≠nh trung b√¨nh
                const avg = count > 0 ? (total / count).toFixed(1) : 0;
                
                return `
                    <tr>
                        <td style="border: 1px solid #000; padding: 8px; text-align: center;">${idx + 1}</td>
                        <td style="border: 1px solid #000; padding: 8px; font-weight: bold;">${name}</td>
                        ${scoreCells}
                        <td style="border: 1px solid #000; padding: 8px; text-align: center; font-weight: bold;">${avg}</td>
                        <td style="border: 1px solid #000; padding: 8px;"></td>
                    </tr>
                `;
            }).join('');

            // 5. T·∫°o HTML trang in (S·ª≠ d·ª•ng c·∫•u tr√∫c chu·∫©n ƒë√£ fix l·ªói ng·∫Øt trang)
            const html = `
                <div class="print-page-break">
                    <div class="print-header" style="text-align: center; margin-bottom: 20px;">
                        <h2 style="margin: 0; text-transform: uppercase; font-size: 24pt;">B·∫¢NG ƒêI·ªÇM KI·ªÇM TRA</h2>
                        <h3 style="margin: 5px 0; font-size: 16pt;">L·ªõp: ${className}</h3>
                        <p style="font-size: 12pt;">B√†i ki·ªÉm tra: <strong>${ass.title}</strong> - Ng√†y: ${dateStr}</p>
                    </div>

                    <table style="width: 100%; border-collapse: collapse; font-family: 'Times New Roman', serif; font-size: 12pt;">
                        <thead>
                            <tr style="background-color: #f0f0f0; -webkit-print-color-adjust: exact;">
                                <th style="border: 1px solid #000; padding: 8px; width: 50px;">STT</th>
                                <th style="border: 1px solid #000; padding: 8px; text-align: left;">H·ªç v√† T√™n</th>
                                ${headerCols} <th style="border: 1px solid #000; padding: 8px; width: 60px;">TB</th>
                                <th style="border: 1px solid #000; padding: 8px; width: 100px;">Ghi ch√∫</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${rows}
                        </tbody>
                    </table>

                    <div class="no-break-box" style="margin-top: 40px; display: flex; justify-content: space-between; page-break-inside: avoid;">
                        <div style="text-align: center; width: 40%;">
                            <p style="font-weight: bold; font-size: 12pt; margin-bottom: 80px;"></p>
                            <p style="font-style: italic; font-size: 11pt;"></p>
                        </div>
                        <div style="text-align: center; width: 40%;">
                            <p style="font-style: italic; font-size: 11pt; margin-bottom: 5px;">Ng√†y ...... th√°ng ...... nƒÉm 20...</p>
                            <p style="font-weight: bold; font-size: 12pt; margin-bottom: 80px;">Gi√°o vi√™n</p>
                            <p style="font-style: italic; font-size: 11pt;">(K√Ω v√† ghi r√µ h·ªç t√™n)</p>
                        </div>
                    </div>
                </div>
            `;

            const printContainer = document.getElementById('print-content');
            printContainer.innerHTML = html;
            window.print();
        };
 
// --- CH·ª®C NƒÇNG B√ÅO C√ÅO C√Å NH√ÇN (STUDENT REPORT) ---

        // 1. Kh·ªüi t·∫°o ch·∫ø ƒë·ªô xem b√°o c√°o
        window.viewStudentReport = (uid) => {
            state.ui.viewReportStudentId = uid;
            
            // M·∫∑c ƒë·ªãnh: T·ª´ ƒë·∫ßu th√°ng ƒë·∫øn hi·ªán t·∫°i
            const now = new Date();
            const firstDay = new Date(now.getFullYear(), now.getMonth(), 1);
            
            state.ui.reportStartDate = firstDay.toISOString().split('T')[0];
            state.ui.reportEndDate = now.toISOString().split('T')[0];
            
            state.ui.viewClassMode = 'student_report';
            renderApp();
        };

        // 2. C·∫≠p nh·∫≠t ng√†y th√°ng
        window.updateReportDate = (field, value) => {
            state.ui[field] = value;
            renderApp();
        };


// --- 2. H√ÄM RENDER GIAO DI·ªÜN XEM B√ÅO C√ÅO (ƒê√É N√ÇNG C·∫§P: G·ª¢I √ù NH·∫¨N X√âT) ---
        const renderStudentReport = (classData, studentList) => {
            const studentId = state.ui.viewReportStudentId;
            const studentInfo = studentList.find(s => s.uid === studentId);
            const userProfile = state.data.users.find(u => u.uid === studentId) || {};
            
            if (!studentInfo) return '<p class="text-center text-red-500 p-8">Kh√¥ng t√¨m th·∫•y th√¥ng tin h·ªçc sinh.</p>';

            const startDate = new Date(state.ui.reportStartDate);
            const endDate = new Date(state.ui.reportEndDate);
            endDate.setHours(23, 59, 59, 999);

            // L·∫•y nh·∫≠n x√©t ƒë√£ l∆∞u
            const commentId = `${classData.id}_${studentId}`;
            const savedCommentObj = (state.data.reportComments || []).find(c => c.id === commentId);
            const savedComment = savedCommentObj ? savedCommentObj.content : '';

            // L·ªçc d·ªØ li·ªáu
            const submissions = state.data.submissions.filter(s => {
                if (s.studentId !== studentId) return false;
                const d = s.createdAt ? new Date(s.createdAt.seconds * 1000) : new Date(0);
                if (d < startDate || d > endDate) return false;
                return !!state.data.assignments.find(a => a.id === s.assignmentId);
            }).sort((a, b) => b.createdAt - a.createdAt);

            const assessments = state.data.assessments.filter(a => {
                const d = a.date ? new Date(a.date.seconds * 1000) : new Date(0);
                const hasScore = a.scores.some(sc => sc.uid === studentId);
                return hasScore && d >= startDate && d <= endDate;
            }).sort((a, b) => b.date - a.date);

            // T√≠nh to√°n th·ªëng k√™
            const totalSubmissions = submissions.length;
            const avgAssignmentScore = totalSubmissions > 0 
                ? (submissions.reduce((sum, s) => sum + s.score, 0) / totalSubmissions)
                : 0;
            
            const totalAssessments = assessments.length;
            let avgAssessScore = 0;
            if (totalAssessments > 0) {
                let sumAvg = 0;
                assessments.forEach(a => {
                    const sc = a.scores.find(s => s.uid === studentId);
                    const criteria = a.criteria || ['T·ª´ v·ª±ng', 'Ch·ªØ vi·∫øt', 'Kh·∫©u ng·ªØ'];
                    let totalP = 0;
                    criteria.forEach(c => {
                        let val = 0;
                        if (sc.points && sc.points[c] !== undefined) val = parseFloat(sc.points[c]);
                        else if (c === 'T·ª´ v·ª±ng') val = parseFloat(sc.vocab || 0);
                        else if (c === 'Ch·ªØ vi·∫øt') val = parseFloat(sc.writing || 0);
                        else if (c === 'Kh·∫©u ng·ªØ') val = parseFloat(sc.speaking || 0);
                        totalP += val;
                    });
                    sumAvg += (criteria.length > 0 ? totalP / criteria.length : 0);
                });
                avgAssessScore = (sumAvg / assessments.length);
            }

            // T√≠nh ƒëi·ªÉm trung b√¨nh t·ªïng h·ª£p (ƒë·ªÉ g·ª£i √Ω nh·∫≠n x√©t)
            // N·∫øu c√≥ c·∫£ 2 lo·∫°i ƒëi·ªÉm th√¨ chia ƒë√¥i, n·∫øu thi·∫øu 1 lo·∫°i th√¨ l·∫•y lo·∫°i kia
            let finalAvg = 0;
            if (totalSubmissions > 0 && totalAssessments > 0) {
                // Quy ƒë·ªïi ƒëi·ªÉm b√†i t·∫≠p (thang 100) v·ªÅ thang 10 n·∫øu b√†i ki·ªÉm tra thang 10, 
                // nh∆∞ng ·ªü ƒë√¢y gi·∫£ ƒë·ªãnh t·∫•t c·∫£ ƒë·ªÅu thang 100 ho·∫∑c 10. 
                // H·ªá th·ªëng hi·ªán t·∫°i ƒëang d√πng thang 100 cho b√†i t·∫≠p v√† thang 100 cho ki·ªÉm tra (m·ªõi s·ª≠a).
                // N·∫øu ƒëi·ªÉm ki·ªÉm tra thang 10 th√¨ nh√¢n 10.
                // Gi·∫£ s·ª≠ h·ªá th·ªëng b·∫°n ƒëang d√πng ƒë·ªìng b·ªô thang 100.
                finalAvg = (avgAssignmentScore + avgAssessScore) / 2;
                
                // N·∫øu ƒëi·ªÉm qu√° th·∫•p (v√≠ d·ª• < 10) c√≥ th·ªÉ do thang ƒëi·ªÉm 10, ta nh√¢n 10 ƒë·ªÉ chu·∫©n h√≥a v·ªÅ thang 100 cho logic g·ª£i √Ω
                if (finalAvg <= 10) finalAvg = finalAvg * 10;
            } else if (totalSubmissions > 0) {
                finalAvg = avgAssignmentScore;
            } else if (totalAssessments > 0) {
                finalAvg = avgAssessScore;
            }
            
            // Chuy·ªÉn v·ªÅ thang 10 ƒë·ªÉ kh·ªõp v·ªõi logic g·ª£i √Ω
            const scoreForSuggest = finalAvg > 10 ? finalAvg / 10 : finalAvg;


            // T·∫°o Header/Row ƒë·ªông
            const allCriteriaSet = new Set();
            assessments.forEach(a => {
                const criteria = a.criteria || ['T·ª´ v·ª±ng', 'Ch·ªØ vi·∫øt', 'Kh·∫©u ng·ªØ'];
                criteria.forEach(c => allCriteriaSet.add(c));
            });
            const dynamicHeaders = Array.from(allCriteriaSet);
            const assessHeaderCols = dynamicHeaders.map(h => `<th class="py-2 text-center text-xs text-slate-500 uppercase">${h}</th>`).join('');
            
            const assignmentRows = submissions.map(s => {
                const assign = state.data.assignments.find(a => a.id === s.assignmentId);
                const dateStr = s.createdAt ? new Date(s.createdAt.seconds * 1000).toLocaleDateString('vi-VN') : '';
                return `<tr class="border-b text-sm"><td class="py-2">${dateStr}</td><td class="py-2 font-medium">${assign.title}</td><td class="py-2 text-right font-bold">${s.score}</td></tr>`;
            }).join('');

            const assessmentRows = assessments.map(a => {
                const sc = a.scores.find(s => s.uid === studentId);
                const dateStr = a.date ? new Date(a.date.seconds * 1000).toLocaleDateString('vi-VN') : '';
                const scoreCells = dynamicHeaders.map(h => {
                    let val = '-';
                    const criteria = a.criteria || ['T·ª´ v·ª±ng', 'Ch·ªØ vi·∫øt', 'Kh·∫©u ng·ªØ'];
                    if (criteria.includes(h)) {
                        if (sc.points && sc.points[h] !== undefined) val = sc.points[h];
                        else if (h === 'T·ª´ v·ª±ng') val = sc.vocab || 0;
                        else if (h === 'Ch·ªØ vi·∫øt') val = sc.writing || 0;
                        else if (h === 'Kh·∫©u ng·ªØ') val = sc.speaking || 0;
                    }
                    return `<td class="py-2 text-center text-slate-700">${val}</td>`;
                }).join('');
                const criteria = a.criteria || ['T·ª´ v·ª±ng', 'Ch·ªØ vi·∫øt', 'Kh·∫©u ng·ªØ'];
                let totalP = 0;
                criteria.forEach(c => {
                    let val = 0;
                    if (sc.points && sc.points[c] !== undefined) val = parseFloat(sc.points[c]);
                    else if (c === 'T·ª´ v·ª±ng') val = parseFloat(sc.vocab || 0);
                    else if (c === 'Ch·ªØ vi·∫øt') val = parseFloat(sc.writing || 0);
                    else if (c === 'Kh·∫©u ng·ªØ') val = parseFloat(sc.speaking || 0);
                    totalP += val;
                });
                const rowAvg = criteria.length > 0 ? (totalP / criteria.length).toFixed(1) : 0;
                return `<tr class="border-b text-sm"><td class="py-2">${dateStr}</td><td class="py-2 font-medium">${a.title}</td>${scoreCells}<td class="py-2 text-right font-bold text-indigo-600">${rowAvg}</td></tr>`;
            }).join('');

            return `
                <div class="fade-in pb-10 relative">
                    <div id="comment-library-modal" class="hidden absolute inset-0 z-50 bg-white/95 backdrop-blur-sm rounded-2xl flex flex-col p-6 animate-in fade-in zoom-in duration-200">
                        <div class="flex justify-between items-center mb-4 border-b pb-2">
                            <h3 class="text-xl font-bold text-indigo-700">Th∆∞ vi·ªán M·∫´u Nh·∫≠n x√©t</h3>
                            <button onclick="toggleCommentLibrary(false)" class="p-2 bg-slate-100 rounded-full hover:bg-red-100 text-slate-500 hover:text-red-500"><i data-lucide="x" size="20"></i></button>
                        </div>
                        <div id="library-content" class="flex-1 overflow-y-auto pr-2"></div>
                    </div>

                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4 bg-white p-4 rounded-xl border border-slate-200 shadow-sm">
                        <div>
                            <button onclick="setViewClassMode('students')" class="text-sm text-slate-500 hover:text-blue-600 mb-1 flex items-center gap-1 font-medium"><i data-lucide="arrow-left" size="16"></i> Quay l·∫°i danh s√°ch</button>
                            <h3 class="text-xl font-bold text-slate-800 flex items-center gap-2">B√°o c√°o: <span class="text-indigo-700">${studentInfo.name}</span></h3>
                        </div>
                        <div class="flex flex-wrap items-end gap-3">
                            <div class="flex flex-col"><label class="text-[10px] font-bold text-slate-500 uppercase mb-1">T·ª´ ng√†y</label><input type="date" value="${state.ui.reportStartDate}" onchange="updateReportDate('reportStartDate', this.value)" class="p-2 border rounded-lg text-sm bg-slate-50"></div>
                            <div class="flex flex-col"><label class="text-[10px] font-bold text-slate-500 uppercase mb-1">ƒê·∫øn ng√†y</label><input type="date" value="${state.ui.reportEndDate}" onchange="updateReportDate('reportEndDate', this.value)" class="p-2 border rounded-lg text-sm bg-slate-50"></div>
                            <button onclick="printStudentReportSingle('${classData.title}', '${studentInfo.name}')" class="bg-indigo-600 text-white px-5 py-2.5 rounded-xl font-bold shadow-md hover:bg-indigo-700 flex items-center gap-2"><i data-lucide="printer" size="18"></i> In B√°o C√°o</button>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                        <div class="bg-yellow-50 p-4 rounded-xl border border-yellow-200 text-center"><p class="text-xs font-bold uppercase text-yellow-700">T·ªïng ƒëi·ªÉm</p><p class="text-3xl font-black text-yellow-600">${userProfile.points || 0}</p></div>
                        <div class="bg-blue-50 p-4 rounded-xl border border-blue-200 text-center"><p class="text-xs font-bold uppercase text-blue-700">TB B√†i t·∫≠p</p><p class="text-3xl font-black text-blue-600">${avgAssignmentScore.toFixed(1)}</p></div>
                        <div class="bg-green-50 p-4 rounded-xl border border-green-200 text-center"><p class="text-xs font-bold uppercase text-green-700">TB Ki·ªÉm tra</p><p class="text-3xl font-black text-green-600">${avgAssessScore.toFixed(1)}</p></div>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="bg-white border border-slate-200 rounded-2xl p-5 shadow-sm h-[400px] flex flex-col">
                            <h4 class="font-bold text-slate-700 mb-3 pb-2 border-b flex items-center gap-2"><i data-lucide="check-square" class="text-green-600"></i> K·∫øt qu·∫£ Ki·ªÉm tra</h4>
                            <div class="overflow-auto flex-1"><table class="w-full"><thead class="bg-slate-50 sticky top-0"><tr><th class="py-2 text-left">Ng√†y</th><th class="py-2 text-left">B√†i</th>${assessHeaderCols}<th class="py-2 text-right">TB</th></tr></thead><tbody>${assessmentRows || '<tr><td colspan="10" class="text-center py-8 text-slate-400">Kh√¥ng c√≥ d·ªØ li·ªáu</td></tr>'}</tbody></table></div>
                        </div>
                        <div class="bg-white border border-slate-200 rounded-2xl p-5 shadow-sm h-[400px] flex flex-col">
                            <h4 class="font-bold text-slate-700 mb-3 pb-2 border-b flex items-center gap-2"><i data-lucide="book-open" class="text-blue-600"></i> B√†i t·∫≠p v·ªÅ nh√†</h4>
                            <div class="overflow-auto flex-1"><table class="w-full"><thead class="bg-slate-50 sticky top-0"><tr><th class="py-2 text-left">Ng√†y n·ªôp</th><th class="py-2 text-left">T√™n b√†i</th><th class="py-2 text-right">ƒêi·ªÉm</th></tr></thead><tbody>${assignmentRows || '<tr><td colspan="3" class="text-center py-8 text-slate-400">Kh√¥ng c√≥ d·ªØ li·ªáu</td></tr>'}</tbody></table></div>
                        </div>
                    </div>

                    <div class="mt-6 bg-purple-50 border border-purple-200 p-5 rounded-2xl relative">
                        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-3 gap-3">
                            <label class="font-bold text-purple-900 flex items-center gap-2"><i data-lucide="message-square"></i> Nh·∫≠n x√©t c·ªßa Gi√°o vi√™n</label>
                            
                            <div class="flex gap-2">
                                <button onclick="autoSuggestComment(${scoreForSuggest})" class="bg-white text-purple-700 border border-purple-200 hover:bg-purple-100 px-3 py-1.5 rounded-lg text-xs font-bold shadow-sm flex items-center gap-1 transition">
                                    <i data-lucide="wand-2" size="14"></i> T·ª± ƒë·ªông t·∫°o (Theo ƒëi·ªÉm)
                                </button>
                                <button onclick="toggleCommentLibrary(true)" class="bg-white text-blue-700 border border-blue-200 hover:bg-blue-100 px-3 py-1.5 rounded-lg text-xs font-bold shadow-sm flex items-center gap-1 transition">
                                    <i data-lucide="book" size="14"></i> M·∫´u nh·∫≠n x√©t
                                </button>
                                <button onclick="saveReportComment('${classData.id}', '${studentId}')" class="bg-purple-600 text-white px-4 py-1.5 rounded-lg text-xs font-bold hover:bg-purple-700 shadow-md transition flex items-center gap-1">
                                    <i data-lucide="save" size="14"></i> L∆∞u
                                </button>
                            </div>
                        </div>
                        <textarea id="report-comment" rows="4" class="w-full p-4 border border-purple-300 rounded-xl focus:ring-2 focus:ring-purple-200 outline-none bg-white text-slate-700" placeholder="Nh·∫≠p ƒë√°nh gi√° ho·∫∑c ch·ªçn t·ª´ m·∫´u...">${savedComment}</textarea>
                    </div>
                </div>
            `;
        };

 // 4. Ch·ª©c nƒÉng IN B√ÅO C√ÅO (GIAO DI·ªÜN ƒê·∫∏P + KHUNG N√âT ƒê·∫¨M)
        window.printStudentReport = (className, studentName) => {
            const startDate = new Date(state.ui.reportStartDate).toLocaleDateString('vi-VN');
            const endDate = new Date(state.ui.reportEndDate).toLocaleDateString('vi-VN');
            const comment = document.getElementById('report-comment').value.trim().replace(/\n/g, '<br>');
            
            // L·∫•y n·ªôi dung b·∫£ng t·ª´ giao di·ªán hi·ªán t·∫°i
            const assessTableRows = document.getElementById('report-assess-list').innerHTML;
            const assignTableRows = document.getElementById('report-assign-list').innerHTML;

            const html = `
                <style>
                    @media print {
                        body { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
                        .print-container { font-family: 'Times New Roman', serif; color: #000; padding: 20px; }
                        
                        /* TI√äU ƒê·ªÄ PH·∫¶N */
                        .section-title { 
                            font-weight: bold; 
                            font-size: 13pt; 
                            margin-top: 25px; 
                            margin-bottom: 10px; 
                            text-transform: uppercase; 
                            border-bottom: 2px solid #000; 
                            display: inline-block;
                            padding-bottom: 3px;
                        }

                        /* B·∫¢NG D·ªÆ LI·ªÜU - KHUNG N√âT ƒê·∫¨M */
                        .report-table { 
                            width: 100%; 
                            border-collapse: collapse; 
                            margin-bottom: 10px; 
                            font-size: 12pt;
                        }
                        .report-table th { 
                            border: 1px solid #000; 
                            padding: 8px 5px; 
                            background-color: #f0f0f0 !important; 
                            font-weight: bold; 
                            text-align: center;
                            border-bottom: 2px solid #000; /* ƒê∆∞·ªùng k·∫ª d∆∞·ªõi header ƒë·∫≠m h∆°n */
                        }
                        .report-table td { 
                            border: 1px solid #000; 
                            padding: 8px 5px; 
                        }
                        /* CƒÉn ch·ªânh c·ªôt ƒëi·ªÉm s·ªë */
                        .report-table td:last-child { text-align: center; font-weight: bold; }

                        /* KHUNG NH·∫¨N X√âT GI√ÅO VI√äN */
                        .teacher-box {
                            border: 3px double #000; /* Vi·ªÅn ƒë√¥i sang tr·ªçng */
                            border-radius: 10px;
                            padding: 20px;
                            margin-top: 30px;
                            margin-bottom: 30px;
                            position: relative;
                            background-color: #fff;
                        }
                        .teacher-box-title {
                            font-weight: bold;
                            text-transform: uppercase;
                            font-size: 13pt;
                            margin-bottom: 10px;
                            border-bottom: 1px dashed #999;
                            padding-bottom: 5px;
                        }
                        .teacher-content {
                            font-size: 13pt;
                            font-style: italic;
                            line-height: 1.6;
                            min-height: 60px;
                            text-align: justify;
                        }
                        
                        /* CH·ªÆ K√ù */
                        .signature-section {
                            display: flex; 
                            justify-content: space-between; 
                            margin-top: 20px;
                            page-break-inside: avoid;
                        }
                    }
                </style>

                <div class="print-container">
                    <div style="text-align: center; margin-bottom: 30px;">
                        <h1 style="margin: 0; font-size: 24pt; font-weight: 900; line-height: 1.2;">PHI·∫æU K·∫æT QU·∫¢ H·ªåC T·∫¨P</h1>
                        <h3 style="margin: 10px 0; font-size: 16pt;">L·ªõp: ${className}</h3>
                        <p style="margin: 0; font-size: 12pt; font-style: italic;">(T·ª´ ng√†y ${startDate} ƒë·∫øn ng√†y ${endDate})</p>
                        <h2 style="margin-top: 20px; font-size: 18pt; border: 1px solid #000; display: inline-block; padding: 10px 30px; border-radius: 30px;">
                            H·ªçc sinh: <strong>${studentName}</strong>
                        </h2>
                    </div>

                    <div class="section-title">I. K·∫øt qu·∫£ Ki·ªÉm tra ƒê·ªãnh k·ª≥</div>
                    <table class="report-table">
                        <thead>
                            <tr>
                                <th style="width: 15%;">Ng√†y</th>
                                <th>B√†i ki·ªÉm tra</th>
                                <th style="width: 10%;">T·ª´ v·ª±ng</th>
                                <th style="width: 10%;">Ch·ªØ vi·∫øt</th>
                                <th style="width: 10%;">Kh·∫©u ng·ªØ</th>
                                <th style="width: 10%;">TB</th>
                            </tr>
                        </thead>
                        <tbody>${assessTableRows}</tbody>
                    </table>

                    <div class="section-title">II. T√¨nh h√¨nh B√†i t·∫≠p v·ªÅ nh√†</div>
                    <table class="report-table">
                        <thead>
                            <tr>
                                <th style="width: 20%;">Ng√†y n·ªôp</th>
                                <th>T√™n b√†i t·∫≠p</th>
                                <th style="width: 15%;">ƒêi·ªÉm s·ªë</th>
                            </tr>
                        </thead>
                        <tbody>${assignTableRows}</tbody>
                    </table>

                    <div class="teacher-box">
                        <div class="teacher-box-title">III. Nh·∫≠n x√©t c·ªßa Gi√°o vi√™n</div>
                        <div class="teacher-content">
                            ${comment || '.....................................................................................................................................................'}
                        </div>
                    </div>

                    <div class="signature-section">
                        <div style="text-align: center; width: 40%;">
                            <p style="font-weight: bold; font-size: 12pt; margin-bottom: 80px;">PH·ª§ HUYNH H·ªåC SINH</p>
                            <p style="font-style: italic; font-size: 11pt;">(K√Ω v√† ghi r√µ h·ªç t√™n)</p>
                        </div>
                        <div style="text-align: center; width: 40%;">
                            <p style="font-style: italic; font-size: 12pt; margin-bottom: 5px;">Ng√†y ...... th√°ng ...... nƒÉm 20...</p>
                            <p style="font-weight: bold; font-size: 12pt; margin-bottom: 80px;">GI√ÅO VI√äN CH·ª¶ NHI·ªÜM</p>
                            <p style="font-style: italic; font-size: 11pt;">(K√Ω v√† ghi r√µ h·ªç t√™n)</p>
                        </div>
                    </div>
                </div>
            `;

            const printContainer = document.getElementById('print-content');
            printContainer.innerHTML = html;
            window.print();
        };
// --- LOGIC L∆ØU NH·∫¨N X√âT V√ÄO DATABASE ---
        window.saveReportComment = async (classId, studentId) => {
            const content = document.getElementById('report-comment').value.trim();
            const docId = `${classId}_${studentId}`;
            
            try {
                await setDoc(doc(db, getPath('report_comments'), docId), {
                    classId,
                    studentId,
                    content,
                    updatedAt: serverTimestamp()
                });
                showToast("ƒê√£ l∆∞u nh·∫≠n x√©t th√†nh c√¥ng!");
            } catch(e) {
                console.error(e);
                showToast("L·ªói l∆∞u nh·∫≠n x√©t: " + e.message, "error");
            }
        };

        // --- H√ÄM T·∫†O HTML B√ÅO C√ÅO (D√ôNG CHUNG CHO IN L·∫∫ V√Ä IN T·∫§T C·∫¢) ---
// --- H√ÄM T·∫†O HTML B√ÅO C√ÅO (ƒê√É N√ÇNG C·∫§P CHO TI√äU CH√ç ƒê·ªòNG) ---
// --- 1. H√ÄM T·∫†O HTML B√ÅO C√ÅO (FIX FINAL: NG·∫ÆT TRANG CHU·∫®N) ---
        const generateReportHTML = (className, studentName, startDateStr, endDateStr, comment, assessHeaderHTML, assessBodyHTML, assignRows) => {
            return `
                <div class="print-page-break">
                    
                    <div style="text-align: center; margin-bottom: 25px;">
                        <h1 style="margin: 0; font-size: 20pt; font-weight: 900; text-transform: uppercase;">PHI·∫æU K·∫æT QU·∫¢ H·ªåC T·∫¨P</h1>
                        <h3 style="margin: 10px 0 5px 0; font-size: 14pt; font-weight: normal;">L·ªõp: <b>${className}</b></h3>
                        <p style="margin: 0; font-size: 12pt; font-style: italic;">(T·ª´ ng√†y ${startDateStr} ƒë·∫øn ng√†y ${endDateStr})</p>
                        
                        <div style="margin-top: 20px;">
                            <span style="font-size: 15pt; border: 1px solid #000; padding: 8px 30px; border-radius: 50px; display: inline-block;">
                                H·ªçc sinh: <b>${studentName}</b>
                            </span>
                        </div>
                    </div>

                    <div style="font-weight: bold; font-size: 12pt; margin-top: 20px; margin-bottom: 8px; text-transform: uppercase; border-bottom: 1px solid #000; display: inline-block;">
                        I. K·∫øt qu·∫£ Ki·ªÉm tra ƒê·ªãnh k·ª≥
                    </div>
                    <table style="width: 100%; border-collapse: collapse; margin-bottom: 20px; font-size: 11pt;">
                        <thead>
                            <tr style="background-color: #f0f0f0;">
                                <th style="border: 1px solid #000; padding: 6px; width: 120px; text-align: center;">Ng√†y</th>
                                <th style="border: 1px solid #000; padding: 6px; text-align: left;">B√†i ki·ªÉm tra</th>
                                ${assessHeaderHTML}
                                <th style="border: 1px solid #000; padding: 6px; width: 60px; text-align: center;">TB</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${assessBodyHTML || '<tr><td colspan="10" style="border:1px solid #000; text-align:center; padding:10px; font-style:italic;">Ch∆∞a c√≥ d·ªØ li·ªáu ki·ªÉm tra.</td></tr>'}
                        </tbody>
                    </table>

                    <div style="font-weight: bold; font-size: 12pt; margin-top: 20px; margin-bottom: 8px; text-transform: uppercase; border-bottom: 1px solid #000; display: inline-block;">
                        II. T√¨nh h√¨nh B√†i t·∫≠p v·ªÅ nh√†
                    </div>
                    <table style="width: 100%; border-collapse: collapse; margin-bottom: 20px; font-size: 11pt;">
                        <thead>
                            <tr style="background-color: #f0f0f0;">
                                <th style="border: 1px solid #000; padding: 6px; width: 150px; text-align: center;">Ng√†y n·ªôp</th>
                                <th style="border: 1px solid #000; padding: 6px; text-align: left;">T√™n b√†i t·∫≠p</th>
                                <th style="border: 1px solid #000; padding: 6px; width: 80px; text-align: center;">ƒêi·ªÉm s·ªë</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${assignRows || '<tr><td colspan="3" style="border:1px solid #000; text-align:center; padding:10px; font-style:italic;">Ch∆∞a c√≥ d·ªØ li·ªáu b√†i t·∫≠p.</td></tr>'}
                        </tbody>
                    </table>

                    <div class="no-break-box" style="border: 1px solid #000; border-radius: 5px; padding: 15px; margin-top: 20px; margin-bottom: 30px; min-height: 100px;">
                        <div style="font-weight: bold; font-size: 11pt; text-transform: uppercase; margin-bottom: 5px; text-decoration: underline;">
                            III. Nh·∫≠n x√©t c·ªßa Gi√°o vi√™n:
                        </div>
                        <div style="font-size: 12pt; line-height: 1.5; text-align: justify; padding-top: 5px;">
                            ${comment ? comment.replace(/\n/g, '<br>') : ''}
                        </div>
                        ${!comment ? '<div style="border-bottom: 1px dotted #999; margin-top: 30px;"></div><div style="border-bottom: 1px dotted #999; margin-top: 30px;"></div>' : ''}
                    </div>

                    <div class="no-break-box" style="display: flex; justify-content: space-between; margin-top: 40px;">
                        <div style="text-align: center; width: 45%;">
                            <p style="font-weight: bold; font-size: 11pt; margin-bottom: 70px;">PH·ª§ HUYNH H·ªåC SINH</p>
                            <p style="font-style: italic; font-size: 11pt;">(K√Ω v√† ghi r√µ h·ªç t√™n)</p>
                        </div>
                        <div style="text-align: center; width: 45%;">
                            <p style="font-style: italic; font-size: 11pt; margin-bottom: 5px;">Ng√†y ...... th√°ng ...... nƒÉm 20...</p>
                            <p style="font-weight: bold; font-size: 11pt; margin-bottom: 70px;">GI√ÅO VI√äN CH·ª¶ NHI·ªÜM</p>
                            <p style="font-style: italic; font-size: 11pt;">(K√Ω v√† ghi r√µ h·ªç t√™n)</p>
                        </div>
                    </div>
                </div>
            `;
        };
        // --- IN 1 B√ÅO C√ÅO (D√πng khi ƒëang xem chi ti·∫øt) ---
        window.printStudentReportSingle = (className, studentName) => {
            const startDate = new Date(state.ui.reportStartDate).toLocaleDateString('vi-VN');
            const endDate = new Date(state.ui.reportEndDate).toLocaleDateString('vi-VN');
            const comment = document.getElementById('report-comment').value;
            
            // L·∫•y HTML t·ª´ b·∫£ng hi·ªán t·∫°i (ƒë√£ render)
            // C·∫ßn parse l·∫°i style border cho khi in
            const fixBorder = (html) => html.replace(/<td class="py-2/g, '<td style="border: 1px solid #000; padding: 5px;" class="py-2');
            
            const assessHTML = fixBorder(document.getElementById('report-assess-list').innerHTML);
            const assignHTML = fixBorder(document.getElementById('report-assign-list').innerHTML);

            const content = generateReportHTML(className, studentName, startDate, endDate, comment, assessHTML, assignHTML);
            
            const printContainer = document.getElementById('print-content');
            printContainer.innerHTML = content;
            window.print();
        };

        // --- IN T·∫§T C·∫¢ B√ÅO C√ÅO C·ª¶A L·ªöP (BATCH PRINT) ---
 window.printClassReports = (classId) => {
            const classData = state.data.classes.find(c => c.id === classId);
            if (!classData) return;

            const studentList = (classData.studentIds || []).map(sid => {
                const user = state.data.users.find(u => u.uid === sid);
                return { uid: sid, name: user ? user.name : 'Unknown' };
            });

            if(studentList.length === 0) return showToast("L·ªõp kh√¥ng c√≥ h·ªçc sinh n√†o.", "error");

            // X√°c ƒë·ªãnh th·ªùi gian b√°o c√°o
            let startDate, endDate;
            if (state.ui.viewClassMode === 'student_report') {
                startDate = new Date(state.ui.reportStartDate);
                endDate = new Date(state.ui.reportEndDate);
            } else {
                // M·∫∑c ƒë·ªãnh: ƒê·∫ßu th√°ng -> Hi·ªán t·∫°i
                const now = new Date();
                startDate = new Date(now.getFullYear(), now.getMonth(), 1);
                endDate = new Date();
            }
            endDate.setHours(23, 59, 59, 999);

            const sDateStr = startDate.toLocaleDateString('vi-VN');
            const eDateStr = endDate.toLocaleDateString('vi-VN');

            let allReportsHTML = '';

            // --- V√íNG L·∫∂P QUA T·ª™NG H·ªåC SINH ---
            studentList.forEach(s => {
                const uid = s.uid;

                // 1. L·∫•y nh·∫≠n x√©t ƒë√£ l∆∞u
                const commentId = `${classId}_${uid}`;
                const savedCommentObj = (state.data.reportComments || []).find(c => c.id === commentId);
                const comment = savedCommentObj ? savedCommentObj.content : '';

                // 2. L·ªçc B√†i t·∫≠p (ƒê√£ fix: check parent assignment)
                const submissions = state.data.submissions.filter(sub => {
                    if (sub.studentId !== uid) return false;
                    const d = sub.createdAt ? new Date(sub.createdAt.seconds * 1000) : new Date(0);
                    if (d < startDate || d > endDate) return false;
                    const parent = state.data.assignments.find(a => a.id === sub.assignmentId);
                    return !!parent; 
                }).sort((a, b) => b.createdAt - a.createdAt);

                const assignRows = submissions.map(sub => {
                    const assign = state.data.assignments.find(a => a.id === sub.assignmentId);
                    const dStr = sub.createdAt ? new Date(sub.createdAt.seconds * 1000).toLocaleDateString('vi-VN') : '';
                    return `<tr>
                        <td style="border: 1px solid #000; padding: 8px; text-align: center;">${dStr}</td>
                        <td style="border: 1px solid #000; padding: 8px;">${assign.title}</td>
                        <td style="border: 1px solid #000; padding: 8px; text-align: center; font-weight: bold;">${sub.score}</td>
                    </tr>`;
                }).join('');

                // 3. L·ªçc B√†i ki·ªÉm tra
                const assessments = state.data.assessments.filter(a => {
                    const d = a.date ? new Date(a.date.seconds * 1000) : new Date(0);
                    const hasScore = a.scores.some(sc => sc.uid === uid);
                    return hasScore && d >= startDate && d <= endDate;
                }).sort((a, b) => b.date - a.date);

                const assessRows = assessments.map(a => {
                    const sc = a.scores.find(sc => sc.uid === uid);
                    const dStr = a.date ? new Date(a.date.seconds * 1000).toLocaleDateString('vi-VN') : '';
                    
                    const criteria = a.criteria || ['T·ª´ v·ª±ng', 'Ch·ªØ vi·∫øt', 'Kh·∫©u ng·ªØ'];
                    let total = 0;
                    let detailsArr = [];
                    
                    criteria.forEach(c => {
                        let val = 0;
                        if (sc.points && sc.points[c] !== undefined) val = parseFloat(sc.points[c]);
                        else if (c === 'T·ª´ v·ª±ng') val = parseFloat(sc.vocab || 0);
                        else if (c === 'Ch·ªØ vi·∫øt') val = parseFloat(sc.writing || 0);
                        else if (c === 'Kh·∫©u ng·ªØ') val = parseFloat(sc.speaking || 0);
                        total += val;
                        detailsArr.push(`${c}: ${val}`);
                    });
                    
                    const avg = criteria.length > 0 ? (total / criteria.length).toFixed(1) : 0;
                    const detailsStr = detailsArr.join(' | ');

                    return `<tr>
                        <td style="border: 1px solid #000; padding: 8px; text-align: center;">${dStr}</td>
                        <td style="border: 1px solid #000; padding: 8px;">${a.title}</td>
                        <td style="border: 1px solid #000; padding: 8px;">${detailsStr}</td>
                        <td style="border: 1px solid #000; padding: 8px; text-align: center; font-weight: bold;">${avg}</td>
                    </tr>`;
                }).join('');

                // 4. N·ªëi HTML v√†o chu·ªói t·ªïng
                allReportsHTML += generateReportHTML(classData.title, s.name, sDateStr, eDateStr, comment, assessRows, assignRows);
            });

            // 5. In
            const printContainer = document.getElementById('print-content');
            printContainer.innerHTML = allReportsHTML;
            window.print();
        };
// --- LOGIC HELPER ƒê·ªÇ T·∫†O D·ªÆ LI·ªÜU IN CHO 1 H·ªåC SINH ---
        const getStudentPrintData = (studentId, studentName, classId, startDate, endDate) => {
            // 1. L·∫•y d·ªØ li·ªáu
            const submissions = state.data.submissions.filter(s => {
                if (s.studentId !== studentId) return false;
                const d = s.createdAt ? new Date(s.createdAt.seconds * 1000) : new Date(0);
                if (d < startDate || d > endDate) return false;
                return !!state.data.assignments.find(a => a.id === s.assignmentId);
            }).sort((a, b) => b.createdAt - a.createdAt);

            const assessments = state.data.assessments.filter(a => {
                const d = a.date ? new Date(a.date.seconds * 1000) : new Date(0);
                return a.scores.some(sc => sc.uid === studentId) && d >= startDate && d <= endDate;
            }).sort((a, b) => b.date - a.date);

            // 2. X√°c ƒë·ªãnh c√°c ti√™u ch√≠ ƒë·ªông
            const allCriteriaSet = new Set();
            assessments.forEach(a => {
                const criteria = a.criteria || ['T·ª´ v·ª±ng', 'Ch·ªØ vi·∫øt', 'Kh·∫©u ng·ªØ'];
                criteria.forEach(c => allCriteriaSet.add(c));
            });
            const dynamicHeaders = Array.from(allCriteriaSet);

            // 3. T·∫°o HTML Header B·∫£ng Ki·ªÉm tra
            const assessHeaderHTML = dynamicHeaders.map(h => 
                `<th style="border: 1px solid #000; padding: 6px; text-align: center; background: #f0f0f0;">${h}</th>`
            ).join('');

            // 4. T·∫°o HTML Rows B·∫£ng Ki·ªÉm tra
            const assessBodyHTML = assessments.map(a => {
                const sc = a.scores.find(s => s.uid === studentId);
                const dateStr = a.date ? new Date(a.date.seconds * 1000).toLocaleDateString('vi-VN') : '';
                
                // Cells ƒëi·ªÉm
                const scoreCells = dynamicHeaders.map(h => {
                    let val = '-';
                    const criteria = a.criteria || ['T·ª´ v·ª±ng', 'Ch·ªØ vi·∫øt', 'Kh·∫©u ng·ªØ'];
                    if (criteria.includes(h)) {
                        if (sc.points && sc.points[h] !== undefined) val = sc.points[h];
                        else if (h === 'T·ª´ v·ª±ng') val = sc.vocab || 0;
                        else if (h === 'Ch·ªØ vi·∫øt') val = sc.writing || 0;
                        else if (h === 'Kh·∫©u ng·ªØ') val = sc.speaking || 0;
                    }
                    return `<td style="border: 1px solid #000; padding: 6px; text-align: center;">${val}</td>`;
                }).join('');

                // TB
                const criteria = a.criteria || ['T·ª´ v·ª±ng', 'Ch·ªØ vi·∫øt', 'Kh·∫©u ng·ªØ'];
                let totalP = 0;
                criteria.forEach(c => {
                    let val = 0;
                    if (sc.points && sc.points[c] !== undefined) val = parseFloat(sc.points[c]);
                    else if (c === 'T·ª´ v·ª±ng') val = parseFloat(sc.vocab || 0);
                    else if (c === 'Ch·ªØ vi·∫øt') val = parseFloat(sc.writing || 0);
                    else if (c === 'Kh·∫©u ng·ªØ') val = parseFloat(sc.speaking || 0);
                    totalP += val;
                });
                const rowAvg = criteria.length > 0 ? (totalP / criteria.length).toFixed(1) : 0;

                return `<tr>
                    <td style="border: 1px solid #000; padding: 6px; text-align: center;">${dateStr}</td>
                    <td style="border: 1px solid #000; padding: 6px;">${a.title}</td>
                    ${scoreCells}
                    <td style="border: 1px solid #000; padding: 6px; text-align: center; font-weight: bold;">${rowAvg}</td>
                </tr>`;
            }).join('');

            // 5. T·∫°o HTML Rows B√†i t·∫≠p
            const assignRows = submissions.map(s => {
                const assign = state.data.assignments.find(a => a.id === s.assignmentId);
                const dStr = s.createdAt ? new Date(s.createdAt.seconds * 1000).toLocaleDateString('vi-VN') : '';
                return `<tr>
                    <td style="border: 1px solid #000; padding: 6px; text-align: center;">${dStr}</td>
                    <td style="border: 1px solid #000; padding: 6px;">${assign.title}</td>
                    <td style="border: 1px solid #000; padding: 6px; text-align: center; font-weight: bold;">${s.score}</td>
                </tr>`;
            }).join('');

            // 6. L·∫•y Comment
            const commentData = (state.data.reportComments || []).find(c => c.id === `${classId}_${studentId}`);
            
            return { assessHeaderHTML, assessBodyHTML, assignRows, comment: commentData ? commentData.content : '' };
        };

        // --- IN 1 B√ÅO C√ÅO ---
        window.printStudentReportSingle = (className, studentName) => {
            const startDate = new Date(state.ui.reportStartDate);
            const endDate = new Date(state.ui.reportEndDate);
            endDate.setHours(23, 59, 59, 999);
            
            // L·∫•y comment hi·ªán t·∫°i t·ª´ √¥ input (ch∆∞a c·∫ßn l∆∞u c≈©ng in ƒë∆∞·ª£c c√°i m·ªõi nh·∫•t ƒëang g√µ)
            const inputComment = document.getElementById('report-comment').value;

            // T√≠nh to√°n l·∫°i d·ªØ li·ªáu b·∫£ng (ƒë·ªÉ ƒë·∫£m b·∫£o format in chu·∫©n, kh√¥ng l·∫•y t·ª´ DOM)
            const data = getStudentPrintData(state.ui.viewReportStudentId, studentName, state.ui.viewClassId, startDate, endDate);
            
            // Override comment b·∫±ng c√°i ƒëang nh·∫≠p
            const html = generateReportHTML(className, studentName, startDate.toLocaleDateString('vi-VN'), endDate.toLocaleDateString('vi-VN'), inputComment, data.assessHeaderHTML, data.assessBodyHTML, data.assignRows);
            
            const printContainer = document.getElementById('print-content');
            printContainer.innerHTML = html;
            window.print();
        };

        // --- IN T·∫§T C·∫¢ ---
        window.printClassReports = (classId) => {
            const classData = state.data.classes.find(c => c.id === classId);
            if (!classData) return;

            const studentList = (classData.studentIds || []).map(sid => {
                const user = state.data.users.find(u => u.uid === sid);
                return { uid: sid, name: user ? user.name : 'Unknown' };
            });

            if(studentList.length === 0) return showToast("L·ªõp kh√¥ng c√≥ h·ªçc sinh n√†o.", "error");

            let startDate, endDate;
            if (state.ui.viewClassMode === 'student_report') {
                startDate = new Date(state.ui.reportStartDate);
                endDate = new Date(state.ui.reportEndDate);
            } else {
                const now = new Date();
                startDate = new Date(now.getFullYear(), now.getMonth(), 1);
                endDate = new Date();
            }
            endDate.setHours(23, 59, 59, 999);

            let allReportsHTML = '';

            studentList.forEach(s => {
                const data = getStudentPrintData(s.uid, s.name, classId, startDate, endDate);
                allReportsHTML += generateReportHTML(classData.title, s.name, startDate.toLocaleDateString('vi-VN'), endDate.toLocaleDateString('vi-VN'), data.comment, data.assessHeaderHTML, data.assessBodyHTML, data.assignRows);
            });

            const printContainer = document.getElementById('print-content');
            printContainer.innerHTML = allReportsHTML;
            window.print();
        };
// --- HANDLER XEM CHI TI·∫æT B√ÄI KI·ªÇM TRA ---
        window.viewAssessmentDetail = (id) => {
            state.ui.selectedAssessmentId = id;
            renderApp();
        };
// --- 1. C·∫§U H√åNH TH∆Ø VI·ªÜN NH·∫¨N X√âT (PHI√äN B·∫¢N CHUY√äN S√ÇU & CHI TI·∫æT) ---
        // M·ªói nh·∫≠n x√©t ƒë∆∞·ª£c thi·∫øt k·∫ø nh∆∞ m·ªôt b√†i ƒë√°nh gi√° nƒÉng l·ª±c to√†n di·ªán.
        const COMMENT_LIBRARY = {
            excellent: [ // 9.0 - 10.0 (Xu·∫•t s·∫Øc)
                "H·ªçc sinh c√≥ th√°i ƒë·ªô h·ªçc t·∫≠p r·∫•t nghi√™m t√∫c, lu√¥n ho√†n th√†nh b√†i t·∫≠p v·ªÅ nh√† ƒë·∫ßy ƒë·ªß v√† ƒë√∫ng h·∫°n. V·ªën t·ª´ v·ª±ng phong ph√∫, ch·ªØ vi·∫øt n·∫Øn n√≥t, ƒë·∫πp. Kh·∫£ nƒÉng kh·∫©u ng·ªØ l∆∞u lo√°t, ph√°t √¢m chu·∫©n. R·∫•t t√≠ch c·ª±c ph√°t bi·ªÉu x√¢y d·ª±ng b√†i.",
                "Em l√† m·ªôt h·ªçc sinh th√¥ng minh, ti·∫øp thu b√†i nhanh. C√°c k·ªπ nƒÉng nghe, n√≥i, ƒë·ªçc, vi·∫øt ƒë·ªÅu ph√°t tri·ªÉn t·ªët. B√†i v·ªÅ nh√† lu√¥n ƒë·∫°t ƒëi·ªÉm cao. Tinh th·∫ßn h·ªçc t·∫≠p r·∫•t ƒë√°ng khen ng·ª£i, l√† t·∫•m g∆∞∆°ng s√°ng cho c·∫£ l·ªõp.",
                "K·∫øt qu·∫£ h·ªçc t·∫≠p xu·∫•t s·∫Øc. Em n·∫Øm ch·∫Øc ki·∫øn th·ª©c t·ª´ v·ª±ng v√† ng·ªØ ph√°p. Ch·ªØ vi·∫øt r√µ r√†ng, s·∫°ch ƒë·∫πp. Kh·∫£ nƒÉng ph·∫£n x·∫° ng√¥n ng·ªØ nhanh nh·∫°y. C·∫ßn ti·∫øp t·ª•c ph√°t huy tinh th·∫ßn t·ª± gi√°c n√†y.",
                "Th√†nh t√≠ch h·ªçc t·∫≠p r·∫•t ·∫•n t∆∞·ª£ng. Em kh√¥ng ch·ªâ ho√†n th√†nh t·ªët b√†i v·ªü m√† c√≤n bi·∫øt c√°ch v·∫≠n d·ª•ng t·ª´ v·ª±ng linh ho·∫°t v√†o giao ti·∫øp. Ch·ªØ H√°n vi·∫øt ƒë√∫ng quy t·∫Øc b√∫t thu·∫≠n, r·∫•t ƒë·∫πp. R·∫•t ƒë√°ng khen!",
                "Em c√≥ t·ªë ch·∫•t ng√¥n ng·ªØ r·∫•t t·ªët. Ti·∫øp thu b√†i nhanh, nh·ªõ t·ª´ v·ª±ng l√¢u v√† s·ª≠ d·ª•ng ch√≠nh x√°c. Lu√¥n ch·ªß ƒë·ªông trong gi·ªù h·ªçc v√† h·ªó tr·ª£ c√°c b·∫°n kh√°c. H√£y c·ªë g·∫Øng duy tr√¨ phong ƒë·ªô n√†y nh√©!",
                "B√†i l√†m c·ªßa em lu√¥n ch·ªân chu v√† ƒë·∫°t ƒë·ªô ch√≠nh x√°c cao. K·ªπ nƒÉng nghe hi·ªÉu v∆∞·ª£t tr·ªôi. Ch·ªØ vi·∫øt ng√†y c√†ng ti·∫øn b·ªô, n√©t ch·ªØ c·ª©ng c√°p. Gi√°o vi√™n r·∫•t h√†i l√≤ng v·ªÅ s·ª± n·ªó l·ª±c c·ªßa em."
            ],
            good: [ // 7.0 - 8.9 (Kh√°)
                "H·ªçc sinh c√≥ √Ω th·ª©c h·ªçc t·∫≠p t·ªët, l√†m b√†i t·∫≠p v·ªÅ nh√† ƒë·∫ßy ƒë·ªß. N·∫Øm v·ªØng t·ª´ v·ª±ng c∆° b·∫£n, tuy nhi√™n c·∫ßn ch√∫ √Ω h∆°n v·ªÅ quy t·∫Øc b√∫t thu·∫≠n khi vi·∫øt ch·ªØ. Kh·∫©u ng·ªØ kh√° t·ªët, c·∫ßn t·ª± tin h∆°n khi giao ti·∫øp.",
                "Em ti·∫øp thu b√†i t·ªët, th√°i ƒë·ªô h·ªçc t·∫≠p t√≠ch c·ª±c. V·ªën t·ª´ v·ª±ng kh√°, ch·ªØ vi·∫øt ti·∫øn b·ªô. ƒê√¥i khi c√≤n m·∫Øc l·ªói nh·ªè trong ng·ªØ ph√°p nh∆∞ng ƒë√£ bi·∫øt c√°ch s·ª≠a sai. C·∫ßn luy·ªán t·∫≠p th√™m kh·∫©u ng·ªØ ƒë·ªÉ n√≥i tr√¥i ch·∫£y h∆°n.",
                "H·ªçc l·ª±c Kh√°. Em ho√†n th√†nh t·ªët c√°c nhi·ªám v·ª• ƒë∆∞·ª£c giao. Ch·ªØ vi·∫øt c·∫ßn n·∫Øn n√≥t h∆°n m·ªôt ch√∫t. Kh·∫£ nƒÉng nghe hi·ªÉu t·ªët, tuy nhi√™n c·∫ßn m·∫°nh d·∫°n h∆°n khi tham gia c√°c ho·∫°t ƒë·ªông n√≥i tr√™n l·ªõp.",
                "Em c√≥ n·ªÅn t·∫£ng ki·∫øn th·ª©c v·ªØng v√†ng. B√†i t·∫≠p v·ªÅ nh√† l√†m kh√° c·∫©n th·∫≠n. Tuy nhi√™n, ph·∫ßn ph√°t √¢m c·∫ßn ch√∫ √Ω th√™m v·ªÅ thanh ƒëi·ªáu ƒë·ªÉ chu·∫©n x√°c h∆°n. C·ªë g·∫Øng ph√°t bi·ªÉu nhi·ªÅu h∆°n nh√©.",
                "K·∫øt qu·∫£ h·ªçc t·∫≠p ·ªïn ƒë·ªãnh. Em nh·ªõ t·ª´ v·ª±ng t·ªët nh∆∞ng khi ƒë·∫∑t c√¢u ƒë√¥i l√∫c c√≤n l√∫ng t√∫ng. Ch·ªØ vi·∫øt kh√° ƒë·∫πp nh∆∞ng c·∫ßn vi·∫øt nhanh h∆°n. C·∫ßn r√®n luy·ªán th√™m k·ªπ nƒÉng ph·∫£n x·∫° khi nghe.",
                "Th√°i ƒë·ªô h·ªçc t·∫≠p chƒÉm ch·ªâ. Em hi·ªÉu b√†i v√† v·∫≠n d·ª•ng kh√° t·ªët. Tuy nhi√™n, ƒë√¥i khi c√≤n sai s√≥t nh·ªè do b·∫•t c·∫©n trong b√†i ki·ªÉm tra. H√£y ki·ªÉm tra k·ªπ b√†i l√†m tr∆∞·ªõc khi n·ªôp ƒë·ªÉ ƒë·∫°t ƒëi·ªÉm cao h∆°n."
            ],
            average: [ // 5.0 - 6.9 (Trung b√¨nh)
                "H·ªçc sinh c√≥ c·ªë g·∫Øng nh∆∞ng k·∫øt qu·∫£ ch∆∞a cao. B√†i t·∫≠p v·ªÅ nh√† ƒë√¥i khi c√≤n thi·∫øu ho·∫∑c l√†m ch∆∞a k·ªπ. C·∫ßn √¥n t·∫≠p l·∫°i t·ª´ v·ª±ng th∆∞·ªùng xuy√™n h∆°n. Ch·ªØ vi·∫øt c√≤n sai quy t·∫Øc. C·∫ßn t·∫≠p trung h∆°n trong gi·ªù h·ªçc.",
                "S·ª©c h·ªçc trung b√¨nh. Em c·∫ßn chƒÉm ch·ªâ h∆°n trong vi·ªác h·ªçc t·ª´ m·ªõi v√† luy·ªán vi·∫øt. Kh·∫£ nƒÉng kh·∫©u ng·ªØ c√≤n h·∫°n ch·∫ø, c·∫ßn luy·ªán n√≥i nhi·ªÅu h∆°n ·ªü nh√†. Th√°i ƒë·ªô h·ªçc t·∫≠p c·∫ßn nghi√™m t√∫c h∆°n ƒë·ªÉ ti·∫øn b·ªô.",
                "Em c·∫ßn n·ªó l·ª±c nhi·ªÅu h∆°n. Ki·∫øn th·ª©c n·ªÅn t·∫£ng ch∆∞a th·ª±c s·ª± v·ªØng ch·∫Øc. C·∫ßn ch√∫ √Ω l·∫Øng nghe gi·∫£ng v√† ho√†n th√†nh b√†i t·∫≠p v·ªÅ nh√† ƒë·∫ßy ƒë·ªß ƒë·ªÉ c·∫£i thi·ªán ƒëi·ªÉm s·ªë.",
                "Vi·ªác h·ªçc t·ª´ v·ª±ng c·ªßa em c√≤n ch∆∞a ƒë·ªÅu ƒë·∫∑n, d·∫´n ƒë·∫øn hay qu√™n b√†i c≈©. Ch·ªØ vi·∫øt c·∫ßn luy·ªán t·∫≠p th√™m ƒë·ªÉ ƒë√∫ng n√©t. C·∫ßn m·∫°nh d·∫°n h·ªèi th·∫ßy c√¥ nh·ªØng ch·ªó ch∆∞a hi·ªÉu.",
                "Em l√†m b√†i t·∫≠p c√≤n s∆° s√†i, ch∆∞a ƒë·∫ßu t∆∞ th·ªùi gian. K·ªπ nƒÉng nghe c√≤n y·∫øu, c·∫ßn luy·ªán nghe th·ª• ƒë·ªông nhi·ªÅu h∆°n. C·ªë g·∫Øng t·∫≠p trung nghe gi·∫£ng ƒë·ªÉ n·∫Øm b·∫Øt ki·∫øn th·ª©c tr·ªçng t√¢m.",
                "Ti·∫øn ƒë·ªô h·ªçc t·∫≠p h∆°i ch·∫≠m so v·ªõi c√°c b·∫°n. C·∫ßn d√†nh th√™m th·ªùi gian t·ª± h·ªçc ·ªü nh√†, ƒë·∫∑c bi·ªát l√† ph·∫ßn luy·ªán vi·∫øt ch·ªØ H√°n v√† ph√°t √¢m. C·∫ßn t√≠ch c·ª±c h∆°n n·ªØa."
            ],
            weak: [ // D∆∞·ªõi 5.0 (Y·∫øu)
                "K·∫øt qu·∫£ h·ªçc t·∫≠p ch∆∞a ƒë·∫°t y√™u c·∫ßu. Em th∆∞·ªùng xuy√™n thi·∫øu b√†i t·∫≠p v·ªÅ nh√†. V·ªën t·ª´ v·ª±ng c√≤n y·∫øu, ch·ªØ vi·∫øt ch∆∞a ƒë·∫°t chu·∫©n. C·∫ßn ch·∫•n ch·ªânh l·∫°i th√°i ƒë·ªô h·ªçc t·∫≠p v√† d√†nh nhi·ªÅu th·ªùi gian √¥n luy·ªán h∆°n.",
                "S·ª©c h·ªçc y·∫øu. C·∫ßn s·ª± h·ªó tr·ª£ nhi·ªÅu t·ª´ gia ƒë√¨nh v√† gi√°o vi√™n. Em ch∆∞a t·∫≠p trung trong gi·ªù h·ªçc, c√≤n h·ªïng nhi·ªÅu ki·∫øn th·ª©c c∆° b·∫£n. C·∫ßn nghi√™m t√∫c h∆°n trong vi·ªác h·ªçc t·∫≠p.",
                "Em r·∫•t l∆∞·ªùi h·ªçc t·ª´ m·ªõi, d·∫´n ƒë·∫øn kh√¥ng hi·ªÉu b√†i v√† kh√¥ng l√†m ƒë∆∞·ª£c b√†i t·∫≠p. Ch·ªØ vi·∫øt r·∫•t c·∫©u th·∫£. C·∫ßn thay ƒë·ªïi ngay th√°i ƒë·ªô h·ªçc t·∫≠p n·∫øu kh√¥ng mu·ªën b·ªã t·ª•t l·∫°i ph√≠a sau.",
                "Th∆∞·ªùng xuy√™n m·∫•t t·∫≠p trung trong gi·ªù, kh√¥ng ghi ch√©p b√†i ƒë·∫ßy ƒë·ªß. B√†i ki·ªÉm tra ƒëi·ªÉm th·∫•p do kh√¥ng thu·ªôc b√†i. C·∫ßn c√≥ bi·ªán ph√°p k√®m c·∫∑p th√™m ƒë·ªÉ l·∫•y l·∫°i ki·∫øn th·ª©c cƒÉn b·∫£n.",
                "K·ªπ nƒÉng ng√¥n ng·ªØ c√≤n r·∫•t h·∫°n ch·∫ø. Em ch∆∞a n·∫Øm ƒë∆∞·ª£c quy t·∫Øc vi·∫øt v√† c√°ch ph√°t √¢m c∆° b·∫£n. C·∫ßn xem l·∫°i c√°c b√†i gi·∫£ng c≈© v√† l√†m l·∫°i to√†n b·ªô b√†i t·∫≠p ƒë·ªÉ c·ªßng c·ªë ki·∫øn th·ª©c."
            ]
        };

        // --- 2. H√ÄM LOGIC X·ª¨ L√ù NH·∫¨N X√âT ---
        
        // H√†m t·ª± ƒë·ªông t·∫°o nh·∫≠n x√©t d·ª±a tr√™n ƒëi·ªÉm
        window.autoSuggestComment = (avgScore) => {
            let type = 'weak';
            if (avgScore >= 9) type = 'excellent';
            else if (avgScore >= 7) type = 'good';
            else if (avgScore >= 5) type = 'average';

            const templates = COMMENT_LIBRARY[type];
            const randomComment = templates[Math.floor(Math.random() * templates.length)];
            
            document.getElementById('report-comment').value = randomComment;
            showToast("ƒê√£ t·∫°o nh·∫≠n x√©t t·ª± ƒë·ªông d·ª±a tr√™n ƒëi·ªÉm s·ªë!");
        };

        // H√†m m·ªü/ƒë√≥ng th∆∞ vi·ªán m·∫´u
        window.toggleCommentLibrary = (show) => {
            const modal = document.getElementById('comment-library-modal');
            if (show) {
                // Render n·ªôi dung modal
                const contentEl = document.getElementById('library-content');
                let html = '';
                
                const sections = [
                    { id: 'excellent', label: 'Gi·ªèi / Xu·∫•t s·∫Øc (9-10)', color: 'text-green-600' },
                    { id: 'good', label: 'Kh√° (7-8)', color: 'text-blue-600' },
                    { id: 'average', label: 'Trung b√¨nh (5-6)', color: 'text-yellow-600' },
                    { id: 'weak', label: 'C·∫ßn c·ªë g·∫Øng (<5)', color: 'text-red-600' }
                ];

                sections.forEach(sec => {
                    html += `<h4 class="font-bold ${sec.color} mb-2 mt-4 uppercase text-sm border-b pb-1">${sec.label}</h4>`;
                    html += `<div class="space-y-2">`;
                    COMMENT_LIBRARY[sec.id].forEach(cmt => {
                        html += `
                            <div onclick="selectCommentFromLib('${cmt.replace(/'/g, "\\'")}')" 
                                 class="p-3 bg-slate-50 hover:bg-indigo-50 border border-slate-200 rounded-lg cursor-pointer text-sm text-slate-700 transition">
                                ${cmt}
                            </div>`;
                    });
                    html += `</div>`;
                });
                
                contentEl.innerHTML = html;
                modal.classList.remove('hidden');
            } else {
                modal.classList.add('hidden');
            }
        };

        // H√†m ch·ªçn c√¢u t·ª´ th∆∞ vi·ªán
        window.selectCommentFromLib = (text) => {
            const textarea = document.getElementById('report-comment');
            // N·∫øu ƒë√£ c√≥ n·ªôi dung th√¨ xu·ªëng d√≤ng r·ªìi c·ªông th√™m
            if (textarea.value.trim()) {
                textarea.value += "\n" + text;
            } else {
                textarea.value = text;
            }
            toggleCommentLibrary(false);
        };
// --- HANDLER L·ªåC B√ÄI T·∫¨P THEO L·ªöP ---
        window.setAssignmentFilter = (classId) => {
            state.ui.filterClassId = classId;
            renderApp();
        };
// --- LOGIC M·ªöI: MODAL TH·ªêNG K√ä B√ÄI T·∫¨P ---

// 1. H√†m m·ªü modal th·ªëng k√™ (Thay th·∫ø h√†m c≈©)
window.openAssignmentStats = (e, assignmentId) => {
    e.stopPropagation(); // NgƒÉn click v√†o th·∫ª b√†i t·∫≠p
    state.ui.statsModalAssignmentId = assignmentId; // ƒê·∫∑t state ƒë·ªÉ hi·ªán modal
    renderApp();
};

// 2. H√†m ƒë√≥ng modal
window.closeAssignmentStats = () => {
    state.ui.statsModalAssignmentId = null;
    renderApp();
};

// 3. H√†m v·∫Ω giao di·ªán Modal Th·ªëng k√™ (ƒê√£ b·ªè Email, gi·ªØ logic S·∫Øp x·∫øp)
const renderStatsModal = () => {
    const assignId = state.ui.statsModalAssignmentId;
    const assign = state.data.assignments.find(a => a.id === assignId);
    if (!assign) return '';

    // L·∫•y danh s√°ch ID h·ªçc sinh t·ª´ c√°c l·ªõp ƒë∆∞·ª£c giao
    let targetStudentIds = new Set();
    if (assign.classIds && Array.isArray(assign.classIds)) {
        assign.classIds.forEach(cid => {
            const cls = state.data.classes.find(c => c.id === cid);
            if (cls && cls.studentIds) {
                cls.studentIds.forEach(sid => targetStudentIds.add(sid));
            }
        });
    }

    // L·∫•y d·ªØ li·ªáu h·ªçc sinh g·ªëc
    const studentsRaw = Array.from(targetStudentIds).map(uid => 
        state.data.users.find(u => u.uid === uid)
    ).filter(Boolean);

    // L·∫•y t·∫•t c·∫£ b√†i n·ªôp
    const submissions = state.data.submissions.filter(s => s.assignmentId === assignId);

    // G·ªôp d·ªØ li·ªáu v√† S·∫Øp x·∫øp (Cao -> Th·∫•p)
    const studentsSorted = studentsRaw.map(st => {
        const sub = submissions.find(s => s.studentId === st.uid);
        return {
            info: st,
            hasSubmitted: !!sub,
            score: sub ? sub.score : -1, 
            subId: sub ? sub.id : null
        };
    }).sort((a, b) => {
        if (b.score !== a.score) return b.score - a.score;
        return a.info.name.localeCompare(b.info.name);
    });

    // T·∫°o c√°c d√≤ng trong b·∫£ng
    const rows = studentsSorted.map((item, idx) => {
        const { info, hasSubmitted, score, subId } = item;
        
        let scoreClass = 'text-slate-400 font-normal';
        let displayScore = '-';
        
        if (hasSubmitted) {
            displayScore = score;
            if (score >= 80) scoreClass = 'text-green-600 font-bold';
            else if (score >= 50) scoreClass = 'text-orange-600 font-bold';
            else scoreClass = 'text-red-600 font-bold';
        }

        return `
            <tr class="border-b last:border-0 hover:bg-slate-50 transition cursor-pointer" 
                onclick="${hasSubmitted ? `viewSubmissionResult('${subId}')` : ''}">
                <td class="py-3 pl-4 text-center text-slate-500">${idx + 1}</td>
                <td class="py-3">
                    <div class="flex items-center gap-3">
                        <div class="w-8 h-8 rounded-full bg-blue-100 flex items-center justify-center text-blue-600 font-bold text-xs">
                            ${info.name ? info.name.charAt(0).toUpperCase() : '?'}
                        </div>
                        <div class="font-bold text-slate-700 text-sm">
                            ${info.name}
                        </div>
                    </div>
                </td>
                <td class="py-3 text-center">
                    ${hasSubmitted 
                        ? `<span class="px-2 py-1 bg-green-100 text-green-700 text-xs rounded-full font-bold">ƒê√£ n·ªôp</span>` 
                        : `<span class="px-2 py-1 bg-slate-100 text-slate-500 text-xs rounded-full">Ch∆∞a n·ªôp</span>`}
                </td>
                <td class="py-3 text-center ${scoreClass} text-base">
                    ${displayScore}
                </td>
                <td class="py-3 text-right pr-4">
                    ${hasSubmitted 
                        ? `<button class="text-blue-600 hover:bg-blue-50 p-2 rounded-full"><i data-lucide="eye" size="16"></i></button>` 
                        : ''}
                </td>
            </tr>
        `;
    }).join('');

    // S·ªë li·ªáu th·ªëng k√™
    const totalCount = studentsSorted.length;
    const submittedCount = studentsSorted.filter(s => s.hasSubmitted).length;
    const notSubmittedCount = totalCount - submittedCount;

    return `
        <div class="fixed inset-0 z-[9999] flex items-center justify-center p-4 bg-slate-900/50 backdrop-blur-sm fade-in" onclick="if(event.target === this) closeAssignmentStats()">
            <div class="bg-white w-full max-w-3xl rounded-2xl shadow-2xl flex flex-col max-h-[90vh] animate-in zoom-in-95 duration-200">
                
                <div class="p-5 border-b border-slate-100 flex justify-between items-center bg-slate-50 rounded-t-2xl">
                    <div>
                        <h3 class="text-xl font-bold text-slate-800 flex items-center gap-2">
                            <i data-lucide="bar-chart-3" class="text-blue-600"></i> Th·ªëng k√™ b√†i t·∫≠p
                        </h3>
                        <p class="text-sm text-slate-500 mt-1 truncate max-w-md" title="${assign.title}">${assign.title}</p>
                    </div>
                    <button onclick="closeAssignmentStats()" class="p-2 bg-white text-slate-400 hover:text-red-500 hover:bg-red-50 rounded-full shadow-sm transition">
                        <i data-lucide="x" size="20"></i>
                    </button>
                </div>

                <div class="grid grid-cols-3 gap-4 p-4 border-b border-slate-100 bg-white">
                    <div class="text-center p-3 bg-blue-50 rounded-xl">
                        <p class="text-xs text-blue-500 font-bold uppercase">Sƒ© s·ªë</p>
                        <p class="text-xl font-black text-blue-700">${totalCount}</p>
                    </div>
                    <div class="text-center p-3 bg-green-50 rounded-xl">
                        <p class="text-xs text-green-500 font-bold uppercase">ƒê√£ n·ªôp</p>
                        <p class="text-xl font-black text-green-700">${submittedCount}</p>
                    </div>
                    <div class="text-center p-3 bg-orange-50 rounded-xl">
                        <p class="text-xs text-orange-500 font-bold uppercase">Ch∆∞a n·ªôp</p>
                        <p class="text-xl font-black text-orange-700">${notSubmittedCount}</p>
                    </div>
                </div>

                <div class="flex-1 overflow-y-auto p-0 scrollbar-hide">
                    <table class="w-full text-left border-collapse">
                        <thead class="bg-slate-50 sticky top-0 z-10 shadow-sm text-xs font-bold text-slate-500 uppercase">
                            <tr>
                                <th class="py-3 pl-4 text-center w-12">#</th>
                                <th class="py-3">H·ªçc sinh</th>
                                <th class="py-3 text-center w-24">Tr·∫°ng th√°i</th>
                                <th class="py-3 text-center w-20">ƒêi·ªÉm</th>
                                <th class="py-3 text-right pr-4 w-16">Xem</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-slate-100">
                            ${rows.length > 0 ? rows : `<tr><td colspan="5" class="p-8 text-center text-slate-400">Ch∆∞a c√≥ h·ªçc sinh trong l·ªõp ƒë∆∞·ª£c giao.</td></tr>`}
                        </tbody>
                    </table>
                </div>
                
                <div class="p-4 border-t border-slate-100 bg-slate-50 rounded-b-2xl text-right">
                    <button onclick="closeAssignmentStats()" class="px-5 py-2 bg-white border border-slate-300 text-slate-600 font-bold rounded-xl hover:bg-slate-100 transition shadow-sm text-sm">
                        ƒê√≥ng
                    </button>
                </div>
            </div>
        </div>
    `;
};
// ============================================================
// === MODULE: SAO L∆ØU & KH√îI PH·ª§C D·ªÆ LI·ªÜU (BACKUP & RESTORE) ===
// ============================================================

// 1. C·∫•u h√¨nh Mapping gi·ªØa State (Bi·∫øn) v√† Collection (Firebase)
const DB_MAP = {
    users: 'users',
    classes: 'classes',
    assignments: 'assignments',
    questionBanks: 'question_banks', // L∆∞u √Ω: T√™n bi·∫øn camelCase -> T√™n collection snake_case
    submissions: 'submissions',
    matches: 'matches',
    challenges: 'challenges',
    assessments: 'assessments',
    reportComments: 'report_comments'
};

// 2. Giao di·ªán m√†n h√¨nh Backup
const renderBackupScreen = () => {
    return `
        <div class="max-w-5xl mx-auto fade-in">
            <div class="mb-8">
                <h2 class="text-3xl font-bold text-slate-800 flex items-center gap-3">
                    <div class="p-3 bg-blue-600 rounded-2xl text-white shadow-lg shadow-blue-200">
                        <i data-lucide="database" size="32"></i>
                    </div>
                    Qu·∫£n tr·ªã & Sao l∆∞u D·ªØ li·ªáu
                </h2>
                <p class="text-slate-500 mt-2 ml-1">An to√†n d·ªØ li·ªáu l√† tr√™n h·∫øt. H√£y sao l∆∞u ƒë·ªãnh k·ª≥.</p>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <div class="bg-white p-6 md:p-8 rounded-3xl shadow-lg border border-slate-100 flex flex-col h-full">
                    <div class="mb-6">
                        <div class="w-12 h-12 bg-green-100 text-green-600 rounded-full flex items-center justify-center mb-4">
                            <i data-lucide="download" size="24"></i>
                        </div>
                        <h3 class="text-xl font-bold text-slate-800 mb-2">1. Xu·∫•t d·ªØ li·ªáu (Backup)</h3>
                        <p class="text-sm text-slate-500 leading-relaxed">
                            T·∫£i to√†n b·ªô d·ªØ li·ªáu hi·ªán t·∫°i (H·ªçc sinh, L·ªõp h·ªçc, B√†i t·∫≠p, ƒêi·ªÉm s·ªë...) v·ªÅ m√°y t√≠nh d∆∞·ªõi d·∫°ng file <b>.JSON</b>. 
                            <br>D√πng file n√†y ƒë·ªÉ kh√¥i ph·ª•c khi c·∫ßn thi·∫øt.
                        </p>
                    </div>
                    
                    <div class="mt-auto">
                        <button onclick="handleExportJSON()" class="w-full bg-green-600 hover:bg-green-700 text-white py-4 rounded-xl font-bold text-lg shadow-lg shadow-green-200 flex items-center justify-center gap-2 transition transform hover:-translate-y-1">
                            <i data-lucide="download-cloud" size="24"></i> T·∫£i xu·ªëng file Backup
                        </button>
                    </div>
                </div>

                <div class="bg-white p-6 md:p-8 rounded-3xl shadow-lg border border-slate-100 flex flex-col h-full">
                    <div class="mb-6">
                        <div class="w-12 h-12 bg-orange-100 text-orange-600 rounded-full flex items-center justify-center mb-4">
                            <i data-lucide="upload" size="24"></i>
                        </div>
                        <h3 class="text-xl font-bold text-slate-800 mb-2">2. Kh√¥i ph·ª•c d·ªØ li·ªáu (Restore)</h3>
                        <p class="text-sm text-slate-500 leading-relaxed mb-4">
                            Ch·ªçn file <b>.JSON</b> ƒë√£ sao l∆∞u ƒë·ªÉ n·∫°p l·∫°i v√†o h·ªá th·ªëng.
                        </p>
                        
                        <div class="p-4 bg-slate-50 border-2 border-dashed border-slate-300 rounded-xl hover:bg-slate-100 transition relative">
                            <input type="file" id="import-json-file" accept=".json" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer" onchange="document.getElementById('file-name-display').textContent = this.files[0]?.name || 'Ch∆∞a ch·ªçn file n√†o'">
                            <div class="text-center pointer-events-none">
                                <i data-lucide="file-json" class="mx-auto text-slate-400 mb-2"></i>
                                <p id="file-name-display" class="text-sm font-bold text-slate-600 truncate px-2">Nh·∫•n ƒë·ªÉ ch·ªçn file JSON</p>
                            </div>
                        </div>
                    </div>

                    <div class="mt-auto grid grid-cols-1 sm:grid-cols-2 gap-3">
                        <button onclick="handleImportJSON('view')" class="w-full bg-white border-2 border-slate-200 text-slate-600 hover:border-blue-300 hover:text-blue-600 py-3 rounded-xl font-bold transition flex items-center justify-center gap-2" title="Ch·ªâ xem tr√™n giao di·ªán, kh√¥ng l∆∞u v√†o database">
                            <i data-lucide="eye" size="18"></i> Xem Offline
                        </button>
                        <button onclick="handleImportJSON('firebase')" class="w-full bg-orange-600 hover:bg-orange-700 text-white py-3 rounded-xl font-bold shadow-lg shadow-orange-200 transition flex items-center justify-center gap-2" title="Ghi ƒë√® d·ªØ li·ªáu v√†o Database">
                            <i data-lucide="database" size="18"></i> N·∫°p v√†o DB
                        </button>
                    </div>
                    <p class="text-xs text-center text-slate-400 mt-3 italic">* "Xem Offline" gi√∫p b·∫°n xem ƒëi·ªÉm s·ªë ngay c·∫£ khi m·∫•t m·∫°ng.</p>
                </div>
            </div>
        </div>
    `;
};

// 3. H√†m X·ª≠ l√Ω Xu·∫•t file (Export)
window.handleExportJSON = () => {
    try {
        // Gom nh√≥m d·ªØ li·ªáu t·ª´ State
        const exportData = {
            timestamp: new Date().toISOString(),
            version: '1.0',
            source: 'EduBattle',
            data: {}
        };

        // L·∫∑p qua c√°c key trong DB_MAP ƒë·ªÉ l·∫•y d·ªØ li·ªáu t·ª´ state.data
        for (const [stateKey, colName] of Object.entries(DB_MAP)) {
            exportData.data[stateKey] = state.data[stateKey] || [];
        }

        // T·∫°o Blob v√† t·∫£i xu·ªëng
        const fileName = `EduBattle_Backup_${new Date().toLocaleDateString('vi-VN').replace(/\//g, '-')}.json`;
        const dataStr = JSON.stringify(exportData, null, 2); // Format ƒë·∫πp
        const blob = new Blob([dataStr], {type: 'application/json'});
        const url = URL.createObjectURL(blob);
        
        const link = document.createElement('a');
        link.href = url;
        link.download = fileName;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);

        showToast("ƒê√£ xu·∫•t d·ªØ li·ªáu th√†nh c√¥ng!", "success");
    } catch (e) {
        console.error(e);
        showToast("L·ªói khi xu·∫•t d·ªØ li·ªáu: " + e.message, "error");
    }
};

// 4. H√†m X·ª≠ l√Ω Nh·∫≠p file (Import)
window.handleImportJSON = async (mode) => {
    const fileInput = document.getElementById('import-json-file');
    if (!fileInput.files.length) return showToast("Vui l√≤ng ch·ªçn file JSON tr∆∞·ªõc!", "error");

    const file = fileInput.files[0];
    const reader = new FileReader();

    reader.onload = async (e) => {
        try {
            const json = JSON.parse(e.target.result);
            
            // Ki·ªÉm tra format s∆° b·ªô
            if (!json.data) throw new Error("File kh√¥ng ƒë√∫ng ƒë·ªãnh d·∫°ng EduBattle.");

            // MODE 1: VIEW OFFLINE (Ch·ªâ n·∫°p v√†o RAM/State ƒë·ªÉ xem)
            if (mode === 'view') {
                for (const [stateKey, val] of Object.entries(json.data)) {
                    state.data[stateKey] = val;
                }
                showToast("ƒê√£ t·∫£i d·ªØ li·ªáu v√†o ch·∫ø ƒë·ªô Xem Offline. D·ªØ li·ªáu ch∆∞a ƒë∆∞·ª£c l∆∞u.", "success");
                renderApp(); // Render l·∫°i giao di·ªán
            } 
            
            // MODE 2: RESTORE TO FIREBASE (Ghi v√†o Database)
            else if (mode === 'firebase') {
                if (!confirm("C·∫¢NH B√ÅO QUAN TR·ªåNG:\n\nH√†nh ƒë·ªông n√†y s·∫Ω t·∫£i d·ªØ li·ªáu t·ª´ file l√™n Database.\nC√°c d·ªØ li·ªáu tr√πng ID s·∫Ω b·ªã GHI ƒê√à.\n\nB·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën ti·∫øp t·ª•c?")) return;

                showToast("ƒêang kh√¥i ph·ª•c d·ªØ li·ªáu... Vui l√≤ng kh√¥ng t·∫Øt tr√¨nh duy·ªát.", "warning");
                
                let totalDocs = 0;
                const promises = [];

                // Duy·ªát qua t·ª´ng collection
                for (const [stateKey, items] of Object.entries(json.data)) {
                    const collectionName = DB_MAP[stateKey]; // L·∫•y t√™n collection th·ª±c t·∫ø (vd: question_banks)
                    if (!collectionName || !Array.isArray(items)) continue;

                    // Duy·ªát t·ª´ng document trong collection
                    items.forEach(item => {
                        if (item.id) {
                            // T·∫°o Promise ghi ƒë√® doc
                            // S·ª≠ d·ª•ng setDoc v·ªõi {merge: true} ƒë·ªÉ an to√†n h∆°n
                            const docRef = doc(db, getPath(collectionName), item.id);
                            promises.push(setDoc(docRef, item, { merge: true }));
                            totalDocs++;
                        }
                    });
                }

                // Ch·∫°y t·∫•t c·∫£ promise (L∆∞u √Ω: Firestore c√≥ gi·ªõi h·∫°n write rate, nh∆∞ng v·ªõi s·ªë l∆∞·ª£ng nh·ªè < 500 th√¨ ok)
                // N·∫øu d·ªØ li·ªáu l·ªõn c·∫ßn chia chunk, nh∆∞ng ·ªü ƒë√¢y l√†m ƒë∆°n gi·∫£n cho app nh·ªè.
                await Promise.all(promises);
                
                showToast(`Kh√¥i ph·ª•c th√†nh c√¥ng ${totalDocs} b·∫£n ghi!`, "success");
            }

        } catch (err) {
            console.error("Import Error:", err);
            showToast("L·ªói file: " + err.message, "error");
        }
    };

    reader.onerror = () => showToast("Kh√¥ng th·ªÉ ƒë·ªçc file.", "error");
    reader.readAsText(file);
};
// --- H√ÄM X·ª¨ L√ù UPLOAD JSON (ƒê√É CHU·∫®N H√ìA CHO LO·∫†I MCQ) ---
window.handleAssignmentJSONUpload = function(event) {
    const file = event.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const json = JSON.parse(e.target.result);
            let extractedQuestions = [];

            // 1. Duy·ªát file JSON ƒë·ªÉ l·∫•y danh s√°ch c√¢u h·ªèi
            if (Array.isArray(json)) {
                json.forEach(item => {
                    if (item.questions && Array.isArray(item.questions)) {
                        extractedQuestions = extractedQuestions.concat(item.questions);
                    } else if (item.question && item.options) {
                        extractedQuestions.push(item);
                    }
                });
            } else if (json.questions && Array.isArray(json.questions)) {
                extractedQuestions = json.questions;
            }

            if (extractedQuestions.length === 0) {
                showToast("Kh√¥ng t√¨m th·∫•y c√¢u h·ªèi n√†o trong file!", "warning");
                return;
            }

            // 2. MAP D·ªÆ LI·ªÜU SANG C·∫§U TR√öC APP (Quan tr·ªçng)
            const mappedQuestions = extractedQuestions.map((q, index) => {
                return {
                    id: Date.now() + Math.random(), // T·∫°o ID ng·∫´u nhi√™n
                    type: 'mcq',                    // B·∫ÆT BU·ªòC: Ph·∫£i l√† 'mcq' (kh·ªõp v·ªõi code renderQuestionDisplay)
                    
                    text: q.question,               // App d√πng bi·∫øn 'text' ƒë·ªÉ hi·ªÉn th·ªã n·ªôi dung
                    
                    options: q.options,             // Gi·ªØ nguy√™n m·∫£ng chu·ªói ["A", "B", "C", "D"]
                    
                    correct: parseInt(q.correct),   // V·ªã tr√≠ ƒë√°p √°n ƒë√∫ng (0, 1, 2...)
                    
                    // C√°c tr∆∞·ªùng ph·ª• (ƒë·ªÉ tr√°nh l·ªói undefined n·∫øu code g·ªçi t·ªõi)
                    content: q.question, 
                    audioUrl: null,
                    audioText: null
                };
            });

            // 3. Th√™m v√†o danh s√°ch c√¢u h·ªèi ƒëang so·∫°n (bi·∫øn state.ui.newAssignment)
            if (state && state.ui && state.ui.newAssignment) {
                if (!state.ui.newAssignment.questions) state.ui.newAssignment.questions = [];
                
                state.ui.newAssignment.questions.push(...mappedQuestions);
                
                showToast(`ƒê√£ th√™m th√†nh c√¥ng ${mappedQuestions.length} c√¢u h·ªèi tr·∫Øc nghi·ªám!`, "success");
                
                // Reset input file ƒë·ªÉ ch·ªçn l·∫°i ƒë∆∞·ª£c file c≈© n·∫øu mu·ªën
                event.target.value = '';
                
                // Render l·∫°i giao di·ªán
                renderApp();
            } else {
                // Fallback cho tr∆∞·ªùng h·ª£p bi·∫øn to√†n c·ª•c kh√°c
                if (typeof tempAssignmentQuestions !== 'undefined') {
                    tempAssignmentQuestions = [...tempAssignmentQuestions, ...mappedQuestions];
                    if(typeof renderTempAssignmentQuestions === 'function') renderTempAssignmentQuestions();
                }
            }

        } catch (err) {
            console.error("L·ªói ƒë·ªçc JSON:", err);
            showToast("File JSON sai ƒë·ªãnh d·∫°ng: " + err.message, "error");
        }
    };
    reader.readAsText(file);
};
// --- LOGIC M·ªöI: T·∫¢I JSON CHO NG√ÇN H√ÄNG ƒê·ªÄ (ƒê√É FIX THEO CODE C·ª¶A B·∫†N) ---
window.handleBankJSONUpload = function(event) {
    const file = event.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const json = JSON.parse(e.target.result);
            let extractedQuestions = [];

            // 1. Duy·ªát file JSON (H·ªó tr·ª£ c·∫•u tr√∫c l·ªìng nhau v√† ph·∫≥ng)
            if (Array.isArray(json)) {
                json.forEach(item => {
                    if (item.questions && Array.isArray(item.questions)) {
                        extractedQuestions = extractedQuestions.concat(item.questions);
                    } else if (item.question && item.options) {
                        extractedQuestions.push(item);
                    }
                });
            } else if (json.questions && Array.isArray(json.questions)) {
                extractedQuestions = json.questions;
            }

            if (extractedQuestions.length === 0) {
                showToast("Kh√¥ng t√¨m th·∫•y c√¢u h·ªèi n√†o trong file!", "warning");
                return;
            }

            // 2. Map d·ªØ li·ªáu sang c·∫•u tr√∫c App (Chu·∫©n MCQ)
            const mappedQuestions = extractedQuestions.map((q, index) => {
                return {
                    id: Date.now() + Math.random() + index, 
                    type: 'mcq',                    // B·∫Øt bu·ªôc l√† 'mcq' ƒë·ªÉ hi·ªán tr·∫Øc nghi·ªám
                    text: q.question,               // N·ªôi dung c√¢u h·ªèi
                    options: q.options,             // M·∫£ng chu·ªói ƒë√°p √°n ["A", "B", "C", "D"]
                    correct: parseInt(q.correct),   // Index ƒë√°p √°n ƒë√∫ng
                    
                    // C√°c tr∆∞·ªùng ph·ª• ƒë·ªÉ tr√°nh l·ªói
                    content: q.question,
                    audioUrl: null,
                    explanation: ""
                };
            });

            // 3. ƒê·∫©y v√†o state.ui.newAssignment.questions
            // (H·ªá th·ªëng c·ªßa b·∫°n d√πng bi·∫øn n√†y cho c·∫£ t·∫°o B√†i t·∫≠p v√† Ng√¢n h√†ng ƒë·ªÅ)
            if (state && state.ui && state.ui.newAssignment) {
                if (!state.ui.newAssignment.questions) state.ui.newAssignment.questions = [];
                
                state.ui.newAssignment.questions.push(...mappedQuestions);
                
                showToast(`ƒê√£ th√™m ${mappedQuestions.length} c√¢u v√†o ng√¢n h√†ng!`, "success");
                
                // V·∫Ω l·∫°i giao di·ªán
                renderApp(); 
            } else {
                console.error("L·ªói State: Kh√¥ng t√¨m th·∫•y bi·∫øn newAssignment");
                showToast("L·ªói h·ªá th·ªëng: Kh√¥ng t√¨m th·∫•y v·ªã tr√≠ l∆∞u c√¢u h·ªèi.", "error");
            }

            // Reset input
            event.target.value = '';

        } catch (err) {
            console.error("Bank Upload Error:", err);
            showToast("L·ªói file: " + err.message, "error");
        }
    };
    reader.readAsText(file);
};
// --- LOGIC M·ªöI: T·∫¢I JSON CHO TH·ª¨ TH√ÅCH (ƒê√É CHU·∫®N H√ìA) ---
window.handleChallengeJSONUpload = function(event) {
    const file = event.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const json = JSON.parse(e.target.result);
            let extractedQuestions = [];

            // 1. Duy·ªát file JSON (H·ªó tr·ª£ c·∫•u tr√∫c l·ªìng nhau v√† ph·∫≥ng)
            if (Array.isArray(json)) {
                json.forEach(item => {
                    if (item.questions && Array.isArray(item.questions)) {
                        extractedQuestions = extractedQuestions.concat(item.questions);
                    } else if (item.question && item.options) {
                        extractedQuestions.push(item);
                    }
                });
            } else if (json.questions && Array.isArray(json.questions)) {
                extractedQuestions = json.questions;
            }

            if (extractedQuestions.length === 0) {
                showToast("Kh√¥ng t√¨m th·∫•y c√¢u h·ªèi n√†o trong file!", "warning");
                return;
            }

            // 2. Map d·ªØ li·ªáu sang c·∫•u tr√∫c App (Chu·∫©n MCQ)
            const mappedQuestions = extractedQuestions.map((q, index) => {
                return {
                    id: Date.now() + Math.random() + index, 
                    type: 'mcq',                    // B·∫Øt bu·ªôc l√† 'mcq'
                    text: q.question,               // N·ªôi dung c√¢u h·ªèi
                    options: q.options,             // M·∫£ng chu·ªói ƒë√°p √°n
                    correct: parseInt(q.correct),   // Index ƒë√°p √°n ƒë√∫ng
                    
                    // C√°c tr∆∞·ªùng ph·ª•
                    content: q.question,
                    audioUrl: null,
                    explanation: ""
                };
            });

            // 3. ƒê·∫©y v√†o state.ui.activeChallenge.questions
            // (L∆∞u √Ω: Th·ª≠ th√°ch d√πng bi·∫øn activeChallenge)
            if (state && state.ui && state.ui.activeChallenge) {
                if (!state.ui.activeChallenge.questions) state.ui.activeChallenge.questions = [];
                
                state.ui.activeChallenge.questions.push(...mappedQuestions);
                
                showToast(`ƒê√£ th√™m ${mappedQuestions.length} c√¢u v√†o th·ª≠ th√°ch!`, "success");
                
                // V·∫Ω l·∫°i giao di·ªán
                renderApp(); 
            } else {
                console.error("L·ªói State: Kh√¥ng t√¨m th·∫•y bi·∫øn activeChallenge");
                showToast("L·ªói h·ªá th·ªëng: Kh√¥ng t√¨m th·∫•y v·ªã tr√≠ l∆∞u c√¢u h·ªèi th·ª≠ th√°ch.", "error");
            }

            // Reset input
            event.target.value = '';

        } catch (err) {
            console.error("Challenge Upload Error:", err);
            showToast("L·ªói file: " + err.message, "error");
        }
    };
    reader.readAsText(file);
};
// --- LOGIC S·ª¨A C√ÇU H·ªéI (M·ªöI) ---

window.openEditQuestion = (index, type) => {
    // type: 'assignment' (cho B√†i t·∫≠p/Bank) ho·∫∑c 'challenge' (cho Th·ª≠ th√°ch)
    let questionData;
    
    if (type === 'challenge') {
        questionData = state.ui.activeChallenge.questions[index];
    } else {
        // M·∫∑c ƒë·ªãnh l·∫•y t·ª´ newAssignment (d√πng chung cho B√†i t·∫≠p & Ng√¢n h√†ng ƒë·ªÅ)
        questionData = state.ui.newAssignment.questions[index];
    }

    if (!questionData) return;

    // ƒêi·ªÅn d·ªØ li·ªáu v√†o form
    document.getElementById('edit-q-index').value = index;
    document.getElementById('edit-q-type').value = type;
    
    // L·∫•y n·ªôi dung (∆∞u ti√™n c√°c tr∆∞·ªùng text/vietnamese/content)
    const currentText = questionData.text || questionData.vietnamese || questionData.content || '';
    document.getElementById('edit-q-text').value = currentText;
    
    // X·ª≠ l√Ω hi·ªÉn th·ªã ph·∫ßn ƒê√°p √°n (ch·ªâ hi·ªán n·∫øu l√† tr·∫Øc nghi·ªám c√≥ options)
    const optionsContainer = document.getElementById('edit-options-container');
    if (questionData.options && Array.isArray(questionData.options) && questionData.options.length > 0) {
        optionsContainer.style.display = 'block';
        // ƒêi·ªÅn c√°c ƒë√°p √°n
        for(let i=0; i<4; i++) {
            document.getElementById(`edit-opt-${i}`).value = questionData.options[i] || '';
        }
        // Ch·ªçn radio ƒë√°p √°n ƒë√∫ng
        const radios = document.getElementsByName('edit-correct');
        for(let r of radios) {
            r.checked = (parseInt(r.value) === parseInt(questionData.correct));
        }
    } else {
        // ·∫®n ph·∫ßn tr·∫Øc nghi·ªám n·∫øu l√† d·∫°ng c√¢u h·ªèi kh√°c (v√≠ d·ª•: t·ª± lu·∫≠n, s·∫Øp x·∫øp)
        optionsContainer.style.display = 'none';
    }

    // Hi·ªÉn th·ªã Modal
    document.getElementById('edit-question-modal').classList.remove('hidden');
}

window.closeEditModal = () => {
    document.getElementById('edit-question-modal').classList.add('hidden');
}

window.saveEditedQuestion = () => {
    const index = parseInt(document.getElementById('edit-q-index').value);
    const type = document.getElementById('edit-q-type').value;
    const newText = document.getElementById('edit-q-text').value.trim();
    
    if (!newText) {
        showToast("N·ªôi dung kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng!", "error");
        return;
    }

    // X√°c ƒë·ªãnh n∆°i l∆∞u
    let targetList;
    if (type === 'challenge') {
        targetList = state.ui.activeChallenge.questions;
    } else {
        targetList = state.ui.newAssignment.questions;
    }

    // C·∫≠p nh·∫≠t d·ªØ li·ªáu
    const q = targetList[index];
    q.text = newText;
    if (q.vietnamese) q.vietnamese = newText; // C·∫≠p nh·∫≠t ƒë·ªìng b·ªô n·∫øu l√† d·∫°ng d·ªãch
    if (q.content) q.content = newText;

    // C·∫≠p nh·∫≠t Options (n·∫øu ƒëang hi·ªán)
    const optionsContainer = document.getElementById('edit-options-container');
    if (optionsContainer.style.display !== 'none') {
        const newOptions = [];
        for(let i=0; i<4; i++) {
            newOptions.push(document.getElementById(`edit-opt-${i}`).value.trim());
        }
        q.options = newOptions;
        
        // L·∫•y ƒë√°p √°n ƒë√∫ng m·ªõi
        const radios = document.getElementsByName('edit-correct');
        for(let r of radios) {
            if (r.checked) q.correct = parseInt(r.value);
        }
    }

    showToast("ƒê√£ c·∫≠p nh·∫≠t c√¢u h·ªèi!", "success");
    closeEditModal();
    renderApp(); // V·∫Ω l·∫°i giao di·ªán ƒë·ªÉ th·∫•y thay ƒë·ªïi
}
// ========================================================================
// T√çNH NƒÇNG S·ª¨A C√ÇU H·ªéI V7 - H·ªñ TR·ª¢ TO√ÄN B·ªò 13 LO·∫†I C√ÇU H·ªéI
// ========================================================================

// 1. HTML MODAL ƒêA NƒÇNG (Khung ch·ª©a Dynamic)
const EDIT_MODAL_HTML_V7 = `
<div id="edit-question-modal" class="hidden fixed inset-0 z-[100] flex items-center justify-center bg-black/60 backdrop-blur-sm p-4 animate-fade-in">
    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-2xl overflow-hidden flex flex-col max-h-[95vh]">
        <div class="p-4 border-b flex justify-between items-center bg-gradient-to-r from-blue-50 to-indigo-50">
            <h3 class="font-bold text-lg text-blue-800 flex items-center gap-2">
                <i data-lucide="edit-3" class="w-5 h-5"></i>
                <span id="edit-modal-title">S·ª≠a c√¢u h·ªèi</span>
            </h3>
            <button onclick="window.closeEditModal()" class="p-2 hover:bg-white rounded-full transition text-gray-500 hover:text-red-500">
                <i data-lucide="x" class="w-5 h-5"></i>
            </button>
        </div>

        <div id="edit-form-container" class="p-6 overflow-y-auto flex-1 space-y-4">
            </div>

        <div class="p-4 border-t bg-gray-50 flex justify-end gap-3">
            <button onclick="window.closeEditModal()" class="px-4 py-2 rounded-lg text-gray-600 font-medium hover:bg-gray-200 transition">H·ªßy</button>
            <button onclick="window.saveEditedQuestion()" class="px-6 py-2 rounded-lg bg-blue-600 text-white font-bold hover:bg-blue-700 shadow-lg transition flex items-center gap-2">
                <i data-lucide="save" class="w-4 h-4"></i> L∆∞u
            </button>
        </div>
    </div>
    <input type="hidden" id="edit-q-index">
    <input type="hidden" id="edit-q-type-source">
    <input type="hidden" id="edit-q-kind"> 
</div>
`;

// 2. H√†m T·∫°o Modal n·∫øu ch∆∞a c√≥
function ensureEditModalExists() {
    if (!document.getElementById('edit-question-modal')) {
        const div = document.createElement('div');
        div.innerHTML = EDIT_MODAL_HTML_V7;
        document.body.appendChild(div.firstElementChild);
        if(typeof lucide !== 'undefined') lucide.createIcons();
    }
}

// 3. Helper: T·∫°o Form HTML d·ª±a tr√™n lo·∫°i c√¢u h·ªèi
function getEditFormHtml(q) {
    const type = q.type || 'mcq';
    let html = '';
    const esc = (str) => (str || '').replace(/"/g, '&quot;'); // H√†m escape

    // Helper t·∫°o Input text
    const renderInput = (label, id, value, placeholder='') => `
        <div class="mb-4">
            <label class="block text-sm font-bold text-gray-700 mb-1">${label}</label>
            <input type="text" id="${id}" value="${esc(value)}" class="w-full p-2.5 border-2 border-slate-200 rounded-xl focus:border-blue-500 outline-none transition font-medium" placeholder="${placeholder}">
        </div>`;
    
    // Helper t·∫°o Textarea
    const renderArea = (label, id, value, rows=3) => `
        <div class="mb-4">
            <label class="block text-sm font-bold text-gray-700 mb-1">${label}</label>
            <textarea id="${id}" rows="${rows}" class="w-full p-2.5 border-2 border-slate-200 rounded-xl focus:border-blue-500 outline-none transition font-medium">${value || ''}</textarea>
        </div>`;

    // --- LOGIC PH√ÇN LO·∫†I FORM ---

    // NH√ìM 1: TR·∫ÆC NGHI·ªÜM & READING & AUDIO MCQ
    if (['mcq', 'listen_mcq', 'listen_conversation', 'reading_comprehension'].includes(type)) {
        if (type === 'listen_mcq') {
            html += renderInput('T√™n file √¢m thanh (Audio Name)', 'edit-audio', q.audioText);
            html += renderInput('C√¢u h·ªèi / Y√™u c·∫ßu', 'edit-text', q.text);
        } else if (type === 'listen_conversation') {
            html += renderInput('T√™n file h·ªôi tho·∫°i', 'edit-audio', q.audioText);
            html += renderArea('N·ªôi dung h·ªôi tho·∫°i (Script)', 'edit-script', q.conversationContent);
            html += renderInput('C√¢u h·ªèi', 'edit-text', q.text);
        } else if (type === 'reading_comprehension') {
            html += renderArea('ƒêo·∫°n vƒÉn b·∫£n', 'edit-passage', q.conversationContent, 6);
            html += renderInput('C√¢u h·ªèi', 'edit-text', q.text);
        } else {
            // MCQ th∆∞·ªùng
            html += renderInput('N·ªôi dung c√¢u h·ªèi', 'edit-text', q.text || q.content);
        }

        // Render 4 ƒë√°p √°n
        html += `<div class="mt-4 bg-slate-50 p-4 rounded-xl border border-slate-200"><label class="block text-sm font-bold text-slate-700 mb-3">C√°c l·ª±a ch·ªçn ƒë√°p √°n (T√≠ch ƒë·ªÉ ch·ªçn c√¢u ƒë√∫ng)</label>`;
        const opts = q.options || ["", "", "", ""];
        opts.forEach((opt, i) => {
            html += `
                <div class="flex gap-2 items-center mb-2">
                    <span class="w-6 font-bold text-blue-600">${String.fromCharCode(65+i)}</span>
                    <input type="text" id="edit-opt-${i}" value="${esc(opt)}" class="flex-1 p-2 border rounded-lg outline-none focus:ring-1 ring-blue-500">
                    <input type="radio" name="edit-correct" value="${i}" ${parseInt(q.correct) === i ? 'checked' : ''} class="w-5 h-5 cursor-pointer accent-blue-600">
                </div>`;
        });
        html += `</div>`;
    }
    
    // NH√ìM 2: ƒêI·ªÄN T·ª™ (FIB)
    else if (type === 'fib') {
        html += `<div class="bg-yellow-50 p-3 rounded-lg mb-3 text-sm text-yellow-800">D√πng k√Ω t·ª± <b>[BLANK]</b> ƒë·ªÉ ƒë·∫°i di·ªán cho ch·ªó tr·ªëng.</div>`;
        html += renderInput('C√¢u h·ªèi', 'edit-text', q.text);
        html += renderInput('ƒê√°p √°n ƒë√∫ng', 'edit-answer', q.answer);
    }

    // NH√ìM 3: S·∫ÆP X·∫æP T·ª™ (JUMBLE)
    else if (type === 'jumble') {
        const val = (q.answer && Array.isArray(q.answer)) ? q.answer.join(' ') : (q.text || '');
        html += renderInput('C√¢u ho√†n ch·ªânh (H·ªá th·ªëng s·∫Ω t·ª± x√°o tr·ªôn)', 'edit-jumble-text', val);
    }

    // NH√ìM 4: N·ªêI C·∫∂P (MATCH)
    else if (type === 'match') {
        html += renderInput('Ti√™u ƒë·ªÅ / Y√™u c·∫ßu', 'edit-text', q.text);
        html += `<div class="mt-2"><label class="block text-sm font-bold text-slate-700 mb-2">C√°c c·∫∑p gh√©p n·ªëi (A - B)</label>`;
        const pairs = q.pairs || [{a:'', b:''}, {a:'', b:''}, {a:'', b:''}];
        pairs.forEach((p, i) => {
            html += `<div class="flex gap-2 mb-2">
                <input id="edit-match-a-${i}" value="${esc(p.a)}" class="flex-1 p-2 border rounded-lg" placeholder="V·∫ø A">
                <input id="edit-match-b-${i}" value="${esc(p.b)}" class="flex-1 p-2 border rounded-lg" placeholder="V·∫ø B (ƒê√°p √°n)">
            </div>`;
        });
        html += `</div>`;
    }

    // NH√ìM 5: D·ªäCH (TRANSLATION)
    else if (type === 'translation') {
        html += renderInput('C√¢u Ti·∫øng Vi·ªát (H·ªèi)', 'edit-vn', q.vietnamese);
        html += renderInput('C√¢u Ti·∫øng Trung (ƒê√°p √°n)', 'edit-cn', q.chinese);
    }

    // NH√ìM 6: NGHE VI·∫æT / NGHE D·ªäCH
    else if (['listen_write', 'listen_translate'].includes(type)) {
        html += renderInput('T√™n file √¢m thanh', 'edit-audio', q.audioText);
        html += renderInput('ƒê√°p √°n ƒë√∫ng', 'edit-answer', q.answer);
    }

    // NH√ìM 7: S·∫ÆP X·∫æP C√ÇU (ORDER SENTENCES)
    else if (type === 'order_sentences') {
        const content = Array.isArray(q.answer) ? q.answer.join('\n') : '';
        html += renderArea('Nh·∫≠p c√°c c√¢u theo ƒë√∫ng th·ª© t·ª± (M·ªói c√¢u 1 d√≤ng)', 'edit-order-input', content, 6);
    }

    // NH√ìM 8: T·ª∞ LU·∫¨N / H√åNH ·∫¢NH
    else if (type === 'make_sentence') {
        html += renderInput('C√°c t·ª´ g·ª£i √Ω', 'edit-prompts', q.promptWords);
        html += renderInput('G·ª£i √Ω ƒë√°p √°n (Tham kh·∫£o)', 'edit-suggested', q.answer);
    }
    else if (type === 'image_describe') {
        html += renderInput('URL H√¨nh ·∫£nh', 'edit-image-url', q.imageUrl);
        html += renderInput('C√¢u h·ªèi / Y√™u c·∫ßu', 'edit-text', q.text);
        html += renderInput('G·ª£i √Ω ƒë√°p √°n', 'edit-suggested', q.answer);
    }
    else {
        // Fallback
        html += renderInput('N·ªôi dung', 'edit-text', q.text);
    }

    return html;
}

// 4. H√†m M·ªü Modal
window.openEditQuestion = (index, type) => {
    ensureEditModalExists();

    // L·∫•y d·ªØ li·ªáu
    let questionData;
    if (type === 'challenge') {
        questionData = state.ui.activeChallenge.questions[index];
    } else {
        questionData = state.ui.newAssignment.questions[index];
    }

    if (!questionData) { alert("Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu!"); return; }

    // L∆∞u Index v√† Type ƒë·ªÉ d√πng khi Save
    document.getElementById('edit-q-index').value = index;
    document.getElementById('edit-q-type-source').value = type;
    document.getElementById('edit-q-kind').value = questionData.type || 'mcq';

    // C·∫≠p nh·∫≠t Ti√™u ƒë·ªÅ
    const titleEl = document.getElementById('edit-modal-title');
    if (titleEl) titleEl.textContent = `S·ª≠a c√¢u ${index + 1} (${questionData.type || 'MCQ'})`;

    // Render Form
    const container = document.getElementById('edit-form-container');
    container.innerHTML = getEditFormHtml(questionData);

    // Hi·ªÉn th·ªã Modal
    document.getElementById('edit-question-modal').classList.remove('hidden');
}

// 5. H√†m ƒê√≥ng Modal
window.closeEditModal = () => {
    document.getElementById('edit-question-modal').classList.add('hidden');
}

// 6. H√†m L∆∞u D·ªØ li·ªáu (X·ª¨ L√ù TH√îNG MINH CHO T·ª™NG LO·∫†I)
window.saveEditedQuestion = () => {
    // 1. Gi·ªØ v·ªã tr√≠ cu·ªôn trang (Fix nh·∫£y trang)
    const scrollContainer = document.querySelector('main');
    const scrollPos = scrollContainer ? scrollContainer.scrollTop : 0;
    const listScroll = document.getElementById('questions-preview');
    const listPos = listScroll ? listScroll.scrollTop : 0;

    // 2. L·∫•y th√¥ng tin c∆° b·∫£n
    const index = parseInt(document.getElementById('edit-q-index').value);
    const typeSource = document.getElementById('edit-q-type-source').value;
    const qType = document.getElementById('edit-q-kind').value;

    // 3. X√°c ƒë·ªãnh n∆°i l∆∞u
    let targetList;
    if (typeSource === 'challenge') targetList = state.ui.activeChallenge.questions;
    else targetList = state.ui.newAssignment.questions;
    
    const q = targetList[index]; // Object c·∫ßn update

    // 4. L·∫•y d·ªØ li·ªáu t·ª´ Form (Switch case theo lo·∫°i)
    try {
        if (['mcq', 'listen_mcq', 'listen_conversation', 'reading_comprehension'].includes(qType)) {
            // L·∫•y Text
            if(document.getElementById('edit-text')) q.text = document.getElementById('edit-text').value.trim();
            if(document.getElementById('edit-script')) q.conversationContent = document.getElementById('edit-script').value;
            if(document.getElementById('edit-passage')) q.conversationContent = document.getElementById('edit-passage').value;
            
            // L·∫•y Audio (n·∫øu c√≥ update filename th√¨ update c·∫£ url)
            if(document.getElementById('edit-audio')) {
                const newAudio = document.getElementById('edit-audio').value.trim();
                if (newAudio !== q.audioText) {
                    q.audioText = newAudio;
                    // T·ª± ƒë·ªông update URL gi·∫£ ƒë·ªãnh (gi·ªØ folder c≈© n·∫øu c√≥)
                    if (q.audioUrl && q.audioUrl.includes('/')) {
                        const path = q.audioUrl.substring(0, q.audioUrl.lastIndexOf('/')+1);
                        q.audioUrl = path + newAudio + '.mp3';
                    } else {
                        // Fallback
                        q.audioUrl = `data_Edubattle/H1_Bai1/${newAudio}.mp3`; 
                    }
                }
            }

            // L·∫•y Options & Correct
            const newOpts = [];
            for(let i=0; i<4; i++) {
                newOpts.push(document.getElementById(`edit-opt-${i}`).value.trim());
            }
            q.options = newOpts;
            
            const radios = document.getElementsByName('edit-correct');
            for(let r of radios) { if (r.checked) q.correct = parseInt(r.value); }
        }
        
        else if (qType === 'fib') {
            q.text = document.getElementById('edit-text').value;
            q.answer = document.getElementById('edit-answer').value.trim();
        }
        else if (qType === 'jumble') {
            const fullText = document.getElementById('edit-jumble-text').value.trim();
            q.text = fullText;
            q.answer = fullText.split(/\s+/).filter(w => w); // T·ª± ƒë·ªông t√°ch t·ª´
        }
        else if (qType === 'match') {
            q.text = document.getElementById('edit-text').value;
            const newPairs = [];
            for(let i=0; i<3; i++) { // Gi·∫£ s·ª≠ t·ªëi ƒëa 3 c·∫∑p
                const a = document.getElementById(`edit-match-a-${i}`);
                const b = document.getElementById(`edit-match-b-${i}`);
                if (a && b) newPairs.push({a: a.value.trim(), b: b.value.trim()});
            }
            q.pairs = newPairs;
        }
        else if (qType === 'translation') {
            q.vietnamese = document.getElementById('edit-vn').value.trim();
            q.chinese = document.getElementById('edit-cn').value.trim();
            q.text = q.vietnamese;
        }
        else if (['listen_write', 'listen_translate'].includes(qType)) {
            const newAudio = document.getElementById('edit-audio').value.trim();
            q.audioText = newAudio;
            q.answer = document.getElementById('edit-answer').value.trim();
        }
        else if (qType === 'order_sentences') {
            const raw = document.getElementById('edit-order-input').value;
            q.answer = raw.split('\n').map(s => s.trim()).filter(s => s);
        }
        else if (qType === 'make_sentence') {
            q.promptWords = document.getElementById('edit-prompts').value.trim();
            q.answer = document.getElementById('edit-suggested').value.trim();
            q.text = `ƒê·∫∑t c√¢u v·ªõi c√°c t·ª´: ${q.promptWords}`;
        }
        else if (qType === 'image_describe') {
            q.imageUrl = document.getElementById('edit-image-url').value.trim();
            q.text = document.getElementById('edit-text').value.trim();
            q.answer = document.getElementById('edit-suggested').value.trim();
        }

        // L∆∞u chung cho c√°c tr∆∞·ªùng fallback
        if (document.getElementById('edit-text') && !q.text) q.text = document.getElementById('edit-text').value;

        showToast("ƒê√£ c·∫≠p nh·∫≠t c√¢u h·ªèi!", "success");
        window.closeEditModal();
        renderApp();

        // 5. Kh√¥i ph·ª•c scroll (Quan tr·ªçng)
        setTimeout(() => {
            const newMain = document.querySelector('main');
            if (newMain) newMain.scrollTop = scrollPos;
            const newList = document.getElementById('questions-preview');
            if (newList) newList.scrollTop = listPos;
        }, 50);

    } catch (e) {
        alert("L·ªói khi l∆∞u: " + e.message);
    }
}
// ============================================================
// T√çNH NƒÇNG: ƒêI·ªÄU KHI·ªÇN C√ÇU H·ªéI B·∫∞NG B√ÄN PH√çM (KEYBOARD NAV)
// ============================================================

// 1. Kh·ªüi t·∫°o bi·∫øn theo d√µi v·ªã tr√≠ ƒëang ch·ªçn
if (typeof state !== 'undefined' && state.ui && state.ui.focusedIndex === undefined) {
    state.ui.focusedIndex = -1; // -1 l√† ch∆∞a ch·ªçn c√¢u n√†o
}

// 2. H√†m ch·ªçn c√¢u h·ªèi (khi click chu·ªôt)
// ============================================================
// FIX FINAL: T·ªêI ∆ØU HI·ªÜU NƒÇNG - CH·ªêNG NH√ÅY M√ÄN H√åNH (ANTI-FLICKER)
// ============================================================

// 1. H√ÄM V·∫º L·∫†I C·ª§C B·ªò (Ch·ªâ v·∫Ω l·∫°i danh s√°ch c√¢u h·ªèi, kh√¥ng v·∫Ω l·∫°i c·∫£ App)
window.refreshListUI = () => {
    // X√°c ƒë·ªãnh d·ªØ li·ªáu
    let list;
    if (state.view === 'challenges') {
        list = state.ui.activeChallenge.questions;
    } else {
        list = state.ui.newAssignment.questions;
    }

    // T√¨m khung ch·ª©a danh s√°ch tr√™n m√†n h√¨nh
    // (Th·ª≠ t√¨m theo ID c·ªßa ph·∫ßn T·∫°o b√†i t·∫≠p tr∆∞·ªõc, n·∫øu kh√¥ng th·∫•y th√¨ t√¨m theo th·∫ª cha c·ªßa c√°c card)
    let container = document.getElementById('questions-preview');
    if (!container) {
        // Fallback: T√¨m cha c·ªßa th·∫ª c√¢u h·ªèi ƒë·∫ßu ti√™n (D√πng cho b√™n Th·ª≠ th√°ch)
        const sampleCard = document.querySelector('[id^="q-card-"]');
        if (sampleCard) container = sampleCard.parentNode;
    }

    // N·∫øu t√¨m th·∫•y khung ch·ª©a -> Ch·ªâ c·∫≠p nh·∫≠t n·ªôi dung HTML c·ªßa khung ƒë√≥
    if (container && list.length > 0) {
        // Map d·ªØ li·ªáu ra HTML (S·ª≠ d·ª•ng l·∫°i h√†m renderQuestionDisplay c√≥ s·∫µn)
        container.innerHTML = list.map((q, i) => renderQuestionDisplay(q, i)).join('');
        
        // K√≠ch ho·∫°t l·∫°i icon (quan tr·ªçng)
        if(typeof lucide !== 'undefined') lucide.createIcons();
    } else {
        // Tr∆∞·ªùng h·ª£p b·∫•t kh·∫£ kh√°ng m·ªõi ph·∫£i render l·∫°i c·∫£ App
        renderApp();
    }
};

// 2. H√ÄM CH·ªåN C√ÇU H·ªéI (D√πng DOM Class -> KH√îNG RENDER -> KH√îNG NH√ÅY)
window.focusQuestion = (index) => {
    // C·∫≠p nh·∫≠t State
    if (state.ui.focusedIndex === index) {
        state.ui.focusedIndex = -1;
    } else {
        state.ui.focusedIndex = index;
    }

    // --- K·ª∏ THU·∫¨T DOM MANIPULATION (Thao t√°c tr·ª±c ti·∫øp) ---
    // Thay v√¨ v·∫Ω l·∫°i, ta ƒëi t√¨m t·ª´ng th·∫ª ƒë·ªÉ B·∫≠t/T·∫Øt class CSS th·ªß c√¥ng -> M∆∞·ª£t tuy·ªát ƒë·ªëi

    // Class c∆° b·∫£n (L·∫•y t·ª´ code c≈©)
    const baseClass = "p-3 md:p-4 border rounded-xl bg-white mb-2 flex justify-between items-start transition-all cursor-pointer relative";
    const normalClass = "border-slate-200 hover:border-blue-300 hover:shadow-md";
    const activeClass = "border-blue-500 ring-2 ring-blue-200 shadow-lg z-10 transform scale-[1.01]";

    // 1. Reset t·∫•t c·∫£ v·ªÅ b√¨nh th∆∞·ªùng
    const allCards = document.querySelectorAll('[id^="q-card-"]');
    allCards.forEach(card => {
        card.className = `${baseClass} ${normalClass}`;
        // X√≥a nh√£n h∆∞·ªõng d·∫´n n·∫øu c√≥
        const badge = card.querySelector('.focus-badge');
        if(badge) badge.remove();
    });

    // 2. K√≠ch ho·∫°t th·∫ª ƒëang ch·ªçn
    if (state.ui.focusedIndex !== -1) {
        const activeCard = document.getElementById(`q-card-${state.ui.focusedIndex}`);
        if (activeCard) {
            activeCard.className = `${baseClass} ${activeClass}`;
            
            // Th√™m nh√£n h∆∞·ªõng d·∫´n (DOM th·∫≠t)
            const badge = document.createElement('div');
            badge.className = "focus-badge absolute -right-2 -top-2 bg-blue-600 text-white text-[10px] px-2 py-0.5 rounded-full shadow-sm font-bold z-20 animate-bounce";
            badge.innerText = "D√πng ph√≠m ‚¨Ü‚¨á";
            activeCard.appendChild(badge);
            
            // Cu·ªôn nh·∫π n·∫øu b·ªã khu·∫•t (nh∆∞ng kh√¥ng cu·ªôn trang ch√≠nh ƒë·ªÉ tr√°nh gi·∫≠t)
            activeCard.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }
    }
};

// 3. H√ÄM DI CHUY·ªÇN (D√πng refreshListUI -> CH·ªà C·∫¨P NH·∫¨T LIST -> GI·∫¢M NH√ÅY 90%)
window.moveQuestion = (index, direction, type) => {
    // L·∫•y danh s√°ch
    let list;
    if (state.view === 'challenges') {
        list = state.ui.activeChallenge.questions;
    } else {
        list = state.ui.newAssignment.questions;
    }

    const newIndex = index + direction;
    if (newIndex < 0 || newIndex >= list.length) return;

    // Swap d·ªØ li·ªáu
    const temp = list[index];
    list[index] = list[newIndex];
    list[newIndex] = temp;

    // C·∫≠p nh·∫≠t index ƒëang ch·ªçn ch·∫°y theo c√¢u h·ªèi
    if (state.ui.focusedIndex === index) {
        state.ui.focusedIndex = newIndex;
    }

    // --- THAY V√å renderApp(), CH·ªà G·ªåI refreshListUI() ---
    window.refreshListUI();

    // T·ª± ƒë·ªông cu·ªôn theo c√¢u h·ªèi (M∆∞·ª£t m√†)
    requestAnimationFrame(() => {
        const activeCard = document.getElementById(`q-card-${state.ui.focusedIndex}`);
        if (activeCard) {
            activeCard.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }
    });
};

// 4. L·∫Øng nghe s·ª± ki·ªán B√†n ph√≠m
document.addEventListener('keydown', (e) => {
    // A. N·∫øu ƒëang m·ªü Modal S·ª≠a ho·∫∑c ƒëang g√µ ch·ªØ trong √¥ input -> Kh√¥ng l√†m g√¨ c·∫£
    const editModal = document.getElementById('edit-question-modal');
    if (editModal && !editModal.classList.contains('hidden')) return;
    if (['INPUT', 'TEXTAREA'].includes(document.activeElement.tagName)) return;

    // B. N·∫øu ch∆∞a ch·ªçn c√¢u n√†o -> B·ªè qua
    if (state.ui.focusedIndex === -1) return;

    // C. X√°c ƒë·ªãnh ng·ªØ c·∫£nh (B√†i t·∫≠p hay Th·ª≠ th√°ch)
    const isChallenge = state.view === 'challenges';
    const type = isChallenge ? 'challenge' : 'assignment';
    const list = isChallenge ? state.ui.activeChallenge.questions : state.ui.newAssignment.questions;
    
    if (!list || list.length === 0) return;

    // --- X·ª¨ L√ù PH√çM B·∫§M ---
    
    // Ph√≠m L√äN (Di chuy·ªÉn c√¢u h·ªèi l√™n)
    if (e.key === 'ArrowUp') {
        e.preventDefault(); // Ch·∫∑n cu·ªôn trang web
        window.moveQuestion(state.ui.focusedIndex, -1, type);
    }
    
    // Ph√≠m XU·ªêNG (Di chuy·ªÉn c√¢u h·ªèi xu·ªëng)
    if (e.key === 'ArrowDown') {
        e.preventDefault();
        window.moveQuestion(state.ui.focusedIndex, 1, type);
    }
    
    // Ph√≠m DELETE (X√≥a c√¢u h·ªèi ƒëang ch·ªçn)
    if (e.key === 'Delete') {
         if (confirm("B·∫°n ch·∫Øc ch·∫Øn mu·ªën x√≥a c√¢u h·ªèi n√†y?")) {
            if(isChallenge) window.removeChallengeQuestion(state.ui.focusedIndex);
            else window.removeQuestion(state.ui.focusedIndex);
            
            state.ui.focusedIndex = -1; // Reset ch·ªçn sau khi x√≥a
         }
    }
});
// ============================================================
// FIX FINAL 3: C·ªê ƒê·ªäNH ƒê·ªÄ ƒê√É TR√ÅO (D√ôNG BI·∫æN TO√ÄN C·ª§C)
// ============================================================

// 1. Bi·∫øn to√†n c·ª•c l∆∞u ƒë·ªÅ thi hi·ªán t·∫°i (QUAN TR·ªåNG: Kh√¥ng b·ªã m·∫•t khi render l·∫°i)
window.CURRENT_EXAM_SESSION = null;

// 2. H√†m Tr√°o ƒê·ªÅ (Gi·ªØ nguy√™n logic tr√°o)
window.shuffleQuestionList = (originalQuestions) => {
    if (!originalQuestions || originalQuestions.length === 0) return [];
    let questions = JSON.parse(JSON.stringify(originalQuestions));
    
    // Tr√°o th·ª© t·ª± c√¢u
    for (let i = questions.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [questions[i], questions[j]] = [questions[j], questions[i]];
    }

    // Tr√°o ƒë√°p √°n (A, B, C, D)
    questions.forEach(q => {
        if (['mcq', 'listen_mcq', 'listen_conversation', 'reading_comprehension', 'arena_quiz'].includes(q.type) && q.options && q.options.length > 1) {
            const contentCorrect = q.options[q.correct];
            let indices = q.options.map((_, i) => i);
            for (let i = indices.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [indices[i], indices[j]] = [indices[j], indices[i]];
            }
            q.options = indices.map(i => q.options[i]);
            q.correct = q.options.indexOf(contentCorrect);
        }
    });
    return questions;
};

// 3. H√†m B·∫Øt ƒë·∫ßu B√†i t·∫≠p (Updated)
window.startAssignment = (id) => {
    // N·∫øu id l√† null -> Tho√°t ch·∫ø ƒë·ªô l√†m b√†i -> X√≥a Session
    if (!id) {
        state.ui.takingAssignmentId = null;
        window.CURRENT_EXAM_SESSION = null; // X√≥a ƒë·ªÅ ƒë√£ tr√°o
        renderApp();
        return;
    }

    state.ui.takingAssignmentId = id;
    state.ui.assignmentAnswers = {};
    state.ui.currentQuestionIndex = 0;
    state.ui.viewSubmission = null;

    const originalAssign = state.data.assignments.find(a => a.id === id);
    if (originalAssign) {
        // Tr√°o ƒë·ªÅ v√† L∆∞u v√†o Bi·∫øn To√†n C·ª•c
        const shuffledQuestions = window.shuffleQuestionList(originalAssign.questions);
        
        window.CURRENT_EXAM_SESSION = {
            ...originalAssign,
            questions: shuffledQuestions,
            type: 'assignment'
        };
        console.log("üîí ƒê√£ c·ªë ƒë·ªãnh ƒë·ªÅ B√†i t·∫≠p:", shuffledQuestions);

        if (originalAssign.timeLimit) window.runTimer(originalAssign.timeLimit);
        else if (state.ui.timerInterval) clearInterval(state.ui.timerInterval);
    }
    renderApp();
};

// 4. H√†m B·∫Øt ƒë·∫ßu Th·ª≠ th√°ch (Updated)
window.initDoChallenge = (id) => {
    const c = state.data.challenges.find(i => i.id === id);
    if (!c) return;

    // Tr√°o ƒë·ªÅ v√† L∆∞u v√†o Bi·∫øn To√†n C·ª•c
    const shuffledQuestions = window.shuffleQuestionList(c.questions);
    
    window.CURRENT_EXAM_SESSION = {
        ...c,
        questions: shuffledQuestions,
        type: 'challenge'
    };
    
    // ƒê·ªìng b·ªô v√†o state ƒë·ªÉ code c≈© kh√¥ng l·ªói (nh∆∞ng hi·ªÉn th·ªã s·∫Ω ∆∞u ti√™n CURRENT_EXAM_SESSION)
    state.ui.activeChallenge = window.CURRENT_EXAM_SESSION;
    
    state.ui.challengeAnswers = {};
    state.ui.challengeQIndex = 0;
    state.ui.challengeMode = 'do';
    
    console.log("üîí ƒê√£ c·ªë ƒë·ªãnh ƒë·ªÅ Th·ª≠ th√°ch:", shuffledQuestions);
    renderApp();
};

// 5. H√†m Tho√°t Th·ª≠ th√°ch (Th√™m m·ªõi ƒë·ªÉ d·ªçn d·∫πp)
window.exitDoingChallenge = () => {
    if(!confirm("B·∫°n c√≥ ch·∫Øc mu·ªën tho√°t? K·∫øt qu·∫£ s·∫Ω kh√¥ng ƒë∆∞·ª£c l∆∞u.")) return;
    state.ui.challengeMode = 'list';
    state.ui.activeChallenge = null;
    window.CURRENT_EXAM_SESSION = null; // X√≥a ƒë·ªÅ
    renderApp();
};
// ============================================================
// FIX FINAL 4: ƒê·ªíNG B·ªò ƒêI·ªÄU H∆Ø·ªöNG & N·ªòP B√ÄI V·ªöI ƒê·ªÄ ƒê√É TR√ÅO
// ============================================================

// 1. H√†m ch·ªçn ƒë√°p √°n (C·∫≠p nh·∫≠t ƒë·ªÉ kh√¥ng b·ªã load l·∫°i ƒë·ªÅ c≈©)
window.selectAnswer = (qIdx, oIdx) => {
    // L∆∞u ƒë√°p √°n v√†o state
    state.ui.assignmentAnswers[qIdx] = oIdx;
    
    // L·∫•y ƒë·ªÅ ƒë√£ tr√°o ƒë·ªÉ v·∫Ω l·∫°i giao di·ªán (quan tr·ªçng)
    const assign = window.CURRENT_EXAM_SESSION || state.data.assignments.find(a => a.id === state.ui.takingAssignmentId);
    
    if (assign) {
        // C·∫≠p nh·∫≠t l·∫°i c√¢u h·ªèi hi·ªán t·∫°i v·ªõi ƒë√°p √°n m·ªõi ch·ªçn
        // D√πng updateAssignmentQuestionUI ƒë·ªÉ m∆∞·ª£t m√† h∆°n renderApp
        if (typeof window.updateAssignmentQuestionUI === 'function') {
            window.updateAssignmentQuestionUI(assign, qIdx);
        } else {
            renderApp(); // Fallback n·∫øu kh√¥ng c√≥ h√†m update c·ª•c b·ªô
        }
    }
};

// 2. H√†m chuy·ªÉn c√¢u ti·∫øp theo (Fix l·ªói load l·∫°i ƒë·ªÅ g·ªëc)
window.goToNextQuestion = () => {
    // ∆Øu ti√™n l·∫•y t·ª´ Session (ƒë√£ tr√°o)
    const assign = window.CURRENT_EXAM_SESSION || state.data.assignments.find(a => a.id === state.ui.takingAssignmentId);
    if (!assign) return;
    
    const totalQuestions = assign.questions.length;
    if (state.ui.currentQuestionIndex < totalQuestions - 1) {
        state.ui.currentQuestionIndex++;
        // C·∫≠p nh·∫≠t UI v·ªõi b·ªô ƒë·ªÅ ƒê√öNG
        if (typeof window.updateAssignmentQuestionUI === 'function') {
            window.updateAssignmentQuestionUI(assign, state.ui.currentQuestionIndex);
        } else {
            renderApp();
        }
    }
};

// 3. H√†m quay l·∫°i c√¢u tr∆∞·ªõc
window.goToPreviousQuestion = () => {
    const assign = window.CURRENT_EXAM_SESSION || state.data.assignments.find(a => a.id === state.ui.takingAssignmentId);
    if (!assign) return;
    
    if (state.ui.currentQuestionIndex > 0) {
        state.ui.currentQuestionIndex--;
        if (typeof window.updateAssignmentQuestionUI === 'function') {
            window.updateAssignmentQuestionUI(assign, state.ui.currentQuestionIndex);
        } else {
            renderApp();
        }
    }
};

// 4. H√†m N·ªôp B√†i (QUAN TR·ªåNG NH·∫§T: Ch·∫•m ƒëi·ªÉm d·ª±a tr√™n ƒë·ªÅ ƒë√£ tr√°o)
// ============================================================
// FIX FINAL 5: S·ª¨A L·ªñI "UNDEFINED" KHI N·ªòP C√ÇU T·ª∞ LU·∫¨N
// --- C·∫¨P NH·∫¨T: N·ªòP B√ÄI T·∫¨P (X·ª¨ L√ù T·ª∞ LU·∫¨N CH·ªú CH·∫§M) ---
window.submitAssignment = async () => {
    if (state.ui.isSubmitting) return;
    const assignId = state.ui.takingAssignmentId;
    
    // Ki·ªÉm tra n·ªôp ƒë√∫p
    const existingSub = state.data.submissions.find(s => s.assignmentId === assignId && s.studentId === state.user.uid);
    if (existingSub) {
        showToast("B·∫°n ƒë√£ n·ªôp b√†i t·∫≠p n√†y r·ªìi!", "error");
        state.ui.takingAssignmentId = null;
        renderApp();
        return;
    }

    if (!confirm("B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën n·ªôp b√†i?")) return;

    state.ui.isSubmitting = true;
    const submitBtn = document.querySelector('#next-q-btn-container button');
    if(submitBtn) { 
        submitBtn.disabled = true; 
        submitBtn.innerHTML = '<i class="animate-spin" data-lucide="loader-2"></i> ƒêang n·ªôp...'; 
        renderIcons(); 
    }

    try {
        // 1. L·∫•y ƒë·ªÅ thi (∆Øu ti√™n ƒë·ªÅ ƒë√£ tr√°o trong Session)
        const assign = window.CURRENT_EXAM_SESSION || state.data.assignments.find(a => a.id === assignId);
        
        let score = 0;
        const totalQuestions = assign.questions.length;
        const scorePerQuestion = 100 / totalQuestions;
        const questionDataToSave = {};
        
        // C·ªù ki·ªÉm tra c√≥ c√¢u t·ª± lu·∫≠n kh√¥ng
        let hasManualQuestion = false;

        assign.questions.forEach((q, idx) => {
            let userAns = state.ui.assignmentAnswers[idx];
            let isCorrect = false;

            // L∆∞u c·∫•u tr√∫c ƒë·ªÅ ƒë√£ tr√°o
            if (q.type === 'match' && q.shuffledColB) questionDataToSave[idx] = { shuffledColB: q.shuffledColB };
            else if (q.type === 'jumble' && q.shuffledWords) questionDataToSave[idx] = { shuffledWords: q.shuffledWords };
            else if (q.type === 'order_sentences' && q.shuffledSentences) questionDataToSave[idx] = { shuffledSentences: q.shuffledSentences };

            // X·ª≠ l√Ω undefined cho c√¢u t·ª± lu·∫≠n
            if (userAns === undefined && ['make_sentence', 'image_describe'].includes(q.type)) {
                userAns = ""; 
            }

            // Logic ch·∫•m ƒëi·ªÉm
            switch(q.type) {
                case 'mcq': case 'listen_mcq': case 'listen_conversation': case 'reading_comprehension':
                    isCorrect = userAns === q.correct;
                    break;
                case 'fib': case 'translation': case 'listen_write': case 'listen_translate':
                    if (userAns) {
                        let expected = (q.type === 'translation' ? q.chinese : q.answer).trim().toLowerCase();
                        isCorrect = userAns.trim().toLowerCase() === expected;
                    }
                    break;
                case 'jumble':
                    if (Array.isArray(userAns)) isCorrect = q.answer.join(' ') === userAns.join(' ');
                    break;
                case 'order_sentences':
                    if (Array.isArray(userAns)) isCorrect = JSON.stringify(userAns) === JSON.stringify(q.answer);
                    break;
                case 'match':
                    if (userAns) {
                        const colBToUse = q.shuffledColB || q.pairs.map(p => p.b).sort(() => Math.random() - 0.5);
                        const numCorrect = q.pairs.reduce((count, p, aIdx) => {
                            const bIdx = userAns[aIdx];
                            return count + (colBToUse[bIdx] === p.b ? 1 : 0);
                        }, 0);
                        isCorrect = numCorrect === q.pairs.length;
                    }
                    break;
                case 'make_sentence': 
                case 'image_describe':
                    // ƒê√°nh d·∫•u l√† c√¢u t·ª± lu·∫≠n c·∫ßn ch·∫•m
                    hasManualQuestion = true;
                    isCorrect = false; // T·∫°m th·ªùi 0 ƒëi·ªÉm, ch·ªù GV ch·∫•m
                    questionDataToSave[idx] = { manualReviewNeeded: true };
                    break;
            }

            if (isCorrect) score += scorePerQuestion;
        });

        score = Math.round(score);

        // 2. X√°c ƒë·ªãnh tr·∫°ng th√°i b√†i n·ªôp
// 2. X√ÅC ƒê·ªäNH TR·∫†NG TH√ÅI & T·∫†O NH·∫¨N X√âT CHI TI·∫æT
        const submissionStatus = hasManualQuestion ? 'pending' : 'graded';
        
        let autoComment = "";
        
        if (hasManualQuestion) {
            // Tr∆∞·ªùng h·ª£p c√≥ c√¢u t·ª± lu·∫≠n: Th√¥ng b√°o ch·ªù ch·∫•m
            autoComment = `H·ªá th·ªëng ƒë√£ ghi nh·∫≠n b√†i l√†m. ƒêi·ªÉm tr·∫Øc nghi·ªám t·∫°m t√≠nh: ${score}ƒë. Gi√°o vi√™n s·∫Ω ch·∫•m ph·∫ßn t·ª± lu·∫≠n v√† c·∫≠p nh·∫≠t ƒëi·ªÉm sau.`;
        } else {
            // Tr∆∞·ªùng h·ª£p to√†n tr·∫Øc nghi·ªám: Nh·∫≠n x√©t chi ti·∫øt theo thang ƒëi·ªÉm
            if (score >= 100) {
                autoComment = "Xu·∫•t s·∫Øc! Em l√†m b√†i r·∫•t t·ªët, h√£y ti·∫øp t·ª•c duy tr√¨ phong ƒë·ªô n√†y nh√©! üåü";
            } else if (score >= 80) {
                autoComment = "R·∫•t t·ªët! Em ƒë√£ n·∫Øm v·ªØng ki·∫øn th·ª©c, h√£y c·ªë g·∫Øng th√™m ch√∫t n·ªØa ƒë·ªÉ ƒë·∫°t ƒëi·ªÉm t·ªëi ƒëa nh√©! üí™.";
            } else if (score >= 70) {
                autoComment = "C·∫ßn c·ªë g·∫Øng h∆°n! Em h√£y √¥n t·∫≠p k·ªπ l·∫°i b√†i h·ªçc v√† l√†m l·∫°i b√†i t·∫≠p ƒë·ªÉ ƒë·∫°t k·∫øt qu·∫£ cao h∆°n nh√©! üìö";
            } else {
                autoComment = "C·∫ßn c·ªë g·∫Øng nhi·ªÅu h∆°n! ƒê·ª´ng n·∫£n ch√≠, h√£y t√≠ch c·ª±c h·ªçc t·ª´ v·ª±ng v√† c·∫•u tr√∫c c√¢u nh√©. üî•";
            }
        }


// 4a. L∆∞u k·∫øt qu·∫£ b√†i l√†m (Submissions)
        const subRef = await addDoc(getRef('submissions'), {
            assignmentId: assign.id,
            studentId: state.user.uid,
            score,
            answers: state.ui.assignmentAnswers,
            questionData: questionDataToSave,
            
            questionsSnapshot: assign.questions, // [TH√äM D√íNG N√ÄY] L∆∞u l·∫°i ƒë·ªÅ ƒë√£ tr·ªôn
            
            createdAt: serverTimestamp(),
            teacherComment: autoComment
        });

        // C·∫≠p nh·∫≠t User Profile (C·ªông ƒëi·ªÉm tr·∫Øc nghi·ªám tr∆∞·ªõc)
        const userRef = doc(db, getPath('users'), state.user.uid);
        const updatePayload = { points: increment(score) };
        // --- LOGIC M·ªöI: T·∫∑ng v√© quay n·∫øu ƒëi·ªÉm > 90 ---
        let earnedTicket = false;
        if (score > 90) { 
                   updatePayload.luckyTickets = increment(1); // C·ªông 1 v√© quay
                   earnedTicket = true;
            }
        if (score === 100 && !hasManualQuestion) updatePayload.perfectScores = increment(1);
        await updateDoc(userRef, updatePayload);

        // 4. Hi·ªÉn th·ªã k·∫øt qu·∫£
        state.ui.viewSubmission = {
            id: subRef.id,
            assignmentId: assign.id,
            studentId: state.user.uid,
            score: score,
            answers: state.ui.assignmentAnswers,
            questionData: questionDataToSave,
            status: submissionStatus, // L∆∞u tr·∫°ng th√°i v√†o UI
            assignment: assign,
            teacherComment: autoComment
        };
        state.ui.takingAssignmentId = null;

        if (state.ui.timerInterval) clearInterval(state.ui.timerInterval);

        if (hasManualQuestion) {
	showToast(`N·ªôp th√†nh c√¥ng! ƒêi·ªÉm tr·∫Øc nghi·ªám: ${score}. ƒêang ch·ªù ch·∫•m t·ª± lu·∫≠n.`, "info");
         } else {
    	// Th√¥ng b√°o cho h·ªçc sinh bi·∫øt
   	 if (earnedTicket) {
        	showToast(`Tuy·ªát v·ªùi! B·∫°n ƒë·∫°t ${score} ƒëi·ªÉm v√† nh·∫≠n ƒë∆∞·ª£c 1 V√â QUAY MAY M·∫ÆN! üéÅ`, "success");
        	// Hi·ªáu ·ª©ng ph√°o gi·∫•y
        	if (typeof window.triggerConfetti === 'function') window.triggerConfetti();
   	 } else {
        	showToast(`N·ªôp th√†nh c√¥ng! +${score} ƒëi·ªÉm`, "success");
   	 }
             }
        
        renderApp();

    } catch(e) {
        console.error("L·ªói Submission:", e);
        showToast("L·ªói n·ªôp b√†i: " + e.message, "error");
    } finally {
        state.ui.isSubmitting = false;
    }
};
// --- H√ÄM M·ªöI: L∆ØU T·∫§T C·∫¢ ƒêI·ªÇM T·ª∞ LU·∫¨N C√ôNG L√öC ---
window.saveAllManualGrades = async (subId) => {
    // 1. L·∫•y d·ªØ li·ªáu b√†i t·∫≠p ƒëang xem
    const subView = state.ui.viewSubmission;
    if (!subView || !subView.assignment) return showToast("Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu b√†i t·∫≠p.", "error");
    
    const assign = subView.assignment;
    const updates = {}; // Object ch·ª©a c√°c ƒëi·ªÉm m·ªõi: { index: score }
    let hasData = false;
    
    // ƒêi·ªÉm t·ªëi ƒëa cho m·ªói c√¢u
    const scorePerQuestion = 100 / assign.questions.length;

    // 2. Qu√©t qua giao di·ªán ƒë·ªÉ l·∫•y gi√° tr·ªã t·ª´ c√°c √¥ nh·∫≠p ƒëi·ªÉm
    assign.questions.forEach((q, idx) => {
        // Ch·ªâ l·∫•y ƒëi·ªÉm c·ªßa c√¢u t·ª± lu·∫≠n
        if (['make_sentence', 'image_describe'].includes(q.type)) {
            const inputEl = document.getElementById(`manual-score-${idx}`);
            if (inputEl) {
                let val = parseFloat(inputEl.value);
                // Validate ƒëi·ªÉm h·ª£p l·ªá (kh√¥ng √¢m, kh√¥ng qu√° ƒëi·ªÉm t·ªëi ƒëa c·ªßa c√¢u)
                // L√†m tr√≤n 2 s·ªë l·∫ª ƒë·ªÉ so s√°nh
                if (!isNaN(val) && val >= 0 && val <= (scorePerQuestion + 0.1)) {
                    updates[idx] = val;
                    hasData = true;
                }
            }
        }
    });

    if (!hasData) return showToast("Kh√¥ng c√≥ thay ƒë·ªïi ho·∫∑c ƒëi·ªÉm kh√¥ng h·ª£p l·ªá.", "info");

    // 3. Hi·ªÉn th·ªã tr·∫°ng th√°i ƒëang l∆∞u
    const saveBtn = document.getElementById('btn-save-all-grades');
    let originalBtnContent = '';
    if(saveBtn) {
        saveBtn.disabled = true;
        originalBtnContent = saveBtn.innerHTML;
        saveBtn.innerHTML = '<i class="animate-spin" data-lucide="loader-2"></i> ƒêang l∆∞u...';
        renderIcons();
    }

    try {
        await runTransaction(db, async (transaction) => {
            const subRef = doc(db, getPath('submissions'), subId);
            const subDoc = await transaction.get(subRef);
            if (!subDoc.exists()) throw "B√†i n·ªôp kh√¥ng t·ªìn t·∫°i";
            const subData = subDoc.data();

            // G·ªôp ƒëi·ªÉm m·ªõi v√†o danh s√°ch ƒëi·ªÉm c≈©
            const currentManualGrades = subData.manualGrades || {};
            Object.assign(currentManualGrades, updates); // Merge ƒëi·ªÉm m·ªõi v√†o

            // --- T√çNH TO√ÅN L·∫†I T·ªîNG ƒêI·ªÇM (Logic gi·ªëng saveManualGrade) ---
            let newTotalScore = 0;
            let manualCorrectCount = 0;
            
            // a. T√≠nh t·ªïng ƒëi·ªÉm t·ª± lu·∫≠n
            Object.keys(currentManualGrades).forEach(k => {
                const s = currentManualGrades[k];
                newTotalScore += s;
                // N·∫øu ƒë∆∞·ª£c >= 50% ƒëi·ªÉm c√¢u ƒë√≥ th√¨ t√≠nh l√† 1 c√¢u ƒë√∫ng
                if (s >= (scorePerQuestion/2)) manualCorrectCount++;
            });

            // b. T√≠nh ƒëi·ªÉm tr·∫Øc nghi·ªám (T·ª± ƒë·ªông)
            // L·∫•y t·ªïng ƒëi·ªÉm c≈© tr·ª´ ƒëi t·ªïng ƒëi·ªÉm t·ª± lu·∫≠n c≈© ƒë·ªÉ ra ph·∫ßn tr·∫Øc nghi·ªám
            // Tuy nhi√™n, ƒë·ªÉ an to√†n nh·∫•t, ta n√™n t√≠nh l·∫°i t·ª´ ƒë·∫ßu ho·∫∑c gi·∫£ ƒë·ªãnh ph·∫ßn tr·∫Øc nghi·ªám kh√¥ng ƒë·ªïi.
            // C√°ch ƒë∆°n gi·∫£n: T√≠nh l·∫°i to√†n b·ªô d·ª±a tr√™n logic c√¢u h·ªèi
            // (ƒê·ªÉ code ng·∫Øn g·ªçn, ·ªü ƒë√¢y t√¥i d√πng c√°ch t√≠nh l·∫°i ƒëi·ªÉm Auto d·ª±a tr√™n m·∫£ng answers)
            let autoScore = 0;
            let autoCorrectCount = 0;
            
            assign.questions.forEach((q, idx) => {
                // B·ªè qua c√¢u t·ª± lu·∫≠n (ƒë√£ t√≠nh ·ªü tr√™n)
                if (['make_sentence', 'image_describe'].includes(q.type)) return;

                const userAns = subData.answers[idx];
                let isCorrect = false;
                
                // Logic check ƒë√∫ng sai c∆° b·∫£n (Copy t·ª´ logic ch·∫•m b√†i)
                if (q.type === 'mcq' || q.type === 'listen_mcq' || q.type === 'listen_conversation' || q.type === 'reading_comprehension') {
                    isCorrect = userAns === q.correct;
                } else if (['fib', 'translation', 'listen_write', 'listen_translate'].includes(q.type)) {
                    if (userAns) isCorrect = userAns.trim().toLowerCase() === (q.type === 'translation' ? q.chinese : q.answer).trim().toLowerCase();
                } else if (q.type === 'jumble') {
                    if (Array.isArray(userAns)) isCorrect = q.answer.join(' ') === userAns.join(' ');
                } else if (q.type === 'order_sentences') {
                    if (Array.isArray(userAns)) isCorrect = JSON.stringify(userAns) === JSON.stringify(q.answer);
                } else if (q.type === 'match') {
                    // Logic match ƒë∆°n gi·∫£n ho√°
                     if (userAns) {
                        const colBToUse = (subData.questionData && subData.questionData[idx] && subData.questionData[idx].shuffledColB) 
                                          || q.pairs.map(p => p.b).sort(() => Math.random() - 0.5); // L∆∞u √Ω: N·∫øu ko c√≥ snapshot shuffle th√¨ check n√†y c√≥ th·ªÉ sai l·ªách nh·∫π, nh∆∞ng ch·∫•p nh·∫≠n ƒë∆∞·ª£c.
                        // ƒê·ªÉ ch√≠nh x√°c tuy·ªát ƒë·ªëi c·∫ßn l∆∞u shuffle state.
                        // ·ªû ƒë√¢y ta gi·∫£ ƒë·ªãnh n·∫øu ƒë√£ ƒë∆∞·ª£c ch·∫•m 'graded' th√¨ logic c≈© ƒë√£ ƒë√∫ng.
                        // T·∫°m t√≠nh: 
                        // isCorrect = true; // C·∫ßn logic check match k·ªπ h∆°n n·∫øu mu·ªën
                     }
                }
                
                // C√°ch an to√†n h∆°n: L·∫•y ƒëi·ªÉm c≈© c·ªßa b√†i n·ªôp TR·ª™ ƒêI ƒëi·ªÉm c√°c c√¢u t·ª± lu·∫≠n c≈©
                // Nh∆∞ng v√¨ ta kh√¥ng l∆∞u ƒëi·ªÉm t·ª´ng c√¢u, n√™n ta t√≠nh l·∫°i
            });
            
            // --- C√ÅCH T√çNH AN TO√ÄN NH·∫§T (D·ª±a tr√™n Delta) ---
            // 1. L·∫•y ƒëi·ªÉm t·ªïng c≈©
            const oldTotalScore = subData.score || 0;
            // 2. L·∫•y t·ªïng ƒëi·ªÉm c√°c c√¢u t·ª± lu·∫≠n C≈®
            const oldManualGrades = subData.manualGrades || {};
            let oldManualTotal = 0;
            Object.values(oldManualGrades).forEach(s => oldManualTotal += s);
            
            // 3. Suy ra ƒëi·ªÉm tr·∫Øc nghi·ªám (Auto) = T·ªïng c≈© - T·ª± lu·∫≠n c≈©
            const scoreAutoOnly = oldTotalScore - oldManualTotal;
            
            // 4. T·ªïng m·ªõi = Auto + T·ª± lu·∫≠n M·ªõi
            newTotalScore = scoreAutoOnly + newTotalScore; // newTotalScore l√∫c n√†y ƒëang ch·ª©a t·ªïng manual m·ªõi
            
            // L√†m tr√≤n
            newTotalScore = Math.round(newTotalScore * 100) / 100;
            newTotalScore = Math.min(100, Math.max(0, newTotalScore)); // K·∫πp trong 0-100

            // C·∫≠p nh·∫≠t nh·∫≠n x√©t t·ª± ƒë·ªông
            let newComment = subData.teacherComment || "";
            // N·∫øu ch∆∞a c√≥ comment ri√™ng, t·∫°o comment t·ª± ƒë·ªông
            if (!newComment || newComment.includes("H·ªá th·ªëng ƒë√£ ghi nh·∫≠n")) {
                 if (newTotalScore >= 90) newComment = "Xu·∫•t s·∫Øc! Em l√†m b√†i r·∫•t t·ªët, h√£y ti·∫øp t·ª•c duy tr√¨ phong ƒë·ªô nh√© üåü";
                 else if (newTotalScore >= 80) newComment = "R·∫•t t·ªët! Em ƒë√£ n·∫Øm v·ªØng ki·∫øn th·ª©c, h√£y c·ªë g·∫Øng th√™m ch√∫t n·ªØa ƒë·ªÉ ƒë·∫°t ƒëi·ªÉm t·ªëi ƒëa nh√©! üí™.";
                 else if (newTotalScore >= 70) newComment = "C·∫ßn c·ªë g·∫Øng h∆°n! Em h√£y √¥n t·∫≠p k·ªπ l·∫°i b√†i h·ªçc v√† l√†m l·∫°i b√†i t·∫≠p ƒë·ªÉ ƒë·∫°t k·∫øt qu·∫£ cao h∆°n nh√©! üìö";
                 else newComment = "C·∫ßn c·ªë g·∫Øng nhi·ªÅu h∆°n! ƒê·ª´ng n·∫£n ch√≠, h√£y t√≠ch c·ª±c h·ªçc t·ª´ v·ª±ng v√† c·∫•u tr√∫c c√¢u nh√©. üî•";
            }

            const scoreDelta = newTotalScore - oldTotalScore;

            // Update Submission
            transaction.update(subRef, { 
                manualGrades: currentManualGrades,
                score: newTotalScore,
                teacherComment: newComment,
                status: 'graded' // ƒê√°nh d·∫•u ƒë√£ ch·∫•m xong
            });

            // Update ƒëi·ªÉm User (n·∫øu ƒëi·ªÉm thay ƒë·ªïi)
// --- LOGIC M·ªöI: Update ƒëi·ªÉm User & T·∫∑ng qu√† ---
if (Math.round(scoreDelta) !== 0) {
    const userRef = doc(db, getPath('users'), subData.studentId);
    
    // T·∫°o object d·ªØ li·ªáu c·∫ßn update
    let userUpdateData = { 
        points: increment(Math.round(scoreDelta)) 
    };

    // Ki·ªÉm tra ƒëi·ªÅu ki·ªán t·∫∑ng v√©:
    // 1. ƒêi·ªÉm M·ªöI ph·∫£i > 90
    // 2. ƒêi·ªÉm C≈® (subData.score) ph·∫£i <= 90 (ƒë·ªÉ tr√°nh t·∫∑ng l·∫∑p l·∫°i khi s·ª≠a ƒëi·ªÉm cao)
    const oldScore = subData.score || 0; // L·∫•y ƒëi·ªÉm c≈©
    
    if (newTotalScore > 90 && oldScore <= 90) {
        userUpdateData.luckyTickets = increment(1); // T·∫∑ng 1 v√©
        // L∆∞u √Ω: C√≥ th·ªÉ th√™m th√¥ng b√°o ri√™ng ho·∫∑c ƒë·ªÉ h·ªçc sinh t·ª± th·∫•y khi v√†o app
    }

    // Th·ª±c hi·ªán update v√†o database
    transaction.update(userRef, userUpdateData);
}
// ----------------------------------------------
        });

        // 4. Update UI Local ngay l·∫≠p t·ª©c
        if (state.ui.viewSubmission) {
            if (!state.ui.viewSubmission.manualGrades) state.ui.viewSubmission.manualGrades = {};
            Object.assign(state.ui.viewSubmission.manualGrades, updates);
        }
        
        showToast("ƒê√£ l∆∞u t·∫•t c·∫£ ƒëi·ªÉm th√†nh c√¥ng!", "success");
        // Kh√¥ng c·∫ßn g·ªçi renderApp() ·ªü ƒë√¢y v√¨ Listener c·ªßa Firebase s·∫Ω t·ª± g·ªçi khi d·ªØ li·ªáu thay ƒë·ªïi
        // Nh∆∞ng n·∫øu mu·ªën ch·∫Øc ch·∫Øn reset n√∫t b·∫•m:
        if(saveBtn) {
            saveBtn.disabled = false;
            saveBtn.innerHTML = originalBtnContent;
            renderIcons();
        }

    } catch (e) {
        console.error(e);
        showToast("L·ªói khi l∆∞u ƒëi·ªÉm: " + e.message, "error");
        if(saveBtn) {
            saveBtn.disabled = false;
            saveBtn.innerHTML = originalBtnContent;
            renderIcons();
        }
    }
};
/* =========================================
   CH·ª®C NƒÇNG: POPUP BI·ªÇU ƒê·ªí KHI V√ÄO APP
/* =========================================
/* =========================================
   CH·ª®C NƒÇNG: POPUP FINAL - FIX √ÇM THANH
   - Fix l·ªói: Th√™m Preload ƒë·ªÉ t·∫£i nh·∫°c tr∆∞·ªõc
   - Fix l·ªói: ƒê·ªïi link nh·∫°c nh·∫π h∆°n (Game Coin Sound)
   - L∆∞u √Ω: B·∫°n c·∫ßn CLICK v√†o trang √≠t nh·∫•t 1 l·∫ßn th√¨ m·ªõi nghe th·∫•y (Lu·∫≠t c·ªßa tr√¨nh duy·ªát)
   ========================================= */

window.hasShownIntro = false;

// --- C·∫§U H√åNH √ÇM THANH ---
// T·∫°o ƒë·ªëi t∆∞·ª£ng Audio to√†n c·ª•c ƒë·ªÉ t·∫£i tr∆∞·ªõc
const successAudio = new Audio('https://assets.mixkit.co/sfx/preview/mixkit-arcade-game-jump-coin-216.mp3');
successAudio.volume = 0.6;
successAudio.preload = 'auto'; // Y√™u c·∫ßu t·∫£i ngay l·∫≠p t·ª©c

// H√†m ph√°t nh·∫°c an to√†n
const playSuccessSound = () => {
    // Reset th·ªùi gian v·ªÅ 0 ƒë·ªÉ ph√°t l·∫°i t·ª´ ƒë·∫ßu n·∫øu g·ªçi nhi·ªÅu l·∫ßn
    successAudio.currentTime = 0;
    
    // Th·ª≠ ph√°t nh·∫°c
    const playPromise = successAudio.play();

    if (playPromise !== undefined) {
        playPromise.then(_ => {
            // Ph√°t th√†nh c√¥ng!
            console.log("Audio played successfully!");
        })
        .catch(error => {
            // N·∫øu b·ªã ch·∫∑n, log ra ƒë·ªÉ bi·∫øt
            console.warn("Tr√¨nh duy·ªát ƒë√£ ch·∫∑n √¢m thanh t·ª± ƒë·ªông. Ng∆∞·ªùi d√πng c·∫ßn t∆∞∆°ng t√°c v·ªõi trang web tr∆∞·ªõc.", error);
        });
    }
};

window.showWelcomeStats = function() {
    if (window.hasShownIntro) return;

    // --- L·∫§Y D·ªÆ LI·ªÜU ---
    const p = state.profile || {};
    const u = state.user || {};
    const rawName = p.name || p.displayName || u.displayName || "H·ªçc vi√™n EduBattle";
    const displayName = rawName;

    // Avatar Logic
    const rawAvatar = p.avatar || p.avatarUrl || p.photoURL || u.photoURL;
    const isUrl = rawAvatar && (rawAvatar.toString().startsWith('http') || rawAvatar.toString().startsWith('data:'));
    const avatarContent = rawAvatar || "üéì"; 

    // Ki·ªÉm tra d·ªØ li·ªáu
    if (!p.name && !p.displayName && !u.displayName) return; 
    
    window.hasShownIntro = true;

    // --- CSS ---
    const styleId = 'stats-final-sound-fix-v2';
    if (!document.getElementById(styleId)) {
        const style = document.createElement('style');
        style.id = styleId;
        style.innerHTML = `
            .modal-backdrop { background: rgba(15, 23, 42, 0.7); backdrop-filter: blur(8px); opacity: 0; transition: opacity 0.4s ease; }
            .modal-backdrop.show { opacity: 1; }
            .modal-card { opacity: 0; transform: scale(0.95) translateY(40px); transition: all 0.5s cubic-bezier(0.19, 1, 0.22, 1); }
            .modal-card.show { opacity: 1; transform: scale(1) translateY(0); }
            .avatar-glow { animation: pulse-glow 3s infinite; }
            @keyframes pulse-glow { 0% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.4); } 70% { box-shadow: 0 0 0 10px rgba(59, 130, 246, 0); } 100% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0); } }
            .stat-box-horizontal {
                display: flex; flex-direction: column; align-items: center; justify-content: center;
                padding: 10px 4px; background: #f8fafc; border: 1px solid transparent; border-radius: 16px;
                transition: all 0.2s ease; text-align: center;
            }
            .stat-box-horizontal:hover { background: #fff; transform: translateY(-4px); border-color: #e2e8f0; box-shadow: 0 8px 20px -4px rgba(0,0,0,0.1); }
            .icon-circle { width: 36px; height: 36px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-bottom: 6px; }
        `;
        document.head.appendChild(style);
    }

    // --- S·ªê LI·ªÜU ---
    const stats = {
        points: p.points || 0,
        streak: p.streak || 0,
        tickets: p.luckyTickets || 0,
        perfect: p.perfectScores || 0
    };

    const chartData = [
        Math.min(stats.points / 30, 120),       
        Math.min(stats.streak * 5, 120),       
        Math.min(stats.tickets * 4, 120), 
        Math.min(stats.perfect * 4, 120) 
    ];

    const modalId = 'welcome-stats-modal';

    // --- HTML ---
    let avatarHtml = '';
    if (isUrl) {
        avatarHtml = `<img src="${rawAvatar}" onerror="this.src='https://ui-avatars.com/api/?name=${encodeURIComponent(rawName)}&background=2563eb&color=fff'" class="avatar-glow relative w-20 h-20 rounded-full border-[4px] border-white shadow-lg object-cover bg-slate-200">`;
    } else {
        avatarHtml = `<div class="avatar-glow relative w-20 h-20 rounded-full border-[4px] border-white shadow-lg bg-blue-100 flex items-center justify-center text-4xl select-none">${avatarContent}</div>`;
    }

    const modalHtml = `
    <div id="${modalId}" class="modal-backdrop fixed inset-0 z-[9999] flex items-center justify-center px-4 font-sans">
        <div class="modal-card bg-white w-full max-w-md rounded-[32px] p-6 shadow-2xl relative flex flex-col items-center" id="${modalId}-content">
            
            <button onclick="window.closeWelcomeStats('${modalId}')" class="absolute top-4 right-4 w-8 h-8 flex items-center justify-center rounded-full bg-slate-50 hover:bg-slate-100 text-slate-400 transition-colors z-10 cursor-pointer">
                <i data-lucide="x" class="w-5 h-5"></i>
            </button>

            <div class="flex flex-col items-center text-center mb-5 mt-1">
                <div class="relative mb-2">
                    ${avatarHtml}
                    <div class="absolute bottom-0 right-0 bg-yellow-500 text-white text-[11px] font-bold px-2 py-0.5 rounded-full border-2 border-white shadow-sm z-10">
                        LV.${Math.floor(stats.points / 500) + 1}
                    </div>
                </div>
                <h2 class="text-3xl font-black bg-gradient-to-r from-blue-600 to-indigo-600 bg-clip-text text-transparent tracking-tight mb-1">${displayName}</h2>
                <p class="text-slate-500 text-sm font-medium">Ch√†o m·ª´ng tr·ªü l·∫°i! S·∫µn s√†ng b·ª©t ph√° nh√©.</p>
            </div>

            <div class="w-full mb-6 px-1">
                <div class="h-36 w-full"> <canvas id="proBarChart"></canvas> </div>
            </div>

            <div class="grid grid-cols-4 gap-2 w-full mb-6">
                <div class="stat-box-horizontal group">
                    <div class="icon-circle bg-yellow-100 text-yellow-600 group-hover:scale-110 transition-transform"><i data-lucide="star" class="w-4 h-4 fill-current"></i></div>
                    <span class="text-lg font-black text-yellow-500 leading-none mb-1">${stats.points}</span>
                    <span class="text-[12px] font-bold text-yellow-500  tracking-wide">ƒêi·ªÉm s·ªë</span>
                </div>
                <div class="stat-box-horizontal group">
                    <div class="icon-circle bg-orange-100 text-orange-600 group-hover:scale-110 transition-transform"><i data-lucide="flame" class="w-4 h-4 fill-current"></i></div>
                    <span class="text-lg font-black text-red-500 leading-none mb-1">${stats.streak}</span>
                    <span class="text-[12px] font-bold text-red-500  tracking-wide">Th·ª≠ th√°ch</span>
                </div>
                <div class="stat-box-horizontal group">
                    <div class="icon-circle bg-blue-100 text-blue-600 group-hover:scale-110 transition-transform"><i data-lucide="ticket" class="w-4 h-4 fill-current"></i></div>
                    <span class="text-lg font-black text-blue-500 leading-none mb-1">${stats.tickets}</span>
                    <span class="text-[12px] font-bold text-blue-500  tracking-wide">V√© th∆∞·ªüng</span>
                </div>
                <div class="stat-box-horizontal group">
                    <div class="icon-circle bg-green-100 text-green-600 group-hover:scale-110 transition-transform"><i data-lucide="award" class="w-4 h-4 fill-current"></i></div>
                    <span class="text-lg font-black text-green-500 leading-none mb-1">${stats.perfect}</span>
                    <span class="text-[12px] font-bold text-green-500  tracking-wide">ƒêi·ªÉm 100</span>
                </div>
            </div>

            <button onclick="window.closeWelcomeStats('${modalId}')" class="w-full bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-700 hover:to-indigo-700 text-white font-bold py-3.5 rounded-2xl shadow-lg shadow-blue-200/50 transition-all active:scale-[0.98] flex items-center justify-center gap-2 cursor-pointer">
                <span>V√†o h·ªçc ngay</span>
                <i data-lucide="arrow-right" class="w-5 h-5"></i>
            </button>
        </div>
    </div>
    `;

    document.body.insertAdjacentHTML('beforeend', modalHtml);
    lucide.createIcons();

    // 1. Hi·ªán Modal + PH√ÅT NH·∫†C
    setTimeout(() => {
        const backdrop = document.getElementById(modalId);
        const card = document.getElementById(`${modalId}-content`);
        if(backdrop) backdrop.classList.add('show');
        if(card) card.classList.add('show');
        
        // >>> PH√ÅT √ÇM THANH <<<
        playSuccessSound(); 
    }, 50);

    // 2. V·∫Ω Chart + Animation
    setTimeout(() => {
        const ctx = document.getElementById('proBarChart');
        if (ctx) {
            const chartCtx = ctx.getContext('2d');
            const createGradient = (c1, c2) => {
                const g = chartCtx.createLinearGradient(0, 150, 0, 0);
                g.addColorStop(0, c1); g.addColorStop(1, c2); return g;
            };
            
            if (window.myStatsChart) { window.myStatsChart.destroy(); }

            window.myStatsChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Ki·∫øn th·ª©c', 'ChƒÉm ch·ªâ', 'May m·∫Øn', 'Xu·∫•t s·∫Øc'],
                    datasets: [{
                        data: chartData,
                        backgroundColor: [
                            createGradient('#facc15', '#ca8a04'), createGradient('#fb923c', '#ea580c'),
                            createGradient('#60a5fa', '#2563eb'), createGradient('#4ade80', '#16a34a')
                        ],
                        borderWidth: 0, borderRadius: 6, barPercentage: 0.6,
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    scales: { y: { display: false, beginAtZero: true, min: 0 }, x: { display: false } },
                    plugins: { legend: { display: false }, tooltip: { enabled: false } },
                    animation: { 
                        duration: 1500, 
                        easing: 'easeOutBounce', 
                        delay: (c) => c.dataIndex * 200
                    }
                }
            });
        }
    }, 500);
};

// H√†m ƒë√≥ng Popup
window.closeWelcomeStats = function(id) {
    const backdrop = document.getElementById(id);
    const card = document.getElementById(`${id}-content`);
    if(backdrop) backdrop.classList.remove('show');
    if(card) { card.style.transform = 'scale(0.95) translateY(20px)'; card.style.opacity = '0'; }
    setTimeout(() => {
        if(backdrop) backdrop.remove();
        if (window.myStatsChart) { window.myStatsChart.destroy(); window.myStatsChart = null; }
        const style = document.getElementById('stats-final-sound-fix-v2');
        if(style) style.remove();
    }, 400);
};
// === LOGIC M·ªû GAME (ƒê√£ s·ª≠a l·ªói scope) ===
window.openGameModal = function(gameUrl) {
    console.log("ƒêang m·ªü game:", gameUrl); // D√≤ng n√†y ƒë·ªÉ ki·ªÉm tra xem h√†m c√≥ ch·∫°y kh√¥ng

    const modal = document.getElementById('gameModal');
    const frame = document.getElementById('gameFrame');
    
    // Ki·ªÉm tra xem ƒë√£ c√≥ Modal ch∆∞a (B∆∞·ªõc 1)
    if (!modal || !frame) {
        alert("L·ªói: Kh√¥ng t√¨m th·∫•y khung Game! B·∫°n h√£y ki·ªÉm tra l·∫°i xem ƒë√£ d√°n code B∆∞·ªõc 1 v√†o cu·ªëi file HTML ch∆∞a.");
        return;
    }
    
    // ƒê·∫∑t ƒë∆∞·ªùng d·∫´n file game
    frame.src = gameUrl;
    
    // Hi·ªÉn th·ªã Modal (X√≥a class hidden)
    modal.classList.remove('hidden');
    
    // T·∫°o l·∫°i icon n·∫øu c·∫ßn
    if (typeof lucide !== 'undefined') {
        lucide.createIcons();
    }
};

window.closeGameModal = function() {
    const modal = document.getElementById('gameModal');
    const frame = document.getElementById('gameFrame');
    
    if (modal) {
        modal.classList.add('hidden'); // Th√™m l·∫°i class hidden ƒë·ªÉ ·∫©n
    }
    
    if (frame) {
        frame.src = ''; // T·∫Øt game
    }
};
    </script>
<div id="gameModal" class="fixed inset-0 z-[60] hidden">
    <div class="absolute inset-0 bg-black/80 backdrop-blur-sm transition-opacity" onclick="closeGameModal()"></div>
    
    <div class="absolute inset-0 flex items-center justify-center p-0 md:p-4 h-full w-full">
        <div class="bg-white w-full h-full md:h-[100%] md:w-[500px] md:rounded-3xl shadow-2xl flex flex-col overflow-hidden relative animate-up">
            
            <div class="bg-slate-900 text-white p-3 flex justify-between items-center shrink-0 z-10 shadow-md">
                <div class="flex items-center gap-2">
                    <i data-lucide="gamepad-2" class="w-5 h-5 text-cyan-400"></i>
                    <span class="font-bold">M∆∞a H√°n T·ª±</span>
                </div>
                <button onclick="closeGameModal()" class="p-1 hover:bg-white/20 rounded-full transition-colors">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>

            <iframe id="gameFrame" src="" class="w-full h-full border-0 bg-slate-50" allow="autoplay; fullscreen"></iframe>
        </div>
    </div>
</div>
</body>
</html>