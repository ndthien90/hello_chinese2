<!DOCTYPE html>
<html lang="vi" class="scroll-smooth"> <!-- B·∫ÆT ƒê·∫¶U: Kh√¥ng c√≥ class 'dark' ban ƒë·∫ßu -->
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>H·ªçc Vi·∫øt Ch·ªØ H√°n (Tailwind)</title>
    <!-- T·∫£i Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- T·∫£i Hanzi Writer -->
    <script src="https://cdn.jsdelivr.net/npm/hanzi-writer@3.5/dist/hanzi-writer.min.js"></script>
    
    <!-- C·∫•u h√¨nh Tailwind (T√πy ch·ªçn) -->
    <script>
        tailwind.config = {
            darkMode: 'class', // B·∫≠t ch·∫ø ƒë·ªô 'class'
            theme: {
                extend: {
                    fontFamily: {
                        // Th√™m font Kaiti v√†o danh s√°ch font-['Kaiti',_sans-serif]
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                        kaiti: ['Kaiti', 'Arial', 'ÂÆã‰Ωì', 'sans-serif'],
                    },
                    // Th√™m c√°c thu·ªôc t√≠nh cho flashcard 3D
                    transitionDuration: {
                        '600': '600ms',
                    },
                    transformStyle: { // Y√™u c·∫ßu plugin, nh∆∞ng c√≥ th·ªÉ d√πng arbitrary value
                        'preserve-3d': 'preserve-3d',
                    },
                    backfaceVisibility: { // Y√™u c·∫ßu plugin, nh∆∞ng c√≥ th·ªÉ d√πng arbitrary value
                        'hidden': 'hidden',
                    }
                }
            }
        }
    </script>

    <!-- 
      Style t·ªëi gi·∫£n cho c√°c hi·ªáu ·ª©ng kh√¥ng c√≥ trong Tailwind
      (ho·∫∑c kh√≥ d√πng v·ªõi arbitrary values)
    -->
    <style>
        /* M·∫∑c d√π Tailwind c√≥ `transform-style-preserve-3d` v√† `backface-hidden`,
          vi·ªác ƒë·∫£m b·∫£o ch√∫ng ho·∫°t ƒë·ªông v·ªõi CDN c√≥ th·ªÉ kh√¥ng ·ªïn ƒë·ªãnh.
          S·ª≠ d·ª•ng arbitrary values [property:value] tr·ª±c ti·∫øp trong HTML.
        */
        
        /* ƒê·∫∑t font-family Inter l√†m m·∫∑c ƒë·ªãnh */
        body {
            font-family: 'Inter', 'system-ui', sans-serif;
        }

        /* T√πy ch·ªânh thanh cu·ªôn (T√πy ch·ªçn, kh√¥ng b·∫Øt bu·ªôc)
          S·ª≠ d·ª•ng CSS thu·∫ßn t√∫y v√¨ plugin scrollbar c·ªßa Tailwind kh√¥ng c√≥ s·∫µn qua CDN
        */
        .vocabulary-list::-webkit-scrollbar {
            width: 6px;
        }
        .vocabulary-list::-webkit-scrollbar-thumb {
            background-color: #a5b4fc; /* indigo-300 */
            border-radius: 3px;
        }
        .dark .vocabulary-list::-webkit-scrollbar-thumb {
            background-color: #6366f1; /* indigo-500 */
        }
        
        /* S·ª≠a l·ªói placeholder cho H√°n t·ª± (tr∆∞·ªõc ƒë√≥ d√πng style*="...")
          Gi·ªù ƒë√¢y ch√∫ng ta c√≥ th·ªÉ nh·∫Øm m·ª•c ti√™u t·ªët h∆°n
        */
        .placeholder-text {
            color: #9ca3af; /* gray-400 */
            width: 100%;
        }
        .dark .placeholder-text {
            color: #6b7280; /* gray-500 */
        }
        .loading-text {
             color: #6366f1; /* indigo-500 */
             text-align: center;
             margin-top: 30px;
        }
        .dark .loading-text {
            color: #a5b4fc; /* indigo-300 */
        }

        /* TH√äM M·ªöI: ƒê·∫£m b·∫£o c√°c thu·ªôc t√≠nh 3D cho Flashcard ho·∫°t ƒë·ªông */
        .flashcard-container {
            perspective: 1000px;
        }
        .flashcard {
            transform-style: preserve-3d;
            /* TH√äM M·ªöI: Chuy·ªÉn transition v√†o CSS */
            transition: transform 0.6s;
        }
        .flashcard-face {
            /* TH√äM M·ªöI: ƒê·∫£m b·∫£o c√°c thu·ªôc t√≠nh n√†y ƒë∆∞·ª£c √°p d·ª•ng */
            position: absolute;
            width: 100%;
            height: 100%;
            /* --- */
            backface-visibility: hidden;
            -webkit-backface-visibility: hidden; /* T∆∞∆°ng th√≠ch Safari */
        }
        
        /* TH√äM M·ªöI: ƒê·ªãnh nghƒ©a xoay cho m·∫∑t sau */
        .flashcard-back {
            transform: rotateY(180deg);
        }

        /* TH√äM M·ªöI: L·ªõp k√≠ch ho·∫°t l·∫≠t th·∫ª */
        .flashcard.is-flipped {
            transform: rotateY(180deg);
        }

    </style>
</head>
<!-- 
  N·ªÅn gradient cho body
  font-sans: S·ª≠ d·ª•ng font Inter ƒë√£ ƒë·ªãnh nghƒ©a
  transition-colors: Th√™m hi·ªáu ·ª©ng chuy·ªÉn m√†u m∆∞·ª£t m√†
-->
<body class="bg-gradient-to-br from-indigo-500 to-purple-700 dark:from-gray-900 dark:to-black min-h-screen p-0 md:p-2.5 flex flex-col justify-start items-center transition-colors duration-300">

    <!-- 
      Mobile Sticky Header
      md:hidden - ·∫®n tr√™n desktop (t·ª´ breakpoint 'md' tr·ªü l√™n)
      flex - Hi·ªÉn th·ªã tr√™n mobile
    -->
    <div class="flex md:hidden sticky top-0 left-0 w-full bg-gray-100 dark:bg-gray-800 p-3 md:px-4 px-3.5 border-b border-gray-200 dark:border-gray-700 z-50 shadow-md justify-between items-center">
        <h2 class="text-xl font-semibold text-gray-800 dark:text-gray-100">Luy·ªán vi·∫øt ch·ªØ H√°n</h2>
        <!-- N√∫t chuy·ªÉn theme (Mobile) -->
        <button id="themeToggleBtnMobile" class="theme-toggle-btn bg-transparent dark:bg-transparent text-gray-800 dark:text-gray-100 border-none rounded-full w-9 h-9 text-2xl cursor-pointer transition-all duration-300 flex-shrink-0 flex items-center justify-center">üåô</button>
    </div>

    <!-- 
      Container ch√≠nh
      flex-col-reverse: X·∫øp sidebar b√™n d∆∞·ªõi main content tr√™n mobile
      md:flex-row: Quay l·∫°i layout sidebar/main content tr√™n desktop
      rounded-none shadow-none: Full-screen tr√™n mobile
      md:rounded-2xl md:shadow-2xl: Bo g√≥c v√† ƒë·ªï b√≥ng tr√™n desktop
    -->
    <div class="container w-full max-w-6xl mx-auto bg-white dark:bg-gray-900 rounded-none shadow-none md:rounded-2xl md:shadow-2xl overflow-hidden flex min-h-[95vh] transition-colors duration-300 flex-col-reverse md:flex-row">
        
        <!-- START: Sidebar Navigation -->
        <!--
          w-full md:w-[300px]: Full-width tr√™n mobile, 300px tr√™n desktop
          max-h-[45vh] md:max-h-none: Gi·ªõi h·∫°n chi·ªÅu cao tr√™n mobile
        -->
        <div class="sidebar w-full md:w-[300px] bg-gray-50 dark:bg-gray-800 p-3 md:p-5 border-t md:border-t-0 md:border-r border-gray-200 dark:border-gray-700 flex-shrink-0 flex flex-col md:h-[95vh] h-auto max-h-[45vh] md:max-h-none transition-colors duration-300">
            
            <!-- 
              Sidebar Header (Desktop)
              hidden md:flex: ·∫®n tr√™n mobile, hi·ªÉn th·ªã tr√™n desktop
            -->
            <div class="sidebar-header hidden md:flex justify-between items-center mb-4 border-b-2 border-gray-300 dark:border-gray-600 pb-2.5">
                <h2 class="desktop-title text-2xl font-semibold text-gray-800 dark:text-gray-100">Luy·ªán vi·∫øt ch·ªØ H√°n</h2>
                <!-- N√∫t chuy·ªÉn theme (Desktop) -->
                <button id="themeToggleBtnDesktop" class="theme-toggle-btn bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-100 border border-gray-300 dark:border-gray-600 rounded-full w-10 h-10 text-xl cursor-pointer transition-all duration-300 flex-shrink-0 flex items-center justify-center hover:bg-gray-300 dark:hover:bg-gray-600">üåô</button>
            </div>
            
            <div class="lesson-selector mb-3 md:mb-5">
                <label for="lessonDropdown" class="hidden">Ch·ªçn b√†i</label>
                <!-- 
                  lesson-controls
                  flex md:block: X·∫øp h√†ng ngang tr√™n mobile, x·∫øp kh·ªëi tr√™n desktop
                -->
                <div class="lesson-controls flex md:block gap-1.5 items-center">
                    <select id="lessonDropdown" onchange="loadLesson()" class="w-full flex-grow p-2.5 text-base border-2 border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-100 appearance-none cursor-pointer transition-colors duration-300 focus:border-indigo-500 dark:focus:border-indigo-400 focus:outline-none">
                        <option value="bai1">B√†i 1: ËÄÅÂ∏àÊÇ®Â•ΩÔºÅ</option>
                        <option value="bai2">B√†i 2: Ë∞¢Ë∞¢‰Ω†ÔºÅ</option>
                        <option value="bai3">B√†i 3: ‰Ω†Âè´‰ªÄ‰πàÂêçÂ≠óÔºü</option>
                    </select>
                    
                    <!-- 
                      N√∫t Flashcard & Quiz
                      basis-1/4: Chi·∫øm 1/4 chi·ªÅu r·ªông tr√™n mobile
                      md:w-full: Full-width tr√™n desktop
                    -->
                    <button class="flashcard-btn w-full md:w-full flex-shrink-0 basis-1/4 md:basis-auto text-center p-2.5 text-sm md:text-base font-bold text-white border-none rounded-lg cursor-pointer md:mt-2.5 transition-colors duration-300 bg-red-500 hover:bg-red-600" onclick="startFlashcardMode()">üìöH·ªçc t·∫≠p</button>
                    <button class="quiz-btn w-full md:w-full flex-shrink-0 basis-1/4 md:basis-auto text-center p-2.5 text-sm md:text-base font-bold text-white border-none rounded-lg cursor-pointer md:mt-2.5 transition-colors duration-300 bg-emerald-500 hover:bg-emerald-600" onclick="startQuizMode()">üìãKi·ªÉm tra</button>
                </div>
            </div>

            <!-- 
              Danh s√°ch t·ª´ v·ª±ng
              S·ª≠ d·ª•ng class 'vocabulary-list' ƒë·ªÉ style thanh cu·ªôn (xem <style> ·ªü tr√™n)
            -->
            <div class="vocabulary-list flex-grow overflow-y-auto pr-1.5" id="vocabularyList">
                <p class="loading-text">
                    ƒêang t·∫£i t·ª´ v·ª±ng...
                </p>
            </div>
        </div>
        <!-- END: Sidebar Navigation -->

        <!-- START: Main Content -->
        <div class="main-content flex-grow p-3 md:p-5 flex flex-col h-auto md:h-[95vh] overflow-y-auto">
            
            <div class="manual-input-section mb-5 p-4 bg-indigo-50 dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700">
                <h3 class="text-sm font-semibold text-gray-600 dark:text-gray-400 mb-2.5"></h3>
                <!-- 
                  input-group
                  flex-col md:flex-row: X·∫øp ch·ªìng tr√™n mobile, h√†ng ngang tr√™n desktop
                -->
                <div class="input-group flex gap-2.5 flex-col md:flex-row">
                    <input type="text" id="textInput" placeholder="Nh·∫≠p ch·ªØ H√°n, t·ª´, ho·∫∑c c√¢u ƒë·ªÉ luy·ªán vi·∫øt..." class="flex-grow p-2.5 px-4 text-base border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-900 text-gray-800 dark:text-gray-100 rounded-lg transition-colors duration-300 placeholder-gray-500 dark:placeholder-gray-400 focus:border-indigo-500 dark:focus:border-indigo-400 focus:outline-none focus:ring-2 focus:ring-indigo-300 dark:focus:ring-indigo-700" />
                    <!-- 
                      N√∫t Ph√¢n t√≠ch
                      S·ª≠ d·ª•ng base-class 'control-btn' v√† c√°c l·ªõp t√πy ch·ªânh
                    -->
                    <button class="control-btn analyze-btn border-red-500 text-red-500 dark:border-red-400 dark:text-red-400 p-2.5 px-5 text-sm w-full md:w-auto hover:bg-red-500 dark:hover:bg-red-400 hover:text-white dark:hover:text-gray-900 py-2 px-4 border-2 rounded-full cursor-pointer font-bold transition-all duration-300 text-xs md:text-sm whitespace-nowrap" onclick="parseText()">Ph√¢n t√≠ch</button>
                </div>
            </div>

            <div class="characters-section p-0 mb-5">
                <h3 class="text-lg font-semibold text-gray-600 dark:text-gray-400 mb-2.5"></h3>
                <div id="charactersGrid" class="characters-grid flex gap-2.5 justify-start flex-wrap">
                    <div class="placeholder-text"></div>
                </div>
            </div>

            <!--
              Khu v·ª±c vi·∫øt
              'hidden' - L·ªõp 'hidden' c·ªßa Tailwind (display: none) ƒë∆∞·ª£c b·∫≠t/t·∫Øt b·∫±ng JS
            -->
            <div id="writerSection" class="writer-section text-center p-3 md:p-4 bg-gray-100 dark:bg-gray-800 border-t border-gray-200 dark:border-gray-700 overflow-hidden transition-all duration-400 ease-in-out relative rounded-2xl mt-auto hidden">
                <div class="writer-container inline-block p-2.5 bg-white dark:bg-gray-900 rounded-2xl shadow-xl my-2.5 mx-0 max-w-full">
                    <div id="writer" class="mx-auto max-w-full flex justify-center items-center"></div>
                    <!-- 'hidden' ƒë∆∞·ª£c b·∫≠t/t·∫Øt b·∫±ng JS -->
                    <div id="loadingMessage" class="loading text-center p-4 text-indigo-600 dark:text-indigo-400 font-bold absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-white/90 dark:bg-gray-800/90 rounded-lg shadow-lg z-10 min-w-[120px] hidden">ƒêang t·∫£i...</div>
                    <!-- 'hidden' ƒë∆∞·ª£c b·∫≠t/t·∫Øt b·∫±ng JS. C√°c l·ªõp m√†u ƒë∆∞·ª£c th√™m b·∫±ng JS -->
                    <div id="quizFeedback" class="quiz-feedback mt-4 p-2.5 rounded-lg font-bold text-sm hidden"></div>
                </div>
                <div class="controls mt-4 flex gap-2 justify-center flex-wrap">
                    <!-- Base class 'control-btn' ƒë∆∞·ª£c √°p d·ª•ng cho t·∫•t c·∫£ -->
                    <button class="control-btn py-2 px-4 border-2 border-indigo-500 dark:border-indigo-400 bg-white dark:bg-gray-800 text-indigo-500 dark:text-indigo-400 rounded-full cursor-pointer font-bold transition-all duration-300 text-xs md:text-sm whitespace-nowrap hover:bg-indigo-500 dark:hover:bg-indigo-400 hover:text-white dark:hover:text-gray-900" onclick="animateCharacter()">üé¨</button>
                    <button class="control-btn py-2 px-4 border-2 border-indigo-500 dark:border-indigo-400 bg-white dark:bg-gray-800 text-indigo-500 dark:text-indigo-400 rounded-full cursor-pointer font-bold transition-all duration-300 text-xs md:text-sm whitespace-nowrap hover:bg-indigo-500 dark:hover:bg-indigo-400 hover:text-white dark:hover:text-gray-900" onclick="showCharacter()">üëÅÔ∏è</button>
                    <button class="control-btn py-2 px-4 border-2 border-indigo-500 dark:border-indigo-400 bg-white dark:bg-gray-800 text-indigo-500 dark:text-indigo-400 rounded-full cursor-pointer font-bold transition-all duration-300 text-xs md:text-sm whitespace-nowrap hover:bg-indigo-500 dark:hover:bg-indigo-400 hover:text-white dark:hover:text-gray-900" onclick="hideCharacter()">üôà</button>
                    <button class="control-btn py-2 px-4 border-2 border-indigo-500 dark:border-indigo-400 bg-white dark:bg-gray-800 text-indigo-500 dark:text-indigo-400 rounded-full cursor-pointer font-bold transition-all duration-300 text-xs md:text-sm whitespace-nowrap hover:bg-indigo-500 dark:hover:bg-indigo-400 hover:text-white dark:hover:text-gray-900" onclick="startQuiz()">‚úçÔ∏è </button>
                    <button class="control-btn py-2 px-4 border-2 border-indigo-500 dark:border-indigo-400 bg-white dark:bg-gray-800 text-indigo-500 dark:text-indigo-400 rounded-full cursor-pointer font-bold transition-all duration-300 text-xs md:text-sm whitespace-nowrap hover:bg-indigo-500 dark:hover:bg-indigo-400 hover:text-white dark:hover:text-gray-900 hidden" onclick="cancelQuiz()" id="cancelBtn">‚ùå H·ªßy luy·ªán</button>
                </div>
            </div>
        </div>
        <!-- END: Main Content -->

    </div>
    
    <!-- === START: FLASHCARD MODAL === -->
    <!-- 'hidden' thay v√¨ 'style="display: none;"' -->
    <div id="flashcardModal" class="flashcard-modal fixed top-0 left-0 w-full h-[100dvh] bg-black/80 dark:bg-black/85 backdrop-blur-sm z-[200] flex flex-col justify-center items-center p-2.5 hidden">
        <button class="modal-close-btn absolute top-4 right-4 text-4xl text-white dark:text-gray-200 bg-transparent border-none cursor-pointer leading-none" onclick="closeFlashcardMode()">&times;</button>
        
        <div id="flashcardCounter" class="flashcard-counter text-white dark:text-gray-100 text-lg mb-5">Th·∫ª 1 / 10</div>
        
        <!-- THAY ƒê·ªîI: X√≥a [perspective:1000px] -->
        <div class="flashcard-container w-full max-w-lg mb-5">
            <!-- 
              L·ªõp 'is-flipped' ƒë√£ b·ªã lo·∫°i b·ªè. 
              JS s·∫Ω th√™m/x√≥a l·ªõp 'rotate-y-180' c·ªßa Tailwind.
            -->
            <!-- THAY ƒê·ªîI: X√≥a [transform-style:preserve-3d] -->
            <!-- THAY ƒê·ªîI: X√≥a transition-transform duration-600 -->
            <div id="flashcard" class="flashcard w-full aspect-video relative cursor-pointer" onclick="flipFlashcard()">
                <!-- M·∫∑t tr∆∞·ªõc -->
                <!-- THAY ƒê·ªîI: X√≥a [backface-visibility:hidden] -->
                <div class="flashcard-face flashcard-front absolute w-full h-full flex flex-col justify-center items-center bg-white dark:bg-gray-800 rounded-2xl shadow-xl p-5 overflow-y-auto">
                    <div id="flashcardWord" class="flashcard-word text-6xl sm:text-9xl text-red-500 dark:text-red-400 font-kaiti">‰Ω†Â•Ω</div>
                </div>
                <!-- M·∫∑t sau -->
                <!-- THAY ƒê·ªîI: X√≥a [backface-visibility:hidden] -->
                <!-- THAY ƒê·ªîI: X√≥a rotate-y-180 -->
                <div class="flashcard-face flashcard-back absolute w-full h-full flex flex-col justify-center items-center bg-white dark:bg-gray-800 rounded-2xl shadow-xl p-5 overflow-y-auto gap-4">
                    <div id="flashcardPinyin" class="flashcard-pinyin text-3xl sm:text-4xl text-purple-600 dark:text-purple-400 italic">n«ê h«éo</div>
                    <div id="flashcardMeaning" class="flashcard-meaning text-2xl sm:text-3xl text-gray-800 dark:text-gray-100 text-center">Xin ch√†o</div>
                </div>
            </div>
        </div>
        
        <div class="flashcard-nav flex justify-around items-center w-full max-w-lg">
            <!-- 
              N√∫t ƒëi·ªÅu h∆∞·ªõng flashcard
              'disabled:' - Style c·ªßa Tailwind cho tr·∫°ng th√°i disabled
            -->
            <button id="flashcardPrevBtn" class="flashcard-nav-btn py-3 px-5 text-base font-bold text-indigo-600 dark:text-indigo-300 bg-white dark:bg-gray-700 border border-indigo-400 dark:border-indigo-500 rounded-2xl cursor-pointer transition-all duration-300 basis-[30%] text-center hover:bg-indigo-50 dark:hover:bg-gray-600 disabled:bg-gray-300 dark:disabled:bg-gray-500 disabled:text-gray-500 dark:disabled:text-gray-400 disabled:cursor-not-allowed" onclick="prevFlashcard()">Tr∆∞·ªõc</button>
            <!-- 
              !bg-red-500 - '!' ƒë·ªÉ ∆∞u ti√™n (override) l·ªõp base
            -->
            <button id="flashcardRandomBtn" class="flashcard-nav-btn py-3 px-5 text-base font-bold rounded-2xl cursor-pointer transition-all duration-300 basis-[30%] text-center hover:bg-indigo-50 dark:hover:bg-gray-600 disabled:bg-gray-300 dark:disabled:bg-gray-500 disabled:text-gray-500 dark:disabled:text-gray-400 disabled:cursor-not-allowed !bg-red-500 !text-white !border-red-500 hover:!bg-red-600" onclick="randomFlashcard()">Ng·∫´u nhi√™n</button>
            <button id="flashcardNextBtn" class="flashcard-nav-btn py-3 px-5 text-base font-bold text-indigo-600 dark:text-indigo-300 bg-white dark:bg-gray-700 border border-indigo-400 dark:border-indigo-500 rounded-2xl cursor-pointer transition-all duration-300 basis-[30%] text-center hover:bg-indigo-50 dark:hover:bg-gray-600 disabled:bg-gray-300 dark:disabled:bg-gray-500 disabled:text-gray-500 dark:disabled:text-gray-400 disabled:cursor-not-allowed" onclick="nextFlashcard()">Sau</button>
        </div>
    </div>
    <!-- === END: FLASHCARD MODAL === -->

    <!-- === START: QUIZ MODAL === -->
    <div id="quizModal" class="quiz-modal fixed top-0 left-0 w-full h-[100dvh] bg-gray-100 dark:bg-gray-900 z-[200] flex flex-col justify-start items-center p-2.5 pt-16 hidden">
        <!-- N√∫t ƒë√≥ng '!' ƒë·ªÉ ∆∞u ti√™n m√†u -->
        <button class="modal-close-btn absolute top-4 right-4 text-4xl bg-transparent border-none cursor-pointer leading-none !text-gray-500 dark:!text-gray-400" onclick="closeQuizMode()">&times;</button>
        
        <div class="quiz-container w-full max-w-3xl flex flex-col flex-grow">
            <!-- Ph·∫ßn hi·ªÉn th·ªã c√¢u h·ªèi -->
            <div id="quizQuestionArea">
                <div class="quiz-progress w-full h-2.5 bg-gray-300 dark:bg-gray-700 rounded-full overflow-hidden mb-2.5">
                    <div id="quizProgressBar" class="w-0 h-full bg-emerald-500 transition-all duration-300 ease-linear"></div>
                </div>
                <div id="quizCounter" class="text-sm font-bold text-gray-600 dark:text-gray-400 mb-5 text-center">C√¢u 1 / 10</div>
                <div id="quizQuestionWord" class="text-6xl sm:text-7xl text-red-500 dark:text-red-400 font-kaiti text-center mb-1.5 bg-white dark:bg-gray-800 p-5 rounded-2xl shadow-lg">‰Ω†Â•Ω</div>
                <div id="quizQuestionPinyin" class="quiz-question-pinyin text-xl sm:text-2xl text-purple-600 dark:text-purple-400 italic text-center mb-5">n«ê h«éo</div>
                
                <!-- 
                  L∆∞·ªõi ƒë√°p √°n
                  grid-cols-1 md:grid-cols-2: 1 c·ªôt tr√™n mobile, 2 c·ªôt tr√™n desktop
                -->
                <div id="quizAnswerOptions" class="grid grid-cols-1 md:grid-cols-2 gap-4 w-full">
                    <!-- C√°c n√∫t ƒë√°p √°n s·∫Ω ƒë∆∞·ª£c ch√®n v√†o ƒë√¢y b·ªüi JS -->
                </div>
            </div>
            
            <!-- 
              Ph·∫ßn hi·ªÉn th·ªã k·∫øt qu·∫£
              'hidden' ƒë∆∞·ª£c b·∫≠t/t·∫Øt b·∫±ng JS
            -->
            <div id="quizResultScreen" class="flex-col justify-center items-center text-center p-5 flex-grow hidden">
                <h2 class="text-4xl font-bold text-gray-800 dark:text-gray-100 mb-4">Ho√†n th√†nh!</h2>
                <div id="quizResultScore" class="text-xl text-gray-600 dark:text-gray-400 mb-8">B·∫°n ƒë√£ tr·∫£ l·ªùi ƒë√∫ng 8 / 10 c√¢u!</div>
                <button class="quiz-restart-btn py-4 px-8 text-lg font-bold text-white bg-indigo-600 dark:bg-indigo-500 border-none rounded-full cursor-pointer hover:bg-indigo-700" onclick="startQuizMode()">L√†m l·∫°i</button>
            </div>
        </div>
    </div>
    <!-- === END: QUIZ MODAL === -->


    <script>
        // Global state variables
        let currentWriter = null;
        let currentCharacter = '';
        let characters = [];
        let isQuizMode = false;
        let isInitialized = false;
        let allLessonsData = {};

        // Flashcard state
        let lessonFlashcards = [];
        let currentFlashcardIndex = 0;
        
        // === NEW: Quiz state ===
        let quizQuestions = [];
        let currentQuizQuestionIndex = 0;
        let quizScore = 0;
        let quizInProgress = false;
        
        // === START: LOGIC CH·∫æ ƒê·ªò S√ÅNG/T·ªêI (ƒê√É C·∫¨P NH·∫¨T CHO TAILWIND) ===
        const themeToggleBtnDesktop = document.getElementById('themeToggleBtnDesktop');
        const themeToggleBtnMobile = document.getElementById('themeToggleBtnMobile');
        const htmlElement = document.documentElement; // D√πng th·∫ª <html>

        /**
         * ƒê·∫∑t theme cho ·ª©ng d·ª•ng (light ho·∫∑c dark)
         * @param {'light' | 'dark'} theme
         */
        function setAppTheme(theme) {
            // THAY ƒê·ªîI: Hardcode m√†u cho HanziWriter
            let newStrokeColor;
            
            if (theme === 'dark') {
                htmlElement.classList.add('dark');
                if (themeToggleBtnDesktop) themeToggleBtnDesktop.textContent = '‚òÄÔ∏è';
                if (themeToggleBtnMobile) themeToggleBtnMobile.textContent = '‚òÄÔ∏è';
                localStorage.setItem('theme', 'dark');
                // M√†u stroke cho dark mode (t·ª´ CSS g·ªëc)
                newStrokeColor = '#fcf803';
            } else {
                htmlElement.classList.remove('dark');
                if (themeToggleBtnDesktop) themeToggleBtnDesktop.textContent = 'üåô';
                if (themeToggleBtnMobile) themeToggleBtnMobile.textContent = 'üåô';
                localStorage.setItem('theme', 'light');
                // M√†u stroke cho light mode (t·ª´ CSS g·ªëc)
                newStrokeColor = '#555';
            }
            
            // C·∫≠p nh·∫≠t m√†u c·ªßa HanziWriter n·∫øu n√≥ ƒëang t·ªìn t·∫°i
            if (currentWriter) {
                try {
                    currentWriter.updateColor('strokeColor', newStrokeColor);
                } catch (e) {
                    console.error("L·ªói c·∫≠p nh·∫≠t m√†u HanziWriter:", e);
                }
            }
        }

        /**
         * Chuy·ªÉn ƒë·ªïi gi·ªØa 2 ch·∫ø ƒë·ªô
         */
        function toggleTheme() {
            const currentTheme = htmlElement.classList.contains('dark') ? 'dark' : 'light';
            setAppTheme(currentTheme === 'dark' ? 'light' : 'dark');
        }

        /**
         * √Åp d·ª•ng theme ban ƒë·∫ßu khi t·∫£i trang (∆∞u ti√™n localStorage, sau ƒë√≥ ƒë·∫øn h·ªá th·ªëng)
         */
        function applyInitialTheme() {
            const savedTheme = localStorage.getItem('theme');
            const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            
            if (savedTheme) {
                setAppTheme(savedTheme);
            } else if (prefersDark) {
                setAppTheme('dark');
            } else {
                setAppTheme('light'); // M·∫∑c ƒë·ªãnh l√† s√°ng
            }
        }
        // === END: LOGIC CH·∫æ ƒê·ªò S√ÅNG/T·ªêI ===


        async function fetchLessonData(lessonKey) {
            // Gi·∫£ s·ª≠ c√°c t·ªáp data n·∫±m trong m·ªôt th∆∞ m·ª•c 'data_chineseStroke'
            // B·∫°n c·∫ßn ƒë·∫£m b·∫£o ƒë∆∞·ªùng d·∫´n n√†y ƒë√∫ng
            const filePath = `data_chineseStroke/${lessonKey}.txt`;
            try {
                const response = await fetch(filePath);
                if (!response.ok) throw new Error(`Kh√¥ng th·ªÉ t·∫£i t·ªáp: ${response.statusText}`);
                const textData = await response.text();
                const parsedData = textData.split('\n')
                    .map(line => line.trim())
                    .filter(line => line.length > 0 && line.includes('|'))
                    .map(line => {
                        const parts = line.split('|');
                        if (parts.length >= 3) { 
                            return { word: parts[0], pinyin: parts[1], meaning: parts[2] };
                        }
                        return null;
                    })
                    .filter(item => item !== null);
                return parsedData;
            } catch (error) {
                console.error(`L·ªói khi t·∫£i b√†i h·ªçc ${lessonKey}:`, error);
                // THAY ƒê·ªîI: X√≥a b·ªè d·ªØ li·ªáu c·ª©ng, ch·ªâ tr·∫£ v·ªÅ m·∫£ng r·ªóng n·∫øu c√≥ l·ªói
                 return [];
            }
        }
        
        // --- Speech Synthesis ---
        const synth = window.speechSynthesis;
        let chineseVoice = null;
        function getChineseVoice() {
            if (chineseVoice) return;
            const voices = synth.getVoices();
            chineseVoice = voices.find(v => v.lang.startsWith('zh-') || v.lang.startsWith('cmn-')) ||
                           voices.find(v => v.name.includes('Chinese') || v.name.includes('Mandarin'));
            if (!chineseVoice) console.warn("Kh√¥ng t√¨m th·∫•y gi·ªçng ti·∫øng Trung.");
        }
        if (synth.onvoiceschanged !== undefined) synth.onvoiceschanged = getChineseVoice;
        getChineseVoice();

        function speakWord(text) {
            if (!synth) return;
            synth.cancel(); 
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'zh-CN'; 
            if (chineseVoice) utterance.voice = chineseVoice;
            utterance.rate = 0.9;
            synth.speak(utterance);
        }

        // --- Core Functions ---
        window.onload = function() {
            console.log('App initialized');
            
            // --- G·∫Øn s·ª± ki·ªán v√† √°p d·ª•ng theme ---
            if (themeToggleBtnDesktop) themeToggleBtnDesktop.addEventListener('click', toggleTheme);
            if (themeToggleBtnMobile) themeToggleBtnMobile.addEventListener('click', toggleTheme);
            applyInitialTheme(); // √Åp d·ª•ng theme ngay khi DOM s·∫µn s√†ng
            
            loadLesson();
            document.getElementById('textInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') parseText();
            });
        };
        
        async function loadLesson() {
            const dropdown = document.getElementById('lessonDropdown');
            const lessonKey = dropdown.value;
            const vocabListDiv = document.getElementById('vocabularyList');
            vocabListDiv.innerHTML = '<p class="loading-text">ƒêang t·∫£i...</p>';
            
            try {
                const lessonData = await fetchLessonData(lessonKey);
                allLessonsData[lessonKey] = lessonData; // Cache d·ªØ li·ªáu
                displayVocabulary(lessonData);
                resetWritingArea(); 
            } catch (error) {
                vocabListDiv.innerHTML = `<p class="text-red-500">L·ªói t·∫£i d·ªØ li·ªáu: ${error.message}</p>`;
            }
        }

        function displayVocabulary(vocabList) {
            const vocabListDiv = document.getElementById('vocabularyList');
            vocabListDiv.innerHTML = ''; 
            if (vocabList.length === 0) {
                vocabListDiv.innerHTML = '<p class="placeholder-text text-center mt-8">B√†i h·ªçc n√†y ch∆∞a c√≥ t·ª´ v·ª±ng.</p>';
                return;
            }
            vocabList.forEach(item => {
                const itemElement = document.createElement('div');
                // THAY ƒê·ªîI: S·ª≠ d·ª•ng l·ªõp Tailwind
                itemElement.className = 'vocab-item flex items-center p-2 md:p-2.5 mb-2 bg-white dark:bg-gray-700 rounded-xl shadow-md cursor-pointer transition-all duration-300 flex-wrap hover:bg-indigo-50 dark:hover:bg-gray-600 hover:-translate-y-0.5 hover:shadow-lg';
                itemElement.dataset.word = item.word;
                itemElement.onclick = () => selectWord(item, itemElement);
                
                // THAY ƒê·ªîI: S·ª≠ d·ª•ng l·ªõp Tailwind
                itemElement.innerHTML = `
                    <div class="vocab-word text-3xl md:text-3xl text-red-500 dark:text-red-400 mr-2.5 font-kaiti whitespace-nowrap">${item.word}</div>
                    <div class="vocab-details flex-grow flex flex-wrap items-baseline">
                        <div class="vocab-pinyin text-lg md:text-lg text-purple-600 dark:text-purple-400 italic mr-2">${item.pinyin}</div>
                        <div class="vocab-meaning text-lg md:text-lg text-gray-600 dark:text-gray-400 mt-0.5 md:mt-0">${item.meaning}</div>
                    </div>
                `;
                vocabListDiv.appendChild(itemElement);
            });
        }
        
        function processCharacterSelection(word, pinyin) {
            characters = word.split('').filter(char => /[\u4e00-\u9fff\u3400-\u4dbf\uf900-\ufaff]/.test(char));
            displayCharacters(characters);
            if (characters.length > 0) {
                const firstElement = document.querySelector(`#charactersGrid .character-item:first-child`);
                if (firstElement) showCharacterWriter(characters[0], firstElement);
            } else {
                resetWritingArea(false); 
                document.getElementById('charactersGrid').innerHTML = '<div class="placeholder-text">Kh√¥ng t√¨m th·∫•y H√°n t·ª± ƒë·ªÉ luy·ªán vi·∫øt.</div>';
            }
        }

        function selectWord(vocabItem, element) {
            speakWord(vocabItem.word);
            document.getElementById('textInput').value = ''; 
            
            // THAY ƒê·ªîI: S·ª≠ d·ª•ng c√°c l·ªõp Tailwind cho tr·∫°ng th√°i 'active'
            const activeClasses = ['bg-red-100', 'border', 'border-red-400', 'dark:bg-red-900', 'dark:border-red-600'];
            const isAlreadyActive = element.classList.contains('bg-red-100'); // Ch·ªâ c·∫ßn ki·ªÉm tra m·ªôt l·ªõp
            
            // X√≥a 'active' kh·ªèi t·∫•t c·∫£
            document.querySelectorAll('.vocab-item').forEach(item => item.classList.remove(...activeClasses));
            // --- K·∫øt th√∫c thay ƒë·ªïi ---

            if (window.innerWidth <= 768) {
                document.querySelectorAll('.char-sub-grid').forEach(grid => grid.remove());
                document.getElementById('charactersGrid').innerHTML = '<div class="placeholder-text"></div>';
                document.getElementById('writerSection').classList.add('hidden');

                if (!isAlreadyActive) {
                    // THAY ƒê·ªîI: Th√™m c√°c l·ªõp 'active'
                    element.classList.add(...activeClasses);
                    const chars = vocabItem.word.split('').filter(char => /[\u4e00-\u9fff\u3400-\u4dbf\uf900-\ufaff]/.test(char));
                    if (chars.length === 1) {
                        showCharacterWriter(chars[0], null); 
                    } else if (chars.length > 1) {
                        displayCharactersInRow(chars, element);
                        const firstSubCharElement = element.querySelector('.sub-char-item');
                        if (firstSubCharElement) showCharacterWriter(chars[0], firstSubCharElement);
                    }
                }
            } else {
                 if (!isAlreadyActive) {
                    element.classList.add(...activeClasses);
                } else {
                    // N·∫øu click l·∫°i, ch·ªâ c·∫ßn b·ªè active, kh√¥ng c·∫ßn x·ª≠ l√Ω th√™m
                    resetWritingArea(false);
                    return;
                }
                processCharacterSelection(vocabItem.word, vocabItem.pinyin);
            }
        }

        function parseText() {
            // THAY ƒê·ªîI: X√≥a l·ªõp 'active' c·ªßa Tailwind
            const activeClasses = ['bg-red-100', 'border', 'border-red-400', 'dark:bg-red-900', 'dark:border-red-600'];
            document.querySelectorAll('.vocab-item').forEach(item => item.classList.remove(...activeClasses));
            // --- K·∫øt th√∫c thay ƒë·ªïi ---
            
            document.querySelectorAll('.char-sub-grid').forEach(grid => grid.remove());
            const word = document.getElementById('textInput').value.trim();
            if (!word) {
                showQuizFeedback('Vui l√≤ng nh·∫≠p ch·ªØ H√°n ho·∫∑c t·ª´ ƒë·ªÉ ph√¢n t√≠ch.', 'mistake');
                resetWritingArea(false); 
                return;
            }
            processCharacterSelection(word, 't·ª± nh·∫≠p');
            hideQuizFeedback();
        }

        function displayCharacters(charList) {
            const grid = document.getElementById('charactersGrid');
            grid.innerHTML = '';
            if (charList.length === 0) {
                grid.innerHTML = '<div class="placeholder-text">T·ª´ v·ª±ng n√†y kh√¥ng ch·ª©a H√°n t·ª±.</div>';
                return;
            }
            charList.forEach(char => {
                const charElement = document.createElement('div');
                // THAY ƒê·ªîI: S·ª≠ d·ª•ng l·ªõp Tailwind
                charElement.className = "character-item w-14 h-14 md:w-[70px] md:h-[70px] bg-gradient-to-br from-indigo-500 to-purple-600 text-white flex items-center justify-center text-3xl md:text-4xl rounded-xl cursor-pointer transition-all duration-300 shadow-lg hover:-translate-y-1 hover:scale-105 hover:shadow-indigo-300 dark:hover:shadow-indigo-800 relative overflow-hidden font-kaiti";
                charElement.textContent = char;
                charElement.onclick = () => showCharacterWriter(char, charElement);
                grid.appendChild(charElement);
            });
        }
        
        function displayCharactersInRow(charList, element) {
            if (charList.length === 0) return;
            const subGrid = document.createElement('div');
            // THAY ƒê·ªîI: S·ª≠ d·ª•ng l·ªõp Tailwind
            subGrid.className = 'char-sub-grid flex flex-wrap gap-2 w-full p-2.5 mt-2 border-t border-gray-200 dark:border-gray-700';
            charList.forEach(char => {
                const charBtn = document.createElement('div');
                // THAY ƒê·ªîI: S·ª≠ d·ª•ng l·ªõp Tailwind
                charBtn.className = "sub-char-item w-11 h-11 bg-indigo-500 text-white flex items-center justify-center text-2xl rounded-lg cursor-pointer transition-all duration-300 font-kaiti hover:bg-red-500 hover:scale-105";
                charBtn.textContent = char;
                charBtn.onclick = (e) => {
                    e.stopPropagation();
                    showCharacterWriter(char, charBtn);
                };
                subGrid.appendChild(charBtn);
            });
            element.appendChild(subGrid);
        }

        // THAY ƒê·ªîI: C·∫≠p nh·∫≠t h√†m ƒë·ªÉ d√πng l·ªõp Tailwind cho SVG
        function initializeSVG(containerId, size) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
            const svgId = containerId + '-svg';
            svg.setAttribute('width', size);
            svg.setAttribute('height', size);
            svg.setAttribute('id', svgId);
            // THAY ƒê·ªîI: S·ª≠ d·ª•ng l·ªõp Tailwind
            svg.setAttribute('class', 'border border-gray-300 dark:border-gray-600 transition-colors duration-300');
            
            const lines = [
                { x1: 0, y1: 0, x2: size, y2: size }, { x1: size, y1: 0, x2: 0, y2: size },
                { x1: size/2, y1: 0, x2: size/2, y2: size }, { x1: 0, y1: size/2, x2: size, y2: size/2 }
            ];
            lines.forEach((lineData, index) => {
                const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                line.setAttribute('x1', lineData.x1); line.setAttribute('y1', lineData.y1);
                line.setAttribute('x2', lineData.x2); line.setAttribute('y2', lineData.y2);
                // THAY ƒê·ªîI: S·ª≠ d·ª•ng l·ªõp Tailwind
                const lineClass = index < 2 ? 'stroke-gray-200 dark:stroke-gray-700' : 'stroke-gray-300 dark:stroke-gray-600';
                line.setAttribute('class', `${lineClass} transition-colors duration-300`);
                line.setAttribute('stroke-dasharray', '5,5');
                svg.appendChild(line);
            });
            container.appendChild(svg);
            return svgId;
        }

        async function showCharacterWriter(character, element) {
            // THAY ƒê·ªîI: L·ªõp 'active' cho H√°n t·ª±
            const activeClasses = ['!bg-gradient-to-br', '!from-red-500', '!to-yellow-500', 'shadow-lg', 'shadow-red-300', 'dark:shadow-red-800'];
            const subActiveClasses = ['!bg-red-500', 'scale-105'];
            
            document.querySelectorAll('.character-item, .sub-char-item').forEach(item => {
                item.classList.remove(...activeClasses, ...subActiveClasses);
            });
            if (element) {
                // √Åp d·ª•ng ƒë√∫ng l·ªõp active
                const classes = element.classList.contains('sub-char-item') ? subActiveClasses : activeClasses;
                element.classList.add(...classes);
            }
            // --- K·∫øt th√∫c thay ƒë·ªïi ---

            if (!character) {
                document.getElementById('writerSection').classList.add('hidden');
                return;
            }

            const writerSection = document.getElementById('writerSection');
            writerSection.classList.remove('hidden');

            if (window.innerWidth <= 768) {
                setTimeout(() => writerSection.scrollIntoView({ behavior: 'smooth', block: 'nearest' }), 150);
            }

            hideQuizFeedback();
            document.getElementById('cancelBtn').classList.add('hidden');
            isQuizMode = false;
            currentCharacter = character;

            try {
                showLoadingMessage();
                const writerDiv = document.getElementById('writer');
                let writerSize;
                if (window.innerWidth <= 768) {
                    const writerContainer = writerDiv.parentElement;
                    const containerPadding = parseFloat(getComputedStyle(writerContainer).paddingLeft) * 2;
                    let availableWidth = writerContainer.offsetWidth - containerPadding;
                    writerSize = Math.max(240, Math.min(availableWidth, 350));
                } else {
                    writerSize = 280;
                }
                writerDiv.style.width = `${writerSize}px`;
                writerDiv.style.height = `${writerSize}px`;
                const svgId = initializeSVG('writer', writerSize);
                if (currentWriter) currentWriter = null; 
                currentWriter = await createWriter(svgId, character, writerSize);
                isInitialized = true; 
                hideLoadingMessage();
                setTimeout(() => {
                    if (currentWriter && !isQuizMode) currentWriter.animateCharacter();
                }, 200);
            } catch (error) {
                console.error('Error handling character:', error);
                hideLoadingMessage();
                showQuizFeedback(`L·ªói khi t·∫£i H√°n t·ª± "${character}".`, 'mistake');
            }
        }

        // THAY ƒê·ªîI: C·∫≠p nh·∫≠t h√†m ƒë·ªÉ d√πng m√†u ƒë·ªông (hardcoded)
        async function createWriter(svgId, character, size) {
            return new Promise((resolve, reject) => {
                // X√°c ƒë·ªãnh m√†u stroke d·ª±a tr√™n theme hi·ªán t·∫°i
                const isDark = document.documentElement.classList.contains('dark');
                // Hardcode m√†u (t·ª´ CSS g·ªëc)
                const strokeColor = isDark ? '#fcf803' : '#555';

                const writer = HanziWriter.create(svgId, character, {
                    width: size, height: size, padding: 20,
                    strokeColor: strokeColor, // D√ôNG M√ÄU ƒê·ªòNG
                    strokeAnimationSpeed: 1, delayBetweenStrokes: 500,
                    showOutline: true, showCharacter: true,
                    onLoadCharDataSuccess: (data) => resolve(writer),
                    onLoadCharDataError: (reason) => reject(new Error(`HanziWriter failed to load ${character}`))
                });
            });
        }
        
        function resetWritingArea(clearInput = true) {
             const textInput = document.getElementById('textInput');
             if (clearInput && textInput) { textInput.value = ''; }
             const charactersGrid = document.getElementById('charactersGrid');
             if (charactersGrid) charactersGrid.innerHTML = '<div class="placeholder-text"></div>';
             const writerSection = document.getElementById('writerSection');
             if (writerSection) writerSection.classList.add('hidden');
             isInitialized = false;
             currentCharacter = '';
             
             // THAY ƒê·ªîI: X√≥a l·ªõp active c·ªßa Tailwind
             const activeClasses = ['bg-red-100', 'border', 'border-red-400', 'dark:bg-red-900', 'dark:border-red-600'];
             document.querySelectorAll('.vocab-item').forEach(item => item.classList.remove(...activeClasses));
             // --- K·∫øt th√∫c thay ƒë·ªïi ---

             document.querySelectorAll('.char-sub-grid').forEach(grid => grid.remove());
             const writerDiv = document.getElementById('writer');
             if (writerDiv) writerDiv.innerHTML = '';
             currentWriter = null;
             hideQuizFeedback();
        }

        // --- Control Functions ---
        function animateCharacter() {
            if (currentWriter) {
                currentWriter.animateCharacter();
                hideQuizFeedback();
            } else {
                showQuizFeedback('Vui l√≤ng ch·ªçn m·ªôt H√°n t·ª± ƒë·ªÉ luy·ªán vi·∫øt tr∆∞·ªõc.', 'mistake');
            }
        }
        function showCharacter() { if (currentWriter) currentWriter.showCharacter(); hideQuizFeedback(); }
        function hideCharacter() { if (currentWriter) currentWriter.hideCharacter(); hideQuizFeedback(); }
        
        function startQuiz() {
            if (!currentWriter) {
                showQuizFeedback('Vui l√≤ng ch·ªçn m·ªôt H√°n t·ª± ƒë·ªÉ luy·ªán vi·∫øt tr∆∞·ªõc.', 'mistake'); return;
            }
            isQuizMode = true;
            hideQuizFeedback();
            document.getElementById('cancelBtn').classList.remove('hidden');
            currentWriter.quiz({
                onComplete: (d) => {
                    isQuizMode = false;
                    document.getElementById('cancelBtn').classList.add('hidden');
                },
                showHintAfterMisses: 3, highlightOnComplete: true
            });
        }
        function cancelQuiz() {
            if (currentWriter && isQuizMode) {
                currentWriter.cancelQuiz();
                isQuizMode = false;
                document.getElementById('cancelBtn').classList.add('hidden');
                hideQuizFeedback();
            }
        }

        // --- UI Helper Functions ---
        function showLoadingMessage() { document.getElementById('loadingMessage').classList.remove('hidden'); }
        function hideLoadingMessage() { document.getElementById('loadingMessage').classList.add('hidden'); }
        
        // THAY ƒê·ªîI: S·ª≠ d·ª•ng l·ªõp Tailwind cho feedback
        function showQuizFeedback(message, type) {
            const feedback = document.getElementById('quizFeedback');
            if (!feedback) return;
            
            // ƒê·∫∑t l·∫°i c√°c l·ªõp base
            feedback.className = 'quiz-feedback mt-4 p-2.5 rounded-lg font-bold text-sm';
            feedback.textContent = message;

            if (type === 'correct') {
                feedback.classList.add('bg-green-100', 'text-green-800', 'border', 'border-green-300', 'dark:bg-green-900', 'dark:text-green-200', 'dark:border-green-700');
            } else if (type === 'mistake') {
                feedback.classList.add('bg-red-100', 'text-red-800', 'border', 'border-red-300', 'dark:bg-red-900', 'dark:text-red-200', 'dark:border-red-700');
            } else if (type === 'complete') {
                 feedback.classList.add('bg-blue-100', 'text-blue-800', 'border', 'border-blue-300', 'dark:bg-blue-900', 'dark:text-blue-200', 'dark:border-blue-700');
            }

            feedback.classList.remove('hidden');
            
            if (type === 'correct') {
                setTimeout(() => {
                    if (feedback.textContent === message) hideQuizFeedback();
                }, 1500);
            }
        }
        function hideQuizFeedback() {
            const feedback = document.getElementById('quizFeedback');
            if (feedback) { feedback.classList.add('hidden'); }
        }

        // --- Resize Handler ---
        window.addEventListener('resize', function() {
            if (currentWriter && currentCharacter && isInitialized) {
                const writerDiv = document.getElementById('writer');
                let newSize;
                if (window.innerWidth <= 768) {
                    const writerContainer = writerDiv.parentElement;
                    const containerPadding = parseFloat(getComputedStyle(writerContainer).paddingLeft) * 2;
                    let availableWidth = writerContainer.offsetWidth - containerPadding;
                    newSize = Math.max(240, Math.min(availableWidth, 350));
                } else {
                    newSize = 280;
                }
                const currentSVG = document.querySelector('#writer-svg');
                if (currentSVG && currentSVG.getAttribute('width') !== newSize.toString()) {
                    isInitialized = false;
                    setTimeout(() => {
                        // THAY ƒê·ªîI: T√¨m H√°n t·ª± active b·∫±ng l·ªõp Tailwind
                        const activeHanzi = document.querySelector('.character-item.\\!bg-gradient-to-br') || 
                                              document.querySelector('.sub-char-item.\\!bg-red-500');
                        const activeVocab = document.querySelector('.vocab-item.bg-red-100');
                        // --- K·∫øt th√∫c thay ƒë·ªïi ---

                        if (activeHanzi) {
                            showCharacterWriter(currentCharacter, activeHanzi);
                        } else if (activeVocab) {
                            showCharacterWriter(currentCharacter, null);
                        }
                    }, 100);
                }
            }
        });
        
        // === START: FLASHCARD FUNCTIONS ===
        
        function startFlashcardMode() {
            const lessonKey = document.getElementById('lessonDropdown').value;
            const vocabData = allLessonsData[lessonKey]; // L·∫•y d·ªØ li·ªáu g·ªëc
            
            if (!vocabData || vocabData.length === 0) {
                alert("Kh√¥ng c√≥ t·ª´ v·ª±ng n√†o ƒë·ªÉ h·ªçc."); return;
            }

            // THAY ƒê·ªîI: T·∫°o m·ªôt b·∫£n sao c·ªßa m·∫£ng
            // ƒêi·ªÅu n√†y ƒë·∫£m b·∫£o m·∫£ng g·ªëc trong cache (allLessonsData) kh√¥ng b·ªã thay ƒë·ªïi
            // v√† danh s√°ch s·∫Ω theo ƒë√∫ng th·ª© t·ª±
            lessonFlashcards = [...vocabData]; 
            
            // ƒê√É X√ìA: V√≤ng l·∫∑p for x√°o tr·ªôn m·∫£ng (Fisher-Yates shuffle) ƒë√£ b·ªã x√≥a kh·ªèi ƒë√¢y
            
            currentFlashcardIndex = 0; // Lu√¥n b·∫Øt ƒë·∫ßu t·ª´ 0
            
            // THAY ƒê·ªîI: S·ª≠ d·ª•ng 'hidden'
            document.getElementById('flashcardModal').classList.remove('hidden');
            document.getElementById('flashcardModal').classList.add('flex'); // ƒê·∫£m b·∫£o n√≥ l√† flex
            showFlashcard(currentFlashcardIndex, true);
        }
        
        function closeFlashcardMode() {
            // THAY ƒê·ªîI: S·ª≠ d·ª•ng 'hidden'
            document.getElementById('flashcardModal').classList.add('hidden');
            document.getElementById('flashcardModal').classList.remove('flex');
        }
        
        function flipFlashcard() {
            // THAY ƒê·ªîI: B·∫≠t/t·∫Øt l·ªõp 'is-flipped' (CSS) thay v√¨ 'rotate-y-180' (Tailwind)
            document.getElementById('flashcard').classList.toggle('is-flipped');
        }
        
        function showFlashcard(index, autoSpeak = false) {
            if (index < 0 || index >= lessonFlashcards.length) return;
            currentFlashcardIndex = index;
            const cardData = lessonFlashcards[index];
            document.getElementById('flashcardWord').textContent = cardData.word;
            document.getElementById('flashcardPinyin').textContent = cardData.pinyin;
            document.getElementById('flashcardMeaning').textContent = cardData.meaning;
            document.getElementById('flashcardCounter').textContent = `Th·∫ª ${index + 1} / ${lessonFlashcards.length}`;
            // THAY ƒê·ªîI: ƒê·∫£m b·∫£o th·∫ª lu√¥n l·∫≠t v·ªÅ m·∫∑t tr∆∞·ªõc (d√πng l·ªõp .is-flipped)
            document.getElementById('flashcard').classList.remove('is-flipped');
            
            document.getElementById('flashcardPrevBtn').disabled = (index === 0);
            document.getElementById('flashcardNextBtn').disabled = (index === lessonFlashcards.length - 1);
            if (autoSpeak) speakWord(cardData.word);
        }
        
        function nextFlashcard() { showFlashcard(currentFlashcardIndex + 1, true); }
        function prevFlashcard() { showFlashcard(currentFlashcardIndex - 1, true); }
        function randomFlashcard() {
            if (!lessonFlashcards || lessonFlashcards.length === 0) return;
            const newIndex = Math.floor(Math.random() * lessonFlashcards.length);
            showFlashcard(newIndex, true);
        }
        
        // === END: FLASHCARD FUNCTIONS ===

        // === START: QUIZ FUNCTIONS ===
        
        function startQuizMode() {
            const lessonKey = document.getElementById('lessonDropdown').value;
            const allVocab = allLessonsData[lessonKey];
            
            if (!allVocab || allVocab.length < 4) {
                alert("C·∫ßn √≠t nh·∫•t 4 t·ª´ v·ª±ng trong b√†i h·ªçc n√†y ƒë·ªÉ b·∫Øt ƒë·∫ßu ki·ªÉm tra.");
                return;
            }
            
            // THAY ƒê·ªîI: S·ª≠ d·ª•ng 'hidden' v√† 'flex'
            const quizModal = document.getElementById('quizModal');
            quizModal.classList.remove('hidden');
            quizModal.classList.add('flex');
            
            document.getElementById('quizResultScreen').classList.add('hidden');
            document.getElementById('quizResultScreen').classList.remove('flex');
            
            document.getElementById('quizQuestionArea').classList.remove('hidden');
            // --- K·∫øt th√∫c thay ƒë·ªïi ---
            
            quizQuestions = generateQuizQuestions(allVocab);
            currentQuizQuestionIndex = 0;
            quizScore = 0;
            showQuizQuestion(currentQuizQuestionIndex);
        }
        
        function closeQuizMode() {
            // THAY ƒê·ªîI: S·ª≠ d·ª•ng 'hidden'
            const quizModal = document.getElementById('quizModal');
            quizModal.classList.add('hidden');
            quizModal.classList.remove('flex');
        }
        
        function generateQuizQuestions(allVocab) {
            let shuffledVocab = [...allVocab].sort(() => 0.5 - Math.random());
            let numQuestions = Math.min(10, shuffledVocab.length);
            let questions = [];

            for (let i = 0; i < numQuestions; i++) {
                const correctWord = shuffledVocab[i];
                let distractors = allVocab
                    .filter(v => v.word !== correctWord.word)
                    .sort(() => 0.5 - Math.random())
                    .slice(0, 3);
                let options = [correctWord, ...distractors];
                let shuffledOptions = options.sort(() => 0.5 - Math.random());
                
                questions.push({
                    word: correctWord.word,
                    pinyin: correctWord.pinyin,
                    options: shuffledOptions.map(o => o.meaning),
                    correctAnswer: correctWord.meaning
                });
            }
            return questions;
        }

        function showQuizQuestion(index) {
            if (index >= quizQuestions.length) {
                showQuizResults();
                return;
            }
            
            quizInProgress = true;
            const question = quizQuestions[index];
            
            const progress = ((index + 1) / quizQuestions.length) * 100;
            document.getElementById('quizProgressBar').style.width = `${progress}%`;
            document.getElementById('quizCounter').textContent = `C√¢u ${index + 1} / ${quizQuestions.length}`;
            document.getElementById('quizQuestionWord').textContent = question.word;
            document.getElementById('quizQuestionPinyin').textContent = question.pinyin;
            speakWord(question.word);
            
            const optionsContainer = document.getElementById('quizAnswerOptions');
            optionsContainer.innerHTML = '';
            
            question.options.forEach(optionText => {
                const optionButton = document.createElement('button');
                // THAY ƒê·ªîI: S·ª≠ d·ª•ng l·ªõp Tailwind
                optionButton.className = 'quiz-option w-full p-5 text-lg text-gray-800 dark:text-gray-100 bg-white dark:bg-gray-800 border-2 border-gray-300 dark:border-gray-700 rounded-xl cursor-pointer transition-all duration-200 ease-in-out text-left hover:border-indigo-500 dark:hover:border-indigo-400 hover:-translate-y-0.5 hover:shadow-lg disabled:cursor-not-allowed disabled:bg-gray-200 dark:disabled:bg-gray-700';
                optionButton.textContent = optionText;
                optionButton.onclick = () => handleQuizAnswer(optionText, question.correctAnswer, optionButton);
                optionsContainer.appendChild(optionButton);
            });
        }
        
        // THAY ƒê·ªîI: S·ª≠ d·ª•ng l·ªõp Tailwind cho feedback
        function handleQuizAnswer(selectedAnswer, correctAnswer, clickedButton) {
            if (!quizInProgress) return;
            quizInProgress = false;
            
            const allOptions = document.querySelectorAll('#quizAnswerOptions .quiz-option');
            allOptions.forEach(btn => btn.disabled = true);
            
            // ƒê·ªãnh nghƒ©a c√°c l·ªõp feedback
            const correctClasses = ['!border-green-500', '!bg-green-100', '!text-green-800', 'dark:!bg-green-900', 'dark:!text-green-200', 'font-bold'];
            const incorrectClasses = ['!border-red-500', '!bg-red-100', '!text-red-800', 'dark:!bg-red-900', 'dark:!text-red-200', 'font-bold'];

            if (selectedAnswer === correctAnswer) {
                clickedButton.classList.add(...correctClasses);
                quizScore++;
            } else {
                clickedButton.classList.add(...incorrectClasses);
                // T√¨m v√† highlight ƒë√°p √°n ƒë√∫ng
                allOptions.forEach(btn => {
                    if (btn.textContent === correctAnswer) {
                        btn.classList.add(...correctClasses);
                    }
                });
            }
            
            setTimeout(() => {
                currentQuizQuestionIndex++;
                showQuizQuestion(currentQuizQuestionIndex);
            }, 1000);
        }
        
        function showQuizResults() {
            // THAY ƒê·ªîI: S·ª≠ d·ª•ng 'hidden' v√† 'flex'
            document.getElementById('quizQuestionArea').classList.add('hidden');
            
            const resultScreen = document.getElementById('quizResultScreen');
            resultScreen.classList.remove('hidden');
            resultScreen.classList.add('flex'); // ƒê·∫£m b·∫£o n√≥ l√† flex
            // --- K·∫øt th√∫c thay ƒë·ªïi ---
            
            document.getElementById('quizResultScore').textContent = 
                `B·∫°n ƒë√£ tr·∫£ l·ªùi ƒë√∫ng ${quizScore} / ${quizQuestions.length} c√¢u!`;
        }

        // === END: QUIZ FUNCTIONS ===
    </script>
</body>
</html>




