<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Luy·ªán T·∫≠p T·ª´ V·ª±ng Ti·∫øng Trung</title>
    <!-- T·∫£i Google Fonts: Mulish -->
    <link href="https://fonts.googleapis.com/css2?family=Mulish:wght@400;700&display=swap" rel="stylesheet">
    <!-- T·∫£i Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Th√™m th∆∞ vi·ªán Confetti JS cho hi·ªáu ·ª©ng ph√°o gi·∫•y -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.3/dist/confetti.browser.min.js"></script>
    <style>
        /* Thi·∫øt l·∫≠p font Mulish l√†m m·∫∑c ƒë·ªãnh cho m·ªçi th·ª© tr·ª´ H√°n t·ª± */
        body {
            font-family: 'Mulish', sans-serif;
            transition: background-color 0.5s, color 0.5s;
            background-color: #f7f9fb;
            color: #1f2937;
        }
        
        /* √Åp d·ª•ng gradient cho body */
        .body-gradient {
            background-image: linear-gradient(to bottom right, #f0f9ff, #e0f2fe);
            color: #1f2937; /* slate-800 equivalent */
        }
        .dark .body-gradient {
            background-image: linear-gradient(to bottom right, #1e293b, #0f172a);
            color: #f1f5f9; /* slate-200 equivalent */
        }

        /* Hanzi: D√πng font Ê•∑‰Ωì (Kaiti) */
        .hanzi-text {
            font-family: 'KaiTi', 'Ê•∑‰Ωì', 'Kaiti SC', 'LiSu', serif; /* Kaiti font family */
            line-height: 1;
            font-weight: 580;
        }
        
        .pinyin-text {
            font-weight: 400;
        }

        /* ƒê·ªãnh d·∫°ng c√°c √¥ ƒë√°p √°n */
        .choice-card {
            aspect-ratio: 1 / 1; 
            cursor: pointer;
            border: none;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06);
            --tw-ring-color: transparent;
            --tw-ring-offset-shadow: 0 0 0 0 var(--tw-ring-color);
            --tw-ring-shadow: 0 0 0 0 var(--tw-ring-color);
            outline: 2px solid transparent; 
            outline-offset: 2px;
            
            transition: transform 0.2s ease-in-out, box-shadow 0.2s, outline 0.2s, background-color 0.2s;
        }
        
        .choice-card:hover:not(.disabled):not(.feedback) {
            transform: scale(1.03);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            outline: 4px solid #a5b4fc; /* M√†u ring khi hover (indigo-300) */
        }
        
        /* ƒê·ªãnh d·∫°ng placeholder (ch·ªâ d√πng cho l·ªói ·∫£nh) */
        .image-placeholder {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            font-size: 1.125rem; /* Base size adjusted for mobile */
            color: #94a3b8; /* slate-400 */
            text-align: center;
            line-height: 1.4;
            padding: 0.5rem; /* Th√™m padding cho n·ªôi dung placeholder */
        }
        
        .choice-card img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block; /* Gi·ªØ hi·ªÉn th·ªã ƒë·ªÉ overlay c√≥ th·ªÉ ho·∫°t ƒë·ªông */
            opacity: 1;
            transition: opacity 0.3s;
        }
        
        /* L·ªõp cho tr·∫°ng th√°i kh√¥ng ƒë∆∞·ª£c ch·ªçn khi c√≥ feedback */
        .dimmed img {
            opacity: 0.4;
        }

        /* CSS M·ªöI: Overlay hi·ªÉn th·ªã nghƒ©a Ti·∫øng Vi·ªát */
        .meaning-overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: rgba(0, 0, 0, 0.65); /* N·ªÅn t·ªëi m·ªù */
            color: #ffffff;
            padding: 0.5rem 1rem;
            font-size: 2rem; /* Base size: text-lg */
            font-weight: 700; /* font-bold */
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8);
            transform: translateY(100%); /* ·∫®n ban ƒë·∫ßu */
            transition: transform 0.3s ease-out;
            border-radius: 0 0 0.75rem 0.75rem; /* rounded-xl ·ªü g√≥c d∆∞·ªõi */
            text-align: center;
            width: 100%;
        }

        /* ƒêi·ªÅu ch·ªânh c·ª° ch·ªØ cho mobile (d∆∞·ªõi 640px) */
        @media (max-width: 639px) { 
            .meaning-overlay {
                font-size: 1rem; /* Thay ƒë·ªïi t·ª´ 1.5rem (text-lg) xu·ªëng 1rem */
                padding: 0.4rem 0.8rem; /* Gi·∫£m padding m·ªôt ch√∫t cho g·ªçn */
            }
        }

        /* Hi·ªÉn th·ªã meaning-overlay khi th·∫ª c√≥ class 'feedback' v√† l√† ƒë√°p √°n ƒë√∫ng */
        .choice-card.feedback .meaning-overlay.show-meaning {
            transform: translateY(0); /* Hi·ªán ra */
        }
        /* End CSS M·ªöI */

        /* Icon SVG cho n√∫t Dark/Light Mode */
        .mode-toggle svg {
            transition: transform 0.3s, color 0.3s;
        }

        .mode-toggle:hover svg {
            transform: rotate(15deg);
            color: #f59e0b; /* Yellow 500 */
        }
        
        /* PROGRESS BAR STYLES M·ªöI */
        .progress-bar-container {
            height: 12px; /* TƒÉng ƒë·ªô d√†y */
            border-radius: 9999px;
            background-color: #e5e7eb; /* gray-200 */
            overflow: hidden;
            box-shadow: inset 0 1px 3px 0 rgb(0 0 0 / 0.1);
        }
        .progress-bar {
            height: 100%;
            background-color: #4f46e5; /* indigo-600 */
            transition: width 0.5s ease-in-out;
            border-radius: 9999px;
            box-shadow: 0 0 10px #4f46e5, 0 0 5px #4f46e5; /* Hi·ªáu ·ª©ng t·ªèa s√°ng nh·∫π */
        }
        .dark .progress-bar-container {
            background-color: #334155; /* slate-700 */
        }
        .dark .progress-bar {
            background-color: #4f46e5; /* indigo-400 */
            box-shadow: 0 0 10px #818cf8, 0 0 5px #818cf8;
        }
        
    </style>
</head>
<body class="body-gradient min-h-screen flex flex-col items-center p-4 sm:p-6">

    <!-- Thanh ti√™u ƒë·ªÅ (Dropdown + Dark Mode Toggle) -->
    <header class="w-full max-w-2xl flex justify-between items-center mb-6 p-2">
        
        <div class="flex space-x-3 sm:space-x-4">

            <!-- Dropdown ch·ªçn b√†i h·ªçc -->
            <div class="relative inline-block text-left rounded-xl shadow-lg bg-white/70 dark:bg-slate-900/70 backdrop-blur-sm transition duration-300">
                <select id="lesson-selector" class="block w-full py-3 px-4 pr-10 text-lg sm:text-xl font-semibold border-none rounded-xl appearance-none bg-transparent text-slate-800 dark:text-slate-200" onchange="resetAndLoadLesson()">
                    <!-- Options s·∫Ω ƒë∆∞·ª£c th√™m b·∫±ng JS -->
                </select>
                <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-slate-700 dark:text-slate-300">
                    <!-- Icon dropdown -->
                    <svg class="fill-current h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path d="M9.293 12.95l.707.707L15.657 8l-1.414-1.414L10 10.828 5.757 6.586 4.343 8z"/></svg>
                </div>
            </div>

            <!-- Dropdown ch·ªçn CH·∫æ ƒê·ªò (H·ªçc t·∫≠p/Luy·ªán t·∫≠p) -->
            <div class="relative inline-block text-left rounded-xl shadow-lg bg-white/70 dark:bg-slate-900/70 backdrop-blur-sm transition duration-300">
                <!-- THAY ƒê·ªîI: Th√™m dropdown cho ch·∫ø ƒë·ªô h·ªçc/luy·ªán t·∫≠p -->
                <select id="study-mode-selector" class="block w-full py-3 px-4 pr-10 text-lg sm:text-xl font-semibold border-none rounded-xl appearance-none bg-transparent text-slate-800 dark:text-slate-200" onchange="resetAndLoadLesson()">
                    <option value="study">H·ªçc t·∫≠p</option>
                    <option value="practice">Luy·ªán t·∫≠p</option>
                </select>
                <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-slate-700 dark:text-slate-300">
                    <!-- Icon dropdown -->
                    <svg class="fill-current h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path d="M9.293 12.95l.707.707L15.657 8l-1.414-1.414L10 10.828 5.757 6.586 4.343 8z"/></svg>
                </div>
            </div>
            <!-- Dropdown ch·ªçn ch·∫ø ƒë·ªô (S·ªë l∆∞·ª£ng c√¢u) -->
            <div class="relative inline-block text-left rounded-xl shadow-lg bg-white/70 dark:bg-slate-900/70 backdrop-blur-sm transition duration-300">
                <!-- THAY ƒê·ªîI: Chuy·ªÉn dropdown n√†y th√†nh ch·ªçn s·ªë l∆∞·ª£ng t·ª´ -->
                <select id="word-count-selector" class="block w-full py-3 px-4 pr-10 text-lg sm:text-xl font-semibold border-none rounded-xl appearance-none bg-transparent text-slate-800 dark:text-slate-200" onchange="resetAndLoadLesson()">
                    <option value="full">To√†n b·ªô</option>
                    <option value="random10">Ng·∫´u nhi√™n</option>
                </select>
                <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-slate-700 dark:text-slate-300">
                    <!-- Icon dropdown -->
                    <svg class="fill-current h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path d="M9.293 12.95l.707.707L15.657 8l-1.414-1.414L10 10.828 5.757 6.586 4.343 8z"/></svg>
                </div>
            </div>
        </div>

        <!-- N√∫t chuy·ªÉn ƒë·ªïi ch·∫ø ƒë·ªô S√°ng/T·ªëi -->
        <button id="mode-toggle" class="mode-toggle p-2 rounded-full text-slate-500 dark:text-slate-300 hover:text-yellow-500 dark:hover:text-yellow-400 transition duration-300">
            <!-- TƒÉng k√≠ch th∆∞·ªõc icon cho d·ªÖ ch·∫°m tr√™n mobile -->
            <svg id="sun-icon" class="h-8 w-8 transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"/>
            </svg>
            <svg id="moon-icon" class="h-8 w-8 hidden transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />
            </svg>
        </button>
    </header>
    
    <!-- KHUNG CH√çNH - TƒÉng max-w l√™n 4xl cho desktop -->
    <div class="w-full max-w-4xl mx-auto bg-white/50 dark:bg-slate-800/50 backdrop-blur-sm rounded-2xl shadow-2xl p-4 sm:p-8 text-center transition-all duration-500">
        

        
        <!-- Khu v·ª±c ch√≠nh gi·ªØa (T·ª´ v·ª±ng) -->
        <main id="game-container" class="flex-grow flex flex-col items-center justify-center">

            <!-- Hanzi v√† Pinyin (TƒÉng c·ª° ch·ªØ responsive) -->
            <!-- Th√™m id cho container ƒë·ªÉ ·∫©n/hi·ªán -->
            <!-- TH√äM cursor-pointer V√Ä hover:shadow-lg CHO CH·ª®C NƒÇNG PH√ÅT √ÇM L·∫†I -->
            <div id="word-display-container" class="mb-8 sm:mb-10 p-4 rounded-xl transition-opacity duration-300 bg-white/70 dark:bg-slate-900/70 shadow-inner cursor-pointer hover:shadow-lg">
                <!-- Hanzi: 6xl (mobile) -> 7xl (sm) -> 8xl (lg) -->
                <div id="hanzi" class="hanzi-text text-6xl sm:text-7xl lg:text-8xl text-slate-800 dark:text-white transition-colors duration-300"></div>
                <!-- Pinyin: 2xl (mobile) -> 3xl (sm) -> 4xl (lg) -->
                <!-- M√†u s·∫Øc pinyin l√† red -->
                <div id="pinyin" class="pinyin-text text-2xl sm:text-3xl lg:text-4xl text-red-600 dark:text-blue-400 transition-colors duration-300">loading...</div>
            </div>
            
        <!-- KHU V·ª∞C TIMER (CH·ªà HI·ªÇN TH·ªä ·ªû CH·∫æ ƒê·ªò LUY·ªÜN T·∫¨P) -->
        <div id="timer-display" class="hidden w-full max-w-lg mx-auto mb-2 transition-opacity duration-500">
             <div class="flex justify-center items-center p-0 sm:p-0 ">
                <!-- Icon ƒë·ªìng h·ªì -->
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor" class="w-8 h-8 sm:w-10 sm:h-10 text-red-600 dark:text-red-400 mr-4 animate-pulse">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6h4.5m4.5 0a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                <span id="timer-text" class="text-4xl sm:text-4xl font-extrabold text-red-600 dark:text-red-400 tabular-nums">00:00</span>
            </div>
        </div>

        <!-- Progress Bar & Text: ƒê√£ ƒë∆∞·ª£c c·∫•u tr√∫c l·∫°i -->
        <div class="w-full max-w-lg mx-auto mb-6 sm:mb-8 transition-opacity duration-500" id="progress-wrapper">
            <!-- ƒê√£ ch·ªânh l·∫°i justify-end ƒë·ªÉ ƒë·∫©y text sang ph·∫£i -->
            <div class="flex justify-end items-center mb-1">
                <span id="progress-text" class="text-2xl font-bold text-indigo-400 dark:text-white-400">0/0</span>
            </div>
            <div id="progress-container" class="progress-bar-container">
                <div id="progress-bar" class="progress-bar" style="width: 0%"></div>
            </div>
        </div>
            <!-- 4 √¥ h√¨nh ·∫£nh -->
            <div id="choices-grid" class="grid grid-cols-2 gap-5 sm:gap-6 w-full max-w-lg mx-auto p-2 sm:p-4">
                <!-- C√°c √¥ s·∫Ω ƒë∆∞·ª£c t·∫°o b·∫±ng JS -->
            </div>
            
            <!-- Th√¥ng b√°o k·∫øt th√∫c b√†i h·ªçc -->
            <div id="result-message" class="hidden text-xl sm:text-3xl font-bold text-green-600 dark:text-green-400 mt-8 p-4 bg-white dark:bg-slate-800 rounded-xl shadow-xl">
                <!-- N·ªôi dung th√¥ng b√°o -->
            </div>
            
            <!-- Loading indicator -->
            <div id="loading-indicator" class="hidden mt-8 text-indigo-500 dark:text-indigo-400">
                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-500 inline-block mr-2"></div>
                ƒêang t·∫£i d·ªØ li·ªáu...
            </div>

        </main>
    </div>

    <script>
        // --- LOGIC PH√ÅT √ÇM C·∫¢I TI·∫æN (∆Øu ti√™n MP3, d·ª± ph√≤ng Web Speech API) ---
        
        let utterance = null;
        let audio = new Audio(); // T·∫°o m·ªôt ƒë·ªëi t∆∞·ª£ng Audio chung ƒë·ªÉ t√°i s·ª≠ d·ª•ng
        audio.preload = 'auto'; // T·∫£i tr∆∞·ªõc √¢m thanh ƒë·ªÉ ph√°t nhanh h∆°n

        /**
         * H√†m d·ª± ph√≤ng: Ph√°t √¢m Hanzi b·∫±ng Web Speech API.
         * @param {string} text - H√°n t·ª± c·∫ßn ph√°t √¢m.
         */
        function speakWithWebSpeechAPI(text) {
            if (!('speechSynthesis' in window)) {
                console.warn("Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ Web Speech API.");
                return;
            }

            // H·ªßy b·ªè ph√°t √¢m Web Speech API n·∫øu ƒëang n√≥i
            if (speechSynthesis.speaking) {
                speechSynthesis.cancel();
            }

            utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'zh-CN'; 
            utterance.rate = 0.9;
            utterance.pitch = 1.0;

            // L·∫•y v√† thi·∫øt l·∫≠p gi·ªçng n√≥i ti·∫øng Trung
            const voices = speechSynthesis.getVoices().filter(voice => voice.lang.startsWith('zh'));
            if (voices.length > 0) {
                const cnVoice = voices.find(voice => voice.lang === 'zh-CN') || voices[0];
                utterance.voice = cnVoice;
            } else {
                 console.warn("Kh√¥ng t√¨m th·∫•y gi·ªçng n√≥i Ti·∫øng Trung (zh-CN) trong h·ªá th·ªëng.");
            }

            speechSynthesis.speak(utterance);
        }

        /**
         * Ph√°t √¢m Hanzi, ∆∞u ti√™n file MP3.
         * N·∫øu kh√¥ng t√¨m th·∫•y file MP3, s·ª≠ d·ª•ng Web Speech API.
         * @param {string} text - H√°n t·ª± c·∫ßn ph√°t √¢m.
         */
        function speakHanzi(text) {
            if (!text || text === 'ƒêang t·∫£i...' || text.includes('!')) {
                return; // Kh√¥ng ph√°t √¢m c√°c th√¥ng b√°o h·ªá th·ªëng ho·∫∑c loading
            }
            
            // H·ªßy b·ªè ph√°t √¢m Web Speech API n·∫øu ƒëang n√≥i
            if (speechSynthesis.speaking) {
                speechSynthesis.cancel();
            }
            
            // T·∫°m d·ª´ng v√† ƒë·∫∑t l·∫°i audio MP3 n·∫øu ƒëang ph√°t
            if (!audio.paused) {
                audio.pause();
                audio.currentTime = 0;
            }

            const trimmedText = text.trim();
            // ƒê∆∞·ªùng d·∫´n file MP3: BASE_PATH/baiX/mp3/Hanzi.mp3
            const mp3Path = `${BASE_PATH}/${currentLessonKey}/mp3/${trimmedText}.mp3`;

            // 1. KI·ªÇM TRA T·ªíN T·∫†I FILE MP3 V√Ä PH√ÅT
            fetch(mp3Path, { method: 'HEAD' })
                .then(response => {
                    if (response.ok) {
                        // File t·ªìn t·∫°i, ti·∫øn h√†nh ph√°t MP3
                        audio.src = mp3Path;
                        audio.play().catch(e => {
                            // X·ª≠ l√Ω l·ªói ph√°t (v√≠ d·ª•: b·ªã ch·∫∑n)
                            console.warn(`L·ªói khi c·ªë g·∫Øng ph√°t MP3 (${mp3Path}):`, e);
                            speakWithWebSpeechAPI(trimmedText);
                        });
                    } else {
                        // File kh√¥ng t·ªìn t·∫°i (status 404, etc.), chuy·ªÉn sang Web Speech API
                        console.info(`Kh√¥ng t√¨m th·∫•y file MP3: ${mp3Path}. S·ª≠ d·ª•ng Web Speech API.`);
                        speakWithWebSpeechAPI(trimmedText);
                    }
                })
                .catch(e => {
                    // L·ªói m·∫°ng ho·∫∑c l·ªói kh√°c, chuy·ªÉn sang Web Speech API
                    console.error(`L·ªói ki·ªÉm tra file MP3: ${e.message}. S·ª≠ d·ª•ng Web Speech API.`);
                    speakWithWebSpeechAPI(trimmedText);
                });
        }
        
        
        // --- C√ÅC H·∫∞NG V√Ä BI·∫æN TO√ÄN C·ª§C ---
        
        const LESSON_CONFIG = [
            { key: "bai1", title: "H1 B√†i 1: ËÄÅÂ∏àÊÇ®Â•ΩÔºÅ" },
            { key: "bai2", title: "H1 B√†i 2: Ë∞¢Ë∞¢‰Ω†ÔºÅ" },
            { key: "bai3", title: "H1 B√†i 3: ‰Ω†Âè´‰ªÄ‰πàÂêçÂ≠óÔºü" },
        ]; 
        
        const LESSON_KEYS = LESSON_CONFIG.map(config => config.key);

        const BASE_PATH = 'data_imgpractice'; 
        let allLessonsData = {}; 
        let currentLessonKey = LESSON_KEYS[0];
        let currentLesson = []; // M·∫£ng c√°c c√¢u h·ªèi ƒë√£ x√°o tr·ªôn (ch·ª©a t·ª´ v·ª±ng c·ªßa b√†i hi·ªán t·∫°i)
        let currentQuestionIndex = 0;
        let score = 0;
        let isQuestionActive = true;
        let timerInterval = null; // Bi·∫øn cho setInterval
        let timeRemaining = 0; // Th·ªùi gian c√≤n l·∫°i (gi√¢y)
        
        const RANDOM_WORD_LIMIT = 10; // Gi·ªõi h·∫°n t·ª´ ng·∫´u nhi√™n
        const TIME_PER_WORD_RANDOM = 6; // 5 gi√¢y/t·ª´ cho ch·∫ø ƒë·ªô 10 c√¢u
        const TIME_PER_WORD_FULL = 6;   // 4 gi√¢y/t·ª´ cho ch·∫ø ƒë·ªô to√†n b·ªô
        
        // C·∫•u h√¨nh ph√°o gi·∫•y
        const CONFETTI_CONFIG = {
            particleCount: 100,
            spread: 70,
            origin: { y: 0.6 }
        };

        // --- C√ÅC PH·∫¶N T·ª¨ DOM ---
        const hanziEl = document.getElementById('hanzi');
        const pinyinEl = document.getElementById('pinyin');
        const choicesGridEl = document.getElementById('choices-grid');
        const resultMessageEl = document.getElementById('result-message');
        const lessonSelectorEl = document.getElementById('lesson-selector');
        const wordCountSelectorEl = document.getElementById('word-count-selector'); // ƒê√£ ƒë·ªïi t√™n t·ª´ modeSelectorEl
        const studyModeSelectorEl = document.getElementById('study-mode-selector'); // DOM M·ªöI CHO CH·∫æ ƒê·ªò H·ªåC/LUY·ªÜN T·∫¨P
        const timerDisplayEl = document.getElementById('timer-display'); // DOM M·ªöI CHO TIMER
        const timerTextEl = document.getElementById('timer-text'); // DOM M·ªöI CHO TEXT TIMER
        const modeToggleEl = document.getElementById('mode-toggle');
        const sunIconEl = document.getElementById('sun-icon');
        const moonIconEl = document.getElementById('moon-icon');
        const loadingIndicatorEl = document.getElementById('loading-indicator');
        // Th√™m DOM cho Progress Bar
        const progressBarEl = document.getElementById('progress-bar');
        const progressTextEl = document.getElementById('progress-text'); 
        const progressWrapperEl = document.getElementById('progress-wrapper'); 
        // Th√™m DOM cho Word Display Container
        const wordDisplayContainerEl = document.getElementById('word-display-container'); 

        // --- LOGIC M·ªöI: NH·∫§N ƒê·ªÇ PH√ÅT √ÇM L·∫†I ---
        /**
         * X·ª≠ l√Ω s·ª± ki·ªán nh·∫•p v√†o khu v·ª±c hi·ªÉn th·ªã t·ª´ v·ª±ng ƒë·ªÉ ph√°t √¢m l·∫°i.
         */
        wordDisplayContainerEl.addEventListener('click', () => {
            const currentHanzi = hanziEl.textContent.trim();
            // Ch·ªâ ph√°t √¢m n·∫øu kh√¥ng ·ªü tr·∫°ng th√°i loading ho·∫∑c k·∫øt th√∫c b√†i.
            const isFinishedMessage = currentHanzi === 'üéâ Tuy·ªát V·ªùi! Xu·∫•t S·∫Øc! üéâ' || currentHanzi === 'üí™ C·ªë G·∫Øng L√™n! üí™';
            
            if (currentHanzi && currentHanzi !== 'ƒêang t·∫£i...' && !isFinishedMessage) {
                speakHanzi(currentHanzi);
            }
        });

        // --- SVG ICONS ---
        const CheckIcon = `<div class="bg-green-500/80 rounded-full p-4"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="3" stroke="currentColor" class="w-8 h-8 sm:w-10 sm:h-10 text-white"><path stroke-linecap="round" stroke-linejoin="round" d="M4.5 12.75l6 6 9-13.5" /></svg></div>`;
        const XIcon = `<div class="bg-red-500/80 rounded-full p-4"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="3" stroke="currentColor" class="w-8 h-8 sm:w-10 sm:h-10 text-white"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg></div>`;

        // --- H√ÄM TI·ªÜN √çCH ---

        /**
         * H√†m x√°o tr·ªôn m·∫£ng Fisher-Yates (ƒë·ªÉ x√°o tr·ªôn ƒë√°p √°n)
         */
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        /**
         * L·∫•y ƒë∆∞·ªùng d·∫´n ·∫£nh th·ª±c t·∫ø.
         */
        function getImagePath(hanzi, lessonKey) {
             const fileName = hanzi.trim() + '.jpg'; 
             return `${BASE_PATH}/${lessonKey}/img/${fileName}`;
        }
        
        /**
         * C·∫≠p nh·∫≠t thanh ti·∫øn tr√¨nh (chi·ªÅu r·ªông v√† vƒÉn b·∫£n X/Y).
         */
        function updateProgressBar() {
            const totalQuestions = currentLesson.length;
            const questionsCompleted = currentQuestionIndex; 

            if (totalQuestions === 0) {
                progressBarEl.style.width = '0%';
                progressTextEl.textContent = '0/0';
                progressWrapperEl.classList.add('opacity-0', 'pointer-events-none'); 
                return;
            }

            const progressPercentage = (questionsCompleted / totalQuestions) * 100;
            progressBarEl.style.width = `${progressPercentage}%`;
            progressTextEl.textContent = `${questionsCompleted}/${totalQuestions}`;
            
            progressWrapperEl.classList.remove('opacity-0', 'pointer-events-none');
            
            if (questionsCompleted >= totalQuestions) {
                setTimeout(() => {
                    progressWrapperEl.classList.add('opacity-0', 'pointer-events-none');
                }, 500); 
            }
        }
        
        // --- LOGIC TIMER M·ªöI ---
        
        /**
         * D·ª´ng b·ªô ƒë·∫øm ng∆∞·ª£c.
         */
        function stopTimer() {
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
        }

        /**
         * Format th·ªùi gian (gi√¢y) th√†nh MM:SS.
         */
        function formatTime(totalSeconds) {
            const minutes = Math.floor(totalSeconds / 60);
            const seconds = totalSeconds % 60;
            return `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        }

        /**
         * B·∫Øt ƒë·∫ßu b·ªô ƒë·∫øm ng∆∞·ª£c d·ª±a tr√™n t·ªïng s·ªë c√¢u h·ªèi.
         */
        function startTimer() {
            stopTimer(); // ƒê·∫£m b·∫£o d·ª´ng timer c≈©

            const studyMode = studyModeSelectorEl.value;
            const totalQuestions = currentLesson.length;

            if (studyMode === 'study' || totalQuestions === 0) {
                timerDisplayEl.classList.add('hidden');
                return;
            }
            
            timerDisplayEl.classList.remove('hidden');

            const wordCountMode = wordCountSelectorEl.value;
            let timePerWord = TIME_PER_WORD_RANDOM;
            
            // N·∫øu ch·ªçn to√†n b·ªô v√† c√≥ nhi·ªÅu h∆°n 10 t·ª´, s·ª≠ d·ª•ng 4 gi√¢y/t·ª´
            if (wordCountMode === 'full' && totalQuestions > RANDOM_WORD_LIMIT) {
                timePerWord = TIME_PER_WORD_FULL;
            }
            
            timeRemaining = totalQuestions * timePerWord;
            timerTextEl.textContent = formatTime(timeRemaining);
            
            // B·∫Øt ƒë·∫ßu ƒë·∫øm ng∆∞·ª£c
            timerInterval = setInterval(() => {
                timeRemaining--;
                timerTextEl.textContent = formatTime(timeRemaining);

                // Thay ƒë·ªïi m√†u khi c√≤n 10 gi√¢y cu·ªëi
                if (timeRemaining <= 10) {
                    timerTextEl.classList.add('text-yellow-500', 'dark:text-yellow-300');
                    timerTextEl.classList.remove('text-red-600', 'dark:text-red-400');
                } else {
                    timerTextEl.classList.remove('text-yellow-500', 'dark:text-yellow-300');
                    timerTextEl.classList.add('text-red-600', 'dark:text-red-400');
                }

                if (timeRemaining <= 0) {
                    stopTimer();
                    handleTimeout(); 
                }
            }, 1000);
        }
        
        /**
         * X·ª≠ l√Ω khi h·∫øt gi·ªù.
         */
        function handleTimeout() {
            isQuestionActive = false;
            // V√¥ hi·ªáu h√≥a t·∫•t c·∫£ c√°c l·ª±a ch·ªçn
            Array.from(choicesGridEl.children).forEach(card => {
                card.classList.add('disabled', 'dimmed'); 
                card.style.outline = 'none';
                card.removeEventListener('click', handleAnswer);
            });
            
            showCompletionMessage(true); // Truy·ªÅn true ƒë·ªÉ th√¥ng b√°o h·∫øt gi·ªù
            
            // THAY ƒê·ªîI: T·ª± ƒë·ªông l√†m l·∫°i b√†i sau 3 gi√¢y
            setTimeout(() => {
                resetAndLoadLesson();
            }, 3000); 
        }

        // --- LOGIC T·∫¢I V√Ä PH√ÇN T√çCH D·ªÆ LI·ªÜU TH·ª∞C T·∫æ ---

        /**
         * H√†m t·∫£i d·ªØ li·ªáu t·ª´ t·ªáp baiX.txt qua fetch API.
         */
        async function fetchLessonData(lessonKey) {
            const url = `${BASE_PATH}/${lessonKey}/${lessonKey}.txt`;
            
            try {
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`L·ªói t·∫£i d·ªØ li·ªáu t·ª´ ${url}. M√£ l·ªói: ${response.status}`);
                }
                const text = await response.text();

                // Ph√¢n t√≠ch d·ªØ li·ªáu: T·ª´ ti·∫øng trung|pinyin|nghƒ©a
                const lines = text.trim().split('\n').filter(line => line.trim() !== '');
                const vocabulary = lines.map(line => {
                    const parts = line.split('|');
                    if (parts.length === 3) {
                        return {
                            hanzi: parts[0].trim(),
                            pinyin: parts[1].trim(),
                            meaning: parts[2].trim(),
                            lessonKeySource: lessonKey, 
                        };
                    }
                    console.warn(`L·ªói ph√¢n t√≠ch d√≤ng: ${line}`);
                    return null;
                }).filter(item => item !== null);

                return vocabulary;

            } catch (error) {
                console.error(`Kh√¥ng th·ªÉ t·∫£i ho·∫∑c ph√¢n t√≠ch d·ªØ li·ªáu cho b√†i ${lessonKey}:`, error);
                return [];
            }
        }

        /**
         * T·∫£i t·∫•t c·∫£ d·ªØ li·ªáu b√†i h·ªçc khi kh·ªüi t·∫°o
         */
        async function initializeLessons() {
            loadingIndicatorEl.classList.remove('hidden');
            hanziEl.textContent = '';
            pinyinEl.textContent = 'Vui l√≤ng ch·ªù...';
            choicesGridEl.innerHTML = '';
            lessonSelectorEl.disabled = true;
            wordCountSelectorEl.disabled = true;
            studyModeSelectorEl.disabled = true;

            const lessonKeysToProcess = LESSON_KEYS;
            
            for (const key of lessonKeysToProcess) {
                const data = await fetchLessonData(key);
                allLessonsData[key] = data;
            }
            
            loadingIndicatorEl.classList.add('hidden');
            lessonSelectorEl.disabled = false;
            wordCountSelectorEl.disabled = false;
            studyModeSelectorEl.disabled = false;
            
            initLessonSelector();
            updateProgressBar(); 
            // KH√îNG g·ªçi loadLesson ·ªü ƒë√¢y n·ªØa, m√† g·ªçi th√¥ng qua initLessonSelector
        }

        // --- H√ÄM T·∫†O GIAO DI·ªÜN V√Ä LOGIC GAME ---

        /**
         * Kh·ªüi t·∫°o Dropdown b√†i h·ªçc (S·ª≠ d·ª•ng LESSON_CONFIG)
         */
        function initLessonSelector() {
            lessonSelectorEl.innerHTML = '';
            
            let firstAvailableKey = null; 

            LESSON_CONFIG.forEach(config => {
                const lessonData = allLessonsData[config.key];
                const hasData = lessonData && lessonData.length > 0;
                
                const option = document.createElement('option');
                option.value = config.key;

                if (hasData) {
                    option.textContent = config.title; 
                    if (!firstAvailableKey) {
                        firstAvailableKey = config.key; 
                    }
                } else {
                    option.textContent = `${config.title} (L·ªói/Ch∆∞a c√≥ d·ªØ li·ªáu)`;
                    option.disabled = true;
                }
                
                lessonSelectorEl.appendChild(option);
            });
            
            if (firstAvailableKey) {
                currentLessonKey = firstAvailableKey;
                lessonSelectorEl.value = currentLessonKey; 
                loadLesson(currentLessonKey); // T·∫£i b√†i h·ªçc ƒë·∫ßu ti√™n
            } else {
                 hanziEl.textContent = 'L·ªói d·ªØ li·ªáu';
                 pinyinEl.textContent = 'Kh√¥ng c√≥ b√†i h·ªçc n√†o ƒë∆∞·ª£c t·∫£i th√†nh c√¥ng.';
                 choicesGridEl.innerHTML = '';
            }
        }
        
        /**
         * H√†m reset tr·∫°ng th√°i v√† t·∫£i l·∫°i b√†i h·ªçc khi thay ƒë·ªïi dropdown.
         */
        function resetAndLoadLesson() {
            stopTimer(); // D·ª´ng timer ngay l·∫≠p t·ª©c khi thay ƒë·ªïi l·ª±a ch·ªçn
            loadLesson(lessonSelectorEl.value);
        }

        /**
         * T·∫£i v√† chu·∫©n b·ªã b√†i h·ªçc m·ªõi
         * @param {string} lessonKey Kh√≥a b√†i h·ªçc c·∫ßn t·∫£i.
         */
        function loadLesson(lessonKey) {
            currentLessonKey = lessonKey;
            
            const lessonData = allLessonsData[lessonKey];
            if (!lessonData || lessonData.length === 0) {
                 console.error(`D·ªØ li·ªáu cho b√†i ${lessonKey} b·ªã l·ªói ho·∫∑c tr·ªëng.`);
                 hanziEl.textContent = 'L·ªói';
                 pinyinEl.textContent = 'Kh√¥ng c√≥ d·ªØ li·ªáu';
                 choicesGridEl.innerHTML = '';
                 updateProgressBar();
                 stopTimer();
                 return;
            }
            
            // L·∫•y ch·∫ø ƒë·ªô luy·ªán t·∫≠p hi·ªán t·∫°i (full/random10)
            const wordCountMode = wordCountSelectorEl.value;
            const studyMode = studyModeSelectorEl.value; // H·ªçc t·∫≠p/Luy·ªán t·∫≠p

            let wordsToPractice = [...lessonData];

            if (wordCountMode === 'random10') {
                // X√°o tr·ªôn to√†n b·ªô t·ª´ v·ª±ng c·ªßa b√†i ƒë√≥
                wordsToPractice = shuffleArray(wordsToPractice);
                // Gi·ªõi h·∫°n l·∫°i th√†nh RANDOM_WORD_LIMIT (10) t·ª´
                currentLesson = wordsToPractice.slice(0, RANDOM_WORD_LIMIT);

                // N·∫øu s·ªë l∆∞·ª£ng t·ª´ c·ªßa b√†i nh·ªè h∆°n 10, ch·ªâ l·∫•y h·∫øt s·ªë ƒë√≥
                if (wordsToPractice.length < RANDOM_WORD_LIMIT) {
                    currentLesson = wordsToPractice;
                    console.warn(`B√†i ${lessonKey} ch·ªâ c√≥ ${wordsToPractice.length} t·ª´. Luy·ªán t·∫≠p to√†n b·ªô s·ªë t·ª´ n√†y.`);
                }
            } else { // Ch·∫ø ƒë·ªô "full"
                currentLesson = shuffleArray(wordsToPractice);
            }

            currentQuestionIndex = 0;
            score = 0;
            resultMessageEl.classList.add('hidden');
            resultMessageEl.innerHTML = '';
            
            // CH·ªà G·ªåI startTimer L·∫¶N ƒê·∫¶U TI√äN ·ªû ƒê√ÇY
            if (studyMode === 'practice') {
                startTimer();
            } else {
                stopTimer();
                timerDisplayEl.classList.add('hidden');
            }

            renderQuestion();
            updateProgressBar();
            
        }

        /**
         * Hi·ªÉn th·ªã c√¢u h·ªèi hi·ªán t·∫°i
         */
        function renderQuestion() {
            isQuestionActive = true;
            choicesGridEl.innerHTML = '';
            
            if (currentQuestionIndex >= currentLesson.length) {
                stopTimer(); // D·ª´ng timer khi ho√†n th√†nh b√†i
                showCompletionMessage();
                updateProgressBar(); 
                return;
            }

            // Hi·ªán l·∫°i ph·∫ßn hi·ªÉn th·ªã Hanzi/Pinyin l·ªõn cho c√¢u h·ªèi m·ªõi
            wordDisplayContainerEl.classList.remove('hidden');

            const currentWord = currentLesson[currentQuestionIndex];
            
            // 1. C·∫≠p nh·∫≠t Hanzi v√† Pinyin
            hanziEl.textContent = currentWord.hanzi;
            pinyinEl.textContent = currentWord.pinyin;
            
            // ƒê·ªçc t·ª´ H√°n t·ª± 
            speakHanzi(currentWord.hanzi); 
            
            // 2. Ch·ªçn 3 ƒë√°p √°n sai (Decoys)
            
            // ƒê·∫£m b·∫£o ch·ªâ l·∫•y t·ª´ b√†i hi·ªán t·∫°i V√Ä kh√¥ng ph·∫£i l√† t·ª´ ƒëang h·ªèi.
            const currentLessonWords = allLessonsData[currentLessonKey] || [];
            
            // L·ªçc ra c√°c t·ª´ c√≥ Hanzi (v√† do ƒë√≥ l√† t·ª´ v·ª±ng) kh√°c v·ªõi t·ª´ ƒëang h·ªèi
            const availableDecoys = currentLessonWords.filter(w => w.hanzi !== currentWord.hanzi);
            
            // Ch·ªçn ng·∫´u nhi√™n 3 t·ª´ g√¢y nhi·ªÖu t·ª´ m·∫£ng ƒë√£ l·ªçc
            const decoys = shuffleArray(availableDecoys).slice(0, Math.min(3, availableDecoys.length)); 

            // 3. T·∫≠p h·ª£p 4 ƒë√°p √°n v√† x√°o tr·ªôn v·ªã tr√≠
            // C√°c t·ª´ trong m·∫£ng 'choices' ƒë·ªÅu c√≥ lessonKeySource = currentLessonKey 
            const choices = shuffleArray([currentWord, ...decoys]).slice(0, 4); 

            // 4. T·∫°o c√°c √¥ l·ª±a ch·ªçn (Choice Cards)
            choices.forEach((choice, index) => {
                const card = document.createElement('button');
                card.id = `choice-${index}`;
                card.className = 'choice-card relative rounded-xl overflow-hidden bg-white dark:bg-slate-900/50 transition-all duration-300 transform';
                card.setAttribute('data-hanzi', choice.hanzi);
                card.setAttribute('data-meaning', choice.meaning); // TH√äM nghƒ©a Ti·∫øng Vi·ªát

                // L·∫•y kh√≥a b√†i h·ªçc g·ªëc t·ª´ ch√≠nh ƒë·ªëi t∆∞·ª£ng t·ª´ v·ª±ng
                const sourceKey = choice.lessonKeySource;

                // S·ª¨ D·ª§NG sourceKey ƒê√É ƒê·∫¢M B·∫¢O L√Ä currentLessonKey
                const imagePath = getImagePath(choice.hanzi, sourceKey); 
                
                const errorPlaceholderHtml = `<div class="image-placeholder absolute inset-0 text-red-500">L·ªói ·∫¢nh</div>`; 
                
                const imageEl = `<img 
                    src="${imagePath}" 
                    alt="${choice.meaning}" 
                    class="w-full h-full object-cover transition-opacity duration-300" 
                    onerror="this.parentElement.innerHTML = \`${errorPlaceholderHtml}\`;"
                >`; 
                
                // TH√äM meaning-overlay
                const meaningOverlay = `<div class="meaning-overlay">${choice.meaning}</div>`;

                card.innerHTML = imageEl + meaningOverlay;
                card.classList.add('show-img'); 
                
                card.addEventListener('click', () => handleAnswer(card, choice.hanzi === currentWord.hanzi));
                
                choicesGridEl.appendChild(card);
            });
            
            resultMessageEl.classList.add('hidden');
        }

        /**
         * X·ª≠ l√Ω khi ng∆∞·ªùi ch∆°i ch·ªçn ƒë√°p √°n
         */
        function handleAnswer(selectedEl, isCorrect) {
            if (!isQuestionActive) return; 
            isQuestionActive = false;
            
            // KH√îNG D·ª™NG TIMER ·ªû ƒê√ÇY N·ªÆA
            // Timer s·∫Ω ti·∫øp t·ª•c ƒë·∫øm xu·ªëng cho ƒë·∫øn khi h·∫øt gi·ªù ho·∫∑c chuy·ªÉn c√¢u h·ªèi.

            const correctWord = currentLesson[currentQuestionIndex];
            
            // 1. V√¥ hi·ªáu h√≥a v√† l√†m m·ªù c√°c l·ª±a ch·ªçn kh√°c
            Array.from(choicesGridEl.children).forEach(card => {
                card.classList.add('disabled', 'dimmed'); 
                card.classList.remove('hover:scale-1.03', 'hover:ring-indigo-300');
                card.style.outline = 'none';
                // X√≥a b·ªè listener ƒë·ªÉ ngƒÉn nh·∫•p th√™m
                card.removeEventListener('click', handleAnswer);
            });
            
            // 2. X·ª≠ l√Ω ph·∫£n h·ªìi cho th·∫ª ƒë∆∞·ª£c ch·ªçn
            selectedEl.classList.remove('dimmed');
            selectedEl.classList.add('feedback');
            selectedEl.style.transform = 'scale(1.05)';

            const overlay = document.createElement('div');
            overlay.className = 'absolute inset-0 flex items-center justify-center transition-opacity duration-300 opacity-100';

            if (isCorrect) {
                score++;
                selectedEl.style.outline = '4px solid #10b981'; // Green 500
                overlay.innerHTML = CheckIcon;
                
                // HI·ªÇN TH·ªä NGHƒ®A CHO ƒê√ÅP √ÅN ƒê√öNG
                const meaningEl = selectedEl.querySelector('.meaning-overlay');
                if (meaningEl) meaningEl.classList.add('show-meaning');

            } else {
                selectedEl.style.outline = '4px solid #ef4444'; // Red 500
                overlay.innerHTML = XIcon;
                
                // 3. T√¨m v√† t√¥ m√†u ƒë√°p √°n ƒë√∫ng
                const correctCard = Array.from(choicesGridEl.children).find(card => card.getAttribute('data-hanzi') === correctWord.hanzi);
                
                if (correctCard) {
                    correctCard.classList.remove('dimmed'); 
                    correctCard.classList.add('feedback'); // ƒê·∫£m b·∫£o th·∫ª ƒë√∫ng c≈©ng c√≥ feedback
                    correctCard.style.outline = '4px solid #10b981'; 
                    correctCard.style.transform = 'scale(1.05)';
                    
                    const correctOverlay = document.createElement('div');
                    correctOverlay.className = 'absolute inset-0 flex items-center justify-center transition-opacity duration-300 opacity-100';
                    correctOverlay.innerHTML = CheckIcon;
                    correctCard.appendChild(correctOverlay);

                    // HI·ªÇN TH·ªä NGHƒ®A CHO ƒê√ÅP √ÅN ƒê√öNG (KHI CH·ªåN SAI)
                    const meaningEl = correctCard.querySelector('.meaning-overlay');
                    if (meaningEl) meaningEl.classList.add('show-meaning');
                }
            }

            selectedEl.appendChild(overlay);

            // Chuy·ªÉn c√¢u h·ªèi sau 2.5 gi√¢y
            setTimeout(() => {
                currentQuestionIndex++;
                updateProgressBar(); // C·∫≠p nh·∫≠t ti·∫øn ƒë·ªô sau khi tr·∫£ l·ªùi
                renderQuestion();
            }, 2500); 
        }
        
        // --- LOGIC PH√ÅO GI·∫§Y V√Ä TH√îNG B√ÅO K·∫æT TH√öC C·∫¢I TI·∫æN ---
        
        /**
         * B·∫Øn ph√°o gi·∫•y t·ª´ m·ªôt v·ªã tr√≠ ng·∫´u nhi√™n
         */
        function shootConfetti() {
            const randomX = Math.random() * 0.6 + 0.2; 
            const randomY = Math.random() * 0.6 + 0.2; 
            
            confetti({
                ...CONFETTI_CONFIG,
                origin: { x: randomX, y: randomY },
                colors: ['#4f46e5', '#f59e0b', '#10b981', '#ef4444', '#ffffff'] // M√†u s·∫Øc t∆∞∆°i s√°ng
            });
        }

        /**
         * B·∫Øn ph√°o gi·∫•y 3 l·∫ßn
         */
        function burstConfetti(times = 3, interval = 500) {
            let count = 0;
            const intervalId = setInterval(() => {
                if (count < times) {
                    shootConfetti();
                    count++;
                } else {
                    clearInterval(intervalId);
                }
            }, interval);
        }

        /**
         * Hi·ªÉn th·ªã th√¥ng b√°o khi ho√†n th√†nh b√†i h·ªçc (C·∫£i ti·∫øn)
         * @param {boolean} isTimeout - true n·∫øu k·∫øt th√∫c do h·∫øt gi·ªù.
         */
        function showCompletionMessage(isTimeout = false) {
            // ·∫®n ph·∫ßn hi·ªÉn th·ªã Hanzi/Pinyin l·ªõn v√† Timer
            wordDisplayContainerEl.classList.add('hidden');
            timerDisplayEl.classList.add('hidden');

            const totalQuestions = currentLesson.length;
            const percentage = totalQuestions > 0 ? (score / totalQuestions) * 100 : 0;
            const isExcellent = percentage >= 80; // Ng∆∞·ª°ng 80%
            
            const currentLessonTitle = LESSON_CONFIG.find(c => c.key === currentLessonKey)?.title || `B√†i ${currentLessonKey.replace('bai', '')}`;
            
            // Ch·ªçn n·ªôi dung th√¥ng b√°o
            let headerText = '';
            let message = '';
            let headerColor = '';
            
            if (isTimeout) {
                headerText = '‚è∞ H·∫øt Gi·ªù! ‚è∞';
                message = `B·∫°n ƒë√£ ho√†n th√†nh ${currentQuestionIndex}/${totalQuestions} c√¢u h·ªèi trong th·ªùi gian quy ƒë·ªãnh. ƒêang t·ª± ƒë·ªông l√†m l·∫°i...`;
                headerColor = 'text-red-600 dark:text-red-400';
            } else if (isExcellent) {
                headerText = 'üéâ Tuy·ªát V·ªùi! Xu·∫•t S·∫Øc! üéâ';
                message = 'B·∫°n ƒë√£ ƒë·∫°t th√†nh t√≠ch r·∫•t cao! Ti·∫øp t·ª•c ph√°t huy nh√©!';
                headerColor = 'text-yellow-600 dark:text-yellow-400';
                burstConfetti(3); // B·∫Øn ph√°o gi·∫•y 3 l·∫ßn
            } else {
                headerText = 'üí™ C·ªë G·∫Øng L√™n! üí™';
                message = 'B·∫°n c·∫ßn luy·ªán t·∫≠p th√™m ƒë·ªÉ n·∫Øm v·ªØng t·ª´ v·ª±ng. ƒê·ª´ng n·∫£n l√≤ng!';
                headerColor = 'text-indigo-600 dark:text-indigo-400';
            }

            // C·∫≠p nh·∫≠t giao di·ªán ch√≠nh
            hanziEl.textContent = headerText; // V·∫´n c·∫≠p nh·∫≠t nh∆∞ng b·ªã ·∫©n
            pinyinEl.textContent = 'B√†i luy·ªán t·∫≠p ƒë√£ k·∫øt th√∫c.'; // V·∫´n c·∫≠p nh·∫≠t nh∆∞ng b·ªã ·∫©n
            choicesGridEl.innerHTML = '';
            
            // C·∫≠p nh·∫≠t th√¥ng b√°o k·∫øt qu·∫£
            resultMessageEl.classList.remove('hidden');
            
            // N·∫øu l√† h·∫øt gi·ªù, kh√¥ng hi·ªÉn th·ªã n√∫t "L√†m l·∫°i b√†i n√†y" m√† ch·ªâ hi·ªÉn th·ªã th√¥ng b√°o
            if (isTimeout) {
                 resultMessageEl.innerHTML = `
                    <div class="mb-4 ${headerColor} text-3xl sm:text-4xl font-extrabold">${headerText}</div>
                    <div class="text-xl sm:text-2xl font-semibold mb-3">${currentLessonTitle}</div>
                    <div class="mb-5 text-lg sm:text-xl">${message}</div>
                    
                    <div class="text-2xl sm:text-3xl font-bold mb-6">
                        ƒêi·ªÉm s·ªë: <span class="text-blue-600 dark:text-blue-400">${score}/${totalQuestions}</span>
                        <span class="ml-4 text-green-600 dark:text-green-400">(${percentage.toFixed(0)}%)</span>
                    </div>
                `;
            } else {
                // N·∫øu ho√†n th√†nh b√¨nh th∆∞·ªùng, v·∫´n gi·ªØ n√∫t l√†m l·∫°i
                resultMessageEl.innerHTML = `
                    <div class="mb-4 ${headerColor} text-3xl sm:text-4xl font-extrabold">${headerText}</div>
                    <div class="text-xl sm:text-2xl font-semibold mb-3">${currentLessonTitle}</div>
                    <div class="mb-5 text-lg sm:text-xl">${message}</div>
                    
                    <div class="text-2xl sm:text-3xl font-bold mb-6">
                        ƒêi·ªÉm s·ªë: <span class="text-blue-600 dark:text-blue-400">${score}/${totalQuestions}</span>
                        <span class="ml-4 text-green-600 dark:text-green-400">(${percentage.toFixed(0)}%)</span>
                    </div>
                    
                    <button onclick="resetAndLoadLesson()" class="mt-4 px-8 py-3 bg-indigo-600 text-white font-bold text-lg rounded-lg shadow-lg hover:bg-indigo-700 focus:outline-none focus:ring-4 focus:ring-indigo-300 dark:focus:ring-indigo-800 transform hover:scale-105 transition-all duration-300">
                        L√†m l·∫°i b√†i n√†y
                    </button>
                `;
            }

        }
        
        // --- LOGIC CHUY·ªÇN ƒê·ªîI CH·∫æ ƒê·ªò S√ÅNG/T·ªêI (DARK MODE) ---

        /**
         * √Åp d·ª•ng ho·∫∑c g·ª° b·ªè class 'dark' cho th·∫ª <html> v√† l∆∞u tr·∫°ng th√°i.
         */
        function toggleDarkMode(isDark) {
            if (isDark) {
                document.documentElement.classList.add('dark');
                sunIconEl.classList.add('hidden');
                moonIconEl.classList.remove('hidden');
                localStorage.setItem('theme', 'dark');
            } else {
                document.documentElement.classList.remove('dark');
                sunIconEl.classList.remove('hidden');
                moonIconEl.classList.add('hidden');
                localStorage.setItem('theme', 'light');
            }
        }

        /**
         * X·ª≠ l√Ω s·ª± ki·ªán nh·∫•p v√†o n√∫t chuy·ªÉn ƒë·ªïi
         */
        modeToggleEl.addEventListener('click', () => {
            const isDark = document.documentElement.classList.contains('dark');
            toggleDarkMode(!isDark);
        });

        // T·∫£i tr·∫°ng th√°i Dark Mode ƒë√£ l∆∞u ho·∫∑c thi·∫øt l·∫≠p m·∫∑c ƒë·ªãnh theo h·ªá th·ªëng
        function initializeTheme() {
            const savedTheme = localStorage.getItem('theme');
            const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
            
            if (savedTheme === 'dark' || (!savedTheme && prefersDark)) {
                toggleDarkMode(true);
            } else {
                toggleDarkMode(false);
            }
        }

        // --- KH·ªûI T·∫†O ·ª®NG D·ª§NG ---
        window.onload = function() {
            initializeTheme();
            initializeLessons(); 
        };

    </script>
</body>
</html>
