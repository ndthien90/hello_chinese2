<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ƒêi·ªÅn T·ª´ - HelloChinese Style</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&family=Noto+Sans+SC:wght@400;500;700&family=Ma+Shan+Zheng&display=swap" rel="stylesheet">
    <!-- Confetti -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.3/dist/confetti.browser.min.js"></script>

    <style>
        @font-face {
            font-family: 'KaiTi';
            src: url('https://ndthien90.github.io/hello_chinese2/fonts/Kaiti.ttf') format('truetype');
            font-weight: normal;
            font-style: normal;
        }

        body {
            font-family: 'Nunito', sans-serif;
            -webkit-tap-highlight-color: transparent;
        }

        .chinese-font {
            font-family: 'KaiTi', 'Ma Shan Zheng', 'Noto Sans SC', serif;
        }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* Custom Select */
        .custom-select {
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 0.75rem center;
            background-repeat: no-repeat;
            background-size: 1.25em 1.25em;
            appearance: none;
        }

        /* Animations */
        @keyframes popIn {
            0% { transform: scale(0.9); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }
        .pop-in { animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }

        @keyframes pulse-border {
            0% { border-color: #3b82f6; box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.4); }
            70% { border-color: #3b82f6; box-shadow: 0 0 0 6px rgba(59, 130, 246, 0); }
            100% { border-color: #3b82f6; box-shadow: 0 0 0 0 rgba(59, 130, 246, 0); }
        }

        /* Game Elements */
        .blank-slot {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-width: 60px;
            height: 44px;
            border-bottom: 3px dashed #cbd5e1; /* gray-300 */
            margin: 0 4px;
            vertical-align: middle;
            color: #2563eb; /* blue-600 */
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
            padding: 0 8px;
        }

        .blank-slot.selected {
            border-bottom: 3px solid #3b82f6;
            background-color: #eff6ff;
            animation: pulse-border 1.5s infinite;
        }

        .blank-slot.filled {
            border-bottom: 3px solid #10b981; /* green-500 */
            color: #059669;
            background-color: transparent;
        }

        .answer-chip {
            transition: all 0.2s;
        }
        .answer-chip:active { transform: scale(0.95); }
        .answer-chip.selected {
            background-color: #3b82f6;
            color: white;
            border-color: #3b82f6;
        }
        .answer-chip.used {
            opacity: 0;
            pointer-events: none;
            transform: scale(0.8);
        }

    </style>
</head>
<body class="bg-gray-50 min-h-screen flex flex-col max-w-md mx-auto shadow-2xl border-x border-gray-100 relative text-gray-800">

    <!-- Top Navigation Bar -->
    <div class="bg-white px-4 py-3 flex items-center justify-between sticky top-0 z-30 shadow-sm">
        <button onclick="handleBack()" class="w-10 h-10 rounded-full hover:bg-gray-100 flex items-center justify-center text-gray-600 transition">
            <i class="fas fa-arrow-left text-lg"></i>
        </button>
        <h1 class="font-extrabold text-gray-800 text-lg">ƒêi·ªÅn t·ª´</h1>
        <div id="timerDisplay" class="hidden bg-orange-100 text-orange-600 px-3 py-1 rounded-full text-xs font-bold font-mono border border-orange-200">
            05:00
        </div>
        <div id="placeholder" class="w-10 h-10" style="display:none"></div> <!-- Spacer if timer hidden -->
    </div>

    <!-- Main Content -->
    <div class="flex-1 flex flex-col p-4 pb-24 overflow-y-auto no-scrollbar relative">
        
        <!-- SETUP SCREEN -->
        <div id="setup-screen" class="flex flex-col gap-6 pt-4 transition-all duration-300">
            <!-- Icon Hero -->
            <div class="flex justify-center mb-2">
                <div class="w-24 h-24 bg-purple-100 rounded-full flex items-center justify-center shadow-inner">
                    <span class="text-5xl">üìù</span>
                </div>
            </div>

            <!-- Lesson Selection -->
            <div class="bg-white p-5 rounded-2xl shadow-sm border border-gray-100">
                <label class="block text-xs font-bold text-gray-500 uppercase mb-2 tracking-wider">B√†i h·ªçc</label>
                <div class="relative">
                    <select id="lessonSelect" class="custom-select w-full bg-gray-50 border border-gray-200 text-gray-800 font-bold py-3 pl-4 pr-10 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 transition cursor-pointer">
                        <option value="1">H1 B√†i 1: ËÄÅÂ∏àÊÇ®Â•ΩÔºÅ</option>
                        <option value="2">H1 B√†i 2: Ë∞¢Ë∞¢‰Ω†ÔºÅ</option>
                        <option value="3">H1 B√†i 3: ‰Ω†Âè´‰ªÄ‰πàÂêçÂ≠óÔºü</option>
                        <option value="4">H1 B√†i 4: Â•πÊòØÊàëÁöÑÊ±âËØ≠ËÄÅÂ∏à</option>
                    </select>
                </div>
            </div>

            <!-- Settings -->
            <div class="bg-white p-5 rounded-2xl shadow-sm border border-gray-100 space-y-4">
                <!-- Question Count -->
                <div>
                    <div class="flex justify-between items-center mb-2">
                        <label class="block text-xs font-bold text-gray-500 uppercase tracking-wider">S·ªë c√¢u h·ªèi</label>
                        <span id="questionCountDisplay" class="bg-blue-100 text-blue-700 text-xs font-bold px-2 py-1 rounded-lg">5</span>
                    </div>
                    <input type="range" id="questionCount" min="2" max="10" value="5" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-blue-600">
                </div>
                
                <!-- Timer -->
                <div>
                    <div class="flex justify-between items-center mb-2">
                        <label class="block text-xs font-bold text-gray-500 uppercase tracking-wider">Th·ªùi gian (gi√¢y)</label>
                        <span id="timerInputDisplay" class="bg-orange-100 text-orange-700 text-xs font-bold px-2 py-1 rounded-lg">300s</span>
                    </div>
                    <input type="range" id="timerInput" min="30" max="600" step="10" value="300" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-orange-500">
                </div>
            </div>

            <!-- Start Button -->
            <button id="startBtn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 rounded-xl shadow-lg shadow-blue-200 active:scale-95 transition-all flex items-center justify-center gap-2 mt-2 text-lg">
                <i class="fas fa-play"></i> B·∫Øt ƒë·∫ßu
            </button>
        </div>

        <!-- GAME SCREEN -->
        <div id="game-screen" class="hidden flex-col h-full relative">
            
            <!-- Progress Bar -->
            <div class="w-full h-1.5 bg-gray-200 rounded-full mb-6 overflow-hidden">
                <div id="gameProgress" class="h-full bg-green-500 rounded-full transition-all duration-500" style="width: 0%"></div>
            </div>

            <!-- Question Area -->
            <div id="questionsContainer" class="flex-1 flex flex-col gap-6">
                <!-- Questions injected here -->
            </div>

            <!-- Word Bank Area (Sticky Bottom) -->
            <div id="wordBank" class="fixed bottom-20 left-0 right-0 max-w-md mx-auto bg-white border-t border-gray-100 p-4 shadow-[0_-4px_20px_rgba(0,0,0,0.05)] z-20 rounded-t-2xl">
                 <p class="text-[10px] text-gray-400 font-bold uppercase mb-2 text-center tracking-widest">Ch·ªçn t·ª´ ƒë·ªÉ ƒëi·ªÅn</p>
                 <div id="answersContainer" class="flex flex-wrap gap-2 justify-center">
                     <!-- Answer chips injected here -->
                 </div>
            </div>
        </div>

        <!-- RESULT SCREEN -->
        <div id="result-screen" class="hidden flex-col items-center justify-center h-full text-center pop-in pt-10">
            <div class="w-24 h-24 bg-green-100 rounded-full flex items-center justify-center mb-4 shadow-sm animate-bounce">
                <span class="text-5xl">üèÜ</span>
            </div>
            <h2 class="text-3xl font-extrabold text-gray-800 mb-2">Ho√†n th√†nh!</h2>
            <p class="text-gray-500 mb-6 px-4">B·∫°n ƒë√£ tr·∫£ l·ªùi ƒë√∫ng t·∫•t c·∫£ c√°c c√¢u h·ªèi.</p>
            
            <div class="bg-gray-50 rounded-xl p-4 w-full mb-8 border border-gray-100 flex justify-around">
                <div class="text-center">
                    <p class="text-xs text-gray-400 uppercase font-bold">Th·ªùi gian</p>
                    <p id="resultTime" class="text-xl font-bold text-gray-800">00:00</p>
                </div>
                <div class="text-center">
                    <p class="text-xs text-gray-400 uppercase font-bold">C√¢u h·ªèi</p>
                    <p id="resultScore" class="text-xl font-bold text-blue-600">0/0</p>
                </div>
            </div>

            <button onclick="resetGame()" class="w-full bg-blue-600 text-white font-bold py-4 rounded-xl shadow-lg shadow-blue-200 active:scale-95 transition mb-3">
                Ch∆°i l·∫°i
            </button>
            <button onclick="handleBack()" class="w-full bg-white text-gray-600 border border-gray-200 font-bold py-4 rounded-xl active:scale-95 transition">
                V·ªÅ m√†n h√¨nh ch√≠nh
            </button>
        </div>

    </div>

    <!-- Bottom Tab Bar -->
    <div class="bg-white border-t border-gray-200 px-2 py-3 flex justify-around items-center sticky bottom-0 z-40 pb-6 md:pb-3">
        <a href="index.html" class="flex flex-col items-center gap-1 text-gray-400 hover:text-blue-600 transition w-16 group">
            <i class="fas fa-home text-xl group-hover:scale-110 transition"></i>
            <span class="text-[10px] font-medium">Home</span>
        </a>
        <a href="FlashCard_new.html" class="flex flex-col items-center gap-1 text-gray-400 hover:text-blue-600 transition w-16 group">
            <i class="fas fa-layer-group text-xl group-hover:scale-110 transition"></i>
            <span class="text-[10px] font-medium">Th·∫ª</span>
        </a>
        <a href="#" class="flex flex-col items-center gap-1 text-blue-600 w-16">
            <i class="fas fa-gamepad text-xl"></i>
            <span class="text-[10px] font-medium">Game</span>
        </a>
        <a href="#" class="flex flex-col items-center gap-1 text-gray-400 hover:text-blue-600 transition w-16 group">
            <i class="fas fa-user text-xl group-hover:scale-110 transition"></i>
            <span class="text-[10px] font-medium">T√¥i</span>
        </a>
    </div>

    <script>
        // --- DATA ---
        const lessonData = {
            1: [
                "/‰Ω†/Â•Ω„ÄÇ", "ÂÜç/ËßÅ/„ÄÇ", "‰Ω†Â•Ω/Âêó/Ôºü", "ÈÇ£/‰∏çÊòØ/ÈôàÊ•†„ÄÇ",
                "Êàë‰∏çÊòØËÄÅÂ∏àÔºåÊàëÊòØ/Â≠¶Áîü/„ÄÇ", "Êàë/Âæà/Â•Ω„ÄÇ", "ÊàëÊòØ/ÂõΩÂÆâ/„ÄÇ", "/ËÄÅÂ∏à/ÔºåÊÇ®Â•Ω„ÄÇ"
            ],
            2: [
                "/Ë∞¢Ë∞¢/‰Ω†ÔºÅ", "‰∏ç/ÂÆ¢/Ê∞îÔºÅ", "ÊàëÁà∏Áà∏‰∏çÊòØ/ÂåªÁîü/„ÄÇ", "‰Ω†Â¶àÂ¶à/ÊòØ/ËÆ∞ËÄÖÂêóÔºü",
                "ÊàëÂ¶àÂ¶àÂæàÂ•ΩÔºåË∞¢Ë∞¢/‰Ω†/ÔºÅ", "/ÈÇ£/‰∏çÊòØË≠¶ÂØüÔºåÈÇ£ÊòØÈÉ®Èòü„ÄÇ", "ÈÇ£/‰∏çÊòØ/‰π¶ÔºåÈÇ£ÊòØÊú¨Â≠ê„ÄÇ",
                "ÂØπ‰∏ç/Ëµ∑/ÔºåÊàë‰∏çÊòØÂæãÂ∏à„ÄÇ", "ÈÇ£ÊòØ‰Ω†/Âì•Âì•/ÂêóÔºü"
            ],
            3: [
                "‰Ω†/Âè´/‰ªÄ‰πàÂêçÂ≠óÔºü", "ËØ∑ÈóÆÔºåÊÇ®/Ë¥µÂßì/Ôºü", "‰Ω†Âßì/‰ªÄ‰πà/Ôºü", "Â¶àÂ¶à/Âßì/ÁéãÔºåÁà∏Áà∏Âßì/Êùé/„ÄÇ",
                "‰Ω†ÂñúÊ¨¢/Âñù/‰ªÄ‰πà?", "ËøôÊòØ‰ªÄ‰πà/‰π¶?", "ÊàëÂæà/ÂñúÊ¨¢/Èü©ÂõΩ„ÄÇ", "Â•π‰∏çÂñúÊ¨¢/ÂêÉ/ÁÅ´ÈîÖ„ÄÇ",
                "‰Ω†ÊòØË∂äÂçó/‰∫∫/ÂêóÔºü", "Êàë‰∏çÊòØ/‰∏≠ÂõΩ‰∫∫/ÔºåÊàëÊòØÊ≥∞ÂõΩ‰∫∫„ÄÇ", "Â¶àÂ¶àÊòØÊó•Êú¨‰∫∫ÔºåÁà∏Áà∏‰πüÊòØ/Êó•Êú¨‰∫∫/„ÄÇ",
                "‰ªñÊòØÁæéÂõΩ‰∫∫Ôºå‰ªñËØ¥/Ëã±ËØ≠/„ÄÇ", "ÊàëÊòØË∂äÂçó‰∫∫ÔºåÊàë/ËØ¥/Ë∂äÂçóËØ≠„ÄÇ", "‰ªñÊòØÊ≥ïÂõΩ‰∫∫Ôºå‰ªñËØ¥/Ê≥ïËØ≠/„ÄÇ",
                "ÊàëÂíå‰ªñ‰ª¨/ÈÉΩ/ÊòØÈü©ÂõΩ‰∫∫„ÄÇ", "ÊàëÂ¶àÂ¶àÂßìÂº†ÔºåÊàëÁà∏Áà∏/‰πü/ÂßìÂº†„ÄÇ"
            ],
            4: [
                "/Ë∞Å/ÊòØÊùéÊúà", "‰Ω†ÊòØ/Âì™/ÂõΩ‰∫∫Ôºü", "‰∏Ä/Âº†/Ê°åÂ≠êÂíå‰∏§/Êää/Èõ®‰ºû„ÄÇ", "ÊàëÊúâ‰∏§/Âèå/Èûã„ÄÇ",
                "ËøôÊòØÊàë/ÁöÑ/‰π¶", "‰ªñÊòØÊàëÁöÑ/Ê±âËØ≠/ËÄÅÂ∏à", "ÊàëÊòØÈôàÊ•†Ôºå‰Ω†/Âë¢/Ôºü", "ÊàëÂñúÊ¨¢/Ë∏¢/Ë∂≥ÁêÉ„ÄÇ",
                "Â•πÂñúÊ¨¢/Êâì/ÁæΩÊØõÁêÉ„ÄÇ", "Êàë‰ª¨ÈÉΩÂñúÊ¨¢Áúã/ÁîµÂΩ±/„ÄÇ", "Êàë‰∏çÂñúÊ¨¢ÁãóÔºåÊàëÂñúÊ¨¢/Áå´/",
                "Â•πÂñúÊ¨¢/Á©ø/ÊãñÈûã„ÄÇ", "‰ªñ‰∏çÊòØÊàëÊúãÂèãÔºåÂ•πÊòØÊàë/ÂêåÂ≠¶/„ÄÇ", "‰Ω†ÂñùÂì™/ÊùØ/Â•∂Ëå∂Ôºü",
                "Â•∂Ëå∂/Âíå/ÂíñÂï°ÊàëÈÉΩÂñúÊ¨¢Âñù„ÄÇ"
            ]
        };

        // --- STATE ---
        let timer;
        let timeLeft = 300;
        let totalTime = 0;
        let questions = [];
        let answers = new Set();
        let selectedBlank = null;
        let selectedAnswer = null;
        let completedQuestions = 0;

        // --- UI ELEMENTS ---
        const setupScreen = document.getElementById('setup-screen');
        const gameScreen = document.getElementById('game-screen');
        const resultScreen = document.getElementById('result-screen');
        const timerDisplay = document.getElementById('timerDisplay');
        const placeholder = document.getElementById('placeholder');
        const questionsContainer = document.getElementById('questionsContainer');
        const answersContainer = document.getElementById('answersContainer');
        const questionCountInput = document.getElementById('questionCount');
        const questionCountDisplay = document.getElementById('questionCountDisplay');
        const timerInput = document.getElementById('timerInput');
        const timerInputDisplay = document.getElementById('timerInputDisplay');
        const lessonSelect = document.getElementById('lessonSelect');

        // --- INITIALIZATION ---
        
        questionCountInput.addEventListener('input', (e) => {
            questionCountDisplay.textContent = e.target.value;
        });

        timerInput.addEventListener('input', (e) => {
            timerInputDisplay.textContent = e.target.value + 's';
        });

        lessonSelect.addEventListener('change', (e) => {
            // Update max questions based on lesson
            const max = lessonData[e.target.value].length;
            questionCountInput.max = max;
            if (parseInt(questionCountInput.value) > max) {
                questionCountInput.value = max;
                questionCountDisplay.textContent = max;
            }
        });

        document.getElementById('startBtn').addEventListener('click', startGame);

        // --- GAME LOGIC ---

        function startGame() {
            // Get settings
            const lesson = parseInt(lessonSelect.value);
            const count = parseInt(questionCountInput.value);
            timeLeft = parseInt(timerInput.value);
            totalTime = timeLeft;

            // Prepare Questions
            const lessonQuestions = lessonData[lesson];
            if(!lessonQuestions) return;

            const shuffledAll = [...lessonQuestions].sort(() => 0.5 - Math.random());
            const selectedRaw = shuffledAll.slice(0, count);
            
            questions = selectedRaw.map(parseQuestion);
            completedQuestions = 0;

            // Switch UI
            setupScreen.classList.add('hidden');
            resultScreen.classList.add('hidden');
            gameScreen.classList.remove('hidden');
            gameScreen.classList.add('flex');
            
            timerDisplay.classList.remove('hidden');
            placeholder.style.display = 'none';

            // Render
            renderGame();
            startTimer();
        }

        function handleBack() {
            if (!setupScreen.classList.contains('hidden')) {
                window.history.back();
            } else {
                resetGame();
            }
        }

        function resetGame() {
            clearInterval(timer);
            gameScreen.classList.add('hidden');
            gameScreen.classList.remove('flex');
            resultScreen.classList.add('hidden');
            timerDisplay.classList.add('hidden');
            placeholder.style.display = 'block';
            setupScreen.classList.remove('hidden');
        }

        function parseQuestion(text) {
            const parts = text.split('/');
            const result = {
                textParts: [], // Array of { type: 'text'|'blank', content: string }
                answer: null
            };
            
            // Format: "Hello /world/." -> world is blank
            // Note: Current logic assumes 1 blank per question for simplicity of UI flow in HelloChinese style
            // If multiple blanks, logic can handle, but UI is better with 1 focus.
            // Let's adapt the parser to handle the split correctly.
            
            // Example: "Êàë/Âæà/Â•Ω„ÄÇ" -> ["Êàë", "Âæà", "Â•Ω„ÄÇ"]
            // Even index = text, Odd index = blank
            
            let htmlParts = [];
            
            for (let i = 0; i < parts.length; i++) {
                if (i % 2 === 0) {
                    if(parts[i]) htmlParts.push({ type: 'text', content: parts[i] });
                } else {
                    htmlParts.push({ type: 'blank', content: parts[i] });
                    answers.add(parts[i]); // Add to global pool for this game
                }
            }
            result.textParts = htmlParts;
            return result;
        }

        function renderGame() {
            questionsContainer.innerHTML = '';
            answersContainer.innerHTML = '';
            answers.clear();

            // Collect all answers first to shuffle
            questions.forEach(q => {
                q.textParts.forEach(p => {
                    if(p.type === 'blank') answers.add(p.content);
                });
            });

            // Render Questions
            questions.forEach((q, index) => {
                const qDiv = document.createElement('div');
                qDiv.className = 'bg-white p-4 rounded-2xl shadow-sm border border-gray-100 flex items-center flex-wrap gap-1 min-h-[80px]';
                qDiv.innerHTML = `<span class="text-gray-400 font-bold mr-2 select-none">${index + 1}.</span>`;

                q.textParts.forEach(part => {
                    if (part.type === 'text') {
                        const span = document.createElement('span');
                        span.className = 'chinese-font text-2xl text-gray-700';
                        span.textContent = part.content;
                        qDiv.appendChild(span);
                    } else {
                        const blank = document.createElement('div');
                        blank.className = 'blank-slot chinese-font text-2xl';
                        blank.dataset.answer = part.content;
                        
                        // Auto-select first blank of first question initially? No, let user tap.
                        blank.addEventListener('click', () => handleBlankClick(blank));
                        qDiv.appendChild(blank);
                    }
                });
                questionsContainer.appendChild(qDiv);
            });

            // Render Answers (Word Bank)
            const shuffledAnswers = [...answers].sort(() => 0.5 - Math.random());
            shuffledAnswers.forEach(ans => {
                const btn = document.createElement('button');
                btn.className = 'answer-chip bg-white border-2 border-gray-200 text-gray-700 font-bold py-2 px-4 rounded-xl shadow-sm chinese-font text-xl hover:border-blue-400';
                btn.textContent = ans;
                btn.addEventListener('click', () => handleAnswerClick(btn));
                answersContainer.appendChild(btn);
            });
            
            // Add padding at bottom for sticky word bank
            const spacer = document.createElement('div');
            spacer.className = "h-32";
            questionsContainer.appendChild(spacer);
        }

        // --- INTERACTION LOGIC ---

        function handleBlankClick(blank) {
            if (blank.classList.contains('filled')) return; // Already correct

            // Deselect old
            if (selectedBlank) selectedBlank.classList.remove('selected');
            
            // Select new
            selectedBlank = blank;
            blank.classList.add('selected');

            // If an answer was already selected, try to fill immediately
            if (selectedAnswer) {
                tryMatch();
            }
        }

        function handleAnswerClick(btn) {
            if (btn.classList.contains('used')) return;

            // Deselect old answer visual
            if (selectedAnswer) selectedAnswer.classList.remove('selected');

            selectedAnswer = btn;
            btn.classList.add('selected');

            // If a blank is selected, try fill
            if (selectedBlank) {
                tryMatch();
            } else {
                // Auto-find first empty blank if none selected? 
                // Enhanced UX: Yes, find first non-filled blank
                const firstEmpty = document.querySelector('.blank-slot:not(.filled)');
                if (firstEmpty) {
                    selectedBlank = firstEmpty;
                    selectedBlank.classList.add('selected');
                    tryMatch();
                }
            }
        }

        function tryMatch() {
            if (!selectedBlank || !selectedAnswer) return;

            const target = selectedBlank.dataset.answer;
            const guess = selectedAnswer.textContent;

            if (target === guess) {
                // Correct
                selectedBlank.textContent = guess;
                selectedBlank.classList.remove('selected');
                selectedBlank.classList.add('filled');
                
                selectedAnswer.classList.remove('selected');
                selectedAnswer.classList.add('used'); // Hide/Disable in bank

                // Check completion
                checkCompletion();
            } else {
                // Wrong
                selectedBlank.classList.add('animate-pulse');
                // Shake effect manually
                selectedBlank.style.borderColor = '#ef4444'; // Red
                setTimeout(() => {
                    selectedBlank.style.borderColor = ''; // Reset
                    selectedBlank.classList.remove('animate-pulse');
                }, 400);
                
                // Deselect answer to let user try again easily
                selectedAnswer.classList.remove('selected');
                selectedAnswer = null;
            }
            
            // Reset selection references
            selectedBlank.classList.remove('selected');
            selectedBlank = null;
            selectedAnswer = null;
        }

        function checkCompletion() {
            const allBlanks = document.querySelectorAll('.blank-slot');
            const filledBlanks = document.querySelectorAll('.blank-slot.filled');
            
            // Update Progress
            const progress = (filledBlanks.length / allBlanks.length) * 100;
            document.getElementById('gameProgress').style.width = `${progress}%`;

            if (filledBlanks.length === allBlanks.length) {
                setTimeout(finishGame, 500);
            }
        }

        // --- TIMER & FINISH ---

        function startTimer() {
            updateTimerUI();
            timer = setInterval(() => {
                timeLeft--;
                updateTimerUI();
                if (timeLeft <= 0) {
                    clearInterval(timer);
                    alert("H·∫øt gi·ªù!");
                    resetGame();
                }
            }, 1000);
        }

        function updateTimerUI() {
            const m = Math.floor(timeLeft / 60);
            const s = timeLeft % 60;
            timerDisplay.textContent = `${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
            
            if (timeLeft < 30) {
                timerDisplay.classList.remove('bg-orange-100', 'text-orange-600', 'border-orange-200');
                timerDisplay.classList.add('bg-red-100', 'text-red-600', 'border-red-200', 'animate-pulse');
            } else {
                 timerDisplay.classList.add('bg-orange-100', 'text-orange-600', 'border-orange-200');
                 timerDisplay.classList.remove('bg-red-100', 'text-red-600', 'border-red-200', 'animate-pulse');
            }
        }

        function finishGame() {
            clearInterval(timer);
            
            // Show Confetti
            const duration = 3000;
            const end = Date.now() + duration;
            (function frame() {
                confetti({
                    particleCount: 5,
                    angle: 60,
                    spread: 55,
                    origin: { x: 0 },
                    colors: ['#3b82f6', '#10b981', '#f59e0b']
                });
                confetti({
                    particleCount: 5,
                    angle: 120,
                    spread: 55,
                    origin: { x: 1 },
                    colors: ['#3b82f6', '#10b981', '#f59e0b']
                });
                if (Date.now() < end) requestAnimationFrame(frame);
            }());

            // Update Result UI
            const timeTaken = totalTime - timeLeft;
            const m = Math.floor(timeTaken / 60);
            const s = timeTaken % 60;
            document.getElementById('resultTime').textContent = `${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
            document.getElementById('resultScore').textContent = `${questions.length}/${questions.length}`;

            // Switch Screen
            gameScreen.classList.add('hidden');
            gameScreen.classList.remove('flex');
            timerDisplay.classList.add('hidden');
            resultScreen.classList.remove('hidden');
            resultScreen.classList.add('flex');
        }

        // Init
        // Auto-set max for lesson 1 initially
        questionCountInput.max = lessonData[1].length;

    </script>
</body>
</html>